<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Category: 工作應用 | Morris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Morris&#39; Blog">
<meta property="og:url" content="http://morris821028.github.io/categories/工作應用/index.html">
<meta property="og:site_name" content="Morris&#39; Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Morris&#39; Blog">
<link rel="publisher" href="108158678174364350000">
  
    <link rel="alternative" href="/atom.xml" title="Morris&#39; Blog" type="application/atom+xml">
  
  
    <meta name="google-site-verification" content="5mRgj8NanEMpGZuNfHNJNmH90RgNlrnJXsFlTaKD6Gs" />
  
  
    <link rel="shortcut icon" href="/img/f.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script src="/js/jquery-2.1.0.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.5.1.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdn.oesmith.co.uk/morris-0.5.1.min.js"></script>
  <!-- <link rel="import" href="/bower_components/app-layout/app-layout.html"> --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"><div id="banner-right"></div></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Morris&#39; Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class=icon-home title='Home'></i></a>
          
        
          
            <a class="main-nav-link" href="/about"><i class=icon-user title='About'></i></a>
          
        
          
            <a class="main-nav-link" href="/archives"><i class=icon-archive title='Archives'></i></a>
          
        
          
            <a class="main-nav-link" href="/tags"><i class=icon-tags title='Tags'></i></a>
          
        
          
            <a class="main-nav-link" href="/picture"><i class=icon-camera title='Pictures'></i></a>
          
        
          
            <a class="main-nav-link" href="/works"><i class=icon-trophy title='Works'></i></a>
          
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://morris821028.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        
          
          <section id="main">
  
    <article id="post-work/company-ghost-story-14" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/28/work/company-ghost-story-14/" class="article-date">
  <time datetime="2021-10-28T02:00:00.000Z" itemprop="datePublished">2021-10-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/工作應用/">工作應用</a>/<a class="article-category-link" href="/categories/工作應用/鬼故事/">鬼故事</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/28/work/company-ghost-story-14/">Company Ghost Story 公司鬼故事 14</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2021/10/28/work/company-ghost-story-14/" data-id="ckvx4dxbb02hzpgvnnq4gnuja" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2021/10/28/work/company-ghost-story-14/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/鬼故事/">鬼故事</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><h3 id="Format-vs-Concatenation"><a href="#Format-vs-Concatenation" class="headerlink" title="Format vs. Concatenation"></a>Format vs. Concatenation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">String.format(<span class="string">"format "</span> + a + <span class="string">"%s"</span>, b);</div></pre></td></tr></table></figure>
<p>大部分情況，很少去生成 format string，<br>混合使用很容易遇到表示錯誤，因為當 <code>a</code> 中出現 <code>%</code> 等特殊字元時，解析上會發生錯誤。最好是統一一種使用規則。</p>
<h3 id="Comparator-Signum"><a href="#Comparator-Signum" class="headerlink" title="Comparator Signum"></a>Comparator Signum</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">long</span> a = func(x);</div><div class="line"><span class="keyword">long</span> b = func(y);</div><div class="line"><span class="keyword">long</span> dir = mDir;</div><div class="line"><span class="keyword">return</span> (<span class="keyword">int</span>) a - (<span class="keyword">int</span>) b;   <span class="comment">// SHOULD Long.compare(a, b);</span></div><div class="line"><span class="keyword">return</span> (<span class="keyword">int</span>) (a - b) * dir; <span class="comment">// SHOULD Long.compare(a, b) * Long.signum(dir);</span></div></pre></td></tr></table></figure>
<p>隨意 casting 三不五時就會 arithmetic overflow 搞砸了排序。</p>
<h3 id="What’s-Not-Equal"><a href="#What’s-Not-Equal" class="headerlink" title="What’s Not-Equal"></a>What’s Not-Equal</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ((a == <span class="keyword">null</span> &amp;&amp; b != <span class="keyword">null</span>) || </div><div class="line">    (a != <span class="keyword">null</span> &amp;&amp; b == <span class="keyword">null</span>) || </div><div class="line">    !a.equals(b)) &#123;</div><div class="line">&#125;</div><div class="line"><span class="comment">// WAIT, if a == null and b == null ?</span></div><div class="line"><span class="comment">// SHOULD Objects.equals(a, b);</span></div></pre></td></tr></table></figure>
<p>有內建方便使用的函數，別再這樣寫了。</p>
<h3 id="Sync-Up"><a href="#Sync-Up" class="headerlink" title="Sync-Up"></a>Sync-Up</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Record</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">merge</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> a.setParent(b.getParent().copy());</div><div class="line">        <span class="comment">// refactor, a.setParent(b.getParent());</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Merger</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(Record r)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            merge();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="comment">// nothing here</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>為什麼偷偷搞了一個 Exception 又不給 log message，一不小心就 refactor 到奇怪的東西，曾經把 <code>NullPointerException</code> 視為一個正常邏輯，修掉來自另一個 call path 的 NPE，卻又踩了另一塊的雷。</p>
<h3 id="Keyboard"><a href="#Keyboard" class="headerlink" title="Keyboard"></a>Keyboard</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">SHIFT + INSERT = CTRL + V</div><div class="line">CTRL + C</div><div class="line">CTRL + Z + ENTER</div><div class="line">HOME/END</div></pre></td></tr></table></figure>
<p>大家耳熟能詳的 CTRL C+V，都不知道 CTRL+INSERT/SHIFT+INSERT，而在 X Window System 上，選取時會自動複製，不用額外按下複製操作。</p>
<p>至於問 INSERT/DELETE/HOME/END 是什麼的小夥伴，還是好好看清楚鍵盤吧。</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-work/appreciation-letter" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/09/12/work/appreciation-letter/" class="article-date">
  <time datetime="2021-09-12T10:00:00.000Z" itemprop="datePublished">2021-09-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/工作應用/">工作應用</a>/<a class="article-category-link" href="/categories/工作應用/其他/">其他</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/12/work/appreciation-letter/">Shiny People 感謝</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2021/09/12/work/appreciation-letter/" data-id="ckvx4dx9a02fqpgvnwg6m1asl" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2021/09/12/work/appreciation-letter/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="背景原因"><a href="#背景原因" class="headerlink" title="背景原因"></a>背景原因</h2><p>公司有一套 Shiny 機制，可以在特別日期或事件後，來表揚合作不錯的長官同事。有時候表揚可以帶鼓勵金的，當然這筆錢不會由您支付，而是由部門的某一個錢包裡出，理所當然得不可能存在同部門互相洗錢的行為，仍然遵循某一種流程。</p>
<p>詳細信件內容有點不同了，就當作有朝一日會在網路上搜尋到吧。</p>
<h2 id="任職周年慶祝"><a href="#任職周年慶祝" class="headerlink" title="任職周年慶祝"></a>任職周年慶祝</h2><h3 id="Software-Architect"><a href="#Software-Architect" class="headerlink" title="Software Architect"></a>Software Architect</h3><p>To Jeffrey Morehouse:</p>
<p>I really appreciate your great art, which facilitates high productivity compared to other products. In these years, give the opportunity to develop my improvement thought in core. During coding experiment, your resource and past experience help me a lots.  Although we’re working on different ways these years, I’m looking forward to having technical discussion with you one day.  Congratulate to Techholic!</p>
<p>感謝您轉交下來的偉大傑作，讓我們產品相較於其他產品<br>擁有非常高的生產力、極低的開發週期。同時在這幾年間，<br>給予我機會去實踐自己的想法。並在開發過程中，給不少<br>資源與過去經驗參考，這些都讓我學了很多。</p>
<p>雖然這幾年間沒有共事，期待未來可以分享這些技術細節。<br>為我們的技術狂熱慶祝！</p>
<h3 id="Manager"><a href="#Manager" class="headerlink" title="Manager"></a>Manager</h3><p>To Thunder Lay:</p>
<p>I’m glad to be the early employee in your part. The unfailingly patient leader is very important to me in first job. Even though we’re good at different profession, we learned from each other to complish great big tasks these years. That is very good experience, and rare in many kinds of job career.</p>
<p>很高興地成為早期的部門成員，對我第一份工作而言，<br>您的耐心指導成為很大的助力，雖擅長不同領域的專長，<br>在這幾年間，取長補短地完成了許多重大任務，這真的<br>是在其他職業生涯中可未必能見到的非常好的經驗。</p>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>寫完英文，看著自己的譯文，赫然發現我的中文死去，找些朋友提前問個意見後，只得到了一致的答覆「看不懂」。在沒有前因後果，不具備相同處理的條件下，看起來可能是誰要離職了吧。</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-work/company-ghost-story-13" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/09/12/work/company-ghost-story-13/" class="article-date">
  <time datetime="2021-09-12T02:00:00.000Z" itemprop="datePublished">2021-09-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/工作應用/">工作應用</a>/<a class="article-category-link" href="/categories/工作應用/鬼故事/">鬼故事</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/12/work/company-ghost-story-13/">Company Ghost Story 公司鬼故事 13</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2021/09/12/work/company-ghost-story-13/" data-id="ckvx4dx9g02fypgvnc3dl5fkq" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2021/09/12/work/company-ghost-story-13/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/鬼故事/">鬼故事</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><h3 id="Default-Constructor-Trap"><a href="#Default-Constructor-Trap" class="headerlink" title="Default Constructor Trap"></a>Default Constructor Trap</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</div><div class="line">    Point() &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(); <span class="comment">// why?</span></div><div class="line">    &#125;</div><div class="line">    Point(<span class="keyword">int</span> x, <span class="keyword">int</span> y) &#123;...&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一開始不宣告就好了，當有自定義的建構子，預設建構子自然無法被使用，沒必要設一個陷阱讓別人踩。</p>
<h3 id="Feature-and-Backward-Compatibility"><a href="#Feature-and-Backward-Compatibility" class="headerlink" title="Feature and Backward Compatibility"></a>Feature and Backward Compatibility</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Engine</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String mFeature = <span class="string">""</span>; <span class="comment">// Why not null ?</span></div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DbObj</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String mFeature = <span class="string">""</span>; <span class="comment">// Why not null ?</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>空與空字串的意義不同，預設為空字串 (<code>&quot;&quot;</code>) 的狀況並不多見，為空 (<code>null</code>) 在序列化和反序列化時的差異就很大了。</p>
<h3 id="Fancy-Check-and-Cast"><a href="#Fancy-Check-and-Cast" class="headerlink" title="Fancy Check-and-Cast"></a>Fancy Check-and-Cast</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Shape shp;</div><div class="line"><span class="keyword">if</span> (shp.getUserName().equals(<span class="string">"circle"</span>)) <span class="comment">// wait, where is your `instanceof`</span></div><div class="line">    <span class="keyword">return</span> ((Circle) shp).getBound();</div></pre></td></tr></table></figure>
<h3 id="Call-By-Value"><a href="#Call-By-Value" class="headerlink" title="Call-By-Value"></a>Call-By-Value</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">readColRow</span><span class="params">(<span class="keyword">int</span> col, <span class="keyword">int</span> row)</span> </span>&#123;</div><div class="line">    Pair p = readPair();</div><div class="line">    col = p.first;</div><div class="line">    row = p.second;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Java 沒有 reference type 的這操作。</p>
<h3 id="Slow-Feature"><a href="#Slow-Feature" class="headerlink" title="Slow Feature"></a>Slow Feature</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">exec</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (;;) &#123;&#125; <span class="comment">// where is throw new UnsupportedOperationException();</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我可不想跟客戶說「你再等等，這功能只是比較慢」的謊言。</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-work/company-ghost-story-12" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/08/14/work/company-ghost-story-12/" class="article-date">
  <time datetime="2021-08-14T02:00:00.000Z" itemprop="datePublished">2021-08-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/工作應用/">工作應用</a>/<a class="article-category-link" href="/categories/工作應用/鬼故事/">鬼故事</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/08/14/work/company-ghost-story-12/">Company Ghost Story 公司鬼故事 12</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2021/08/14/work/company-ghost-story-12/" data-id="ckvx4dx9d02ftpgvngxcvj865" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2021/08/14/work/company-ghost-story-12/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/鬼故事/">鬼故事</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><h3 id="Fancy-OOP"><a href="#Fancy-OOP" class="headerlink" title="Fancy OOP"></a>Fancy OOP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MSTAlgorithmEngine</span> </span>&#123;</div><div class="line">    JButton mApplyButton; <span class="comment">// why, ???</span></div><div class="line">    JPanel mUI;           <span class="comment">// why, ???</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DiffRecord</span> </span>&#123;</div><div class="line">    Action mMergeAction; <span class="comment">// why, ???</span></div><div class="line">    Action mShowAction;  <span class="comment">// why, ???</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">normalize</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> NormalizeAction().actionPerformed(<span class="keyword">new</span> ActionEvent(ActionEvent.PERFORMED));</div><div class="line">    &#125; <span class="comment">// I cannot deal with this shit anymore.</span></div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">NormalizeAction</span> <span class="keyword">extends</span> <span class="title">AbstractAction</span> </span>&#123;</div><div class="line">        <span class="comment">// real implementation for model class</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>資料歸資料，算法歸算法，別把 UI 牽扯進來。</p>
<h3 id="Shit-Cache"><a href="#Shit-Cache" class="headerlink" title="Shit Cache"></a>Shit Cache</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Engine</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CacheStructure sCache;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exec</span><span class="params">()</span> </span>&#123;</div><div class="line">        resetCache();</div><div class="line">        <span class="comment">// fill cache;</span></div><div class="line">    &#125; <span class="comment">// but, when will you clear sCache, sCache = null?</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>快取的污染啊，那些殘存的資料依舊卡在記憶體內，是無法被 GC 回收的。反而，造成下一個運行的更容易出現記憶體不足。</p>
<h3 id="Shit-Cache-in-Class"><a href="#Shit-Cache-in-Class" class="headerlink" title="Shit Cache in Class"></a>Shit Cache in Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dbo</span> <span class="keyword">extends</span> <span class="title">DbObject</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> CacheStructure mCache; <span class="comment">// for internal recursion, why this thing is here?</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getSomething</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// init cache</span></div><div class="line">        <span class="keyword">return</span> internalGetSomething(parameters);</div><div class="line">    &#125; <span class="comment">// but, when will you clear cache, cache = null?</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">internalGetSomething</span><span class="params">(parameters)</span> </span>&#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>別亂放你的資料結構，這關資料庫物件什麼事？</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-java/java-jni-tls-error-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/07/29/java/java-jni-tls-error-2/" class="article-date">
  <time datetime="2021-07-29T04:00:00.000Z" itemprop="datePublished">2021-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/工作應用/">工作應用</a>/<a class="article-category-link" href="/categories/工作應用/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/07/29/java/java-jni-tls-error-2/">Java JNI GC Thread Error (EINVAL)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2021/07/29/java/java-jni-tls-error-2/" data-id="ckvx4dx2f025spgvnr2e90tiq" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2021/07/29/java/java-jni-tls-error-2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JNI/">JNI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TLS/">TLS</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <p>Keywords: JNI, Java, GC Thread, add_workers, static library, Thread Error</p>
<p>Solution: <code>-XX:+AdjustStackSizeForTLS</code> from JDK 14</p>
<h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><p>We cannot launch GC thread of JVM from JNI. And, it shows</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[os,thread] Failed to start thread - pthread_create failed (EINVAL) <span class="keyword">for</span> attributes: stacksize: 1024k, guardsize: 0k, detached.</div></pre></td></tr></table></figure>
<p>The main reason is the glibc bugs for native C code issues. For example, we allocate thread-local variables by static library linking.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">__thread <span class="keyword">int</span> buf[<span class="number">1048576</span>];</div><div class="line"><span class="keyword">thread_local</span> <span class="keyword">int</span> buf[<span class="number">1048576</span>];</div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp threadprive(buf);</span></div></pre></td></tr></table></figure>
<p>And then, glibc 2.12 will move them on stack, and require minimum stack size at least 1024k bytes. But, the default configuration JVM of JDK11 will minimum stacksize to be 1024k bytes as default in Linux OS. Therefore, the <code>pthread_create</code> throws the error <code>EINVAL</code> for specific stacksize setting.</p>
<h2 id="Options"><a href="#Options" class="headerlink" title="Options"></a>Options</h2><p><a href="https://www.oracle.com/java/technologies/javase/14all-relnotes.html" target="_blank" rel="external">https://www.oracle.com/java/technologies/javase/14all-relnotes.html</a></p>
<p>The glibc library allocates some thread-local storage (TLS) in the stack of a newly created thread, leaving less stack than requested for the thread to do its work. This is particularly a problem for threads with small stack sizes. It is an inherited issue from a well-known glibc problem, ‘Program with large TLS segments fail’ [0] and has been observed in Java applications. In one of the reported JVM failure instances, the issue manifests as a StackOverflowError on the process reaper thread, which has a small stack size. The java.lang.Thread constructor enables users to specify the stack size for a new thread. The created thread may encounter the TLS problem when the specified size is too small to accommodate the on-stack TLS blocks.</p>
<p>In JDK 8, a system property, <code>jdk.lang.processReaperUseDefaultStackSize</code>, was introduced to address the TLS issue only for reaper threads. Setting the property gives a bigger stack size to the reaper threads.</p>
<p>To address the issue for all threads, a general purpose workaround was implemented in Java which adjusts thread stack size for TLS. It can be enabled by using the <code>AdjustStackSizeForTLS</code> command-line option:</p>
<p>When creating a new thread, if <code>AdjustStackSizeForTLS</code> is true, the static TLS area size is added to the user requested stack size. <code>AdjustStackSizeForTLS</code> is disabled by default.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>整合進大型程式時，要多觀察靜態編譯的部分，如果有一些 TLS 的宣告，則會增加其他預設執行緒的最小使用堆疊大小。而 JVM 又傾向使用最少資源去完成，則很容易在計算最小資源時發生問題。</p>
<p>如果去查閱 JDK15 的 <a href="https://github.com/openjdk/jdk15/blob/master/src/hotspot/os/linux/os_linux.cpp" target="_blank" rel="external">代碼  os_linux.cpp</a>  時，有一段到動態鏈結函數庫 glibc 的詢問最低需求來解決此問題。這一段牽涉到 hack 技巧，偷偷利用 symbol 爬出私有函數，不算正常操作行為。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// On Linux, glibc places static TLS blocks (for __thread variables) on</span></div><div class="line"><span class="comment">// the thread stack. This decreases the stack size actually available</span></div><div class="line"><span class="comment">// to threads.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// For large static TLS sizes, this may cause threads to malfunction due</span></div><div class="line"><span class="comment">// to insufficient stack space. This is a well-known issue in glibc:</span></div><div class="line"><span class="comment">// http://sourceware.org/bugzilla/show_bug.cgi?id=11787.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// As a workaround, we call a private but assumed-stable glibc function,</span></div><div class="line"><span class="comment">// __pthread_get_minstack() to obtain the minstack size and derive the</span></div><div class="line"><span class="comment">// static TLS size from it. We then increase the user requested stack</span></div><div class="line"><span class="comment">// size by this TLS size.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// Due to compatibility concerns, this size adjustment is opt-in and</span></div><div class="line"><span class="comment">// controlled via AdjustStackSizeForTLS.</span></div><div class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">size_t</span> <span class="params">(*GetMinStack)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">pthread_attr_t</span> *attr)</span></span>;</div><div class="line"></div><div class="line">GetMinStack _get_minstack_func = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">get_minstack_init</span><span class="params">()</span> </span>&#123;</div><div class="line">  _get_minstack_func =</div><div class="line">        (GetMinStack)dlsym(RTLD_DEFAULT, <span class="string">"__pthread_get_minstack"</span>);</div><div class="line">  log_info(os, thread)(<span class="string">"Lookup of __pthread_get_minstack %s"</span>,</div><div class="line">                       _get_minstack_func == <span class="literal">NULL</span> ? <span class="string">"failed"</span> : <span class="string">"succeeded"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Returns the size of the static TLS area glibc puts on thread stacks.</span></div><div class="line"><span class="comment">// The value is cached on first use, which occurs when the first thread</span></div><div class="line"><span class="comment">// is created during VM initialization.</span></div><div class="line"><span class="function"><span class="keyword">static</span> size_t <span class="title">get_static_tls_area_size</span><span class="params">(<span class="keyword">const</span> <span class="keyword">pthread_attr_t</span> *attr)</span> </span>&#123;</div><div class="line">  <span class="keyword">size_t</span> tls_size = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span> (_get_minstack_func != <span class="literal">NULL</span>) &#123;</div><div class="line">    <span class="comment">// Obtain the pthread minstack size by calling __pthread_get_minstack.</span></div><div class="line">    <span class="keyword">size_t</span> minstack_size = _get_minstack_func(attr);</div><div class="line"></div><div class="line">    <span class="comment">// Remove non-TLS area size included in minstack size returned</span></div><div class="line">    <span class="comment">// by __pthread_get_minstack() to get the static TLS size.</span></div><div class="line">    <span class="comment">// In glibc before 2.27, minstack size includes guard_size.</span></div><div class="line">    <span class="comment">// In glibc 2.27 and later, guard_size is automatically added</span></div><div class="line">    <span class="comment">// to the stack size by pthread_create and is no longer included</span></div><div class="line">    <span class="comment">// in minstack size. In both cases, the guard_size is taken into</span></div><div class="line">    <span class="comment">// account, so there is no need to adjust the result for that.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// Although __pthread_get_minstack() is a private glibc function,</span></div><div class="line">    <span class="comment">// it is expected to have a stable behavior across future glibc</span></div><div class="line">    <span class="comment">// versions while glibc still allocates the static TLS blocks off</span></div><div class="line">    <span class="comment">// the stack. Following is glibc 2.28 __pthread_get_minstack():</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// size_t</span></div><div class="line">    <span class="comment">// __pthread_get_minstack (const pthread_attr_t *attr)</span></div><div class="line">    <span class="comment">// &#123;</span></div><div class="line">    <span class="comment">//   return GLRO(dl_pagesize) + __static_tls_size + PTHREAD_STACK_MIN;</span></div><div class="line">    <span class="comment">// &#125;</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// The following 'minstack_size &gt; os::vm_page_size() + PTHREAD_STACK_MIN'</span></div><div class="line">    <span class="comment">// if check is done for precaution.</span></div><div class="line">    <span class="keyword">if</span> (minstack_size &gt; (<span class="keyword">size_t</span>)os::vm_page_size() + PTHREAD_STACK_MIN) &#123;</div><div class="line">      tls_size = minstack_size - os::vm_page_size() - PTHREAD_STACK_MIN;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  log_info(os, thread)(<span class="string">"Stack size adjustment for TLS is "</span> SIZE_FORMAT,</div><div class="line">                       tls_size);</div><div class="line">  <span class="keyword">return</span> tls_size;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-work/company-ghost-story-11" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/07/29/work/company-ghost-story-11/" class="article-date">
  <time datetime="2021-07-29T02:00:00.000Z" itemprop="datePublished">2021-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/工作應用/">工作應用</a>/<a class="article-category-link" href="/categories/工作應用/鬼故事/">鬼故事</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/07/29/work/company-ghost-story-11/">Company Ghost Story 公司鬼故事 11</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2021/07/29/work/company-ghost-story-11/" data-id="ckvx4dx9502flpgvngw8po1qc" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2021/07/29/work/company-ghost-story-11/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/鬼故事/">鬼故事</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><h3 id="Over-Overload"><a href="#Over-Overload" class="headerlink" title="Over Overload"></a>Over Overload</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">OhMyGod</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;System.out.println(<span class="string">"A"</span>);&#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String t)</span> </span>&#123;System.out.println(<span class="string">"B"</span>);&#125;</div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(T[] t)</span> </span>&#123;System.out.println(<span class="string">"C"</span>);&#125;</div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(T t)</span> </span>&#123;System.out.println(<span class="string">"D"</span>);&#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... t)</span> </span>&#123;System.out.println(<span class="string">"E"</span>);&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> OhMyGod().run();</div><div class="line">        <span class="keyword">new</span> OhMyGod().run(<span class="keyword">new</span> String[<span class="number">0</span>]);</div><div class="line">        <span class="keyword">new</span> OhMyGod().run(<span class="string">"1"</span>);</div><div class="line">        <span class="keyword">new</span> OhMyGod().run(<span class="string">"1"</span>, <span class="string">"2"</span>);</div><div class="line">    &#125;</div><div class="line">&#125; <span class="comment">// AEBE, little strange</span></div></pre></td></tr></table></figure>
<h3 id="One-Format-Multiple-Ways"><a href="#One-Format-Multiple-Ways" class="headerlink" title="One-Format Multiple-Ways"></a>One-Format Multiple-Ways</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileIn</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isCSV; <span class="comment">// why not enum</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isXML;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isJSON;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIsCSV</span><span class="params">(<span class="keyword">boolean</span> e)</span> </span>&#123;isCSV = e;&#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIsXML</span><span class="params">(<span class="keyword">boolean</span> e)</span> </span>&#123;isXML = e;&#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIsJSON</span><span class="params">(<span class="keyword">boolean</span> e)</span> </span>&#123;isJSON = e;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">import</span><span class="params">(File file)</span> </span>&#123;</div><div class="line">        <span class="comment">// why not if-else</span></div><div class="line">        <span class="keyword">if</span> (isCSV) CSVIn(file); 	<span class="comment">//??? </span></div><div class="line">        <span class="keyword">if</span> (isXML) XMLIn(file); 	<span class="comment">//???</span></div><div class="line">        <span class="keyword">if</span> (isJSON) JSONIn(file); 	<span class="comment">//???</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-work/company-ghost-story-10" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/21/work/company-ghost-story-10/" class="article-date">
  <time datetime="2021-06-21T02:00:00.000Z" itemprop="datePublished">2021-06-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/工作應用/">工作應用</a>/<a class="article-category-link" href="/categories/工作應用/鬼故事/">鬼故事</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/21/work/company-ghost-story-10/">Company Ghost Story 公司鬼故事 10</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2021/06/21/work/company-ghost-story-10/" data-id="ckvx4dx9t02gdpgvnja4vph7u" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2021/06/21/work/company-ghost-story-10/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/鬼故事/">鬼故事</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><h3 id="Compare-Function"><a href="#Compare-Function" class="headerlink" title="Compare Function"></a>Compare Function</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Collections.sort(arr, (x, y) -&gt; (<span class="keyword">int</span>) (x.cost - y.cost));</div><div class="line">Collections.sort(arr, (x, y) -&gt; Long.valueOf(x).compareTo(y));</div><div class="line">Collections.sort(arr, (x, y) -&gt; (<span class="keyword">int</span>) Math.round(x.cost - y.cost));</div><div class="line"></div><div class="line"><span class="comment">// why not use official methods?</span></div><div class="line">Collections.sort(arr, (x, y) -&gt; Double.compare(x.cost, y.cost));</div><div class="line">Collections.sort(arr, (x, y) -&gt; Long.compare(x, y));</div></pre></td></tr></table></figure>
<p>別鬧了，會 overflow/underflow，數量一大，每一個排序都在丟例外給我啊。</p>
<h3 id="Partition-Function"><a href="#Partition-Function" class="headerlink" title="Partition Function"></a>Partition Function</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Optimizer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">avgX</span><span class="params">(ArrayList&lt;Point&gt; pts)</span> </span>&#123;</div><div class="line">        ArrayList&lt;Long&gt; x = <span class="keyword">new</span> ArrayList&lt;&gt;(pts.size());</div><div class="line">        <span class="keyword">for</span> (Point p : pts)</div><div class="line">            x.add(p.x);</div><div class="line">        <span class="keyword">return</span> avg(x);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">avg</span><span class="params">(ArrayList&lt;Long&gt; xs)</span> </span>&#123;</div><div class="line">        <span class="keyword">long</span> sum = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (Long x : xs)</div><div class="line">            sum += x;</div><div class="line">        <span class="keyword">return</span> sum / xs.size();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// ... why not merge avg() into avgX()?</span></div></pre></td></tr></table></figure>
<p>每次都要額外建一個陣列，而且這個函數只有被內部的單一函數呼叫，函數切這麼細，但是效能卻爛掉。</p>
<h3 id="Try-Catch-vs-If-Else"><a href="#Try-Catch-vs-If-Else" class="headerlink" title="Try-Catch vs. If-Else"></a>Try-Catch vs. If-Else</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parser</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addChar</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            que[index] = c;</div><div class="line">        &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</div><div class="line">            doubleArray();</div><div class="line">            que[index] = c;</div><div class="line">        &#125;</div><div class="line">        index++;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// why not just write if-else statements, it's really hard to maintain your code.</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parser</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addChar</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (index &gt;= que.length)</div><div class="line">            doubleArray(index);</div><div class="line">        que[index] = c;</div><div class="line">        index++;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果在修改這幾段代碼的時候，還得經常考慮例外處理是怎麼做的，這寫法真的太奇葩。要是開剖析器去檢查，會經常看到例外出現，那到底是好事還壞事？</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-java/java-memory-optimization-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/05/30/java/java-memory-optimization-2/" class="article-date">
  <time datetime="2021-05-30T05:00:00.000Z" itemprop="datePublished">2021-05-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/工作應用/">工作應用</a>/<a class="article-category-link" href="/categories/工作應用/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/05/30/java/java-memory-optimization-2/">Java 優化內存使用 組合篇</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2021/05/30/java/java-memory-optimization-2/" data-id="ckvx4dx2b025ppgvnmzz06ue8" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2021/05/30/java/java-memory-optimization-2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/memory/">memory</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/performance/">performance</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化/">優化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/內存/">內存</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/效能/">效能</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/記憶體/">記憶體</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="整數映射-Integer-Mapping"><a href="#整數映射-Integer-Mapping" class="headerlink" title="整數映射 (Integer Mapping)"></a>整數映射 (Integer Mapping)</h2><p>算法經常會使用整數映射到物件，而整數範圍就會影響到內存。為了技術性能 (capability)，直接宣告 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Map&lt;Long, Object&gt; a;</div><div class="line">TLongObjectMap&lt;Object&gt; b;</div></pre></td></tr></table></figure>
<p>以應付未來變化。考慮到鍵值欄位，實作上建立 <span>$\mathcal{O}(n)$</span><!-- Has MathJax --> <code>long[]</code>。在初始狀態下，大多情境只使用 <code>int[]</code> 的情況。為此，我們考慮分流使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MMap</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    TLongObjectMap&lt;T&gt; longMap;</div><div class="line">    TIntObjectMap&lt;T&gt; intMap;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用這樣子的概念，通用狀態可以降低 <span>$50\%$</span><!-- Has MathJax --> 內存，均勻分布情況則可以降低 <span>$25\%$</span><!-- Has MathJax -->。</p>
<h2 id="陣列替代-Array-Substitute"><a href="#陣列替代-Array-Substitute" class="headerlink" title="陣列替代 (Array Substitute)"></a>陣列替代 (Array Substitute)</h2><p>前一篇，我們提到了將 <code>ArrayList</code> 換成最原生的 <code>T[]</code>。更進一步，以前寫 C 的時候，壓根不在意 <code>T[].length</code> 這一個需求，因為題目已經寫死在某個全區變數裡。可在 Java 裡頭，我們宣告不出純粹的陣列，只能硬生生多出 <span>$4 \; \text{bytes}$</span><!-- Has MathJax -->。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scheme</span> </span>&#123;</div><div class="line">    K[] keys; <span class="comment">// as known, keys.length = 10</span></div><div class="line">    V[] vals; <span class="comment">// as known, vals.length = 10</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>換個方向思考，那朝著減少試試。進行陣列雙向合併</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scheme</span> </span>&#123;</div><div class="line">    Object[] keyval; <span class="comment">// [key0, key1, ..., val1, val0]</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>Scheme</code> 物件中，我們減少了 <span>$8 \; \text{bytes}$</span><!-- Has MathJax --> 的額外資訊。但在使用時， casting 是個開銷。</p>
<h2 id="欄位轉移-Field-Translation"><a href="#欄位轉移-Field-Translation" class="headerlink" title="欄位轉移 (Field Translation)"></a>欄位轉移 (Field Translation)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Map&lt;T, String&gt; map;</div><div class="line">map.put(a, <span class="string">"MARKED"</span>);</div><div class="line">map.put(b, <span class="string">"UNMARKED"</span>);</div></pre></td></tr></table></figure>
<p>當我們還沒有仔細規劃結構時，直接用 <strong>has-A</strong> 的精神去寫第一步。回過頭來，就會造成不少零散的映射出現。如果映射使用雜湊實作，而不是樹的話，整體的記憶體效率會低個 <span>$33\%$</span><!-- Has MathJax -->，因為無法塞滿所有的 hash table 中的桶子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">T</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    Object userData;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>那為了提升記憶體效率，先檢查是不是所有的項目，幾乎都在這個映射裡面。如果是的話，將這個欄位轉移到目標類別上。看起來很不美觀，但進一步的資料佈局是很可觀的，甚至可以比雜湊 <span>$\mathcal{O}(1)$</span><!-- Has MathJax --> 更快的存取。</p>
<h2 id="卸載策略-Offloading-Strategy"><a href="#卸載策略-Offloading-Strategy" class="headerlink" title="卸載策略 (Offloading Strategy)"></a>卸載策略 (Offloading Strategy)</h2><p>在平行處理中，我們可以劃分成不同數量級的策略。在小規模下，嘗試先以 CPU 計算，若發現更大規模，將資料卸載給其他異質計算單元來完成。同樣的道理，對於資料結構也能更近一步地劃分。</p>
<p>如集合實作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MSet</span> </span>&#123;</div><div class="line">    Object mRaw; <span class="comment">// size &lt; 8: LinkedList; otherwise, HashSet</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由於 Java 中的 <code>HashSet&lt;T&gt;</code> 並不是單一欄位的實作，實值為 <code>HashMap&lt;T, T&gt;</code>，相較於 C/C++ 的狀態，空間多了兩、三成。我們可以簡單使用 <code>LinkedList</code> 取代 <code>HashSet</code>，並且避免小規模數據中未能填滿 hash table 的狀態。在元素個數為一時，串列的記憶體效率 <span>$100 \%$</span><!-- Has MathJax -->，但雜湊集合只有 <span>$12.5 \%$</span><!-- Has MathJax -->。換句話說，有時候數據分布很極端，內存用量就差了十倍。</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-java/java-memory-optimization-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/05/30/java/java-memory-optimization-1/" class="article-date">
  <time datetime="2021-05-30T04:00:00.000Z" itemprop="datePublished">2021-05-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/工作應用/">工作應用</a>/<a class="article-category-link" href="/categories/工作應用/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/05/30/java/java-memory-optimization-1/">Java 優化內存使用 結構篇</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2021/05/30/java/java-memory-optimization-1/" data-id="ckvx4dx2s0265pgvngvvlkqws" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2021/05/30/java/java-memory-optimization-1/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/memory/">memory</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/performance/">performance</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化/">優化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/內存/">內存</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/效能/">效能</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/記憶體/">記憶體</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>首先，針對 JVM 這一類的語言設計，所有事物皆為物件，那麼就表示每一個物件都必須額外紀錄 object header，也就是說一個物件在 64 位元的作業系統環境下，通常會額外帶有 12 bytes 資料 (mark word:4 bytes 和 klass word:8 bytes)，但 64 位元計算機架構需對齊 8 bytes 的規範，使得每一個物件都大上許多。</p>
<p>例如，一個 <code>struct Point</code> 在 C 語言裡面，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Point</span> &#123;</span></div><div class="line">    <span class="keyword">long</span> x; <span class="comment">// 8 byte</span></div><div class="line">    <span class="keyword">long</span> y; <span class="comment">// 8 byte</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我們輕易地就明白單一物件大小為 16 bytes，而在 Java 撰寫時，卻會變成 <span>$32 \; \text{bytes} \;(\text{header:}12 + \text{x:}8 + \text{y:}8 + \text{padding:}4)$</span><!-- Has MathJax -->。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123; <span class="comment">// object header 12 byte</span></div><div class="line">    <span class="keyword">long</span> x; <span class="comment">// 8 byte</span></div><div class="line">    <span class="keyword">long</span> y; <span class="comment">// 8 byte</span></div><div class="line">    <span class="comment">// padding 4 byte</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>這樣看起來並不妙。相同的演算法、配上相同的數據，Java 處理時的內容硬是比 C 還多出整整兩倍。物件導向有其優點，必然存在一些缺點，可以很彈性地開發、豐富的權限管理、方便追蹤剖析，卻容易在非常基礎的大量計算中暴露記憶體方面的問題。</p>
<h2 id="打包物件-packed-object"><a href="#打包物件-packed-object" class="headerlink" title="打包物件 (packed object)"></a>打包物件 (packed object)</h2><p>對於基礎物件，就只能倚靠撰寫 JNI 或者修改 JVM 的參數，來降低每一個單一物件的大小。對於底層不夠熟悉的開發者而言，還是可以透過一些實作方法來完成。但必須犧牲一點物件導向的方法論，喪失維護性，面對真實問題。</p>
<p>例如，我們儲存一個矩形，需要一個左上角和右下角的點。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span> </span>&#123;</div><div class="line">    Point a; <span class="comment">// pointer: 8 bytes</span></div><div class="line">    Point b; <span class="comment">// pointer: 8 bytes</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>資深工程師總會很直覺地 <strong>重複使用</strong>，這個原則並沒有錯，但對於大量的基礎物件而言，宣告一個矩形實際上會占用 <span>$32 + 2 \times 32 = 96 \; \text{bytes}$</span><!-- Has MathJax -->。接著，老是有人跟我唱反調說「效能分析工具 (Profiler) 只給出 <span>$32 \; \text{bytes}$</span><!-- Has MathJax -->，你肯定算錯了！」別忘了，你寫的不是 C/C++，是一切皆為指標的 Java。</p>
<p>那我們要怎麼打包物件呢？或者說 <strong>攤平</strong>，目標要減少 <code>Point</code> 多出來的 object header。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> lx;</div><div class="line">    <span class="keyword">long</span> ly;</div><div class="line">    <span class="keyword">long</span> rx;</div><div class="line">    <span class="keyword">long</span> ry;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>返璞歸真，直接將欄位往上提取，破壞一點基礎建設，在一些 API 上犧牲一點效能。這樣就變成了 <span>$48 \; \text{bytes} = 12 + 8 \times 4 + 4 \; \text{bytes}$</span><!-- Has MathJax --> 的物件。如此一來，減少了一半的內存用量。</p>
<h2 id="原始型別-Primitive-Type"><a href="#原始型別-Primitive-Type" class="headerlink" title="原始型別 (Primitive Type)"></a>原始型別 (Primitive Type)</h2><p>在很多不經意的操作下，很容易將原始型別 (primitive type) 儲存成物件型別 (object type)，也就是物件導向最容易造成的問題，從整體用法來分析，並不影響程式正確性，但會造成記憶體用量飆高。如 <code>long</code> 原本為 8-byte 物件，轉換成 <code>Long</code> 會變成 24-byte 物件。</p>
<h3 id="繼承與泛型影響"><a href="#繼承與泛型影響" class="headerlink" title="繼承與泛型影響"></a>繼承與泛型影響</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Version</span> <span class="keyword">extends</span> <span class="title">Pair</span>&lt;<span class="title">Long</span>, <span class="title">Long</span>&gt; </span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>當想重複使用類別，透過繼承的泛型很容易自動轉換成物件型別。這個問題在 C# 內並不存在，CIL 能允許宣告 <code>Pair&lt;long, long&gt;</code>，並且不透過型別抹除，分別建立相應的代碼，能解決此問題。在 Java 上要解決這個問題，只能更樸素一點。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Version</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> major;</div><div class="line">    <span class="keyword">long</span> minor;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代碼多了一點，取而代之的是記憶體量減少，物件轉換次數的降低。</p>
<h3 id="多形使用"><a href="#多形使用" class="headerlink" title="多形使用"></a>多形使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">List&lt;Object&gt; list;</div><div class="line">list.add(<span class="number">1</span>);</div><div class="line">Map&lt;Object, Object&gt; map;</div><div class="line">map.put(<span class="number">2</span>, <span class="number">3</span>);</div></pre></td></tr></table></figure>
<p>多形操作下，將好幾種不同類別的物件一起使用，隱式轉換問題就會發生，一般要追到底層才知道最後發生什麼事情。由於 Java 官方的庫並沒有預設大量的原生型別的資料結構，我們只能透過像 trove4j、eclipse collections 等插件來補足，必要時自己刻一個。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">TLongObjectMap&lt;T&gt; a;</div><div class="line">TLongArrayList b;</div><div class="line">...</div></pre></td></tr></table></figure>
<h2 id="資料結構-Data-Structure"><a href="#資料結構-Data-Structure" class="headerlink" title="資料結構 (Data Structure)"></a>資料結構 (Data Structure)</h2><h3 id="雜湊表-Hash-Table"><a href="#雜湊表-Hash-Table" class="headerlink" title="雜湊表 (Hash Table)"></a>雜湊表 (Hash Table)</h3><p>在大多數的實作下，雜湊表佔據線性空間 <span>$\mathcal{O}(n)$</span><!-- Has MathJax -->，存取時間 <span>$\mathcal{O}(1)$</span><!-- Has MathJax -->，理論分析上也近乎完美。在處理碰撞的技巧上，影響常數級別的空間用量。通常分成以下兩種</p>
<h4 id="開放定址法-Open-Addressing"><a href="#開放定址法-Open-Addressing" class="headerlink" title="開放定址法 (Open Addressing)"></a>開放定址法 (Open Addressing)</h4><p>trove4j 和 eclipse collections 採用此方法。</p>
<ul>
<li>使用記憶體空間最小<br>  僅有兩個陣列 <code>key[]</code> 和 <code>value[]</code>，沒有多餘的 object header。</li>
<li>存取常數大，調整時間較長<br>  通常會有兩個以上的 probing 操作，中間穿插刪除操作時，容易造成退化。</li>
</ul>
<h4 id="串鏈法-Chaining"><a href="#串鏈法-Chaining" class="headerlink" title="串鏈法 (Chaining)"></a>串鏈法 (Chaining)</h4><p>jdk 預設採用此方法。</p>
<ul>
<li>使用記憶體空間最大<br>  <code>HashNode {val, next, prev}</code> 佔據了大部分的記憶體，且大量的 object header 出現。</li>
<li>存取常數較小</li>
</ul>
<p>從穩定性分析上，串鏈法在某種程度上可以複合許多結構，如 unrolled linked list (bucket) 或者是 binary tree 來降低最慘複雜度。而開放定址法，雖然有記憶體用量小，快取能力更高，但數據量一大，很容易在 rehash 的階段花太久的時間，而且不容易做到刪除操作。</p>
<h3 id="固定長度陣列-Fixed-length-Array"><a href="#固定長度陣列-Fixed-length-Array" class="headerlink" title="固定長度陣列 (Fixed-length Array)"></a>固定長度陣列 (Fixed-length Array)</h3><p>Java 開發久了，連宣告陣列都很吃技術。有時候，並沒仔細探討固定長度與不固定長度的差異。劈頭就寫一個</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scheme</span> </span>&#123;</div><div class="line">    ArrayList&lt;Field&gt; fields;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>這樣的設計擴充性佳，具有彈性。在底層設計時，卻會發現 <code>ArrayList</code> 至少包含了 <code>size</code> 和 <code>val[]</code> 兩個欄位，而 <code>val[]</code> 包含了真正的 <code>array pointer</code> 和 <code>length</code> 兩個欄位。如果已知固定長度且不再變更，或者變更的使用量極低，且能保證 <code>size == val.length</code>，那不如直接宣告</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scheme</span> </span>&#123;</div><div class="line">    Field[] fields;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如此一來，一個 <code>Scheme</code> 物件便能減少 <span>$16 \; \text{bytes}$</span><!-- Has MathJax -->。更進一步，我們可以利用封裝 (Encapsulation) 和多型技術，再降低 <span>$8 \; \text{bytes}$</span><!-- Has MathJax -->。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scheme1</span> </span>&#123;</div><div class="line">    Field f1;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scheme2</span> </span>&#123;</div><div class="line">    Field f1;</div><div class="line">    Field f2;</div><div class="line">&#125;</div><div class="line">...</div></pre></td></tr></table></figure>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>根據實際應用的數據分布，對最常用的物件進行優化。醜了點，但能解決問題。雖然並不是黑魔法，更能了解實作。</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-work/meme-globl-var" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/31/work/meme-globl-var/" class="article-date">
  <time datetime="2021-01-31T05:00:00.000Z" itemprop="datePublished">2021-01-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/工作應用/">工作應用</a>/<a class="article-category-link" href="/categories/工作應用/Meme/">Meme</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="https://i.imgur.com/ZOytC47.jpg" rel="gallery_ckvx4dxa302gopgvnzkojj7y5">
        <img src="https://i.imgur.com/ZOytC47.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/01/31/work/meme-globl-var/">Global Variable</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2021/01/31/work/meme-globl-var/" data-id="ckvx4dxa302gopgvnzkojj7y5" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2021/01/31/work/meme-globl-var/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Meme/">Meme</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>Global variable is convenient for me.</p>
</blockquote>
<p>當調用或請求資源的時候，發現資源無法被載入記憶體中。原來是同事都寫全域變數來存放臨時資料，導致在沒釋放資源的操作後，後續的修改都無法成立</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/categories/工作應用/page/2/">2</a><a class="page-number" href="/categories/工作應用/page/3/">3</a><a class="page-number" href="/categories/工作應用/page/4/">4</a><a class="extend next" rel="next" href="/categories/工作應用/page/2/">Next &raquo;</a>
    </nav>
  
</section>
          
          
            <aside id="sidebar">
  <!-- <div id="ukagaka_panel"></div> -->
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/">學校課程</a><span class="category-list-count">115</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/介面設計/">介面設計</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/作業系統/">作業系統</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/即時系統/">即時系統</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/大學專題/">大學專題</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/巨量資料/">巨量資料</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/平行程式/">平行程式</a><span class="category-list-count">43</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/敏捷方法/">敏捷方法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/編譯器/">編譯器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/自然語言/">自然語言</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/虛擬實境/">虛擬實境</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算型智慧/">計算型智慧</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算幾何/">計算幾何</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算機圖學/">計算機圖學</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資料庫系統/">資料庫系統</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資訊安全/">資訊安全</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/通識課程/">通識課程</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/">工作應用</a><span class="category-list-count">38</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Java/">Java</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Meme/">Meme</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/其他/">其他</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/可持久化/">可持久化</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/鬼故事/">鬼故事</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/手札日記/">手札日記</a><span class="category-list-count">51</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/">網頁設計</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/About-This-Blog/">About This Blog</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/HTML5/">HTML5</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/JQuery/">JQuery</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/Markdown/">Markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/NodeJs/">NodeJs</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/">解題區</a><span class="category-list-count">633</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/Latex/">Latex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/出題解題/">出題解題</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-POJ/">解題區 - POJ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a><span class="category-list-count">483</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a><span class="category-list-count">77</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-未解題目/">解題區 - 未解題目</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/雜言筆記/">雜言筆記</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a class="text" href="/2021/11/12/diary-20211112-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·參》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/31/diary-20211031-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·貳》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/28/diary-202110-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·序》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/28/diary-202110/">
              
                <i class="icon-file-o"></i> 
              
            好多個 28 在這個時刻</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/28/work/company-ghost-story-14/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 14</a>
          </li>
        
          <li>
            <a class="text" href="/2021/09/12/work/appreciation-letter/">
              
                <i class="icon-file-o"></i> 
              
            Shiny People 感謝</a>
          </li>
        
          <li>
            <a class="text" href="/2021/09/12/work/company-ghost-story-13/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 13</a>
          </li>
        
          <li>
            <a class="text" href="/2021/08/15/diary-202108/">
              
                <i class="icon-file-o"></i> 
              
            被預告要開始管人的我，今天開始學管理？</a>
          </li>
        
          <li>
            <a class="text" href="/2021/08/14/work/company-ghost-story-12/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 12</a>
          </li>
        
          <li>
            <a class="text" href="/2021/07/29/java/java-jni-tls-error-2/">
              
                <i class="icon-file-o"></i> 
              
            Java JNI GC Thread Error (EINVAL)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">   
        <ul>
          <li><a href="http://mypaper.pchome.com.tw/zerojudge" target="_blank" title="Old Blog"><i class="icon-star"></i> Morris' Blog (pchome)</a></li>
        </ul>
    </div>
</div>

  
    
<script src="/js/jquery-ui.js"></script>
<script src="/js/ukagaka/jquery.morris.ukagaka.resource.js"></script>
<script src="/js/ukagaka/typed.js"></script>
  
  
</aside>
          
        
      </div>
      <footer id="footer">
  
  <div class="outer">    
    <div class="social-group">
      
      <a href="https://github.com/morris821028" target="_blank" title="github"><i class="icon-github"></i></a>
      
      
      <a href="https://www.facebook.com/Morris1028" target="_blank" title="facebook"><i class="icon-facebook-sign"></i></a>
      
      
      <a href="http://uhunt.felix-halim.net/id/46705" target="_blank" title="uhunt" ><span class="icon-uhunt">UVa<span></a>
      
    </div>
    <div id="footer-info" class="inner">
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/morris821028/hexo-theme-landscape" target="_blank" title="landscape">landscape</a> &copy; 2021 Shiang-Yun Yang 
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link"><i class=icon-home ></i>&nbsp&nbspHome</a>
  
    <a href="/about" class="mobile-nav-link"><i class=icon-user ></i>&nbsp&nbspAbout</a>
  
    <a href="/archives" class="mobile-nav-link"><i class=icon-archive ></i>&nbsp&nbspArchives</a>
  
    <a href="/tags" class="mobile-nav-link"><i class=icon-tags ></i>&nbsp&nbspTags</a>
  
    <a href="/picture" class="mobile-nav-link"><i class=icon-camera ></i>&nbsp&nbspPictures</a>
  
    <a href="/works" class="mobile-nav-link"><i class=icon-trophy ></i>&nbsp&nbspWorks</a>
  
</nav>
    
<script>
  var disqus_shortname = 'morris1028';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/jquery.lazyload.js"></script>
<script src="/js/jquery.als-1.6.js"></script>

<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>