<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Category: 學校課程 | Morris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Morris&#39; Blog">
<meta property="og:url" content="http://morris821028.github.io/categories/學校課程/index.html">
<meta property="og:site_name" content="Morris&#39; Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Morris&#39; Blog">
<link rel="publisher" href="108158678174364350000">
  
    <link rel="alternative" href="/atom.xml" title="Morris&#39; Blog" type="application/atom+xml">
  
  
    <meta name="google-site-verification" content="5mRgj8NanEMpGZuNfHNJNmH90RgNlrnJXsFlTaKD6Gs" />
  
  
    <link rel="shortcut icon" href="/img/f.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script src="/js/jquery-2.1.0.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.5.1.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdn.oesmith.co.uk/morris-0.5.1.min.js"></script>
  <!-- <link rel="import" href="/bower_components/app-layout/app-layout.html"> --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"><div id="banner-right"></div></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Morris&#39; Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class=icon-home title='Home'></i></a>
          
        
          
            <a class="main-nav-link" href="/about"><i class=icon-user title='About'></i></a>
          
        
          
            <a class="main-nav-link" href="/archives"><i class=icon-archive title='Archives'></i></a>
          
        
          
            <a class="main-nav-link" href="/tags"><i class=icon-tags title='Tags'></i></a>
          
        
          
            <a class="main-nav-link" href="/picture"><i class=icon-camera title='Pictures'></i></a>
          
        
          
            <a class="main-nav-link" href="/works"><i class=icon-trophy title='Works'></i></a>
          
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://morris821028.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        
          
          <section id="main">
  
    <article id="post-jg-20021" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/01/jg-20021/" class="article-date">
  <time datetime="2017-07-01T07:38:49.000Z" itemprop="datePublished">2017-07-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/平行程式/">平行程式</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/01/jg-20021/">批改娘 20021. Dynamic Range Sum</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/07/01/jg-20021/" data-id="ckxwy6rrv0079esvnvm74cadj" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/07/01/jg-20021/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SIMD/">SIMD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/批改娘/">批改娘</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h2><p>在二維平面上有 <span>$N$</span><!-- Has MathJax --> 個點，每一個點 <span>$p_i(x_i, y_i)$</span><!-- Has MathJax -->各自帶權重 <span>$w_i$</span><!-- Has MathJax -->，這些點不時會移動和改變權重。</p>
<p>現在 Morris 希望你幫忙撰寫線性搜索的函數，好讓他專注數據結構上的調整。函數詢問包含 </p>
<ul>
<li><span>$N$</span><!-- Has MathJax --> 個點的資訊 (以 SoA (Structure of Array) 的方式儲存，以達到最好的快取使用率) </li>
<li>詢問的矩形 <span>$\text{Rect}$</span><!-- Has MathJax --> (正交於兩軸)</li>
</ul>
<p>函數必須回傳在矩形內部的點權重和。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int32_t</span> search_range(Rect rect, <span class="keyword">int32_t</span> x[], <span class="keyword">int32_t</span> y[], <span class="keyword">int32_t</span> w[], <span class="keyword">int32_t</span> n);</div></pre></td></tr></table></figure>
<h3 id="main-c-測試用"><a href="#main-c-測試用" class="headerlink" title="main.c (測試用)"></a>main.c (測試用)</h3><ul>
<li>一開始，在二維空間 <span>$[0, R) \times [0, R)$</span><!-- Has MathJax --> 之間產生 <span>$N$</span><!-- Has MathJax --> 個點的資訊</li>
<li>接著，模擬 <span>$M$</span><!-- Has MathJax --> 次點的變化，並且呼叫 <code>search_range</code> </li>
<li>最後，將所有答案 HASH 輸出一個值</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"DRS.h"</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">uint32_t</span> seed = <span class="number">0</span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">p_srand</span><span class="params">(<span class="keyword">uint32_t</span> x)</span> </span>&#123; seed = x;&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> uint32_t <span class="title">p_rand</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> seed = (seed*<span class="number">9301</span> + <span class="number">49297</span>);&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span> *x, <span class="keyword">int</span> *y)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> tmp = *x;</div><div class="line">    *x = *y;</div><div class="line">    *y = tmp;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> Rect <span class="title">rand_rect</span><span class="params">(<span class="keyword">int</span> R)</span> </span>&#123;</div><div class="line">    Rect r;</div><div class="line">    r.lx = p_rand()%R;</div><div class="line">    r.ly = p_rand()%R;</div><div class="line">    r.rx = p_rand()%R;</div><div class="line">    r.ry = p_rand()%R;</div><div class="line">    <span class="keyword">if</span> (r.lx &gt; r.rx)	swap(&amp;r.lx, &amp;r.rx);</div><div class="line">    <span class="keyword">if</span> (r.ly &gt; r.ry)	swap(&amp;r.ly, &amp;r.ry);</div><div class="line">    <span class="keyword">return</span> r;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> N, <span class="keyword">int</span> R, <span class="keyword">int32_t</span> x[], <span class="keyword">int32_t</span> y[], <span class="keyword">int32_t</span> w[])</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">        x[i] = p_rand()%R;</div><div class="line">        y[i] = p_rand()%R;</div><div class="line">        w[i] = p_rand()%R;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tick</span><span class="params">(<span class="keyword">int</span> N, <span class="keyword">int</span> R, <span class="keyword">int32_t</span> x[], <span class="keyword">int32_t</span> y[], <span class="keyword">int32_t</span> w[])</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)	&#123;</div><div class="line">        <span class="keyword">int</span> idx = p_rand()%N;</div><div class="line">        x[idx] = p_rand()%R;</div><div class="line">        y[idx] = p_rand()%R;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)	&#123;</div><div class="line">        <span class="keyword">int</span> idx = p_rand()%N;</div><div class="line">        w[idx] = p_rand()%R;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 1048576</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    p_srand(<span class="number">0</span>);</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int32_t</span> x[MAXN], y[MAXN], w[MAXN];</div><div class="line">    <span class="keyword">int</span> N = <span class="number">1000</span>, M = <span class="number">10000</span>, R = <span class="number">100</span>;</div><div class="line">    </div><div class="line">    init(N, R, x, y, w);</div><div class="line"></div><div class="line">    <span class="keyword">int32_t</span> hash = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> it = <span class="number">0</span>; it &lt; M; it++) &#123;</div><div class="line">        Rect rect = rand_rect(R);</div><div class="line">        <span class="keyword">int32_t</span> ret = search_range(rect, x, y, w, N);</div><div class="line">        hash ^= ret;</div><div class="line">        tick(N, R, x, y, w);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%"</span> PRIi32 <span class="string">"\n"</span>, hash);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="DRS-h"><a href="#DRS-h" class="headerlink" title="DRS.h"></a>DRS.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __DRS_H</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> __DRS_H</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Rect</span> &#123;</span></div><div class="line">    <span class="keyword">int32_t</span> lx, ly, rx, ry;</div><div class="line">&#125; Rect;</div><div class="line"></div><div class="line"><span class="keyword">int32_t</span> search_range(Rect rect, <span class="keyword">int32_t</span> x[], <span class="keyword">int32_t</span> y[], </div><div class="line">        <span class="keyword">int32_t</span> w[], <span class="keyword">int32_t</span> n);</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure>
<h3 id="DRS-c"><a href="#DRS-c" class="headerlink" title="DRS.c"></a>DRS.c</h3><p>你的目標是要加速下述函數的計算，通過最低要求加速 2 倍以上。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"DRS.h"</span></span></div><div class="line"></div><div class="line"><span class="keyword">int32_t</span> search_range(Rect rect, <span class="keyword">int32_t</span> x[], <span class="keyword">int32_t</span> y[], </div><div class="line">        <span class="keyword">int32_t</span> w[], <span class="keyword">int32_t</span> n) &#123;</div><div class="line">    <span class="keyword">int32_t</span> ret = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (rect.lx &lt;= x[i] &amp;&amp; x[i] &lt;= rect.rx &amp;&amp;</div><div class="line">            rect.ly &lt;= y[i] &amp;&amp; y[i] &lt;= rect.ry) &#123;</div><div class="line">            ret += w[i];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="測資限制"><a href="#測資限制" class="headerlink" title="測資限制"></a>測資限制</h2><ul>
<li>$N \le 131072$</li>
<li>$R \le 32768$</li>
</ul>
<h2 id="範例輸入"><a href="#範例輸入" class="headerlink" title="範例輸入"></a>範例輸入</h2><p><strong><em>no input</em></strong></p>
<h2 id="範例輸出"><a href="#範例輸出" class="headerlink" title="範例輸出"></a>範例輸出</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">8967</div></pre></td></tr></table></figure>
<h2 id="編譯參數"><a href="#編譯參數" class="headerlink" title="編譯參數"></a>編譯參數</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">all: main</div><div class="line"></div><div class="line">main: main.c</div><div class="line">    gcc -std=c99 -Ofast -march=native DRS.c -c -o DRS.o</div><div class="line">    gcc -std=c99 -Ofast -march=native main.c DRS.o -o main</div></pre></td></tr></table></figure>
<ul>
<li>當前測試機器 Intel CPU E5-2620v3</li>
<li><a href="https://software.intel.com/sites/landingpage/IntrinsicsGuide/#" target="_blank" rel="external">Intel Intrinsics Guide</a></li>
</ul>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>一般的線性作法，透過 <code>rect.lx &lt;= x[i] &amp;&amp; x[i] &lt;= rect.rx &amp;&amp; rect.ly &lt;= y[i] &amp;&amp; y[i] &lt;= rect.ry</code> 操作，翻譯成組合語言時，四次的 branch &amp; jump，在管線處理上的效能易受到影響。為了使這種 branch 減少而不使管線處理的效能下降，通常會使用查表法來完成，藉由并行的數值計算，在最後一步才進行 load/store 完成指定區塊的指令。</p>
<p>在這一題中，唯有條件式皆成立才執行，由於分枝操作上只有一種情況，故查表法就不適用於此。我們仍可以并行數個矩形判斷，並且存在至少一個矩形成立再運行 load 加總所需的資料，將會給予效能上的大幅提升。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"DRS.h"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;x86intrin.h&gt;</span></span></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">int32_t search_range(Rect rect, int32_t x[], int32_t y[], </span></div><div class="line"><span class="comment">		int32_t w[], int32_t n) &#123;</span></div><div class="line"><span class="comment">	int32_t ret = 0;</span></div><div class="line"><span class="comment">	for (int i = 0; i &lt; n; i++) &#123;</span></div><div class="line"><span class="comment">		if (rect.lx &lt;= x[i] &amp;&amp; x[i] &lt;= rect.rx &amp;&amp;</span></div><div class="line"><span class="comment">			rect.ly &lt;= y[i] &amp;&amp; y[i] &lt;= rect.ry) &#123;</span></div><div class="line"><span class="comment">			ret += w[i];</span></div><div class="line"><span class="comment">		&#125;</span></div><div class="line"><span class="comment">	&#125;</span></div><div class="line"><span class="comment">	return ret;</span></div><div class="line"><span class="comment">&#125;</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">int32_t</span> search_range(Rect rect, <span class="keyword">int32_t</span> x[], <span class="keyword">int32_t</span> y[], <span class="keyword">int32_t</span> w[], <span class="keyword">int32_t</span> n) &#123;</div><div class="line">    __m128i ret = _mm_set_epi32(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    rect.lx--, rect.ly--;</div><div class="line">    rect.rx++, rect.ry++;</div><div class="line">    __m128i lx = _mm_broadcastd_epi32(*((__m128i *) &amp;rect.lx));</div><div class="line">    __m128i ly = _mm_broadcastd_epi32(*((__m128i *) &amp;rect.ly));</div><div class="line">    __m128i rx = _mm_broadcastd_epi32(*((__m128i *) &amp;rect.rx));</div><div class="line">    __m128i ry = _mm_broadcastd_epi32(*((__m128i *) &amp;rect.ry));</div><div class="line">    __m128i zo = _mm_set_epi32(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    __m128i ic = _mm_set_epi32(<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i+<span class="number">4</span> &lt;= n; i += <span class="number">4</span>) &#123;</div><div class="line">        __m128i sx = _mm_load_si128((__m128i *) (x+i));</div><div class="line">        __m128i sy = _mm_load_si128((__m128i *) (y+i));</div><div class="line">        __m128i c1 = _mm_and_si128(_mm_cmplt_epi32(lx, sx), _mm_cmplt_epi32(sx, rx));</div><div class="line">        __m128i c2 = _mm_and_si128(_mm_cmplt_epi32(ly, sy), _mm_cmplt_epi32(sy, ry));</div><div class="line">        <span class="keyword">if</span> (_mm_testz_si128(c1, c2) == <span class="number">0</span>) &#123;</div><div class="line">            __m128i cc = _mm_and_si128(c1, c2);</div><div class="line">            __m128i vi = _mm_add_epi32(ic, _mm_set_epi32(i, i, i, i));</div><div class="line">            __m128i rs = _mm_mask_i32gather_epi32(zo, w+i, ic, cc, <span class="number">4</span>);</div><div class="line">            ret = _mm_add_epi32(ret, rs);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">int32_t</span> sum = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = (n&gt;&gt;<span class="number">2</span>)&lt;&lt;<span class="number">2</span>; i &lt; n; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (rect.lx &lt;= x[i] &amp;&amp; x[i] &lt;= rect.rx &amp;&amp;</div><div class="line">            rect.ly &lt;= y[i] &amp;&amp; y[i] &lt;= rect.ry) &#123;</div><div class="line">            sum += w[i];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int32_t</span> tmp[<span class="number">4</span>] __attribute__ ((aligned (<span class="number">16</span>)));</div><div class="line">    _mm_store_si128((__m128i*) &amp;tmp[<span class="number">0</span>], ret);</div><div class="line">    sum += tmp[<span class="number">0</span>] + tmp[<span class="number">1</span>] + tmp[<span class="number">2</span>] + tmp[<span class="number">3</span>];</div><div class="line">    <span class="keyword">return</span> sum;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-jg-20020" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/01/jg-20020/" class="article-date">
  <time datetime="2017-07-01T05:47:41.000Z" itemprop="datePublished">2017-07-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/平行程式/">平行程式</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/01/jg-20020/">批改娘 20020. Dot Product</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/07/01/jg-20020/" data-id="ckxwy6rrt0071esvnzdyyj7lq" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/07/01/jg-20020/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SIMD/">SIMD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/批改娘/">批改娘</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h2><p>請嘗試使用 SIMD 技術 AVX/SSE/MMX 來加速以下的純數值計算。</p>
<h3 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h3><p>最低需求加速兩倍快</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> uint32_t <span class="title">rotate_left</span><span class="params">(<span class="keyword">uint32_t</span> x, <span class="keyword">uint32_t</span> n)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span>  (x &lt;&lt; n) | (x &gt;&gt; (<span class="number">32</span>-n));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> uint32_t <span class="title">encrypt</span><span class="params">(<span class="keyword">uint32_t</span> m, <span class="keyword">uint32_t</span> key)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (rotate_left(m, key&amp;<span class="number">31</span>) + key)^key;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">static</span> uint32_t <span class="title">f</span><span class="params">(<span class="keyword">int</span> N, <span class="keyword">int</span> off, <span class="keyword">uint32_t</span> key1, <span class="keyword">uint32_t</span> key2)</span> </span>&#123;</div><div class="line">    <span class="keyword">uint32_t</span> sum = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = off; i &lt; N; i++, j++)</div><div class="line">        sum += encrypt(j, key1) * encrypt(j, key2), i++, j++;</div><div class="line">    <span class="keyword">return</span> sum;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> N;</div><div class="line">    <span class="keyword">uint32_t</span> key1, key2;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %"</span> PRIu32 <span class="string">" %"</span> PRIu32, &amp;N, &amp;key1, &amp;key2) == <span class="number">3</span>) &#123;</div><div class="line">        <span class="keyword">uint32_t</span> sum = f(N, <span class="number">0</span>, key1, key2);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%"</span> PRIu32 <span class="string">"\n"</span>, sum);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="輸入格式"><a href="#輸入格式" class="headerlink" title="輸入格式"></a>輸入格式</h2><p>有多組測資，每組一行包含三個整數 <span>$N, \; \text{key1}, \; \text{key2}$</span><!-- Has MathJax -->，表示向量長度 <span>$N$</span><!-- Has MathJax -->、向量 <span>$\vec{A}$</span><!-- Has MathJax --> 由亂數種子 <span>$\text{key1}$</span><!-- Has MathJax --> 產生、向量 <span>$\vec{B}$</span><!-- Has MathJax --> 由亂數種子 <span>$\text{key2}$</span><!-- Has MathJax --> 產生。</p>
<ul>
<li>$1 \le N \le 16777216$</li>
</ul>
<h2 id="輸出格式"><a href="#輸出格式" class="headerlink" title="輸出格式"></a>輸出格式</h2><p>對於每組測資輸出一行整數，為 <span>$\vec{A} \cdot \vec{B}$</span><!-- Has MathJax --> 的 unsigned 32-bit integer 結果。</p>
<h2 id="範例輸入"><a href="#範例輸入" class="headerlink" title="範例輸入"></a>範例輸入</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">16777216 1 2</div><div class="line">16777216 3 5</div></pre></td></tr></table></figure>
<h2 id="範例輸出"><a href="#範例輸出" class="headerlink" title="範例輸出"></a>範例輸出</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">2885681152</div><div class="line">2147483648</div></pre></td></tr></table></figure>
<h2 id="編譯參數"><a href="#編譯參數" class="headerlink" title="編譯參數"></a>編譯參數</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gcc -std=c99 -O3 -march=native main.c -lm</div></pre></td></tr></table></figure>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ul>
<li>當前測試機器 Intel CPU E5-2620v3</li>
<li><a href="https://software.intel.com/sites/landingpage/IntrinsicsGuide/#" target="_blank" rel="external">Intel Intrinsics Guide</a></li>
</ul>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>對於數值計算時，SIMD 能充分地加速程序，每一個元素皆經過一連串的數學函數計算，那麼把一連串的數學式拆分，化成最簡的邏輯計算，並且找出常數向量存放到暫存器中。如在影像處理的程序，即使沒有 GPU 幫忙，搭配 SIMD 也是個不錯的選擇，可以加速 2~4 倍之多。</p>
<p>為了凸顯效能差異，題目設計時必須在計算單一元素結果上複雜些，防止大部分的加速效果是來自於減少 branch 操作 (loop unrolling)。</p>
<h3 id="AVX"><a href="#AVX" class="headerlink" title="AVX"></a>AVX</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;x86intrin.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> uint32_t <span class="title">rotate_left</span><span class="params">(<span class="keyword">uint32_t</span> x, <span class="keyword">uint32_t</span> n)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span>  (x &lt;&lt; n) | (x &gt;&gt; (<span class="number">32</span>-n));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> uint32_t <span class="title">encrypt</span><span class="params">(<span class="keyword">uint32_t</span> m, <span class="keyword">uint32_t</span> key)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (rotate_left(m, key&amp;<span class="number">31</span>) + key)^key;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> uint32_t <span class="title">SSE</span><span class="params">(<span class="keyword">int</span> N, <span class="keyword">int</span> off, <span class="keyword">uint32_t</span> key1, <span class="keyword">uint32_t</span> key2)</span> </span>&#123;</div><div class="line">    <span class="keyword">uint32_t</span> sum = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = (N&gt;&gt;<span class="number">3</span>)&lt;&lt;<span class="number">3</span>; i &lt; N; i++)</div><div class="line">        sum += encrypt(i+off, key1) * encrypt(i+off, key2);</div><div class="line">    __m256i s_i = _mm256_set_epi32(off, off+<span class="number">1</span>, off+<span class="number">2</span>, off+<span class="number">3</span>, off+<span class="number">4</span>, off+<span class="number">5</span>, off+<span class="number">6</span>, off+<span class="number">7</span>);</div><div class="line">    __m256i s_4 = _mm256_set_epi32(<span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>);</div><div class="line">    __m256i s_k1 = _mm256_set_epi32(key1, key1, key1, key1, key1, key1, key1, key1);</div><div class="line">    __m256i s_k2 = _mm256_set_epi32(key2, key2, key2, key2, key2, key2, key2, key2);</div><div class="line">    <span class="keyword">uint32_t</span> modk1 = key1&amp;<span class="number">31</span>;</div><div class="line">    <span class="keyword">uint32_t</span> modk2 = key2&amp;<span class="number">31</span>;</div><div class="line">    <span class="keyword">uint32_t</span> cmodk1 = <span class="number">32</span> - modk1;</div><div class="line">    <span class="keyword">uint32_t</span> cmodk2 = <span class="number">32</span> - modk2;</div><div class="line">    __m256i s_ret = _mm256_set_epi32(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    N &gt;&gt;= <span class="number">3</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> it = <span class="number">0</span>; it &lt; N; it++) &#123;</div><div class="line">        __m256i r_1 = _mm256_or_si256(_mm256_slli_epi32(s_i, modk1), _mm256_srli_epi32(s_i, cmodk1));</div><div class="line">        r_1 = _mm256_xor_si256(_mm256_add_epi32(r_1, s_k1), s_k1);</div><div class="line">        __m256i r_2 = _mm256_or_si256(_mm256_slli_epi32(s_i, modk2), _mm256_srli_epi32(s_i, cmodk2));</div><div class="line">        r_2 = _mm256_xor_si256(_mm256_add_epi32(r_2, s_k2), s_k2);</div><div class="line">        __m256i r_m = _mm256_mullo_epi32(r_1, r_2);</div><div class="line">        s_ret = _mm256_add_epi32(s_ret, r_m);</div><div class="line">        s_i = _mm256_add_epi32(s_i, s_4);</div><div class="line">    &#125;</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int32_t</span> tmp[<span class="number">8</span>] __attribute__ ((aligned (<span class="number">32</span>)));</div><div class="line">        _mm256_store_si256((__m256i*) &amp;tmp[<span class="number">0</span>], s_ret);</div><div class="line">        sum += tmp[<span class="number">0</span>] + tmp[<span class="number">1</span>] + tmp[<span class="number">2</span>] + tmp[<span class="number">3</span>];</div><div class="line">        sum += tmp[<span class="number">4</span>] + tmp[<span class="number">5</span>] + tmp[<span class="number">6</span>] + tmp[<span class="number">7</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> sum;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> N;</div><div class="line">    <span class="keyword">uint32_t</span> key1, key2;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %"</span> PRIu32 <span class="string">" %"</span> PRIu32, &amp;N, &amp;key1, &amp;key2) == <span class="number">3</span>) &#123;</div><div class="line">        <span class="keyword">uint32_t</span> sum = SSE(N, <span class="number">0</span>, key1, key2);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%"</span> PRIu32 <span class="string">"\n"</span>, sum);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="SSE"><a href="#SSE" class="headerlink" title="SSE"></a>SSE</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;x86intrin.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> uint32_t <span class="title">rotate_left</span><span class="params">(<span class="keyword">uint32_t</span> x, <span class="keyword">uint32_t</span> n)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span>  (x &lt;&lt; n) | (x &gt;&gt; (<span class="number">32</span>-n));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> uint32_t <span class="title">encrypt</span><span class="params">(<span class="keyword">uint32_t</span> m, <span class="keyword">uint32_t</span> key)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (rotate_left(m, key&amp;<span class="number">31</span>) + key)^key;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> uint32_t <span class="title">SSE</span><span class="params">(<span class="keyword">int</span> N, <span class="keyword">int</span> off, <span class="keyword">uint32_t</span> key1, <span class="keyword">uint32_t</span> key2)</span> </span>&#123;</div><div class="line">    <span class="keyword">uint32_t</span> sum = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = N/<span class="number">4</span>*<span class="number">4</span>; i &lt; N; i++)</div><div class="line">        sum += encrypt(i+off, key1) * encrypt(i+off, key2);</div><div class="line">    __m128i s_i = _mm_set_epi32(off, off+<span class="number">1</span>, off+<span class="number">2</span>, off+<span class="number">3</span>);</div><div class="line">    __m128i s_4 = _mm_set_epi32(<span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>);</div><div class="line">    __m128i s_k1 = _mm_set_epi32(key1, key1, key1, key1);</div><div class="line">    __m128i s_k2 = _mm_set_epi32(key2, key2, key2, key2);</div><div class="line">    <span class="keyword">uint32_t</span> modk1 = key1&amp;<span class="number">31</span>;</div><div class="line">    <span class="keyword">uint32_t</span> modk2 = key2&amp;<span class="number">31</span>;</div><div class="line">    <span class="keyword">uint32_t</span> cmodk1 = <span class="number">32</span> - modk1;</div><div class="line">    <span class="keyword">uint32_t</span> cmodk2 = <span class="number">32</span> - modk2;</div><div class="line">    __m128i s_ret = _mm_set_epi32(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    N &gt;&gt;= <span class="number">2</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> it = <span class="number">0</span>; it &lt; N; it++) &#123;</div><div class="line">        __m128i r_1 = _mm_or_si128(_mm_slli_epi32(s_i, modk1), _mm_srli_epi32(s_i, cmodk1));</div><div class="line">        r_1 = _mm_xor_si128(_mm_add_epi32(r_1, s_k1), s_k1);</div><div class="line">        __m128i r_2 = _mm_or_si128(_mm_slli_epi32(s_i, modk2), _mm_srli_epi32(s_i, cmodk2));</div><div class="line">        r_2 = _mm_xor_si128(_mm_add_epi32(r_2, s_k2), s_k2);</div><div class="line">        __m128i r_m = _mm_mullo_epi32(r_1, r_2);</div><div class="line">        s_ret = _mm_add_epi32(s_ret, r_m);</div><div class="line">        s_i = _mm_add_epi32(s_i, s_4);</div><div class="line">    &#125;</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int32_t</span> tmp[<span class="number">4</span>] __attribute__ ((aligned (<span class="number">16</span>)));</div><div class="line">        _mm_store_si128((__m128i*) &amp;tmp[<span class="number">0</span>], s_ret);</div><div class="line">        sum += tmp[<span class="number">0</span>] + tmp[<span class="number">1</span>] + tmp[<span class="number">2</span>] + tmp[<span class="number">3</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> sum;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> N;</div><div class="line">    <span class="keyword">uint32_t</span> key1, key2;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %"</span> PRIu32 <span class="string">" %"</span> PRIu32, &amp;N, &amp;key1, &amp;key2) == <span class="number">3</span>) &#123;</div><div class="line">        <span class="keyword">uint32_t</span> sum = SSE(N, <span class="number">0</span>, key1, key2);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%"</span> PRIu32 <span class="string">"\n"</span>, sum);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-jg-20018" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/01/jg-20018/" class="article-date">
  <time datetime="2017-07-01T05:27:09.000Z" itemprop="datePublished">2017-07-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/平行程式/">平行程式</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/01/jg-20018/">批改娘 20018. Square Root of Vector Elements</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/07/01/jg-20018/" data-id="ckxwy6rrr006xesvn9y38u8yh" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/07/01/jg-20018/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SIMD/">SIMD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/批改娘/">批改娘</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>Intel 公司在 X86 指令集上提供了 AVX (Advanced Vector Extensions)、SSE (Streaming SIMD Extensions) 的特殊指令，這些在 SIMD 指令上提供強力的加速。</p>
<h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>現在給你長度為 <span>$N$</span><!-- Has MathJax --> 的 32-bit floating point，分別將其開根號回傳。</p>
<ul>
<li>你可能會需要函數庫 <code>#include &lt;x86intrin.h&gt;</code></li>
<li>你可能會需要 AVX/SSE 開根指令 <a href="https://software.intel.com/en-us/cpp-compiler-18.0-developer-guide-and-reference-mm256-sqrt-ps" target="_blank" rel="external"><code>__m256 _mm256_sqrt_ps(__m256 a);</code></a></li>
</ul>
<h3 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"VSQRT.h"</span></span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">float</span> a[<span class="number">1048576</span>], b[<span class="number">1048576</span>];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; ++i)</div><div class="line">        a[i] = i;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> it = <span class="number">0</span>; it &lt; <span class="number">20</span>; it++)</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">memcpy</span>(b, a, <span class="keyword">sizeof</span>(a[<span class="number">0</span>])*N);</div><div class="line">        <span class="keyword">clock_t</span> t = clock();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</div><div class="line">            sqrt2(b, b+N);</div><div class="line">        t = clock() - t;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"It took me %f seconds.\n"</span>, ((<span class="keyword">float</span>) t)/CLOCKS_PER_SEC);</div><div class="line">        <span class="keyword">float</span> sum = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">            sum += b[i];</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%f\n"</span>, sum);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="VSQRT-h"><a href="#VSQRT-h" class="headerlink" title="VSQRT.h"></a>VSQRT.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __VSQRT_H</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> __VSQRT_H</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sqrt2</span><span class="params">(<span class="keyword">float</span> *begin, <span class="keyword">float</span> *end)</span></span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure>
<h3 id="VSQRT-c"><a href="#VSQRT-c" class="headerlink" title="VSQRT.c"></a>VSQRT.c</h3><p>請嘗試加速以下程式碼。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"VSQRT.h"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sqrt2</span><span class="params">(<span class="keyword">float</span> *begin, <span class="keyword">float</span> *end)</span> </span>&#123;</div><div class="line">     <span class="keyword">for</span> (; begin != end; begin++)</div><div class="line">         *begin = <span class="built_in">sqrt</span>(*begin);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Sample-Input-stdin"><a href="#Sample-Input-stdin" class="headerlink" title="Sample Input (stdin)"></a>Sample Input (stdin)</h2><p><strong><em> no input </em></strong></p>
<h2 id="Sample-Output-stdout"><a href="#Sample-Output-stdout" class="headerlink" title="Sample Output (stdout)"></a>Sample Output (stdout)</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div><div class="line"><span class="number">1051776.125000</span></div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>這裡我們使用 Intel CPU 撰寫 SIMD 指令時，透過編譯參數 <code>-msse -mavx ...</code> 指定相關的指令集進行調適。這些單一指令多資料處理的操作，使得在指定層級得到較高的平行度。</p>
<p>為了使用它們，我們需要較多的前置處理，例如要把資料載入和儲存時，必然要符合對齊的標準，若記憶體位址不是 32 的倍數 (AVX 的 256 bits) 或者 16 的倍數 (SSE 的 128 bits)，則系統會產生 trap，進而導致程式運行中斷而發生錯誤。這方面必須特別小心，有時編譯器恰好幫你對齊而正常運行，若增加其他變數時，對齊就有可能跑掉，這時候再去找錯誤會變得相當瑣碎。</p>
<p>通常些 SSE/AVX 加速指令，將會在 <code>gcc -Ofast</code> 中使用，而在 <code>-O3</code> 下仍有可能尚未開啟。而在 LLVM 中的 <code>clang -O2</code> 編譯下就會自動開啟 SSE。無論如何，要明白開啟這些的并行指令的代價，數據小造成運行效能低落，隨著資料量遽增才會明顯加速，若牽涉到浮點數計算，務必注意精準度的需求。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"VSQRT.h"</span></span></div><div class="line"> </div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;x86intrin.h&gt;</span></span></div><div class="line"> </div><div class="line"><span class="comment">//#undef __AVX__</span></div><div class="line"><span class="comment">//#undef __SSE__</span></div><div class="line"> </div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__AVX__)</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sqrt2</span><span class="params">(<span class="keyword">float</span> *a, <span class="keyword">float</span> *end)</span> </span>&#123;</div><div class="line">    <span class="keyword">uint32_t</span> offset = ((<span class="keyword">void</span> *) a - (<span class="keyword">void</span> *) <span class="number">0</span>);</div><div class="line">    <span class="keyword">for</span> (; a &lt; end &amp;&amp; (offset&amp;<span class="number">31</span>); a++, offset += <span class="keyword">sizeof</span>(<span class="keyword">float</span>))</div><div class="line">        *a = <span class="built_in">sqrt</span>(*a);</div><div class="line">    __m256* ptr = (__m256*) a;</div><div class="line">    <span class="keyword">for</span> (; a + <span class="number">8</span> &lt;= end; a += <span class="number">8</span>, ptr++)</div><div class="line">        _mm256_store_ps(a, _mm256_sqrt_ps(*ptr));</div><div class="line">    <span class="keyword">for</span> (; a &lt; end; a++)</div><div class="line">        *a = <span class="built_in">sqrt</span>(*a);</div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(__SSE__)</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sqrt2</span><span class="params">(<span class="keyword">float</span> *a, <span class="keyword">float</span> *end)</span> </span>&#123;</div><div class="line">    <span class="keyword">uint32_t</span> offset = ((<span class="keyword">void</span> *) a - (<span class="keyword">void</span> *) <span class="number">0</span>);</div><div class="line">    <span class="keyword">for</span> (; a &lt; end &amp;&amp; (offset&amp;<span class="number">15</span>); a++, offset += <span class="keyword">sizeof</span>(<span class="keyword">float</span>))</div><div class="line">        *a = <span class="built_in">sqrt</span>(*a);</div><div class="line">    __m128* ptr = (__m128*) a;</div><div class="line">    <span class="keyword">for</span> (; a + <span class="number">4</span> &lt;= end; a += <span class="number">4</span>, ptr++)</div><div class="line">        _mm_store_ps(a, _mm_sqrt_ps(*ptr));</div><div class="line">    <span class="keyword">for</span> (; a &lt; end; a++)</div><div class="line">        *a = <span class="built_in">sqrt</span>(*a);</div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sqrt2</span><span class="params">(<span class="keyword">float</span> *begin, <span class="keyword">float</span> *end)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (; begin != end; begin++)</div><div class="line">        *begin = sqrtf(*begin);</div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-parallel-TA" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/01/parallel-TA/" class="article-date">
  <time datetime="2017-07-01T02:02:25.000Z" itemprop="datePublished">2017-07-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/平行程式/">平行程式</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="http://i.imgur.com/W9PD2EB.jpg" rel="gallery_ckxwy6rt800agesvn405o7y3x">
        <img src="http://i.imgur.com/W9PD2EB.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/01/parallel-TA/">助教生涯－平行總結</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/07/01/parallel-TA/" data-id="ckxwy6rt800agesvn405o7y3x" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/07/01/parallel-TA/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/實作技巧/">實作技巧</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <p>從碩班入學開始的這兩年內，助教一職圍繞在身邊許久，不擅長教別人的我卻非得接下這份工作－「教練，我可以不當助教嗎？」一轉眼兩年過去，當了三個學期半的助教，兩年間也不過四個學期，我想這些經歷肯定對於其他人是特別的，甚至會覺得有博班學長跟你一起當助教。不幸地，沒人可以給你經驗學習當助教－「從今天開始，你就是課程助教了！」</p>
<h2 id="關於作業"><a href="#關於作業" class="headerlink" title="關於作業"></a>關於作業</h2><p>大部分的課程都會使用的相同作業，助教只需要發下去給同學們寫就好。若加點變化，這就讓助教苦了，那是為什麼呢？一個小小的更動將更新參考答案、增加檢測方法、準備應付學生難以理解題目的諮詢，單兵作業的情況下，要如何做到全面防守便是一場長期消耗戰。</p>
<p>在學校課程中，也只有幾堂課是週週出作業、交作業，那週週改作業是怎麼一回事！那麼就是一個完全的管線處理，一下子從期初忙到期末，作業格式要找老師檢查、課堂中督導學生撰寫、課後收作業批閱、收到補交作業批改、接獲隔週作業需求設計、進行初步實驗和作業規劃、郵件通知學生 … 等，每週這樣子循環，有時候在想要是突然生病或消失，會出什麼事情呢？好想知道，希望是個可以找個人接替的日子，那麼就能好好地做自己的事情。</p>
<p>永無止盡地思考——這樣的設計會不會出事？誰能來提供更好的解法，能不能再設計得更好了一些？你是否也有相同的煩惱呢？</p>
<h2 id="關於考試"><a href="#關於考試" class="headerlink" title="關於考試"></a>關於考試</h2><p>考試不像作業有一陣子的緩衝期，出題面向與準備方向需要跟老師確定，一旦沒有喬好，就會在學生和老師間被踢來踢去，要是讓學生準備方向錯誤，那麼一定會件很可怕的事情。檢查再檢查，還是會有一些描述在當下造成學生無法理解的部分。更擔心的是，知道考題內容也沒有附上參考答案和配分方法。當問答題時更為頭痛，總會有那些出乎意料的答題方法，學生考試當下詢問時，這要怎麼辦呢？例外處理要怎麼給分？</p>
<p>考卷批改又是另一回事，由老師改還是助教改呢？改完就要準備讓學生檢討「助教？為什麼這會錯？為什麼他寫那樣就會對，我寫就不對？」有時候，文字描述總是很可怕的，當我們充分理解這位仁兄時，看考卷的觀點會變成「假設你懂」相反地就是「假設你不懂」，通常都要以後者為主，但如果偏向實作課程時，對於那些實作能力很好，卻不想背誦專有名詞定義的高手而感到惋惜。</p>
<p>最好的解決方法，就是助教都認得出來每個學生和表現，這樣也許會好上一些，一個學期能不能認識一個班級的人呢？有些很少出現和表現的同學，到底要怎麼認識啊！</p>
<h2 id="關於環境架設"><a href="#關於環境架設" class="headerlink" title="關於環境架設"></a>關於環境架設</h2><p>在程式撰寫方面，替學生進行環境設定相當苦惱，因為有分成標準與不標準，像我這種非正規教育出來的，只知道一堆網路搜索的資訊結果，哪一種解決方法才是最好的，能帶到下一個運行版本下持續運作，長遠性的規劃！只發現以前課程所遺留下來的資料，大多都有一些毛病在，還有一些尚未描述清楚的部分。「咱很笨，能教教我嗎？上上上屆學長們，你們消失到哪了？」</p>
<p><img src="http://i.imgur.com/s8NlOr9.jpg" alt="「原來我之前什麼都不明白啊」—《正解的卡多 KADO》"></p>
<h2 id="雜言"><a href="#雜言" class="headerlink" title="雜言"></a>雜言</h2><p><img src="http://i.imgur.com/cBeZmFH.jpg" alt="「無言」－《從零開始的魔法書》"></p>
<p>當收到同學問程式，時常忘記給予任何嘗試的足跡，只有一份有錯的程序，接著就要助教幫忙通靈找錯誤，你先可以問問一起修課的同學嗎？每次都這樣子的話，咱已經受不了啊，一年、兩年過去，也疲於應付這些，我也想要屬於我自己的救贖啊！</p>
<p><img src="http://i.imgur.com/Rv1eT0c.jpg" alt="「」－《為美好的世界獻上祝福》"></p>
<p>每週跟課三個多小時，又要確定作業題目、生測資和測試，我自己也想鑽研作業，所追求的作業是沒有底的標準，能更好就更好，多給一點意見，讓我也能從中學習吧，為什麼都只有作業寫好就完事？有點傷心，不甘如此地結束，你能驚艷我的，對吧？</p>
<p>從系統環境架設、考試準備、通知學生和課程時替學生除錯，製作課程簡報，修正幾代學長遺留下來的錯誤，撰寫參考解答，追求更好的效能與算法，行政事項的準備，還有外來的委託架設。該經歷的都經歷了，只是一個人忙不太過來，也一直撐不住這麼多龐大的壓力。</p>
<p>然而，要準備離開學校的當下，信箱不時有一些待申請的大一新生信件，其中還會有外系學生想要使用我們課程中使用的系統來學習。系上的轉系考要我弄環境、考題，看來我的人生很不平靜呢 … 一些邏輯說不通的事情發生在身上時，過得是多麼無力呀。</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-icg-final-project-radiosity-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/24/icg-final-project-radiosity-2/" class="article-date">
  <time datetime="2017-01-24T03:01:19.000Z" itemprop="datePublished">2017-01-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/計算機圖學/">計算機圖學</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/24/icg-final-project-radiosity-2/">探討平行與優化技術於熱輻射法 (下)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/01/24/icg-final-project-radiosity-2/" data-id="ckxwy6rq4002pesvni2szh8kj" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/01/24/icg-final-project-radiosity-2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/平行/">平行</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/計算機圖學/">計算機圖學</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>接續上一篇</p>
</blockquote>
<h2 id="平行設計-Parallel-Design"><a href="#平行設計-Parallel-Design" class="headerlink" title="平行設計 Parallel Design"></a>平行設計 Parallel Design</h2><p>回顧原始算法，為了加快收斂速度，每一次會挑選單位面積能量最多的三角形 <span>$f$</span><!-- Has MathJax --> ，之後便拿所有三角形 <span>$t$</span><!-- Has MathJax --> 進行傳導，直到傳導能量小於閥值，迭代將停止。算法如下所述：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> (<span class="keyword">not</span> converge) &#123;</div><div class="line">  f = PickMaxRadiosityTriangle()</div><div class="line">  foreach triangle t in model</div><div class="line">      shader(f, t);</div><div class="line">  clearRadiosity(f)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在嘗試傳遞的過程中，若三角形 <span>$f$</span><!-- Has MathJax --> 的三頂點的能量差異大，則選擇自適應切割三角形，直到三頂點能量差異小，這麼計算 Form-Factor 才會正確。在自適應部份，切割方法如下圖所示：</p>
<p><img src="http://i.imgur.com/qd2QlKk.png" alt=""></p>
<p>當偵測到綠色三角形 <span>$A$</span><!-- Has MathJax --> 頂點之間的 Form-Factor 差異過大時，使用最長邊的中點切割，這麼做是盡可能產生銳角三角形，為了圖形完整，必然也要對鄰居切割。為減少計算量，只算新增中心點 <span>$P$</span><!-- Has MathJax --> 的 Form-Factor。對於下方的三角形 <span>$B$</span><!-- Has MathJax --> 而言，分成兩種情況，已在這一輪完成計算，則重新計算 Form-Factor；相反地，不做任何事。</p>
<h3 id="Single-Source-Parallel-Algorithm"><a href="#Single-Source-Parallel-Algorithm" class="headerlink" title="Single-Source Parallel Algorithm"></a>Single-Source Parallel Algorithm</h3><p>我們發現計算 Form-Factor 相當獨立的，但自適應處理需要遞迴切割，因此選用多核心平台，而非通用圖形處理器平台，因為目前的 GPU 實作遞迴所需的 stack 使用 global memory 作為存取位址，所以一般多核心平台效果會更好。在這一次報告中，我們選用 OpenMP 這套跨平台多執行緒 API 進行實驗。</p>
<p>著手將多個三角形平行處理，意即每一個執行緒負責多個三角形的 Form-Factor 計算。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Single-Source Parallel Algorithm</span></div><div class="line"><span class="keyword">while</span> (<span class="keyword">not</span> converage) &#123;</div><div class="line">  f = PickMaxRadiosityTriangle()</div><div class="line">  parallel foreach triangle t in model</div><div class="line">      shader(s, t);</div><div class="line">  clearRadiosity(f)</div></pre></td></tr></table></figure>
<h3 id="Multi-Source-Parallel-Algorithm"><a href="#Multi-Source-Parallel-Algorithm" class="headerlink" title="Multi-Source Parallel Algorithm"></a>Multi-Source Parallel Algorithm</h3><p>從原始算法中，我們發現到每一次迭代將只有一個熱源輻射到場景中，當場景有多個高能量熱源時，場景必須經過好幾次迭代才能近似最終結果。藉由平行處理的效能，我們可以一次迭代多熱源，便可將低執行緒之間分配工作不均的情況，不僅僅前幾次迭代就能近似最終結果，同時也能加速運算。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Multi-Source Parallel Algorithm</span></div><div class="line"><span class="keyword">while</span> (<span class="keyword">not</span> converge) &#123;</div><div class="line">  <span class="built_in">set</span>&lt;Triangle&gt; f = RadiosityTriangleCandiateCandidate();</div><div class="line">  parallel foreach triangle t in model</div><div class="line">      <span class="keyword">if</span> (f.find(t))</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">      foreach s in f</div><div class="line">          shader(s, t);</div><div class="line">  clearRadiosity(f);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我們所用的平行方無法搭配上述自適應的切割方案，其原因在於分裂過程中，同時也要對鄰居三角形分裂，整個圖形產生的節點與邊的關係才會正確，無法保證鄰居在同一執行緒內處理，若沒有做好空間切割，我們便無法處理這部份。若模型格式會是數個獨立的物體，而非單純的三角形資訊，可分配每一個執行緒處理多個獨立物體，我們預期可以達到更好的效果。</p>
<p>平行過程中每一個執行緒共享和衝突的區段越少越好，這意味著我們必須在運行輻射前就必須將模型切得相當細緻。特別注意到，切得細緻與否對於光線投射 (Ray Casting) 複雜度不變，因為邏輯上他們處理同一平面。</p>
<p>一旦切得細緻，傳遞的效果就不是這麼好，在邊界的陰影更加顯著。根據理論和實作層面推測，其一原因是能傳遞的總能量隨著迭代減少，那麼從分裂過程中傳遞能量採用較多的加法完成，相較於多個 32-bit floating point 誤差就少了許多。</p>
<p>我們也試著使用獨立的切割方案─重心切割，切割的結果不依賴鄰居，只需要在加入三角形清單部份使用 critical section 即可，效能影響並不大。</p>
<p><img src="http://i.imgur.com/cI7z6Jx.png" alt=""></p>
<p>根據重心切割，下述實驗中，從 156 個三角形，自動分裂到 30000 個三角形後進行輻射的結果如下圖所示：</p>
<p>明顯地，根據重心的切割方法容易產生鈍角三角形，看起來就會像很多紡錘體。在眾多數學性質中，只使用重心也許不是好的解決方案，這是値得探討的一部份，由於製作上的時間限制，我們並沒有去探討各個不同切割方案，所對應的自適應的效果如何。</p>
<table>
<thead>
<tr>
<th style="text-align:center">Longest Edge</th>
<th style="text-align:center">Center</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><img src="http://i.imgur.com/vQFsQ3K.png" alt=""></td>
<td style="text-align:center"><img src="http://i.imgur.com/ZyLbimO.png" alt=""></td>
</tr>
</tbody>
</table>
<h2 id="展示結果-Demo"><a href="#展示結果-Demo" class="headerlink" title="展示結果 Demo"></a>展示結果 Demo</h2><p>只使用優化技術渲染結果</p>
<table>
<thead>
<tr>
<th style="text-align:center">blocks</th>
<th style="text-align:center">room</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><img src="http://i.imgur.com/4I3U5zd.png" alt=""></td>
<td style="text-align:center"><img src="http://i.imgur.com/ATsDg8e.png" alt=""></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:center">hall</th>
<th style="text-align:center">church</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><img src="http://i.imgur.com/j6KNvT0.png" alt=""></td>
<td style="text-align:center"><img src="http://i.imgur.com/Squ2W0v.png" alt=""></td>
</tr>
</tbody>
</table>
<h3 id="平行效能比較"><a href="#平行效能比較" class="headerlink" title="平行效能比較"></a>平行效能比較</h3><p>在 Intel Xeon E5-2620 v3 上，我們測試不同平行度帶來的影響，由於只有兩個實體 CPU，每一個 CPU 有 6 個核心，每個核心皆有 Hyper-threading 技術，故可產生 24 個執行緒。</p>
<p><img src="http://i.imgur.com/qcJfMW7.png" alt="Single-Source Parallel Algorithm - Scalability"></p>
<p>我們對模型 room.tri 以預先切割 14977 個三角形後，根據先前提到的平行算法 Single-Source Parallel Algorithm，即是迭代一次只取一個熱源，平行計算所有三角形到此熱源的 Form-Factor 値，針對不同的執行緒個數和運行時間記錄，結果如上圖。在由於過多的執行緒可能會帶來更多的 false sharing，造成資料在不同的 CPU 之間運行 data transmission，所以效果就逐漸不明顯。</p>
<p><img src="http://i.imgur.com/GKBUCrB.png" alt="Multi-Source Parallel Algorithm - Scalability"></p>
<p>接著，我們測試 Multi-Source Parallel Algorithm，以 room.tri 預先切割 50017 個三角形後，每次迭代皆取數個熱源，平行計算所有三角形到所有被選取熱源的 Form-Factor 的總和。同樣地，因為查找的資料重複存取的模式造成不好的影響，類似上述所提到的 false sharing 影響，故會呈現一種陡坡。</p>
<h2 id="參考論文-Reference"><a href="#參考論文-Reference" class="headerlink" title="參考論文 Reference"></a>參考論文 Reference</h2><ul>
<li>Fast conversion of floating-point values to string, Wojciech Muła:<br><a href="http://0x80.pl/notesen/2015-12-29-float-to-string.html" target="_blank" rel="external">http://0x80.pl/notesen/2015-12-29-float-to-string.html</a><br>我們使用這一篇討論中，在輸出 Triangle 格式部份加速浮點數轉文字加快 4 倍速。</li>
</ul>
<h2 id="後記-Note"><a href="#後記-Note" class="headerlink" title="後記 Note"></a>後記 Note</h2><p>當我們進行平行效能比較時，要特別小心編譯器行為的差異，意即平行處理 <span>$P$</span><!-- Has MathJax --> 控制時，當 <span>$P=1$</span><!-- Has MathJax --> 時，使用平行版本比較合適。因為有時候，平行部分的函數被編譯器偵測到，由於分享記憶體的關係，部分代碼無法優化，導致效能瞬間慢個四到五倍都是有可能的，再加上 false sharing 的關係，更有可能在發生密集計算時，效能更加低落。</p>
<p>在不同平台上的情況也有所不同，例如在一般 server 上運行時，CPU 頻率通常都會比一般 PC 慢上許多，又因為很多個 CPU 導致總共的快取大小遠比一般 PC 多，所以平行效能將會受限於運行的應用行為，是否需要時常存取大量的資料。</p>
<h2 id="致謝-Thanks"><a href="#致謝-Thanks" class="headerlink" title="致謝 Thanks"></a>致謝 Thanks</h2><p>一開始在挑選主題相當困惑，畢竟使用 Unity 可以做出更生動的作品，但作品的元素和創意相當重要，相當迷惘於要選哪一種類型才好。如果要兩人以上一起做，那麼主題又不能太過狹隘。百般思慮下，還是由我拉選了這個主題下來做。</p>
<blockquote>
<p>「我可能會扯你後腿，還是我們各別做？」組員擔心地說道</p>
</blockquote>
<p>不用擔心，我自己也沒信心將所有程序都看完且修改更好更快，每天都焦頭爛額地煩惱整份程序的運作，深怕來不及在時限內完成足夠的報告份量。</p>
<blockquote>
<p>「快來幫幫我啊，在身邊一起 trace 程序也好，咱的記憶體不足啊。」內心如此吶喊</p>
</blockquote>
<p>一起修課的博班學長給了我們一些意見與鼓勵，而學弟們只會在一旁扯後腿問「學姊今天會來嗎？」最後，我們完成了整份程序的理解與討論。</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-icg-final-project-radiosity" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/22/icg-final-project-radiosity/" class="article-date">
  <time datetime="2017-01-22T03:40:03.000Z" itemprop="datePublished">2017-01-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/計算機圖學/">計算機圖學</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/22/icg-final-project-radiosity/">探討平行與優化技術於熱輻射法 (上)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/01/22/icg-final-project-radiosity/" data-id="ckxwy6rqa0034esvn3ohrwopm" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/01/22/icg-final-project-radiosity/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化/">優化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/計算機圖學/">計算機圖學</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>此為計算機圖學課程中的一環，自由挑選主題。而這個 Radiosity 有好幾年前的原始碼，程式碼部分由老師提供。看到幾處寫得不是很好的地方，於是就拿來加速。在 tracing code 耗費了相當大的力氣，雖然才幾千行的 C 程序，完全不熟的領域，慢慢做起來也別有一番風趣。<a href="https://github.com/morris821028/hw-radiosity" target="_blank" rel="external">morris821028/hw-radiosity</a></p>
</blockquote>
<h2 id="Parallel-Computing-and-Optimization-Skills-for-Radiosity"><a href="#Parallel-Computing-and-Optimization-Skills-for-Radiosity" class="headerlink" title="Parallel Computing and Optimization Skills for Radiosity"></a>Parallel Computing and Optimization Skills for Radiosity</h2><ul>
<li>R04922067 楊翔雲、R04922133 古君葳</li>
</ul>
<h2 id="介紹-Introduction"><a href="#介紹-Introduction" class="headerlink" title="介紹 Introduction"></a>介紹 Introduction</h2><p>熱輻射法 (Radiosity) 是一種渲染的技術。相較於光線追蹤法 (Ray Tracing)，熱輻射法可以產生更接近於現實場景中光亮的變化。當場景使用光線追蹤法時，物體的陰影的邊緣相對銳利，但在現實情況下，物體陰影漸層呈現，因此使用熱輻射法可以更貼近我們想要的。</p>
<span>$$\begin{align*}
B_i dA_i = E_i dA_i + R_i \int_j B_j F_{ji} dA_j
\end{align*}$$</span><!-- Has MathJax -->
<ul>
<li><span>$A_i$</span><!-- Has MathJax --> : Area of element i (computable)</li>
<li><span>$B_i$</span><!-- Has MathJax --> : Radiosity of element i (unknown)</li>
<li><span>$E_i$</span><!-- Has MathJax --> : Radient emitted flux density of element i (given)</li>
<li><span>$R_i$</span><!-- Has MathJax --> : Refletance of element i (given)</li>
<li><span>$F_{ji}$</span><!-- Has MathJax --> : Form Factor from j to i (computable)</li>
</ul>
<p>假設整個場景中有 <span>$N$</span><!-- Has MathJax --> 個三角形，每一次迭代選擇一個最亮的三角形當作光源，由這個光源計算與場景中其他三角形的 Radiosity 之值。其中，判斷光源是否可以輻射到某個三角形之複雜度介於 <span>$O(\log N)$</span><!-- Has MathJax --> 到 <span>$O(N)$</span><!-- Has MathJax --> (視Data structure而定)，而計算 Form-Factor的花費可以視為常數 <span>$O(1)$</span><!-- Has MathJax --> ，因此每次迭代的複雜度介於 <span>$O(N \log N)$</span><!-- Has MathJax --> 到 <span>$O(N^2)$</span><!-- Has MathJax -->。</p>
<p>其中佔據效能的因素是 Form-Factor 估算，因此有像 Hemicube之類的近似逼近，大幅度減少計算量，但投影回到原本物件上會失真。</p>
<span>$$\begin{align*}
F_{ij} = \frac{1}{A_i} \int_{A_i}\int_{A_j} \frac{\cos \phi_2 \cos \phi_1}{\pi r^2} dA_i dA_j
\end{align*}$$</span><!-- Has MathJax -->
<p><img src="http://i.imgur.com/mOMEPZR.gif" alt=""></p>
<blockquote>
<p>進入優化主題吧</p>
</blockquote>
<h2 id="優化技術-Code-Review-amp-Optimization"><a href="#優化技術-Code-Review-amp-Optimization" class="headerlink" title="優化技術 Code Review &amp; Optimization"></a>優化技術 Code Review &amp; Optimization</h2><p>首先，我們先對助教提供的程式碼加速，分成以下幾個部分討論</p>
<ul>
<li>減少光線投射計算量 Strength Reduction for Ray Casting</li>
<li>減少 Form-Factor計算量 Strength Reduction for Form-Factor</li>
<li>改善資料局部性 Improve Data Locality</li>
<li>其他優化 Other Optimization: <ul>
<li>Improve I-cache Miss</li>
<li>Short Circuit Design</li>
<li>Clipping Algorithm</li>
<li>Strength Reduction for Float-Point</li>
<li>Shrink the Scope of Variables</li>
<li>Reduce the Number of Arguments</li>
<li>Remove Implications of Pointer Aliasing</li>
<li>Copy Optimization</li>
</ul>
</li>
</ul>
<h3 id="減少光線投射計算量-Strength-Reduction-for-Ray-Casting"><a href="#減少光線投射計算量-Strength-Reduction-for-Ray-Casting" class="headerlink" title="減少光線投射計算量 Strength Reduction for Ray Casting"></a>減少光線投射計算量 Strength Reduction for Ray Casting</h3><p>判斷射線 (Ray) 是否能打到三角形 <span>$A$</span><!-- Has MathJax --> 上，先用 bounding box 包住 <span>$A$</span><!-- Has MathJax --> ，計算 <span>$p$</span><!-- Has MathJax --> 到 bounding box 的時間 <span>$t$</span><!-- Has MathJax --> ，若 <span>$t$</span><!-- Has MathJax --> 大於目前的最小 <span>$t_{\min}$</span><!-- Has MathJax --> ，則退出。相反地，再計算更精準的 <span>$t$</span><!-- Has MathJax --> 。加入利用已知結果 <span>$v = p + t_{\min} \cdot d, t_{\min} &gt; 0$</span><!-- Has MathJax --></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">TriangleHitted</span><span class="params">(Vector p, Vector d, TrianglePtr tp, <span class="keyword">float</span> *t_min)</span> </span>&#123;</div><div class="line">    <span class="keyword">float</span> t = <span class="comment">/* time t from p to bounding box of Triangle tp */</span>;</div><div class="line">    <span class="keyword">if</span> (t &lt; eps)</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    <span class="keyword">if</span> (t &gt;= *t_min)    <span class="comment">/* important !! */</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    <span class="comment">/* ... */</span></div><div class="line">    *t_min = t;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="減少-FF-計算量-Strength-Reduction-for-Form-Factor"><a href="#減少-FF-計算量-Strength-Reduction-for-Form-Factor" class="headerlink" title="減少 FF 計算量 Strength Reduction for Form-Factor"></a>減少 FF 計算量 Strength Reduction for Form-Factor</h3><p>根據公式 <span>$F_{ij} = \frac{1}{A_i} \int_{A_i}\int_{A_j} \frac{\cos \phi_2 \cos \phi_1}{\pi r^2} dA_i dA_j$</span><!-- Has MathJax --> ，一般我們的判斷順序會得如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">float</span> <span class="title">computeFormFactor</span><span class="params">(TrianglePtr srcTri, <span class="keyword">int</span> logSrc, TrianglePtr desTri, <span class="keyword">int</span> logDes, Vector p)</span> </span>&#123;</div><div class="line">    Vector dir = srcTri-&gt;c - p;</div><div class="line">    <span class="keyword">float</span> ff = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (RayHitted(p, dir, logDes) == logDes) &#123;</div><div class="line">        <span class="keyword">float</span> theta1 = CosTheta(dir, srcTri-&gt;normal), theta2 = CosTheta(dir, desTri-&gt;normal);</div><div class="line">        ff = theta1 * theta2 * srcTri-&gt;area / (norm2(dir) * PI);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> max(ff, <span class="number">0.f</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>效能考量的因素：</p>
<ul>
<li><code>RayHitted()</code> 需要大量的計算</li>
<li>Form-Factor 在 <code>float</code> 儲存格式下可能無法得到貢獻，改採優先計算 Form-Factor 的值，再運行 RayHitted 判斷。調整加速了 2 倍多。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">float</span> <span class="title">computeFormFactor</span><span class="params">(TrianglePtr srcTri, <span class="keyword">int</span> logSrc, TrianglePtr desTri, <span class="keyword">int</span> logDes, Vector p)</span></span></div><div class="line"><span class="function">    Vector dir </span>= srcTri-&gt;c - p;</div><div class="line">    <span class="keyword">float</span> theta1 = CosTheta(dir, srcTri-&gt;normal), </div><div class="line">theta2 = CosTheta(dir, desTri-&gt;normal);</div><div class="line">    <span class="keyword">float</span> ff = theta1 * theta2;</div><div class="line">    <span class="keyword">if</span> (ff &lt;= <span class="number">0</span>)    <span class="keyword">return</span> <span class="number">0.f</span>;</div><div class="line">    ff *= srcTri-&gt;area / (norm2(dir) * PI);</div><div class="line">    <span class="keyword">if</span> (ff &lt;= <span class="number">0</span>)    <span class="keyword">return</span> <span class="number">0.f</span>;</div><div class="line">    <span class="keyword">if</span> (RayHitted(p, dir, logDes) == logDes)</div><div class="line">        <span class="keyword">return</span> ff;</div><div class="line">    <span class="keyword">return</span> <span class="number">0.f</span>;</div></pre></td></tr></table></figure>
<h3 id="改善資料局部性-Improve-Data-Locality"><a href="#改善資料局部性-Improve-Data-Locality" class="headerlink" title="改善資料局部性 Improve Data Locality"></a>改善資料局部性 Improve Data Locality</h3><p>程式碼中使用 3D-DDA Line Algorithm/Bresenham’s Line Algorithm 搭配 Octree，在找尋某個射線與哪個最近三角形相交。</p>
<ul>
<li>只需要儲存葉節點代表的立方體中，所有可能相交的三角形編號</li>
<li>移除掉中間產生的編號，讓每一次 access 的 cache-miss 下降</li>
</ul>
<p>在 3D-DDA 中，我們需要反查找空間中一點 p 在哪一個葉節點中，藉由固定的長寬高切割長度，可以在 <span>$O(1)$</span><!-- Has MathJax --> 時間內得知 <code>[i][j][k]</code> 各別的值。若限制大小，則建立陣列 <code>[i][j][k]</code> 查找。若自適應大小，則建立 hash 表查找，但根據實驗結果，效能並沒有改善，因為三角形個數過多導致命中機率過低。</p>
<p>對於 Static Tree 的 Memory Layout，大致上分成四種DFS Layout、Inorder Layout、BFS Layout、和 van Emde Boas Layout，目前程式使用的是 DFS Layout，這方面會影響到存取的效能。若有更多的時間，我們也可以測試平行處理的細粒度與這些 Memory Layout 的影響。</p>
<h3 id="其他優化-Other-Optimization"><a href="#其他優化-Other-Optimization" class="headerlink" title="其他優化 Other Optimization"></a>其他優化 Other Optimization</h3><h4 id="Improve-I-cache-Miss"><a href="#Improve-I-cache-Miss" class="headerlink" title="Improve I-cache Miss"></a>Improve I-cache Miss</h4><p>壓縮程式碼長度以改善 I-cache miss，因為大部分的初始化只會運行一次，不應該交錯在時常被呼叫的函數之間，指令載入效能才會提高，同時也要做好 Code Layout，就能改善執行效能。</p>
<p>原始版本如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">x, y = compute(<span class="number">0</span>)</div><div class="line">buildTree(x, y)</div><div class="line">x, y = compute(<span class="number">1</span>)</div><div class="line">buildTree()</div><div class="line">x, y = compute(<span class="number">2</span>)</div><div class="line">buildTree()</div><div class="line">x, y = compute(<span class="number">3</span>)</div><div class="line">buildTree()</div><div class="line">...</div></pre></td></tr></table></figure>
<p>壓縮和整理後</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i from <span class="number">0</span> to n</div><div class="line">    x, y = compute(i)</div><div class="line">    buildTree()</div></pre></td></tr></table></figure>
<h4 id="Short-Circuit-Design"><a href="#Short-Circuit-Design" class="headerlink" title="Short Circuit Design"></a>Short Circuit Design</h4><p>判斷三角形與一個正交立方體是否相交，使用投影到二維空間中與一線段的交點是否皆存在。投影方法有 3 種 x-y, y-z, z-x，線段投影共有 2 種，共計 6 種情況。原先程式沒有做好短路設計，只要其中一種不符就應退出。</p>
<p><img src="http://i.imgur.com/8jcycpG.png" alt=""></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">CrossOver</span><span class="params">(TrianglePtr tri, </span></span></div><div class="line"><span class="function"><span class="params">            Vector g0, Vector g1)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (xyz = <span class="number">0</span>; xyz &lt; <span class="number">3</span>; xyz++) &#123;</div><div class="line">        <span class="comment">// front face project</span></div><div class="line">        <span class="keyword">if</span> (!test())</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        <span class="comment">// back face project</span></div><div class="line">        <span class="keyword">if</span> (!test())</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Clipping-Algorithm"><a href="#Clipping-Algorithm" class="headerlink" title="Clipping Algorithm"></a>Clipping Algorithm</h4><p>我們實作課程中所描述的 Cohen–Sutherland Algorithm 降低 branch 次數，使用 bitwise 操作引出 SSE (Streaming SIMD Extensions)。儘管 compiler -O2 替我們優化，為減少 stack push/pop 的次數，實作時請不要使用的 procedure call，否則會慢上許多。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">computeRadiosity</span><span class="params">(TrianglePtr srcTri, TrianglePtr desTri, </span></span></div><div class="line"><span class="function"><span class="params"><span class="keyword">float</span> ff[<span class="number">3</span>])</span> </span>&#123;</div><div class="line">    <span class="keyword">char</span> mask1 = (p0[x] &lt; g0[x])&lt;&lt;<span class="number">0</span> |</div><div class="line">        (p0[x] &gt; g1[x])&lt;&lt;<span class="number">1</span> |</div><div class="line">        (p0[y] &lt; g0[y])&lt;&lt;<span class="number">2</span> |</div><div class="line">        (p0[y] &gt; g1[y])&lt;&lt;<span class="number">3</span> ;</div><div class="line">    <span class="keyword">char</span> mask2 = (p1[x] &lt; g0[x])&lt;&lt;<span class="number">0</span> |</div><div class="line">        (p1[x] &gt; g1[x])&lt;&lt;<span class="number">1</span> |</div><div class="line">        (p1[y] &lt; g0[y])&lt;&lt;<span class="number">2</span> |</div><div class="line">        (p1[y] &gt; g1[y])&lt;&lt;<span class="number">3</span> ;</div><div class="line">    <span class="keyword">if</span> (mask1&amp;mask2)    </div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    <span class="keyword">if</span> (!(mask1|mask2))</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    <span class="comment">// ... test</span></div></pre></td></tr></table></figure>
<h4 id="Strength-Reduction-for-Float-Point"><a href="#Strength-Reduction-for-Float-Point" class="headerlink" title="Strength Reduction for Float-Point"></a>Strength Reduction for Float-Point</h4><p>兩個外積結果相乘小於零，減少 instruction cycle 量，盡量用整數作為運算型態。</p>
<blockquote>
<p>在現在的 Intel CPU 中，32-bit 浮點數運算基本上跟整數一樣快</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">float</span> a = cross(<span class="comment">/* */</span>);</div><div class="line"><span class="keyword">float</span> b = cross(<span class="comment">/* */</span>);</div><div class="line"><span class="keyword">if</span> (a * b &lt; <span class="number">0</span>)</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">b = cross(<span class="comment">/* */</span>);</div><div class="line"><span class="keyword">if</span> (a * b &lt; <span class="number">0</span>)</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">...</div></pre></td></tr></table></figure>
<p>事先判斷正負號，同時也防止溢位。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> a = cross(<span class="comment">/* */</span>) &lt; <span class="number">0</span>;</div><div class="line"><span class="keyword">int</span> b = cross(<span class="comment">/* */</span>) &lt; <span class="number">0</span>;</div><div class="line"><span class="keyword">if</span> (a != b)</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">b = cross(<span class="comment">/* */</span>) &lt; <span class="number">0</span>;</div><div class="line"><span class="keyword">if</span> (a != b)</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">...</div></pre></td></tr></table></figure>
<h4 id="Shrink-the-Scope-of-Variables"><a href="#Shrink-the-Scope-of-Variables" class="headerlink" title="Shrink the Scope of Variables"></a>Shrink the Scope of Variables</h4><p>減少變數生命週期的長度以增加放入暫存器的機會，而非 stack 上。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">float</span> rgb[<span class="number">3</span>];</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</div><div class="line">    rgb[f(i)] = g(i);</div><div class="line"><span class="comment">/* ... */</span></div><div class="line"><span class="keyword">if</span> (maybe) &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</div><div class="line">        rgb[h(i)] = g(i);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/* ... */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>當邏輯很複雜時，編譯器不太能幫忙做分析，所以自己手動優化的效果會比較好，在 C/C++ 語言中，可以利用大括弧進行區域變數的設定。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="keyword">float</span> rgb[<span class="number">3</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</div><div class="line">        rgb[f(i)] = g(i);</div><div class="line">    <span class="comment">/* ... */</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (maybe) &#123;</div><div class="line">    <span class="keyword">float</span> rgb[<span class="number">3</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</div><div class="line">        rgb[h(i)] = g(i);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/* ... */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Reduce-the-Number-of-Arguments"><a href="#Reduce-the-Number-of-Arguments" class="headerlink" title="Reduce the Number of Arguments"></a>Reduce the Number of Arguments</h4><p>減少 stack push/pop 次數</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Arg</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> a0, a1;</div><div class="line">&#125;;    <span class="comment">// p1.a1 = p2.a0</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">(Arg p1, Arg p2)</span> </span>&#123;</div><div class="line">    <span class="comment">/* ... */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如何修改合適的參數個數，必須看使用的機率和次數，才能達到最大效益。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Arg</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> a0, a1, a2;</div><div class="line">&#125;;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">(Arg p1p2)</span> </span>&#123;</div><div class="line">    <span class="comment">/* ... */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Remove-Implications-of-Pointer-Aliasing"><a href="#Remove-Implications-of-Pointer-Aliasing" class="headerlink" title="Remove Implications of Pointer Aliasing"></a>Remove Implications of Pointer Aliasing</h4><p>移除指標 Aliasing，意指可能會指向相同記憶體位址，導致每次計算都要重新載入，不能放進暫存器中。如下述的寫法，編譯器無法判定 <code>srcTri</code> 是否與 <code>desTri</code> 相同，在累加時則重新載入 <code>srcTri-&gt;deltaB[]</code> 的數值，計算上可能會產生數次的 cache miss，隨著迴圈次數不斷突顯效能差異。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">computeRadiosity</span><span class="params">(TrianglePtr srcTri, TrianglePtr desTri,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="keyword">float</span> ff[<span class="number">3</span>])</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; <span class="number">3</span>; v++) &#123;    <span class="comment">// vertex</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span>; c &lt; <span class="number">3</span>; c++) &#123;    <span class="comment">// color RGB</span></div><div class="line">            flaot deltaB = desTri-&gt;Frgb[c]/<span class="number">255.0</span>*RefRatio*srcTri-&gt;deltaB[c]*ff[v]/<span class="number">3</span>;</div><div class="line">            desTri-&gt;deltaB[c] += deltaB; </div><div class="line">            desTri-&gt;accB[v][c] += deltaB; </div><div class="line">            desTri-&gt;deltaAccB[v][c] += deltaB; </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>方法 1: 加入 <code>if (srcTri != desTri)</code> 判斷，讓編譯器在 Function Pass 階段著手的 Dependency Analysis 更好</li>
<li>方法 2: 使用 Copy Optimization，同時把重複計算搬到 stack 上，或者使用 Polyhedal 表示法進行 Reordering Accesses for Loop Nest。這裡我們選擇前者，更容易引出 SSE</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">computeRadiosity</span><span class="params">(TrianglePtr srcTri, TrianglePtr desTri, </span></span></div><div class="line"><span class="function"><span class="params"><span class="keyword">float</span> ff[<span class="number">3</span>])</span> </span>&#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">float</span> k = RefRatio / <span class="number">255.0</span>;</div><div class="line">    <span class="keyword">float</span> lo[<span class="number">3</span>] = &#123; desTri-&gt;Frgb[<span class="number">0</span>]*k*(srctri-&gt;deltaB[<span class="number">0</span>]), </div><div class="line">                    desTri-&gt;Frgb[<span class="number">1</span>]*k*(srctri-&gt;deltaB[<span class="number">1</span>]), </div><div class="line">                    desTri-&gt;Frgb[<span class="number">2</span>]*k*(srctri-&gt;deltaB[<span class="number">2</span>])&#125;;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; <span class="number">3</span>; v++)    &#123;    <span class="comment">// vertex</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span>; c &lt; <span class="number">3</span>; c++) &#123;    <span class="comment">// color RGB</span></div><div class="line">            <span class="comment">/* calculate the reflectiveness */</span></div><div class="line">            <span class="keyword">float</span> deltaB = lo[c] * ff[v] / <span class="number">3</span>;</div><div class="line">            desTri-&gt;deltaB[c] += deltaB;</div><div class="line">            desTri-&gt;accB[v][c] += deltaB;</div><div class="line">            desTri-&gt;deltaaccB[v][c] = deltaB;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h2><ul>
<li>使用洽當的編譯器參數可加速 2 倍</li>
<li>減少 Form-Factor 計算加速 2 倍</li>
<li>剩餘優化部份改善 10% ~ 20% 效能。</li>
</ul>
<p>至今，我們加速了 4 倍，在下一篇文章中，我們將繼續探討平行處理。</p>
<h3 id="Experiment"><a href="#Experiment" class="headerlink" title="Experiment"></a>Experiment</h3><table>
<thead>
<tr>
<th style="text-align:center">Model</th>
<th style="text-align:right">Origin (sec.)</th>
<th style="text-align:right">Our v0.1 (sec.)</th>
<th style="text-align:right">Speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">room.tri</td>
<td style="text-align:right">10.27</td>
<td style="text-align:right">4.70</td>
<td style="text-align:right">2.18</td>
</tr>
<tr>
<td style="text-align:center">hall.tri</td>
<td style="text-align:right">176.92</td>
<td style="text-align:right">38.50</td>
<td style="text-align:right">4.59</td>
</tr>
<tr>
<td style="text-align:center">church.tri</td>
<td style="text-align:right">72.32</td>
<td style="text-align:right">42.64</td>
<td style="text-align:right">1.69</td>
</tr>
</tbody>
</table>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-parallel-opt" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/31/parallel-opt/" class="article-date">
  <time datetime="2016-07-31T12:15:17.000Z" itemprop="datePublished">2016-07-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/平行程式/">平行程式</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/31/parallel-opt/">平行優化技巧－基礎篇</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/07/31/parallel-opt/" data-id="ckxwy6rt600abesvnc0i9frfq" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/07/31/parallel-opt/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CUDA/">CUDA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenCL/">OpenCL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenMP/">OpenMP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化/">優化</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <p>在撰寫平行程式時，仍會使用到編譯器的技巧，大幅度地減少指令個數，有時候這些優化甚至會把寫壞的分享記憶體 (shared memory) 存取給移除掉，如果能充分理解這些不好的設計，就不會造成實驗上發生的謬誤，還以為自己跑得很慢，平行根本沒加速到，這樣草草交出的報告，助教也收到煩了 (這裡不討論實驗方法本身就是錯的情況)。</p>
<h2 id="內存篇"><a href="#內存篇" class="headerlink" title="內存篇"></a>內存篇</h2><p>首先，來談談 cache line 是什麼吧？現在的機器都有著記憶體階層架構 (memory hierarchy)，按照大小排序，其中最小的就是 cache line，接下來才是 L1, L2, L3 cache，最後是最大的主記憶體 (main memory)，但某些超級電腦的設計就不是如此，而有些輔助處理器 (如 intel xeon phi) 缺少 L3 cache，而像 GPU 則沒有 cache 設計，但有提供有 bank 存取資料。這些都跟處理問題的類型有關，才導致有那些特殊設計。</p>
<h3 id="Multicore"><a href="#Multicore" class="headerlink" title="Multicore"></a>Multicore</h3><h4 id="Cache-Size"><a href="#Cache-Size" class="headerlink" title="Cache Size"></a>Cache Size</h4><p>為什麼 cache line 很重要？因為存取速度最快，但能存放的資料也很小，通常是 64 bytes 或者 32 bytes。在快取設計中，一次把位址連續的資料一起搬靠近 CPU，這樣簡單的設計，導致我們在撰寫程式時，若能將結構定義得好便能讓使用率高，這非常仰賴編成者對於系統架構的了解。例如色彩 RGB，可以宣告成 <code>struct RGB {flaot R, G, B};</code> 或者 <code>float R[], G[], B[]</code>，如果 RGB 三者會共同計算，例如色彩轉換通常是三者交互作用的表達式，因此前者構造方式較為妥當。</p>
<blockquote>
<p>例題：批改娘 10087. Sparse Matrix Multiplication (OpenMP) </p>
</blockquote>
<h4 id="Cache-Hierarchy"><a href="#Cache-Hierarchy" class="headerlink" title="Cache Hierarchy"></a>Cache Hierarchy</h4><p>然而，有些情況充分使用反而不好，沒錯，就是平行程式，通常平行程式不外乎會有分享記憶體，這時候充分利用反而是一件壞事，因為我們需要讓數個核心 (core) 同時運行，因為每一個 core 都有各自的 cache line，若在不同 core 上同時修改相近的位址時，很容易產生 dirty bit，這導致要掉回 L3 cache (同一個 CPU，但分享在不同的 core 上) 進行同步。通常編譯器能做到 independent 分析，那麼就會利用暫存器配置來避開這問題，如果不行，就要靠自己手動來調整。</p>
<blockquote>
<p>例題：批改娘 10085. Parallel Count (debug)</p>
</blockquote>
<h3 id="GPU"><a href="#GPU" class="headerlink" title="GPU"></a>GPU</h3><p>GPU 的記憶體設計分成四種，經常分成 on-chip 和 off-chip，差別在於是不是內建焊死，因此 on-chip 內建記憶體有比較好的效能，而 off-chip 則是外接記憶體，存取速度相對於 on-chip 慢個三倍以上。特別注意，有好就有壞，提供越快存取速度的記憶體能存放的容量越小，因此非常不容易配置。</p>
<p>在編寫 CUDA 或者是 OpenCL 時，提供 shared memory 的設計，如果請求數量過大，將會自動轉入 global memory，這一點沒有明確告知，只有在執行時期才會發現突然變慢。若採用存取速度較快的寫法，有時候不見得比較快，</p>
<blockquote>
<p>例題：批改娘 10101. Fast Game of Life (CUDA) </p>
</blockquote>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-jg-10116" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/28/jg-10116/" class="article-date">
  <time datetime="2016-06-28T06:02:13.000Z" itemprop="datePublished">2016-06-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/平行程式/">平行程式</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/28/jg-10116/">批改娘 10116. Fast Dynamic Programming Computing I (OpenMP)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/06/28/jg-10116/" data-id="ckxwy6rru0075esvnh10bm53m" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/06/28/jg-10116/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DP/">DP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenMP/">OpenMP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cache-oblivious-algorithm/">cache-oblivious algorithm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/批改娘/">批改娘</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h2><p>給定一序列矩陣，期望求出相乘這些矩陣的最有效方法的乘法次數。</p>
<h3 id="sequence-c"><a href="#sequence-c" class="headerlink" title="sequence.c"></a>sequence.c</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 4096</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> INF (1LL&lt;&lt;60)</span></div><div class="line"><span class="keyword">int</span> N;</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> dp[MAXN*MAXN], SZ[MAXN+<span class="number">5</span>];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;N) == <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= N; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;SZ[i]);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N-i; j++) &#123;</div><div class="line">                <span class="keyword">int</span> l = j, r = j+i;</div><div class="line">                <span class="keyword">long</span> <span class="keyword">long</span> local = INF;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = l; k &lt; r; k++) &#123;</div><div class="line">                    <span class="keyword">long</span> <span class="keyword">long</span> t = dp[l*N+k] + dp[(k+<span class="number">1</span>)*N+r] + SZ[l] * SZ[k+<span class="number">1</span>] * SZ[r+<span class="number">1</span>];</div><div class="line">                    <span class="keyword">if</span> (t &lt; local)</div><div class="line">                        local = t;</div><div class="line">                &#125;</div><div class="line">                dp[l*N+r] = local;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, dp[<span class="number">0</span>*N+N<span class="number">-1</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="輸入格式"><a href="#輸入格式" class="headerlink" title="輸入格式"></a>輸入格式</h2><p>有多組測資，每組第一行會有一個整數 $N$ 表示矩陣鏈上有 $N$ 個矩陣，第二行上會有 $N+1$ 個整數 $Z_i$，表示矩陣鏈的每一個行列大小，例如當 $N = 3$ 時，輸入 <code>10 30 5 60</code> 表示矩陣 <span>$A_{10, 30} B_{30, 5} C_{5, 60}$</span><!-- Has MathJax --> 相乘。</p>
<ul>
<li>$1 \le N \le 4096$</li>
<li>$1 \le Z_i \le 4096$</li>
</ul>
<h2 id="輸出格式"><a href="#輸出格式" class="headerlink" title="輸出格式"></a>輸出格式</h2><p>對於每組測資輸出一行一個整數 $M$ 為最少乘法次數。</p>
<h2 id="範例輸入"><a href="#範例輸入" class="headerlink" title="範例輸入"></a>範例輸入</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">2</div><div class="line">2 2 2</div><div class="line"> </div><div class="line">3</div><div class="line">10 30 5 60</div><div class="line"> </div><div class="line">3</div><div class="line">1 5 20 1</div><div class="line"> </div><div class="line">3</div><div class="line">5 10 20 35</div><div class="line"> </div><div class="line">6</div><div class="line">30 35 15 5 10 20 25</div></pre></td></tr></table></figure>
<h2 id="範例輸出"><a href="#範例輸出" class="headerlink" title="範例輸出"></a>範例輸出</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">8</div><div class="line">4500</div><div class="line">105</div><div class="line">4500</div><div class="line">15125</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>假設有 $p$ 個處理單元，矩陣大小為 $n \times n$，分析一般平行運算時間 <span>$T_p$</span><!-- Has MathJax --> 如下所示：</p>
<span>$$\begin{align*}
&Tab;T_p &amp;= \sum\limits_{k=1}^{n} \left\lceil \frac{k}{p} \right\rceil \times (n - k)
\end{align*}$$</span><!-- Has MathJax -->
<p>針對地 $k$ 次迭代，將第二層迴圈平行化，每一個執行緒處理 $\left\lceil \frac{k}{p} \right\rceil$ 個狀態計算，每個狀態繼續需要 $n-k$ 次計算。</p>
<span>$$\begin{align*}
&Tab;\sum\limits_{k=1}^{n} \left\lceil \frac{k}{p} \right\rceil \times k
&Tab;&Tab;&amp;= 1 \times (1 + 2 + 3 + \cdots + p) + \\
&Tab;&Tab;&amp; \qquad
&Tab;&Tab;&Tab;2 \times ((p+1) + (p+2) + (p+3) + \cdots + 2p) + \cdots + \\
&Tab;&Tab;&amp; \qquad
&Tab;&Tab;&Tab;&Tab;(n \bmod{p}) \times \left\lceil \frac{n}{p}\right\rceil (\lfloor n/p \rfloor \times p + 1 + \cdots + n) \\
&Tab;&Tab;&amp;= \sum_{k=1}^{\lfloor n/p \rfloor} k \cdot \frac{p (2k+1) p}{2}
&Tab;&Tab;&Tab;+ (n \bmod{p}) \times \left\lceil \frac{n}{p}\right\rceil 
&Tab;&Tab;&Tab;&Tab;\frac{(n \bmod{p})(n + \left\lfloor \frac{n}{p}\right\rfloor p + 1)}{2} \\
&Tab;&Tab;&amp;= p^2 \left[ \frac{\left\lfloor n/p \right\rfloor(\left\lfloor n/p \right\rfloor+1)(2 \left\lfloor n/p \right\rfloor + 1)}{6} + \frac{\left\lfloor n/p \right\rfloor(\left\lfloor n/p \right\rfloor+1)}{4} \right] + 
&Tab;&Tab;&Tab;(n \bmod{p})^2 \left\lceil n/p \right\rceil \frac{n + \left\lfloor n/p \right\rfloor p + 1}{2} \\
&Tab;\sum\limits_{k=1}^{n} \left\lceil \frac{k}{p} \right\rceil \times n
&Tab;&Tab;&amp;= n \cdot p \cdot \frac{\left\lfloor n/p \right\rfloor (\left\lfloor n/p \right\rfloor + 1)}{2} + 
&Tab;n \cdot (n - p \cdot \left\lfloor n/p \right\rfloor) \left\lceil n/p \right\rceil
\end{align*}$$</span><!-- Has MathJax -->
<p>總結一下 <span>$T_p = \sum\nolimits_{k=1}^{n} \left\lceil \frac{k}{p} \right\rceil \times n - \sum\nolimits_{k=1}^{n} \left\lceil \frac{k}{p} \right\rceil \times k = O(n^3 / p)$</span><!-- Has MathJax --></p>
<p>針對前半段 <span>$\sum\limits_{k=1}^{n} \left\lceil \frac{k}{p} \right\rceil$</span><!-- Has MathJax --> 有以下兩種推法可供參考。</p>
<h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><span>$$\begin{align*}
&Tab;\sum\limits_{k=1}^{n} \left\lceil \frac{k}{p} \right\rceil 
&Tab;&Tab;&amp;= p \cdot 1 + p \cdot 2 + p \cdot 3 + \cdots + p \cdot \left\lfloor n/p \right\rfloor + (n \bmod{p}) \cdot \left\lceil n/p \right\rceil 
&Tab;&Tab;&Tab;\phantom{0\over0}\\
&Tab;&Tab;&amp;= \sum\limits_{k=1}^{\left\lfloor n/p \right\rfloor} k \cdot p + (n - p \cdot 
&Tab;&Tab;&Tab;\left\lfloor n/p \right\rfloor)
&Tab;&Tab;&Tab;\left\lceil n/p \right\rceil \\
&Tab;&Tab;&amp;= p \cdot \frac{\left\lfloor n/p \right\rfloor (\left\lfloor n/p \right\rfloor + 1)}{2} + 
&Tab;&Tab;(n - p \cdot \left\lfloor n/p \right\rfloor) \left\lceil n/p \right\rceil
&Tab;&Tab;&Tab;&amp;&amp; \blacksquare
\end{align*}$$</span><!-- Has MathJax -->
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>套用定理如下：(解釋： $n$ 個人分成 $p$，每組人數最多差一。)</p>
<span>$$\begin{align}
&Tab;n = \left\lceil \frac{n}{p} \right\rceil + \left\lceil \frac{n-1}{p} \right\rceil
&Tab;&Tab;+ \cdots + \left\lceil \frac{n-p+1}{p} \right\rceil
\end{align}$$</span><!-- Has MathJax -->
<p>套用上式從 $k = n$ 往回推。</p>
<span>$$\begin{align*}
&Tab;\sum\limits_{k=1}^{n} \left\lceil \frac{k}{p} \right\rceil 
&Tab;&Tab;&amp;= \left\lceil \frac{n}{p} \right\rceil +
&Tab;&Tab;&Tab;\left\lceil \frac{n-1}{p} \right\rceil + \cdots +
&Tab;&Tab;&Tab;\left\lceil \frac{n-p+1}{p} \right\rceil +
&Tab;&Tab;&Tab;&Tab;\sum_{k=1}^{n-p} \left\lceil \frac{k}{p} \right\rceil \\
&Tab;&Tab;&amp;= n + (n - p) + (n - 2p) + \cdots + (n - \lfloor n/p \rfloor \cdot p)
&Tab;&Tab;&Tab;+ \sum_{k=1}^{n \bmod{p}} \left\lceil \frac{k}{p} \right\rceil \\
&Tab;&Tab;&amp;= \sum\limits_{k=0}^{\left\lfloor n/p \right\rfloor - 1} (n - k p)
&Tab;&Tab;&Tab;+ (n \bmod{p}) \\
&Tab;&Tab;&amp;= n \left\lfloor n / p \right\rfloor 
&Tab;&Tab;&Tab;- \frac{\left\lfloor n/p \right\rfloor (\left\lfloor n/p \right\rfloor - 1)}{2} \times p 
&Tab;&Tab;&Tab;+ (n \bmod{p}) &amp;&amp; \blacksquare
\end{align*}$$</span><!-- Has MathJax -->
<h3 id="基礎平行"><a href="#基礎平行" class="headerlink" title="基礎平行"></a>基礎平行</h3><ul>
<li>Accepted (50883 ms, 132224 KB)</li>
</ul>
<p>平行地方呼之欲出，針對第二層迴圈直接平行化即可，下述代碼會帶入一點累贅，其原因在於做了各種實驗所致，但不影響正確性。只做了減少 thread 建立時的 overhead 的處理。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;omp.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 4096</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> INF (1LL&lt;&lt;60)</span></div><div class="line"><span class="keyword">int</span> N;</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> dp[MAXN*MAXN], SZ[MAXN+<span class="number">5</span>];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;N) == <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= N; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;SZ[i]);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">            dp[i*N+i] = <span class="number">0</span>;</div><div class="line">        <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel firstprivate(N)</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++) &#123;</div><div class="line">                <span class="meta">#<span class="meta-keyword">pragma</span> omp for</span></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N-i; j++) &#123;</div><div class="line">                    <span class="keyword">int</span> l = j, r = j+i;</div><div class="line">                    <span class="keyword">long</span> <span class="keyword">long</span> local = INF;</div><div class="line">                    dp[l*N+r] = INF;</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> k = l; k &lt; r; k++) &#123;</div><div class="line">                        <span class="keyword">long</span> <span class="keyword">long</span> t = dp[l*N+k] + dp[(k+<span class="number">1</span>)*N+r] + SZ[l] * SZ[k+<span class="number">1</span>] * SZ[r+<span class="number">1</span>];</div><div class="line">                        <span class="keyword">if</span> (t &lt; local)</div><div class="line">                            local = t;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (local &lt; dp[l*N+r])</div><div class="line">                        dp[l*N+r] = local;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, dp[<span class="number">0</span>*N+N<span class="number">-1</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="進階平行"><a href="#進階平行" class="headerlink" title="進階平行"></a>進階平行</h3><ul>
<li>Accepted (9890 ms, 136320 KB)</li>
</ul>
<p>從一般平行實驗結果中，發現明顯地加速倍率不對，明明使用 24 個核心，跑起來不到兩倍加速的原因到底在哪？是的，在第三層存取順序需要 <code>dp[l][k]</code> 和 <code>dp[k+1][r]</code> 隨著 $k$ 變大，在前者存取順序是連續的，而在後者存取順序每一次跳躍長度為 $N$，導致 <code>dp[k+1][r]</code> 常常會發生 cache miss，一旦發生 cache miss，需要數百的 cycle 等待資料被帶進記憶體中。</p>
<p>由於矩陣鍊乘積計算時只用了矩陣的上三角，那複製一份到下三角矩陣去吧！<code>dp[l][r] = dp[r][l]</code>，如此一來在第三層迴圈發生 cache miss 的機會就大幅度下降。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;omp.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 4096</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> INF (1LL&lt;&lt;60)</span></div><div class="line"><span class="keyword">int</span> N, SZ[MAXN+<span class="number">5</span>];</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> dp[MAXN*MAXN];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;N) == <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= N; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;SZ[i]);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">            dp[i*N+i] = <span class="number">0</span>;</div><div class="line">        <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel firstprivate(N)</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++) &#123;</div><div class="line">                <span class="meta">#<span class="meta-keyword">pragma</span> omp for</span></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N-i; j++) &#123;</div><div class="line">                    <span class="keyword">int</span> l = j, r = j+i;</div><div class="line">                    <span class="keyword">long</span> <span class="keyword">long</span> local = INF, base = <span class="number">1L</span>L * SZ[l] * SZ[r+<span class="number">1</span>];</div><div class="line">                    <span class="keyword">long</span> <span class="keyword">long</span> *dp1 = dp + l*N, *dp2 = dp + r*N;</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> k = l; k &lt; r; k++) &#123;</div><div class="line">                        <span class="keyword">long</span> <span class="keyword">long</span> t = dp1[k] + dp2[k+<span class="number">1</span>] + SZ[k+<span class="number">1</span>] * base;</div><div class="line">                        <span class="keyword">if</span> (t &lt; local)</div><div class="line">                            local = t;</div><div class="line">                    &#125;</div><div class="line">                    dp1[r] = dp2[l] = local;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, dp[<span class="number">0</span>*N+N<span class="number">-1</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="忘卻快取平行"><a href="#忘卻快取平行" class="headerlink" title="忘卻快取平行"></a>忘卻快取平行</h3><ul>
<li><p>Accepted (4264 ms, 134400 KB)</p>
</li>
<li><p>參考論文 High-perofrmance Energy-efficient Recursive Dynamic Programming with Matrix-multiplication-like Flexible Kernels</p>
</li>
</ul>
<p>最主要的精神 cache-oblivious algorithm 設計，利用大方陣切割成數個小方陣，矩陣跟矩陣之間在足夠小的情況下進行合併計算。算法概述如下：</p>
<p><img src="http://i.imgur.com/38JJ44k.png" alt="cache-oblivious algorithm"></p>
<p>每一個函數參數中的藍色區塊答案算出，而其他參數則是要合併的左矩陣和下矩陣，直到計算大小足夠小時，直接跑序列版本的程式，此時所有陣列可以全部帶進快取，這時候計算變得更加有利。再加上很多層的快取，每一個 CPU 的 cache 重複使用率相當高。</p>
<p>一般的平行度最高只有 $N$，因為我們只針對其中一個迴圈平行，而在 cache-oblivious algorithm 中，平行度最高為 $N^{1.415}$。這些都只是理論分析，實作時為了考慮硬體架構是沒辦法達到理想狀態的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 4096</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXD 6</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXC 64</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> INF (1LL&lt;&lt;62)</span></div><div class="line"><span class="keyword">int</span> N;</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> dp[MAXN*MAXN], SZ[MAXN+<span class="number">5</span>];</div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">MtxHead</span> &#123;</span></div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> *A;</div><div class="line">    <span class="keyword">int</span> bx, by, n;</div><div class="line">&#125; MtxHead;</div><div class="line"></div><div class="line"><span class="function">MtxHead <span class="title">subMtx</span><span class="params">(MtxHead X, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</div><div class="line">    MtxHead T = X;</div><div class="line">    T.n &gt;&gt;= <span class="number">1</span>;</div><div class="line">    <span class="keyword">if</span> (i == <span class="number">2</span>)	T.bx += T.n;</div><div class="line">    <span class="keyword">if</span> (j == <span class="number">2</span>)	T.by += T.n;</div><div class="line">    <span class="keyword">return</span> T;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">min</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> x &lt; y ? x : y;	</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">max</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> x &gt; y ? x : y;	</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="title">loop</span><span class="params">(MtxHead X, MtxHead U, MtxHead V, <span class="keyword">int</span> tl, <span class="keyword">int</span> tr, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> v = INF, t;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> comSZ = SZ[l] * SZ[r+<span class="number">1</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = tl; k &lt; tr; k++) &#123;</div><div class="line">        t = U.A[l*N+k] + V.A[(k+<span class="number">1</span>)+r*N] + SZ[k+<span class="number">1</span>] * comSZ;</div><div class="line">        <span class="keyword">if</span> (t &lt; v)	v = t;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> v;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Cloop</span><span class="params">(MtxHead X, MtxHead U, MtxHead V)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n = X.n, l, r, tl, tr;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> v, t;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = n<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</div><div class="line">            l = X.bx + i, r = X.by + j;</div><div class="line">            v = X.A[l*N+r];</div><div class="line">            </div><div class="line">            tl = max(U.by, X.bx+i), tr = min(U.by+n, X.by+j);</div><div class="line">            t = loop(X, U, V, tl, tr, l, r);</div><div class="line">            <span class="keyword">if</span> (t &lt; v)	v = t;</div><div class="line">            </div><div class="line">            tl = max(V.bx, X.bx+i), tr = min(V.bx+n, X.by+j);</div><div class="line">            t = loop(X, U, V, tl, tr, l, r);</div><div class="line">            <span class="keyword">if</span> (t &lt; v)	v = t;</div><div class="line">            </div><div class="line">            X.A[l*N+r] = X.A[r*N+l] = v;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Bloop</span><span class="params">(MtxHead X, MtxHead U, MtxHead V)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n = X.n, l, r, tl, tr;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> v, t;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = n<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</div><div class="line">            l = X.bx + i, r = X.by + j;</div><div class="line">            v = X.A[l*N+r];</div><div class="line">                        </div><div class="line">            tl = max(U.by+i, X.bx+i), tr = min(U.by+n, X.by+j);</div><div class="line">            t = loop(X, U, V, tl, tr, l, r);</div><div class="line">            <span class="keyword">if</span> (t &lt; v)	v = t;</div><div class="line">            </div><div class="line">            tl = max(V.bx, X.bx+i), tr = min(V.bx+n, X.by+j);</div><div class="line">            t = loop(X, U, V, tl, tr, l, r);</div><div class="line">            <span class="keyword">if</span> (t &lt; v)	v = t;</div><div class="line">            </div><div class="line">            X.A[l*N+r] = X.A[r*N+l] = v;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Aloop</span><span class="params">(MtxHead X)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n = X.n;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j+i &lt; n; j++) &#123;</div><div class="line">            <span class="keyword">int</span> l = X.bx + j, r = X.by + j+i;</div><div class="line">            <span class="keyword">long</span> <span class="keyword">long</span> v = X.A[l*N+r], t;</div><div class="line">            <span class="keyword">long</span> <span class="keyword">long</span> comSZ = SZ[l] * SZ[r+<span class="number">1</span>];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = l; k &lt; r; k++) &#123;</div><div class="line">                t = X.A[l*N+k] + X.A[(k+<span class="number">1</span>)+r*N] + SZ[k+<span class="number">1</span>] * comSZ;</div><div class="line">                <span class="keyword">if</span> (t &lt; v)</div><div class="line">                    v = t;</div><div class="line">            &#125;</div><div class="line">            X.A[l*N+r] = X.A[r*N+l] = v;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Cpar</span><span class="params">(MtxHead X, MtxHead U, MtxHead V, <span class="keyword">int</span> dep)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (X.n &lt;= MAXC) &#123;</div><div class="line">        Cloop(X, U, V);</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">1</span>, <span class="number">1</span>), subMtx(U, <span class="number">1</span>, <span class="number">1</span>), subMtx(V, <span class="number">1</span>, <span class="number">1</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">1</span>, <span class="number">2</span>), subMtx(U, <span class="number">1</span>, <span class="number">1</span>), subMtx(V, <span class="number">1</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">2</span>, <span class="number">1</span>), subMtx(U, <span class="number">2</span>, <span class="number">1</span>), subMtx(V, <span class="number">1</span>, <span class="number">1</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">2</span>, <span class="number">2</span>), subMtx(U, <span class="number">2</span>, <span class="number">1</span>), subMtx(V, <span class="number">1</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp taskwait</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">1</span>, <span class="number">1</span>), subMtx(U, <span class="number">1</span>, <span class="number">2</span>), subMtx(V, <span class="number">2</span>, <span class="number">1</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">1</span>, <span class="number">2</span>), subMtx(U, <span class="number">1</span>, <span class="number">2</span>), subMtx(V, <span class="number">2</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">2</span>, <span class="number">1</span>), subMtx(U, <span class="number">2</span>, <span class="number">2</span>), subMtx(V, <span class="number">2</span>, <span class="number">1</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">2</span>, <span class="number">2</span>), subMtx(U, <span class="number">2</span>, <span class="number">2</span>), subMtx(V, <span class="number">2</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp taskwait</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Bpar</span><span class="params">(MtxHead X, MtxHead U, MtxHead V, <span class="keyword">int</span> dep)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (X.n &lt;= MAXC) &#123;</div><div class="line">        Bloop(X, U, V);</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    Bpar(subMtx(X, <span class="number">2</span>, <span class="number">1</span>), subMtx(U, <span class="number">2</span>, <span class="number">2</span>), subMtx(V, <span class="number">1</span>, <span class="number">1</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">1</span>, <span class="number">1</span>), subMtx(U, <span class="number">1</span>, <span class="number">2</span>), subMtx(X, <span class="number">2</span>, <span class="number">1</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">2</span>, <span class="number">2</span>), subMtx(X, <span class="number">2</span>, <span class="number">1</span>), subMtx(V, <span class="number">1</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp taskwait</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Bpar(subMtx(X, <span class="number">1</span>, <span class="number">1</span>), subMtx(U, <span class="number">1</span>, <span class="number">1</span>), subMtx(V, <span class="number">1</span>, <span class="number">1</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Bpar(subMtx(X, <span class="number">2</span>, <span class="number">2</span>), subMtx(U, <span class="number">2</span>, <span class="number">2</span>), subMtx(V, <span class="number">2</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp taskwait</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    Cpar(subMtx(X, <span class="number">1</span>, <span class="number">2</span>), subMtx(U, <span class="number">1</span>, <span class="number">2</span>), subMtx(X, <span class="number">2</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    Cpar(subMtx(X, <span class="number">1</span>, <span class="number">2</span>), subMtx(X, <span class="number">1</span>, <span class="number">1</span>), subMtx(V, <span class="number">1</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    Bpar(subMtx(X, <span class="number">1</span>, <span class="number">2</span>), subMtx(U, <span class="number">1</span>, <span class="number">1</span>), subMtx(V, <span class="number">2</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Apar</span><span class="params">(MtxHead X, <span class="keyword">int</span> dep)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (X.n &lt;= MAXC) &#123;</div><div class="line">        Aloop(X);</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Apar(subMtx(X, <span class="number">1</span>, <span class="number">1</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Apar(subMtx(X, <span class="number">2</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp taskwait</span></div><div class="line">    </div><div class="line">    Bpar(subMtx(X, <span class="number">1</span>, <span class="number">2</span>), subMtx(X, <span class="number">1</span>, <span class="number">1</span>), subMtx(X, <span class="number">2</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Psmall</span><span class="params">(<span class="keyword">int</span> N)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">        dp[i*N+i] = <span class="number">0</span>;</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = N<span class="number">-1</span>; i &gt; <span class="number">0</span>; i--) &#123;</div><div class="line">            <span class="keyword">int</span> comN = N-i;</div><div class="line">            <span class="meta">#<span class="meta-keyword">pragma</span> omp for</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j++) &#123;</div><div class="line">                <span class="keyword">int</span> l = j, r = comN+j;</div><div class="line">                <span class="keyword">long</span> <span class="keyword">long</span> local = INF;</div><div class="line">                <span class="keyword">long</span> <span class="keyword">long</span> *dp1 = dp+l*N, *dp2 = dp+r*N;</div><div class="line">                <span class="keyword">long</span> <span class="keyword">long</span> comSZ = SZ[l] * SZ[r+<span class="number">1</span>];</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = l; k &lt; r; k++) &#123;</div><div class="line">                    <span class="keyword">long</span> <span class="keyword">long</span> t = dp1[k] + dp2[(k+<span class="number">1</span>)] + comSZ * SZ[k+<span class="number">1</span>];</div><div class="line">                    <span class="keyword">if</span> (t &lt; local)</div><div class="line">                        local = t;</div><div class="line">                &#125;</div><div class="line">                dp[l*N+r] = dp[r*N+l] = local;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, dp[<span class="number">0</span>*N+N<span class="number">-1</span>]);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;N) == <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= N; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;SZ[i]);</div><div class="line">        <span class="keyword">if</span> (N &lt;= <span class="number">2048</span>) &#123;</div><div class="line">        	Psmall(N);</div><div class="line">        	<span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> ON = N;</div><div class="line">        <span class="keyword">while</span> ((N&amp;(-N)) != N)</div><div class="line">            N++;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">        	<span class="keyword">for</span> (<span class="keyword">int</span> j = i+<span class="number">1</span>; j &lt; N; j++)</div><div class="line">        		dp[i*N+j] = INF;</div><div class="line">            dp[i*N+i] = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        MtxHead X;</div><div class="line">        X.n = N, X.bx = X.by = <span class="number">0</span>, X.A = dp;</div><div class="line">        <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></div><div class="line">        &#123;</div><div class="line">        	<span class="meta">#<span class="meta-keyword">pragma</span> omp single</span></div><div class="line">        	Apar(X, <span class="number">0</span>);</div><div class="line">    	&#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, dp[<span class="number">0</span>*N+ON<span class="number">-1</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-jg-10113" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/28/jg-10113/" class="article-date">
  <time datetime="2016-06-28T05:36:40.000Z" itemprop="datePublished">2016-06-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/平行程式/">平行程式</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/28/jg-10113/">批改娘 10113. Longest Common Subsequence II (CUDA)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/06/28/jg-10113/" data-id="ckxwy6rrn006oesvni8m5790q" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/06/28/jg-10113/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CUDA/">CUDA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DP/">DP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hirschberg-s-algorithm/">Hirschberg's algorithm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LCS/">LCS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/批改娘/">批改娘</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h2><p>給兩個字串 $X, \; Y$，在兩個字串中都有出現且最長的子序列 (subsequence)，就是最長共同子字串<br>。</p>
<h2 id="輸入格式"><a href="#輸入格式" class="headerlink" title="輸入格式"></a>輸入格式</h2><p>有多組測資，每組測資有兩行字串 $X, \; Y$，$X, \; Y$ 只由 <code>A</code> <code>T</code> <code>C</code> <code>G</code> 四個字母構成。</p>
<ul>
<li>$1 \le |X|, |Y| \le 60000$</li>
</ul>
<h2 id="輸出格式"><a href="#輸出格式" class="headerlink" title="輸出格式"></a>輸出格式</h2><p>針對每一組測資，輸出一行 $X, \; Y$ 的最長共同子字串長度以及任何一組最長共同子字串。</p>
<h2 id="範例輸入"><a href="#範例輸入" class="headerlink" title="範例輸入"></a>範例輸入</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">TCA</div><div class="line">GTA</div><div class="line">TGGAC</div><div class="line">TATCT</div></pre></td></tr></table></figure>
<h2 id="範例輸出"><a href="#範例輸出" class="headerlink" title="範例輸出"></a>範例輸出</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2</div><div class="line">TA</div><div class="line">3</div><div class="line">TAC</div></pre></td></tr></table></figure>
<h2 id="編譯參數"><a href="#編譯參數" class="headerlink" title="編譯參數"></a>編譯參數</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ nvcc -Xcompiler &quot;-O2 -fopenmp&quot; main.cu -o main</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>附錄為舊版設計，可以針對 OpenMP 的設計再重新設計 CUDA 版本。</p>
<p>舊版設計根據 CPU 平行與不平行以及 GPU 三種狀態，根據閥值決定要選擇運行哪一種版本。若加上足夠小的情況下，直接用 $O(N^2)$ 表格直接回溯，和 OpenMP 判斷閥值的公式，效能還能在加速個兩到三倍，但整體而言未必比純 OpenMP 還要快，因為有 GPU 啟動的 overhead，要跑夠多的測資才看得出來。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div></pre></td><td class="code"><pre><div class="line">#include &lt;cstdio&gt;</div><div class="line">#include &lt;cstdlib&gt;</div><div class="line">#include &lt;algorithm&gt;</div><div class="line">#include &lt;omp.h&gt;</div><div class="line">using namespace std;</div><div class="line">#define MAXN 60005</div><div class="line">#define CHARSET 4</div><div class="line">#define max(x, y) (x) &gt; (y) ? (x) : (y)</div><div class="line">typedef unsigned short uint16;</div><div class="line">static char A[MAXN], B[MAXN];</div><div class="line">static int c2i[128];</div><div class="line">static char i2c[CHARSET+1] = &quot;ACGT&quot;;</div><div class="line">static int *cuP;</div><div class="line">static char *cuB;</div><div class="line">static uint16 *cuDP;</div><div class="line">__global__ void prepare(int *P, char *B, int nb) &#123;</div><div class="line">    int i = threadIdx.x;</div><div class="line">    int *p = P + i*MAXN;</div><div class="line">    char c = &quot;ACGT&quot;[i];</div><div class="line">    p[0] = 0;</div><div class="line">    for (int j = 1; j &lt;= nb; j++)</div><div class="line">        p[j] = (B[j] == c) ? j : p[j-1];</div><div class="line">&#125;</div><div class="line">__global__ void run(int nb, uint16 *dpIn, uint16 *dpOut, int *P) &#123;</div><div class="line">    int j = blockDim.x*blockIdx.x+threadIdx.x+1;</div><div class="line">    if (j &gt; nb)    return ;</div><div class="line">    int pos = P[j];</div><div class="line">    uint16 t1 = pos ? dpIn[pos-1]+1 : 0;</div><div class="line">    uint16 t2 = dpIn[j];</div><div class="line">    dpOut[j] = t1 &gt; t2 ? t1 : t2;</div><div class="line">&#125;</div><div class="line">int lcs_len_seq(const char *A, int na, const char *B, int nb, uint16 dpf[]) &#123;</div><div class="line">    static uint16 dp[2][MAXN];</div><div class="line">    memset(dp[0], 0, sizeof(uint16)*(nb+1));</div><div class="line">    dp[1][0] = 0, dpf[0] = 0;</div><div class="line">    for (int i = 1; i &lt;= na; i++) &#123;</div><div class="line">        for (int j = 1; j &lt;= nb; j++) &#123;</div><div class="line">            if (A[i-1] == B[j-1])</div><div class="line">                dp[1][j] = dp[0][j-1]+1;</div><div class="line">            else</div><div class="line">                dp[1][j] = max(dp[1][j-1], dp[0][j]);</div><div class="line">        &#125;</div><div class="line">        memcpy(dp[0], dp[1], sizeof(uint16)*(nb+1));</div><div class="line">    &#125;</div><div class="line">    for (int i = 0; i &lt;= nb; i++)</div><div class="line">        dpf[i] = dp[0][i];</div><div class="line">    return dpf[nb];</div><div class="line">&#125;</div><div class="line">int lcs_len_omp(const char *A, int na, const char *B, int nb, uint16 dpf[]) &#123;</div><div class="line">    static int P[CHARSET][MAXN];</div><div class="line">    static uint16 dp[2][MAXN];</div><div class="line">    A--, B--;</div><div class="line">#pragma omp parallel for</div><div class="line">    for (int i = 0; i &lt; CHARSET; i++) &#123;</div><div class="line">        memset(P[i], 0, sizeof(int)*(nb+1));</div><div class="line">        for (int j = 1; j &lt;= nb; j++)</div><div class="line">            P[i][j] = (B[j] == i2c[i])? j : P[i][j-1];</div><div class="line">    &#125;</div><div class="line">    for (int i = 0; i &lt; 2; i++)</div><div class="line">        memset(dp[i], 0, sizeof(uint16)*(nb+1));</div><div class="line">#pragma omp parallel</div><div class="line">    for (int i = 1; i &lt;= na; i++) &#123;</div><div class="line">        int *Pv = P[c2i[A[i]]];</div><div class="line">#pragma omp for</div><div class="line">        for (int j = 1; j &lt;= nb; j++) &#123;</div><div class="line">            int last_match = Pv[j];</div><div class="line">            uint16 tmp = last_match ? dp[i&amp;1^1][last_match-1]+1 : 0;</div><div class="line">            dp[i&amp;1][j] = max(dp[i&amp;1^1][j], tmp);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    for (int i = 0; i &lt;= nb; i++)</div><div class="line">        dpf[i] = dp[na&amp;1][i];</div><div class="line">    return dpf[nb];</div><div class="line">&#125;</div><div class="line">int lcs_len(const char *A, int na, const char *B, int nb, uint16 dpf[]) &#123;</div><div class="line">    if (max(na, nb) &lt; 2048)</div><div class="line">        return lcs_len_seq(A, na, B, nb, dpf);</div><div class="line">    if (nb &lt; 10000)</div><div class="line">        return lcs_len_omp(A, na, B, nb, dpf);</div><div class="line">    B--;</div><div class="line">    cudaMemcpy(cuB, B, sizeof(char)*(nb+1), cudaMemcpyHostToDevice);</div><div class="line">    cudaMemset(cuDP, 0, sizeof(uint16)*(nb+1));</div><div class="line">    cudaMemset(cuDP+MAXN, 0, sizeof(uint16)*(nb+1));</div><div class="line"></div><div class="line">    int bsz = 1024;</div><div class="line">    dim3 bb(bsz);</div><div class="line">    dim3 gg((nb+bsz-1)/bsz);</div><div class="line">    prepare&lt;&lt;&lt;1, 4&gt;&gt;&gt;(cuP, cuB, nb);</div><div class="line">    for (int i = 0; i &lt; na; i++) &#123;</div><div class="line">        int v = c2i[A[i]];</div><div class="line">        run&lt;&lt;&lt;gg, bb&gt;&gt;&gt;(nb, cuDP+(i&amp;1)*MAXN, cuDP+((i&amp;1)^1)*MAXN, cuP+v*MAXN);</div><div class="line">    &#125;</div><div class="line">    cudaMemcpy(dpf, cuDP+(na&amp;1)*MAXN, sizeof(uint16)*(nb+1), cudaMemcpyDeviceToHost);</div><div class="line">    return dpf[nb];</div><div class="line">&#125;</div><div class="line">char* alloc_str(int sz) &#123;</div><div class="line">    return (char *) calloc(sz, sizeof(char));</div><div class="line">&#125;</div><div class="line">char* substr(const char *s, int pos, int len) &#123;</div><div class="line">    char *t = alloc_str(len+1);</div><div class="line">    memcpy(t, s+pos, len);</div><div class="line">    return t;</div><div class="line">&#125;</div><div class="line">char* cat(const char *sa, const char *sb) &#123;</div><div class="line">    int na = strlen(sa), nb = strlen(sb);</div><div class="line">    char *t = alloc_str(na + nb + 1);</div><div class="line">    memcpy(t, sa, na);</div><div class="line">    memcpy(t+na, sb, nb);</div><div class="line">    return t;</div><div class="line">&#125;</div><div class="line">char* reverse(const char *s, int len) &#123;</div><div class="line">    char *t = substr(s, 0, len);</div><div class="line">    char *l = t, *r = t + len - 1;</div><div class="line">    char tmp;</div><div class="line">    while (l &lt; r) &#123;</div><div class="line">        tmp = *l, *l = *r, *r = tmp;</div><div class="line">        l++, r--;</div><div class="line">    &#125;</div><div class="line">    return t;</div><div class="line">&#125;</div><div class="line">char* find_lcs(const char *a, int na, const char *b, int nb) &#123;</div><div class="line">    if (na &gt; nb) &#123;</div><div class="line">        const char *c; int t;</div><div class="line">        c = a, a = b, b = c;</div><div class="line">        t = na, na = nb, nb = t;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (na == 0)</div><div class="line">        return alloc_str(1);</div><div class="line"></div><div class="line">    if (na == 1) &#123;</div><div class="line">        for (int i = 0; i &lt; nb; i++) &#123;</div><div class="line">            if (a[0] == b[i])</div><div class="line">                return substr(a, 0, 1);</div><div class="line">        &#125;</div><div class="line">        return alloc_str(1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    static uint16 t1[MAXN];</div><div class="line">    static uint16 t2[MAXN];</div><div class="line">    int len = lcs_len(a, na, b, nb, t1);</div><div class="line">    if (len == 0)</div><div class="line">        return alloc_str(1);</div><div class="line">    int half_len = na / 2;</div><div class="line">    char *la = substr(a, 0, half_len);</div><div class="line">    char *ra = substr(a, half_len, na - half_len);</div><div class="line">    char *tb = reverse(b, nb);</div><div class="line">    char *ta = reverse(ra, na - half_len);</div><div class="line">    lcs_len(la, half_len, b, nb, t1);</div><div class="line">    lcs_len(ta, na - half_len, tb, nb, t2);</div><div class="line"></div><div class="line">    int split = -1;</div><div class="line">    for (int i = 0; i &lt;= nb; i++) &#123;</div><div class="line">        if (t1[i] + t2[nb-i] == len) &#123;</div><div class="line">            split = i;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    char *lb = substr(b, 0, split);</div><div class="line">    char *rb = substr(b, split, nb - split);</div><div class="line">    char *sl = find_lcs(la, half_len, lb, split);</div><div class="line">    char *sr = find_lcs(ra, na - half_len, rb, nb - split);</div><div class="line">    char *ret = cat(sl, sr);</div><div class="line">    free(la), free(ra), free(ta);</div><div class="line">    free(lb), free(rb), free(tb);</div><div class="line">    free(sl), free(sr);</div><div class="line">    return ret;</div><div class="line">&#125;</div><div class="line">int main() &#123;</div><div class="line">    for (int i = 0; i &lt; CHARSET; i++)</div><div class="line">        c2i[i2c[i]] = i;</div><div class="line">    cudaMalloc(&amp;cuB, sizeof(char)*MAXN);</div><div class="line">    cudaMalloc(&amp;cuP, sizeof(int)*MAXN*4);</div><div class="line">    cudaMalloc(&amp;cuDP, sizeof(uint16)*MAXN*2);</div><div class="line">    static uint16 dpf[MAXN];</div><div class="line">    while (scanf(&quot;%s %s&quot;, A, B) == 2) &#123;</div><div class="line">        int na = strlen(A);</div><div class="line">        int nb = strlen(B);</div><div class="line">        int len = lcs_len(A, na, B, nb, dpf);</div><div class="line">        char *str = find_lcs(A, na, B, nb);</div><div class="line">        printf(&quot;%d\n&quot;, len);</div><div class="line">        printf(&quot;%s\n&quot;, str);</div><div class="line">        free(str);	</div><div class="line">    &#125;</div><div class="line">    cudaFree(cuB);</div><div class="line">    cudaFree(cuP);</div><div class="line">    cudaFree(cuDP);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-jg-10112" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/28/jg-10112/" class="article-date">
  <time datetime="2016-06-28T05:29:26.000Z" itemprop="datePublished">2016-06-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/平行程式/">平行程式</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/28/jg-10112/">批改娘 10112. Longest Common Subsequence (CUDA)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/06/28/jg-10112/" data-id="ckxwy6rrl006iesvneap509hh" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/06/28/jg-10112/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CUDA/">CUDA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DP/">DP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LCS/">LCS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/批改娘/">批改娘</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h2><p>給兩個字串 $X, \; Y$，在兩個字串中都有出現且最長的子序列 (subsequence)，就是最長共同子字串<br>。</p>
<h2 id="輸入格式"><a href="#輸入格式" class="headerlink" title="輸入格式"></a>輸入格式</h2><p>有多組測資，每組測資有兩行字串 $X, \; Y$，$X, \; Y$ 只由 <code>A</code> <code>T</code> <code>C</code> <code>G</code> 四個字母構成。</p>
<ul>
<li>$1 \le |X|, |Y| \le 60000$</li>
</ul>
<h2 id="輸出格式"><a href="#輸出格式" class="headerlink" title="輸出格式"></a>輸出格式</h2><p>針對每一組測資，輸出一行 $X, \; Y$ 的最長共同子字串長度。</p>
<h2 id="範例輸入"><a href="#範例輸入" class="headerlink" title="範例輸入"></a>範例輸入</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">TCA</div><div class="line">GTA</div><div class="line">TGGAC</div><div class="line">TATCT</div></pre></td></tr></table></figure>
<h2 id="範例輸出"><a href="#範例輸出" class="headerlink" title="範例輸出"></a>範例輸出</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">2</div><div class="line">3</div></pre></td></tr></table></figure>
<h2 id="編譯參數"><a href="#編譯參數" class="headerlink" title="編譯參數"></a>編譯參數</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ nvcc -Xcompiler &quot;-O2 -fopenmp&quot; main.cu -o main</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>相比於 OpenMP 版本，由於 GPU 的快取設計不如 CPU，在我們使用失敗指針優化 branch 的發生，對 GPU 反而還是慢的，因為要存取 global memory，這使得還不如發生 branch，讓 warp 分多次跑反而比較快，因為有足夠多的 warp 在一個 block。在優化程度上，CPU 和 GPU 還是得分開解決。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 60005</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> CHARSET 4</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> uint16;</div><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> A[MAXN], B[MAXN];</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> c2i[<span class="number">128</span>];</div><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> i2c[CHARSET+<span class="number">1</span>] = <span class="string">"ACGT"</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> *cuP;</div><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> *cuB;</div><div class="line"><span class="keyword">static</span> uint16 *cuDP;</div><div class="line">__<span class="function">global__ <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">int</span> *P, <span class="keyword">char</span> *B, <span class="keyword">int</span> nb)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> i = threadIdx.x;</div><div class="line">    <span class="keyword">int</span> *p = P + i*MAXN;</div><div class="line">    <span class="keyword">char</span> c = <span class="string">"ACGT"</span>[i];</div><div class="line">    p[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= nb; j++)</div><div class="line">        p[j] = (B[j] == c) ? j : p[j<span class="number">-1</span>];</div><div class="line">&#125;</div><div class="line">__<span class="function">global__ <span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">int</span> nb, uint16 *dpIn, uint16 *dpOut, <span class="keyword">int</span> *P)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> j = blockDim.x*blockIdx.x+threadIdx.x+<span class="number">1</span>;</div><div class="line">    <span class="keyword">if</span> (j &gt; nb)	<span class="keyword">return</span> ;</div><div class="line">    <span class="keyword">int</span> pos = P[j];</div><div class="line">    uint16 t1 = pos ? dpIn[pos<span class="number">-1</span>]+<span class="number">1</span> : <span class="number">0</span>;</div><div class="line">    uint16 t2 = dpIn[j];</div><div class="line">    dpOut[j] = t1 &gt; t2 ? t1 : t2;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">lcs_len</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *A, <span class="keyword">int</span> na, <span class="keyword">const</span> <span class="keyword">char</span> *B, <span class="keyword">int</span> nb, uint16 dpf[])</span> </span>&#123;</div><div class="line">    B--;</div><div class="line">    cudaMemcpy(cuB, B, <span class="keyword">sizeof</span>(<span class="keyword">char</span>)*(nb+<span class="number">1</span>), cudaMemcpyHostToDevice);</div><div class="line">    cudaMemset(cuDP, <span class="number">0</span>, <span class="keyword">sizeof</span>(uint16)*(nb+<span class="number">1</span>));</div><div class="line">    cudaMemset(cuDP+MAXN, <span class="number">0</span>, <span class="keyword">sizeof</span>(uint16)*(nb+<span class="number">1</span>));</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> bsz = <span class="number">1024</span>;</div><div class="line">    <span class="function">dim3 <span class="title">bb</span><span class="params">(bsz)</span></span>;</div><div class="line">    dim3 gg((nb+bsz-1)/bsz);</div><div class="line">    prepare&lt;&lt;&lt;<span class="number">1</span>, <span class="number">4</span>&gt;&gt;&gt;(cuP, cuB, nb);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; na; i++) &#123;</div><div class="line">        <span class="keyword">int</span> v = c2i[A[i]];</div><div class="line">        run&lt;&lt;&lt;gg, bb&gt;&gt;&gt;(nb, cuDP+(i&amp;<span class="number">1</span>)*MAXN, cuDP+((i&amp;<span class="number">1</span>)^<span class="number">1</span>)*MAXN, cuP+v*MAXN);</div><div class="line">    &#125;</div><div class="line">    cudaMemcpy(dpf, cuDP+(na&amp;<span class="number">1</span>)*MAXN, <span class="keyword">sizeof</span>(uint16)*(nb+<span class="number">1</span>), cudaMemcpyDeviceToHost);</div><div class="line">    <span class="keyword">return</span> dpf[nb];</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CHARSET; i++)</div><div class="line">        c2i[i2c[i]] = i;</div><div class="line">    cudaMalloc(&amp;cuB, <span class="keyword">sizeof</span>(<span class="keyword">char</span>)*MAXN);</div><div class="line">    cudaMalloc(&amp;cuP, <span class="keyword">sizeof</span>(<span class="keyword">int</span>)*MAXN*<span class="number">4</span>);</div><div class="line">    cudaMalloc(&amp;cuDP, <span class="keyword">sizeof</span>(uint16)*MAXN*<span class="number">2</span>);</div><div class="line">    <span class="keyword">static</span> uint16 dpf[MAXN];</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%s %s"</span>, A, B) == <span class="number">2</span>) &#123;</div><div class="line">        <span class="keyword">int</span> len = lcs_len(A, <span class="built_in">strlen</span>(A), B, <span class="built_in">strlen</span>(B), dpf);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, len);</div><div class="line">    &#125;</div><div class="line">    cudaFree(cuB);</div><div class="line">    cudaFree(cuP);</div><div class="line">    cudaFree(cuDP);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/categories/學校課程/page/2/">2</a><a class="page-number" href="/categories/學校課程/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/categories/學校課程/page/12/">12</a><a class="extend next" rel="next" href="/categories/學校課程/page/2/">Next &raquo;</a>
    </nav>
  
</section>
          
          
            <aside id="sidebar">
  <!-- <div id="ukagaka_panel"></div> -->
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/">學校課程</a><span class="category-list-count">115</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/介面設計/">介面設計</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/作業系統/">作業系統</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/即時系統/">即時系統</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/大學專題/">大學專題</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/巨量資料/">巨量資料</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/平行程式/">平行程式</a><span class="category-list-count">43</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/敏捷方法/">敏捷方法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/編譯器/">編譯器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/自然語言/">自然語言</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/虛擬實境/">虛擬實境</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算型智慧/">計算型智慧</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算幾何/">計算幾何</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算機圖學/">計算機圖學</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資料庫系統/">資料庫系統</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資訊安全/">資訊安全</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/通識課程/">通識課程</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/">工作應用</a><span class="category-list-count">38</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Java/">Java</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Meme/">Meme</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/其他/">其他</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/可持久化/">可持久化</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/鬼故事/">鬼故事</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/手札日記/">手札日記</a><span class="category-list-count">57</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/">網頁設計</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/About-This-Blog/">About This Blog</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/HTML5/">HTML5</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/JQuery/">JQuery</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/Markdown/">Markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/NodeJs/">NodeJs</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/">解題區</a><span class="category-list-count">633</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/Latex/">Latex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/出題解題/">出題解題</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-POJ/">解題區 - POJ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a><span class="category-list-count">483</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a><span class="category-list-count">77</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-未解題目/">解題區 - 未解題目</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/雜言筆記/">雜言筆記</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a class="text" href="/2022/01/01/note/diary-20220101-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·柒 暗潮》</a>
          </li>
        
          <li>
            <a class="text" href="/2022/01/01/note/diary-20220101/">
              
                <i class="icon-file-o"></i> 
              
            二八 ‧ 年尾</a>
          </li>
        
          <li>
            <a class="text" href="/2022/01/01/note/clove-letter/">
              
                <i class="icon-file-o"></i> 
              
            《獻給某工程師的情書》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/12/31/note/diary-20211231-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·陸 二八》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/12/26/note/diary-20211226-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·伍 坦白》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/11/21/note/diary-20211121-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·肆 雨中》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/11/12/note/diary-20211112-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·參 來遇》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/31/note/diary-20211031-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·貳 去遇》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/28/note/diary-202110-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·序 遇見》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/28/note/diary-202110/">
              
                <i class="icon-file-o"></i> 
              
            好多個 28 在這個時刻</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">   
        <ul>
          <li><a href="http://mypaper.pchome.com.tw/zerojudge" target="_blank" title="Old Blog"><i class="icon-star"></i> Morris' Blog (pchome)</a></li>
        </ul>
    </div>
</div>

  
    
<script src="/js/jquery-ui.js"></script>
<script src="/js/ukagaka/jquery.morris.ukagaka.resource.js"></script>
<script src="/js/ukagaka/typed.js"></script>
  
  
</aside>
          
        
      </div>
      <footer id="footer">
  
  <div class="outer">    
    <div class="social-group">
      
      <a href="https://github.com/morris821028" target="_blank" title="github"><i class="icon-github"></i></a>
      
      
      <a href="https://www.facebook.com/Morris1028" target="_blank" title="facebook"><i class="icon-facebook-sign"></i></a>
      
      
      <a href="http://uhunt.felix-halim.net/id/46705" target="_blank" title="uhunt" ><span class="icon-uhunt">UVa<span></a>
      
    </div>
    <div id="footer-info" class="inner">
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/morris821028/hexo-theme-landscape" target="_blank" title="landscape">landscape</a> &copy; 2022 Shiang-Yun Yang 
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link"><i class=icon-home ></i>&nbsp&nbspHome</a>
  
    <a href="/about" class="mobile-nav-link"><i class=icon-user ></i>&nbsp&nbspAbout</a>
  
    <a href="/archives" class="mobile-nav-link"><i class=icon-archive ></i>&nbsp&nbspArchives</a>
  
    <a href="/tags" class="mobile-nav-link"><i class=icon-tags ></i>&nbsp&nbspTags</a>
  
    <a href="/picture" class="mobile-nav-link"><i class=icon-camera ></i>&nbsp&nbspPictures</a>
  
    <a href="/works" class="mobile-nav-link"><i class=icon-trophy ></i>&nbsp&nbspWorks</a>
  
</nav>
    
<script>
  var disqus_shortname = 'morris1028';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/jquery.lazyload.js"></script>
<script src="/js/jquery.als-1.6.js"></script>

<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>