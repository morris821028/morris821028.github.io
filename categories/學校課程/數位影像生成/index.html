<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Category: 數位影像生成 | Morris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Morris&#39; Blog">
<meta property="og:url" content="http://morris821028.github.io/categories/學校課程/數位影像生成/index.html">
<meta property="og:site_name" content="Morris&#39; Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Morris&#39; Blog">
<link rel="publisher" href="108158678174364350000">
  
    <link rel="alternative" href="/atom.xml" title="Morris&#39; Blog" type="application/atom+xml">
  
  
    <meta name="google-site-verification" content="5mRgj8NanEMpGZuNfHNJNmH90RgNlrnJXsFlTaKD6Gs" />
  
  
    <link rel="shortcut icon" href="/img/f.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script src="/js/jquery-2.1.0.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.5.1.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdn.oesmith.co.uk/morris-0.5.1.min.js"></script>
  <!-- <link rel="import" href="/bower_components/app-layout/app-layout.html"> --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"><div id="banner-right"></div></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Morris&#39; Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class=icon-home title='Home'></i></a>
          
        
          
            <a class="main-nav-link" href="/about"><i class=icon-user title='About'></i></a>
          
        
          
            <a class="main-nav-link" href="/archives"><i class=icon-archive title='Archives'></i></a>
          
        
          
            <a class="main-nav-link" href="/tags"><i class=icon-tags title='Tags'></i></a>
          
        
          
            <a class="main-nav-link" href="/picture"><i class=icon-camera title='Pictures'></i></a>
          
        
          
            <a class="main-nav-link" href="/works"><i class=icon-trophy title='Works'></i></a>
          
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://morris821028.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        
          
          <section id="main">
  
    <article id="post-rendering-bvh-contract-and-traversal" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/21/rendering-bvh-contract-and-traversal/" class="article-date">
  <time datetime="2016-01-21T09:31:34.000Z" itemprop="datePublished">2016-01-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/21/rendering-bvh-contract-and-traversal/">pbrt-v2 加速結構 BVH-contract 改寫</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/01/21/rendering-bvh-contract-and-traversal/" data-id="ckxtxqs9800etgkvnhjeq4vn3" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/01/21/rendering-bvh-contract-and-traversal/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h3 id="Description-of-implementation-approach-and-comments"><a href="#Description-of-implementation-approach-and-comments" class="headerlink" title="Description of implementation approach and comments"></a>Description of implementation approach and comments</h3><p>從一般 BVH 架構中，一般都是用 full binary tree，子節點要不 0 個要不 2 個。若有 <span>$N$</span><!-- Has MathJax --> 個 primitive 物件，則表示有 <span>$N$</span><!-- Has MathJax --> 個葉節點放置這些 primitive 物件，而有 <span>$N-1$</span><!-- Has MathJax --> 個內部節點紀錄 Bounding Box 的部分。在測試交點和遍歷走訪的使用上，最慘有一半是多餘計算和走訪，而另一半屬於加速結構。</p>
<p>在論文 <a href="">Ray Specialized Contraction on Bounding Volume Hierarchies</a> 中，企圖想要利用 generic tree 取代一般使用 full binary tree 實作，在不更動 BVH 的效能下，減少運行上較沒用的內部節點，用以提升遍歷走訪效能，以及提升內存快取的效率。</p>
<p>降低內部節點步驟如下所示：</p>
<ol>
<li>利用原生方法建立 full binary tree 的 BVH (利用各種分割策略完成)</li>
<li>進行坍倒 (flatten)，將二元樹不連續的記憶體分布調整成線性分布，加速遍歷走訪的內存快取效率。</li>
<li>靜態調整成 generic tree 版本，藉由啟發式收縮 (Contract)，利用節點與其子節點的 Bounding Box 表面積比例，評估浪費的走訪節點。</li>
<li>動態調整部分，採用隨機取樣，根據取樣 ray，取樣走訪次數，將比較容易打到的節點盡可能收縮到接近根節點。</li>
</ol>
<p>若要收縮節點 <span>$N$</span><!-- Has MathJax -->，假設 Bounding box 計算交點花費為 <span>$C_B$</span><!-- Has MathJax -->，穿過節點 <span>$N$</span><!-- Has MathJax --> 的 Bounding box 射線機率 <span>$\alpha_N$</span><!-- Has MathJax -->，得到收縮前後的計算差值 <span>$\delta(N)$</span><!-- Has MathJax -->，如下所示。</p>
<span>$$\begin{align}
\delta(N) &amp;= n_{N.\text{child}} \; C_B - (\alpha_N (1+n_{N.\text{child}}) +(1 - \alpha_N)) \; C_B \\
&amp; = ((1 - \alpha_N) \; n_{N.\text{child}} - 1) \; C_B
\end{align}$$</span><!-- Has MathJax -->
<p>目標讓 <span>$\delta(N) &lt; 0$</span><!-- Has MathJax -->，得到</p>
<span>$\alpha(N) &gt; 1 - \frac{1}{n_{N.\text{child}}}$</span><!-- Has MathJax -->
<p>計算 <span>$\delta(N)$</span><!-- Has MathJax --> 顯得要有效率，但又沒辦法全局考量，需要提供一個猜測算法，藉由部分取樣以及步驟 2. 的表面積總和比例進行收縮。</p>
<h3 id="實作部分"><a href="#實作部分" class="headerlink" title="實作部分"></a>實作部分</h3><p>從實作中，在步驟 2. 約略可以減少 <span>$25\%$</span><!-- Has MathJax --> 的節點，在記憶體方面的影響量沒有太大影響，節點紀錄資訊也增加 (<code>sizeof(struct Node)</code> 相對地大上許多)。</p>
<p>在步驟 3. 中，根據 pbrt-v2 的架構，加速結構能取得的場景資訊並不容易竄改，大部分的類別函數都是 <code>const function()</code>，意即無法變動 object member 的值，但針對指向位址的值可以改變。這類寫法，猜想所有加速結構都是靜態決定，在多核心運行時較不會存在同步 overhead 的影響。</p>
<p>在此，換成另外一種修改方案，在 <code>pbrt-v2/core/scene.h</code> 的 <code>bool Scene::Intersect(...)</code> 函數中加入 <code>aggregate-&gt;tick();</code>。利用 <code>aggregate-&gt;tick();</code> 這個函數，大部分呼叫都沒有更動樹狀結構。當呼叫次數 <span>$T$</span><!-- Has MathJax --> 達到一定次數時，加速結構會進行大規模的結構調整。</p>
<p>根據 pbrt rendering 的步驟，儘管不斷地測試或者是估計 <span>$T$</span><!-- Has MathJax --> 要設定的值，都無法接近全局的取樣評估，其中最大的原因是取樣順序和局部取樣調整，從理論上得知不可能會有比較好的結果。這樣的寫法提供簡便的方案去統計 pbrt 運算時較有可能的 ray 從哪裡射出，不用挖掘所有的不同類型 ray 進行取樣。</p>
<p>最後，修改檔案如下：</p>
<h4 id="修改檔案清單"><a href="#修改檔案清單" class="headerlink" title="修改檔案清單"></a>修改檔案清單</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">.</div><div class="line">├── accelerators</div><div class="line">│   ├── bvhcontract.cpp</div><div class="line">│   └── bvhcontract.h</div><div class="line">└── core</div><div class="line">    ├── api.cpp</div><div class="line">    ├── primitive.cpp</div><div class="line">    ├── primitive.h</div><div class="line">    └── scene.h</div></pre></td></tr></table></figure>
<h4 id="core-api-cpp"><a href="#core-api-cpp" class="headerlink" title="core/api.cpp"></a><code>core/api.cpp</code></h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function">Primitive *<span class="title">MakeAccelerator</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span> &amp;name,</span></span></div><div class="line"><span class="function"><span class="params">                           <span class="keyword">const</span> <span class="built_in">vector</span>&lt;Reference&lt;Primitive&gt; &gt; &amp;prims,</span></span></div><div class="line"><span class="function"><span class="params">                           <span class="keyword">const</span> ParamSet &amp;paramSet)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (name == <span class="string">"bvhcontract"</span>)</div><div class="line">        accel = CreateBVHContractAccelerator(prims, paramSet);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="core-primitive-h"><a href="#core-primitive-h" class="headerlink" title="core/primitive.h"></a><code>core/primitive.h</code></h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Primitive</span> :</span> <span class="keyword">public</span> ReferenceCounted &#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    ...</div><div class="line">    <span class="comment">// MORRIS ADD</span></div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">tick</span><span class="params">()</span></span>;</div><div class="line">    ...</div><div class="line"><span class="keyword">protected</span>:</div><div class="line">    ...</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="core-scene-h"><a href="#core-scene-h" class="headerlink" title="core/scene.h"></a><code>core/scene.h</code></h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scene</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="comment">// Scene Public Methods</span></div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">Intersect</span><span class="params">(<span class="keyword">const</span> Ray &amp;ray, Intersection *isect)</span> <span class="keyword">const</span> </span>&#123;</div><div class="line">        ...</div><div class="line">        aggregate-&gt;tick();</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="Generic-Tree-設計與走訪測試"><a href="#Generic-Tree-設計與走訪測試" class="headerlink" title="Generic Tree 設計與走訪測試"></a>Generic Tree 設計與走訪測試</h3><p>在 Full binary tree style - BVH 實作中，利用前序走訪分配節點編號範圍 <span>$[0, 2N-1]$</span><!-- Has MathJax -->，因此節點編號 <span>$u$</span><!-- Has MathJax --> 的左子樹的編號為 <span>$u+1$</span><!-- Has MathJax -->，只需要紀錄右子樹編號 <code>secondChildOffset</code>，這種寫法在空間和走訪時的快取都有效能改善。在標準程序中也單用迭代方式即可完成，不採用遞迴走訪，減少 push stack 的指令。</p>
<p>在 Generic tree 版本中，基礎節點紀錄架構如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">LinearTreeNode</span> &#123;</span></div><div class="line">    <span class="comment">// node link information</span></div><div class="line">    <span class="keyword">uint32_t</span> parentOffset;</div><div class="line">    <span class="keyword">uint32_t</span> childOffsetHead, childOffsetTail;</div><div class="line">    <span class="keyword">uint32_t</span> siblingOffsetNext, siblingOffsetPrev;</div><div class="line">    <span class="comment">// faster record</span></div><div class="line">    <span class="keyword">uint32_t</span> numChild;</div><div class="line">    <span class="comment">// node data</span></div><div class="line">    TreeData e;</div><div class="line">    <span class="keyword">uint32_t</span> visitCount;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>在原生 BVH 求交點寫法中，根據節點的 Split-Axis 以及 Ray 的方向決定先左子樹還是先右子樹走訪，藉以獲得較高的剪枝機率。但全部先左子樹走訪的快取優勢比較高 (因為前序分配節點編號)，反之在 Split-Axis 有一半的機率走會走快取優勢不高的情況，在權衡兩者之間。</p>
<p>然而在 Generic Tree 實作上，若要提供 Split-Axis 則需要提供 <code>childOffsetTail</code> 和 <code>siblingOffsetPrev</code> 兩個指針，則多了兩個紀錄欄位，單一節點大小從 <code>sizeof(LinearBVHNode) = 32</code>拓展到 <code>sizeof(LinearBVHContractNode) = 60</code>，記憶體用量整整接近兩倍。從 Contract 算法中，節點個數保證無法減少一半，推論得到在 Contract 後記憶體用量會多一些。</p>
<p>走訪實作上分成遞迴和迭代兩種版本，遞迴在效能上會卡在 push esp, argument 等資訊上，而在迭代版本省了 call function overhead 和空間使用，但增加計算次數。而在我撰寫的版本中，還必須 access 父節點的資訊決定要往 <code>siblingOffsetNext</code> 還是 <code>siblingOffsetprev</code>，因此快取效能從理論上嚴重下滑。</p>
<p>遞迴和迭代走訪寫法如下：</p>
<h4 id="遞迴版本走訪"><a href="#遞迴版本走訪" class="headerlink" title="遞迴版本走訪"></a>遞迴版本走訪</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">recursiveTraverse</span><span class="params">(LinearTreeNode *node, LinearTreeNode *_mem)</span> </span>&#123;</div><div class="line">    <span class="comment">// proess</span></div><div class="line">    <span class="keyword">uint32_t</span> offset = node-&gt;childOffsetHead;</div><div class="line">    <span class="keyword">if</span> (offset == <span class="number">-1</span>)</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    <span class="keyword">for</span> (LinearTreeNode *u; offset != <span class="number">-1</span>; offset = u-&gt;siblingOffsetNext) &#123;</div><div class="line">        u = &amp;_mem[offset];</div><div class="line">        recursiveTraverse(u, _mem);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="迭代版本走訪"><a href="#迭代版本走訪" class="headerlink" title="迭代版本走訪"></a>迭代版本走訪</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">iteratorTraverse</span><span class="params">(<span class="keyword">uint32_t</span> offset, LinearTreeNode *_mem)</span> </span>&#123;</div><div class="line">    <span class="keyword">bool</span> process = <span class="literal">true</span>;</div><div class="line">    <span class="keyword">while</span> (offset != <span class="number">-1</span>) &#123;</div><div class="line">        LinearTreeNode *node = &amp;_mem[offset];</div><div class="line">        <span class="keyword">if</span> (process) &#123;</div><div class="line">            <span class="comment">// process</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (node-&gt;childOffsetHead != <span class="number">-1</span> &amp;&amp; process) &#123;</div><div class="line">            offset = node-&gt;childOffsetHead;</div><div class="line">            process = <span class="literal">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node-&gt;siblingOffsetNext != <span class="number">-1</span>) &#123;</div><div class="line">            offset = node-&gt;siblingOffsetNext;</div><div class="line">            process = <span class="literal">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            offset = node-&gt;parentOffset;</div><div class="line">            process = <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="節點大小對走訪效能影響"><a href="#節點大小對走訪效能影響" class="headerlink" title="節點大小對走訪效能影響"></a>節點大小對走訪效能影響</h4><p>從實驗數據看來，遞迴版本比迭代版本在越大節點情況效能普遍性地好，預估是在遞迴版本造成的快取效能好上許多。</p>
<table>
<thead>
<tr>
<th>sizeof(LinearTreeNode) bytes \ Traversal</th>
<th>Recursive</th>
<th>Loop</th>
</tr>
</thead>
<tbody>
<tr>
<td>32</td>
<td>6.049s</td>
<td>5.628s</td>
</tr>
<tr>
<td>44</td>
<td>6.651s</td>
<td>6.817s</td>
</tr>
<tr>
<td>60</td>
<td>7.460s</td>
<td>6.888s</td>
</tr>
<tr>
<td>92</td>
<td>9.361s</td>
<td>9.271s</td>
</tr>
<tr>
<td>156</td>
<td>16.844s</td>
<td>16.694s</td>
</tr>
<tr>
<td>220</td>
<td>25.294s</td>
<td>27.031s</td>
</tr>
<tr>
<td>284</td>
<td>28.181s</td>
<td>30.900s</td>
</tr>
<tr>
<td>540</td>
<td>28.560s</td>
<td>33.707s</td>
</tr>
</tbody>
</table>
<h3 id="實驗結果"><a href="#實驗結果" class="headerlink" title="實驗結果"></a>實驗結果</h3><p>由於 <code>tick()</code> 效果並不好，調整參數後與原生的作法差距仍然存在，單靠表面積提供的啟發式收縮，效率比加上動態結果還好。但從實驗結果中得知，實作方面存在一些尚未排除的效能障礙，在多核心部分效能差距就非常明顯，預計是在求交點時同步資料造成的 overhead 時間。</p>
<p>而在減少的節點數量，光是啟發是的表面收縮就減少 <span>$25\%$</span><!-- Has MathJax --> 節點量，而在動態收縮處理，儘管已經探訪 <span>$10^7$</span><!-- Has MathJax --> 收縮點數量近乎微乎其微 (不到一兩百個節點)。</p>
<table>
<thead>
<tr>
<th>sences \ BVH policy</th>
<th>Native</th>
<th>Contract(loop)</th>
<th>Contract(recursive)</th>
<th>Node Reduce</th>
</tr>
</thead>
<tbody>
<tr>
<td>sibenik.pbrt</td>
<td>7.000s</td>
<td>10.502s</td>
<td>9.411s</td>
<td>99576 / 131457</td>
</tr>
<tr>
<td>yeahright.pbrt</td>
<td>12.297s</td>
<td>14.638s</td>
<td>14.210s</td>
<td>288707 / 376317</td>
</tr>
<tr>
<td>sponza-fog.pbrt</td>
<td>16m36.037s</td>
<td>21m09.960s</td>
<td>20m12.012s</td>
<td>91412 / 121155</td>
</tr>
</tbody>
</table>
<h3 id="Test-sences"><a href="#Test-sences" class="headerlink" title="Test sences"></a>Test sences</h3><ul>
<li><a href="http://www.pbrt.org/scenes.php" target="_blank" rel="external">pbrt.org scenes</a></li>
</ul>
<h3 id="Reference-paper"><a href="#Reference-paper" class="headerlink" title="Reference paper"></a>Reference paper</h3><p><a href="http://www.cs.cmu.edu/~ygu1/paper/PG15/conference.pdf" target="_blank" rel="external">Ray Specialized Contraction on Bounding Volume Hierarchies, Yan Gu Yong He Guy E. Blelloch</a></p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-rendering-environment-lights" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/21/rendering-environment-lights/" class="article-date">
  <time datetime="2016-01-21T09:06:48.000Z" itemprop="datePublished">2016-01-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/21/rendering-environment-lights/">pbrt-v2 加速結構 Environment Lights 改寫</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/01/21/rendering-environment-lights/" data-id="ckxtxqs9b00f0gkvnnvnwfdko" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/01/21/rendering-environment-lights/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h3 id="Median-Cut-Algorithm"><a href="#Median-Cut-Algorithm" class="headerlink" title="Median Cut Algorithm"></a>Median Cut Algorithm</h3><p>根據論文 <a href="http://dl.acm.org/citation.cfm?id=1187029" target="_blank" rel="external">P. Debevec, A Median Cut Algorithm for Light Probe Sampling, SIGGRAPH 2006 Sketches and Applications.</a> 中，預期要將 <code>pbrt/lights/infinite.cpp</code> 中的 <code>class InfiniteAreaLight</code> 用數個點光源取代 Infinite Area Light 的寫法，提升均勻取樣的效能，而 Median Cut Algorithm 在預處理非常快，根據用多少量的點光源將影響品質，若在品質不用太好的 rendering 環境下，這是一個不錯的降質提升速度的方案。</p>
<h4 id="在-Median-Cut-Algorithm-取樣-64-equal-energy-region-的速度在不同取樣個數差異比較"><a href="#在-Median-Cut-Algorithm-取樣-64-equal-energy-region-的速度在不同取樣個數差異比較" class="headerlink" title="在 Median Cut Algorithm 取樣 64 equal-energy region 的速度在不同取樣個數差異比較"></a>在 Median Cut Algorithm 取樣 64 equal-energy region 的速度在不同取樣個數差異比較</h4><h5> Env-Light.pbrt </h5>

<div style="padding: 10px;"><br>  <div id="run-result" style="height: 480px; "><br>  </div><br></div>

<h5> Env-Light-new.pbrt </h5>

<div style="padding: 10px;"><br>  <div id="run-result-new" style="height: 480px;"><br>  </div><br></div>

<h4 id="在-Median-Cut-Algorithm-不同數量-equal-energy-region-在-256-samples-速度"><a href="#在-Median-Cut-Algorithm-不同數量-equal-energy-region-在-256-samples-速度" class="headerlink" title="在 Median Cut Algorithm 不同數量 equal-energy region 在 256 samples 速度"></a>在 Median Cut Algorithm 不同數量 equal-energy region 在 256 samples 速度</h4><h5> Median Cut Algorithm equal-energy region </h5>

<div style="padding: 10px;"><br>  <div id="run-result-region" style="height: 480px; "><br>  </div><br></div>

<script>
new Morris.Line({
  element: 'run-result',
  data: [
    { y: '4', a: 7.044, b: 5.970, c: 5.995 },
    { y: '16', a: 11.570,  b: 6.847, c: 7.007 },
    { y: '64', a: 30.650,  b: 10.487, c: 10.496 },
    { y: '256', a: 106.768,  b: 25.756, c: 27.283 }
  ],
  parseTime: false,
  xkey: 'y',
  ykeys: ['a', 'b', 'c'],
  ymin: 0.0,
  ymax: 150.0,
  labels: ['InfiniteAreaLight', 'Median-Cut Centroid 1', 'Median-Cut Centroid 2']
});
new Morris.Line({
  element: 'run-result-new',
  data: [
    { y: '4', a: 9.343, b: 11.415, c: 11.390 },
    { y: '16', a: 14.695,  b: 12.682, c: 12.640 },
    { y: '64', a: 35.954,  b: 17.984, c: 17.944 },
    { y: '256', a: 121.204,  b: 39.614, c: 39.573 }
  ],
  parseTime: false,
  xkey: 'y',
  ykeys: ['a', 'b', 'c'],
  ymin: 0.0,
  ymax: 150.0,
  labels: ['InfiniteAreaLight', 'Median-Cut Centroid 1', 'Median-Cut Centroid 2']
});
new Morris.Line({
  element: 'run-result-region',
  data: [
    { y: '4', a: 26.176, b: 41.869},
    { y: '16', a: 24.804, b: 39.456},
    { y: '64', a: 25.756, b: 39.614},
    { y: '256', a: 27.181, b: 45.259 }
  ],
  parseTime: false,
  xkey: 'y',
  ykeys: ['a', 'b'],
  ymin: 20.0,
  ymax: 60.0,
  labels: ['EnvLight', 'EnvLight-new']
});
</script>

<p>算法的步驟如下：</p>
<ol>
<li>將入射光場影像 (light probe image) 切成好幾個矩形區域，每一個區域將取用一個點光源代替。將入射光場影像轉換成灰階亮度 <span>$Y$</span><!-- Has MathJax -->，如論文中所提及的方案 <span>$Y = 0.2125 R + 0.7154 G + 0.0721 B$</span><!-- Has MathJax --> 這類型的轉換。</li>
<li>對於每一個區域將會根據最長維度切割成兩個子區域。切割成兩個子區域的亮度總和越接近越好。</li>
<li>若切割區域數量不到目標的數量，則重複步驟 2。</li>
<li>最後將每一個區域算出代表的點光源，並加總區域內的亮度和，隨後取樣根據亮度和作為取樣根據 (在 <code>Spectrum MedianCutEnvironmentLight::Sample_L(const Point&amp;, float, const LightSample&amp;, float, Vector&amp;, float*, VisibilityTester*)</code> 中使用)，用每一個區域內部的 pixel 位置和亮度計算重心作為代表的點光源。</li>
</ol>
<p>算法類似於 k-d Tree，但特別的是每次選擇區域維度最長的那一段進行切割，而不是像 k-d Tree 則是採用輪替維度進行。</p>
<p>Median Cut Algorithm 需要 <span>$\mathcal{O}(HW)$</span><!-- Has MathJax --> 時間 <span>$\mathcal{O}(HW)$</span><!-- Has MathJax --> 空間來預處理亮度資訊。若要切割成 <span>$N$</span><!-- Has MathJax --> 個區域，需要 <span>$\mathcal{O}(\log N)$</span><!-- Has MathJax --> 次迭代，每一次迭代增加兩倍區域數量。將一個區域切割時，針對維度最長的那一軸二分搜尋，二分搜尋計算其中一個區域的亮度和是否是整個區域亮度的一半，由於預處理完成的表格，可以在 <span>$\mathcal{O}(1)$</span><!-- Has MathJax --> 時間內計算任意平行兩軸的矩形內部元素總和。</p>
<p>維護 <code>sumTable[i][j]</code> 計算左上角 <span>$(0, 0)$</span><!-- Has MathJax --> 右下角 <span>$(i, j)$</span><!-- Has MathJax --> 的亮度和，計算任意平行兩軸矩形內部和只需要 <span>$\mathcal{O}(1)$</span><!-- Has MathJax --> 時間。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">float</span> <span class="title">getEnergy</span><span class="params">(<span class="keyword">float</span> sumTable[], <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">    <span class="keyword">float</span> e = sumTable[VERT(ru, rv)];</div><div class="line">    <span class="keyword">if</span> (lu)	e -= sumTable[VERT(lu<span class="number">-1</span>, rv)];</div><div class="line">    <span class="keyword">if</span> (lv)	e -= sumTable[VERT(ru, lv<span class="number">-1</span>)];</div><div class="line">    <span class="keyword">if</span> (lu &amp;&amp; lv)	e += sumTable[VERT(lu<span class="number">-1</span>, lv<span class="number">-1</span>)];</div><div class="line">    <span class="keyword">return</span> e;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>另一種方案，可以從 pbrt 原生的 <code>class MIPMap</code> 取代上述寫法，<code>MIPMap</code> 的寫法採用分層式的架構，每一層將原圖長寬各縮小一半。計算某矩形元素總和時，藉由兩層的總和估計進行內插。理論上，這種寫法雖然不夠精準，但提供很好的快取優勢。</p>
</blockquote>
<h3 id="重心計算"><a href="#重心計算" class="headerlink" title="重心計算"></a>重心計算</h3><h3 id="Centroid-Formula-1"><a href="#Centroid-Formula-1" class="headerlink" title="Centroid Formula 1"></a>Centroid Formula 1</h3><p>一般重心計算採用以下公式：</p>
<span>$$X_c = \frac{\sum^{}_{(x, y) \in \mathit{region}} L_{(x, y)} \; x}{\sum^{}_{(x, y) \in \mathit{region}} L_{(x, y)}} \\
Y_c = \frac{\sum^{}_{(x, y) \in \mathit{region}} L_{(x, y)} \; y}{\sum^{}_{(x, y) \in \mathit{region}} L_{(x, y)}}$$</span><!-- Has MathJax -->
<p>經由 Median-Cut Algorithm 在 Texmap 1 運行後，代表的點光源明顯地偏離亮區，因此為了讓代表的點光源更靠近亮區，我們將其重心公式修改成 Centroid Formula 2。</p>
<h3 id="Centroid-Formula-1-1"><a href="#Centroid-Formula-1-1" class="headerlink" title="Centroid Formula 1"></a>Centroid Formula 1</h3><p>若以 <span>$\mathit{Energy} \propto L^2_{(x, y)}$</span><!-- Has MathJax -->，能量與亮度二次成正比，則計算出的重心會更靠近亮區。</p>
<span>$$X_c = \frac{\sum^{}_{(x, y) \in \mathit{region}} L^2_{(x, y)} \; x}{\sum^{}_{(x, y) \in \mathit{region}} L^2_{(x, y)}} \\
Y_c = \frac{\sum^{}_{(x, y) \in \mathit{region}} L^2_{(x, y)} \; y}{\sum^{}_{(x, y) \in \mathit{region}} L^2_{(x, y)}}$$</span><!-- Has MathJax -->
<p>比較結果如下：</p>
<p>由於 CSS 問題，詳細內容請到 <a href="http://morris821028.github.io/hw-rendering/homework3/submission/index.html">http://morris821028.github.io/hw-rendering/homework3/submission/index.html</a> 觀看。</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-rendering-realistic-camera" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/21/rendering-realistic-camera/" class="article-date">
  <time datetime="2016-01-21T08:35:46.000Z" itemprop="datePublished">2016-01-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/21/rendering-realistic-camera/">pbrt-v2 加速結構 Realistic Camera 改寫</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/01/21/rendering-realistic-camera/" data-id="ckxtxqs9c00f2gkvnqlwkhgjf" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/01/21/rendering-realistic-camera/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h3 id="Ray-Sphere-Intersection"><a href="#Ray-Sphere-Intersection" class="headerlink" title="Ray Sphere Intersection"></a>Ray Sphere Intersection</h3><p>計算射線和球體的交點，可以參照 <code>/pbrt-v2/shapes/sphere.cpp</code> 中 <code>bool Shpere::Intersect()</code> 的算法。</p>
<p>假設球體圓心座標 <span>$O$</span><!-- Has MathJax -->，射線單位向量 <span>$I$</span><!-- Has MathJax --> 的起點座標 <span>$C$</span><!-- Has MathJax -->，且最近目標交點座標 <span>$P$</span><!-- Has MathJax -->，原半徑 <span>$\mathrm{radius}$</span><!-- Has MathJax -->。射線走單位時間 <span>$t$</span><!-- Has MathJax --> 會到達球面上。</p>
<ul>
<li><span>$\overrightarrow{OC} + \overrightarrow{I} \times t = \overrightarrow{OP}$</span><!-- Has MathJax --></li>
<li><span>$|\overrightarrow{OP}| = \text{radius}$</span><!-- Has MathJax --></li>
<li><span>$|\overrightarrow{OC} + \overrightarrow{I} \times t| = |\overrightarrow{OP}|$</span><!-- Has MathJax --></li>
<li><span>$|\overrightarrow{I}|^2 t^2 + 2 \; (\overrightarrow{OC} \cdot \overrightarrow{I}) \; t + |\overrightarrow{OC}|^2 - \text{radius}^2 = 0$</span><!-- Has MathJax -->
</li>
</ul>
<p>解一元二次方程式之後可以得到 <span>$t$</span><!-- Has MathJax --> 得值，並得到交點座標 <span>$P$</span><!-- Has MathJax -->。</p>
<p><img src="http://morris821028.github.io/hw-rendering/homework2/submission/images/hw2_circle_intersect.png" alt=""></p>
<h3 id="Snell’s-Law"><a href="#Snell’s-Law" class="headerlink" title="Snell’s Law"></a>Snell’s Law</h3><p>根據物理法則斯乃爾定律計算折射的方向向量，課程中提供三種做法。</p>
<p>變數解釋：入射介面材質 <span>$\eta_1$</span><!-- Has MathJax -->，折射介面材質 <span>$\eta_2$</span><!-- Has MathJax -->，入射單位向量 <span>$\overrightarrow{I}$</span><!-- Has MathJax -->，交點面法向量 <span>$\overrightarrow{N}$</span><!-- Has MathJax -->，折射方向向量 <span>$\overrightarrow{T}$</span><!-- Has MathJax --></p>
<p>特別小心 <code>ray-&gt;d = Normalize(ray-&gt;d)</code> 的處理，Heckbert’s Method 計算維持在單位圓上，故不用做最後的正規化計算。</p>
<h4 id="Whitted’s-Method"><a href="#Whitted’s-Method" class="headerlink" title="Whitted’s Method"></a>Whitted’s Method</h4><table>
<thead>
<tr>
<th><span>$\sqrt{}$</span><!-- Has MathJax --></th>
<th><span>$/$</span><!-- Has MathJax --></th>
<th><span>$\times$</span><!-- Has MathJax --></th>
<th><span>$+$</span><!-- Has MathJax --></th>
<th>compute</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>1</td>
<td></td>
<td></td>
<td><span>$n = \eta_1 / \eta_2$</span><!-- Has MathJax --></td>
</tr>
<tr>
<td></td>
<td>3</td>
<td>3</td>
<td>2</td>
<td><span>$I&apos; = I / (-I \cdot N)$</span><!-- Has MathJax --></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>3</td>
<td><span>$J = I&apos; + N$</span><!-- Has MathJax --></td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>8</td>
<td>5</td>
<td><span>$\alpha = 1 / \sqrt{n^2(I&apos; \cdot I&apos;) - (J \cdot J)}$</span><!-- Has MathJax --></td>
</tr>
<tr>
<td></td>
<td></td>
<td>3</td>
<td>3</td>
<td><span>$T&apos; = \alpha J - N$</span><!-- Has MathJax --></td>
</tr>
<tr>
<td>1</td>
<td>3</td>
<td>3</td>
<td>2</td>
<td><span>$T&apos; = T&apos; / \| T&apos; \|$</span><!-- Has MathJax --></td>
</tr>
<tr>
<td>2</td>
<td>8</td>
<td>17</td>
<td>15</td>
<td>TOTAL</td>
</tr>
</tbody>
</table>
<h4 id="Heckbert’s-Method"><a href="#Heckbert’s-Method" class="headerlink" title="Heckbert’s Method"></a>Heckbert’s Method</h4><table>
<thead>
<tr>
<th><span>$\sqrt{}$</span><!-- Has MathJax --></th>
<th><span>$/$</span><!-- Has MathJax --></th>
<th><span>$\times$</span><!-- Has MathJax --></th>
<th><span>$+$</span><!-- Has MathJax --></th>
<th>compute</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>1</td>
<td></td>
<td></td>
<td><span>$\eta = \eta_1 / \eta_2$</span><!-- Has MathJax --></td>
</tr>
<tr>
<td></td>
<td></td>
<td>3</td>
<td>2</td>
<td><span>$c_1 = - I \cdot N$</span><!-- Has MathJax --></td>
</tr>
<tr>
<td>1</td>
<td></td>
<td>3</td>
<td>2</td>
<td><span>$c_2 = \sqrt{1 - \eta^2(1 - c_1^2)}$</span><!-- Has MathJax --></td>
</tr>
<tr>
<td></td>
<td></td>
<td>7</td>
<td>4</td>
<td><span>$T = \eta I + (\eta c_1 - c_2) N$</span><!-- Has MathJax --></td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>13</td>
<td>8</td>
<td>TOTAL</td>
</tr>
</tbody>
</table>
<h4 id="Other-Method"><a href="#Other-Method" class="headerlink" title="Other Method"></a>Other Method</h4><table>
<thead>
<tr>
<th><span>$\sqrt{}$</span><!-- Has MathJax --></th>
<th><span>$/$</span><!-- Has MathJax --></th>
<th><span>$\times$</span><!-- Has MathJax --></th>
<th><span>$+$</span><!-- Has MathJax --></th>
<th>compute</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>1</td>
<td></td>
<td></td>
<td><span>$n = \eta_2 / \eta_1$</span><!-- Has MathJax --></td>
</tr>
<tr>
<td></td>
<td></td>
<td>3</td>
<td>2</td>
<td><span>$c_1 = - I \cdot N$</span><!-- Has MathJax --></td>
</tr>
<tr>
<td>1</td>
<td></td>
<td>2</td>
<td>3</td>
<td><span>$\beta = c_1 \sqrt{n^2 - 1 + c_1^2}$</span><!-- Has MathJax --></td>
</tr>
<tr>
<td></td>
<td>3</td>
<td>3</td>
<td>3</td>
<td><span>$T = (I + \beta N ) / n$</span><!-- Has MathJax --></td>
</tr>
<tr>
<td>1</td>
<td>4</td>
<td>8</td>
<td>8</td>
<td>TOTAL</td>
</tr>
</tbody>
</table>
<p>其中以 Heckbert’s Method 消耗最少計算數。如果除法速度快於乘法，則使用 Other Method，原則上很少有機器運算除法比乘法快。</p>
<h3 id="RasterToCamera"><a href="#RasterToCamera" class="headerlink" title="RasterToCamera"></a>RasterToCamera</h3><p>這部分處理後得到 <code>Transform RasterToCamera</code>。若計算錯誤，會造成一片黑或者圖片顯示的大小問題。座標轉換處理細節可以參考實際的例子，如下圖所示：</p>
<p><img src="http://morris821028.github.io/hw-rendering/homework2/submission/images/cambasic1A.png" alt="http://www.scratchapixel.com/lessons/3d-basic-rendering/ray-tracing-generating-camera-rays/generating-camera-rays"></p>
<ul>
<li>Raster-To-NDC 轉換矩陣 <span>$A=\text{Scale}(scale, scale, 1)$</span><!-- Has MathJax -->，進行縮放。</li>
<li>NDC-To-Camera 轉換矩陣 <span>$B=\text{Translate}(Vector(0, 0, filedistance)) \times \text{Translate}(Vector(X, -Y, 0))$</span><!-- Has MathJax -->，進行位移。</li>
<li>最後得到 RasterToCamera 轉換矩陣 <span>$C= B \times A \times \text{Scale}(-1, 1, 1)$</span><!-- Has MathJax -->，最後將 x 軸顛倒以符合成像問題。</li>
</ul>
<h3 id="Ray-Weight"><a href="#Ray-Weight" class="headerlink" title="Ray Weight"></a>Ray Weight</h3><p>作業要求經過 <code>float GenerateRay()</code> 回傳 <span>$\mathrm{weight} = \frac{\cos^4 \theta&apos;}{Z^2}$</span><!-- Has MathJax -->，這麼設置會過暗，根據論文 A Realistic Camera Model for Computer Graphics 中寫道</p>
<blockquote>
<p>If the exit pupil subtends a small solid angle from <span>$x&apos;$</span><!-- Has MathJax -->, <span>$\theta&apos;$</span><!-- Has MathJax --> can be assumed to be constant and equal the angle between <span>$x&apos;$</span><!-- Has MathJax --> and the center of the disk. This allows us to simplify<br><span>$E(x&apos;) = \int_{x&apos;&apos; \in D} L(x&apos;&apos;, x&apos;) \frac{\cos \theta&apos; \cos \theta&apos;&apos;}{\| x&apos;&apos; - x&apos;\|} dA&apos;&apos;$&lt;span&gt;$to:$&lt;/span&gt;&lt;!-- Has MathJax --&gt;$E(x&rsquo;) = L \frac{A}{Z^2} \cos^4 \theta&rsquo;$</span><!-- Has MathJax --><br>where <span>$Z$</span><!-- Has MathJax --> is the axial distance from the film plane to the dist and <span>$A$</span><!-- Has MathJax --> is the area of the disk. </p>
</blockquote>
<p><img src="http://morris821028.github.io/hw-rendering/homework2/submission/images/paperfigure6.jpg" alt="A Realistic Camera Model for Computer Graphics: Figure 6"></p>
<p>因此需要額外乘上常數 <span>$A$</span><!-- Has MathJax -->，其中 <span>$A$</span><!-- Has MathJax --> 是最裡層的透鏡面積，因為我們是根據最裡層的透鏡面做均勻取樣，得到 <span>$A = \mathit{backLens.radius}^2 \pi$</span><!-- Has MathJax -->。</p>
<h3 id="Sampling"><a href="#Sampling" class="headerlink" title="Sampling"></a>Sampling</h3><p>單位圓均勻取樣方法有以下兩種，而非均勻取樣的寫法可參照 Sample 3 (錯誤的做法參照) 出來的效果看出。</p>
<h4 id="Sampling-1"><a href="#Sampling-1" class="headerlink" title="Sampling 1"></a>Sampling 1</h4><p>採用內建函數 <code>CencentricSampleDisk()</code>，採用 A Low Distortion Map Between Disk and Square 論文中提到的方案，將一個正方形壓縮到一個圓形中。參照作法如下圖所示  <img src="http://morris821028.github.io/hw-rendering/homework2/submission/images/pbrt_low_distortion.gif" alt=""></p>
<p>其中給定 <span>$a, b$</span><!-- Has MathJax --> 均勻分布 <span>$[0, 1]$</span><!-- Has MathJax -->，則得到 <span>$r = a, \; \phi = \frac{\pi}{4} \frac{b}{a}$</span><!-- Has MathJax -->，最後計算得到座標 <span>$x = r \cos \phi, \; y = r \sin \phi$</span><!-- Has MathJax -->。</p>
<h4 id="Sampling-2"><a href="#Sampling-2" class="headerlink" title="Sampling 2"></a>Sampling 2</h4><p>採用教科書上提供，其中給定 <span>$a, b$</span><!-- Has MathJax --> 均勻分布 <span>$[0, 1]$</span><!-- Has MathJax -->，令 <span>$r = \sqrt{a}, \; \phi = 2 \pi b$</span><!-- Has MathJax -->，最後計算得到座標 <span>$x = r \cos \phi, \; y = r \sin \phi$</span><!-- Has MathJax -->。</p>
<h4 id="Sampling-3"><a href="#Sampling-3" class="headerlink" title="Sampling 3"></a>Sampling 3</h4><p>分布 <span>$[0, 1]$</span><!-- Has MathJax -->，令 <span>$r = a, \; \phi = 2 \pi b$</span><!-- Has MathJax -->，最後計算得到座標 <span>$x = r \cos \phi, \; y = r \sin \phi$</span><!-- Has MathJax -->。這種寫法在相同半徑下，角度均勻分布，不同半徑下的周長與 <span>$r$</span><!-- Has MathJax --> 成正比，導致不同半徑的取樣點不均勻，越靠近中心點取樣越密集，意即容易造成中心點看起來較亮。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="http://blog.csdn.net/codeboycjy/article/details/6225886" target="_blank" rel="external">PBRT学习笔记：在单位圆内部均匀采样 -<br>codeboycjy的专栏</a></li>
</ul>
<h2>Final Images Rendered Compare 4 samples</h2>

<p></p><h4>Gauss Lens</h4><p></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0"><br>  <tr><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling1/dof-dragons.dgauss_4.jpg"><br>      <p><font><tt>My Implementation (Sampling 1)</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling2/dof-dragons.dgauss_4.jpg"><br>      <p><font><tt>My Implementation (Sampling 2)</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling3/dof-dragons.dgauss_4.jpg"><br>      <p><font><tt>My Implementation (Sampling 3)</tt></font></p><p><br>    </p></td><br>  </tr><br></table>

<p></p><h4>Fisheye Lens</h4><p></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0"><br>  <tr><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling1/dof-dragons.fisheye_4.jpg"><br>      <p><font><tt>My Implementation (Sampling 1)</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling2/dof-dragons.fisheye_4.jpg"><br>      <p><font><tt>My Implementation (Sampling 2)</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling3/dof-dragons.fisheye_4.jpg"><br>      <p><font><tt>My Implementation (Sampling 3)</tt></font></p><p><br>    </p></td><br>  </tr><br></table>

<p></p><h4>Telephoto Lens</h4><p></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0"><br>  <tr><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling1/dof-dragons.telephoto_4.jpg"><br>      <p><font><tt>My Implementation (Sampling 1)</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling2/dof-dragons.telephoto_4.jpg"><br>      <p><font><tt>My Implementation (Sampling 2)</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling3/dof-dragons.telephoto_4.jpg"><br>      <p><font><tt>My Implementation (Sampling 3)</tt></font></p><p><br>    </p></td><br>  </tr><br></table>


<p></p><h4>Wide-Angle Lens</h4><p></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0"><br>  <tr><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling1/dof-dragons.wide_4.jpg"><br>      <p><font><tt>My Implementation (Sampling 1)</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling2/dof-dragons.wide_4.jpg"><br>      <p><font><tt>My Implementation (Sampling 2)</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling3/dof-dragons.wide_4.jpg"><br>      <p><font><tt>My Implementation (Sampling 3)</tt></font></p><p><br>    </p></td><br>  </tr><br></table>

<h2>Final Images Rendered Compare 512 samples</h2>

<p></p><h4>Gauss Lens</h4><p></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0"><br>  <tr><br>     <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/ref/dof-dragons.dgauss_512ref.jpg"><br>         <p><font><tt>Reference</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling1/dof-dragons.dgauss_512.jpg"><br>        <p><font><tt>My Implementation (Sampling 1)</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling2/dof-dragons.dgauss_512.jpg"><br>      <p><font><tt>My Implementation (Sampling 2)</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling3/dof-dragons.dgauss_512.jpg"><br>      <p><font><tt>My Implementation (Sampling 3)</tt></font></p><p><br>    </p></td><br>  </tr><br></table>

<p></p><h4>Fisheye Lens</h4><p></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0"><br>  <tr><br>     <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/ref/dof-dragons.fisheye_512ref.jpg"><br>      <p><font><tt>Reference</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling1/dof-dragons.fisheye_512.jpg"><br>      <p><font><tt>My Implementation (Sampling 1)</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling2/dof-dragons.fisheye_512.jpg"><br>      <p><font><tt>My Implementation (Sampling 2)</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling3/dof-dragons.fisheye_512.jpg"><br>      <p><font><tt>My Implementation (Sampling 3)</tt></font></p><p><br>    </p></td><br>  </tr><br></table>

<p></p><h4>Telephoto Lens</h4><p></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0"><br>  <tr><br>     <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/ref/dof-dragons.telephoto_512ref.jpg"><br>      <p><font><tt>Reference</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling1/dof-dragons.telephoto_512.jpg"><br>      <p><font><tt>My Implementation (Sampling 1)</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling2/dof-dragons.telephoto_512.jpg"><br>      <p><font><tt>My Implementation (Sampling 2)</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling3/dof-dragons.telephoto_512.jpg"><br>      <p><font><tt>My Implementation (Sampling 3)</tt></font></p><p><br>    </p></td><br>  </tr><br></table>


<p></p><h4>Wide-Angle Lens</h4><p></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0"><br>  <tr><br>     <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/ref/dof-dragons.wide_512ref.jpg"><br>      <p><font><tt>Reference</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling1/dof-dragons.wide_512.jpg"><br>      <p><font><tt>My Implementation (Sampling 1)</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling2/dof-dragons.wide_512.jpg"><br>      <p><font><tt>My Implementation (Sampling 2)</tt></font></p><p><br>    </p></td><br>    <td width="25%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework2/submission/images/expr/sampling3/dof-dragons.wide_512.jpg"><br>      <p><font><tt>My Implementation (Sampling 3)</tt></font></p><p><br>    </p></td><br>  </tr><br></table>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-rendering-height-field" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/21/rendering-height-field/" class="article-date">
  <time datetime="2016-01-21T07:57:57.000Z" itemprop="datePublished">2016-01-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/21/rendering-height-field/">pbrt-v2 加速結構 Height Field 改寫</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/01/21/rendering-height-field/" data-id="ckxtxqsga00wogkvn46ngvd3k" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/01/21/rendering-height-field/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h3 id="前情提要-pbrt"><a href="#前情提要-pbrt" class="headerlink" title="前情提要 pbrt"></a>前情提要 pbrt</h3><p>一套數位影像生成軟體，盡可能以物理性質為基底打造的，目前已經到了 pbrt-v3。pbrt 主要的工作在於 modeling 後，可以在場景內放置以幾何描述的物體、光源、拍攝曝光 … 等設定，藉由模擬光線走訪得到呈現在螢幕上每一個 pixel 的顏色。</p>
<h3 id="目標工作"><a href="#目標工作" class="headerlink" title="目標工作"></a>目標工作</h3><p>Height Field 是一個高度場，測資中以山脈構造為主，等間隔取樣每一平面上的每一點高度的場景，當間隔越小越接近真實場景。原生寫法是將點放置在三維空間，轉換成一堆三角網格，將其丟入 KD-tree 或者是 BVH 等加速結構，加快光線模擬找交點 (三維空間中，一射線和一多面體的交點) 的效能。而現在挑戰用 3D-DDA 的方式進行交點查找。</p>
<p>實作採用 3D-DDA 算法降至 2D Grid 上進行交點測試。Uniform Grid 將會切割成 <span>$N \times M$</span><!-- Has MathJax --> 的格子，在 2D 平面上，先找到 ray 進入的格子點，接著使用增量算法找到下一個格子，算法只測試投影到 x-y 平面上時，在 ray 鄰近的格子點做交點測試，時間複雜度 <span>$O(\sqrt{N \times M})$</span><!-- Has MathJax -->，與預設的其他算法所需要的 traversal 複雜度差不多。</p>
<p>原本預設的 Height Field 拆成好幾個 Triangle，做法類似 Triangle Mesh，接著將這幾個 Triangle 利用 BVH 或者是 KD-tree 的架構進行，原本的做法會考慮三個維度，使用投影的方式只考慮兩個維度下的情況，接著再針對有相交的格子測試，最後才進行 3D Triangle 是否與 ray 相交。</p>
<p>實作 Height Field 時，考慮快取和再計算之間的好壞，則有兩種方法</p>
<ol>
<li>預先將預處理每個 3D Triangle 座標 (消耗空間)</li>
<li>需要時，再創建 Triangle 出來測試 (消耗時間)</li>
</ol>
<p>由於要找 ray 碰度到 uniform grid 的第一個格子，需要預處理 Height Field Bound Box，計算 Bound Box 需要 <span>$O(N \times M)$</span><!-- Has MathJax -->，若不預處理會造成 3D-DDA 與暴力法 <span>$O(N \times M)$</span><!-- Has MathJax --> 無異。</p>
<p>若對 Height Field 進行 2D-DDA 好處在於一定是數個三角形構成，因此不用等到 <code>ray.maxT</code> 小於下一格交點的 <code>NextCrossingT[stepAxis]</code> 才能結束，一與三角形有交點就可以離開，因為每一格之間都有獨立性。</p>
<h4 id="實作與測試細節"><a href="#實作與測試細節" class="headerlink" title="實作與測試細節"></a>實作與測試細節</h4><h4 id="測試環境"><a href="#測試環境" class="headerlink" title="測試環境"></a>測試環境</h4><p>一開始為了熟悉 pbrt 架構環境只實作求出交點的函數，</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> Heightfield2::Intersect(<span class="keyword">const</span> Ray &amp;r, <span class="keyword">float</span> *tHit, <span class="keyword">float</span> *rayEpsilon,</div><div class="line">        DifferentialGeometry *dg) <span class="keyword">const</span> &#123;</div><div class="line">    <span class="comment">// 3D DDA</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而直接忽略單純詢問交點是否存在，這會導致畫面一片黑，因為每打到一個交點會嘗試從物體表面的交點連到點光源。若下述函數恆真，則不存在光源到交點的路徑，因此產出來的圖片是一片黑。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> Heightfield2::IntersectP(<span class="keyword">const</span> Ray &amp;r) <span class="keyword">const</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="紋理模糊"><a href="#紋理模糊" class="headerlink" title="紋理模糊"></a>紋理模糊</h4><p>找出紋理的兩個參數 <span>$(u, v)$</span><!-- Has MathJax --> 時，從 <code>trianglemesh.cpp</code> 複製過來的 <code>class Triangle</code> 其 <code>bool Triangle::Intersect()</code> 函數得到的 <span>$u, v$</span><!-- Has MathJax --> 都是相對於三角形的 <span>$0 \le u, v \le 1$</span><!-- Has MathJax --> (直接 rendering 會看起來很多小格子點)，因此得到相對的 <span>$u, v$</span><!-- Has MathJax --> 和交點 <span>$p_{hit}$</span><!-- Has MathJax --> (Object coordinate)，則把 <span>$p_{hit}$</span><!-- Has MathJax --> 再次投影到 x-y 平面上，由於 height field 在 x-y 平面上長寬都是 1，投影到平面後得到 <span>$p_{projection}$</span><!-- Has MathJax -->，對於整個 height field <span>$u = p_{projection}.x, \; v = p_{projection}.y$</span><!-- Has MathJax -->。</p>
<blockquote>
<p>若測試 texture.pbrt 時，發生過模糊情況，其主要原因在於過多次座標轉換，如 <code>Object -&gt; World -&gt; Object -&gt; World</code>，求出來的 <span>$u, v$</span><!-- Has MathJax --> 誤差就會放大。</p>
</blockquote>
<p>將 height field 存成好幾個 triangle 可以像 <code>class TriangleMesh</code> 利用 <code>index</code> 標籤來壓縮記憶體，但實作為方便仍然每一個三角形都有實體的 <code>Point</code>，儲存三角形每一個點座標採用 object coordinate，先把 <span>$ray$</span><!-- Has MathJax --> 從 <code>WorldToObject</code> 得到 <span>$ray&apos;$</span><!-- Has MathJax -->，得到的交點 <span>$p_{hit}$</span><!-- Has MathJax --> 再進行 <code>ObjectToWorld</code>，如此一來模糊情況就會消失。</p>
<h4 id="Phong-圓滑化"><a href="#Phong-圓滑化" class="headerlink" title="Phong 圓滑化"></a>Phong 圓滑化</h4><p>Phong interpolation 方法在三角形上面操作時，需要得知三個頂點的法向量，給予 height field 的資訊，並不曉得每一個頂點的法向量為何。得到每一個頂點的法向量，採用預先處理所有頂點的法向量並儲存起來，因為不斷地正規化是很耗時間的 (<code>float sqrt(float x)</code> 儘管採用 fast inverse square root 算法，也要極力避免多餘的運算)。</p>
<p>再計算頂點法向量時，根據影像處理中常用的一次差分 (differentiation) 遮罩</p>
<p><img src="http://morris821028.github.io/hw-rendering/homework1/submission/images/hftest_1.png" alt=""></p>
<p><img src="http://morris821028.github.io/hw-rendering/homework1/submission/images/hftest_2.png" alt=""></p>
<h5 id="Case-1-邊緣"><a href="#Case-1-邊緣" class="headerlink" title="Case 1 邊緣"></a>Case 1 邊緣</h5><span>$$N_x = \begin{bmatrix}
0 &amp; 0 &amp; 0 \\
-1 &amp; 1 &amp; 0 \\
0 &amp; 0 &amp; 0 \\
\end{bmatrix}, \;
N_y = \begin{bmatrix}
0 &amp; 0 &amp; 0 \\
0 &amp; 1 &amp; 0 \\
0 &amp; -1 &amp; 0 \\
\end{bmatrix}$$</span><!-- Has MathJax -->
<h5 id="Case-2-非邊緣"><a href="#Case-2-非邊緣" class="headerlink" title="Case 2 非邊緣"></a>Case 2 非邊緣</h5><span>$$N_x = \begin{bmatrix}
0 &amp; 0 &amp; 0 \\
-1 &amp; 0 &amp; 1 \\
0 &amp; 0 &amp; 0 \\
\end{bmatrix}, \;
N_y = \begin{bmatrix}
0 &amp; 1 &amp; 0 \\
0 &amp; 0 &amp; 0 \\
0 &amp; -1 &amp; 0 \\
\end{bmatrix}$$</span><!-- Has MathJax -->
<p>上圖矩陣的中心座標為 <span>$(x, y)$</span><!-- Has MathJax -->，將相鄰座標的高度值 <span>$z$</span><!-- Has MathJax --> 相減得到兩個方向的向量 <span>$N_x, \; N_y$</span><!-- Has MathJax -->，外積得到座標 <span>$(x, y)$</span><!-- Has MathJax --> 的法向量 <span>$N_{x, y} = \mathrm{Cross}(N_x, N_y)$</span><!-- Has MathJax -->。</p>
<p>從另一個角度來看，將 height field 三角化後，每一個頂點原則上有 6 個鄰居，可以對每一個鄰居進行差分，接著順時針或者逆時針將兩兩相臨的向量外積，得到 6 個法向量平均後得到 <span>$N_{x, y}$</span><!-- Has MathJax -->，這做法看起來比上述的差分來得穩定，但初始化消耗的時間會比較長，且撰寫的外積順序不對容易造成零向量的正規化錯誤。</p>
<p><img src="http://morris821028.github.io/hw-rendering/homework1/submission/images/phong_interpolation_1.png" alt=""></p>
<p><img src="http://morris821028.github.io/hw-rendering/homework1/submission/images/phong_interpolation_2.png" alt=""></p>
<p></p><h3>Final Images Rendered with my implementation of heightfield.cpp</h3><p></p>
<p></p><p>&nbsp;</p>
<table border="0" width="100%" cellspacing="0" cellpadding="0"><br>  <tr><br>     <td width="50%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework1/submission/images/3ddda/hftest_2.jpg" width="400" height="400"><br>      <p><font><tt>hftest.pbrt </tt> (without Phong<br>      interpolation)</font><br>      </p><p><font>Timings:</font><br>      <ul><br>        <li><font>Original: 0.125 seconds</font></li><br>        <li><font>My implementation: 0.130 seconds (104% original)</font></li><br>      </ul><br>    </p></td><br>    <td width="50%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework1/submission/images/3ddda/landsea-0_2.jpg" width="400" height="400"><br>      <p><font><tt>landsea-0.pbrt </tt> (without Phong<br>      interpolation)</font><br>      </p><p><font>Timings:</font><br>      <ul><br>        <li><font>Original: 0.815 seconds</font></li><br>        <li><font>My implementation: 1.050 seconds (128% original)</font></li><br>      </ul><br>    </p></td><br>  </tr><br>  <tr><br>    <td width="50%"></td><br>    <td width="50%"></td><br>  </tr><br>  <tr><br>    <td width="50%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework1/submission/images/3ddda/landsea-1_2.jpg" width="400" height="400"><br>      <p><font><tt>landsea-1.pbrt </tt> <tt> </tt> (without Phong<br>      interpolation)</font><br>      </p><p><font>Timings:</font><br>      <ul><br>        <li><font>Original: 0.850 seconds</font></li><br>        <li><font>My implementation: 1.020 seconds (120% original)</font></li><br>      </ul><br>    </p></td><br>    <td width="50%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework1/submission/images/3ddda/landsea-2_2.jpg" width="400" height="400"><br>      <p><font><tt>landsea-2.pbrt </tt> <tt> </tt> (without Phong<br>      interpolation)</font><br>      </p><p><font>Timings:</font><br>      <ul><br>        <li><font>Original: 0.780 seconds</font></li><br>        <li><font>My implementation: 0.870 seconds (115% original)</font></li><br>      </ul><br>    </p></td><br>  </tr><br>  <tr><br>    <td width="50%"></td><br>    <td width="50%"></td><br>  </tr><br>  <tr><br>    <td width="50%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework1/submission/images/3ddda/texture_2.jpg" width="400" height="400"><br>      <p><font><tt>texture.pbrt </tt> (without Phong<br>      interpolation)</font><br>      </p><p><font>Timings:</font><br>      <ul><br>        <li><font>Original: 0.450 seconds</font></li><br>        <li><font>My implementation: 0.520 seconds (120% original)</font></li><br>      </ul><br>    </p></td><br>    <td width="50%"><br>    </td><br>  </tr><br>  <tr><br>    <td width="50%"></td><br>    <td width="50%"></td><br>  </tr><br>  <tr><br>    <td width="100%" colspan="2"><br>     <img border="0" src="http://morris821028.github.io/hw-rendering/homework1/submission/images/3ddda/landsea-big_2.jpg" width="600" height="600"><br>      <p><font><tt>landsea-big.pbrt </tt> (without Phong<br>            interpolation)</font></p><br>            <p><font>Timings:</font><br>      <ul><br>        <li><font>Original: 6.200 seconds</font></li><br>        <li><font>My implementation: 2.200 seconds (35% original)</font></li><br>      </ul><br>    </p></td><br>  </tr><br></table>

<p></p><h3>Final Images Rendered with my implementation of heightfield.cpp</h3><p></p>
<p></p><p>&nbsp;</p>
<table border="0" width="100%" cellspacing="0" cellpadding="0"><br>  <tr><br>     <td width="50%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework1/submission/images/phong/hftest_2.jpg" width="400" height="400"><br>      <p><font><tt>hftest.pbrt </tt> (with Phong<br>      interpolation)</font><br>      </p><p><font>Timings:</font><br>      <ul><br>        <li><font>My implementation: 0.135 seconds</font></li><br>      </ul><br>    </p></td><br>    <td width="50%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework1/submission/images/phong/landsea-0_2.jpg" width="400" height="400"><br>      <p><font><tt>landsea-0.pbrt </tt> (with Phong<br>      interpolation)</font><br>      </p><p><font>Timings:</font><br>      <ul><br>        <li><font>My implementation: 1.100 seconds</font></li><br>      </ul><br>    </p></td><br>  </tr><br>  <tr><br>    <td width="50%"></td><br>    <td width="50%"></td><br>  </tr><br>  <tr><br>    <td width="50%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework1/submission/images/phong/landsea-1_2.jpg" width="400" height="400"><br>      <p><font><tt>landsea-1.pbrt </tt> <tt> </tt> (with Phong<br>      interpolation)</font><br>      </p><p><font>Timings:</font><br>      <ul><br>        <li><font>My implementation: 1.050 seconds</font></li><br>      </ul><br>    </p></td><br>    <td width="50%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework1/submission/images/phong/landsea-2_2.jpg" width="400" height="400"><br>      <p><font><tt>landsea-2.pbrt </tt> <tt> </tt> (with Phong<br>      interpolation)</font><br>      </p><p><font>Timings:</font><br>      <ul><br>        <li><font>My implementation: 0.900 seconds</font></li><br>      </ul><br>    </p></td><br>  </tr><br>  <tr><br>    <td width="50%"></td><br>    <td width="50%"></td><br>  </tr><br>  <tr><br>    <td width="50%"><img border="0" src="http://morris821028.github.io/hw-rendering/homework1/submission/images/phong/texture_2.jpg" width="400" height="400"><br>      <p><font><tt>texture.pbrt </tt> (with Phong<br>      interpolation)</font><br>      </p><p><font>Timings:</font><br>      <ul><br>        <li><font>My implementation: 0.530 seconds</font></li><br>      </ul><br>    </p></td><br>    <td width="50%"><br>    </td><br>  </tr><br>  <tr><br>    <td width="50%"></td><br>    <td width="50%"></td><br>  </tr><br>  <tr><br>    <td width="100%" colspan="2"><br>     <img border="0" src="http://morris821028.github.io/hw-rendering/homework1/submission/images/phong/landsea-big_2.jpg" width="600" height="600"><br>    <p><font><tt>landsea-big.pbrt </tt> (with Phong interpolation)</font></p><br>          <p><font>Timings:</font><br>    <ul><br>      <li><font>My implementation: 2.300 seconds</font></li><br>    </ul><br>    </p></td><br>  </tr><br></table>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
  
</section>
          
          
            <aside id="sidebar">
  <!-- <div id="ukagaka_panel"></div> -->
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/">學校課程</a><span class="category-list-count">115</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/介面設計/">介面設計</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/作業系統/">作業系統</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/即時系統/">即時系統</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/大學專題/">大學專題</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/巨量資料/">巨量資料</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/平行程式/">平行程式</a><span class="category-list-count">43</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/敏捷方法/">敏捷方法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/編譯器/">編譯器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/自然語言/">自然語言</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/虛擬實境/">虛擬實境</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算型智慧/">計算型智慧</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算幾何/">計算幾何</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算機圖學/">計算機圖學</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資料庫系統/">資料庫系統</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資訊安全/">資訊安全</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/通識課程/">通識課程</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/">工作應用</a><span class="category-list-count">38</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Java/">Java</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Meme/">Meme</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/其他/">其他</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/可持久化/">可持久化</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/鬼故事/">鬼故事</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/手札日記/">手札日記</a><span class="category-list-count">54</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/">網頁設計</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/About-This-Blog/">About This Blog</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/HTML5/">HTML5</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/JQuery/">JQuery</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/Markdown/">Markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/NodeJs/">NodeJs</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/">解題區</a><span class="category-list-count">633</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/Latex/">Latex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/出題解題/">出題解題</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-POJ/">解題區 - POJ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a><span class="category-list-count">483</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a><span class="category-list-count">77</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-未解題目/">解題區 - 未解題目</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/雜言筆記/">雜言筆記</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a class="text" href="/2021/12/31/diary-20211231-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·陸》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/12/26/diary-20211226-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·伍》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/11/21/diary-20211121-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·肆》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/11/12/diary-20211112-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·參》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/31/diary-20211031-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·貳》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/28/diary-202110-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·序》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/28/diary-202110/">
              
                <i class="icon-file-o"></i> 
              
            好多個 28 在這個時刻</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/28/work/company-ghost-story-14/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 14</a>
          </li>
        
          <li>
            <a class="text" href="/2021/09/12/work/appreciation-letter/">
              
                <i class="icon-file-o"></i> 
              
            Shiny People 感謝</a>
          </li>
        
          <li>
            <a class="text" href="/2021/09/12/work/company-ghost-story-13/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 13</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">   
        <ul>
          <li><a href="http://mypaper.pchome.com.tw/zerojudge" target="_blank" title="Old Blog"><i class="icon-star"></i> Morris' Blog (pchome)</a></li>
        </ul>
    </div>
</div>

  
    
<script src="/js/jquery-ui.js"></script>
<script src="/js/ukagaka/jquery.morris.ukagaka.resource.js"></script>
<script src="/js/ukagaka/typed.js"></script>
  
  
</aside>
          
        
      </div>
      <footer id="footer">
  
  <div class="outer">    
    <div class="social-group">
      
      <a href="https://github.com/morris821028" target="_blank" title="github"><i class="icon-github"></i></a>
      
      
      <a href="https://www.facebook.com/Morris1028" target="_blank" title="facebook"><i class="icon-facebook-sign"></i></a>
      
      
      <a href="http://uhunt.felix-halim.net/id/46705" target="_blank" title="uhunt" ><span class="icon-uhunt">UVa<span></a>
      
    </div>
    <div id="footer-info" class="inner">
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/morris821028/hexo-theme-landscape" target="_blank" title="landscape">landscape</a> &copy; 2021 Shiang-Yun Yang 
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link"><i class=icon-home ></i>&nbsp&nbspHome</a>
  
    <a href="/about" class="mobile-nav-link"><i class=icon-user ></i>&nbsp&nbspAbout</a>
  
    <a href="/archives" class="mobile-nav-link"><i class=icon-archive ></i>&nbsp&nbspArchives</a>
  
    <a href="/tags" class="mobile-nav-link"><i class=icon-tags ></i>&nbsp&nbspTags</a>
  
    <a href="/picture" class="mobile-nav-link"><i class=icon-camera ></i>&nbsp&nbspPictures</a>
  
    <a href="/works" class="mobile-nav-link"><i class=icon-trophy ></i>&nbsp&nbspWorks</a>
  
</nav>
    
<script>
  var disqus_shortname = 'morris1028';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/jquery.lazyload.js"></script>
<script src="/js/jquery.als-1.6.js"></script>

<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>