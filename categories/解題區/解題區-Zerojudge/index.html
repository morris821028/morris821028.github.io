<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Category: 解題區 - Zerojudge | Morris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Morris&#39; Blog">
<meta property="og:url" content="http://morris821028.github.io/categories/解題區/解題區-Zerojudge/index.html">
<meta property="og:site_name" content="Morris&#39; Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Morris&#39; Blog">
<link rel="publisher" href="108158678174364350000">
  
    <link rel="alternative" href="/atom.xml" title="Morris&#39; Blog" type="application/atom+xml">
  
  
    <meta name="google-site-verification" content="5mRgj8NanEMpGZuNfHNJNmH90RgNlrnJXsFlTaKD6Gs" />
  
  
    <link rel="shortcut icon" href="/img/f.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script src="/js/jquery-2.1.0.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.5.1.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdn.oesmith.co.uk/morris-0.5.1.min.js"></script>
  <link rel="import" href="/bower_components/app-layout/app-layout.html"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"><div id="banner-right"></div></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Morris&#39; Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class=icon-home title='Home'></i></a>
          
        
          
            <a class="main-nav-link" href="/about"><i class=icon-user title='About'></i></a>
          
        
          
            <a class="main-nav-link" href="/archives"><i class=icon-archive title='Archives'></i></a>
          
        
          
            <a class="main-nav-link" href="/tags"><i class=icon-tags title='Tags'></i></a>
          
        
          
            <a class="main-nav-link" href="/picture"><i class=icon-camera title='Pictures'></i></a>
          
        
          
            <a class="main-nav-link" href="/works"><i class=icon-trophy title='Works'></i></a>
          
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://morris821028.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        
          
          <section id="main">
  
    <article id="post-zj-e021" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/16/zj-e021/" class="article-date">
  <time datetime="2019-02-16T01:11:22.000Z" itemprop="datePublished">2019-02-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/16/zj-e021/">動態幾何 史蒂芙的泡泡 (解法 2)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2019/02/16/zj-e021/" data-id="ckpaivcfo00njn8vngd73d3xs" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2019/02/16/zj-e021/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pbds/">pbds</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rope/">rope</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h2><p>在處理完數以百計的政事後，受盡折磨的史蒂芙，打算回家好好地休息。 拖著疲倦的身軀，再也無法再容納任何一點複雜計算。從王宮走回寢居的路上， 發現身邊所見的事物都不再圓滑，看起來就像是粗糙的幾何多邊形構成的一切。</p>
<p>打算享受著泡泡浴的史蒂芙，看著眼前的多邊形泡泡，失去原本應有的色澤，那透涼的心境更蒙上了一層灰影</p>
<p>「為什麼是我呢？」感嘆道</p>
<p>伸出手戳著眼前的泡泡，卻飄了過去</p>
<p>「區區的泡泡也跟我作對，嗚嗚」</p>
<p>將一個泡泡視為一個簡單多邊形 <span>$A$</span><!-- Has MathJax -->，方便起見用一個序列 <span>$a_0, a_1, ..., a_{n-1}$</span><!-- Has MathJax --> 表示多邊形 <span>$A$</span><!-- Has MathJax --> 的每一個頂點，則會有 <span>$n$</span><!-- Has MathJax --> 個線段 <span>$\overline{a_0 a_1}, \overline{a_1 a_2}, \cdots, \overline{a_{n-1} a_0}$</span><!-- Has MathJax -->。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">5 14</span><br><span class="line"></span><br><span class="line">0 0</span><br><span class="line">10 0 </span><br><span class="line">10 10</span><br><span class="line">0 10</span><br><span class="line">5 5</span><br><span class="line"></span><br><span class="line">1 0 0</span><br><span class="line">1 1 0</span><br><span class="line">1 2 1</span><br><span class="line">1 3 2</span><br><span class="line">3 5.5 5</span><br><span class="line">3 10 -1</span><br><span class="line">3 10 5</span><br><span class="line">1 4 1</span><br><span class="line">3 5.5 5</span><br><span class="line">3 10 -1</span><br><span class="line">3 10 5</span><br><span class="line">2 3</span><br><span class="line">3 5 7.5</span><br><span class="line">3 5 2.5</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>參閱 <a href="/2019/01/26/mproblem-dynamic-point-in-polygon/" title="動態幾何 史蒂芙的泡泡  (解法 1)">動態幾何 史蒂芙的泡泡  (解法 1)</a></p>
<p>相較於先前的解法 <span>$\mathcal{O}(\log n) - \mathcal{O}(\ast \sqrt{n})$</span><!-- Has MathJax -->，相當不穩定的嵌套 KD-BRH 的解法，實際上如果單純針對這一題，可以拋開 region search 的操作，只有完全的詢問點是否在多邊形內部，則可以做到 <span>$\mathcal{O}(\log^2 n)$</span><!-- Has MathJax -->。</p>
<p>如同一般的射線法，對詢問點拉出無限延長的線，找到與多邊形的邊相交個數。如果單純把每一條邊拿出來看，最暴力的複雜度為 <span>$\mathcal{O}(n)$</span><!-- Has MathJax -->，現在要減少查閱的邊數，且透過 rank tree 在 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax --> 累計相交數量。</p>
<p>由於給定的座標不需要動態，則著手離散化 <span>$X = x_0, x_1, \cdots, x_n$</span><!-- Has MathJax -->，線段樹中的每一個點 <span>$u$</span><!-- Has MathJax --> 維護一個 rank tree，把包含者個區段 <span>$[x_l, x_r]$</span><!-- Has MathJax --> 的線段通通放入，且保證放入的線段彼此之間不相交 (除了兩端點)。如此一來，當詢問一個點，需要探訪 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax --> 個節點，每個節點 <span>$u$</span><!-- Has MathJax --> 需要 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax --> 時間來計算相交數量，最後詢問的複雜度為 <span>$\mathcal{O}(\log^2 n)$</span><!-- Has MathJax -->。同理，修改點的操作也會在 <span>$\mathcal{O}(\log^2 n)$</span><!-- Has MathJax -->。</p>
<p>實作時，特別注意到與射線方向相同的線段不予處理，按照下面的寫法則是不處理垂直的線段，一來是射線法也不會去計算，二來是線段樹劃分的時候會造成一些邊界問題，由於我們對於點離散，父節點 <span>$[x_l, x_r]$</span><!-- Has MathJax -->，左右子樹控制的分別為 <span>$[x_l, x_\text{mid}]$</span><!-- Has MathJax -->、<span>$[x_\text{mid}, x_r]$</span><!-- Has MathJax -->，劃分時會共用中間點。</p>
<p>即使有了上述的概念來解題，我們仍需要維護 <a href="https://en.wikipedia.org/wiki/Rope_(data_structure">rope data structrue</a> 來維護節點的相鄰關係，可以自己實作任何的 binary tree 來達到 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax -->，這裡採用 splay tree 示範。</p>
<hr>
<p>接下來介紹內建黑魔法 PBDS (policy-based data structure) 和 rope。很多人都提及到這些非正式的 STL 函式庫，只有在 gcc/g++ 裡面才有附錄，如果是 clang 等其他編譯器可能是沒有辦法的。所以上傳相關代碼要看 OJ 是否採用純正的 gcc/g++。</p>
<p>參考資料：</p>
<ul>
<li><a href="https://codeforces.com/blog/entry/11080">C++ STL: Policy based data structures - Codeforces</a></li>
<li><a href="https://www.luogu.org/blog/Chanis/gnu-pbds">比STL还STL？——平板电视</a></li>
<li><a href="http://www.martinbroadhurst.com/stl/Rope.html">C++ STL: SGI rope</a></li>
</ul>
<p>PBDS 比較常用在 rank tree 和 heap，由於代碼量非常多，用內建防止 code length exceed limitation 的出現，也不妨是個好辦法。用 rank tree 的每一個詢問操作皆在 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax -->，而 heap 選擇 thin heap 或 pairing heap，除了 pop 操作外，皆為 <span>$\mathcal{O}(1)$</span><!-- Has MathJax -->，在對最短路徑問題上別有優勢。</p>
<p>而這一題不太適用 SGI rope，原因在於雖為 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax --> 操作，但它原本就為了仿作 string 而強迫變成可持久化的引數結構，導致每一個操作需要額外的開銷來減少內存使用。由於此題經常在單一元素上操作，SGI rope 對於單一元素效能不彰，以造成嚴重的逾時。</p>
<p>這裡仍提及和示範這些概念的資料結構，哪天正式編入標準函式庫，想必效能問題都已解決。</p>
<hr>
<ul>
<li>KD BRH AC(0.2s, 10 MB)</li>
<li>PBDS + SPLAY AC(0.3s, 38 MB)</li>
<li>PBDS + SGI rope AC(0.5s, 41 MB)<br>本機 MINGW gcc 4.9 c++ 11 編譯完運行最大的測資需要 20 倍慢於其他寫法，但是上傳到 ZJ 的 gcc 7 又追回去了。於是下載 CYGWIN gcc 7 測試結果與 ZJ 運行結果相當，對於需要調適的人，建議在新版上測試。</li>
</ul>
<p>用 splay tree 模擬 rope 的時候，會遇到循序非遞減的走訪，這時候若不斷地旋轉至根，會在之後的操作造成退化，常數稍微大一點，雖然在迭代過程中造就好的快取效能，很快地在 <span>$\mathcal{O}(1)$</span><!-- Has MathJax --> 訪問到相鄰的節點，卻在下一次的插入/刪除操作中變慢。一些變異的版本中，如只在插入/刪除操作中旋轉至根，在查找操作中不旋轉，或者限制旋轉的深度。雖然有一些特別的退化操作，splay 仍舊是某些 OS 場景中使用的資料結構，現實總是很特別的。</p>
<blockquote><p>In 2000, Danny Sleator and Robert Tarjan won the ACM Kanellakis Theory and Practice Award for their papers on splay trees and amortized analysis.  Splay trees are used in Windows NT (in the virtual memory, networking, and file system code), the gcc compiler and GNU C++ library, the sed string editor, Fore Systems network routers, the most popular implementation of Unix malloc, Linux loadable kernel modules, and in much other software.</p>
<footer><strong>Berkeley eecs April 23, 2014</strong><cite><a href="https://people.eecs.berkeley.edu/~jrs/61b/lec/36">people.eecs.berkeley.edu/~jrs/61b/lec/36</a></cite></footer></blockquote>

<h3 id="PBDS-SPLAY"><a href="#PBDS-SPLAY" class="headerlink" title="PBDS + SPLAY"></a>PBDS + SPLAY</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ext/pb_ds/assoc_container.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ext/pb_ds/tree_policy.hpp&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> __gnu_pbds;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Mesh</span> &#123;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1e5</span> + <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">int</span> pt[MAXN][<span class="number">2</span>];</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; X;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;pt[i][<span class="number">0</span>], &amp;pt[i][<span class="number">1</span>]);</span><br><span class="line">        X.<span class="built_in">clear</span>(); X.<span class="built_in">reserve</span>(n);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            X.<span class="built_in">push_back</span>(pt[i][<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">sort</span>(X.<span class="built_in">begin</span>(), X.<span class="built_in">end</span>());</span><br><span class="line">        X.<span class="built_in">erase</span>(<span class="built_in">unique</span>(X.<span class="built_in">begin</span>(), X.<span class="built_in">end</span>()), X.<span class="built_in">end</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125; mesh;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplayTree</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        Node *ch[<span class="number">2</span>], *fa;</span><br><span class="line">        <span class="keyword">int</span> size; <span class="keyword">int</span> data;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;</span><br><span class="line">            ch[<span class="number">0</span>] = ch[<span class="number">1</span>] = fa = <span class="literal">NULL</span>;</span><br><span class="line">            size = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">is_root</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> fa-&gt;ch[<span class="number">0</span>] != <span class="keyword">this</span> &amp;&amp; fa-&gt;ch[<span class="number">1</span>] != <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    Node *root, *EMPTY;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">(Node *u)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u-&gt;ch[<span class="number">0</span>] != EMPTY)	<span class="built_in">pushdown</span>(u-&gt;ch[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (u-&gt;ch[<span class="number">1</span>] != EMPTY)	<span class="built_in">pushdown</span>(u-&gt;ch[<span class="number">1</span>]);</span><br><span class="line">        u-&gt;size = <span class="number">1</span> + u-&gt;ch[<span class="number">0</span>]-&gt;size + u-&gt;ch[<span class="number">1</span>]-&gt;size;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setch</span><span class="params">(Node *p, Node *u, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (p != EMPTY)	p-&gt;ch[i] = u;</span><br><span class="line">        <span class="keyword">if</span> (u != EMPTY)	u-&gt;fa = p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">SplayTree</span>() &#123;</span><br><span class="line">        EMPTY = <span class="keyword">new</span> <span class="built_in">Node</span>();</span><br><span class="line">        EMPTY-&gt;fa = EMPTY-&gt;ch[<span class="number">0</span>] = EMPTY-&gt;ch[<span class="number">1</span>] = EMPTY;</span><br><span class="line">        EMPTY-&gt;size = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        root = EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node *u = <span class="keyword">new</span> <span class="built_in">Node</span>();</span><br><span class="line">        u-&gt;fa = u-&gt;ch[<span class="number">0</span>] = u-&gt;ch[<span class="number">1</span>] = EMPTY;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rotate</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        Node *y;</span><br><span class="line">        <span class="keyword">int</span> d;</span><br><span class="line">        y = x-&gt;fa, d = y-&gt;ch[<span class="number">1</span>] == x ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        x-&gt;ch[d^<span class="number">1</span>]-&gt;fa = y, y-&gt;ch[d] = x-&gt;ch[d^<span class="number">1</span>];</span><br><span class="line">        x-&gt;ch[d^<span class="number">1</span>] = y;</span><br><span class="line">        <span class="keyword">if</span> (!y-&gt;<span class="built_in">is_root</span>())</span><br><span class="line">            y-&gt;fa-&gt;ch[y-&gt;fa-&gt;ch[<span class="number">1</span>] == y] = x;</span><br><span class="line">        x-&gt;fa = y-&gt;fa, y-&gt;fa = x;</span><br><span class="line">        <span class="built_in">pushup</span>(y);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deal</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!x-&gt;<span class="built_in">is_root</span>())	<span class="built_in">deal</span>(x-&gt;fa);</span><br><span class="line">        <span class="built_in">pushdown</span>(x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">(Node *x, Node *below)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x == EMPTY)	<span class="keyword">return</span> ;</span><br><span class="line">        Node *y, *z;</span><br><span class="line">        <span class="built_in">deal</span>(x);</span><br><span class="line">        <span class="keyword">while</span> (!x-&gt;<span class="built_in">is_root</span>() &amp;&amp; x-&gt;fa != below) &#123;</span><br><span class="line">            y = x-&gt;fa, z = y-&gt;fa;</span><br><span class="line">            <span class="keyword">if</span> (!y-&gt;<span class="built_in">is_root</span>() &amp;&amp; y-&gt;fa != below) &#123;</span><br><span class="line">                <span class="keyword">if</span> (y-&gt;ch[<span class="number">0</span>] == x ^ z-&gt;ch[<span class="number">0</span>] == y)</span><br><span class="line">                    <span class="built_in">rotate</span>(x);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">rotate</span>(y);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">rotate</span>(x);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">pushup</span>(x);</span><br><span class="line">        <span class="keyword">if</span> (x-&gt;fa == EMPTY)	root = x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">prevNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">splay</span>(u, EMPTY);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">maxNode</span>(u-&gt;ch[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">nextNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">splay</span>(u, EMPTY);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">minNode</span>(u-&gt;ch[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">minNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        Node *p = u-&gt;fa;</span><br><span class="line">        <span class="keyword">for</span> (; <span class="built_in">pushdown</span>(u), u-&gt;ch[<span class="number">0</span>] != EMPTY; u = u-&gt;ch[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">splay</span>(u, p);</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">maxNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        Node *p = u-&gt;fa;</span><br><span class="line">        <span class="keyword">for</span> (; <span class="built_in">pushdown</span>(u), u-&gt;ch[<span class="number">1</span>] != EMPTY; u = u-&gt;ch[<span class="number">1</span>]);</span><br><span class="line">        <span class="built_in">splay</span>(u, p);</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">findPos</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123; <span class="comment">// [0...]</span></span><br><span class="line">        <span class="keyword">for</span> (Node *u = root; u != EMPTY;) &#123;</span><br><span class="line">            <span class="built_in">pushdown</span>(u);</span><br><span class="line">            <span class="keyword">int</span> t = u-&gt;ch[<span class="number">0</span>]-&gt;size;</span><br><span class="line">            <span class="keyword">if</span> (t == pos) &#123;</span><br><span class="line">                <span class="built_in">splay</span>(u, EMPTY);</span><br><span class="line">                <span class="keyword">return</span> u;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (t &gt; pos)</span><br><span class="line">                u = u-&gt;ch[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                u = u-&gt;ch[<span class="number">1</span>], pos -= t + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; <span class="title">insert</span><span class="params">(<span class="keyword">int</span> data, <span class="keyword">int</span> pos)</span> </span>&#123;	<span class="comment">// make [pos] = data</span></span><br><span class="line">        Node *p, *q = <span class="built_in">findPos</span>(pos);</span><br><span class="line">        Node *x = <span class="built_in">newNode</span>(); x-&gt;data = data;</span><br><span class="line">        <span class="keyword">if</span> (q == EMPTY) &#123;</span><br><span class="line">            p = <span class="built_in">maxNode</span>(root), <span class="built_in">splay</span>(p, EMPTY);</span><br><span class="line">            <span class="built_in">setch</span>(x, p, <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">splay</span>(x, EMPTY);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">splay</span>(q, EMPTY), p = q-&gt;ch[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">setch</span>(x, p, <span class="number">0</span>), <span class="built_in">setch</span>(x, q, <span class="number">1</span>);</span><br><span class="line">            <span class="built_in">setch</span>(q, EMPTY, <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">splay</span>(q, EMPTY);</span><br><span class="line">            p = <span class="built_in">prevNode</span>(x);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (p == EMPTY)	p = <span class="built_in">maxNode</span>(root);</span><br><span class="line">        <span class="keyword">if</span> (q == EMPTY)	q = <span class="built_in">minNode</span>(root);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">make_tuple</span>(p-&gt;data, data, q-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; <span class="title">remove</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">        Node *x = <span class="built_in">findPos</span>(pos), *p, *q;</span><br><span class="line">        p = <span class="built_in">prevNode</span>(x), q = <span class="built_in">nextNode</span>(x);</span><br><span class="line">        <span class="keyword">if</span> (p != EMPTY &amp;&amp; q != EMPTY) &#123;</span><br><span class="line">            <span class="built_in">setch</span>(p, q, <span class="number">1</span>);</span><br><span class="line">            p-&gt;fa = EMPTY, <span class="built_in">splay</span>(q, EMPTY);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p != EMPTY) &#123;</span><br><span class="line">            p-&gt;fa = EMPTY, root = p;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            q-&gt;fa = EMPTY, root = q;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> del = x-&gt;data;</span><br><span class="line">        <span class="keyword">delete</span> x;</span><br><span class="line">        <span class="keyword">if</span> (p == EMPTY)	p = <span class="built_in">maxNode</span>(root);</span><br><span class="line">        <span class="keyword">if</span> (q == EMPTY)	q = <span class="built_in">minNode</span>(root);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">make_tuple</span>(p-&gt;data, del, q-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> root == EMPTY ? <span class="number">0</span> : root-&gt;size;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; mlist;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pt</span> &#123;</span></span><br><span class="line">    <span class="keyword">double</span> x, y;</span><br><span class="line">    <span class="built_in">Pt</span>() &#123;&#125;</span><br><span class="line">    <span class="built_in">Pt</span>(<span class="keyword">int</span> xy[]):<span class="built_in">Pt</span>(xy[<span class="number">0</span>], xy[<span class="number">1</span>]) &#123;&#125;</span><br><span class="line">    <span class="built_in">Pt</span>(<span class="keyword">double</span> x, <span class="keyword">double</span> y):<span class="built_in">x</span>(x), <span class="built_in">y</span>(y) &#123;&#125;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Pt &amp;o) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x != o.x)	<span class="keyword">return</span> x &lt; o.x;</span><br><span class="line">        <span class="keyword">return</span> y &lt; o.y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PtP</span> &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">double</span> x;</span><br><span class="line">    Pt p, q;</span><br><span class="line">    <span class="built_in">PtP</span>(Pt a, Pt b) &#123;</span><br><span class="line">        p = a, q = b;</span><br><span class="line">        <span class="keyword">if</span> (q &lt; p)</span><br><span class="line">            <span class="built_in">swap</span>(p, q);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">interpolate</span><span class="params">(<span class="keyword">const</span> Pt&amp; p1, <span class="keyword">const</span> Pt&amp; p2, <span class="keyword">double</span>&amp; x)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (p1.x == p2.x) <span class="keyword">return</span> <span class="built_in">min</span>(p1.y, p2.y);</span><br><span class="line">        <span class="keyword">return</span> p1.y + (p2.y - p1.y) / (p2.x - p1.x) * (x - p1.x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> PtP &amp;o) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">interpolate</span>(p, q, x) &lt; <span class="built_in">interpolate</span>(o.p, o.q, x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">double</span> PtP::x = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SegSeg</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        Node *lson, *rson;</span><br><span class="line">        tree&lt;pair&lt;PtP, <span class="keyword">int</span>&gt;, null_type, less&lt;pair&lt;PtP, <span class="keyword">int</span>&gt;&gt;, rb_tree_tag, tree_order_statistics_node_update&gt; segs;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;</span><br><span class="line">            lson = rson = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    Node *root;</span><br><span class="line">    <span class="keyword">int</span> xn;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Node</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">freeNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">free</span>(u);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        root = <span class="literal">NULL</span>;</span><br><span class="line">        xn = mesh.X.<span class="built_in">size</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> p, q, r; <span class="built_in">tie</span>(p, q, r) = e;</span><br><span class="line">        <span class="built_in">remove</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[p]), <span class="built_in">Pt</span>(mesh.pt[r])), r&#125;);</span><br><span class="line">        <span class="built_in">insert</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[p]), <span class="built_in">Pt</span>(mesh.pt[q])), q&#125;);</span><br><span class="line">        <span class="built_in">insert</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[q]), <span class="built_in">Pt</span>(mesh.pt[r])), r&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> p, q, r; <span class="built_in">tie</span>(p, q, r) = e;</span><br><span class="line">        <span class="built_in">remove</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[p]), <span class="built_in">Pt</span>(mesh.pt[q])), q&#125;);</span><br><span class="line">        <span class="built_in">remove</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[q]), <span class="built_in">Pt</span>(mesh.pt[r])), r&#125;);</span><br><span class="line">        <span class="built_in">insert</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[p]), <span class="built_in">Pt</span>(mesh.pt[r])), r&#125;);</span><br><span class="line">    &#125;	</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">inside</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</span><br><span class="line">        PtP::x = x;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">count</span>(root, <span class="number">0</span>, xn<span class="number">-1</span>, x, y)&amp;<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">count</span><span class="params">(Node* u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((mesh.X[l] &gt; x) != (mesh.X[r] &gt; x))</span><br><span class="line">            ret += u-&gt;segs.<span class="built_in">order_of_key</span>(&#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(x, y), <span class="built_in">Pt</span>(x, y)), <span class="number">-1</span>&#125;);</span><br><span class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (x &lt;= mesh.X[m])</span><br><span class="line">            ret += <span class="built_in">count</span>(u-&gt;lson, l, m, x, y);</span><br><span class="line">        <span class="keyword">if</span> (x &gt;= mesh.X[m])</span><br><span class="line">            ret += <span class="built_in">count</span>(u-&gt;rson, m, r, x, y);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (s.first.p.x != s.first.q.x)</span><br><span class="line">            <span class="built_in">insert</span>(root, l, r, s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (s.first.p.x != s.first.q.x)</span><br><span class="line">            <span class="built_in">remove</span>(root, l, r, s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</span><br><span class="line">            u = <span class="built_in">newNode</span>();</span><br><span class="line">        <span class="keyword">if</span> (s.first.p.x &lt;= mesh.X[l] &amp;&amp; mesh.X[r] &lt;= s.first.q.x) &#123;</span><br><span class="line">            PtP::x = (mesh.X[l] + mesh.X[r])/<span class="number">2.0</span>;</span><br><span class="line">            u-&gt;segs.<span class="built_in">insert</span>(s);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (s.first.q.x &lt;= mesh.X[m])			<span class="built_in">insert</span>(u-&gt;lson, l, m, s);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s.first.p.x &gt;= mesh.X[m])	<span class="built_in">insert</span>(u-&gt;rson, m, r, s);</span><br><span class="line">        <span class="keyword">else</span>	<span class="built_in">insert</span>(u-&gt;lson, l, m, s), <span class="built_in">insert</span>(u-&gt;rson, m, r, s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(Node* u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (s.first.p.x &lt;= mesh.X[l] &amp;&amp; mesh.X[r] &lt;= s.first.q.x) &#123;</span><br><span class="line">            PtP::x = (mesh.X[l] + mesh.X[r])/<span class="number">2.0</span>;</span><br><span class="line">            u-&gt;segs.<span class="built_in">erase</span>(s);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (s.first.q.x &lt;= mesh.X[m])			<span class="built_in">remove</span>(u-&gt;lson, l, m, s);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s.first.p.x &gt;= mesh.X[m])	<span class="built_in">remove</span>(u-&gt;rson, m, r, s);</span><br><span class="line">        <span class="keyword">else</span>	<span class="built_in">remove</span>(u-&gt;lson, l, m, s), <span class="built_in">remove</span>(u-&gt;rson, m, r, s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; mbrh;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, m, cmd, x, pos;</span><br><span class="line">    <span class="keyword">double</span> px, py;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">    mesh.<span class="built_in">read</span>(n);</span><br><span class="line">    mlist.<span class="built_in">init</span>(), mbrh.<span class="built_in">init</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;x, &amp;pos);</span><br><span class="line">            mbrh.<span class="built_in">insert</span>(mlist.<span class="built_in">insert</span>(x, pos));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;x);</span><br><span class="line">            mbrh.<span class="built_in">remove</span>(mlist.<span class="built_in">remove</span>(x));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%lf %lf&quot;</span>, &amp;px, &amp;py);</span><br><span class="line">            <span class="built_in">puts</span>(mbrh.<span class="built_in">inside</span>(px, py) ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="PBDS-ROPE"><a href="#PBDS-ROPE" class="headerlink" title="PBDS + ROPE"></a>PBDS + ROPE</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ext/rope&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> __gnu_cxx;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ext/pb_ds/assoc_container.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ext/pb_ds/tree_policy.hpp&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> __gnu_pbds;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Mesh</span> &#123;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1e5</span> + <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">int</span> pt[MAXN][<span class="number">2</span>];</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; X;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;pt[i][<span class="number">0</span>], &amp;pt[i][<span class="number">1</span>]);</span><br><span class="line">        X.<span class="built_in">clear</span>(); X.<span class="built_in">reserve</span>(n);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            X.<span class="built_in">push_back</span>(pt[i][<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">sort</span>(X.<span class="built_in">begin</span>(), X.<span class="built_in">end</span>());</span><br><span class="line">        X.<span class="built_in">erase</span>(<span class="built_in">unique</span>(X.<span class="built_in">begin</span>(), X.<span class="built_in">end</span>()), X.<span class="built_in">end</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125; mesh;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rope</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    rope&lt;<span class="keyword">int</span>&gt; r;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        r.<span class="built_in">clear</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">next</span><span class="params">(rope&lt;<span class="keyword">int</span>&gt;::const_iterator it)</span> </span>&#123;</span><br><span class="line">        it++;</span><br><span class="line">        <span class="keyword">if</span> (it == r.<span class="built_in">end</span>())</span><br><span class="line">            <span class="keyword">return</span> *r.<span class="built_in">begin</span>();</span><br><span class="line">        <span class="keyword">return</span> *it;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">prev</span><span class="params">(rope&lt;<span class="keyword">int</span>&gt;::const_iterator it)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (it == r.<span class="built_in">begin</span>())</span><br><span class="line">            <span class="keyword">return</span> *r.<span class="built_in">rbegin</span>();</span><br><span class="line">        it--;</span><br><span class="line">        <span class="keyword">return</span> *it;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; <span class="title">insert</span><span class="params">(<span class="keyword">int</span> data, <span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">        r.<span class="built_in">insert</span>(pos, data);</span><br><span class="line">        <span class="keyword">auto</span> it = r.<span class="built_in">begin</span>() + pos;</span><br><span class="line">        <span class="keyword">int</span> p = <span class="built_in">prev</span>(it);</span><br><span class="line">        <span class="keyword">int</span> q = <span class="built_in">next</span>(it);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">make_tuple</span>(p, data, q);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; <span class="title">remove</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> it = r.<span class="built_in">begin</span>() + pos;</span><br><span class="line">        <span class="keyword">int</span> del = *it;</span><br><span class="line">        <span class="keyword">int</span> p = <span class="built_in">prev</span>(it);</span><br><span class="line">        <span class="keyword">int</span> q = <span class="built_in">next</span>(it);</span><br><span class="line">        r.<span class="built_in">erase</span>(pos, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">make_tuple</span>(p, del, q);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; mlist;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pt</span> &#123;</span></span><br><span class="line">    <span class="keyword">double</span> x, y;</span><br><span class="line">    <span class="built_in">Pt</span>() &#123;&#125;</span><br><span class="line">    <span class="built_in">Pt</span>(<span class="keyword">int</span> xy[]):<span class="built_in">Pt</span>(xy[<span class="number">0</span>], xy[<span class="number">1</span>]) &#123;&#125;</span><br><span class="line">    <span class="built_in">Pt</span>(<span class="keyword">double</span> x, <span class="keyword">double</span> y):<span class="built_in">x</span>(x), <span class="built_in">y</span>(y) &#123;&#125;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Pt &amp;o) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x != o.x)	<span class="keyword">return</span> x &lt; o.x;</span><br><span class="line">        <span class="keyword">return</span> y &lt; o.y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PtP</span> &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">double</span> x;</span><br><span class="line">    Pt p, q;</span><br><span class="line">    <span class="built_in">PtP</span>(Pt a, Pt b) &#123;</span><br><span class="line">        p = a, q = b;</span><br><span class="line">        <span class="keyword">if</span> (q &lt; p)</span><br><span class="line">            <span class="built_in">swap</span>(p, q);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">interpolate</span><span class="params">(<span class="keyword">const</span> Pt&amp; p1, <span class="keyword">const</span> Pt&amp; p2, <span class="keyword">double</span>&amp; x)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (p1.x == p2.x) <span class="keyword">return</span> <span class="built_in">min</span>(p1.y, p2.y);</span><br><span class="line">        <span class="keyword">return</span> p1.y + (p2.y - p1.y) / (p2.x - p1.x) * (x - p1.x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> PtP &amp;o) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">interpolate</span>(p, q, x) &lt; <span class="built_in">interpolate</span>(o.p, o.q, x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">double</span> PtP::x = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SegSeg</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        Node *lson, *rson;</span><br><span class="line">        tree&lt;pair&lt;PtP, <span class="keyword">int</span>&gt;, null_type, less&lt;pair&lt;PtP, <span class="keyword">int</span>&gt;&gt;, rb_tree_tag, tree_order_statistics_node_update&gt; segs;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;</span><br><span class="line">            lson = rson = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    Node *root;</span><br><span class="line">    <span class="keyword">int</span> xn;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Node</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        root = <span class="literal">NULL</span>;</span><br><span class="line">        xn = mesh.X.<span class="built_in">size</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> p, q, r; <span class="built_in">tie</span>(p, q, r) = e;</span><br><span class="line">        <span class="built_in">remove</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[p]), <span class="built_in">Pt</span>(mesh.pt[r])), r&#125;);</span><br><span class="line">        <span class="built_in">insert</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[p]), <span class="built_in">Pt</span>(mesh.pt[q])), q&#125;);</span><br><span class="line">        <span class="built_in">insert</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[q]), <span class="built_in">Pt</span>(mesh.pt[r])), r&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> p, q, r; <span class="built_in">tie</span>(p, q, r) = e;</span><br><span class="line">        <span class="built_in">remove</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[p]), <span class="built_in">Pt</span>(mesh.pt[q])), q&#125;);</span><br><span class="line">        <span class="built_in">remove</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[q]), <span class="built_in">Pt</span>(mesh.pt[r])), r&#125;);</span><br><span class="line">        <span class="built_in">insert</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[p]), <span class="built_in">Pt</span>(mesh.pt[r])), r&#125;);</span><br><span class="line">    &#125;	</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">inside</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</span><br><span class="line">        PtP::x = x;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">count</span>(root, <span class="number">0</span>, xn<span class="number">-1</span>, x, y)&amp;<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">count</span><span class="params">(Node* u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((mesh.X[l] &gt; x) != (mesh.X[r] &gt; x))</span><br><span class="line">            ret += u-&gt;segs.<span class="built_in">order_of_key</span>(&#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(x, y), <span class="built_in">Pt</span>(x, y)), <span class="number">-1</span>&#125;);</span><br><span class="line">        <span class="keyword">if</span> (l == r)</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (x &lt;= mesh.X[m])</span><br><span class="line">            ret += <span class="built_in">count</span>(u-&gt;lson, l, m, x, y);</span><br><span class="line">        <span class="keyword">if</span> (x &gt;= mesh.X[m])</span><br><span class="line">            ret += <span class="built_in">count</span>(u-&gt;rson, m, r, x, y);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (s.first.p.x != s.first.q.x)</span><br><span class="line">            <span class="built_in">insert</span>(root, l, r, s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (s.first.p.x != s.first.q.x)</span><br><span class="line">            <span class="built_in">remove</span>(root, l, r, s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</span><br><span class="line">            u = <span class="built_in">newNode</span>();</span><br><span class="line">        <span class="keyword">if</span> (s.first.p.x &lt;= mesh.X[l] &amp;&amp; mesh.X[r] &lt;= s.first.q.x) &#123;</span><br><span class="line">            PtP::x = (mesh.X[l] + mesh.X[r])/<span class="number">2.0</span>;</span><br><span class="line">            u-&gt;segs.<span class="built_in">insert</span>(s);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (l == r)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (s.first.q.x &lt;= mesh.X[m])			<span class="built_in">insert</span>(u-&gt;lson, l, m, s);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s.first.p.x &gt;= mesh.X[m])	<span class="built_in">insert</span>(u-&gt;rson, m, r, s);</span><br><span class="line">        <span class="keyword">else</span>	<span class="built_in">insert</span>(u-&gt;lson, l, m, s), <span class="built_in">insert</span>(u-&gt;rson, m, r, s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (s.first.p.x &lt;= mesh.X[l] &amp;&amp; mesh.X[r] &lt;= s.first.q.x) &#123;</span><br><span class="line">            PtP::x = (mesh.X[l] + mesh.X[r])/<span class="number">2.0</span>;</span><br><span class="line">            u-&gt;segs.<span class="built_in">erase</span>(s);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (l == r)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (s.first.q.x &lt;= mesh.X[m])			<span class="built_in">remove</span>(u-&gt;lson, l, m, s);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s.first.p.x &gt;= mesh.X[m])	<span class="built_in">remove</span>(u-&gt;rson, m, r, s);</span><br><span class="line">        <span class="keyword">else</span>	<span class="built_in">remove</span>(u-&gt;lson, l, m, s), <span class="built_in">remove</span>(u-&gt;rson, m, r, s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; mbrh;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, m, cmd, x, pos;</span><br><span class="line">    <span class="keyword">double</span> px, py;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">    mesh.<span class="built_in">read</span>(n);</span><br><span class="line">    mlist.<span class="built_in">init</span>(), mbrh.<span class="built_in">init</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;x, &amp;pos);</span><br><span class="line">            mbrh.<span class="built_in">insert</span>(mlist.<span class="built_in">insert</span>(x, pos));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;x);</span><br><span class="line">            mbrh.<span class="built_in">remove</span>(mlist.<span class="built_in">remove</span>(x));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%lf %lf&quot;</span>, &amp;px, &amp;py);</span><br><span class="line">            <span class="built_in">puts</span>(mbrh.<span class="built_in">inside</span>(px, py) ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b685" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/24/zj-b685/" class="article-date">
  <time datetime="2016-01-24T02:06:24.000Z" itemprop="datePublished">2016-01-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/24/zj-b685/">b685. 高中組第五題-課堂抽籤</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/01/24/zj-b685/" data-id="ckpaivcac00bwn8vnhal96z0f" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/01/24/zj-b685/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dp/">dp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/數學/">數學</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><span>$N$</span><!-- Has MathJax --> 個人抽籤決定跟誰同一組，請問在某些籤已經決定好的情況下，求恰好分成 <span>$M$</span><!-- Has MathJax --> 組的抽籤方法數。

<p>轉換成 <span>$N$</span><!-- Has MathJax --> 個節點，恰好形成 <span>$M$</span><!-- Has MathJax --> 個環的方法數。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2</span><br><span class="line">5 1</span><br><span class="line">2 3 1 5 4</span><br><span class="line">5 2</span><br><span class="line">2 3 1 5 4</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>在此特別感謝 lwc (Wei Chen Liao) 提供思路。</p>
<p>手動暴力打表後，上網蒐到 <a href="https://oeis.org/A125714">A125714 Alfred Moessner’s factorial triangle.</a> 恰好是這個數列的答案。</p>
<p>由於每一個人的籤不重複，若把他抽到的籤當作指向出去的邊，那麼保證這一個點恰好一個出邊和一個入邊。當所有籤抽滿後，圖看起來是好幾個環。</p>
<p>遞迴定義 <code>dp[i][j]</code> 表示有 <span>$i$</span><!-- Has MathJax --> 個節點和 <span>$j$</span><!-- Has MathJax --> 個環。考慮新加入得點要抽到哪一個籤，加入到 <span>$j$</span><!-- Has MathJax --> 個環的情況，則是把某一個環的某一個位置打開加入，或者自身形成一個環，最後得到 <code>dp[i][j] = dp[i-1][j-1] + (i-1)*dp[i-1][j]</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1024</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> MOD = <span class="number">1000007</span>;</span><br><span class="line"><span class="keyword">long</span> <span class="keyword">long</span> dp[MAXN][MAXN];</span><br><span class="line"><span class="keyword">int</span> A[MAXN], used[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    dp[<span class="number">0</span>][<span class="number">0</span>] = dp[<span class="number">1</span>][<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; MAXN; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= i; j++)</span><br><span class="line">            dp[i][j] = (dp[i<span class="number">-1</span>][j<span class="number">-1</span>] + dp[i<span class="number">-1</span>][j] * (i<span class="number">-1</span>))%MOD;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> testcase, n, m;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;testcase);</span><br><span class="line">    <span class="keyword">while</span> (testcase--) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;A[i]);</span><br><span class="line">        <span class="keyword">int</span> a = n, b = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">memset</span>(used, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(used));</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (used[i])</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">int</span> x = i, cnt = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (x &amp;&amp; used[x] == <span class="number">0</span>)</span><br><span class="line">                used[x] = <span class="number">1</span>, x = A[x], cnt++;</span><br><span class="line">            a -= cnt<span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">if</span> (x == i)	m--;</span><br><span class="line">            <span class="keyword">if</span> (x == <span class="number">0</span>)	b++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (m &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>, dp[b][m]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b500" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/24/zj-b500/" class="article-date">
  <time datetime="2015-08-24T08:34:06.000Z" itemprop="datePublished">2015-08-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/24/zj-b500/">b500. 子字串集合</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/08/24/zj-b500/" data-id="ckpaivcac00bvn8vn38ntec9w" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/08/24/zj-b500/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SAM/">SAM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/trie/">trie</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/後綴自動機/">後綴自動機</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>給予一個字串 <span>$S$</span><!-- Has MathJax -->，求出所有子字串的集合，將集合內除了空字串以外的字串照字典順序輸出。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SLEEP</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">E</span><br><span class="line">EE</span><br><span class="line">EEP</span><br><span class="line">EP</span><br><span class="line">L</span><br><span class="line">LE</span><br><span class="line">LEE</span><br><span class="line">LEEP</span><br><span class="line">P</span><br><span class="line">S</span><br><span class="line">SL</span><br><span class="line">SLE</span><br><span class="line">SLEE</span><br><span class="line">SLEEP</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>新手上路練習題，沒打算考很難的操作，即便如此信任也破產，看來出成變態題的機會高一點導致釣不到人來寫。</p>
<p>直觀作法是窮舉所有子字串，去掉重複即可，時間複雜度 <span>$O(N^3)$</span><!-- Has MathJax -->，由於 <span>$N = 500$</span><!-- Has MathJax --> 也要考慮輸出的成本，所以不可能出太大。儘管如此，來比較算法之間的空間和時間用量。</p>
<p>首先，最常見到的 set 作法，若直接儲存字串空間用量 <span>$O(N^3)$</span><!-- Has MathJax -->，為了避免空間太多，可以自己寫一個 compare function 來完成，因此 set 只要記錄子字串的起始位置和長度即可，時間複雜度 <span>$O(N^3)$</span><!-- Has MathJax -->，空間降到 <span>$O(N^2)$</span><!-- Has MathJax -->。</p>
<p>接著，進入到後期，常用到字典樹 trie，若把所有後綴插入到字典中，接著在 trie 走訪輸出所有結果即可，時間複雜度 <span>$O(N^2)$</span><!-- Has MathJax -->，空間 <span>$O(N^2 \times 26)$</span><!-- Has MathJax -->。可以使用 double-array trie 捨棄掉一點時間，降低節點的空間使用量。</p>
<p>最後，比較強悍的後綴自動機，在劉汝佳的書上主要是用 DAWG (directed acyclic word graph) 來描述 suffix automaton，後綴自動機可以在線構造，時間和空間複雜度都是 <span>$O(N)$</span><!-- Has MathJax -->，後綴自動機可以接受 <span>$S$</span><!-- Has MathJax --> 所有的後綴，關於建造時間和狀態總數的證明可以參考 <a href="https://github.com/morris821028/ACM-ICPC-resource/blob/master/pdf/Suffix%20automaton%28SAM%29.pdf">《Suffix Automaton 杭州外国语学校 陈立杰》</a> 的簡報。</p>
<p>若不想這麼詳細的證明狀態總數和時間複雜度，可以從 AC 自動機的建構概念來思考，一樣有 fail 指針，來維護當一個後綴失去匹配，移除前綴要移動到的狀態。特別的是，每一次增加最多兩個節點，最後一次增加的節點為 accept state (後綴自動機只有一個或兩個 accept state)，其中一個節點是解決當前字串的後綴長度 1 的轉移。</p>
<p>根據這一題的需求，走訪一次後綴自動機就能印出所有子字串。</p>
<ul>
<li>set 解法一 AC (0.2s, 25.2MB) </li>
<li>set 解法二 AC (0.4s, 3.8MB)</li>
<li>trie AC (0.1s, 12.1MB)</li>
<li>Double-array trie AC (0.2s, 7.7MB)</li>
<li>後綴自動機 suffix automaton AC (64ms, 240KB)</li>
</ul>
<h3 id="後綴自動機"><a href="#後綴自動機" class="headerlink" title="後綴自動機"></a>後綴自動機</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SuffixAutomaton</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">500</span>&lt;&lt;<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXC = <span class="number">26</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        Node *next[MAXC], *pre;</span><br><span class="line">        <span class="keyword">int</span> step;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;</span><br><span class="line">            pre = <span class="literal">NULL</span>, step = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">memset</span>(next, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(next));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; _mem[MAXN];</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">    Node *root, *tail;	</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        size = <span class="number">0</span>;</span><br><span class="line">        root = tail = <span class="built_in">newNode</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node *p = &amp;_mem[size++];</span><br><span class="line">        *p = <span class="built_in">Node</span>();</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">toIndex</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123; <span class="keyword">return</span> c - <span class="string">&#x27;A&#x27;</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">char</span> <span class="title">toChar</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; <span class="keyword">return</span> c + <span class="string">&#x27;A&#x27;</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">char</span> c, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">        c = <span class="built_in">toIndex</span>(c);</span><br><span class="line">        Node *p, *q, *np, *nq;</span><br><span class="line">        p = tail, np = <span class="built_in">newNode</span>();</span><br><span class="line">        np-&gt;step = len;</span><br><span class="line">        <span class="keyword">for</span> (; p &amp;&amp; p-&gt;next[c] == <span class="literal">NULL</span>; p = p-&gt;pre)</span><br><span class="line">            p-&gt;next[c] = np;</span><br><span class="line">        tail = np;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            np-&gt;pre = root;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (p-&gt;next[c]-&gt;step == p-&gt;step+<span class="number">1</span>) &#123;</span><br><span class="line">                np-&gt;pre = p-&gt;next[c];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                q = p-&gt;next[c], nq = <span class="built_in">newNode</span>();</span><br><span class="line">                *nq = *q;</span><br><span class="line">                nq-&gt;step = p-&gt;step + <span class="number">1</span>;</span><br><span class="line">                q-&gt;pre = np-&gt;pre = nq;</span><br><span class="line">                <span class="keyword">for</span> (; p &amp;&amp; p-&gt;next[c] == q; p = p-&gt;pre)</span><br><span class="line">                    p-&gt;next[c] = nq;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">init</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; s[i]; i++)</span><br><span class="line">            <span class="built_in">add</span>(s[i], i+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(Node *u, <span class="keyword">int</span> idx, <span class="keyword">char</span> path[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAXC; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (u-&gt;next[i]) &#123;</span><br><span class="line">                path[idx] = <span class="built_in">toChar</span>(i);</span><br><span class="line">                path[idx+<span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                <span class="built_in">puts</span>(path);</span><br><span class="line">                <span class="built_in">dfs</span>(u-&gt;next[i], idx+<span class="number">1</span>, path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> s[<span class="number">1024</span>];</span><br><span class="line">        <span class="built_in">dfs</span>(root, <span class="number">0</span>, s);</span><br><span class="line">    &#125; </span><br><span class="line">&#125; SAM;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> s[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s) == <span class="number">1</span>) &#123;</span><br><span class="line">        SAM.<span class="built_in">build</span>(s);</span><br><span class="line">        SAM.<span class="built_in">print</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="set-ver-1"><a href="#set-ver-1" class="headerlink" title="set ver 1"></a>set ver 1</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> s[<span class="number">512</span>];</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s) == <span class="number">1</span>) &#123;</span><br><span class="line">        set&lt;string&gt; S;</span><br><span class="line">        <span class="keyword">int</span> n = <span class="built_in">strlen</span>(s);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; n; j++) &#123;</span><br><span class="line">                <span class="keyword">char</span> c = s[j+<span class="number">1</span>];</span><br><span class="line">                s[j+<span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                S.<span class="built_in">insert</span>(s+i);</span><br><span class="line">                s[j+<span class="number">1</span>] = c;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;x : S)</span><br><span class="line">            <span class="built_in">puts</span>(x.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="set-ver-2"><a href="#set-ver-2" class="headerlink" title="set ver 2"></a>set ver 2</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">char</span> s[<span class="number">512</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cmp</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span> <span class="params">(<span class="keyword">const</span> pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &amp;a, <span class="keyword">const</span> pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &amp;b)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; a.second &amp;&amp; i &lt; b.second; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s[a.first+i] != s[b.first+i])</span><br><span class="line">                <span class="keyword">return</span> s[a.first+i] &lt; s[b.first+i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> a.second &lt; b.second;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s) == <span class="number">1</span>) &#123;</span><br><span class="line">        set&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;, cmp &gt; S;</span><br><span class="line">        <span class="keyword">int</span> n = <span class="built_in">strlen</span>(s);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; n; j++) &#123;</span><br><span class="line">                S.<span class="built_in">insert</span>(&#123;i, j-i+<span class="number">1</span>&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;x : S) &#123;</span><br><span class="line">            <span class="keyword">int</span> base = x.first, len = x.second;</span><br><span class="line">            <span class="keyword">char</span> c = s[base+len];</span><br><span class="line">            s[base+len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            <span class="built_in">puts</span>(s + base);</span><br><span class="line">            s[base+len] = c;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="trie"><a href="#trie" class="headerlink" title="trie"></a>trie</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Trie</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">130000</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXC = <span class="number">26</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        Node *next[MAXC];</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">memset</span>(next, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(next));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; nodes[MAXN];</span><br><span class="line">    Node *root;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    	<span class="built_in">assert</span>(size &lt; MAXN);</span><br><span class="line">        Node *p = &amp;nodes[size++];</span><br><span class="line">        p-&gt;<span class="built_in">init</span>();</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        size = <span class="number">0</span>;</span><br><span class="line">        root = <span class="built_in">newNode</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">toIndex</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> c - <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">toChar</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> c + <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> str[])</span> </span>&#123;</span><br><span class="line">        Node *p = root;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, idx; str[i]; i++) &#123;</span><br><span class="line">            idx = <span class="built_in">toIndex</span>(str[i]);</span><br><span class="line">            <span class="keyword">if</span> (p-&gt;next[idx] == <span class="literal">NULL</span>)</span><br><span class="line">                p-&gt;next[idx] = <span class="built_in">newNode</span>();</span><br><span class="line">            p = p-&gt;next[idx];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(Node *u, <span class="keyword">int</span> idx, <span class="keyword">char</span> path[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAXC; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (u-&gt;next[i]) &#123;</span><br><span class="line">                path[idx] = <span class="built_in">toChar</span>(i);</span><br><span class="line">                path[idx+<span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                <span class="built_in">puts</span>(path);</span><br><span class="line">                <span class="built_in">dfs</span>(u-&gt;next[i], idx+<span class="number">1</span>, path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> s[<span class="number">1024</span>];</span><br><span class="line">        <span class="built_in">dfs</span>(root, <span class="number">0</span>, s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; tree;</span><br><span class="line"><span class="keyword">char</span> s[<span class="number">1024</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> n = <span class="built_in">strlen</span>(s);</span><br><span class="line">        tree.<span class="built_in">init</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; n; j++) &#123;</span><br><span class="line">                <span class="keyword">char</span> c = s[j+<span class="number">1</span>];</span><br><span class="line">                s[j+<span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                tree.<span class="built_in">insert</span>(s+i);</span><br><span class="line">                s[j+<span class="number">1</span>] = c;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        tree.<span class="built_in">print</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="DA-trie"><a href="#DA-trie" class="headerlink" title="DA trie"></a>DA trie</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DATrie</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">500000</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXC = <span class="number">27</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        <span class="keyword">int</span> check, base, fail, val;</span><br><span class="line">    &#125; A[MAXN + MAXC];</span><br><span class="line">    <span class="keyword">int</span> node_size, mem_size, emp_size;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">int</span> son_pos[MAXC], find_pos;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">toIndex</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> c - <span class="string">&#x27;A&#x27;</span> + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">toChar</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> c + <span class="string">&#x27;A&#x27;</span> - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">isEMPTY</span><span class="params">(<span class="keyword">int</span> u)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">return</span> u &lt; MAXN &amp;&amp; A[u].check &lt; <span class="number">0</span> &amp;&amp; A[u].base &lt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; MAXN; i++)</span><br><span class="line">            A[i].check = -(i+<span class="number">1</span>), A[i].base = -(i<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = MAXN; i &lt; MAXN + MAXC; i++)</span><br><span class="line">            A[i].check = INT_MAX;</span><br><span class="line">        A[MAXN<span class="number">-1</span>].check = <span class="number">-1</span>, A[<span class="number">1</span>].base = -(MAXN<span class="number">-1</span>);</span><br><span class="line">        A[<span class="number">0</span>].check = <span class="number">-1</span>, A[<span class="number">0</span>].base = <span class="number">0</span>;</span><br><span class="line">        node_size = mem_size = emp_size = <span class="number">0</span>, find_pos = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">rm_node</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (find_pos == x)	find_pos = <span class="built_in">abs</span>(A[x].check);</span><br><span class="line">        A[-A[x].base].check = A[x].check;</span><br><span class="line">        A[-A[x].check].base = A[x].base;</span><br><span class="line">        node_size++;</span><br><span class="line">        mem_size = <span class="built_in">max</span>(mem_size, x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">ad_node</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        A[x].check = MAXN, A[x].base = MAXN;</span><br><span class="line">        emp_size++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">insert</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> st = <span class="number">0</span>, to, c;</span><br><span class="line">        <span class="keyword">int</span> flag = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; s[i]; i++) &#123;</span><br><span class="line">            c = <span class="built_in">toIndex</span>(s[i]);</span><br><span class="line">            to = <span class="built_in">abs</span>(A[st].base) + c;	</span><br><span class="line">            <span class="keyword">if</span> (st == <span class="built_in">abs</span>(A[to].check)) &#123;</span><br><span class="line">                st = to;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">isEMPTY</span>(to)) &#123;</span><br><span class="line">                <span class="built_in">rm_node</span>(to); </span><br><span class="line">                A[to].check = st, A[to].base = to;</span><br><span class="line">                st = to;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> son_sz = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">int</span> pos = <span class="built_in">find_empty</span>(st, c, son_sz);</span><br><span class="line">                <span class="built_in">relocate</span>(st, pos, son_sz<span class="number">-1</span>);</span><br><span class="line">                i--; </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        A[st].base = -<span class="built_in">abs</span>(A[st].base);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> st = <span class="number">0</span>, to, c;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; s[i]; i++) &#123;</span><br><span class="line">            c = <span class="built_in">toIndex</span>(s[i]);</span><br><span class="line">            to = <span class="built_in">abs</span>(A[st].base) + c;</span><br><span class="line">            <span class="keyword">if</span> (st == <span class="built_in">abs</span>(A[to].check))</span><br><span class="line">                st = to;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> A[st].base &lt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">find_empty</span><span class="params">(<span class="keyword">int</span> st, <span class="keyword">int</span> c, <span class="keyword">int</span> &amp;sz)</span> </span>&#123;</span><br><span class="line">        sz = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> bs = <span class="built_in">abs</span>(A[st].base);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, j = bs+<span class="number">1</span>; i &lt; MAXC; i++, j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">abs</span>(A[j].check) == st)</span><br><span class="line">                son_pos[sz++] = i;</span><br><span class="line">        &#125;</span><br><span class="line">        son_pos[sz++] = c;</span><br><span class="line">        <span class="keyword">int</span> mn_pos = <span class="built_in">min</span>(son_pos[<span class="number">0</span>], c) - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (; find_pos &amp;&amp; (find_pos &lt; bs || find_pos &lt; mn_pos); find_pos = <span class="built_in">abs</span>(A[find_pos].check));</span><br><span class="line">        <span class="keyword">for</span> (; find_pos; find_pos = <span class="built_in">abs</span>(A[find_pos].check)) &#123;</span><br><span class="line">            <span class="keyword">int</span> ok = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz &amp;&amp; ok; i++)</span><br><span class="line">                ok &amp;= <span class="built_in">isEMPTY</span>(find_pos + son_pos[i] - mn_pos);</span><br><span class="line">            <span class="keyword">if</span> (ok)</span><br><span class="line">                <span class="keyword">return</span> find_pos - mn_pos;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Memory Leak -- %d\n&quot;</span>, find_pos);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">relocate</span><span class="params">(<span class="keyword">int</span> st, <span class="keyword">int</span> to, <span class="keyword">int</span> sz)</span> </span>&#123;	<span class="comment">// move ::st -&gt; ::to</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = sz<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="keyword">int</span> a = <span class="built_in">abs</span>(A[st].base) + son_pos[i];	<span class="comment">// old</span></span><br><span class="line">            <span class="keyword">int</span> b = to + son_pos[i];			<span class="comment">// new</span></span><br><span class="line">            <span class="built_in">rm_node</span>(b);</span><br><span class="line">            A[b].check = st, A[b].base = A[a].base;</span><br><span class="line">            <span class="keyword">int</span> vs = <span class="built_in">abs</span>(A[a].base);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>, k = vs+<span class="number">1</span>; j &lt; MAXC; j++, k++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">abs</span>(A[k].check) == a)</span><br><span class="line">                    A[k].check = b;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">ad_node</span>(a);</span><br><span class="line">        &#125;</span><br><span class="line">        A[st].base = (A[st].base &lt; <span class="number">0</span> ? <span class="number">-1</span> : <span class="number">1</span>) * to;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> idx, <span class="keyword">char</span> path[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; MAXC; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> to = <span class="built_in">abs</span>(A[u].base) + i;</span><br><span class="line">            <span class="keyword">if</span> (u == <span class="built_in">abs</span>(A[to].check)) &#123;</span><br><span class="line">                path[idx] = <span class="built_in">toChar</span>(i);</span><br><span class="line">                path[idx+<span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                <span class="built_in">puts</span>(path);</span><br><span class="line">                <span class="built_in">dfs</span>(to, idx+<span class="number">1</span>, path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> s[<span class="number">1024</span>];</span><br><span class="line">        <span class="built_in">dfs</span>(<span class="number">0</span>, <span class="number">0</span>, s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; tree;</span><br><span class="line"><span class="keyword">char</span> s[<span class="number">1024</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> n = <span class="built_in">strlen</span>(s);</span><br><span class="line">        tree.<span class="built_in">init</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; n; j++) &#123;</span><br><span class="line">                <span class="keyword">char</span> c = s[j+<span class="number">1</span>];</span><br><span class="line">                s[j+<span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                tree.<span class="built_in">insert</span>(s+i);</span><br><span class="line">                s[j+<span class="number">1</span>] = c;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        tree.<span class="built_in">print</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b498" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/24/zj-b498/" class="article-date">
  <time datetime="2015-08-24T08:26:51.000Z" itemprop="datePublished">2015-08-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/24/zj-b498/">b498. 史蒂芙的單詞統計</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/08/24/zj-b498/" data-id="ckpaivcab00bun8vn02hdeuj4" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/08/24/zj-b498/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AC-自動機/">AC 自動機</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DA-trie/">DA trie</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/double-array-trie/">double-array trie</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/trie/">trie</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>史蒂芙手上有本小字典，這字典專門針對某種類型的需求而收集，字典中有非常多特定單詞，為了要辨識語言是否屬於哪一類，判斷方法就是統計一句話中出現多少次字典的單詞，再按照比例數量去偵測。</p>
<h3 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h3><p>給予 <span>$N$</span><!-- Has MathJax --> 個單詞的字典，每個單詞只由大小寫字母和數字構成，接著有 <span>$Q$</span><!-- Has MathJax --> 個詢問，每個詢問為一個字串，字串只由大小寫字母和數字構成。對於每個詢問加總每一種單詞出現在字串的個數。</p>
<p>例如經典遊戲《魂斗羅》的秘笈 UUDDLRLRBA，若字典中只有兩個單詞 LR 和 BA，由於 LR 出現 2 次，BA 出現 1 次，統計結果為 1+2 = 3。同理，BANANANA，若字典中只有 ANA 和 BA，則 ANA 出現 3 次，BA 出現一次，統計結果為 3+1 = 4。</p>
<p>這個工作需要極致的效率，就麻煩各位。由於史蒂芙經費有限，只能給予 128MB 的空間。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">2</span><br><span class="line">01</span><br><span class="line">01</span><br><span class="line">1</span><br><span class="line">01001</span><br><span class="line"></span><br><span class="line">3</span><br><span class="line">LR</span><br><span class="line">BA</span><br><span class="line">ANA</span><br><span class="line">2</span><br><span class="line">UUDDLRLRBA</span><br><span class="line">BANANANA</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Case #1:</span><br><span class="line">2</span><br><span class="line">Case #2:</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>史蒂芙系列迎來第七題，這次考驗的是 Trie 和 Aho-Corasick automation 的空間優化，明顯地在 Trie 中每一個節點會帶有 |alpha set| 個 pointer，因此空間使用量非常浪費，尤其後綴的機率極低重疊。</p>
<p>因此，雖然只有大小寫英文和數字的字串，<span>$O(64)$</span><!-- Has MathJax --> 空間仍然很大，那麼開平衡樹是個解決方法，但千萬不能使用內建的 <code>std::map</code>，因為實作的 RB tree 帶有的 CONTAINER OVERHEAD 直接佔有大量空間。</p>
<ul>
<li>解法一： Double-Array Trie + Aho-Corasick automation，DA Trie 原則上在弄 perfect hash，一旦衝突就要捨棄，接著一代子節點跟著搬家，因此宣告一個諾大的內存池，利用雙向鏈表維護，讓他們盡可能找到安居之地。</li>
<li>解法二：原生作法，但使用 <code>vector&lt;Node*&gt; link</code> 來維護，保證 link 的首尾都有實體子節點，中間若發生留空就隨他去，目標省下後綴空間，那後綴運氣好都是在 size = 1 的情況紀錄。</li>
<li>解法三：安妥妥地寫平衡樹。</li>
</ul>
<p>看到解法二就知道解法一白做工，雖然標榜 DA Trie 在插入能力很低效，修改一下找 perfect hash 的方法，不支持高效率壓縮，多一點垃圾也沒關係，那麼弄成作業系統那樣的檔案配置，看要用 C-LOOK 還是 SCAN 亂幹。總之，每次從頭開始刷會刷到天昏地暗。</p>
<ul>
<li>解法一：AC (2.5s, 76.8MB)</li>
<li>解法二：AC (2.5s, 53.3MB)</li>
<li>解法三：釣魚中</li>
</ul>
<h3 id="DA-trie"><a href="#DA-trie" class="headerlink" title="DA trie"></a>DA trie</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DATrie</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">5000000</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXC = <span class="number">63</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        <span class="keyword">int</span> check, base, fail, val;</span><br><span class="line">    &#125; A[MAXN + MAXC];</span><br><span class="line">    <span class="keyword">int</span> node_size, mem_size, emp_size;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">int</span> son_pos[MAXC], find_pos;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">toIndex</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">isdigit</span>(c))	<span class="keyword">return</span> c - <span class="string">&#x27;0&#x27;</span> + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">isupper</span>(c)) <span class="keyword">return</span> c - <span class="string">&#x27;A&#x27;</span> + <span class="number">10</span> + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">islower</span>(c))	<span class="keyword">return</span> c - <span class="string">&#x27;a&#x27;</span> + <span class="number">26</span> + <span class="number">10</span> + <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">assert</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">isEMPTY</span><span class="params">(<span class="keyword">int</span> u)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> u &lt; MAXN &amp;&amp; A[u].check &lt; <span class="number">0</span> &amp;&amp; A[u].base &lt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; MAXN; i++)</span><br><span class="line">            A[i].check = -(i+<span class="number">1</span>), A[i].base = -(i<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = MAXN; i &lt; MAXN + MAXC; i++)</span><br><span class="line">            A[i].check = INT_MAX;</span><br><span class="line">        A[MAXN<span class="number">-1</span>].check = <span class="number">-1</span>, A[<span class="number">1</span>].base = -(MAXN<span class="number">-1</span>);</span><br><span class="line">        A[<span class="number">0</span>].check = <span class="number">-1</span>, A[<span class="number">0</span>].base = <span class="number">0</span>;</span><br><span class="line">        node_size = mem_size = emp_size = <span class="number">0</span>, find_pos = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">rm_node</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (find_pos == x)	find_pos = <span class="built_in">abs</span>(A[x].check);</span><br><span class="line">        A[-A[x].base].check = A[x].check;</span><br><span class="line">        A[-A[x].check].base = A[x].base;</span><br><span class="line">        node_size++;</span><br><span class="line">        mem_size = <span class="built_in">max</span>(mem_size, x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">ad_node</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        A[x].check = MAXN, A[x].base = MAXN;</span><br><span class="line">        emp_size++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">insert</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> st = <span class="number">0</span>, to, c;</span><br><span class="line">        <span class="keyword">int</span> flag = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; s[i]; i++) &#123;</span><br><span class="line">            c = <span class="built_in">toIndex</span>(s[i]);</span><br><span class="line">            to = <span class="built_in">abs</span>(A[st].base) + c;	</span><br><span class="line">            <span class="keyword">if</span> (st == <span class="built_in">abs</span>(A[to].check)) &#123;</span><br><span class="line">                st = to;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">isEMPTY</span>(to)) &#123;</span><br><span class="line">                <span class="built_in">rm_node</span>(to); </span><br><span class="line">                A[to].check = st, A[to].base = to;</span><br><span class="line">                st = to;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> son_sz = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">int</span> pos = <span class="built_in">find_empty</span>(st, c, son_sz);</span><br><span class="line">                <span class="built_in">relocate</span>(st, pos, son_sz<span class="number">-1</span>);</span><br><span class="line">                i--; </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//		if (A[st].base &gt; 0)	words++;</span></span><br><span class="line">        A[st].base = -<span class="built_in">abs</span>(A[st].base);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> st = <span class="number">0</span>, to, c;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; s[i]; i++) &#123;</span><br><span class="line">            c = <span class="built_in">toIndex</span>(s[i]);</span><br><span class="line">            to = <span class="built_in">abs</span>(A[st].base) + c;</span><br><span class="line">            <span class="keyword">if</span> (st == <span class="built_in">abs</span>(A[to].check))</span><br><span class="line">                st = to;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> A[st].base &lt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">find_empty</span><span class="params">(<span class="keyword">int</span> st, <span class="keyword">int</span> c, <span class="keyword">int</span> &amp;sz)</span> </span>&#123;</span><br><span class="line">        sz = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> bs = <span class="built_in">abs</span>(A[st].base);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, j = bs+<span class="number">1</span>; i &lt; MAXC; i++, j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">abs</span>(A[j].check) == st)</span><br><span class="line">                son_pos[sz++] = i;</span><br><span class="line">        &#125;</span><br><span class="line">        son_pos[sz++] = c;</span><br><span class="line">        <span class="keyword">int</span> mn_pos = <span class="built_in">min</span>(son_pos[<span class="number">0</span>], c) - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (; find_pos &amp;&amp; (find_pos &lt; bs || find_pos &lt; mn_pos); find_pos = <span class="built_in">abs</span>(A[find_pos].check));</span><br><span class="line">        <span class="keyword">for</span> (; find_pos; find_pos = <span class="built_in">abs</span>(A[find_pos].check)) &#123;</span><br><span class="line">            <span class="keyword">int</span> ok = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz &amp;&amp; ok; i++)</span><br><span class="line">                ok &amp;= <span class="built_in">isEMPTY</span>(find_pos + son_pos[i] - mn_pos);</span><br><span class="line">            <span class="keyword">if</span> (ok)</span><br><span class="line">                <span class="keyword">return</span> find_pos - mn_pos;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Memory Leak -- %d\n&quot;</span>, find_pos);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">relocate</span><span class="params">(<span class="keyword">int</span> st, <span class="keyword">int</span> to, <span class="keyword">int</span> sz)</span> </span>&#123;	<span class="comment">// move ::st -&gt; ::to</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = sz<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="keyword">int</span> a = <span class="built_in">abs</span>(A[st].base) + son_pos[i];	<span class="comment">// old</span></span><br><span class="line">            <span class="keyword">int</span> b = to + son_pos[i];			<span class="comment">// new</span></span><br><span class="line">            <span class="built_in">rm_node</span>(b);</span><br><span class="line">            A[b].check = st, A[b].base = A[a].base;</span><br><span class="line">            <span class="keyword">int</span> vs = <span class="built_in">abs</span>(A[a].base);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>, k = vs+<span class="number">1</span>; j &lt; MAXC; j++, k++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">abs</span>(A[k].check) == a)</span><br><span class="line">                    A[k].check = b;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">ad_node</span>(a);</span><br><span class="line">        &#125;</span><br><span class="line">        A[st].base = (A[st].base &lt; <span class="number">0</span> ? <span class="number">-1</span> : <span class="number">1</span>) * to;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">()</span> </span>&#123; <span class="comment">// AC automation</span></span><br><span class="line">        queue&lt;<span class="keyword">int</span>&gt; Q;</span><br><span class="line">        <span class="keyword">int</span> u, p, to, pto;</span><br><span class="line">        Q.<span class="built_in">push</span>(<span class="number">0</span>), A[<span class="number">0</span>].fail = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">while</span> (!Q.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            u = Q.<span class="built_in">front</span>(), Q.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; MAXC; i++) &#123;</span><br><span class="line">                to = <span class="built_in">abs</span>(A[u].base) + i;</span><br><span class="line">                <span class="keyword">if</span> (u != <span class="built_in">abs</span>(A[to].check))	</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                Q.<span class="built_in">push</span>(to);</span><br><span class="line">                p = A[u].fail;</span><br><span class="line">                <span class="keyword">while</span> (p != <span class="number">-1</span>) &#123;</span><br><span class="line">                    pto = <span class="built_in">abs</span>(A[p].base) + i;</span><br><span class="line">                    <span class="keyword">if</span> (p != <span class="built_in">abs</span>(A[pto].check))</span><br><span class="line">                        p = A[p].fail;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="number">-1</span>)</span><br><span class="line">                    A[to].fail = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    A[to].fail = <span class="built_in">abs</span>(A[p].base) + i;</span><br><span class="line">                A[to].val = A[A[to].fail].val + (A[to].base &lt; <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> st = <span class="number">0</span>, c, to;</span><br><span class="line">        <span class="keyword">int</span> matched = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; s[i]; i++) &#123;</span><br><span class="line">            c = <span class="built_in">toIndex</span>(s[i]);</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                to = <span class="built_in">abs</span>(A[st].base) + c;</span><br><span class="line">                <span class="keyword">if</span> (st != <span class="built_in">abs</span>(A[to].check) &amp;&amp; st != <span class="number">0</span>)</span><br><span class="line">                    st = A[st].fail;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line">            to = <span class="built_in">abs</span>(A[st].base) + c;</span><br><span class="line">            <span class="keyword">if</span> (st != <span class="built_in">abs</span>(A[to].check))</span><br><span class="line">                st = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                st = to;</span><br><span class="line">            matched += A[st].val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> matched;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; tree;</span><br><span class="line"><span class="keyword">char</span> s[<span class="number">1048576</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, m, cases = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;n) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Case #%d:\n&quot;</span>, ++cases);</span><br><span class="line">        tree.<span class="built_in">init</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s);</span><br><span class="line">            tree.<span class="built_in">insert</span>(s);</span><br><span class="line">        &#125;</span><br><span class="line">        tree.<span class="built_in">build</span>();</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;m);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s);</span><br><span class="line">            <span class="keyword">int</span> t = tree.<span class="built_in">query</span>(s);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="vector-base"><a href="#vector-base" class="headerlink" title="vector + base"></a>vector + base</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXCHAR 62</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXS (3000005)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXNODE 1200000</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ACmachine</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">    	vector&lt;Node*&gt; link;</span><br><span class="line">        Node *fail;</span><br><span class="line">        <span class="keyword">int</span> cnt, val, base;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;</span><br><span class="line">            fail = <span class="literal">NULL</span>;</span><br><span class="line">            cnt = val = <span class="number">0</span>;</span><br><span class="line">            base = <span class="number">128</span>, link = vector&lt;Node*&gt;(<span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">Node* <span class="title">next</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">        	<span class="keyword">if</span> (c - base &lt; <span class="number">0</span>)				<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        	<span class="keyword">if</span> (c - base &gt;= link.<span class="built_in">size</span>())	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        	<span class="keyword">return</span> link[c - base];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">change</span><span class="params">(<span class="keyword">int</span> c, Node *p)</span> </span>&#123;</span><br><span class="line">        	<span class="keyword">if</span> (c &gt;= base &amp;&amp; c - base &lt; link.<span class="built_in">size</span>()) &#123;</span><br><span class="line">        		link[c-base] = p;</span><br><span class="line">        	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        		<span class="keyword">int</span> nb = <span class="built_in">min</span>(base, c), mx = <span class="built_in">max</span>(base+(<span class="keyword">int</span>)link.<span class="built_in">size</span>()<span class="number">-1</span>, c);</span><br><span class="line">        		<span class="keyword">if</span> (base == <span class="number">128</span>)	mx = c;</span><br><span class="line">        		<span class="function">vector&lt;Node*&gt; <span class="title">co</span><span class="params">(mx-nb+<span class="number">1</span>, <span class="literal">NULL</span>)</span></span>;</span><br><span class="line">        		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; link.<span class="built_in">size</span>(); i++)</span><br><span class="line">        			co[i+base-nb] = link[i];</span><br><span class="line">        		link = co, base = nb;</span><br><span class="line">        		link[c-base] = p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; nodes[MAXNODE];</span><br><span class="line">    Node *root;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">    <span class="function">Node* <span class="title">getNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    	<span class="built_in">assert</span>(size &lt; MAXNODE);</span><br><span class="line">        Node *p = &amp;nodes[size++];</span><br><span class="line">        *p = <span class="built_in">Node</span>();</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        size = <span class="number">0</span>;</span><br><span class="line">        root = <span class="built_in">getNode</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">toIndex</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">isdigit</span>(c))	<span class="keyword">return</span> c - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">isupper</span>(c)) <span class="keyword">return</span> c - <span class="string">&#x27;A&#x27;</span> + <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">islower</span>(c))	<span class="keyword">return</span> c - <span class="string">&#x27;a&#x27;</span> + <span class="number">26</span> + <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> str[])</span> </span>&#123;</span><br><span class="line">        Node *p = root;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, idx; str[i]; i++) &#123;</span><br><span class="line">            idx = <span class="built_in">toIndex</span>(str[i]);</span><br><span class="line">            <span class="keyword">if</span> (p-&gt;<span class="built_in">next</span>(idx) == <span class="literal">NULL</span>)</span><br><span class="line">                p-&gt;<span class="built_in">change</span>(idx, <span class="built_in">getNode</span>());</span><br><span class="line">            p = p-&gt;<span class="built_in">next</span>(idx);</span><br><span class="line">        &#125;</span><br><span class="line">        p-&gt;cnt = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">()</span> </span>&#123; <span class="comment">// AC automation</span></span><br><span class="line">        queue&lt;Node*&gt; Q;</span><br><span class="line">        Node *u, *p;</span><br><span class="line">        Q.<span class="built_in">push</span>(root), root-&gt;fail = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">while</span> (!Q.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            u = Q.<span class="built_in">front</span>(), Q.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAXCHAR; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (u-&gt;<span class="built_in">next</span>(i) == <span class="literal">NULL</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                Q.<span class="built_in">push</span>(u-&gt;<span class="built_in">next</span>(i));</span><br><span class="line">                p = u-&gt;fail;</span><br><span class="line">                <span class="keyword">while</span> (p != <span class="literal">NULL</span> &amp;&amp; p-&gt;<span class="built_in">next</span>(i) == <span class="literal">NULL</span>)</span><br><span class="line">                    p = p-&gt;fail;</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">                    u-&gt;<span class="built_in">next</span>(i)-&gt;fail = root;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    u-&gt;<span class="built_in">next</span>(i)-&gt;fail = p-&gt;<span class="built_in">next</span>(i);</span><br><span class="line">                u-&gt;<span class="built_in">next</span>(i)-&gt;val = u-&gt;<span class="built_in">next</span>(i)-&gt;fail-&gt;val + u-&gt;<span class="built_in">next</span>(i)-&gt;cnt;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> str[])</span> </span>&#123;</span><br><span class="line">        Node *u = root, *p;</span><br><span class="line">        <span class="keyword">int</span> matched = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, idx; str[i]; i++) &#123;</span><br><span class="line">            idx = <span class="built_in">toIndex</span>(str[i]);</span><br><span class="line">            <span class="keyword">while</span> (u-&gt;<span class="built_in">next</span>(idx) == <span class="literal">NULL</span> &amp;&amp; u != root)</span><br><span class="line">                u = u-&gt;fail;</span><br><span class="line">            u = u-&gt;<span class="built_in">next</span>(idx);</span><br><span class="line">            u = (u == <span class="literal">NULL</span>) ? root : u;</span><br><span class="line">            p = u;</span><br><span class="line">            matched += p-&gt;val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> matched;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">ACmachine disk;</span><br><span class="line"><span class="keyword">char</span> s[<span class="number">1048576</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, m, cases = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;n) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Case #%d:\n&quot;</span>, ++cases);</span><br><span class="line">        disk.<span class="built_in">init</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s);</span><br><span class="line">            disk.<span class="built_in">insert</span>(s);</span><br><span class="line">        &#125;</span><br><span class="line">        disk.<span class="built_in">build</span>();</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;m);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s);</span><br><span class="line">            <span class="keyword">int</span> t = disk.<span class="built_in">query</span>(s);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, t);</span><br><span class="line">        &#125;</span><br><span class="line">        disk.<span class="built_in">free</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b494" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/19/zj-b494/" class="article-date">
  <time datetime="2015-08-19T07:14:02.000Z" itemprop="datePublished">2015-08-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/19/zj-b494/">b494. 史蒂芙的修羅道</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/08/19/zj-b494/" data-id="ckpaivcab00btn8vnakkrdmi9" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/08/19/zj-b494/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LCA/">LCA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RMQ/">RMQ</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/morris-traversal/">morris traversal</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tarjan/">tarjan</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/笛卡爾樹/">笛卡爾樹</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>史蒂芙被王國政務工作忙昏頭，每次都要求效率的極限，即使不會玩遊戲，只要把政務工作處理到極致，想必這就是另一種人生價值。</p>
<h3 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h3><p>回顧一個經典問題區間極大極小值詢問 RMQ，她收到下面這一份代碼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;bits/stdc++.h&gt;</span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">unsigned int seed = 0;</span><br><span class="line">unsigned int p_random() &#123;return seed = (seed*9301+49297);&#125;</span><br><span class="line"></span><br><span class="line">unsigned int A[5000005];</span><br><span class="line">int main() &#123;</span><br><span class="line">    int N, M, S, x, y;</span><br><span class="line">    unsigned int hash = 0;</span><br><span class="line">    scanf(&quot;%d %d %d&quot;, &amp;N, &amp;M, &amp;S);</span><br><span class="line">    seed = S;</span><br><span class="line">    for (int i = 1; i &lt;= N; i++)</span><br><span class="line">        A[i] = p_random();</span><br><span class="line">    for (int i = 0; i &lt; M; i++) &#123;</span><br><span class="line">        x = p_random()%N+1, y = p_random()%N+1;</span><br><span class="line">        if (x &gt; y)	swap(x, y);</span><br><span class="line">        unsigned int max_val = A[x];</span><br><span class="line">        for (int j = x; j &lt;= y; j++)</span><br><span class="line">            max_val = max(max_val, A[j]);</span><br><span class="line">        hash ^= max_val; </span><br><span class="line">    &#125;</span><br><span class="line">    printf(&quot;%lu\n&quot;, hash);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>「給定 <span>$N$</span><!-- Has MathJax --> 個整數、<span>$M$</span><!-- Has MathJax --> 個詢問操作、<span>$S$</span><!-- Has MathJax --> 為亂數種子，接著產生 <span>$N$</span><!-- Has MathJax --> 個數字，對於接下來 <span>$M$</span><!-- Has MathJax --> 個詢問，每一個詢問兩個整數，輸出區間內的最大值。」這對曾經的史蒂芙而言，用過 Segment Tree、Sparse Table、Unrolled Linked List 解決過，時間、空間複雜度都非常優秀。</p>
<p>現在的工作就是加速這一份代碼。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">8 5 10</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4049919279</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>經典 RMQ 問題，主要有以下四種，最後一種只支持離線不帶修改的操作。</p>
<ul>
<li>sqrt-decomposition <span>$O(N)$</span><!-- Has MathJax --> - <span>$O(\sqrt{N})$</span><!-- Has MathJax --></li>
<li>sparse table <span>$O(N \log N)$</span><!-- Has MathJax --> - <span>$O(1)$</span><!-- Has MathJax --></li>
<li>segment tree <span>$O(N)$</span><!-- Has MathJax --> - <span>$O(\log N)$</span><!-- Has MathJax --></li>
<li>cartesian tree + tarjan LCA algorithm + morris traversal <span>$O(N + Q)$</span><!-- Has MathJax --></li>
</ul>
<p>於是出了這一題 b494. 史蒂芙的修羅道，把第一種算法卡時間、第二種算法卡空間、第三種算法卡常數。</p>
<p>實作起來非常變態，速度一不小心就會輸非遞迴的 segment tree (zkw 線段樹或者稱做 non-recursive segment tree 的實作技巧，詳見 <a href="http://codeforces.com/blog/entry/18051">codeforce - Efficient and easy segment trees</a> )，儘管如此還是卡不住這類的實作，但時間上把遞迴實作的版本卡 TLE，速度略贏 prefect tree 的 segment tree 的實作，但使用空間多了兩倍。</p>
<ul>
<li>不開 <code>std::vector</code>，否則記憶體會預保留一倍。</li>
<li>使用 tarjan LCA algorithm 在笛卡爾樹二元樹上時要特化操作。</li>
<li>無法使用遞迴，實作非遞迴的二元搜尋樹走訪常數要注意。</li>
</ul>
<p>通常 tarjan LCA algorithm 會把一個詢問拆成兩個詢問，常數會多 1。在笛卡爾樹上有一個性質，每一個節點的狀態為 <code>&lt;key, value&gt;</code> 看 key 仍然是一個二元搜尋樹，看 value 是一個 heap，在完成 tarjan LCA algorithm 需要的是後序走訪，能保證回答 <code>LCA(x, y)</code> 的順序。假設詢問 <code>LCA(x, y) &amp;&amp; x &lt; y</code> 只需要在 y 節點準備詢問 x 即可。</p>
<p>若要降空間複雜度常數，利用 morris traversal 在空間複雜度 <span>$O(1)$</span><!-- Has MathJax --> 完成。若使用 <code>stack&lt;&gt;</code> 模擬 tarjan LCA algorithm，最慘的空間複雜度是 <span>$O(N)$</span><!-- Has MathJax -->。</p>
<h3 id="morris-traversal"><a href="#morris-traversal" class="headerlink" title="morris traversal"></a>morris traversal</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">5000005</span>, MAXQ = <span class="number">5000005</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> idx;</span><br><span class="line">    Node *ch[<span class="number">2</span>], *fa;</span><br><span class="line">    <span class="built_in">Node</span>() &#123;</span><br><span class="line">        idx = <span class="number">0</span>;</span><br><span class="line">        ch[<span class="number">0</span>] = ch[<span class="number">1</span>] = fa = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; nodes[MAXN];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">QEdge</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> u;</span><br><span class="line">    QEdge *next;</span><br><span class="line">&#125;;</span><br><span class="line">QEdge qedge[MAXQ], *qadj[MAXN] = &#123;&#125;;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> A[MAXN], eq, ret;</span><br><span class="line"><span class="keyword">int</span> parent[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    eq = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= n; i++)</span><br><span class="line">        parent[i] = i <span class="comment">/*, qadj[i] = NULL */</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(Node *u, Node *p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (A[p-&gt;idx] &lt; A[u-&gt;idx])	p = p-&gt;fa;</span><br><span class="line">    u-&gt;ch[<span class="number">0</span>] = p-&gt;ch[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;ch[<span class="number">1</span>])	p-&gt;ch[<span class="number">1</span>]-&gt;fa = u;</span><br><span class="line">    p-&gt;ch[<span class="number">1</span>] = u;</span><br><span class="line">    u-&gt;fa = p;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span> N)</span> </span>&#123;</span><br><span class="line">    nodes[<span class="number">0</span>] = <span class="built_in">Node</span>(), A[<span class="number">0</span>] = UINT_MAX;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++) &#123;</span><br><span class="line">        nodes[i] = <span class="built_in">Node</span>(), nodes[i].idx = i;</span><br><span class="line">        <span class="built_in">insert</span>(&amp;nodes[i], &amp;nodes[i<span class="number">-1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">findp</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> parent[x] == x ? x : parent[x]=<span class="built_in">findp</span>(parent[x]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tree_reverse</span><span class="params">(Node *from, Node *to)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (from == to)	<span class="keyword">return</span> ;</span><br><span class="line">    Node *x = from, *y = from-&gt;ch[<span class="number">1</span>], *z;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        z = y-&gt;ch[<span class="number">1</span>];</span><br><span class="line">        y-&gt;ch[<span class="number">1</span>] = x;</span><br><span class="line">        x = y, y = z;</span><br><span class="line">        <span class="keyword">if</span> (x == to)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_reverse</span><span class="params">(Node *from, Node *to)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">tree_reverse</span>(from, to);</span><br><span class="line">    Node *p = to;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> u = p-&gt;idx;</span><br><span class="line">        <span class="keyword">for</span> (QEdge *e = qadj[u]; e; e = e-&gt;next)</span><br><span class="line">            ret ^= A[<span class="built_in">findp</span>(e-&gt;u)];</span><br><span class="line">        <span class="keyword">if</span> (p-&gt;fa != <span class="literal">NULL</span>)	parent[<span class="built_in">findp</span>(u)] = p-&gt;fa-&gt;idx;</span><br><span class="line">        <span class="keyword">if</span> (p == from)	<span class="keyword">break</span>;</span><br><span class="line">        p = p-&gt;ch[<span class="number">1</span>];</span><br><span class="line">    &#125;		</span><br><span class="line">    <span class="built_in">tree_reverse</span>(to, from);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tarjan</span><span class="params">(Node *root)</span> </span>&#123;	</span><br><span class="line">    Node *cur, *prev, tmp;</span><br><span class="line">    tmp.ch[<span class="number">0</span>] = root;</span><br><span class="line">    cur = &amp;tmp, prev = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">while</span> (cur != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cur-&gt;ch[<span class="number">0</span>] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            cur = cur-&gt;ch[<span class="number">1</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            prev = cur-&gt;ch[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">while</span> (prev-&gt;ch[<span class="number">1</span>] != <span class="literal">NULL</span> &amp;&amp; prev-&gt;ch[<span class="number">1</span>] != cur)</span><br><span class="line">                prev = prev-&gt;ch[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (prev-&gt;ch[<span class="number">1</span>] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                prev-&gt;ch[<span class="number">1</span>] = cur, cur = cur-&gt;ch[<span class="number">0</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">print_reverse</span>(cur-&gt;ch[<span class="number">0</span>], prev);</span><br><span class="line">                prev-&gt;ch[<span class="number">1</span>] = <span class="literal">NULL</span>, cur = cur-&gt;ch[<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> qid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; y)	<span class="built_in">swap</span>(x, y);</span><br><span class="line">    qedge[eq].u = y, qedge[eq].next = qadj[x], qadj[x] = &amp;qedge[eq++];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> seed = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">gen</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> seed = (seed*<span class="number">9301</span>+<span class="number">49297</span>);&#125;</span><br><span class="line"><span class="keyword">int</span> N, M, S, x, y;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d %d %d&quot;</span>, &amp;N, &amp;M, &amp;S);</span><br><span class="line">    seed = S, <span class="built_in">init</span>(N);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">        x = <span class="built_in">gen</span>(), A[i] = x;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; M; i++) &#123;</span><br><span class="line">        x = <span class="built_in">gen</span>()%N+<span class="number">1</span>, y = <span class="built_in">gen</span>()%N+<span class="number">1</span>;</span><br><span class="line">        <span class="built_in">add</span>(x, y, i);</span><br><span class="line">    &#125;</span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">build</span>(N), <span class="built_in">tarjan</span>(nodes[<span class="number">0</span>].ch[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lu\n&quot;</span>, ret);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="stack"><a href="#stack" class="headerlink" title="stack"></a>stack</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">5000005</span>, MAXQ = <span class="number">5000005</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> idx;</span><br><span class="line">    Node *ch[<span class="number">2</span>], *fa;</span><br><span class="line">    <span class="built_in">Node</span>() &#123;</span><br><span class="line">        idx = <span class="number">0</span>;</span><br><span class="line">        ch[<span class="number">0</span>] = ch[<span class="number">1</span>] = fa = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; nodes[MAXN];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">QEdge</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> u;</span><br><span class="line">    QEdge *next;</span><br><span class="line">&#125;;</span><br><span class="line">QEdge qedge[MAXQ], *qadj[MAXN] = &#123;&#125;;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> A[MAXN], eq, ret;</span><br><span class="line"><span class="keyword">int</span> parent[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    eq = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= n; i++)</span><br><span class="line">        parent[i] = i <span class="comment">/*, qadj[i] = NULL */</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(Node *u, Node *p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (A[p-&gt;idx] &lt; A[u-&gt;idx])	p = p-&gt;fa;</span><br><span class="line">    u-&gt;ch[<span class="number">0</span>] = p-&gt;ch[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;ch[<span class="number">1</span>])	p-&gt;ch[<span class="number">1</span>]-&gt;fa = u;</span><br><span class="line">    p-&gt;ch[<span class="number">1</span>] = u;</span><br><span class="line">    u-&gt;fa = p;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span> N)</span> </span>&#123;</span><br><span class="line">    nodes[<span class="number">0</span>] = <span class="built_in">Node</span>(), A[<span class="number">0</span>] = UINT_MAX;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++) &#123;</span><br><span class="line">        nodes[i] = <span class="built_in">Node</span>(), nodes[i].idx = i;</span><br><span class="line">        <span class="built_in">insert</span>(&amp;nodes[i], &amp;nodes[i<span class="number">-1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">findp</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> parent[x] == x ? x : parent[x]=<span class="built_in">findp</span>(parent[x]);</span><br><span class="line">&#125;</span><br><span class="line">pair&lt;Node*, <span class="keyword">int</span>&gt; stk[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tarjan</span><span class="params">(Node *root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> top = <span class="number">-1</span>, u;</span><br><span class="line">    Node *p;</span><br><span class="line">    stk[++top] = &#123;root, <span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span> (top &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        pair&lt;Node*, <span class="keyword">int</span>&gt; &amp;x = stk[top];</span><br><span class="line">        x.second++;</span><br><span class="line">        <span class="keyword">if</span> (x.second == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (x.first-&gt;ch[<span class="number">0</span>])</span><br><span class="line">                stk[++top] = &#123;x.first-&gt;ch[<span class="number">0</span>], <span class="number">0</span>&#125;;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x.second == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (x.first-&gt;ch[<span class="number">1</span>])</span><br><span class="line">                stk[++top] = &#123;x.first-&gt;ch[<span class="number">1</span>], <span class="number">0</span>&#125;;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            top--;</span><br><span class="line">            p = x.first, u = p-&gt;idx;</span><br><span class="line">            <span class="keyword">for</span> (QEdge *e = qadj[u]; e; e = e-&gt;next)</span><br><span class="line">                ret ^= A[<span class="built_in">findp</span>(e-&gt;u)];</span><br><span class="line">            parent[<span class="built_in">findp</span>(u)] = p-&gt;fa-&gt;idx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> qid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; y)	<span class="built_in">swap</span>(x, y);</span><br><span class="line">    qedge[eq].u = y, qedge[eq].next = qadj[x], qadj[x] = &amp;qedge[eq++];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> seed = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">gen</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> seed = (seed*<span class="number">9301</span>+<span class="number">49297</span>);&#125;</span><br><span class="line"><span class="keyword">int</span> N, M, S, x, y;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d %d %d&quot;</span>, &amp;N, &amp;M, &amp;S);</span><br><span class="line">    seed = S, <span class="built_in">init</span>(N);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">        A[i] = <span class="built_in">gen</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; M; i++) &#123;</span><br><span class="line">        x = <span class="built_in">gen</span>()%N+<span class="number">1</span>, y = <span class="built_in">gen</span>()%N+<span class="number">1</span>;</span><br><span class="line">        <span class="built_in">add</span>(x, y, i);</span><br><span class="line">    &#125;</span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">build</span>(N), <span class="built_in">tarjan</span>(nodes[<span class="number">0</span>].ch[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lu\n&quot;</span>, ret);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b493" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/19/zj-b493/" class="article-date">
  <time datetime="2015-08-19T04:08:02.000Z" itemprop="datePublished">2015-08-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/19/zj-b493/">b493. 史蒂芙的外交夥伴</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/08/19/zj-b493/" data-id="ckpaivcab00bsn8vn6x0zdngg" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/08/19/zj-b493/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LCA/">LCA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/函數式線段樹/">函數式線段樹</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/可持久化/">可持久化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/啟發式合併/">啟發式合併</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>史蒂芙終於有了夥伴，夥伴們各自為了人類國家出訪外交，在大陸版圖中有 <span>$N$</span><!-- Has MathJax --> 個小城市，每個城市都有各自的文明發展程度 <span>$A_i$</span><!-- Has MathJax -->，史蒂芙的夥伴擁有各自能力 <span>$K$</span><!-- Has MathJax --> 只能選擇文明發展程度 <span>$A_i$</span><!-- Has MathJax --> 小於等於 <span>$K$</span><!-- Has MathJax --> 的國家拜訪。一開始國家跟國家之間彼此不相連，隨著外交拓展，小城市決定為史蒂芙的人類國家開一條道路通行另一個小城市，但如果這兩個小城市可以藉由直接相連或間接相連，那這一條道路將不會被建造。</p>
<p>礙於時間有限，史蒂芙手頭上有數個計劃，打算對起點城市到終點城市策劃行程，現在請你算出所有計畫的走訪個數。</p>
<h3 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h3><p>給定 <span>$N$</span><!-- Has MathJax --> 個城市版圖以及 <span>$Q$</span><!-- Has MathJax --> 個詢問，一開始城市彼此都不相連，詢問操作有以下兩種</p>
<ul>
<li><code>0 X Y</code>  建造城市編號 X 到城市編號 Y 的雙向道路。如果 X 和 Y 本身已經直接相連或間接相連，則忽略此操作。</li>
<li><code>1 X Y K</code> 詢問路線 X 到 Y 的行程規劃，當夥伴的能力為 <span>$K$</span><!-- Has MathJax --> 能走訪的國家個數。</li>
</ul>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">7 11</span><br><span class="line">1 5 2 6 3 7 4</span><br><span class="line">0 2 4</span><br><span class="line">0 1 2</span><br><span class="line">0 1 3</span><br><span class="line">0 3 7</span><br><span class="line">1 4 7 3</span><br><span class="line">1 7 4 5</span><br><span class="line">0 2 5</span><br><span class="line">0 5 3</span><br><span class="line">1 1 4 5</span><br><span class="line">0 1 4</span><br><span class="line">1 7 4 6</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2</span><br><span class="line">0</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>在樹上套用函數式線段樹，維護有根樹和 LCA 的操作，將父節點的線段樹狀態傳遞給子節點進行持久化的變動，詢問 x 到 y 路徑時利用區間加減法，計算 x, y, LCA(x, y) 到根的符合條件的數量，統計一下即可。</p>
<p>由於一開始不是完整的一棵樹，會逐漸合成一棵樹，利用啟發式合併，也就是最傳統的合併操作，將小的集合合併到大的集合，合併複雜度為小集合的大小，那複雜度保證 <span>$O(N \log N)$</span><!-- Has MathJax -->。</p>
<p>在套用函數式線段樹後，合併操作必須在 <span>$O(N \log N)$</span><!-- Has MathJax --> 時間完成，空間複雜度也是 <span>$O(N \log N)$</span><!-- Has MathJax -->，因此完全所有合併操作需要 <span>$O(N \log^2 N)$</span><!-- Has MathJax --> 的時間，空間複雜度仍然是 <span>$O(N \log N)$</span><!-- Has MathJax -->，若沒有搭配垃圾回收，空間會變成 <span>$O(N \log^2 N)$</span><!-- Has MathJax --> 的需求。</p>
<p>關於垃圾回收，建議使用 <code>std::queue&lt;&gt;</code> 完成，因為佔有空間少空間常數是 2，若使用 <code>std::vector&lt;&gt;</code> 空間常數是 2，但多餘的部分保證不會用到，就變得相當浪費。一旦支持垃圾回收，空間使用會逐漸變得不連續性，碎片化會造成 cache 的能力降低。速度上會慢上許多。若預先支付空間或者直接浪費 <span>$O(N \log^2 N)$</span><!-- Has MathJax --> 的空間都是可以被接受的方案。</p>
<p>在 LCA 計算，需要 <span>$O(N \log N)$</span><!-- Has MathJax --> 的時間建表以及 <span>$O(N \log N)$</span><!-- Has MathJax --> 的空間，詢問複雜度是 <span>$O(\log N)$</span><!-- Has MathJax -->。若要降空間複雜度為 <span>$O(N)$</span><!-- Has MathJax -->，可以用 Link/Cut Tree 代替，由於 splay tree 實作關係，時間複雜度常數略個三四倍。</p>
<h3 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SegementTree</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1000000</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXV = <span class="number">50005</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        Node *lson, *rson;</span><br><span class="line">        <span class="keyword">int</span> sum;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;</span><br><span class="line">        	lson = rson = <span class="literal">NULL</span>;</span><br><span class="line">        	sum = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; _mem[MAXN];</span><br><span class="line">    <span class="keyword">int</span> L, R, V, mem_buf, mem_idx;</span><br><span class="line">    queue&lt;Node*&gt; mem_bin[MAXV], bin;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">clear_bin</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (!mem_bin[x].<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            <span class="built_in">recycle</span>(mem_bin[x].<span class="built_in">front</span>());</span><br><span class="line">            mem_bin[x].<span class="built_in">pop</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">recycle</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        bin.<span class="built_in">push</span>(x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">init</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">        L = l, R = r, V = v;</span><br><span class="line">        mem_buf = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= v; i++) &#123;</span><br><span class="line">            <span class="keyword">while</span> (!mem_bin[i].<span class="built_in">empty</span>())	mem_bin[i].<span class="built_in">pop</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (!bin.<span class="built_in">empty</span>())	bin.<span class="built_in">pop</span>();</span><br><span class="line">        Node* root = <span class="built_in">build</span>(l, r);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node *u;</span><br><span class="line">        <span class="keyword">if</span> (mem_buf &lt; MAXN) &#123;</span><br><span class="line">            u = &amp;_mem[mem_buf++];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">assert</span>(!bin.<span class="built_in">empty</span>());</span><br><span class="line">            u = bin.<span class="built_in">front</span>(), bin.<span class="built_in">pop</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        *u = <span class="built_in">Node</span>();</span><br><span class="line">        mem_bin[mem_idx].<span class="built_in">push</span>(u);</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">cloneNode</span><span class="params">(Node *p)</span> </span>&#123;</span><br><span class="line">        Node* u = <span class="built_in">newNode</span>();</span><br><span class="line">        *u = *p;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">build</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (l &gt; r)  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        Node *u = <span class="built_in">newNode</span>();</span><br><span class="line">        <span class="keyword">if</span> (l == r) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> m = (l + r)/<span class="number">2</span>;</span><br><span class="line">        	u-&gt;lson = <span class="built_in">build</span>(l, m);</span><br><span class="line">        	u-&gt;rson = <span class="built_in">build</span>(m+<span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">change</span><span class="params">(Node *p, <span class="keyword">int</span> x, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">assert</span>(p != <span class="literal">NULL</span>);</span><br><span class="line">        Node *u = <span class="built_in">cloneNode</span>(p);</span><br><span class="line">        u-&gt;sum++;</span><br><span class="line">        <span class="keyword">if</span> (l == r) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        	<span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">        	<span class="keyword">if</span> (x &lt;= mid)</span><br><span class="line">            	u-&gt;lson = <span class="built_in">change</span>(p-&gt;lson, x, l, mid);</span><br><span class="line">        	<span class="keyword">else</span></span><br><span class="line">         		u-&gt;rson = <span class="built_in">change</span>(p-&gt;rson, x, mid+<span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">change</span><span class="params">(Node *p, <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">change</span>(p, x, L, R);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> QD;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">find</span><span class="params">(Node *v1, <span class="keyword">int</span> x, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> &lt;= l &amp;&amp; r &lt;= x) &#123;</span><br><span class="line">        	QD += v1-&gt;sum;</span><br><span class="line">        	<span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (x &lt;= mid) &#123;</span><br><span class="line">            <span class="built_in">find</span>(v1-&gt;lson, x, l, mid);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">find</span>(v1-&gt;lson, x, l, mid);</span><br><span class="line">            <span class="built_in">find</span>(v1-&gt;rson, x, mid+<span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(Node *v1, <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        QD = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">find</span>(v1, x, L, R);</span><br><span class="line">        <span class="keyword">return</span> QD;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; tree;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">65536</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXLOGN = <span class="number">17</span>;</span><br><span class="line">SegementTree::Node *root[MAXN];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> A[MAXN];</span><br><span class="line"><span class="keyword">int</span> fa[MAXLOGN][MAXN], dep[MAXN];</span><br><span class="line"><span class="keyword">int</span> parent[MAXN], weight[MAXN];</span><br><span class="line">vector&lt;<span class="keyword">int</span>&gt; g[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> p, vector&lt;<span class="keyword">int</span>&gt; &amp;vA)</span> </span>&#123;</span><br><span class="line">    root[u] = tree.<span class="built_in">change</span>(root[p], A[u]);</span><br><span class="line">    fa[<span class="number">0</span>][u] = p, dep[u] = dep[p] + <span class="number">1</span>;</span><br><span class="line">    vA.<span class="built_in">push_back</span>(u);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> v : g[u]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (v == p)	<span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">dfs</span>(v, u, vA);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">findp</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x == parent[x] ? x : (parent[x]=<span class="built_in">findp</span>(parent[x]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">LCA</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (dep[x] &lt; dep[y])	<span class="built_in">swap</span>(x, y);</span><br><span class="line">    <span class="keyword">int</span> d = dep[x] - dep[y];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = MAXLOGN<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((d&gt;&gt;i)&amp;<span class="number">1</span>) &#123;</span><br><span class="line">            d -= <span class="number">1</span>&lt;&lt;i;</span><br><span class="line">            x = fa[i][x];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (x == y)	<span class="keyword">return</span> x;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = MAXLOGN<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fa[i][x] != fa[i][y]) &#123;</span><br><span class="line">            x = fa[i][x], y = fa[i][y];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fa[<span class="number">0</span>][x];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span> X, <span class="keyword">int</span> Y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">findp</span>(X) == <span class="built_in">findp</span>(Y))	<span class="keyword">return</span> ;</span><br><span class="line">    <span class="keyword">int</span> rx, ry;</span><br><span class="line">    rx = <span class="built_in">findp</span>(X), ry = <span class="built_in">findp</span>(Y);</span><br><span class="line">    <span class="keyword">if</span> (weight[rx] &lt; weight[ry])	<span class="built_in">swap</span>(rx, ry), <span class="built_in">swap</span>(X, Y);</span><br><span class="line">    g[X].<span class="built_in">push_back</span>(Y), g[Y].<span class="built_in">push_back</span>(X);</span><br><span class="line">    <span class="comment">// merge Y&#x27;s group into X&#x27;s group</span></span><br><span class="line">    tree.<span class="built_in">clear_bin</span>(ry), tree.mem_idx = rx;</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; vA;</span><br><span class="line">    <span class="built_in">dfs</span>(Y, X, vA);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; MAXLOGN; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> j : vA)</span><br><span class="line">            fa[i][j] = fa[i<span class="number">-1</span>][fa[i<span class="number">-1</span>][j]];</span><br><span class="line">    &#125;	</span><br><span class="line">    parent[ry] = rx, weight[rx] += weight[ry];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">path</span><span class="params">(<span class="keyword">int</span> X, <span class="keyword">int</span> Y, <span class="keyword">int</span> K)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">findp</span>(X) != <span class="built_in">findp</span>(Y))	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> rx, ry, lca;</span><br><span class="line">    rx = <span class="built_in">findp</span>(X), ry = <span class="built_in">findp</span>(Y);</span><br><span class="line">    lca = <span class="built_in">LCA</span>(X, Y);</span><br><span class="line">    <span class="keyword">int</span> ret = tree.<span class="built_in">find</span>(root[X], K) + tree.<span class="built_in">find</span>(root[Y], K) - tree.<span class="built_in">find</span>(root[lca], K) * <span class="number">2</span>;</span><br><span class="line">    ret += A[lca] &lt;= K;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> N, Q, cmd;</span><br><span class="line">    <span class="keyword">int</span> X, Y, K;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;N, &amp;Q) == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;A[i]);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">            parent[i] = i, weight[i] = <span class="number">1</span>, g[i].<span class="built_in">clear</span>(), dep[i] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAXLOGN; i++)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= N; j++)</span><br><span class="line">                fa[i][j] = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">        tree.mem_idx = <span class="number">0</span>;</span><br><span class="line">        root[<span class="number">0</span>] = tree.<span class="built_in">init</span>(<span class="number">1</span>, N, N);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">            root[i] = root[<span class="number">0</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> d = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Q; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d %d&quot;</span>, &amp;cmd, &amp;X, &amp;Y);</span><br><span class="line">            X ^= d, Y ^= d;</span><br><span class="line">            <span class="keyword">if</span> (cmd == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">merge</span>(X, Y);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;K), K ^= d;</span><br><span class="line">                d = <span class="built_in">path</span>(X, Y, K);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, d);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="預先支付空間"><a href="#預先支付空間" class="headerlink" title="預先支付空間"></a>預先支付空間</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">log2int</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> __builtin_clz((<span class="keyword">int</span>)<span class="number">1</span>)-__builtin_clz(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SegementTree</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1000000</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXV = <span class="number">50005</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        Node *lson, *rson;</span><br><span class="line">        <span class="keyword">int</span> sum;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;</span><br><span class="line">        	lson = rson = <span class="literal">NULL</span>;</span><br><span class="line">        	sum = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; _mem[MAXN];</span><br><span class="line">    <span class="keyword">int</span> L, R, V, mem_idx;</span><br><span class="line">    <span class="function">Node* <span class="title">init</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">        L = l, R = r, V = v;</span><br><span class="line">        mem_idx = <span class="number">0</span>;</span><br><span class="line">        Node* root = <span class="built_in">build</span>(l, r);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node *u = &amp;_mem[mem_idx++];</span><br><span class="line">        *u = <span class="built_in">Node</span>();</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//	inline Node* cloneNode(Node *p) &#123;</span></span><br><span class="line"><span class="comment">//		Node *u = &amp;_mem[mem_idx++];</span></span><br><span class="line"><span class="comment">//		*u = *p;</span></span><br><span class="line"><span class="comment">//		return u;</span></span><br><span class="line"><span class="comment">//	&#125;</span></span><br><span class="line">    <span class="function">Node* <span class="title">build</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (l &gt; r)  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        Node *u = <span class="built_in">newNode</span>();</span><br><span class="line">        <span class="keyword">if</span> (l == r) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> m = (l + r)/<span class="number">2</span>;</span><br><span class="line">        	u-&gt;lson = <span class="built_in">build</span>(l, m);</span><br><span class="line">        	u-&gt;rson = <span class="built_in">build</span>(m+<span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">change</span><span class="params">(Node *p, Node **sp, <span class="keyword">int</span> x, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line"><span class="comment">//		Node *u = cloneNode(p);</span></span><br><span class="line">        Node *u = *sp;</span><br><span class="line">        *u = *p;</span><br><span class="line">        u-&gt;sum++;</span><br><span class="line">        <span class="keyword">if</span> (l == r) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        	<span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">        	<span class="keyword">if</span> (x &lt;= mid)</span><br><span class="line">            	u-&gt;lson = <span class="built_in">change</span>(p-&gt;lson, sp+<span class="number">1</span>, x, l, mid);</span><br><span class="line">        	<span class="keyword">else</span></span><br><span class="line">         		u-&gt;rson = <span class="built_in">change</span>(p-&gt;rson, sp+<span class="number">1</span>, x, mid+<span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">change</span><span class="params">(Node *p, Node **sp, <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">change</span>(p, sp, x, L, R);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> QD;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">find</span><span class="params">(Node *v1, <span class="keyword">int</span> x, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> &lt;= l &amp;&amp; r &lt;= x) &#123;</span><br><span class="line">        	QD += v1-&gt;sum;</span><br><span class="line">        	<span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (x &lt;= mid) &#123;</span><br><span class="line">            <span class="built_in">find</span>(v1-&gt;lson, x, l, mid);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">find</span>(v1-&gt;lson, x, l, mid);</span><br><span class="line">            <span class="built_in">find</span>(v1-&gt;rson, x, mid+<span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(Node *v1, <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        QD = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">find</span>(v1, x, L, R);</span><br><span class="line">        <span class="keyword">return</span> QD;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; tree;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">50005</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXLOGN = <span class="number">17</span>;</span><br><span class="line">SegementTree::Node *root[MAXN], *pre_mem[MAXN][MAXLOGN];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> A[MAXN];</span><br><span class="line"><span class="keyword">int</span> fa[MAXN][MAXLOGN], dep[MAXN];</span><br><span class="line"><span class="keyword">int</span> parent[MAXN], weight[MAXN];</span><br><span class="line">vector&lt;<span class="keyword">int</span>&gt; g[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> p, vector&lt;<span class="keyword">int</span>&gt; &amp;vA)</span> </span>&#123;</span><br><span class="line">    root[u] = tree.<span class="built_in">change</span>(root[p], pre_mem[u], A[u]);</span><br><span class="line">    fa[u][<span class="number">0</span>] = p, dep[u] = dep[p] + <span class="number">1</span>;</span><br><span class="line">    vA.<span class="built_in">push_back</span>(u);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> v : g[u]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (v == p)	<span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">dfs</span>(v, u, vA);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">findp</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x == parent[x] ? x : (parent[x]=<span class="built_in">findp</span>(parent[x]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">LCA</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (dep[x] &lt; dep[y])	<span class="built_in">swap</span>(x, y);</span><br><span class="line">    <span class="keyword">int</span> d = dep[x] - dep[y];</span><br><span class="line">    <span class="keyword">int</span> LOGN = <span class="built_in">log2int</span>(dep[x]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = LOGN; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((d&gt;&gt;i)&amp;<span class="number">1</span>)</span><br><span class="line">            d -= <span class="number">1</span>&lt;&lt;i, x = fa[x][i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (x == y)	<span class="keyword">return</span> x;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = LOGN; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fa[x][i] != fa[y][i])</span><br><span class="line">            x = fa[x][i], y = fa[y][i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fa[x][<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span> X, <span class="keyword">int</span> Y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">findp</span>(X) == <span class="built_in">findp</span>(Y))	<span class="keyword">return</span> ;</span><br><span class="line">    <span class="keyword">int</span> rx, ry;</span><br><span class="line">    rx = <span class="built_in">findp</span>(X), ry = <span class="built_in">findp</span>(Y);</span><br><span class="line">    <span class="keyword">if</span> (weight[rx] &gt; weight[ry])	<span class="built_in">swap</span>(rx, ry), <span class="built_in">swap</span>(X, Y);</span><br><span class="line">    g[X].<span class="built_in">push_back</span>(Y), g[Y].<span class="built_in">push_back</span>(X);</span><br><span class="line">    <span class="comment">// merge Y&#x27;s group into X&#x27;s group</span></span><br><span class="line">    parent[rx] = ry, weight[ry] += weight[rx];</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; vA;</span><br><span class="line">    <span class="built_in">dfs</span>(X, Y, vA);</span><br><span class="line">    <span class="keyword">int</span> LOGN = <span class="built_in">log2int</span>(weight[ry]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= LOGN; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> j : vA)</span><br><span class="line">            fa[j][i] = fa[fa[j][i<span class="number">-1</span>]][i<span class="number">-1</span>];</span><br><span class="line">    &#125;	</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">path</span><span class="params">(<span class="keyword">int</span> X, <span class="keyword">int</span> Y, <span class="keyword">int</span> K)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">findp</span>(X) != <span class="built_in">findp</span>(Y))	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> lca = <span class="built_in">LCA</span>(X, Y);</span><br><span class="line">    <span class="keyword">int</span> ret = tree.<span class="built_in">find</span>(root[X], K) + tree.<span class="built_in">find</span>(root[Y], K) - tree.<span class="built_in">find</span>(root[lca], K) * <span class="number">2</span>;</span><br><span class="line">    ret += A[lca] &lt;= K;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> N, Q, cmd;</span><br><span class="line">    <span class="keyword">int</span> X, Y, K;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;N, &amp;Q) == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;A[i]);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">            parent[i] = i, weight[i] = <span class="number">1</span>, g[i].<span class="built_in">clear</span>(), dep[i] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAXLOGN; i++)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= N; j++)</span><br><span class="line">                fa[j][i] = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">        root[<span class="number">0</span>] = tree.<span class="built_in">init</span>(<span class="number">1</span>, N, N);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; MAXLOGN; j++)</span><br><span class="line">                pre_mem[i][j] = tree.<span class="built_in">newNode</span>();</span><br><span class="line">            root[i] = tree.<span class="built_in">change</span>(root[<span class="number">0</span>], pre_mem[i], A[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> d = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Q; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d %d&quot;</span>, &amp;cmd, &amp;X, &amp;Y);</span><br><span class="line">            X ^= d, Y ^= d;</span><br><span class="line">            <span class="keyword">if</span> (cmd == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">merge</span>(X, Y);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;K);</span><br><span class="line">                K ^= d;</span><br><span class="line">                d = <span class="built_in">path</span>(X, Y, K);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, d);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="內存用盡"><a href="#內存用盡" class="headerlink" title="內存用盡"></a>內存用盡</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">log2int</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> __builtin_clz((<span class="keyword">int</span>)<span class="number">1</span>)-__builtin_clz(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SegementTree</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">7000000</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXV = <span class="number">50005</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        Node *lson, *rson;</span><br><span class="line">        <span class="keyword">int</span> sum;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;</span><br><span class="line">        	lson = rson = <span class="literal">NULL</span>;</span><br><span class="line">        	sum = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; _mem[MAXN];</span><br><span class="line">    <span class="keyword">int</span> L, R, V, mem_idx;</span><br><span class="line">    <span class="function">Node* <span class="title">init</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">        L = l, R = r, V = v;</span><br><span class="line">        mem_idx = <span class="number">0</span>;</span><br><span class="line">        Node* root = <span class="built_in">build</span>(l, r);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node *u = &amp;_mem[mem_idx++];</span><br><span class="line">        *u = <span class="built_in">Node</span>();</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> Node* <span class="title">cloneNode</span><span class="params">(Node *p)</span> </span>&#123;</span><br><span class="line">        Node *u = &amp;_mem[mem_idx++];</span><br><span class="line">        *u = *p;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">build</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (l &gt; r)  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        Node *u = <span class="built_in">newNode</span>();</span><br><span class="line">        <span class="keyword">if</span> (l == r) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> m = (l + r)/<span class="number">2</span>;</span><br><span class="line">        	u-&gt;lson = <span class="built_in">build</span>(l, m);</span><br><span class="line">        	u-&gt;rson = <span class="built_in">build</span>(m+<span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">change</span><span class="params">(Node *p, <span class="keyword">int</span> x, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        Node *u = <span class="built_in">cloneNode</span>(p);</span><br><span class="line">        u-&gt;sum++;</span><br><span class="line">        <span class="keyword">if</span> (l == r) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        	<span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">        	<span class="keyword">if</span> (x &lt;= mid)</span><br><span class="line">            	u-&gt;lson = <span class="built_in">change</span>(p-&gt;lson, x, l, mid);</span><br><span class="line">        	<span class="keyword">else</span></span><br><span class="line">         		u-&gt;rson = <span class="built_in">change</span>(p-&gt;rson, x, mid+<span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">change</span><span class="params">(Node *p, <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">change</span>(p, x, L, R);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> QD;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">find</span><span class="params">(Node *v1, <span class="keyword">int</span> x, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> &lt;= l &amp;&amp; r &lt;= x) &#123;</span><br><span class="line">        	QD += v1-&gt;sum;</span><br><span class="line">        	<span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (x &lt;= mid) &#123;</span><br><span class="line">            <span class="built_in">find</span>(v1-&gt;lson, x, l, mid);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">find</span>(v1-&gt;lson, x, l, mid);</span><br><span class="line">            <span class="built_in">find</span>(v1-&gt;rson, x, mid+<span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(Node *v1, <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        QD = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">find</span>(v1, x, L, R);</span><br><span class="line">        <span class="keyword">return</span> QD;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; tree;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">50005</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXLOGN = <span class="number">16</span>;</span><br><span class="line">SegementTree::Node *root[MAXN];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> A[MAXN];</span><br><span class="line"><span class="keyword">int</span> fa[MAXLOGN][MAXN], dep[MAXN];</span><br><span class="line"><span class="keyword">int</span> parent[MAXN], weight[MAXN];</span><br><span class="line">vector&lt;<span class="keyword">int</span>&gt; g[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> p, vector&lt;<span class="keyword">int</span>&gt; &amp;vA)</span> </span>&#123;</span><br><span class="line">    root[u] = tree.<span class="built_in">change</span>(root[p], A[u]);</span><br><span class="line">    fa[<span class="number">0</span>][u] = p, dep[u] = dep[p] + <span class="number">1</span>;</span><br><span class="line">    vA.<span class="built_in">push_back</span>(u);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> v : g[u]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (v == p)	<span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">dfs</span>(v, u, vA);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">findp</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x == parent[x] ? x : (parent[x]=<span class="built_in">findp</span>(parent[x]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">LCA</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (dep[x] &lt; dep[y])	<span class="built_in">swap</span>(x, y);</span><br><span class="line">    <span class="keyword">int</span> d = dep[x] - dep[y];</span><br><span class="line">    <span class="keyword">int</span> LOGN = <span class="built_in">log2int</span>(dep[x]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = LOGN; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((d&gt;&gt;i)&amp;<span class="number">1</span>)</span><br><span class="line">            d -= <span class="number">1</span>&lt;&lt;i, x = fa[i][x];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (x == y)	<span class="keyword">return</span> x;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = LOGN; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fa[i][x] != fa[i][y])</span><br><span class="line">            x = fa[i][x], y = fa[i][y];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fa[<span class="number">0</span>][x];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span> X, <span class="keyword">int</span> Y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">findp</span>(X) == <span class="built_in">findp</span>(Y))	<span class="keyword">return</span> ;</span><br><span class="line">    <span class="keyword">int</span> rx, ry;</span><br><span class="line">    rx = <span class="built_in">findp</span>(X), ry = <span class="built_in">findp</span>(Y);</span><br><span class="line">    <span class="keyword">if</span> (weight[rx] &lt; weight[ry])	<span class="built_in">swap</span>(rx, ry), <span class="built_in">swap</span>(X, Y);</span><br><span class="line">    g[X].<span class="built_in">push_back</span>(Y), g[Y].<span class="built_in">push_back</span>(X);</span><br><span class="line">    <span class="comment">// merge Y&#x27;s group into X&#x27;s group</span></span><br><span class="line">    parent[ry] = rx, weight[rx] += weight[ry];</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; vA;</span><br><span class="line">    <span class="built_in">dfs</span>(Y, X, vA);</span><br><span class="line">    <span class="keyword">int</span> LOGN = <span class="built_in">log2int</span>(weight[rx]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= LOGN; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> j : vA)</span><br><span class="line">            fa[i][j] = fa[i<span class="number">-1</span>][fa[i<span class="number">-1</span>][j]];</span><br><span class="line">    &#125;	</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">path</span><span class="params">(<span class="keyword">int</span> X, <span class="keyword">int</span> Y, <span class="keyword">int</span> K)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">findp</span>(X) != <span class="built_in">findp</span>(Y))	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> lca = <span class="built_in">LCA</span>(X, Y);</span><br><span class="line">    <span class="keyword">int</span> ret = tree.<span class="built_in">find</span>(root[X], K) + tree.<span class="built_in">find</span>(root[Y], K) - tree.<span class="built_in">find</span>(root[lca], K) * <span class="number">2</span>;</span><br><span class="line">    ret += A[lca] &lt;= K;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> N, Q, cmd;</span><br><span class="line">    <span class="keyword">int</span> X, Y, K;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;N, &amp;Q) == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;A[i]);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">            parent[i] = i, weight[i] = <span class="number">1</span>, g[i].<span class="built_in">clear</span>(), dep[i] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAXLOGN; i++)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= N; j++)</span><br><span class="line">                fa[i][j] = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">        root[<span class="number">0</span>] = tree.<span class="built_in">init</span>(<span class="number">1</span>, N, N);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">            root[i] = root[<span class="number">0</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> d = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Q; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d %d&quot;</span>, &amp;cmd, &amp;X, &amp;Y);</span><br><span class="line">            X ^= d, Y ^= d;</span><br><span class="line">            <span class="keyword">if</span> (cmd == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">merge</span>(X, Y);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;K);</span><br><span class="line">                K ^= d;</span><br><span class="line">                d = <span class="built_in">path</span>(X, Y, K);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, d);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b492" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/19/zj-b492/" class="article-date">
  <time datetime="2015-08-19T03:20:20.000Z" itemprop="datePublished">2015-08-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/19/zj-b492/">b492. 史蒂芙的外交序列</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/08/19/zj-b492/" data-id="ckpaivcab00brn8vn8qud9p5p" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/08/19/zj-b492/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/乘法反元素/">乘法反元素</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/函數式線段樹/">函數式線段樹</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/可持久化/">可持久化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/逆元/">逆元</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>史蒂芙為了人類國家決定出遠門外交，在一條神秘谷徑中有 <span>$N$</span><!-- Has MathJax --> 個小城市，每個城市都有各自的文明發展程度 <span>$A_i$</span><!-- Has MathJax -->，史蒂芙依照自己的能力 <span>$K$</span><!-- Has MathJax --> 只能選擇文明發展程度 <span>$A_i$</span><!-- Has MathJax --> 小於等於 <span>$K$</span><!-- Has MathJax --> 的國家拜訪，並且這次遠門的滿意程度是所有走訪國家的權重相乘。</p>
<p>礙於時間有限，史蒂芙手頭上有數個計劃，打算對某個區間內的城市策劃行程，現在請你算出所有計畫的預期滿意程度以及走訪個數，由於滿意程度會很大，輸出 <span>$\mod 1000000007$</span><!-- Has MathJax --> 的結果。</p>
<h3 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h3><p>給定 <span>$N$</span><!-- Has MathJax --> 個整數序列 <span>$A[]$</span><!-- Has MathJax --> 以及 <span>$Q$</span><!-- Has MathJax --> 個詢問，每一個詢問 <span>$[L, R]$</span><!-- Has MathJax --> 以及 <span>$K$</span><!-- Has MathJax -->，請計算 <span>$\sum_{L \le i \le R } [A_i \le K]$</span><!-- Has MathJax --> 以及 <span>$\prod_{L \le i \le R, \; A_i \le K } A_i$</span><!-- Has MathJax --></p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">7 4</span><br><span class="line">1 5 2 6 3 7 4</span><br><span class="line">2 5 3</span><br><span class="line">4 4 1</span><br><span class="line">1 7 3</span><br><span class="line">4 6 6</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2 6</span><br><span class="line">0 0</span><br><span class="line">3 6</span><br><span class="line">2 18</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>詢問一個區間內，元素小於等於 <span>$K$</span><!-- Has MathJax --> 的元素個數，並且把這些數字相乘輸出。</p>
<p>這裡使用函數式線段樹來完成操作，時間複雜度 <span>$O(Q \log N)$</span><!-- Has MathJax --> 空間複雜度 <span>$O(N \log N)$</span><!-- Has MathJax -->。但若模數不是大質數，相乘結果無法利用區間加減法的性質計算，要使用別的資料結構完成，函數式線段樹將沒辦法支持這個計算。</p>
<p>特別小心實作反元素計算時，要分開計算比較好，儘管歐基里德輾轉相除法複雜度 <span>$O(\log N)$</span><!-- Has MathJax --> 且常數非常小，詢問時避免兩個版本好同時計算，寫法如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">void find(Node *v1, Node *v2, int x, int l, int r) &#123;</span><br><span class="line">    if (1 &lt;= l &amp;&amp; r &lt;= x) &#123;</span><br><span class="line">    	QV = QV * v1-&gt;prod %MOD * inverse(v2-&gt;prod, MOD) % MOD;</span><br><span class="line">    	QD += v1-&gt;sum - v2-&gt;sum;</span><br><span class="line">    	return ;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>單筆詢問時間複雜度會掉回 <span>$O(\log^2 N)$</span><!-- Has MathJax -->。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MOD = <span class="number">1000000007</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exgcd</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> &amp;g, <span class="keyword">int</span> &amp;a, <span class="keyword">int</span> &amp;b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (y == <span class="number">0</span>)</span><br><span class="line">        g = x, a = <span class="number">1</span>, b = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">exgcd</span>(y, x%y, g, b, a), b -= (x/y) * a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inverse</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> g, b, r;</span><br><span class="line">    <span class="built_in">exgcd</span>(x, p, g, r, b);</span><br><span class="line">    <span class="keyword">if</span> (g &lt; <span class="number">0</span>)	r = -r;</span><br><span class="line">    <span class="keyword">return</span> (r%p + p)%p;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SegementTree</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1000000</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        Node *lson, *rson;</span><br><span class="line">        <span class="keyword">int</span> sum, prod;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;</span><br><span class="line">        	lson = rson = <span class="literal">NULL</span>;</span><br><span class="line">        	prod = <span class="number">1</span>, sum = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; nodes[MAXN];</span><br><span class="line">    <span class="keyword">int</span> nodesize, L, R;</span><br><span class="line">    <span class="function">Node* <span class="title">init</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        nodesize = <span class="number">0</span>;</span><br><span class="line">        L = l, R = r;</span><br><span class="line">        Node* root = <span class="built_in">build</span>(l, r);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node *u = &amp;nodes[nodesize++];</span><br><span class="line">        *u = <span class="built_in">Node</span>();</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">cloneNode</span><span class="params">(Node *p)</span> </span>&#123;</span><br><span class="line">        Node* u = &amp;nodes[nodesize++];</span><br><span class="line">        *u = *p;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">build</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (l &gt; r)  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        Node *u = <span class="built_in">newNode</span>();</span><br><span class="line">        <span class="keyword">if</span> (l == r) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> m = (l + r)/<span class="number">2</span>;</span><br><span class="line">        	u-&gt;lson = <span class="built_in">build</span>(l, m);</span><br><span class="line">        	u-&gt;rson = <span class="built_in">build</span>(m+<span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">change</span><span class="params">(Node *p, <span class="keyword">int</span> x, <span class="keyword">long</span> <span class="keyword">long</span> val, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        Node *u = <span class="built_in">cloneNode</span>(p);</span><br><span class="line">        u-&gt;prod = (u-&gt;prod * val)%MOD, u-&gt;sum++;</span><br><span class="line">        <span class="keyword">if</span> (l == r) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        	<span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">        	<span class="keyword">if</span> (x &lt;= mid)</span><br><span class="line">            	u-&gt;lson = <span class="built_in">change</span>(p-&gt;lson, x, val, l, mid);</span><br><span class="line">        	<span class="keyword">else</span></span><br><span class="line">         		u-&gt;rson = <span class="built_in">change</span>(p-&gt;rson, x, val, mid+<span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">change</span><span class="params">(Node *p, <span class="keyword">int</span> x, <span class="keyword">long</span> <span class="keyword">long</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">change</span>(p, x, val, L, R);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> QV, QD;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">find</span><span class="params">(Node *v1, <span class="keyword">int</span> x, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> &lt;= l &amp;&amp; r &lt;= x) &#123;</span><br><span class="line">        	QV = (<span class="keyword">long</span> <span class="keyword">long</span>)QV * v1-&gt;prod % MOD;</span><br><span class="line">        	QD += v1-&gt;sum;</span><br><span class="line">        	<span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (x &lt;= mid) &#123;</span><br><span class="line">            <span class="built_in">find</span>(v1-&gt;lson, x, l, mid);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">find</span>(v1-&gt;lson, x, l, mid);</span><br><span class="line">            <span class="built_in">find</span>(v1-&gt;rson, x, mid+<span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; <span class="title">find</span><span class="params">(Node *v1, <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        QV = <span class="number">1</span>, QD = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">find</span>(v1, x, L, R);</span><br><span class="line">        <span class="keyword">return</span> &#123;QD, QV&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; tree;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">65536</span>;</span><br><span class="line">SegementTree::Node *root[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> N, Q, A[MAXN];</span><br><span class="line">    <span class="keyword">int</span> L, R, K;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;N, &amp;Q) == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;A[i]);</span><br><span class="line">            </span><br><span class="line">        root[<span class="number">0</span>] = tree.<span class="built_in">init</span>(<span class="number">1</span>, N);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">            root[i] = tree.<span class="built_in">change</span>(root[i<span class="number">-1</span>], A[i], A[i]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Q; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d %d&quot;</span>, &amp;L, &amp;R, &amp;K);</span><br><span class="line">            <span class="keyword">int</span> a, b;</span><br><span class="line">            pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; r;</span><br><span class="line">            r = tree.<span class="built_in">find</span>(root[R], K);</span><br><span class="line">            a = r.first, b = r.second;</span><br><span class="line">            r = tree.<span class="built_in">find</span>(root[L<span class="number">-1</span>], K);</span><br><span class="line">            a -= r.first, b = (<span class="keyword">long</span> <span class="keyword">long</span>) b * <span class="built_in">inverse</span>(r.second, MOD)%MOD;</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;0 0\n&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d %d\n&quot;</span>, a, b);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b491" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/19/zj-b491/" class="article-date">
  <time datetime="2015-08-19T03:12:53.000Z" itemprop="datePublished">2015-08-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/19/zj-b491/">b491. 史蒂芙的政務工作</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/08/19/zj-b491/" data-id="ckpaivcaa00bqn8vnhhlt36xb" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/08/19/zj-b491/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Splay-tree/">Splay tree</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>史蒂芙接管人類最後國家的政務工作，卻時常受到熊孩子搗亂，文書資料原本按照編號 <span>$[1 \cdots N]$</span><!-- Has MathJax --> 排成一疊，熊孩子每一次搗亂都會翻轉位置 <span>$[L, R]$</span><!-- Has MathJax --> 的資料，使得編號整個反過來。</p>
<p>史蒂芙已經無暇處理這些熊孩子，她只想知道某個資料現在到底在哪個位置上。</p>
<h3 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h3><p>給定 <span>$N$</span><!-- Has MathJax --> 個整數 <span>$1 \cdots N$</span><!-- Has MathJax --> 以及 <span>$Q$</span><!-- Has MathJax --> 個操作，一開始文書編號 <span>$i$</span><!-- Has MathJax --> 在位置 <span>$i$</span><!-- Has MathJax --> 上。</p>
<ul>
<li><code>0 L R</code> 反轉區間位置 <span>$[L, R]$</span><!-- Has MathJax --> 的文書</li>
<li><code>1 x</code> 詢問文書編號 <span>$x$</span><!-- Has MathJax --> 的位置</li>
</ul>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">7 6</span><br><span class="line">1 7</span><br><span class="line">0 3 5</span><br><span class="line">1 5</span><br><span class="line">0 1 3</span><br><span class="line">1 3</span><br><span class="line">1 1</span><br><span class="line"></span><br><span class="line">5 5</span><br><span class="line">0 1 3</span><br><span class="line">0 4 5</span><br><span class="line">1 1</span><br><span class="line">1 3</span><br><span class="line">1 5</span><br><span class="line"></span><br><span class="line">5 5</span><br><span class="line">0 1 4</span><br><span class="line">0 2 5</span><br><span class="line">1 1</span><br><span class="line">1 3</span><br><span class="line">1 5</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">7</span><br><span class="line">3</span><br><span class="line">5</span><br><span class="line">3</span><br><span class="line">3</span><br><span class="line">1</span><br><span class="line">4</span><br><span class="line">3</span><br><span class="line">5</span><br><span class="line">2</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>不能直接建造 <span>$O(N)$</span><!-- Has MathJax --> 的節點的 Splay tree，每一個節點為一個區間，每一次詢問最多產生兩個新的節點，空間為 <span>$O(Q)$</span><!-- Has MathJax -->，時間複雜度為 <span>$O(Q \log Q)$</span><!-- Has MathJax -->。而在詢問位置時，額外建造一個平衡樹來完成反向映射找到位置。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">200005</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SPLAY_TREE</span> &#123;</span> <span class="comment">// Splay Tree</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">200005</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        <span class="keyword">static</span> Node *EMPTY;</span><br><span class="line">        Node *ch[<span class="number">2</span>], *fa;</span><br><span class="line">        <span class="keyword">int</span> rev<span class="comment">/*, size*/</span>;</span><br><span class="line">        <span class="keyword">int</span> L, R, LRsize;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;</span><br><span class="line">            ch[<span class="number">0</span>] = ch[<span class="number">1</span>] = fa = <span class="literal">NULL</span>;</span><br><span class="line">            rev = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//			size = 1;</span></span><br><span class="line">            L = <span class="number">0</span>, R = <span class="number">-1</span>, LRsize = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">is_root</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> fa-&gt;ch[<span class="number">0</span>] != <span class="keyword">this</span> &amp;&amp; fa-&gt;ch[<span class="number">1</span>] != <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (rev) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ch[<span class="number">0</span>] != EMPTY)	ch[<span class="number">0</span>]-&gt;rev ^= <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (ch[<span class="number">1</span>] != EMPTY)	ch[<span class="number">1</span>]-&gt;rev ^= <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">swap</span>(ch[<span class="number">0</span>], ch[<span class="number">1</span>]), <span class="built_in">swap</span>(L, R);</span><br><span class="line">                rev ^= <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//			if (ch[0] != EMPTY)	ch[0]-&gt;pushdown();</span></span><br><span class="line"><span class="comment">//			if (ch[1] != EMPTY)	ch[1]-&gt;pushdown();</span></span><br><span class="line"><span class="comment">//			size = 1 + ch[0]-&gt;size + ch[1]-&gt;size;</span></span><br><span class="line">            LRsize = <span class="built_in">i_size</span>() + ch[<span class="number">0</span>]-&gt;LRsize + ch[<span class="number">1</span>]-&gt;LRsize;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">i_size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span> == EMPTY)	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">max</span>(R, L) - <span class="built_in">min</span>(R, L) + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; _mem[MAXN];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> bufIdx;</span><br><span class="line">    SPLAY_TREE::Node *root;</span><br><span class="line">    map&lt;<span class="keyword">int</span>, Node*&gt; S;</span><br><span class="line">    <span class="built_in">SPLAY_TREE</span>() &#123;</span><br><span class="line">        Node::EMPTY = &amp;_mem[<span class="number">0</span>];</span><br><span class="line">        Node::EMPTY-&gt;fa = Node::EMPTY-&gt;ch[<span class="number">0</span>] = Node::EMPTY-&gt;ch[<span class="number">1</span>] = Node::EMPTY;</span><br><span class="line"><span class="comment">//		Node::EMPTY-&gt;size = 0;</span></span><br><span class="line">        bufIdx = <span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bufIdx = <span class="number">1</span>;</span><br><span class="line">        S.<span class="built_in">clear</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node *u = &amp;_mem[bufIdx++];</span><br><span class="line">        *u = <span class="built_in">Node</span>();</span><br><span class="line">        u-&gt;fa = u-&gt;ch[<span class="number">0</span>] = u-&gt;ch[<span class="number">1</span>] = Node::EMPTY;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rotate</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        Node *y;</span><br><span class="line">        <span class="keyword">int</span> d;</span><br><span class="line">        y = x-&gt;fa, d = y-&gt;ch[<span class="number">1</span>] == x ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        x-&gt;ch[d^<span class="number">1</span>]-&gt;fa = y, y-&gt;ch[d] = x-&gt;ch[d^<span class="number">1</span>];</span><br><span class="line">        x-&gt;ch[d^<span class="number">1</span>] = y;</span><br><span class="line">        <span class="keyword">if</span> (!y-&gt;<span class="built_in">is_root</span>())</span><br><span class="line">            y-&gt;fa-&gt;ch[y-&gt;fa-&gt;ch[<span class="number">1</span>] == y] = x;</span><br><span class="line">        x-&gt;fa = y-&gt;fa, y-&gt;fa = x;</span><br><span class="line">        y-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deal</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!x-&gt;<span class="built_in">is_root</span>())	<span class="built_in">deal</span>(x-&gt;fa);</span><br><span class="line">        x-&gt;<span class="built_in">pushdown</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">find_rt</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (; x-&gt;fa != Node::EMPTY; x = x-&gt;fa);</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">(Node *x, Node *below)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x == Node::EMPTY)	<span class="keyword">return</span> ;</span><br><span class="line">        Node *y, *z;</span><br><span class="line">        <span class="built_in">deal</span>(x);</span><br><span class="line">        <span class="keyword">while</span> (!x-&gt;<span class="built_in">is_root</span>() &amp;&amp; x-&gt;fa != below) &#123;</span><br><span class="line">            y = x-&gt;fa, z = y-&gt;fa;</span><br><span class="line">            <span class="keyword">if</span> (!y-&gt;<span class="built_in">is_root</span>() &amp;&amp; y-&gt;fa != below) &#123;</span><br><span class="line">                <span class="keyword">if</span> (y-&gt;ch[<span class="number">0</span>] == x ^ z-&gt;ch[<span class="number">0</span>] == y)</span><br><span class="line">                    <span class="built_in">rotate</span>(x);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">rotate</span>(y);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">rotate</span>(x);</span><br><span class="line">        &#125;</span><br><span class="line">        x-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">        <span class="keyword">if</span> (x-&gt;fa == Node::EMPTY)	root = x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">build</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (l &gt; r)	<span class="keyword">return</span> Node::EMPTY; </span><br><span class="line">        Node *t = <span class="built_in">newNode</span>();</span><br><span class="line">        t-&gt;L = l, t-&gt;R = r;</span><br><span class="line">        t-&gt;fa = Node::EMPTY;</span><br><span class="line">        t-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">        root = t;</span><br><span class="line">        S[<span class="built_in">min</span>(l, r)] = t;</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node *<span class="title">splitNode</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;	<span class="comment">// make node interval [pos, ?]</span></span><br><span class="line">    	Node *u = root, *v;</span><br><span class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> t; u != Node::EMPTY;) &#123;</span><br><span class="line">    		u-&gt;<span class="built_in">pushdown</span>();</span><br><span class="line">    		t = u-&gt;ch[<span class="number">0</span>]-&gt;LRsize;</span><br><span class="line">    		<span class="keyword">if</span> (t+<span class="number">1</span> == pos)	<span class="keyword">return</span> u; </span><br><span class="line">    		<span class="keyword">if</span> (t &gt;= pos) &#123;</span><br><span class="line">    			u = u-&gt;ch[<span class="number">0</span>];</span><br><span class="line">    		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pos &gt; t + u-&gt;<span class="built_in">i_size</span>()) &#123;</span><br><span class="line">    			pos -= t + u-&gt;<span class="built_in">i_size</span>(), u = u-&gt;ch[<span class="number">1</span>];</span><br><span class="line">    		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> l = u-&gt;L, r = u-&gt;R;</span><br><span class="line">    			Node *x = <span class="built_in">newNode</span>();</span><br><span class="line">    			pos -= t;</span><br><span class="line">    			S[<span class="built_in">min</span>(u-&gt;L, u-&gt;R)] = u;</span><br><span class="line">    			<span class="keyword">if</span> (l &lt; r)</span><br><span class="line">    				u-&gt;L = l + (pos - <span class="number">1</span>), r = u-&gt;L - <span class="number">1</span>;</span><br><span class="line">    			<span class="keyword">else</span></span><br><span class="line">    				u-&gt;L = l - (pos - <span class="number">1</span>), r = u-&gt;L + <span class="number">1</span>;</span><br><span class="line">    			x-&gt;L = l, x-&gt;R = r;</span><br><span class="line">    			<span class="keyword">if</span> (u-&gt;ch[<span class="number">0</span>] == Node::EMPTY) &#123;</span><br><span class="line">    				u-&gt;ch[<span class="number">0</span>] = x, x-&gt;fa = u;</span><br><span class="line">    			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    				v = <span class="built_in">prevNode</span>(u);</span><br><span class="line">    				v-&gt;ch[<span class="number">1</span>] = x, x-&gt;fa = v;</span><br><span class="line">    			&#125;</span><br><span class="line">    			S[<span class="built_in">min</span>(u-&gt;L, u-&gt;R)] = u;</span><br><span class="line">    			S[<span class="built_in">min</span>(x-&gt;L, x-&gt;R)] = x;</span><br><span class="line">    			<span class="built_in">splay</span>(x, Node::EMPTY);</span><br><span class="line">    			<span class="keyword">return</span> u;</span><br><span class="line">    		&#125;</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">prevNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">    	<span class="built_in">splay</span>(u, Node::EMPTY);</span><br><span class="line">        <span class="keyword">for</span> (u = u-&gt;ch[<span class="number">0</span>]; u-&gt;<span class="built_in">pushdown</span>(), u-&gt;ch[<span class="number">1</span>] != Node::EMPTY; u = u-&gt;ch[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reverse</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">    	Node *p, *q;</span><br><span class="line">    	p = <span class="built_in">splitNode</span>(l);</span><br><span class="line">    	p = <span class="built_in">prevNode</span>(p);</span><br><span class="line">        q = <span class="built_in">splitNode</span>(r+<span class="number">1</span>);</span><br><span class="line">    	<span class="built_in">splay</span>(p, Node::EMPTY), <span class="built_in">splay</span>(q, root);</span><br><span class="line">    	q-&gt;ch[<span class="number">0</span>]-&gt;rev ^= <span class="number">1</span>;</span><br><span class="line">    	<span class="built_in">splay</span>(q-&gt;ch[<span class="number">0</span>], Node::EMPTY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    	Node *u;</span><br><span class="line">    	map&lt;<span class="keyword">int</span>, Node*&gt;::iterator it;</span><br><span class="line">        it = S.<span class="built_in">upper_bound</span>(x), it--;</span><br><span class="line">    	u = it-&gt;second;</span><br><span class="line">    	<span class="built_in">splay</span>(u, Node::EMPTY);</span><br><span class="line">    	<span class="keyword">return</span> u-&gt;ch[<span class="number">0</span>]-&gt;LRsize + <span class="built_in">abs</span>(x - u-&gt;L) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; tree;</span><br><span class="line">SPLAY_TREE::Node *SPLAY_TREE::Node::EMPTY;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> N, Q;</span><br><span class="line">    <span class="keyword">int</span> cmd, l, r, x;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;N, &amp;Q) == <span class="number">2</span>) &#123;</span><br><span class="line">        tree.<span class="built_in">init</span>();</span><br><span class="line">        tree.<span class="built_in">build</span>(<span class="number">0</span>, N+<span class="number">1</span>);	<span class="comment">// value [0, N+1], index [1, N+2]</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Q; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;cmd);</span><br><span class="line">            <span class="keyword">if</span> (cmd == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;l, &amp;r);</span><br><span class="line">                tree.<span class="built_in">reverse</span>(l+<span class="number">1</span>, r+<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;x);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, tree.<span class="built_in">find</span>(x) - <span class="number">1</span>);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b487" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/15/zj-b487/" class="article-date">
  <time datetime="2015-08-15T00:24:06.000Z" itemprop="datePublished">2015-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="http://i.imgur.com/S1m2Cnz.jpg" rel="gallery_ckpaivcaa00bpn8vnexhx131q">
        <img src="http://i.imgur.com/S1m2Cnz.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/15/zj-b487/">b487. 變態史考古 錯誤報導篇</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/08/15/zj-b487/" data-id="ckpaivcaa00bpn8vnexhx131q" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/08/15/zj-b487/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LCA/">LCA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LCT/">LCT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Link-Cut-tree/">Link/Cut tree</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/動態/">動態</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><h3 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h3><p>隨著考古學者近幾年的研究，逐漸地分析出變態人類文化族群的祖先。同時也知道，每一代人會將其變態基因傳遞給下一代，而下一代的變態指數會比上一代多一。若子代有數個，每個子代帶有的變態性向會有所歧異。</p>
<p>每當新聞報導某個變態父子關係時，人們總會熱議某兩個變態的相似程度。口耳相傳的消息是不可信任的，現在給予事情發生的時間軸，請驗證人們口中的變態相似程度。</p>
<p>變態相似程度定義</p>
<span>$\textit{sim}(A, B) = \frac{\textit{dist}(\textit{Original}(A), \textit{LCA}(A, B)) \times 2}{\textit{dist}(\textit{Original}(A), A) + \textit{dist}(\textit{Original}(B), B)}$</span><!-- Has MathJax -->

<p>其中 <span>$\textit{Original}(A)$</span><!-- Has MathJax --> 表示根據事實推測得到的最早源頭祖先，<span>$\textit{dist}(A, B)$</span><!-- Has MathJax --> 表示在樹狀圖中兩點的距離，<span>$\textit{LCA}(A, B)$</span><!-- Has MathJax --> 表示 <span>$A, \; B$</span><!-- Has MathJax --> 最小公共祖先 (Lowest Common Ancestor，簡稱 LCA)。</p>
<p>例如當前知道的祖先關係如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    P</span><br><span class="line">   / </span><br><span class="line">  Q</span><br><span class="line"> / \</span><br><span class="line">A   R</span><br><span class="line">   /</span><br><span class="line">  B</span><br></pre></td></tr></table></figure>
<ul>
<li><span>$\textit{Original}(A) = \textit{Original}(B) = P$</span><!-- Has MathJax -->，</li>
<li><span>$\textit{dist}(P, A) = 3, \; \textit{dist}(P, B) = 4, \; \textit{LCA}(A, B) = Q, \; \textit{dist}(Q, P) = 2$</span><!-- Has MathJax -->。</li>
<li>最後 <span>$\textit{sim}(A, B) = \frac{4}{7}$</span><!-- Has MathJax --></li>
</ul>
<p>不幸地，在新聞報導時會因為口誤而傳錯消息，例如在一開始報導 A 的祖先為 R，過了不久受到指責才修正回 A 的祖先為 Q，錯誤報導的氾濫使得程序檢驗要求有效率且有彈性。不少變態因為錯誤報導而造受批判波及，現在要求你協助檢驗受災程度，好讓那些變態向新聞組織申請賠償。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">5 11</span><br><span class="line">news 4 3</span><br><span class="line">news 3 2</span><br><span class="line">sim 3 4</span><br><span class="line">sim 3 5</span><br><span class="line">news 2 1</span><br><span class="line">news 5 3</span><br><span class="line">sim 3 4</span><br><span class="line">sim 4 5</span><br><span class="line">news 4 2</span><br><span class="line">sim 4 5</span><br><span class="line">sim 4 4</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">4/5</span><br><span class="line">-1</span><br><span class="line">6/7</span><br><span class="line">3/4</span><br><span class="line">4/7</span><br><span class="line">1/1</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>相對於 Zerojudge b486. 變態史考古 的動態版本，因此沒辦法離線處理，當然也許有更高招的對操作二分等方式。</p>
<p>用 Link/Cut Tree 這一類的動態樹結構來說，維護有向樹根資訊就相當簡單，接著就是利用 Link/Cut Tree 找 <code>LCA(x, y)</code>，先藉由 <code>access(y), splay(y)</code> 將 y 轉到樹根，再把 x 打通到樹根去，最後一個從虛邊接上樹根所在的 splay tree 上的就是 <code>LCA(x, y)</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Node* lca(Node *x, Node *y) &#123;</span><br><span class="line">    if (x == y)	return x;</span><br><span class="line">    if (find(x) != find(y))</span><br><span class="line">        return Node::EMPTY;</span><br><span class="line">    Node *u, *v = Node::EMPTY, *LCA = Node::EMPTY;</span><br><span class="line">    access(y), splay(y);</span><br><span class="line">    for (u = x; u != Node::EMPTY; u = u-&gt;fa) &#123;</span><br><span class="line">        splay(u);</span><br><span class="line">        if (u-&gt;fa == Node::EMPTY)</span><br><span class="line">            LCA = u;</span><br><span class="line">        u-&gt;ch[1] = v;</span><br><span class="line">        v = u;</span><br><span class="line">        v-&gt;pushup();</span><br><span class="line">    &#125;</span><br><span class="line">    return LCA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由於是有根樹，找路徑權重時要防止上下關係發生變化，因此呼叫 <code>void mk_root(Node *u)</code> 操作時，限定 <code>u</code> 一定要是樹根才行。找路徑權重的方式也類似找 LCA 的方法。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LCT</span> &#123;</span> <span class="comment">// Link-Cut Tree</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">100005</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        <span class="keyword">static</span> Node *EMPTY;</span><br><span class="line">        Node *ch[<span class="number">2</span>], *fa;</span><br><span class="line">        <span class="keyword">int</span> rev;</span><br><span class="line">        <span class="keyword">int</span> size;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;</span><br><span class="line">            ch[<span class="number">0</span>] = ch[<span class="number">1</span>] = fa = <span class="literal">NULL</span>;</span><br><span class="line">            rev = <span class="number">0</span>; </span><br><span class="line">            size = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">is_root</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> fa-&gt;ch[<span class="number">0</span>] != <span class="keyword">this</span> &amp;&amp; fa-&gt;ch[<span class="number">1</span>] != <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (rev) &#123;</span><br><span class="line">                ch[<span class="number">0</span>]-&gt;rev ^= <span class="number">1</span>, ch[<span class="number">1</span>]-&gt;rev ^= <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">swap</span>(ch[<span class="number">0</span>], ch[<span class="number">1</span>]);</span><br><span class="line">                rev ^= <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span> == EMPTY)	<span class="keyword">return</span> ;</span><br><span class="line">            size = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (ch[<span class="number">0</span>] != EMPTY)</span><br><span class="line">                size += ch[<span class="number">0</span>]-&gt;size;</span><br><span class="line">            <span class="keyword">if</span> (ch[<span class="number">1</span>] != EMPTY)</span><br><span class="line">                size += ch[<span class="number">1</span>]-&gt;size;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; _mem[MAXN];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> bufIdx;</span><br><span class="line">    <span class="built_in">LCT</span>() &#123;</span><br><span class="line">        Node::EMPTY = &amp;_mem[<span class="number">0</span>];</span><br><span class="line">        Node::EMPTY-&gt;fa = Node::EMPTY-&gt;ch[<span class="number">0</span>] = Node::EMPTY-&gt;ch[<span class="number">1</span>] = Node::EMPTY;</span><br><span class="line">        Node::EMPTY-&gt;size = <span class="number">0</span>;</span><br><span class="line">        bufIdx = <span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bufIdx = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node *u = &amp;_mem[bufIdx++];</span><br><span class="line">        *u = <span class="built_in">Node</span>();</span><br><span class="line">        u-&gt;fa = u-&gt;ch[<span class="number">0</span>] = u-&gt;ch[<span class="number">1</span>] = Node::EMPTY;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rotate</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        Node *y;</span><br><span class="line">        <span class="keyword">int</span> d;</span><br><span class="line">        y = x-&gt;fa, d = y-&gt;ch[<span class="number">1</span>] == x ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        x-&gt;ch[d^<span class="number">1</span>]-&gt;fa = y, y-&gt;ch[d] = x-&gt;ch[d^<span class="number">1</span>];</span><br><span class="line">        x-&gt;ch[d^<span class="number">1</span>] = y;</span><br><span class="line">        <span class="keyword">if</span> (!y-&gt;<span class="built_in">is_root</span>())</span><br><span class="line">            y-&gt;fa-&gt;ch[y-&gt;fa-&gt;ch[<span class="number">1</span>] == y] = x;</span><br><span class="line">        x-&gt;fa = y-&gt;fa, y-&gt;fa = x;</span><br><span class="line">        y-&gt;<span class="built_in">pushup</span>(), x-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deal</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!x-&gt;<span class="built_in">is_root</span>())	<span class="built_in">deal</span>(x-&gt;fa);</span><br><span class="line">        x-&gt;<span class="built_in">pushdown</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        Node *y, *z;</span><br><span class="line">        <span class="built_in">deal</span>(x);</span><br><span class="line">        <span class="keyword">while</span> (!x-&gt;<span class="built_in">is_root</span>()) &#123;</span><br><span class="line">            y = x-&gt;fa, z = y-&gt;fa;</span><br><span class="line">            <span class="keyword">if</span> (!y-&gt;<span class="built_in">is_root</span>()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (y-&gt;ch[<span class="number">0</span>] == x ^ z-&gt;ch[<span class="number">0</span>] == y)</span><br><span class="line">                    <span class="built_in">rotate</span>(x);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">rotate</span>(y);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">rotate</span>(x);</span><br><span class="line">        &#125;</span><br><span class="line">        x-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">access</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        Node *v = Node::EMPTY;</span><br><span class="line">        <span class="keyword">for</span> (; u != Node::EMPTY; u = u-&gt;fa) &#123;</span><br><span class="line">            <span class="built_in">splay</span>(u);</span><br><span class="line">            u-&gt;ch[<span class="number">1</span>] = v;</span><br><span class="line">            v = u;</span><br><span class="line">            v-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">mk_root</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">access</span>(u)-&gt;rev ^= <span class="number">1</span>, <span class="built_in">splay</span>(u);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cut</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">mk_root</span>(x);</span><br><span class="line">        <span class="built_in">access</span>(y), <span class="built_in">splay</span>(y);</span><br><span class="line">        y-&gt;ch[<span class="number">0</span>] = x-&gt;fa = Node::EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">cut</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        Node *u, *v, *rt = <span class="built_in">find</span>(x);</span><br><span class="line">        <span class="built_in">mk_root</span>(rt);</span><br><span class="line">        <span class="built_in">access</span>(x), <span class="built_in">splay</span>(x);</span><br><span class="line">        <span class="keyword">for</span> (v = x-&gt;ch[<span class="number">0</span>]; v-&gt;ch[<span class="number">1</span>] != Node::EMPTY; v = v-&gt;ch[<span class="number">1</span>]);</span><br><span class="line">        x-&gt;ch[<span class="number">0</span>]-&gt;fa = x-&gt;fa;</span><br><span class="line">        x-&gt;fa = x-&gt;ch[<span class="number">0</span>] = Node::EMPTY;</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">link</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">mk_root</span>(x);</span><br><span class="line">        x-&gt;fa = y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">find</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (x = <span class="built_in">access</span>(x); x-&gt;<span class="built_in">pushdown</span>(), x-&gt;ch[<span class="number">0</span>] != Node::EMPTY; x = x-&gt;ch[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="function">Node* <span class="title">lca</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x == y)	<span class="keyword">return</span> x;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">find</span>(x) != <span class="built_in">find</span>(y))</span><br><span class="line">            <span class="keyword">return</span> Node::EMPTY;</span><br><span class="line">        Node *u, *v = Node::EMPTY, *LCA = Node::EMPTY;</span><br><span class="line">        <span class="built_in">access</span>(y), <span class="built_in">splay</span>(y);</span><br><span class="line">        <span class="keyword">for</span> (u = x; u != Node::EMPTY; u = u-&gt;fa) &#123;</span><br><span class="line">            <span class="built_in">splay</span>(u);</span><br><span class="line">            <span class="keyword">if</span> (u-&gt;fa == Node::EMPTY) &#123;</span><br><span class="line">                LCA = u;</span><br><span class="line"><span class="comment">//				u-&gt;ch[1]-&gt;push_add(c), v-&gt;push_add(c);</span></span><br><span class="line">            &#125;</span><br><span class="line">            u-&gt;ch[<span class="number">1</span>] = v;</span><br><span class="line">            v = u;</span><br><span class="line">            v-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> LCA;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">path</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line">        Node *u, *v = Node::EMPTY;</span><br><span class="line">        <span class="built_in">access</span>(y), <span class="built_in">splay</span>(y);</span><br><span class="line">        <span class="keyword">for</span> (u = x; u != Node::EMPTY; u = u-&gt;fa) &#123;</span><br><span class="line">            <span class="built_in">splay</span>(u), u-&gt;<span class="built_in">pushdown</span>();</span><br><span class="line">            <span class="keyword">if</span> (u-&gt;fa == Node::EMPTY) &#123;</span><br><span class="line">                ret = u-&gt;ch[<span class="number">1</span>]-&gt;size + v-&gt;size;</span><br><span class="line">            &#125;</span><br><span class="line">            u-&gt;ch[<span class="number">1</span>] = v;</span><br><span class="line">            v = u;</span><br><span class="line">            v-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">label</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x - _mem;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; tree;</span><br><span class="line">LCT::Node *LCT::Node::EMPTY;</span><br><span class="line">LCT::Node *A[<span class="number">100005</span>], *node_x, *node_rt;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, m, x, y, c, u, v;</span><br><span class="line">    <span class="keyword">char</span> cmd[<span class="number">8</span>];</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</span><br><span class="line">        tree.<span class="built_in">init</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">            A[i] = tree.<span class="built_in">newNode</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, cmd);</span><br><span class="line">            <span class="keyword">if</span> (cmd[<span class="number">0</span>] == <span class="string">&#x27;n&#x27;</span>) &#123;		<span class="comment">// link</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;x, &amp;y);</span><br><span class="line">                tree.<span class="built_in">cut</span>(A[x]);</span><br><span class="line">                tree.<span class="built_in">link</span>(A[x], A[y]);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd[<span class="number">0</span>] == <span class="string">&#x27;s&#x27;</span>) &#123;	<span class="comment">// sim</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;x, &amp;y);</span><br><span class="line">                node_x = tree.<span class="built_in">lca</span>(A[x], A[y]);</span><br><span class="line">                <span class="keyword">int</span> lca = tree.<span class="built_in">label</span>(node_x);</span><br><span class="line">                <span class="keyword">if</span> (lca == <span class="number">0</span>) &#123; </span><br><span class="line">                    <span class="built_in">puts</span>(<span class="string">&quot;-1&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    node_rt = tree.<span class="built_in">find</span>(A[lca]);</span><br><span class="line">                    <span class="keyword">int</span> p1, p2;</span><br><span class="line">                    p1 = tree.<span class="built_in">path</span>(A[x], A[y]) + <span class="number">1</span>;</span><br><span class="line">                    p2 = tree.<span class="built_in">path</span>(A[lca], node_rt) + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">int</span> a = p2*<span class="number">2</span>, b = p1 + p2*<span class="number">2</span> - <span class="number">1</span>, g;</span><br><span class="line">                    g = __gcd(a, b), a /= g, b /= g;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%d/%d\n&quot;</span>, a, b);</span><br><span class="line">                &#125; </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-a481" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/13/zj-a481/" class="article-date">
  <time datetime="2015-08-12T23:22:36.000Z" itemprop="datePublished">2015-08-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/13/zj-a481/">a481. 樹的維護</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/08/13/zj-a481/" data-id="ckpaivc9z00adn8vn0j0oa58k" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/08/13/zj-a481/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LCT/">LCT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Link-Cut-tree/">Link/Cut tree</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>操作有三種</p>
<ul>
<li><code>1 x y</code> 詢問樹路徑 <code>x - y</code> 經過的點權重和</li>
<li><code>2 x w</code> 修改 <code>x</code> 的點權為 <code>w</code></li>
<li><code>3 x y</code> 將 <code>x</code> 父節點修改成 <code>y</code></li>
</ul>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">5</span><br><span class="line">0 1</span><br><span class="line">1 2</span><br><span class="line">1 3</span><br><span class="line">2 4</span><br><span class="line">2 5</span><br><span class="line">5</span><br><span class="line">1 3 5</span><br><span class="line">2 1 2</span><br><span class="line">1 3 5</span><br><span class="line">3 2 3</span><br><span class="line">1 3 5</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">11</span><br><span class="line">12</span><br><span class="line">10</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>題目看起來是一個有根樹，由於權重落在點上，又由於父節點修改可以用額外數組紀錄，因此可以當作無向樹操作。</p>
<p>假設知道一條邊的兩端點 <code>e(u, v)</code>，進行 <code>cut(u, v)</code> 操作，不知道誰父誰子的切割時，可以轉兩次通到樹根，讓另一端點落在左子樹。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void cut(Node *x, Node *y) &#123;</span><br><span class="line">    mk_root(x);</span><br><span class="line">    access(y), splay(y);</span><br><span class="line">    y-&gt;ch[0] = x-&gt;fa = Node::EMPTY;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由於是無向樹，詢問路徑則藉由將其中一端變成根，接著藉由 <code>access()</code> 將路徑接到樹根，再藉由 <code>splay()</code> 轉到 splay tree 的根，此時帶權值就是路徑總和。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int sumPath(Node *x, Node *y) &#123;</span><br><span class="line">    mk_root(x);</span><br><span class="line">    access(y), splay(y);</span><br><span class="line">    return y-&gt;sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LCT</span> &#123;</span> <span class="comment">// Link-Cut Tree</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">131072</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        <span class="keyword">static</span> Node *EMPTY;</span><br><span class="line">        Node *ch[<span class="number">2</span>], *fa;</span><br><span class="line">        <span class="keyword">int</span> rev;</span><br><span class="line">        <span class="keyword">int</span> val, sum, size;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;</span><br><span class="line">            ch[<span class="number">0</span>] = ch[<span class="number">1</span>] = fa = <span class="literal">NULL</span>;</span><br><span class="line">            rev = <span class="number">0</span>;</span><br><span class="line">            val = sum = size = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">is_root</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> fa-&gt;ch[<span class="number">0</span>] != <span class="keyword">this</span> &amp;&amp; fa-&gt;ch[<span class="number">1</span>] != <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (rev) &#123;</span><br><span class="line">                ch[<span class="number">0</span>]-&gt;rev ^= <span class="number">1</span>, ch[<span class="number">1</span>]-&gt;rev ^= <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">swap</span>(ch[<span class="number">0</span>], ch[<span class="number">1</span>]);</span><br><span class="line">                rev ^= <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            sum = val, size = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (ch[<span class="number">0</span>] != EMPTY)</span><br><span class="line">                sum += ch[<span class="number">0</span>]-&gt;sum, size += ch[<span class="number">0</span>]-&gt;size;</span><br><span class="line">            <span class="keyword">if</span> (ch[<span class="number">1</span>] != EMPTY)</span><br><span class="line">                sum += ch[<span class="number">1</span>]-&gt;sum, size += ch[<span class="number">1</span>]-&gt;size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">push_deal</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">            val = c;</span><br><span class="line">            <span class="built_in">pushup</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; _mem[MAXN];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> bufIdx;</span><br><span class="line">    <span class="built_in">LCT</span>() &#123;</span><br><span class="line">        Node::EMPTY = &amp;_mem[<span class="number">0</span>];</span><br><span class="line">        Node::EMPTY-&gt;fa = Node::EMPTY-&gt;ch[<span class="number">0</span>] = Node::EMPTY-&gt;ch[<span class="number">1</span>] = Node::EMPTY;</span><br><span class="line">        bufIdx = <span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bufIdx = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node *u = &amp;_mem[bufIdx++];</span><br><span class="line">        *u = <span class="built_in">Node</span>();</span><br><span class="line">        u-&gt;fa = u-&gt;ch[<span class="number">0</span>] = u-&gt;ch[<span class="number">1</span>] = Node::EMPTY;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rotate</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        Node *y;</span><br><span class="line">        <span class="keyword">int</span> d;</span><br><span class="line">        y = x-&gt;fa, d = y-&gt;ch[<span class="number">1</span>] == x ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        x-&gt;ch[d^<span class="number">1</span>]-&gt;fa = y, y-&gt;ch[d] = x-&gt;ch[d^<span class="number">1</span>];</span><br><span class="line">        x-&gt;ch[d^<span class="number">1</span>] = y;</span><br><span class="line">        <span class="keyword">if</span> (!y-&gt;<span class="built_in">is_root</span>())</span><br><span class="line">            y-&gt;fa-&gt;ch[y-&gt;fa-&gt;ch[<span class="number">1</span>] == y] = x;</span><br><span class="line">        x-&gt;fa = y-&gt;fa, y-&gt;fa = x;</span><br><span class="line">        y-&gt;<span class="built_in">pushup</span>(), x-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deal</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!x-&gt;<span class="built_in">is_root</span>())	<span class="built_in">deal</span>(x-&gt;fa);</span><br><span class="line">        x-&gt;<span class="built_in">pushdown</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        Node *y, *z;</span><br><span class="line">        <span class="built_in">deal</span>(x);</span><br><span class="line">        <span class="keyword">while</span> (!x-&gt;<span class="built_in">is_root</span>()) &#123;</span><br><span class="line">            y = x-&gt;fa, z = y-&gt;fa;</span><br><span class="line">            <span class="keyword">if</span> (!y-&gt;<span class="built_in">is_root</span>()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (y-&gt;ch[<span class="number">0</span>] == x ^ z-&gt;ch[<span class="number">0</span>] == y)</span><br><span class="line">                    <span class="built_in">rotate</span>(x);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">rotate</span>(y);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">rotate</span>(x);</span><br><span class="line">        &#125;</span><br><span class="line">        x-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">access</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        Node *v = Node::EMPTY;</span><br><span class="line">        <span class="keyword">for</span> (; u != Node::EMPTY; u = u-&gt;fa) &#123;</span><br><span class="line">            <span class="built_in">splay</span>(u);</span><br><span class="line">            u-&gt;ch[<span class="number">1</span>] = v;</span><br><span class="line">            v = u;</span><br><span class="line">            v-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">mk_root</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">access</span>(u), <span class="built_in">splay</span>(u);</span><br><span class="line">        u-&gt;rev ^= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cut</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">mk_root</span>(x);</span><br><span class="line">        <span class="built_in">access</span>(y), <span class="built_in">splay</span>(y);</span><br><span class="line">        y-&gt;ch[<span class="number">0</span>] = x-&gt;fa = Node::EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">link</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">mk_root</span>(x);</span><br><span class="line">        x-&gt;fa = y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">find</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">access</span>(x), <span class="built_in">splay</span>(x);</span><br><span class="line">        <span class="keyword">for</span> (; x-&gt;ch[<span class="number">0</span>] != Node::EMPTY; x = x-&gt;ch[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dealNode</span><span class="params">(Node *x, <span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">mk_root</span>(x);</span><br><span class="line">        x-&gt;<span class="built_in">push_deal</span>(c);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">sumPath</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">mk_root</span>(x);</span><br><span class="line">        <span class="built_in">access</span>(y), <span class="built_in">splay</span>(y);</span><br><span class="line">        <span class="keyword">return</span> y-&gt;sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; tree;</span><br><span class="line">LCT::Node *LCT::Node::EMPTY;</span><br><span class="line">LCT::Node *A[<span class="number">131072</span>], *node_x, *node_y;</span><br><span class="line"><span class="keyword">int</span> p[<span class="number">131072</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, m, x, y, c, u, v, cmd;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;n) == <span class="number">1</span>) &#123;</span><br><span class="line">        tree.<span class="built_in">init</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">            A[i] = tree.<span class="built_in">newNode</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;p[i], &amp;y);</span><br><span class="line">            <span class="keyword">if</span> (p[i])</span><br><span class="line">                tree.<span class="built_in">link</span>(A[i], A[p[i]]);</span><br><span class="line">            tree.<span class="built_in">dealNode</span>(A[i], y);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;m);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d %d&quot;</span>, &amp;cmd, &amp;x, &amp;y);</span><br><span class="line">            <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, tree.<span class="built_in">sumPath</span>(A[x], A[y]));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;</span><br><span class="line">                tree.<span class="built_in">dealNode</span>(A[x], y);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">3</span>) &#123;</span><br><span class="line">                tree.<span class="built_in">cut</span>(A[x], A[p[x]]);</span><br><span class="line">                tree.<span class="built_in">link</span>(A[x], A[y]);</span><br><span class="line">                p[x] = y;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/categories/解題區/解題區-Zerojudge/page/2/">2</a><a class="page-number" href="/categories/解題區/解題區-Zerojudge/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/categories/解題區/解題區-Zerojudge/page/8/">8</a><a class="extend next" rel="next" href="/categories/解題區/解題區-Zerojudge/page/2/">Next &raquo;</a>
    </nav>
  
</section>
          
          
            <aside id="sidebar">
  <!-- <div id="ukagaka_panel"></div> -->
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/">學校課程</a><span class="category-list-count">115</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/介面設計/">介面設計</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/作業系統/">作業系統</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/即時系統/">即時系統</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/大學專題/">大學專題</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/巨量資料/">巨量資料</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/平行程式/">平行程式</a><span class="category-list-count">43</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/敏捷方法/">敏捷方法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/編譯器/">編譯器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/自然語言/">自然語言</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/虛擬實境/">虛擬實境</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算型智慧/">計算型智慧</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算幾何/">計算幾何</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算機圖學/">計算機圖學</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資料庫系統/">資料庫系統</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資訊安全/">資訊安全</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/通識課程/">通識課程</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/">工作應用</a><span class="category-list-count">30</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Java/">Java</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Meme/">Meme</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/可持久化/">可持久化</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/鬼故事/">鬼故事</a><span class="category-list-count">9</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/手札日記/">手札日記</a><span class="category-list-count">44</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/">網頁設計</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/About-This-Blog/">About This Blog</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/HTML5/">HTML5</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/JQuery/">JQuery</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/Markdown/">Markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/NodeJs/">NodeJs</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/">解題區</a><span class="category-list-count">633</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/Latex/">Latex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/出題解題/">出題解題</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-POJ/">解題區 - POJ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a><span class="category-list-count">483</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a><span class="category-list-count">77</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-未解題目/">解題區 - 未解題目</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/雜言筆記/">雜言筆記</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a class="text" href="/2021/05/30/java/java-memory-optimization-1/">
              
                <i class="icon-file-o"></i> 
              
            Java 優化內存使用 結構篇</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/diary-202101/">
              
                <i class="icon-file-o"></i> 
              
            二八進展</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-file-extension/">
              
                <i class="icon-file-o"></i> 
              
            File Extension</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-globl-var/">
              
                <i class="icon-file-o"></i> 
              
            Global Variable</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-handover/">
              
                <i class="icon-file-o"></i> 
              
            Handover</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-interview-recursion/">
              
                <i class="icon-file-o"></i> 
              
            Interview &amp; Recursion</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-job-build/">
              
                <i class="icon-file-o"></i> 
              
            Job Build</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-lang/">
              
                <i class="icon-file-o"></i> 
              
            Programming Language Impostors</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-machine-learning-newbie/">
              
                <i class="icon-file-o"></i> 
              
            Machine Learning for Newbie</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-parallel-gc/">
              
                <i class="icon-file-o"></i> 
              
            Parallel &amp; Garbage Collection</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">   
      	<ul>
	      <li><a href="http://mypaper.pchome.com.tw/zerojudge" target="_blank" title="Old Blog"><i class="icon-star"></i> Morris' Blog (pchome)</a></li>
	      <li><a href="http://flere114.blogspot.tw/" target="_blank" title="蘿莉勿觸"><i class="icon-googles"></i> flere's Blog</a></li>
	      <li><a href="http://dreamoon4.blogspot.tw/" target="_blank" title="夢月"><i class="icon-googles"></i> dreamoon's Blog</a></li>
	      <li><a href="http://m80126colin.github.io" target="_blank" title="許胖們"><i class="icon-github-alt"></i> m80126colin's Blog</a></li>
	      <li><a href="http://sd12582000.blogspot.tw/" target="_blank" title="妮可妮可"><i class="icon-github-alt"></i> Nico's Blog</a></li>
	      <li><a href="http://kuoe0.logdown.com/" target="_blank" title="郭至軒大神"><i class="icon-github-alt"></i> KuoE0's Dots</a></li>
	      <li><a href="http://tyan.io/" title=""><i class="icon-github-alt"></i> Tyan Blog</a></li>
    	</ul>
    </div>
</div>

  
    
<script src="/js/jquery-ui.js"></script>
<script src="/js/ukagaka/jquery.morris.ukagaka.resource.js"></script>
<script src="/js/ukagaka/typed.js"></script>
<script type="text/javascript">
  $('#ukagaka_panel').ukagaka();
</script>
  
  
</aside>
          
        
      </div>
      <footer id="footer">
  
  <div class="outer">    
    <div class="social-group">
      
      <a href="https://github.com/morris821028" target="_blank" title="github"><i class="icon-github"></i></a>
      
      
      <a href="https://www.facebook.com/Morris1028" target="_blank" title="facebook"><i class="icon-facebook-sign"></i></a>
      
      
      <a href="http://uhunt.felix-halim.net/id/46705" target="_blank" title="uhunt" ><span class="icon-uhunt">UVa<span></a>
      
    </div>
    <div id="footer-info" class="inner">
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/morris821028/hexo-theme-landscape" target="_blank" title="landscape">landscape</a> &copy; 2021 Shiang-Yun Yang 
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link"><i class=icon-home ></i>&nbsp&nbspHome</a>
  
    <a href="/about" class="mobile-nav-link"><i class=icon-user ></i>&nbsp&nbspAbout</a>
  
    <a href="/archives" class="mobile-nav-link"><i class=icon-archive ></i>&nbsp&nbspArchives</a>
  
    <a href="/tags" class="mobile-nav-link"><i class=icon-tags ></i>&nbsp&nbspTags</a>
  
    <a href="/picture" class="mobile-nav-link"><i class=icon-camera ></i>&nbsp&nbspPictures</a>
  
    <a href="/works" class="mobile-nav-link"><i class=icon-trophy ></i>&nbsp&nbspWorks</a>
  
</nav>
    
<script>
  var disqus_shortname = 'morris1028';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/jquery.lazyload.js"></script>
<script src="/js/jquery.als-1.6.js"></script>

<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>