<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Category: 出題解題 | Morris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Morris&#39; Blog">
<meta property="og:url" content="http://morris821028.github.io/categories/解題區/出題解題/index.html">
<meta property="og:site_name" content="Morris&#39; Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Morris&#39; Blog">
<link rel="publisher" href="108158678174364350000">
  
    <link rel="alternative" href="/atom.xml" title="Morris&#39; Blog" type="application/atom+xml">
  
  
    <meta name="google-site-verification" content="5mRgj8NanEMpGZuNfHNJNmH90RgNlrnJXsFlTaKD6Gs" />
  
  
    <link rel="shortcut icon" href="/img/f.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script src="/js/jquery-2.1.0.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.5.1.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdn.oesmith.co.uk/morris-0.5.1.min.js"></script>
  <!-- <link rel="import" href="/bower_components/app-layout/app-layout.html"> --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"><div id="banner-right"></div></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Morris&#39; Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class=icon-home title='Home'></i></a>
          
        
          
            <a class="main-nav-link" href="/about"><i class=icon-user title='About'></i></a>
          
        
          
            <a class="main-nav-link" href="/archives"><i class=icon-archive title='Archives'></i></a>
          
        
          
            <a class="main-nav-link" href="/tags"><i class=icon-tags title='Tags'></i></a>
          
        
          
            <a class="main-nav-link" href="/picture"><i class=icon-camera title='Pictures'></i></a>
          
        
          
            <a class="main-nav-link" href="/works"><i class=icon-trophy title='Works'></i></a>
          
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://morris821028.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        
          
          <section id="main">
  
    <article id="post-mproblem-dynamic-point-in-polygon" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/26/mproblem-dynamic-point-in-polygon/" class="article-date">
  <time datetime="2019-01-26T12:49:22.000Z" itemprop="datePublished">2019-01-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/26/mproblem-dynamic-point-in-polygon/">動態幾何 史蒂芙的泡泡  (解法 1)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2019/01/26/mproblem-dynamic-point-in-polygon/" data-id="ckxv7t8u6007olkvn475xvy1u" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2019/01/26/mproblem-dynamic-point-in-polygon/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BRH/">BRH</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Splay-tree/">Splay tree</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kd-tree/">kd-tree</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/射線法/">射線法</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>題目描述請至 Zerojudge e021: 史蒂芙的泡泡 查閱詳細內容</p>
</blockquote>
<h2 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h2><p>在處理完數以百計的政事後，受盡折磨的史蒂芙，打算回家好好地休息。 拖著疲倦的身軀，再也無法再容納任何一點複雜計算。從王宮走回寢居的路上， 發現身邊所見的事物都不再圓滑，看起來就像是粗糙的幾何多邊形構成的一切。</p>
<p>打算享受著泡泡浴的史蒂芙，看著眼前的多邊形泡泡，失去原本應有的色澤，那透涼的心境更蒙上了一層灰影</p>
<p>「為什麼是我呢？」感嘆道</p>
<p>伸出手戳著眼前的泡泡，卻飄了過去</p>
<p>「區區的泡泡也跟我作對，嗚嗚」</p>
<p>將一個泡泡視為一個簡單多邊形 <span>$A$</span><!-- Has MathJax -->，方便起見用一個序列 <span>$a_0, a_1, ..., a_{n-1}$</span><!-- Has MathJax --> 表示多邊形 <span>$A$</span><!-- Has MathJax --> 的每一個頂點，則會有 <span>$n$</span><!-- Has MathJax --> 個線段 <span>$\overline{a_0 a_1}, \overline{a_1 a_2}, \cdots, \overline{a_{n-1} a_0}$</span><!-- Has MathJax -->。</p>
<h2 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h2><p>從能找到的論文「A Unified Approach to Dynamic Point Location, Ray Shooting, and Shortest Paths in Planar Maps」 得知操作更新 <span>$\mathcal{O}(\log^3 n)$</span><!-- Has MathJax -->，詢問操作 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax -->，這一個實作難度估計沒辦法在 10K 限制下完成 (代碼上傳長度上限)。</p>
<p>從動態梯形剖分開始，複雜度就相當高了，而論文後要有類似輕重鏈剖分的概念，將對偶圖產生的節點以輕重邊保存，接著再維護雙線輪廓，讓相連的連續重邊可以保存左右兩側的輪廓，… 資訊量龐大，想到一些可能未提及的邊界案例，實作相當困難。而從其他題目的經驗中，當設計到 <span>$\mathcal{O}(\log^2 n)$</span><!-- Has MathJax --> 的操作時，由於操作常數大，運行時間可能無法匹敵 <span>$\mathcal{O}(\sqrt{n})$</span><!-- Has MathJax --> 的算法。</p>
<p>那麼有沒有其他的替代方案，只需要跑得比暴力法還要快就行？特別小心，暴力法找一個點是否在多邊形內，需要 <span>$\mathcal{O}(n)$</span><!-- Has MathJax --> 的時間，且快取效果非常好，很容易做到 SIMD 的平行技術。</p>
<p>首先，解決維護多邊形點集序列，可以使用任何的平衡樹完成，若採用 splay tree 在均攤 <span>$\text{Amortized} \; \mathcal{O}(\log n)$</span><!-- Has MathJax -->。使用 treap 也可以完成這類操作，還可以做到額外的持久化功能。接著，修改點的操作，可以轉換成替換一個點的下一個點，因此將點放在 KD tree 上，而維護下一個點相當於把每一個節點擴充成 BRH。</p>
<p>接著，當解決點是否在多邊形內時，可走訪 BRH 找射線穿過的交點個數，此時複雜度至少為 <span>$\mathcal{O}(\sqrt{n} + k)$</span><!-- Has MathJax -->，其中 <span>$k$</span><!-- Has MathJax --> 為交點個數。我們可以額外維護多邊形的順逆時針來優化搜尋空間，最後一個接觸的線段方向，額外提供奇偶數來判斷該點是否在內側，然後把射線縮短到交點到詢問點之間。不斷地縮短搜尋空間下，大部分的情況為 <span>$\mathcal{O}(\sqrt{n})$</span><!-- Has MathJax -->，拋開了原本存在的 <span>$k$</span><!-- Has MathJax -->。</p>
<p>由於是封閉的簡單多邊形，所以當邊的疏密程度不一時，KD tree 轉換 BRH 會造成額外的負擔，bounding box 無法有效提供分割空間的功能。那麼在實際搜尋情況，額外走訪的節點與平面分布有關，這部分就不好分析。如果有更好的想法，歡迎分享。</p>
<p>現在實作動態 KD tree 必須有替罪羊樹 Scapegoat tree 的概念，再掛上 BRH 的想法，提供了相對有效率的動態方法來查詢點是否在多邊形內部。若把維護點序列的 splay tree 換成 treap，便可以做到持久化的動態幾何操作，這便是一開始想要的目標。</p>
<p>如果梯形剖分也可以持久化？暫時還不想去思考，那思考的容器要多大呢？</p>
<h2 id="參考解法"><a href="#參考解法" class="headerlink" title="參考解法"></a>參考解法</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Mesh</span> &#123;</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1e5</span> + <span class="number">5</span>;</div><div class="line">    <span class="keyword">int</span> pt[MAXN][<span class="number">2</span>];</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;pt[i][<span class="number">0</span>], &amp;pt[i][<span class="number">1</span>]);</div><div class="line">    &#125;</div><div class="line">&#125; mesh;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplayTree</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></div><div class="line">        Node *ch[<span class="number">2</span>], *fa;</div><div class="line">        <span class="keyword">int</span> size; <span class="keyword">int</span> data;</div><div class="line">        Node() &#123;</div><div class="line">            ch[<span class="number">0</span>] = ch[<span class="number">1</span>] = fa = <span class="literal">NULL</span>;</div><div class="line">            size = <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">is_root</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> fa-&gt;ch[<span class="number">0</span>] != <span class="keyword">this</span> &amp;&amp; fa-&gt;ch[<span class="number">1</span>] != <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    Node *root, *EMPTY;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">(Node *u)</span> </span>&#123;&#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (u-&gt;ch[<span class="number">0</span>] != EMPTY)	pushdown(u-&gt;ch[<span class="number">0</span>]);</div><div class="line">        <span class="keyword">if</span> (u-&gt;ch[<span class="number">1</span>] != EMPTY)	pushdown(u-&gt;ch[<span class="number">1</span>]);</div><div class="line">        u-&gt;size = <span class="number">1</span> + u-&gt;ch[<span class="number">0</span>]-&gt;size + u-&gt;ch[<span class="number">1</span>]-&gt;size;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setch</span><span class="params">(Node *p, Node *u, <span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (p != EMPTY)	p-&gt;ch[i] = u;</div><div class="line">        <span class="keyword">if</span> (u != EMPTY)	u-&gt;fa = p;</div><div class="line">    &#125;</div><div class="line">    SplayTree() &#123;</div><div class="line">        EMPTY = <span class="keyword">new</span> Node();</div><div class="line">        EMPTY-&gt;fa = EMPTY-&gt;ch[<span class="number">0</span>] = EMPTY-&gt;ch[<span class="number">1</span>] = EMPTY;</div><div class="line">        EMPTY-&gt;size = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        root = EMPTY;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</div><div class="line">        Node *u = <span class="keyword">new</span> Node();</div><div class="line">        u-&gt;fa = u-&gt;ch[<span class="number">0</span>] = u-&gt;ch[<span class="number">1</span>] = EMPTY;</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rotate</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        Node *y;</div><div class="line">        <span class="keyword">int</span> d;</div><div class="line">        y = x-&gt;fa, d = y-&gt;ch[<span class="number">1</span>] == x ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">        x-&gt;ch[d^<span class="number">1</span>]-&gt;fa = y, y-&gt;ch[d] = x-&gt;ch[d^<span class="number">1</span>];</div><div class="line">        x-&gt;ch[d^<span class="number">1</span>] = y;</div><div class="line">        <span class="keyword">if</span> (!y-&gt;is_root())</div><div class="line">            y-&gt;fa-&gt;ch[y-&gt;fa-&gt;ch[<span class="number">1</span>] == y] = x;</div><div class="line">        x-&gt;fa = y-&gt;fa, y-&gt;fa = x;</div><div class="line">        pushup(y);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deal</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!x-&gt;is_root())	deal(x-&gt;fa);</div><div class="line">        pushdown(x);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">(Node *x, Node *below)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (x == EMPTY)	<span class="keyword">return</span> ;</div><div class="line">        Node *y, *z;</div><div class="line">        deal(x);</div><div class="line">        <span class="keyword">while</span> (!x-&gt;is_root() &amp;&amp; x-&gt;fa != below) &#123;</div><div class="line">            y = x-&gt;fa, z = y-&gt;fa;</div><div class="line">            <span class="keyword">if</span> (!y-&gt;is_root() &amp;&amp; y-&gt;fa != below) &#123;</div><div class="line">                <span class="keyword">if</span> (y-&gt;ch[<span class="number">0</span>] == x ^ z-&gt;ch[<span class="number">0</span>] == y)</div><div class="line">                    rotate(x);</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    rotate(y);</div><div class="line">            &#125;</div><div class="line">            rotate(x);</div><div class="line">        &#125;</div><div class="line">        pushup(x);</div><div class="line">        <span class="keyword">if</span> (x-&gt;fa == EMPTY)	root = x;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">prevNode</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        splay(u, EMPTY);</div><div class="line">        <span class="keyword">return</span> maxNode(u-&gt;ch[<span class="number">0</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">nextNode</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        splay(u, EMPTY);</div><div class="line">        <span class="keyword">return</span> minNode(u-&gt;ch[<span class="number">1</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">minNode</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        Node *p = u-&gt;fa;</div><div class="line">        <span class="keyword">for</span> (; pushdown(u), u-&gt;ch[<span class="number">0</span>] != EMPTY; u = u-&gt;ch[<span class="number">0</span>]);</div><div class="line">        splay(u, p);</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">maxNode</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        Node *p = u-&gt;fa;</div><div class="line">        <span class="keyword">for</span> (; pushdown(u), u-&gt;ch[<span class="number">1</span>] != EMPTY; u = u-&gt;ch[<span class="number">1</span>]);</div><div class="line">        splay(u, p);</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">findPos</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123; <span class="comment">// [0...]</span></div><div class="line">        <span class="keyword">for</span> (Node *u = root; u != EMPTY;) &#123;</div><div class="line">            pushdown(u);</div><div class="line">            <span class="keyword">int</span> t = u-&gt;ch[<span class="number">0</span>]-&gt;size;</div><div class="line">            <span class="keyword">if</span> (t == pos) &#123;</div><div class="line">                splay(u, EMPTY);</div><div class="line">                <span class="keyword">return</span> u;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (t &gt; pos)</div><div class="line">                u = u-&gt;ch[<span class="number">0</span>];</div><div class="line">            <span class="keyword">else</span></div><div class="line">                u = u-&gt;ch[<span class="number">1</span>], pos -= t + <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> EMPTY;</div><div class="line">    &#125;</div><div class="line">    tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; insert(<span class="keyword">int</span> data, <span class="keyword">int</span> pos) &#123;	<span class="comment">// make [pos] = data</span></div><div class="line">        Node *p, *q = findPos(pos);</div><div class="line">        Node *x = newNode(); x-&gt;data = data;</div><div class="line">        <span class="keyword">if</span> (q == EMPTY) &#123;</div><div class="line">            p = maxNode(root), splay(p, EMPTY);</div><div class="line">            setch(x, p, <span class="number">0</span>);</div><div class="line">            splay(x, EMPTY);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            splay(q, EMPTY), p = q-&gt;ch[<span class="number">0</span>];</div><div class="line">            setch(x, p, <span class="number">0</span>), setch(x, q, <span class="number">1</span>);</div><div class="line">            setch(q, EMPTY, <span class="number">0</span>);</div><div class="line">            splay(q, EMPTY);</div><div class="line">            p = prevNode(x);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (p == EMPTY)	p = maxNode(root);</div><div class="line">        <span class="keyword">if</span> (q == EMPTY)	q = minNode(root);</div><div class="line">        <span class="keyword">return</span> make_tuple(p-&gt;data, data, q-&gt;data);</div><div class="line">    &#125;</div><div class="line">    tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; remove(<span class="keyword">int</span> pos) &#123;</div><div class="line">        Node *x = findPos(pos), *p, *q;</div><div class="line">        p = prevNode(x), q = nextNode(x);</div><div class="line">        <span class="keyword">if</span> (p != EMPTY &amp;&amp; q != EMPTY) &#123;</div><div class="line">            setch(p, q, <span class="number">1</span>);</div><div class="line">            p-&gt;fa = EMPTY, splay(q, EMPTY);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p != EMPTY) &#123;</div><div class="line">            p-&gt;fa = EMPTY, root = p;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            q-&gt;fa = EMPTY, root = q;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> del = x-&gt;data;</div><div class="line">        <span class="built_in">free</span>(x);</div><div class="line">        <span class="keyword">if</span> (p == EMPTY)	p = maxNode(root);</div><div class="line">        <span class="keyword">if</span> (q == EMPTY)	q = minNode(root);</div><div class="line">        <span class="keyword">return</span> make_tuple(p-&gt;data, del, q-&gt;data);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> root == EMPTY ? <span class="number">0</span> : root-&gt;size;</div><div class="line">    &#125;</div><div class="line">&#125; mlist;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">log2int</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">31</span> - __builtin_clz(x);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> int64_t <span class="title">h</span><span class="params">(<span class="keyword">int</span> p, <span class="keyword">int</span> q)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (<span class="keyword">int64_t</span>) mesh.pt[p][<span class="number">0</span>]*mesh.pt[q][<span class="number">1</span>] - (<span class="keyword">int64_t</span>) mesh.pt[p][<span class="number">1</span>]*mesh.pt[q][<span class="number">0</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">KDBRH</span> &#123;</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">double</span> ALPHA = <span class="number">0.75</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">double</span> LOG_ALPHA = log2(<span class="number">1.0</span> / ALPHA);</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Pt</span> &#123;</span></div><div class="line">        <span class="keyword">int</span> d[<span class="number">2</span>];</div><div class="line">        Pt() &#123;&#125;</div><div class="line">        Pt(<span class="keyword">int</span> xy[]):Pt(xy[<span class="number">0</span>], xy[<span class="number">1</span>]) &#123;&#125;</div><div class="line">        Pt(<span class="keyword">int</span> x, <span class="keyword">int</span> y) &#123;d[<span class="number">0</span>] = x, d[<span class="number">1</span>] = y;&#125;</div><div class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> Pt &amp;x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> d[<span class="number">0</span>] == x.d[<span class="number">0</span>] &amp;&amp; d[<span class="number">1</span>] == x.d[<span class="number">1</span>];</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">static</span> Pt <span class="title">NaN</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> Pt(INT_MIN, INT_MIN);&#125;</div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">isNaN</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> d[<span class="number">0</span>] == INT_MIN;&#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">PtP</span> &#123;</span></div><div class="line">        Pt p, q;</div><div class="line">        PtP(Pt p, Pt q): p(p), q(q) &#123;&#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cmpAxis</span> &#123;</span></div><div class="line">        <span class="keyword">int</span> k;</div><div class="line">        cmpAxis(<span class="keyword">int</span> k): k(k) &#123;&#125;</div><div class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span> <span class="params">(<span class="keyword">const</span> PtP &amp;x, <span class="keyword">const</span> PtP &amp;y)</span> <span class="keyword">const</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> x.p.d[k] &lt; y.p.d[k];</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BBox</span> &#123;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KDMIN(a, b, c) &#123;a[0] = min(b[0], c[0]), a[1] = min(b[1], c[1]);&#125;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KDMAX(a, b, c) &#123;a[0] = max(b[0], c[0]), a[1] = max(b[1], c[1]);&#125;</span></div><div class="line">        <span class="keyword">int</span> l[<span class="number">2</span>], r[<span class="number">2</span>];</div><div class="line">        BBox() &#123;&#125;</div><div class="line">        BBox(<span class="keyword">int</span> a[], <span class="keyword">int</span> b[]) &#123;</div><div class="line">            KDMIN(l, a, b); KDMAX(r, a, b);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">expand</span><span class="params">(Pt p)</span> </span>&#123;</div><div class="line">            KDMIN(l, l, p.d); KDMAX(r, r, p.d);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">expand</span><span class="params">(BBox b)</span> </span>&#123;</div><div class="line">            KDMIN(l, l, b.l); KDMAX(r, r, b.r);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">raycast</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> fx, <span class="keyword">double</span> y)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> l[<span class="number">1</span>] &lt;= y &amp;&amp; y &lt;= r[<span class="number">1</span>] &amp;&amp; r[<span class="number">0</span>] &gt;= x &amp;&amp; l[<span class="number">0</span>] &lt;= fx;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">static</span> BBox <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">            BBox b; b.l[<span class="number">0</span>] = b.l[<span class="number">1</span>] = INT_MAX, b.r[<span class="number">0</span>] = b.r[<span class="number">1</span>] = INT_MIN;</div><div class="line">            <span class="keyword">return</span> b;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></div><div class="line">        Node *lson, *rson;</div><div class="line">        Pt pt, qt;</div><div class="line">        BBox box;</div><div class="line">        <span class="keyword">int</span> size; <span class="keyword">int8_t</span> used;</div><div class="line">        Node() &#123;&#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">            lson = rson = <span class="literal">NULL</span>;</div><div class="line">            size = <span class="number">1</span>, used = <span class="number">1</span>;</div><div class="line">            pt = qt = Pt::NaN();</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">hasBox</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> box.l[<span class="number">0</span>] &lt;= box.r[<span class="number">0</span>]; &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">()</span> </span>&#123;</div><div class="line">            size = used;</div><div class="line">            <span class="keyword">if</span> (lson)	size += lson-&gt;size;</div><div class="line">            <span class="keyword">if</span> (rson)	size += rson-&gt;size;</div><div class="line">            pushupBox();</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushupBox</span><span class="params">()</span> </span>&#123;</div><div class="line">            BBox t = BBox::init();</div><div class="line">            <span class="keyword">if</span> (!qt.isNaN())</div><div class="line">                t.expand(pt), t.expand(qt);</div><div class="line">            <span class="keyword">if</span> (lson &amp;&amp; lson-&gt;hasBox())</div><div class="line">                t.expand(lson-&gt;box);</div><div class="line">            <span class="keyword">if</span> (rson &amp;&amp; rson-&gt;hasBox())</div><div class="line">                t.expand(rson-&gt;box);</div><div class="line">            box = t;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">double</span> <span class="title">interpolate</span><span class="params">(<span class="keyword">double</span> y)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (pt.d[<span class="number">1</span>] == qt.d[<span class="number">1</span>])	<span class="keyword">return</span> pt.d[<span class="number">0</span>];</div><div class="line">            <span class="keyword">return</span> pt.d[<span class="number">0</span>] + (qt.d[<span class="number">0</span>] - pt.d[<span class="number">0</span>]) * (y - pt.d[<span class="number">1</span>]) / (qt.d[<span class="number">1</span>] - pt.d[<span class="number">1</span>]);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    Node *root;</div><div class="line">    <span class="built_in">vector</span>&lt;PtP&gt; A;</div><div class="line">    <span class="keyword">int64_t</span> area;</div><div class="line">    Node _mem[<span class="number">262144</span>];</div><div class="line">    <span class="keyword">int</span> gc[<span class="number">262144</span>], gci, memi;</div><div class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</div><div class="line">        Node *u = gci &gt;= <span class="number">0</span> ? &amp;_mem[gc[gci--]] : &amp;_mem[memi++];</div><div class="line">        u-&gt;init();</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">freeNode</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        gc[++gci] = u-_mem;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        root = <span class="literal">NULL</span>, area = <span class="number">0</span>;</div><div class="line">        gci = <span class="number">-1</span>, memi = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> p, q, r; tie(p, q, r) = e;</div><div class="line">        insert(root, <span class="number">0</span>, Pt(mesh.pt[q]), Pt(mesh.pt[p]), log2int(size()) / LOG_ALPHA);</div><div class="line">        changeNode(root, <span class="number">0</span>, Pt(mesh.pt[r]), Pt(mesh.pt[q]));</div><div class="line">        area += h(p, q) + h(q, r) - h(p, r);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> p, q, r; tie(p, q, r) = e;</div><div class="line">        remove(root, <span class="number">0</span>, Pt(mesh.pt[q]), log2int(size()) / LOG_ALPHA);</div><div class="line">        changeNode(root, <span class="number">0</span>, Pt(mesh.pt[r]), Pt(mesh.pt[p]));</div><div class="line">        area -= h(p, q) + h(q, r) - h(p, r);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> RAY_T;</div><div class="line">    <span class="keyword">double</span> RAY_X;</div><div class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt; X;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">inside</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (area == <span class="number">0</span>)	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        X.clear(), RAY_X = <span class="number">1e+12</span>, RAY_T = <span class="number">-1</span>;</div><div class="line">        raycast(root, x, y);</div><div class="line">        <span class="keyword">if</span> (RAY_T &lt; <span class="number">0</span>)</div><div class="line">            <span class="keyword">return</span> X.size()&amp;<span class="number">1</span>;</div><div class="line">        <span class="keyword">int</span> pass = (area &gt; <span class="number">0</span>) == RAY_T;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;x : X)</div><div class="line">            pass += x &lt;= RAY_X;</div><div class="line">        <span class="keyword">return</span> pass&amp;<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> root == <span class="literal">NULL</span> ? <span class="number">0</span> : root-&gt;size; &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">isbad</span><span class="params">(Node *u, Node *v)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (u == root)	<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        <span class="keyword">int</span> l = v ? v-&gt;size : <span class="number">0</span>;</div><div class="line">        l = max(l, u-&gt;size-u-&gt;used-l);</div><div class="line">        <span class="keyword">return</span> l &gt; u-&gt;size * ALPHA;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">build</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (l &gt; r)	<span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">        <span class="keyword">int</span> mid = (l + r)&gt;&gt;<span class="number">1</span>;</div><div class="line">        Node *ret = newNode();</div><div class="line">        sort(A.begin()+l, A.begin()+r+<span class="number">1</span>, cmpAxis(k));</div><div class="line">        <span class="keyword">while</span> (mid &gt; l &amp;&amp; A[mid].p.d[k] == A[mid<span class="number">-1</span>].p.d[k])</div><div class="line">            mid--;</div><div class="line">        tie(ret-&gt;pt, ret-&gt;qt) = tie(A[mid].p, A[mid].q);</div><div class="line">        ret-&gt;lson = build(!k, l, mid<span class="number">-1</span>);</div><div class="line">        ret-&gt;rson = build(!k, mid+<span class="number">1</span>, r);</div><div class="line">        ret-&gt;pushup();</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">flatten</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!u)	<span class="keyword">return</span> ;</div><div class="line">        flatten(u-&gt;lson);</div><div class="line">        flatten(u-&gt;rson);</div><div class="line">        <span class="keyword">if</span> (u-&gt;used)	A.emplace_back(u-&gt;pt, u-&gt;qt);</div><div class="line">        freeNode(u);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">changeNode</span><span class="params">(Node *u, <span class="keyword">int</span> k, Pt x, Pt qt)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!u)	<span class="keyword">return</span>;</div><div class="line">        <span class="keyword">if</span> (x == u-&gt;pt) &#123;</div><div class="line">            u-&gt;qt = qt, u-&gt;pushupBox();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        changeNode(x.d[k] &lt; u-&gt;pt.d[k] ? u-&gt;lson : u-&gt;rson, !k, x, qt);</div><div class="line">        u-&gt;pushupBox();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rebuild</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> k)</span> </span>&#123;</div><div class="line">        A.clear(), A.reserve(u-&gt;size);</div><div class="line">        flatten(u);</div><div class="line">        u = build(k, <span class="number">0</span>, A.size()<span class="number">-1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">insert</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> k, Pt x, Pt y, <span class="keyword">int</span> d)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!u) &#123;</div><div class="line">            u = newNode(), u-&gt;pt = x, u-&gt;qt = y, u-&gt;pushup();</div><div class="line">            <span class="keyword">return</span> d &lt;= <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (x == u-&gt;pt) &#123;</div><div class="line">            u-&gt;used = <span class="number">1</span>, u-&gt;qt = y, u-&gt;pushup();</div><div class="line">            <span class="keyword">return</span> d &lt;= <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">auto</span> &amp;v = x.d[k] &lt; u-&gt;pt.d[k] ? u-&gt;lson : u-&gt;rson;</div><div class="line">        <span class="keyword">int</span> t = insert(v, !k, x, y, d<span class="number">-1</span>);</div><div class="line">        u-&gt;pushup();</div><div class="line">        <span class="keyword">if</span> (t &amp;&amp; !isbad(u, v))</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span> (t)	rebuild(u, k);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">remove</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> k, Pt x, <span class="keyword">int</span> d)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!u)</div><div class="line">            <span class="keyword">return</span> d &lt;= <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (x == u-&gt;pt) &#123;</div><div class="line">            <span class="keyword">if</span> (u-&gt;lson || u-&gt;rson)</div><div class="line">                u-&gt;used = <span class="number">0</span>, u-&gt;qt = Pt::NaN(), u-&gt;pushup();</div><div class="line">            <span class="keyword">else</span></div><div class="line">                freeNode(u), u = <span class="literal">NULL</span>;</div><div class="line">            <span class="keyword">return</span> d &lt;= <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">auto</span> &amp;v = x.d[k] &lt; u-&gt;pt.d[k] ? u-&gt;lson : u-&gt;rson;</div><div class="line">        <span class="keyword">int</span> t = remove(v, !k, x, d<span class="number">-1</span>);</div><div class="line">        u-&gt;pushup();</div><div class="line">        <span class="keyword">if</span> (t &amp;&amp; !isbad(u, v))</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span> (t)	rebuild(u, k);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">cast</span><span class="params">(Node *u, <span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (u-&gt;qt.isNaN() || (u-&gt;pt.d[<span class="number">1</span>] &gt; y) == (u-&gt;qt.d[<span class="number">1</span>] &gt; y))</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        <span class="keyword">double</span> tx = u-&gt;interpolate(y);</div><div class="line">        <span class="keyword">if</span> (tx &lt;= x || tx &gt; RAY_X)</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        RAY_X = tx, RAY_T = u-&gt;pt.d[<span class="number">1</span>] &lt; u-&gt;qt.d[<span class="number">1</span>];</div><div class="line">        X.emplace_back(tx);</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    Node* stk[<span class="number">128</span>];</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">raycast</span><span class="params">(Node *u, <span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> pushstk(u) &#123;*p++ = u;&#125;</span></div><div class="line">        Node **p = stk;</div><div class="line">        pushstk(u);</div><div class="line">        <span class="keyword">while</span> (p &gt; stk) &#123;</div><div class="line">            u = *--p;</div><div class="line">            <span class="keyword">if</span> (!u || !u-&gt;size || !u-&gt;box.raycast(x, RAY_X, y))</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            cast(u, x, y);</div><div class="line">            pushstk(u-&gt;rson);</div><div class="line">            pushstk(u-&gt;lson);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125; mbrh;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m, cmd, x, pos;</div><div class="line">    <span class="keyword">double</span> px, py;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m);</div><div class="line">    mesh.read(n);</div><div class="line">    mlist.init(), mbrh.init();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;cmd);</div><div class="line">        <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;x, &amp;pos);</div><div class="line">            mbrh.insert(mlist.insert(x, pos));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;x);</div><div class="line">            mbrh.remove(mlist.remove(x));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%lf %lf"</span>, &amp;px, &amp;py);</div><div class="line">            <span class="built_in">puts</span>(mbrh.inside(px, py) ? <span class="string">"1"</span> : <span class="string">"0"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-mproblem-dynamic-tree" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/26/mproblem-dynamic-tree/" class="article-date">
  <time datetime="2019-01-26T12:07:42.000Z" itemprop="datePublished">2019-01-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/26/mproblem-dynamic-tree/">動態樹 樹形避難所</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2019/01/26/mproblem-dynamic-tree/" data-id="ckxv7t8u7007tlkvn4obausri" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2019/01/26/mproblem-dynamic-tree/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LCT/">LCT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Link-Cut-Tree/">Link/Cut Tree</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>題目描述請至 Zerojudge e003: 樹形避難所 I、e004: 樹形避難所 II 查閱詳細內容</p>
</blockquote>
<h2 id="樹形避難所-I"><a href="#樹形避難所-I" class="headerlink" title="樹形避難所 I"></a>樹形避難所 I</h2><p>在一個樹形避難所中有 $N$ 個房間，待在充滿監視器房間的你，透過監視器的顯示發現存在一些未知的入侵者出現在某些房間。為了保護同伴，你可以選擇開啟或關閉房間之間的通道，而你也會收到來自於某個房間的同伴求救訊號，此時給予所有可能遇見的入侵者數量，以便同伴做好萬全的作戰準備。然而，操縱通道的控制器已不受限制，你只能眼睜睜地看著同伴與入侵者對抗，現在的你 … 做好準備了嗎？</p>
<ul>
<li>操作 1 <span>$u$</span><!-- Has MathJax --> <span>$v$</span><!-- Has MathJax -->：將房間 <span>$u$</span><!-- Has MathJax --> 與 <span>$v$</span><!-- Has MathJax --> 的通道開啟</li>
<li>操作 2 <span>$u$</span><!-- Has MathJax --> <span>$v$</span><!-- Has MathJax -->：將房間 <span>$u$</span><!-- Has MathJax --> 與 <span>$v$</span><!-- Has MathJax --> 的通道關閉</li>
<li>操作 3 <span>$u$</span><!-- Has MathJax --> <span>$w$</span><!-- Has MathJax -->：更正房間 <span>$u$</span><!-- Has MathJax --> 為 <span>$w$</span><!-- Has MathJax --> 個入侵者</li>
<li>操作 4 <span>$u$</span><!-- Has MathJax -->：回答來自 <span>$u$</span><!-- Has MathJax --> 的求救信號，告知與其可能面臨到的入侵者個數</li>
</ul>
<h2 id="樹形避難所-II"><a href="#樹形避難所-II" class="headerlink" title="樹形避難所 II"></a>樹形避難所 II</h2><p>由於上一個樹形避難所已經不再安全，全員轉移到下一個避難所，新的地方將不再是先前的平面構造，新的避難所建構在地下水層中，每一個房間可以在水中移動，並且打通到上一層的某一個房間。不幸地，新的入侵者更加地難纏，想保護大家的你，想藉由破壞某一個房間，將其相連的下層房間的入侵者一同殲滅，情局不斷地變化，哪一個才是最好的破壞手段呢 …</p>
<ul>
<li>操作 1 <span>$u$</span><!-- Has MathJax --> <span>$v$</span><!-- Has MathJax -->：將房間 <span>$u$</span><!-- Has MathJax --> 與上層房間 <span>$v$</span><!-- Has MathJax --> 的通道開啟</li>
<li>操作 2 <span>$u$</span><!-- Has MathJax -->：關閉房間 <span>$u$</span><!-- Has MathJax --> 與上層的通道</li>
<li>操作 3 <span>$u$</span><!-- Has MathJax --> <span>$w$</span><!-- Has MathJax -->：更正房間 <span>$u$</span><!-- Has MathJax --> 為 <span>$w$</span><!-- Has MathJax --> 個入侵者</li>
<li>操作 4 <span>$u$</span><!-- Has MathJax -->：估算摧毀房間 <span>$u$</span><!-- Has MathJax -->，可以殲滅的入侵者個數</li>
</ul>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>這一題對於樹的操作，牽涉到修改邊，修改點權，詢問整個連通的樹大小、以及子樹大小。可以考慮使用 Link/Cut Tree 完成。也有高手使用了離線算法，對操作分治後計算答案，將一個邊的存在時間記錄在某個時間戳記上，整體落在 <span>$\mathcal{O}(M \log M)$</span><!-- Has MathJax -->，由上而下合併所有存在的邊來完成單一詢問，需要搭配啟發式合併，來指查找根造成的退化，這一點相當地聰明。若強制在線，仍需要使用動態樹完成之。</p>
<p>對於第一題，只有包含前三個操作，可以當作一個無根樹操作，因此在 LCT 中的 <span>$\text{MakeRoot}$</span><!-- Has MathJax --> 打上反轉標記，無視原本的父子關係，額外維護一個虛邊上的子樹大小，如此一來就可以計算整個子樹大小。其餘的點權修改就相較於容易許多。對於第二題，便要求有根樹，因此在轉到根節點時，不能打上反轉標記，此時的左子樹為父節點，扣除掉父節點的大小後，便可以得到子樹大小。</p>
<ul>
<li>動態樹解法：空間複雜度 <span>$\mathcal{O}(N)$</span><!-- Has MathJax -->，操作複雜度 <span>$\text{Amortized} \; \mathcal{O}(\log N)$</span><!-- Has MathJax --></li>
<li>離線解法：空間複雜度 <span>$\mathcal{O}(M \log M)$</span><!-- Has MathJax -->，整體時間複雜度 <span>$\mathcal{O}(M \log M)$</span><!-- Has MathJax --></li>
</ul>
<h2 id="延伸問題"><a href="#延伸問題" class="headerlink" title="延伸問題"></a>延伸問題</h2><p>如果子樹存在等價關係，意即他們會被一個操作同時受到影響，那麼更新會退化嗎？</p>
<p>如果這個問題能被解決，那麼使用相同的概念，便能解決更多的高壓縮架構問題。工作就能輕鬆一些了。</p>
<h2 id="參考解答"><a href="#參考解答" class="headerlink" title="參考解答"></a>參考解答</h2><h3 id="樹形避難所-I-1"><a href="#樹形避難所-I-1" class="headerlink" title="樹形避難所 I"></a>樹形避難所 I</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line">  </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LCT</span> &#123;</span> <span class="comment">// Link-Cut Tree</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">30005</span>;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span>;</span></div><div class="line">    <span class="keyword">static</span> Node *EMPTY;</div><div class="line">    <span class="keyword">static</span> Node _mem[MAXN];</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> bufIdx;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></div><div class="line">        Node *ch[<span class="number">2</span>], *fa;</div><div class="line">        <span class="keyword">int</span> rev;</div><div class="line">        <span class="keyword">int</span> vsize, size, val;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">            ch[<span class="number">0</span>] = ch[<span class="number">1</span>] = fa = <span class="literal">NULL</span>;</div><div class="line">            size = <span class="number">0</span>, vsize = <span class="number">0</span>, rev = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">is_root</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> fa-&gt;ch[<span class="number">0</span>] != <span class="keyword">this</span> &amp;&amp; fa-&gt;ch[<span class="number">1</span>] != <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">()</span> </span>&#123;</div><div class="line">        	<span class="keyword">if</span> (rev) &#123;</div><div class="line">        		ch[<span class="number">0</span>]-&gt;rev ^= <span class="number">1</span>;</div><div class="line">                ch[<span class="number">1</span>]-&gt;rev ^= <span class="number">1</span>;</div><div class="line">        		swap(ch[<span class="number">0</span>], ch[<span class="number">1</span>]);</div><div class="line">        		rev = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">()</span> </span>&#123;</div><div class="line">        	<span class="keyword">if</span> (<span class="keyword">this</span> == EMPTY)</div><div class="line">        		<span class="keyword">return</span>;</div><div class="line">        	size = ch[<span class="number">0</span>]-&gt;size + ch[<span class="number">1</span>]-&gt;size + val + vsize;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    LCT() &#123;</div><div class="line">        EMPTY = &amp;_mem[<span class="number">0</span>];</div><div class="line">        EMPTY-&gt;fa = EMPTY-&gt;ch[<span class="number">0</span>] = EMPTY-&gt;ch[<span class="number">1</span>] = EMPTY;</div><div class="line">        EMPTY-&gt;size = <span class="number">0</span>;</div><div class="line">        bufIdx = <span class="number">1</span>; </div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        bufIdx = <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</div><div class="line">        Node *u = &amp;_mem[bufIdx++];</div><div class="line">        u-&gt;init();</div><div class="line">        u-&gt;fa = u-&gt;ch[<span class="number">0</span>] = u-&gt;ch[<span class="number">1</span>] = EMPTY;</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rotate</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        Node *y;</div><div class="line">        <span class="keyword">int</span> d;</div><div class="line">        y = x-&gt;fa, d = y-&gt;ch[<span class="number">1</span>] == x ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">        x-&gt;ch[d^<span class="number">1</span>]-&gt;fa = y, y-&gt;ch[d] = x-&gt;ch[d^<span class="number">1</span>];</div><div class="line">        x-&gt;ch[d^<span class="number">1</span>] = y;</div><div class="line">        <span class="keyword">if</span> (!y-&gt;is_root())</div><div class="line">            y-&gt;fa-&gt;ch[y-&gt;fa-&gt;ch[<span class="number">1</span>] == y] = x;</div><div class="line">        x-&gt;fa = y-&gt;fa, y-&gt;fa = x;</div><div class="line">        y-&gt;pushup(), x-&gt;pushup();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deal</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!x-&gt;is_root())   deal(x-&gt;fa);</div><div class="line">        x-&gt;pushdown();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        Node *y, *z;</div><div class="line">        deal(x);</div><div class="line">        <span class="keyword">while</span> (!x-&gt;is_root()) &#123;</div><div class="line">            y = x-&gt;fa, z = y-&gt;fa;</div><div class="line">            <span class="keyword">if</span> (!y-&gt;is_root()) &#123;</div><div class="line">                <span class="keyword">if</span> (y-&gt;ch[<span class="number">0</span>] == x ^ z-&gt;ch[<span class="number">0</span>] == y)</div><div class="line">                    rotate(x);</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    rotate(y);</div><div class="line">            &#125;</div><div class="line">            rotate(x);</div><div class="line">        &#125;</div><div class="line">        x-&gt;pushdown();</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">access</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        Node *v = EMPTY;</div><div class="line">        <span class="keyword">for</span> (; u != EMPTY; u = u-&gt;fa) &#123;</div><div class="line">            splay(u);</div><div class="line">            u-&gt;vsize += u-&gt;ch[<span class="number">1</span>] != EMPTY ? u-&gt;ch[<span class="number">1</span>]-&gt;size : <span class="number">0</span>;</div><div class="line">            u-&gt;vsize -= v != EMPTY ? v-&gt;size : <span class="number">0</span>;</div><div class="line">            u-&gt;ch[<span class="number">1</span>] = v;</div><div class="line">            u-&gt;pushup();</div><div class="line">            v = u;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> v;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">mk_root</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        access(u)-&gt;rev ^= <span class="number">1</span>, splay(u);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cut</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</div><div class="line">    	mk_root(x);</div><div class="line">    	access(y), splay(y);</div><div class="line"><span class="comment">//    	debug(10);</span></div><div class="line">    	assert(y-&gt;ch[<span class="number">0</span>] == x);</div><div class="line">        y-&gt;ch[<span class="number">0</span>] = x-&gt;fa = EMPTY;</div><div class="line">        y-&gt;pushup();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">link</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</div><div class="line">    	mk_root(y);</div><div class="line">    	access(x), splay(x);</div><div class="line">        y-&gt;fa = x;</div><div class="line">        x-&gt;vsize += y-&gt;size;</div><div class="line">        x-&gt;pushup();</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">find</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        access(x), splay(x);</div><div class="line">        <span class="keyword">for</span> (; x-&gt;ch[<span class="number">0</span>] != EMPTY; x = x-&gt;ch[<span class="number">0</span>]);</div><div class="line">        <span class="keyword">return</span> x;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(Node *x, <span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">    	mk_root(x);</div><div class="line">    	x-&gt;val = val;</div><div class="line">    	x-&gt;pushup();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">    	mk_root(u);</div><div class="line">    	<span class="keyword">return</span> u-&gt;size;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">same</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> find(x) == find(y);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">        <span class="built_in">puts</span>(<span class="string">"=================="</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            Node *u = &amp;_mem[i];</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"[%d] %d, %d %d, %d %d %d\n"</span>, i, u-&gt;fa-_mem, u-&gt;ch[<span class="number">0</span>]-_mem, u-&gt;ch[<span class="number">1</span>]-_mem, u-&gt;size, u-&gt;vsize, u-&gt;val);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125; lct;</div><div class="line">LCT::Node *LCT::EMPTY, LCT::_mem[LCT::MAXN];</div><div class="line"><span class="keyword">int</span> LCT::bufIdx;</div><div class="line">LCT::Node *node[LCT::MAXN];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</div><div class="line">        lct.init();</div><div class="line">        <span class="keyword">int</span> cmd, u, v, w;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;w);</div><div class="line">            node[i] = lct.newNode();</div><div class="line">            lct.<span class="built_in">set</span>(node[i], w);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;cmd);</div><div class="line">            <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;u, &amp;v);</div><div class="line">                lct.link(node[u], node[v]);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;u, &amp;v);</div><div class="line">                lct.cut(node[u], node[v]);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">3</span>) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;u, &amp;w);</div><div class="line">                lct.<span class="built_in">set</span>(node[u], w);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">4</span>) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;u);</div><div class="line">                <span class="keyword">int</span> p = lct.get(node[u]);</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, p);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;u, &amp;v);</div><div class="line">                <span class="keyword">int</span> f = lct.same(node[u], node[v]);</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, f);</div><div class="line">            &#125;</div><div class="line">            lct.debug(<span class="number">10</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="樹形避難所-II-1"><a href="#樹形避難所-II-1" class="headerlink" title="樹形避難所 II"></a>樹形避難所 II</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line">  </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LCT</span> &#123;</span> <span class="comment">// Link-Cut Tree</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">30005</span>;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span>;</span></div><div class="line">    <span class="keyword">static</span> Node *EMPTY;</div><div class="line">    <span class="keyword">static</span> Node _mem[MAXN];</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> bufIdx;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></div><div class="line">        Node *ch[<span class="number">2</span>], *fa;</div><div class="line">        <span class="keyword">int</span> vsize, size, val;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">            ch[<span class="number">0</span>] = ch[<span class="number">1</span>] = fa = <span class="literal">NULL</span>;</div><div class="line">            size = <span class="number">0</span>, vsize = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">is_root</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> fa-&gt;ch[<span class="number">0</span>] != <span class="keyword">this</span> &amp;&amp; fa-&gt;ch[<span class="number">1</span>] != <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">()</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">()</span> </span>&#123;</div><div class="line">        	<span class="keyword">if</span> (<span class="keyword">this</span> == EMPTY)</div><div class="line">        		<span class="keyword">return</span>;</div><div class="line">        	size = ch[<span class="number">0</span>]-&gt;size + ch[<span class="number">1</span>]-&gt;size + val + vsize;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    LCT() &#123;</div><div class="line">        EMPTY = &amp;_mem[<span class="number">0</span>];</div><div class="line">        EMPTY-&gt;fa = EMPTY-&gt;ch[<span class="number">0</span>] = EMPTY-&gt;ch[<span class="number">1</span>] = EMPTY;</div><div class="line">        EMPTY-&gt;size = <span class="number">0</span>;</div><div class="line">        bufIdx = <span class="number">1</span>; </div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        bufIdx = <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</div><div class="line">        Node *u = &amp;_mem[bufIdx++];</div><div class="line">        u-&gt;init();</div><div class="line">        u-&gt;fa = u-&gt;ch[<span class="number">0</span>] = u-&gt;ch[<span class="number">1</span>] = EMPTY;</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rotate</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        Node *y;</div><div class="line">        <span class="keyword">int</span> d;</div><div class="line">        y = x-&gt;fa, d = y-&gt;ch[<span class="number">1</span>] == x ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">        x-&gt;ch[d^<span class="number">1</span>]-&gt;fa = y, y-&gt;ch[d] = x-&gt;ch[d^<span class="number">1</span>];</div><div class="line">        x-&gt;ch[d^<span class="number">1</span>] = y;</div><div class="line">        <span class="keyword">if</span> (!y-&gt;is_root())</div><div class="line">            y-&gt;fa-&gt;ch[y-&gt;fa-&gt;ch[<span class="number">1</span>] == y] = x;</div><div class="line">        x-&gt;fa = y-&gt;fa, y-&gt;fa = x;</div><div class="line">        y-&gt;pushup(), x-&gt;pushup();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deal</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!x-&gt;is_root())   deal(x-&gt;fa);</div><div class="line">        x-&gt;pushdown();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        Node *y, *z;</div><div class="line">        deal(x);</div><div class="line">        <span class="keyword">while</span> (!x-&gt;is_root()) &#123;</div><div class="line">            y = x-&gt;fa, z = y-&gt;fa;</div><div class="line">            <span class="keyword">if</span> (!y-&gt;is_root()) &#123;</div><div class="line">                <span class="keyword">if</span> (y-&gt;ch[<span class="number">0</span>] == x ^ z-&gt;ch[<span class="number">0</span>] == y)</div><div class="line">                    rotate(x);</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    rotate(y);</div><div class="line">            &#125;</div><div class="line">            rotate(x);</div><div class="line">        &#125;</div><div class="line">        x-&gt;pushdown();</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">access</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        Node *v = EMPTY;</div><div class="line">        <span class="keyword">for</span> (; u != EMPTY; u = u-&gt;fa) &#123;</div><div class="line">            splay(u);</div><div class="line">            u-&gt;vsize += u-&gt;ch[<span class="number">1</span>] != EMPTY ? u-&gt;ch[<span class="number">1</span>]-&gt;size : <span class="number">0</span>;</div><div class="line">            u-&gt;vsize -= v != EMPTY ? v-&gt;size : <span class="number">0</span>;</div><div class="line">            u-&gt;ch[<span class="number">1</span>] = v;</div><div class="line">            u-&gt;pushup();</div><div class="line">            v = u;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> v;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">mk_root</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        access(u), splay(u);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cut</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">    	access(x), splay(x);</div><div class="line">    	x-&gt;ch[<span class="number">0</span>]-&gt;fa = EMPTY;</div><div class="line">        x-&gt;ch[<span class="number">0</span>] = EMPTY;</div><div class="line">        x-&gt;pushup();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">link</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</div><div class="line">    	access(x), splay(x);</div><div class="line">    	access(y), splay(y);</div><div class="line">        x-&gt;fa = y;</div><div class="line">        y-&gt;vsize += x-&gt;size;</div><div class="line">        y-&gt;pushup();</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">find</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        access(x), splay(x);</div><div class="line">        <span class="keyword">for</span> (; x-&gt;ch[<span class="number">0</span>] != EMPTY; x = x-&gt;ch[<span class="number">0</span>]);</div><div class="line">        <span class="keyword">return</span> x;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(Node *x, <span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">    	mk_root(x);</div><div class="line">    	x-&gt;val = val;</div><div class="line">    	x-&gt;pushup();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">    	mk_root(u);</div><div class="line">    	<span class="keyword">int</span> ret = u-&gt;size;</div><div class="line">    	<span class="keyword">if</span> (u-&gt;ch[<span class="number">0</span>] != EMPTY)</div><div class="line">    		ret -= u-&gt;ch[<span class="number">0</span>]-&gt;size;</div><div class="line">    	<span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">same</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> find(x) == find(y);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">        <span class="built_in">puts</span>(<span class="string">"=================="</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            Node *u = &amp;_mem[i];</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"[%d] %d, %d %d, %d %d %d\n"</span>, i, u-&gt;fa-_mem, u-&gt;ch[<span class="number">0</span>]-_mem, u-&gt;ch[<span class="number">1</span>]-_mem, u-&gt;size, u-&gt;vsize, u-&gt;val);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125; lct;</div><div class="line">LCT::Node *LCT::EMPTY, LCT::_mem[LCT::MAXN];</div><div class="line"><span class="keyword">int</span> LCT::bufIdx;</div><div class="line"></div><div class="line">    LCT::Node *node[LCT::MAXN];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</div><div class="line">        lct.init();</div><div class="line">        <span class="keyword">int</span> cmd, u, v, w;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;w);</div><div class="line">            node[i] = lct.newNode();</div><div class="line">            lct.<span class="built_in">set</span>(node[i], w);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;cmd);</div><div class="line">            <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;u, &amp;v);</div><div class="line">                lct.link(node[u], node[v]);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;u);</div><div class="line">                lct.cut(node[u]);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">3</span>) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;u, &amp;w);</div><div class="line">                lct.<span class="built_in">set</span>(node[u], w);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">4</span>) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;u);</div><div class="line">                <span class="keyword">int</span> p = lct.get(node[u]);</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, p);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;u, &amp;v);</div><div class="line">                <span class="keyword">int</span> f = lct.same(node[u], node[v]);</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, f);</div><div class="line">            &#125;</div><div class="line">            lct.debug(<span class="number">4</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-jg-20007" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/18/jg-20007/" class="article-date">
  <time datetime="2017-01-18T01:16:30.000Z" itemprop="datePublished">2017-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/18/jg-20007/">淺談旅行推銷員問題 (Travelling Salesman Problem) 搜索加速</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/01/18/jg-20007/" data-id="ckxv7t8tu006rlkvns6a6ol31" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/01/18/jg-20007/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DLX/">DLX</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/branch-and-reduce-algorithm/">branch-and-reduce algorithm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/批改娘/">批改娘</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>學弟們修課〈演算法設計與分析〉內容中的一環，看他們的講義進行加速比較，也許有人會認為我太閒，但這只是追求真理。看看維基百科上，就有那上萬點的極佳近似解算法，而接下來要說的相當於玩具等級。</p>
</blockquote>
<h2 id="Task-Description"><a href="#Task-Description" class="headerlink" title="Task Description"></a>Task Description</h2><p>給一組城市和每一個城市之間的單向距離，請找出從起點城市出發，經過所有城市且不重複回到起點城市的最短距離和。</p>
<p>例如，走訪順序為 $1-2-4-3-1$. 距離總和為 $10+25+30+15 = 80$.</p>
<p><img src="http://i.imgur.com/l2aSygv.png" alt=""></p>
<h2 id="Subtask"><a href="#Subtask" class="headerlink" title="Subtask"></a>Subtask</h2><span>$N \le 100$</span><!-- Has MathJax -->
<h2 id="Input-Format"><a href="#Input-Format" class="headerlink" title="Input Format"></a>Input Format</h2><p>只有一組測資，每組第一行有一個整數 <span>$N$</span><!-- Has MathJax --> ，表示有 <span>$N$</span><!-- Has MathJax --> 座城市，接下來會有 <span>$N$</span><!-- Has MathJax --> 行，每行上有 <span>$N$</span><!-- Has MathJax --> 個非負整數 <span>$D_{i, j}$</span><!-- Has MathJax --> 表示節點 <span>$i$</span><!-- Has MathJax --> 到節點 <span>$j$</span><!-- Has MathJax --> 的距離，如果 <span>$D_{i, j} = 0$</span><!-- Has MathJax --> ，視同沒有邊。</p>
<p>你可以假設每一條邊可能是單向的，保證至少一條 TSP 路徑。</p>
<ul>
<li><span>$3 &lt; N \leq 100$</span><!-- Has MathJax --></li>
<li><span>$0 &lt; \textit{distance between any pair of cities} \le 10000$</span><!-- Has MathJax -->
</li>
</ul>
<h2 id="Output-Format"><a href="#Output-Format" class="headerlink" title="Output Format"></a>Output Format</h2><p>輸出一行最小距離和。</p>
<h2 id="Sample-Input-1"><a href="#Sample-Input-1" class="headerlink" title="Sample Input 1"></a>Sample Input 1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">4</div><div class="line">0 10 15 20</div><div class="line">10 0 35 25</div><div class="line">15 35 0 30</div><div class="line">20 25 30 0</div></pre></td></tr></table></figure>
<h2 id="Sample-Output-1"><a href="#Sample-Output-1" class="headerlink" title="Sample Output 1"></a>Sample Output 1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">80</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><h3 id="初學第一步－窮舉"><a href="#初學第一步－窮舉" class="headerlink" title="初學第一步－窮舉"></a>初學第一步－窮舉</h3><p>從最直觀的想法中，我們可以使用窮舉 <span>$O(N!)$</span><!-- Has MathJax --> 解決，再搭配簡單的剪枝 (加上當前點 <span>$u$</span><!-- Has MathJax --> 返回起點的最短路徑長是否大於已知解)。當 <span>$N \ge 12$</span><!-- Has MathJax --> 時，理論運算次數達 4 億之多，運算時間相當於 1 秒左右 (粗估一般 CPU 可達 4 GHz)，接下來窮舉速度就不堪負荷。</p>
<blockquote>
<p>時間複雜度 <span>$O(N!)$</span><!-- Has MathJax --> ， 空間複雜度 <span>$O(N)$</span><!-- Has MathJax --></p>
</blockquote>
<h3 id="踏出第一步－動態規劃"><a href="#踏出第一步－動態規劃" class="headerlink" title="踏出第一步－動態規劃"></a>踏出第一步－動態規劃</h3><p>當學會動態規劃後，解決這一 NP-Complete 問題時，我們使用記憶體空間去掉重複換取時間，定義狀態 <code>dp[i][j]</code> 表示當前走過的點集合 <span>$i$</span><!-- Has MathJax --> ，停留最後一個點位置 <span>$j$</span><!-- Has MathJax --> ，點集合可以用 bitmask 的技巧壓縮，集合狀態個數 <span>$2^N$</span><!-- Has MathJax --> ，窮舉所有停留點轉移需要 <span>$O(N)$</span><!-- Has MathJax --> 次。當 <span>$N \ge 25$</span><!-- Has MathJax --> 時，理論次數達 8 億之多，再加上記憶體存取效能，導致運行約數十秒。</p>
<blockquote>
<p>時間複雜度 <span>$O(N^2 \cdot 2^N)$</span><!-- Has MathJax --> ， 空間複雜度 <span>$O(N \cdot 2^N)$</span><!-- Has MathJax --></p>
</blockquote>
<h3 id="更進一步"><a href="#更進一步" class="headerlink" title="更進一步"></a>更進一步</h3><p>我們發現到基礎窮舉中可以剪枝卻又不夠局觀，在動態規劃中擁有移除重複卻又不能剪枝，動態規劃又佔據大量的記憶體空間，那麼使用更厲害的 branch-and-reduce 算法吧。簡單介紹一下 branch-and-reduce 算法的特性：</p>
<ul>
<li>屬於窮舉的一環</li>
<li>在每一步中，花費較多的時間估算整體基礎花費，用來剪枝</li>
<li>窮舉一步之後，將盤面選擇縮小，甚至做到同構移除來減少窮舉分支，這個步驟稱為 reduce</li>
<li>使用的記憶體空間少 (與一般窮舉相當)</li>
</ul>
<p>運用在 TSP 問題時，我們首先將輸入轉換成 <span>$N \times N$</span><!-- Has MathJax --> 矩陣，當移動從 <span>$u$</span><!-- Has MathJax --> 到 <span>$v$</span><!-- Has MathJax --> 時，矩陣就會變成 <span>$(N-1) \times (N-1)$</span><!-- Has MathJax --> 大小。</p>
<h4 id="計算基礎花費"><a href="#計算基礎花費" class="headerlink" title="計算基礎花費"></a>計算基礎花費</h4><p>對於一個 TSP 而言，每一個點必然有入邊和出邊，因此基礎花費必然每一個節點權重最小的入邊和出邊總和。範例操作如下：</p>
<span>$$\begin{align*}
\text{cost matrix } M_5 = \begin{bmatrix}
\infty &amp; 20 &amp; 30 &amp; 10 &amp; 11 \\
15 &amp; \infty &amp; 16 &amp; 4 &amp; 2 \\
3 &amp; 5 &amp; \infty &amp; 2 &amp; 4 \\
19 &amp; 6 &amp; 18 &amp; \infty &amp; 3 \\
16 &amp; 4 &amp; 7 &amp; 16 &amp; \infty
\end{bmatrix}
\end{align*}$$</span><!-- Has MathJax -->
<p>計算出邊最小值，將每一行的最小值算出，例如第一行 <span>$[\infty \; 20 \; 30 \; 10 \; 11]$</span><!-- Has MathJax --> 為 10，最後分別扣掉 10, 2, 2, 3, 4，得到出邊基礎花費 <span>$10+2+2+3+4 = 21$</span><!-- Has MathJax --> ，接著我們扣除掉基礎花費得到</p>
<span>$$\begin{align*}
\text{reduce row, cost matrix } M_5 = \begin{bmatrix}
\infty &amp; 10 &amp; 20 &amp; 0 &amp; 1 \\
13 &amp; \infty &amp; 14 &amp; 2 &amp; 0 \\
1 &amp; 3 &amp; \infty &amp; 0 &amp; 2 \\
16 &amp; 3 &amp; 15 &amp; \infty &amp; 0 \\
12 &amp; 0 &amp; 3 &amp; 12 &amp; \infty
\end{bmatrix}
\end{align*}$$</span><!-- Has MathJax -->
<p>此時，我們再針對入邊找到基礎花費，將每一個列的最小值算出，分別為 1, 0, 3, 0, 0，因此得到基礎花費 <span>$21+1+3 = 25$</span><!-- Has MathJax --> ，如此一來當下限高於當前的最佳解就可以退出。下一階段的矩陣就會被改造成如下所示</p>
<span>$$\begin{align*}
\text{reduce row/column, cost matrix }M_5 = \begin{bmatrix}
\infty &amp; 10 &amp; 17 &amp; 0 &amp; 1 \\
12 &amp; \infty &amp; 11 &amp; 2 &amp; 0 \\
0 &amp; 3 &amp; \infty &amp; 0 &amp; 2 \\
15 &amp; 3 &amp; 12 &amp; \infty &amp; 0 \\
11 &amp; 0 &amp; 0 &amp; 12 &amp; \infty
\end{bmatrix}
\end{align*}$$</span><!-- Has MathJax -->
<p>當我們從某一點 <span>$u$</span><!-- Has MathJax --> 移動到 <span>$v$</span><!-- Has MathJax --> 時，移除掉矩陣中的某一行 <span>$u$</span><!-- Has MathJax --> 和某一列 <span>$v$</span><!-- Has MathJax --> 即可。特別注意到，上述範例為完全圖，對於稀疏圖會發生無解情況，需要特別判斷。</p>
<h4 id="優化一夜"><a href="#優化一夜" class="headerlink" title="優化一夜"></a>優化一夜</h4><p>用陣列實作不算困難，當抽出一行一列時，可能會需要複製整個矩陣，又或者只用標記來防止計算到經過的點，不管哪一種寫法都不算漂亮。這裡提供一個解決方法：在處理基礎花費時，對整個矩陣每行每列扣一個定值，實作時不真正修改數值，而是把差值記錄下來，用 <span>$O(N)$</span><!-- Has MathJax --> 空間 <span>$Dx[], \; Dy[]$</span><!-- Has MathJax --> 記錄差值，如此一來就不用耗費 <span>$O(N^2)$</span><!-- Has MathJax --> 空間和時間進行複製。</p>
<p>相對地，這會造成計算真正值 <span>$M&apos;_{x, y} = M_{x, y} - Dx[x] - Dy[y]$</span><!-- Has MathJax --> 需要數次的記憶體存取。無妨地，我們已經將了每一層的空間和搬運次數，又因為陣列小到可以全塞進快取中。</p>
<h4 id="優化二夜"><a href="#優化二夜" class="headerlink" title="優化二夜"></a>優化二夜</h4><p>對於稀疏圖而言，用矩陣實作過於浪費空間，而且很容易拖累速度，因此可以使用雙十字鏈表 Dancing Links 來模擬上述的矩陣，高效地降低運行常數。實作複雜度指數上升。</p>
<h4 id="優化三夜"><a href="#優化三夜" class="headerlink" title="優化三夜"></a>優化三夜</h4><p>遞迴窮舉必然會遇到復原操作，除非我們完整地複製每一層狀態。通常我們只會修改差異，這裡需要對整個矩陣修改，這導致差異數量非常多。為了加速復原操作，遞迴時維護自己 stack 來復原修改差異，而且僅當 <span>$Dx[], Dy[]$</span><!-- Has MathJax --> 不為零的時候才進行儲存，因為一部分的 reduce 結果會是零，這些影響的效能非常多。</p>
<p>除了上述外，計算基礎花費仍佔據了 <span>$O(N^2)$</span><!-- Has MathJax --> 的時間並佔大部分的運行時間。為了減少計算量，可以做到以下幾點：</p>
<ul>
<li>在每一行/列計算最小值時，走訪 Dancing Links 每一行每一列，如果當前最小值已經被更新到 0 時，可以直接退出。</li>
<li>傳遞當前已知最佳解，當累積計算花費總和高於已知解就退出。</li>
</ul>
<h4 id="優化四夜"><a href="#優化四夜" class="headerlink" title="優化四夜"></a>優化四夜</h4><p>從啟發的觀點來看，每一階段有 <span>$n$</span><!-- Has MathJax --> 種選擇，各別算出預期最少花費後，排序後優先從花費小的開始拓展。</p>
<blockquote>
<p>下述程式只支援頂點個數 30 以內，在頂點個數 30 時，只需要耗費 161 ms 即可完成。<br>當我將頂點個數放大 50 時，小夥伴們的程序花了 2 個小時還沒結果，而我寫的版本跑了 1X 秒就結束。測資的極限就只到這了，暫時先擱著吧。<a href="https://judgegirl.csie.org/problem/0/20007" target="_blank" rel="external">題目鏈結 20007. Fast Travelling Salesman Problem</a></p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXNODE 5000</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXCOL 32</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 32</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> INF 0x3f3f3f</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DancingNode</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> left, right, up, down;</div><div class="line">    <span class="keyword">int</span> ch, rh, w;</div><div class="line">&#125; DL[MAXNODE];</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">HelperNode</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> head, size, next, prev;</div><div class="line">&#125; HN[MAXNODE];</div><div class="line"><span class="keyword">int</span> help_head;</div><div class="line"><span class="keyword">int</span> s[MAXCOL];</div><div class="line"><span class="keyword">int</span> head, size, Ans;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Remove</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</div><div class="line">    DL[DL[c].right].left = DL[c].left;</div><div class="line">    DL[DL[c].left].right = DL[c].right;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = DL[c].down; i != c; i = DL[i].down) &#123;</div><div class="line">    	<span class="keyword">if</span> (HN[DL[i].rh].head == i)</div><div class="line">    		HN[DL[i].rh].head = DL[i].left;</div><div class="line">    	HN[DL[i].rh].size--;</div><div class="line">        DL[DL[i].right].left = DL[i].left;</div><div class="line">        DL[DL[i].left].right = DL[i].right;</div><div class="line">        s[DL[i].ch]--;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Resume</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = DL[c].down; i != c; i = DL[i].down) &#123;</div><div class="line">    	<span class="keyword">if</span> (HN[DL[i].rh].head == i)</div><div class="line">    		HN[DL[i].rh].head = DL[i].right;</div><div class="line">    	HN[DL[i].rh].size++;</div><div class="line">        DL[DL[i].right].left = i;</div><div class="line">        DL[DL[i].left].right = i;</div><div class="line">        s[DL[i].ch]++;</div><div class="line">    &#125;</div><div class="line">    DL[DL[c].right].left = c;</div><div class="line">    DL[DL[c].left].right = c;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Reduce</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> t = DL[i].rh;</div><div class="line">    HN[HN[t].next].prev = HN[t].prev;</div><div class="line">    HN[HN[t].prev].next = HN[t].next;</div><div class="line">    s[DL[i].ch]--;</div><div class="line">    </div><div class="line">    DL[DL[i].down].up = DL[i].up;</div><div class="line">    DL[DL[i].up].down = DL[i].down;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = DL[i].right; k != i; k = DL[k].right) &#123;</div><div class="line">        DL[DL[k].down].up = DL[k].up;</div><div class="line">        DL[DL[k].up].down = DL[k].down;</div><div class="line">        s[DL[k].ch]--;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Recover</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> t = DL[i].rh;</div><div class="line">    HN[HN[t].next].prev = t;</div><div class="line">    HN[HN[t].prev].next = t;</div><div class="line">    s[DL[i].ch]++;</div><div class="line">    </div><div class="line">    DL[DL[i].down].up = i;</div><div class="line">    DL[DL[i].up].down = i;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = DL[i].right; k != i; k = DL[k].right) &#123;</div><div class="line">        DL[DL[k].down].up = k;</div><div class="line">        DL[DL[k].up].down = k;</div><div class="line">        s[DL[k].ch]++;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Select</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> s = DL[i].rh;</div><div class="line">    Reduce(i);</div><div class="line">    Remove(j);</div><div class="line">    HN[HN[s].next].prev = HN[s].prev;</div><div class="line">    HN[HN[s].prev].next = HN[s].next;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Cancel</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> s = DL[i].rh;</div><div class="line">    Resume(j);</div><div class="line">    Recover(i);</div><div class="line">    HN[HN[s].next].prev = s;</div><div class="line">    HN[HN[s].prev].next = s;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">new_node</span><span class="params">(<span class="keyword">int</span> up, <span class="keyword">int</span> down, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</div><div class="line">    DL[size].up = up, DL[size].down = down;</div><div class="line">    DL[size].left = left, DL[size].right = right;</div><div class="line">    DL[up].down = DL[down].up = DL[left].right = DL[right].left = size;</div><div class="line">    <span class="keyword">return</span> size++;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">new_row</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> R[][<span class="number">2</span>], <span class="keyword">int</span> rh)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> r, row = <span class="number">-1</span>, k;</div><div class="line">    <span class="keyword">int</span> h = size;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">        r = R[i][<span class="number">0</span>];</div><div class="line">        DL[size].ch = r, s[r]++;</div><div class="line">        DL[size].rh = rh;</div><div class="line">        DL[size].w = R[i][<span class="number">1</span>];</div><div class="line">        <span class="keyword">if</span> (row == <span class="number">-1</span>) &#123;</div><div class="line">            row = new_node(DL[DL[r].ch].up, DL[r].ch, size, size);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            k = new_node(DL[DL[r].ch].up, DL[r].ch, DL[row].left, row);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    HN[rh].size = n;</div><div class="line">    HN[rh].head = h;</div><div class="line">    HN[rh].next = HN[help_head].next;</div><div class="line">    HN[rh].prev = help_head;</div><div class="line">    HN[HN[help_head].next].prev = rh;</div><div class="line">    HN[help_head].next = rh;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> m)</span> </span>&#123;</div><div class="line">    size = <span class="number">0</span>;</div><div class="line">    help_head = <span class="number">0</span>, HN[help_head].next = HN[help_head].prev = help_head;</div><div class="line">    head = new_node(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++) &#123;</div><div class="line">        new_node(i, i, DL[head].left, head);</div><div class="line">        DL[i].ch = i, s[i] = <span class="number">0</span>;</div><div class="line">        DL[i].rh = <span class="number">0</span>;	<span class="comment">// important pointer (fail pointer)</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> Dx[MAXN], Dy[MAXN];</div><div class="line"><span class="keyword">int</span> markRStk[MAXNODE], markRidx = <span class="number">-1</span>;</div><div class="line"><span class="keyword">int</span> markCStk[MAXNODE], markCidx = <span class="number">-1</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">printDL</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = HN[help_head].prev; i != help_head; i = HN[i].prev) &#123;</div><div class="line">        <span class="keyword">int</span> j = HN[i].head, prev = <span class="number">1</span>;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%2d "</span>, DL[j].rh);</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            <span class="keyword">while</span> (prev &lt; DL[j].ch)</div><div class="line">                prev++, <span class="built_in">printf</span>(<span class="string">" -- "</span>);</div><div class="line">            prev = DL[j].ch+<span class="number">1</span>;</div><div class="line">            <span class="keyword">int</span> rh = DL[j].rh, ch = DL[j].ch;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"[%2d]"</span>, DL[j].w - Dx[rh] - Dy[ch]);</div><div class="line">            j = DL[j].right;</div><div class="line">        &#125; <span class="keyword">while</span> (j != HN[i].head);</div><div class="line">        <span class="keyword">while</span> (prev &lt;= n)</div><div class="line">            prev++, <span class="built_in">printf</span>(<span class="string">" -- "</span>);</div><div class="line">        <span class="built_in">puts</span>(<span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">puts</span>(<span class="string">"----------------------"</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">cH</span><span class="params">(<span class="keyword">int</span> limit = INF)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> ins = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = HN[help_head].prev; i != help_head; i = HN[i].prev) &#123;</div><div class="line">        <span class="keyword">if</span> (HN[i].size == <span class="number">0</span>)</div><div class="line">            <span class="keyword">return</span> INF;</div><div class="line">        <span class="keyword">int</span> j = HN[i].head, v = INF;</div><div class="line">        <span class="keyword">int</span> rh = DL[j].rh, ch;</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            ch = DL[j].ch;</div><div class="line">            v = min(v, DL[j].w - Dx[rh] - Dy[ch]);</div><div class="line">            j = DL[j].right;</div><div class="line">        &#125; <span class="keyword">while</span> (j != HN[i].head &amp;&amp; v);</div><div class="line">        <span class="keyword">if</span> (v == INF || ins+v &gt;= limit)</div><div class="line">            <span class="keyword">return</span> INF;</div><div class="line">        <span class="keyword">if</span> (v) &#123;</div><div class="line">            ins += v;</div><div class="line">            Dx[rh] += v;</div><div class="line">            markRStk[++markRidx] = v;</div><div class="line">            markRStk[++markRidx] = rh;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">	printf("cH first\n");</span></div><div class="line"><span class="comment">	printDL(4);</span></div><div class="line"><span class="comment">*/</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = DL[head].right; i != head; i = DL[i].right) &#123;</div><div class="line">        <span class="keyword">if</span> (DL[i].down == i)</div><div class="line">            <span class="keyword">return</span> INF;</div><div class="line">        <span class="keyword">int</span> j = DL[i].down, v = INF;</div><div class="line">        <span class="keyword">int</span> ch = DL[i].ch, rh;</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            rh = DL[j].rh;</div><div class="line">            v = min(v, DL[j].w - Dx[rh] - Dy[ch]);</div><div class="line">            j = DL[j].down;</div><div class="line">        &#125; <span class="keyword">while</span> (j != i &amp;&amp; v);</div><div class="line">        <span class="keyword">if</span> (v == INF || ins+v &gt;= limit)</div><div class="line">            <span class="keyword">return</span> INF;</div><div class="line">        <span class="keyword">if</span> (v) &#123;</div><div class="line">            ins += v;</div><div class="line">            Dy[ch] += v;</div><div class="line">            markCStk[++markCidx] = v;</div><div class="line">            markCStk[++markCidx] = ch;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ins;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">rH</span><span class="params">(<span class="keyword">int</span> backRidx, <span class="keyword">int</span> backCidx)</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (markRidx &gt; backRidx) &#123;</div><div class="line">        <span class="keyword">int</span> a = markRStk[markRidx--];</div><div class="line">        <span class="keyword">int</span> b = markRStk[markRidx--];</div><div class="line">        Dx[a] -= b;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span> (markCidx &gt; backCidx) &#123;</div><div class="line">        <span class="keyword">int</span> a = markCStk[markCidx--];</div><div class="line">        <span class="keyword">int</span> b = markCStk[markCidx--];</div><div class="line">        Dy[a] -= b;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SAME_CUT</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">isSame</span><span class="params">(<span class="keyword">int</span> vx, <span class="keyword">int</span> vy)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> i = HN[vx].head, j = HN[vy].head;</div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="keyword">if</span> (DL[i].ch != DL[j].ch &amp;&amp; (DL[i].ch != vy &amp;&amp; DL[j].ch != vx))</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> e1 = DL[i].w - Dx[vx] - Dy[DL[i].ch];</div><div class="line">        <span class="keyword">int</span> e2 = DL[j].w - Dx[vy] - Dy[DL[j].ch];</div><div class="line">        <span class="keyword">if</span> (e1 != e2)</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        i = DL[i].right;</div><div class="line">        j = DL[j].right;	</div><div class="line">    &#125; <span class="keyword">while</span> (i != HN[vx].head &amp;&amp; j != HN[vy].head);</div><div class="line">    <span class="keyword">return</span> i == HN[vx].head &amp;&amp; j == HN[vy].head;</div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MST_CUT</span></div><div class="line"><span class="keyword">int</span> parent[MAXN];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">findp</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> x == parent[x] ? x : (parent[x]=findp(parent[x]));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">joint</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">    x = findp(x), y = findp(y);</div><div class="line">    <span class="keyword">if</span> (x == y) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    parent[y] = x;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">MST</span><span class="params">(<span class="keyword">int</span> st, <span class="keyword">int</span> ed, <span class="keyword">int</span> limit = INF)</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> used[MAXN] = &#123;&#125;, cases = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (HN[HN[help_head].prev].prev == help_head)</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> i = HN[help_head].prev;</div><div class="line">    <span class="keyword">int</span> n = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>, in = INF, out = INF;</div><div class="line">    cases++;</div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="keyword">int</span> j = HN[i].head;</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            <span class="keyword">int</span> x = DL[j].rh, y = DL[j].ch;</div><div class="line">            <span class="keyword">int</span> w = DL[j].w - Dx[x] - Dy[y];</div><div class="line">            <span class="keyword">if</span> (x == st) &#123;</div><div class="line">                in = min(in, w);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (y == ed) &#123;</div><div class="line">                out = min(out, w);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (used[x] != cases)</div><div class="line">                    used[x] = cases, parent[x] = x, n++;</div><div class="line">                <span class="keyword">if</span> (used[y] != cases)</div><div class="line">                    used[y] = cases, parent[y] = y, n++;</div><div class="line">                n -= joint(x, y);</div><div class="line">            &#125;</div><div class="line">            j = DL[j].right;</div><div class="line">        &#125; <span class="keyword">while</span> (j != HN[i].head);</div><div class="line">        i = HN[i].prev;</div><div class="line">    &#125; <span class="keyword">while</span> (i != help_head);</div><div class="line">    ret = in + out;</div><div class="line">    <span class="keyword">if</span> (ret &gt;= limit)</div><div class="line">        <span class="keyword">return</span> limit;</div><div class="line">    <span class="keyword">if</span> (n &gt; <span class="number">1</span>) &#123;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"cc cut\n"</span>);</div><div class="line">        <span class="keyword">return</span> INF;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> </span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">DFS</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> lower_bound)</span> </span>&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MST_CUT</span></div><div class="line">    <span class="keyword">if</span> (lower_bound + MST(u, <span class="number">1</span>, Ans - lower_bound) &gt;= Ans) &#123;</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="keyword">if</span> (lower_bound &gt;= Ans) &#123;</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (HN[HN[help_head].prev].prev == help_head) &#123;</div><div class="line">        Ans = lower_bound;</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> i = HN[u].head;</div><div class="line">    <span class="built_in">vector</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt; pick;</div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="keyword">int</span> v = DL[i].ch;</div><div class="line">        <span class="keyword">int</span> runnable = <span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span> (v == <span class="number">1</span>)</div><div class="line">            runnable = <span class="number">0</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SAME_CUT</span></div><div class="line">        <span class="keyword">if</span> (runnable) &#123;</div><div class="line">            <span class="keyword">int</span> e1 = DL[i].w - Dx[u] - Dy[v];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = HN[u].head; j != i &amp;&amp; runnable; j = DL[j].right) &#123;</div><div class="line">                <span class="keyword">int</span> e2 = DL[j].w - Dx[u] - Dy[DL[j].ch];</div><div class="line">                <span class="keyword">if</span> (e1 != e2)</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                <span class="keyword">if</span> (isSame(v, DL[j].ch))</div><div class="line">                    runnable = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (runnable) &#123;</div><div class="line">            <span class="keyword">int</span> backRidx = markRidx, backCidx = markCidx;</div><div class="line">            <span class="keyword">int</span> tu = HN[u].head;</div><div class="line">            Select(tu, v);</div><div class="line">            <span class="keyword">int</span> c = cH(Ans - lower_bound);</div><div class="line">            <span class="keyword">if</span> (c != INF) &#123;</div><div class="line">                pick.push_back(make_pair(lower_bound + c + DL[i].w-Dx[u]-Dy[v], v));</div><div class="line">            <span class="comment">//	DFS(v, lower_bound + c + DL[i].w-Dx[u]-Dy[v]);</span></div><div class="line">            &#125;</div><div class="line">            rH(backRidx, backCidx);</div><div class="line">            Cancel(tu, v);</div><div class="line">        &#125;</div><div class="line">        i = DL[i].right;</div><div class="line">    &#125; <span class="keyword">while</span> (i != HN[u].head);</div><div class="line"></div><div class="line">    sort(pick.begin(), pick.end());</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pick.size(); i++) &#123;</div><div class="line">        <span class="keyword">int</span> v = pick[i].second;	</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">		printf("%d -&gt; %d, %d\n", u, v, pick[i].first);</span></div><div class="line"><span class="comment">		printDL(4);</span></div><div class="line"><span class="comment">*/</span></div><div class="line">        <span class="keyword">int</span> backRidx = markRidx, backCidx = markCidx;</div><div class="line">        <span class="keyword">int</span> tu = HN[u].head;</div><div class="line">        Select(tu, v);</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">		printf("Select\n");</span></div><div class="line"><span class="comment">		printDL(4);</span></div><div class="line"><span class="comment">*/</span></div><div class="line">        <span class="keyword">int</span> c = cH(Ans - lower_bound);</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">		printf("Reduce\n");</span></div><div class="line"><span class="comment">		printDL(4);</span></div><div class="line"><span class="comment">*/</span></div><div class="line">        <span class="keyword">if</span> (c != INF)</div><div class="line">            DFS(v, pick[i].first);</div><div class="line">        rH(backRidx, backCidx);</div><div class="line">        Cancel(tu, v);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> G[MAXN][MAXN];</div><div class="line">    <span class="keyword">int</span> n;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n) == <span class="number">1</span>) &#123;</div><div class="line">        init(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            <span class="keyword">int</span> R[MAXN][<span class="number">2</span>], Rcnt = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j++) &#123;</div><div class="line">                assert(<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;G[i][j]) == <span class="number">1</span>);</div><div class="line">                <span class="keyword">if</span> (G[i][j])</div><div class="line">                    R[Rcnt][<span class="number">0</span>] = j, R[Rcnt][<span class="number">1</span>] = G[i][j], Rcnt++;</div><div class="line">            &#125;</div><div class="line">            new_row(Rcnt, R, i);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> backRidx = markRidx, backCidx = markCidx;</div><div class="line">        Ans = INF;</div><div class="line">        DFS(<span class="number">1</span>, cH());</div><div class="line">        rH(backRidx, backCidx);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, Ans);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-jg-20008" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/18/jg-20008/" class="article-date">
  <time datetime="2016-12-18T03:14:07.000Z" itemprop="datePublished">2016-12-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/18/jg-20008/">淺談多重背包問題 (Multiple Knapsack Problem) 優化那些事</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/12/18/jg-20008/" data-id="ckxv7t8tv006ulkvntc4n2cpa" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/12/18/jg-20008/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DP/">DP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/monotone-queue/">monotone queue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化/">優化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/單調堆/">單調堆</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/背包問題/">背包問題</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>收錄於 <a href="https://judgegirl.csie.org/problem/0/20008" target="_blank" rel="external">批改娘 20008. Fast Multiple Knapsack Problem</a></p>
<p>之所以出了這一題，源自於實驗室另一名同學跑實驗太久，進而撰寫優化程序。聽說原本跑了十分鐘的實驗，改善後提升了到一分鐘跑完。</p>
</blockquote>
<h2 id="輸入格式"><a href="#輸入格式" class="headerlink" title="輸入格式"></a>輸入格式</h2><p>每組測資第一行包含兩個正整數，分別代表背包大小 $M$ ($\leq 10^6$) 和物品個數 $N$ ($\leq 1000$)，下一行開始每行包含兩個正整數，分別代表物品價值 $P_i$ ($\leq 10^3$)、物品重量 $W_i$ ($ \leq 10^5$) 以及物品最多可以挑 $C_i$ 個 ($\le 100$)。</p>
<h2 id="輸出格式"><a href="#輸出格式" class="headerlink" title="輸出格式"></a>輸出格式</h2><p>對於每組測資，請輸出最大收益。</p>
<h2 id="範例輸入-1"><a href="#範例輸入-1" class="headerlink" title="範例輸入 1"></a>範例輸入 1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">50 7</div><div class="line">66 31 1</div><div class="line">232 10 4</div><div class="line">49 20 1</div><div class="line">54 19 1</div><div class="line">426 4 3</div><div class="line">589 3 10</div><div class="line">10 6 4</div></pre></td></tr></table></figure>
<h2 id="範例輸出-1"><a href="#範例輸出-1" class="headerlink" title="範例輸出 1"></a>範例輸出 1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">7178</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><blockquote>
<p>不管是 0/1 背包或者多重背包，兩者都屬於 bounded knapsack problem 問題。即便如此，優化上仍有些許的不同，請讓我緩緩道來。</p>
</blockquote>
<p>在此之前，您必須先理解上一篇《淺談背包問題 (0/1 Knapsack Problem) 優化那些事》的部分，不然會造成閱讀上的困難。</p>
<p>多重背包有一個二進制優化，也就是當物品限制最多拿 <span>$C$</span><!-- Has MathJax --> 個時，我們可以利用二進制組合的方式，轉換到 0/1 背包問題，因此我們會得到新的 <span>$N \log C$</span><!-- Has MathJax --> 個物品跑一次 0/1 背包，因此複雜度落在 <span>$O(N \log C \; W)$</span><!-- Has MathJax --> </p>
<p>然而，從公式定義上，在好幾年前的論文中，使用斜率優化降到 <span>$O(N \; W)$</span><!-- Has MathJax -->，推倒過程如下，</p>
<span>$j = k \; w_i + r, \; 0 \le r \le w_i - 1$</span><!-- Has MathJax -->
<span>$$\begin{align*}
dp[i][j] &amp;= \max\left\{dp[i-1][j], dp[i-1][j-w_i]+p_i, \cdots, dp[i-1][j-c_i \; w_i] + c_i \; p_i\right\} \\
&Tab;&amp;= \max\left\{dp[i-1][k \; w_i + r], dp[i-1][(k-1) \; w_i + r] + p_i, \cdots
&Tab;&Tab;, dp[i-1][(k-c_i) \; w_i + r] + c_i p_i\right\} \\
&Tab;&amp;= \max\left\{dp[i-1][k \; w_i + r] - k \; p_i, dp[i-1][(k-1) \; w_i + r] + (k-1) \; p_i, \cdots
&Tab;&Tab;, dp[i-1][(k-c_i) \; w_i + r] - (k-c_i) p_i\right\} + k \; p_i\\
\end{align*}$$</span><!-- Has MathJax -->
<p>隨著式子的轉移，我們發現每一個取值將不依賴相對位置，只跟自身的位置有關，那麼可以使用單調堆 (monotone queue) 運行 <span>$O(1)$</span><!-- Has MathJax --> 的 sliding windows 查找極值。最後，將相同餘數分堆處理，單調堆中最多存在 <span>$O(c)$</span><!-- Has MathJax --> 個元素。</p>
<h3 id="優化初夜"><a href="#優化初夜" class="headerlink" title="優化初夜"></a>優化初夜</h3><blockquote>
<p>如果只使用二進制優化，套上我們的 0/1 優化方案，將有大幅度地提升。</p>
</blockquote>
<p>加入 0/1 背包的優化策略，再套上最簡單的斜率優化算法，得到下面的程式。這裡很懶惰地，由於單調堆最多入隊 <span>$W$</span><!-- Has MathJax --> 次，不外乎地直接只用大小為 <span>$W$</span><!-- Has MathJax --> 的方式實作。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> &#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXW = <span class="number">1000005</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1005</span>;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BB</span> &#123;</span></div><div class="line">        <span class="keyword">int</span> w, v, c;</div><div class="line">        BB(<span class="keyword">int</span> w = <span class="number">0</span>, <span class="keyword">int</span> v = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>):</div><div class="line">            w(w), v(v), c(c) &#123;&#125;</div><div class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> BB &amp;x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> w * c  &lt; x.w * x.c;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(BB A[], <span class="keyword">int</span> dp[], <span class="keyword">int</span> W, <span class="keyword">int</span> N)</span> </span>&#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> MQ[MAXW][<span class="number">2</span>];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> w = A[i].w, v = A[i].v, c = A[i].c;</div><div class="line">            sum = min(sum + w*c, W);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; w; j++) &#123;</div><div class="line">                <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="number">0</span>;</div><div class="line">                MQ[l][<span class="number">0</span>] = <span class="number">0</span>, MQ[l][<span class="number">1</span>] = dp[j];</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>; k*w+j &lt;= sum; k++) &#123;</div><div class="line">                    <span class="keyword">if</span> (k - MQ[l][<span class="number">0</span>] &gt; c)	</div><div class="line">                        l++;</div><div class="line">                    <span class="keyword">int</span> dpv = dp[k*w+j] - k*v;</div><div class="line">                    <span class="keyword">while</span> (l &lt;= r &amp;&amp; MQ[r][<span class="number">1</span>] &lt;= dpv)</div><div class="line">                        r--;</div><div class="line">                    r++;</div><div class="line">                    MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</div><div class="line">                    dp[k*w+j] = max(dp[k*w+j], MQ[l][<span class="number">1</span>] + k*v);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;	</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">knapsack</span><span class="params">(<span class="keyword">int</span> C[][<span class="number">3</span>], <span class="keyword">int</span> N, <span class="keyword">int</span> W)</span> </span>&#123;</div><div class="line">        <span class="built_in">vector</span>&lt;BB&gt; A;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> w = C[i][<span class="number">0</span>], v = C[i][<span class="number">1</span>], c = C[i][<span class="number">2</span>];</div><div class="line">            A.push_back(BB(w, v, c));</div><div class="line">        &#125;</div><div class="line">        assert(N &lt; MAXN);</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> dp1[MAXW+<span class="number">1</span>], dp2[MAXW+<span class="number">1</span>];</div><div class="line">        BB Ar[<span class="number">2</span>][MAXN];</div><div class="line">        <span class="keyword">int</span> ArN[<span class="number">2</span>] = &#123;&#125;;</div><div class="line">        <span class="built_in">memset</span>(dp1, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp1[<span class="number">0</span>])*(W+<span class="number">1</span>));</div><div class="line">        <span class="built_in">memset</span>(dp2, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp2[<span class="number">0</span>])*(W+<span class="number">1</span>));</div><div class="line">        sort(A.begin(), A.end());</div><div class="line">        <span class="keyword">int</span> sum[<span class="number">2</span>] = &#123;&#125;;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> ch = sum[<span class="number">1</span>] &lt; sum[<span class="number">0</span>];</div><div class="line">            Ar[ch][ArN[ch]] = A[i];</div><div class="line">            ArN[ch]++;</div><div class="line">            sum[ch] = min(sum[ch] + A[i].w*A[i].c, W);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        run(Ar[<span class="number">0</span>], dp1, W, ArN[<span class="number">0</span>]);</div><div class="line">        run(Ar[<span class="number">1</span>], dp2, W, ArN[<span class="number">1</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = W, mx = <span class="number">0</span>; i &lt;= W; i++, j--) &#123;</div><div class="line">            mx = max(mx, dp2[i]);</div><div class="line">            ret = max(ret, dp1[j] + mx);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> W, N;</div><div class="line">    assert(<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;W, &amp;N) == <span class="number">2</span>);</div><div class="line">    <span class="keyword">int</span> C[MAXN][<span class="number">3</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">        assert(<span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;C[i][<span class="number">1</span>], &amp;C[i][<span class="number">0</span>], &amp;C[i][<span class="number">2</span>]) == <span class="number">3</span>);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, knapsack(C, N, W));</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不幸地，相較於一般的斜率優化寫法，並沒有太大的改善。</p>
<h3 id="優化二夜"><a href="#優化二夜" class="headerlink" title="優化二夜"></a>優化二夜</h3><p>運行 sliding windows 操作時，前 <span>$c$</span><!-- Has MathJax --> 次，是不會進行 <code>pop_front()</code> 操作的，因此把迴圈分兩堆處理，增加 branch predict。以及在乘數運算上，使用強度減少 (strength reduction) 的技術，將乘法換成加法。</p>
<blockquote>
<p>只能些許地改善 5% 的效能。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(BB A[], <span class="keyword">int</span> dp[], <span class="keyword">int</span> W, <span class="keyword">int</span> N)</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> MQ[MAXW][<span class="number">2</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">        <span class="keyword">int</span> w = A[i].w, v = A[i].v, c = A[i].c;</div><div class="line">        sum = min(sum + w*c, W);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; w; j++) &#123;</div><div class="line">            <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="number">0</span>;</div><div class="line">            MQ[l][<span class="number">0</span>] = <span class="number">0</span>, MQ[l][<span class="number">1</span>] = dp[j];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>, tw = w+j, tv = v; tw &lt;= sum &amp;&amp; k &lt;= c; k++, tw += w, tv += v) &#123;</div><div class="line">                <span class="keyword">int</span> dpv = dp[tw] - tv;</div><div class="line">                <span class="keyword">while</span> (l &lt;= r &amp;&amp; MQ[r][<span class="number">1</span>] &lt;= dpv)</div><div class="line">                    r--;</div><div class="line">                r++;</div><div class="line">                MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</div><div class="line">                dp[tw] = max(dp[tw], MQ[l][<span class="number">1</span>] + tv);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = c+<span class="number">1</span>, tw = (c+<span class="number">1</span>)*w+j, tv = (c+<span class="number">1</span>)*v; tw &lt;= sum; k++, tw += w, tv += v) &#123;</div><div class="line">                <span class="keyword">if</span> (k - MQ[l][<span class="number">0</span>] &gt; c)   </div><div class="line">                    l++;</div><div class="line">                <span class="keyword">int</span> dpv = dp[tw] - tv;</div><div class="line">                <span class="keyword">while</span> (l &lt;= r &amp;&amp; MQ[r][<span class="number">1</span>] &lt;= dpv)</div><div class="line">                    r--;</div><div class="line">                r++;</div><div class="line">                MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</div><div class="line">                dp[tw] = max(dp[tw], MQ[l][<span class="number">1</span>] + tv);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="優化三夜"><a href="#優化三夜" class="headerlink" title="優化三夜"></a>優化三夜</h3><p>後來發現，sliding windows 滑動時，我們常常看前看後，因此常常會發生 cache miss，因為他要跳躍一大段記憶體空間查找數值，所以可以考慮花點操作將極值放在 stack 上，視為一種 software cache 來加速，來減少 cache miss 的懲罰。</p>
<p>接著，在迴圈邊界比較時，我們可以算得更精準些，回到一般的 <code>i++</code> 的 format pattern，讓編譯器幫我們做常見的迴圈優化。</p>
<blockquote>
<p>改善了 10% 效能</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(BB A[], <span class="keyword">int</span> dp[], <span class="keyword">int</span> W, <span class="keyword">int</span> N)</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> MQ[MAXW][<span class="number">2</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">        <span class="keyword">int</span> w = A[i].w, v = A[i].v, c = A[i].c;</div><div class="line">        sum = min(sum + w*c, W);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; w; j++) &#123;</div><div class="line">            <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="number">0</span>;</div><div class="line">            MQ[l][<span class="number">0</span>] = <span class="number">0</span>, MQ[l][<span class="number">1</span>] = dp[j];</div><div class="line">            <span class="keyword">int</span> cache_max = MQ[l][<span class="number">1</span>], cache_idx = MQ[l][<span class="number">0</span>];</div><div class="line">            <span class="keyword">int</span> k_bound;</div><div class="line">            k_bound = min((sum-j)/w, c);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>, tw = w+j, tv = v; k &lt;= k_bound; k++, tw += w, tv += v) &#123;</div><div class="line">                <span class="comment">// tw = k*w+j, tv = k*v;</span></div><div class="line">                <span class="keyword">int</span> dpv = dp[tw] - tv;</div><div class="line">                <span class="keyword">while</span> (l &lt;= r &amp;&amp; MQ[r][<span class="number">1</span>] &lt;= dpv)</div><div class="line">                    r--;</div><div class="line">                r++;</div><div class="line">                MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</div><div class="line">                <span class="keyword">if</span> (r == l)    cache_max = dpv, cache_idx = k;</div><div class="line">                dp[tw] = max(dp[tw], cache_max + tv);</div><div class="line">            &#125;</div><div class="line">            k_bound = (sum-j)/w;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = c+<span class="number">1</span>, tw = (c+<span class="number">1</span>)*w+j, tv = (c+<span class="number">1</span>)*v; k &lt;= k_bound; k++, tw += w, tv += v) &#123;</div><div class="line">                <span class="keyword">int</span> dpv = dp[tw] - tv;</div><div class="line">                <span class="keyword">while</span> (l &lt;= r &amp;&amp; MQ[r][<span class="number">1</span>] &lt;= dpv)</div><div class="line">                    r--;</div><div class="line">                r++;</div><div class="line">                MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</div><div class="line">                <span class="keyword">if</span> (r == l)   </div><div class="line">                    cache_max = dpv, cache_idx = k;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (k - cache_idx &gt; c)   </div><div class="line">                    l++, cache_idx = MQ[l][<span class="number">0</span>], cache_max = MQ[l][<span class="number">1</span>];</div><div class="line">                dp[tw] = max(dp[tw], cache_max + tv);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125; </div></pre></td></tr></table></figure>
<h3 id="優化四夜"><a href="#優化四夜" class="headerlink" title="優化四夜"></a>優化四夜</h3><p>儘管上面使用的 software cache 的方式減少 cache miss，但 DP table 仍與數據結構的記憶體位置相當遙遠，為了使他們貼近，應使用環狀隊列的實作，空間從 <span>$O(W)$</span><!-- Has MathJax --> 將到 <span>$O(N)$</span><!-- Has MathJax -->，實作時，將大小限制在 <span>$2^k$</span><!-- Has MathJax -->，方便運行時使用 AND 運算取代耗時的模數運算。</p>
<p>由於限制個數分佈上，很容易造成貪心算法有解，因此先跑一次貪心，如果貪心沒辦法達到剛好大小，那麼再跑 DP 找解。DP 找解時，可以將物品嘗試進行二進制轉換，將等價物品合併，來觸發計算邊界的優化。完成的程序如下：</p>
<blockquote>
<p>最終加速，改善 10%，期待你我的分享增進。根據鴿籠原理，cp 直種類不多時，可以高達 10 倍以上的加速。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> &#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXW = <span class="number">1000005</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1005</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXC = <span class="number">1</span>&lt;&lt;<span class="number">12</span>;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BB</span> &#123;</span></div><div class="line">        <span class="keyword">int</span> w, v, c;</div><div class="line">        BB(<span class="keyword">int</span> w = <span class="number">0</span>, <span class="keyword">int</span> v = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>):</div><div class="line">            w(w), v(v), c(c) &#123;&#125;</div><div class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> BB &amp;x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> w * c  &lt; x.w * x.c;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">cmpByWeight</span><span class="params">(BB x, BB y)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> x.w &lt; y.w;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(BB A[], <span class="keyword">int</span> dp[], <span class="keyword">int</span> W, <span class="keyword">int</span> N)</span> </span>&#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> MQ[MAXC][<span class="number">2</span>];</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> w = A[i].w, v = A[i].v, c = A[i].c;</div><div class="line">            assert(c &lt; MAXC);</div><div class="line">            sum = min(sum + w*c, W);</div><div class="line">            <span class="keyword">if</span> (c != <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; w; j++) &#123;</div><div class="line">                    <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="number">0</span>;</div><div class="line">                    MQ[r][<span class="number">0</span>] = <span class="number">0</span>, MQ[r][<span class="number">1</span>] = dp[j];</div><div class="line">                    <span class="keyword">int</span> cache_max = MQ[r][<span class="number">1</span>], cache_idx = MQ[r][<span class="number">0</span>];</div><div class="line">                    <span class="keyword">int</span> k_bound;</div><div class="line">                    r = (r+<span class="number">1</span>)&amp;(MAXC<span class="number">-1</span>);</div><div class="line">                    k_bound = min((sum-j)/w, c);</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>, tw = w+j, tv = v; k &lt;= k_bound; k++, tw += w, tv += v) &#123;</div><div class="line">                        <span class="comment">// tw = k*w+j, tv = k*v;</span></div><div class="line">                        <span class="keyword">int</span> dpv = dp[tw] - tv;</div><div class="line">                        <span class="keyword">while</span> (l != r &amp;&amp; MQ[(r<span class="number">-1</span>+MAXC)&amp;(MAXC<span class="number">-1</span>)][<span class="number">1</span>] &lt;= dpv)</div><div class="line">                            r = (r<span class="number">-1</span>+MAXC)&amp;(MAXC<span class="number">-1</span>);</div><div class="line">                        MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</div><div class="line">                        <span class="keyword">if</span> (l == r)	cache_max = dpv, cache_idx = k;</div><div class="line">                        r = (r+<span class="number">1</span>)&amp;(MAXC<span class="number">-1</span>);</div><div class="line">                        dp[tw] = max(dp[tw], cache_max + tv);</div><div class="line">                    &#125;</div><div class="line">                    k_bound = (sum-j)/w;</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> k = c+<span class="number">1</span>, tw = (c+<span class="number">1</span>)*w+j, tv = (c+<span class="number">1</span>)*v; k &lt;= k_bound; k++, tw += w, tv += v) &#123;</div><div class="line">                        <span class="keyword">int</span> dpv = dp[tw] - tv;</div><div class="line">                        <span class="keyword">while</span> (l != r &amp;&amp; MQ[(r<span class="number">-1</span>+MAXC)&amp;(MAXC<span class="number">-1</span>)][<span class="number">1</span>] &lt;= dpv)</div><div class="line">                            r--;</div><div class="line">                        MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</div><div class="line">                        <span class="keyword">if</span> (l == r)	cache_max = dpv, cache_idx = k;</div><div class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (k - cache_idx &gt; c)	</div><div class="line">                            l = (l+<span class="number">1</span>)&amp;(MAXC<span class="number">-1</span>), cache_idx = MQ[l][<span class="number">0</span>], cache_max = MQ[l][<span class="number">1</span>];</div><div class="line">                        r = (r+<span class="number">1</span>)&amp;(MAXC<span class="number">-1</span>);</div><div class="line">                        dp[tw] = max(dp[tw], cache_max + tv);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = sum; j &gt;= w; j--)</div><div class="line">                    dp[j] = max(dp[j], dp[j-w]+v);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;	</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">greedy</span><span class="params">(<span class="keyword">int</span> C[][<span class="number">3</span>], <span class="keyword">int</span> N, <span class="keyword">int</span> W)</span> </span>&#123;</div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">GB</span> &#123;</span></div><div class="line">            <span class="keyword">int</span> w, v, c;</div><div class="line">            GB(<span class="keyword">int</span> w = <span class="number">0</span>, <span class="keyword">int</span> v = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>):</div><div class="line">                w(w), v(v), c(c) &#123;&#125;</div><div class="line">            <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> GB &amp;x) <span class="keyword">const</span> &#123;</div><div class="line">                <span class="keyword">if</span> (v * x.w != x.v * w)</div><div class="line">                    <span class="keyword">return</span> v * x.w &gt; x.v * w;</div><div class="line">                <span class="keyword">return</span> c &gt; x.c;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="built_in">vector</span>&lt;GB&gt; A;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> w = C[i][<span class="number">0</span>], v = C[i][<span class="number">1</span>], c = C[i][<span class="number">2</span>];</div><div class="line">            A.push_back(GB(w, v, c));</div><div class="line">        &#125;</div><div class="line">        sort(A.begin(), A.end());</div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> t = min(A[i].c, W/A[i].w);</div><div class="line">            <span class="keyword">if</span> (t == <span class="number">0</span>)</div><div class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">            W -= t*A[i].w;</div><div class="line">            ret += t*A[i].v;</div><div class="line">            <span class="keyword">if</span> (W == <span class="number">0</span>)</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">knapsack</span><span class="params">(<span class="keyword">int</span> C[][<span class="number">3</span>], <span class="keyword">int</span> N, <span class="keyword">int</span> W)</span> </span>&#123;</div><div class="line">        <span class="comment">// filter</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">int</span> filter = greedy(C, N, W);</div><div class="line">            <span class="keyword">if</span> (filter != <span class="number">-1</span>)</div><div class="line">                <span class="keyword">return</span> filter;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">vector</span>&lt;BB&gt; A;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> w = C[i][<span class="number">0</span>], v = C[i][<span class="number">1</span>], c = C[i][<span class="number">2</span>];</div><div class="line">            A.push_back(BB(w, v, c));</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// reduce</span></div><div class="line">        &#123;</div><div class="line">            sort(A.begin(), A.end(), cmpByWeight);</div><div class="line">            <span class="built_in">map</span>&lt;pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;, <span class="keyword">int</span>&gt; R;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">                R[make_pair(A[i].w, A[i].v)] = i;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">                <span class="keyword">int</span> c = A[i].c;</div><div class="line">                <span class="built_in">map</span>&lt;pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;, <span class="keyword">int</span>&gt;::iterator it;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>; k &lt;= c; k &lt;&lt;= <span class="number">1</span>) &#123;</div><div class="line">                    <span class="keyword">int</span> w = A[i].w * k, v = A[i].v * k;</div><div class="line">                    it = R.find(make_pair(w, v));</div><div class="line">                    <span class="keyword">if</span> (it != R.end() &amp;&amp; i != it-&gt;second) &#123;</div><div class="line">                        <span class="keyword">int</span> j = it-&gt;second;</div><div class="line">                        A[j].c ++;</div><div class="line">                        A[i].c -= k;</div><div class="line">                    &#125;</div><div class="line">                    c -= k;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (c &gt; <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">int</span> w = A[i].w * c, v = A[i].v * c;</div><div class="line">                    it = R.find(make_pair(w, v));</div><div class="line">                    <span class="keyword">if</span> (it != R.end() &amp;&amp; i != it-&gt;second) &#123;</div><div class="line">                        <span class="keyword">int</span> j = it-&gt;second;</div><div class="line">                        A[j].c ++;</div><div class="line">                        A[i].c -= c;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> dp1[MAXW+<span class="number">1</span>], dp2[MAXW+<span class="number">1</span>];</div><div class="line">        BB Ar[<span class="number">2</span>][MAXN];</div><div class="line">        <span class="keyword">int</span> ArN[<span class="number">2</span>] = &#123;&#125;;</div><div class="line">        <span class="built_in">memset</span>(dp1, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp1[<span class="number">0</span>])*(W+<span class="number">1</span>));</div><div class="line">        <span class="built_in">memset</span>(dp2, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp2[<span class="number">0</span>])*(W+<span class="number">1</span>));</div><div class="line">        sort(A.begin(), A.end());</div><div class="line">        <span class="keyword">int</span> sum[<span class="number">2</span>] = &#123;&#125;;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> ch = sum[<span class="number">1</span>] &lt; sum[<span class="number">0</span>];</div><div class="line">            Ar[ch][ArN[ch]] = A[i];</div><div class="line">            ArN[ch]++;</div><div class="line">            sum[ch] = min(sum[ch] + A[i].w*A[i].c, W);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        run(Ar[<span class="number">0</span>], dp1, W, ArN[<span class="number">0</span>]);</div><div class="line">        run(Ar[<span class="number">1</span>], dp2, W, ArN[<span class="number">1</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = W, mx = <span class="number">0</span>; i &lt;= W; i++, j--) &#123;</div><div class="line">            mx = max(mx, dp2[i]);</div><div class="line">            ret = max(ret, dp1[j] + mx);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> W, N;</div><div class="line">    assert(<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;W, &amp;N) == <span class="number">2</span>);</div><div class="line">    <span class="keyword">int</span> C[MAXN][<span class="number">3</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">        assert(<span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;C[i][<span class="number">1</span>], &amp;C[i][<span class="number">0</span>], &amp;C[i][<span class="number">2</span>]) == <span class="number">3</span>);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, knapsack(C, N, W));</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-jg-20005" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/18/jg-20005/" class="article-date">
  <time datetime="2016-12-18T01:13:40.000Z" itemprop="datePublished">2016-12-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/18/jg-20005/">淺談背包問題 (0/1 Knapsack Problem) 優化那些事</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/12/18/jg-20005/" data-id="ckxv7t8tt006olkvnawi2j61z" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/12/18/jg-20005/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DP/">DP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化/">優化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/背包問題/">背包問題</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>收錄於 <a href="https://judgegirl.csie.org/problem/0/20005" target="_blank" rel="external">批改娘 20005. 0/1 Knapsack Problem</a>。之所以有機會談到這個問題，其原因於早期的背包問題，大多都是用 branch-and-bound 算法來完成，也因此學弟課程出了這一份作業，大部分的測資，使用 branch-and-bound 能跑得比一般記憶體化 DP 快上非常多。當然，作為一個 Morris(?) 怎能允許這樣的事情發生。</p>
<p>現在回顧一下背包問題的模型吧！</p>
</blockquote>
<h2 id="輸入格式"><a href="#輸入格式" class="headerlink" title="輸入格式"></a>輸入格式</h2><p>每組測資第一行包含兩個正整數，分別代表背包大小 $M$ ($\leq 5×10^6$) 和物品個數 $N$ ($\leq 1000$)，下一行開始每行包含兩個正整數，分別代表物品價值 $P_i$ ($\leq 10^5$)和物品重量 $W_i$ ($ \leq 10^5$)。</p>
<h2 id="輸出格式"><a href="#輸出格式" class="headerlink" title="輸出格式"></a>輸出格式</h2><p>對於每組測資，請輸出最大收益。</p>
<h2 id="範例輸入-1"><a href="#範例輸入-1" class="headerlink" title="範例輸入 1"></a>範例輸入 1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">50 7</div><div class="line">70 31</div><div class="line">20 10</div><div class="line">39 20</div><div class="line">37 19</div><div class="line">7 4</div><div class="line">5 3</div><div class="line">10 6</div></pre></td></tr></table></figure>
<h2 id="範例輸出-1"><a href="#範例輸出-1" class="headerlink" title="範例輸出 1"></a>範例輸出 1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">107</div></pre></td></tr></table></figure>
<h2 id="範例輸入-2"><a href="#範例輸入-2" class="headerlink" title="範例輸入 2"></a>範例輸入 2</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">170 7</div><div class="line">442 41</div><div class="line">525 50</div><div class="line">511 49</div><div class="line">593 59</div><div class="line">546 55</div><div class="line">564 57</div><div class="line">617 60</div></pre></td></tr></table></figure>
<h2 id="範例輸出-2"><a href="#範例輸出-2" class="headerlink" title="範例輸出 2"></a>範例輸出 2</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1735</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><h3 id="Branch-and-bound"><a href="#Branch-and-bound" class="headerlink" title="Branch-and-bound"></a>Branch-and-bound</h3><blockquote>
<p><a href="http://www.or.deis.unibo.it/kp/Chapter3.pdf" target="_blank" rel="external">bound knapscak problem</a> 古耕竹同學提供</p>
</blockquote>
<p>如果物品可以被切割，那麼可以利用物品的 CP 值 (<span>$\textit{cp}_i = p_i/w_i$</span><!-- Has MathJax -->)排序，使用貪心算法在 <span>$O(N \log N)$</span><!-- Has MathJax --> 找到最佳解。然而，背包問題在於物品只能挑或不挑，一旦無法切割物品，那麼貪心算法無法將剩餘的部分填滿，進而可能產生更好的一組解填滿剩餘部分。</p>
<blockquote>
<p>想要更快嗎？多看論文且實作它吧！</p>
</blockquote>
<p>branch-and-bound 基本核心操作為</p>
<ul>
<li>按照 CP 值由大到小排序</li>
<li>貪心法最佳解 <span>$\textit{bound}$</span><!-- Has MathJax --></li>
<li>進行深度優先搜索，優先挑 CP 值大的入選<ul>
<li>當前挑選方案最佳解 <span>$g$</span><!-- Has MathJax --> + 剩餘物品使用貪心法最佳解 <span>$g$</span><!-- Has MathJax --> 小於等於當前最佳解 <span>$\textit{bound}$</span><!-- Has MathJax -->，則退出搜索。</li>
<li>更新 <span>$\textit{bound} = \max(\textit{bound}, g)$</span><!-- Has MathJax --></li>
<li>選擇加入 或 不加入 (註：學弟說我的某些測資，通通優先不選可以快個數十倍)</li>
</ul>
</li>
</ul>
<p>參考代碼</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Item</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> v, w;</div><div class="line">    <span class="function"><span class="keyword">double</span> <span class="title">cp</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">double</span>) v / w;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">cmpCP</span><span class="params">(Item a, Item b)</span> </span>&#123;</div><div class="line">    <span class="keyword">double</span> cpA = a.cp();</div><div class="line">    <span class="keyword">double</span> cpB = b.cp();</div><div class="line">    <span class="keyword">if</span> (cpA == cpB)</div><div class="line">        <span class="keyword">return</span> a.w &gt; b.w;</div><div class="line">    <span class="keyword">return</span> cpA &gt; cpB;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> n, m;</div><div class="line"><span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">Item items[<span class="number">1005</span>];</div><div class="line"><span class="keyword">int</span> prefixW[<span class="number">1005</span>];</div><div class="line"><span class="keyword">int</span> prefixV[<span class="number">1005</span>];</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">h</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> w, <span class="keyword">int</span> b, <span class="keyword">int</span> &amp;j, <span class="keyword">int</span> &amp;f)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> fw = i == <span class="number">0</span> ? w : (w + prefixW[i<span class="number">-1</span>]);</div><div class="line">    <span class="keyword">for</span> (j = max(b, i); j &lt; n &amp;&amp; prefixW[j] &lt;= fw; j++);</div><div class="line">    <span class="keyword">if</span> (j &gt;= n) &#123;</div><div class="line">        <span class="keyword">return</span> prefixV[n<span class="number">-1</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> v = <span class="number">0</span>;</div><div class="line">    f = <span class="number">0</span>;</div><div class="line">    v += prefixV[j<span class="number">-1</span>] - (i == <span class="number">0</span> ? <span class="number">0</span> : prefixV[i<span class="number">-1</span>]);</div><div class="line">    w -= prefixW[j<span class="number">-1</span>] - (i == <span class="number">0</span> ? <span class="number">0</span> : prefixW[i<span class="number">-1</span>]);</div><div class="line">    <span class="keyword">if</span> (w != <span class="number">0</span>) &#123;</div><div class="line">        f = <span class="number">1</span>;</div><div class="line">        <span class="keyword">float</span> k = (<span class="keyword">float</span>) w / items[j].w;</div><div class="line">        w -= k * items[j].w;</div><div class="line">        v += k * items[j].v;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> v;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">greedy</span><span class="params">(<span class="keyword">int</span> w)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> v = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)  &#123;</div><div class="line">        <span class="keyword">if</span> (w &gt;= items[i].w)&#123;</div><div class="line">            w -= items[i].w;</div><div class="line">            v += items[i].v;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> v;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> v;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> w, <span class="keyword">int</span> v, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (i &gt;= n) &#123;</div><div class="line">        ret = max(ret, v);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> j = n, f;</div><div class="line">    <span class="keyword">int</span> hv = v + h(i, w, b, j, f);</div><div class="line">    <span class="keyword">if</span> (hv &lt;= ret)</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">if</span> (f == <span class="number">0</span>) &#123;</div><div class="line">        ret = max(ret, hv);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (w &gt;= items[i].w)</div><div class="line">        dfs(i + <span class="number">1</span>, w - items[i].w, v + items[i].v, j);</div><div class="line">    dfs(i + <span class="number">1</span>, w, v, j);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;m, &amp;n) == <span class="number">2</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;items[i].v, &amp;items[i].w);</div><div class="line">        stable_sort(items, items+n, cmpCP);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, w = <span class="number">0</span>, v = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            w += items[i].w;</div><div class="line">            v += items[i].v;</div><div class="line">            prefixW[i] = w;</div><div class="line">            prefixV[i] = v;</div><div class="line">        &#125;</div><div class="line">        ret = greedy(m);</div><div class="line">        dfs(<span class="number">0</span>, m, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, ret);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h4><p>branch-and-bound 空間複雜度只跟 <span>$N$</span><!-- Has MathJax --> 有關，使用記憶體空間小，相較於記憶化搜索有較少的 cache miss，速度取決於搜索順序。對於同一 CP 的等價處理薄弱，一遇到這種情況，搜尋時間瞬間指數次方上去，可以等個昏天暗地。</p>
<h3 id="Dynamic-Programming"><a href="#Dynamic-Programming" class="headerlink" title="Dynamic Programming"></a>Dynamic Programming</h3><h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><blockquote>
<p>請不要忘記背包問題屬於 NP-Complete，我們能做的事情只能優化計算，最慘的情況仍要面對，優化常數是可以努力的方向，讓我們嘗試變得更快吧。</p>
</blockquote>
<p>基礎寫法解說請參考 <a href="http://www.csie.ntnu.edu.tw/~u91029/KnapsackProblem.html#4" target="_blank" rel="external">DJWS - Bounded Knapsack Problem</a> 的說明。</p>
<p>從定義上，我們通常會宣告 <code>dp[i][j]</code> 表示放入前 <span>$i$</span><!-- Has MathJax --> 個物品時，總共最多為 <span>$j$</span><!-- Has MathJax --> 的最大價值為何。這樣空間宣告使用 <span>$\mathcal{O}(NW)$</span><!-- Has MathJax -->。在實作上，我們可以藉由運算順序將空間降為 <span>$\mathcal{O}(W)$</span><!-- Has MathJax -->。因此，寫出以下代碼並不難</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> dp[MAXW];</div><div class="line"><span class="built_in">memset</span>(dp, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp));</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = W; j &gt;= w[i]; j--)</div><div class="line">        dp[j] = max(dp[j], dp[j-w[i]]+v[i]);</div></pre></td></tr></table></figure>
<h4 id="優化初夜"><a href="#優化初夜" class="headerlink" title="優化初夜"></a>優化初夜</h4><p>從實際運行上，我們可以發現每次跑 <span>$\mathcal{\theta}(W)$</span><!-- Has MathJax --> 非常浪費，只需要跑 <span>$\min(W, \sum w_i)$</span><!-- Has MathJax --> 即可。因此，第一份計算量優化如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> dp[MAXW];</div><div class="line"><span class="built_in">memset</span>(dp, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp));</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">    sum += w[i];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = min(W, sum); j &gt;= w[i]; j--)</div><div class="line">        dp[j] = max(dp[j], dp[j-w[i]]+v[i]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>計算邊界優化通常可以達到 2x 加速</p>
</blockquote>
<p>如此一來，在數量多權重小時，剛啟動的效能時可以賺到非常多。然而，不乏第一次就給權重的大的，目標最小化 <span>$\sum \text{sum}_i$</span><!-- Has MathJax -->，從數學觀念很明顯地瞭解，只要一開始將權重 <span>$w_i$</span><!-- Has MathJax --> 由小到大排序即可，這樣能保證最小化計算量！</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> dp[MAXW];</div><div class="line"><span class="built_in">memset</span>(dp, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp));</div><div class="line">sort (w, v) by w</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">    sum += w[i];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = min(W, sum); j &gt;= w[i]; j--)</div><div class="line">        dp[j] = max(dp[j], dp[j-w[i]]+v[i]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>數學使得我們更進一步，達到 1.5x 加速</p>
</blockquote>
<h4 id="優化二夜"><a href="#優化二夜" class="headerlink" title="優化二夜"></a>優化二夜</h4><p>經由平行的訓練，也許我們可以更往上一層優化。</p>
<p>接下來，打算把物品拆成兩堆，再利用優化初夜學到的技巧，就能引爆更多計算邊界優化。如果拆成三堆以上，合併操作變得相當複雜，當只有兩堆時，保證合併效能一定在 <span>$\mathcal{\theta}(W)$</span><!-- Has MathJax --> 完成。</p>
<p>如何合併兩堆的計算結果，假設 <code>dp1[i]</code> 表示其中一堆重量小於等於 <span>$i$</span><!-- Has MathJax --> 的最佳解，同理 <code>dp2[j]</code> 的計算結果。</p>
<p>當要湊出重量為 <span>$W$</span><!-- Has MathJax --> 的最佳解時，窮舉其中一堆的重量 <span>$i$</span><!-- Has MathJax --> 維護其中一堆的前綴最大值 <span>$j$</span><!-- Has MathJax -->，相當於使用掃描線算法在線性時間內合併。合併操作如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = W, mx = <span class="number">0</span>; i &lt;= W; i++, j--) &#123;</div><div class="line">    mx = max(mx, dp2[i]);</div><div class="line">    ret = max(ret, dp1[j] + mx);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Divide-and-Conquer，使得我們更快再更快！達到 1.5 加速</p>
</blockquote>
<p>然而，優化問題將轉移到最佳分堆策略，好的分堆策略將使得計算量下降更多。目標分兩堆，使得 <span>$\sum \text{sum1}_i + \sum \text{sum2}_i$</span><!-- Has MathJax --> 最小化。明顯地，由小到大排序物品重量，依序將物品放到總和最小的那一堆即可。最後，我們整合每一夜的結果如下：</p>
<blockquote>
<p>一個好的分堆，達到 1.2x 加速</p>
<p>相信在不久之後，還有更好的優化策略，也許不是延伸，而是全新的面貌。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> &#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXW = <span class="number">5000005</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1005</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">int</span> A[][<span class="number">2</span>], <span class="keyword">int</span> dp[], <span class="keyword">int</span> W, <span class="keyword">int</span> N)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> w = A[i][<span class="number">0</span>], v = A[i][<span class="number">1</span>];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = min(W, sum + w); j &gt;= w; j--)</div><div class="line">                dp[j] = max(dp[j], dp[j-w]+v);</div><div class="line">            sum += w;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">knapsack</span><span class="params">(<span class="keyword">int</span> C[][<span class="number">2</span>], <span class="keyword">int</span> N, <span class="keyword">int</span> W)</span> </span>&#123;</div><div class="line">        <span class="built_in">vector</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt; A;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">            A.push_back(make_pair(C[i][<span class="number">0</span>], C[i][<span class="number">1</span>]));</div><div class="line">        N = A.size();</div><div class="line">        assert(N &lt; MAXN);</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> dp1[MAXW+<span class="number">1</span>], dp2[MAXW+<span class="number">1</span>];</div><div class="line">        <span class="keyword">int</span> Ar[<span class="number">2</span>][MAXN][<span class="number">2</span>], ArN[<span class="number">2</span>] = &#123;&#125;;</div><div class="line">        <span class="built_in">memset</span>(dp1, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp1[<span class="number">0</span>])*(W+<span class="number">1</span>));</div><div class="line">        <span class="built_in">memset</span>(dp2, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp2[<span class="number">0</span>])*(W+<span class="number">1</span>));</div><div class="line">        sort(A.begin(), A.end());</div><div class="line">        <span class="keyword">int</span> sum[<span class="number">2</span>] = &#123;&#125;;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> ch = sum[<span class="number">1</span>] &lt; sum[<span class="number">0</span>];</div><div class="line">            Ar[ch][ArN[ch]][<span class="number">0</span>] = A[i].first;</div><div class="line">            Ar[ch][ArN[ch]][<span class="number">1</span>] = A[i].second;</div><div class="line">            ArN[ch]++;</div><div class="line">            sum[ch] += A[i].first;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        run(Ar[<span class="number">0</span>], dp1, W, ArN[<span class="number">0</span>]);</div><div class="line">        run(Ar[<span class="number">1</span>], dp2, W, ArN[<span class="number">1</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = W, mx = <span class="number">0</span>; i &lt;= W; i++, j--) &#123;</div><div class="line">            mx = max(mx, dp2[i]);</div><div class="line">            ret = max(ret, dp1[j] + mx);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> W, N, C[MAXN][<span class="number">2</span>];</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;W, &amp;N) == <span class="number">2</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">            assert(<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;C[i][<span class="number">1</span>], &amp;C[i][<span class="number">0</span>]) == <span class="number">2</span>);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, knapsack(C, N, W));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-mproblem-sort-array-limited-memory" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/22/mproblem-sort-array-limited-memory/" class="article-date">
  <time datetime="2016-01-22T05:49:03.000Z" itemprop="datePublished">2016-01-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/22/mproblem-sort-array-limited-memory/">[讀檔操作] 有限記憶體排序數組</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/01/22/mproblem-sort-array-limited-memory/" data-id="ckxv7t8ux009mlkvn924w17hm" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/01/22/mproblem-sort-array-limited-memory/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hash/">hash</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/二分搜尋/">二分搜尋</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/巨量資料/">巨量資料</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/讀檔/">讀檔</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>現在的系統架構中，內存 (Memory，台灣翻譯：記憶體，大陸翻譯：內存) 的大小仍無法完全像硬碟機一樣。如檔案大小 64GB，內存只有 4GB，處理檔案無法全部 In Memory，當然最近的硬體技術也逐漸朝著 All In Memory 的方式進行加速。回過頭來，在內存不足的情況下，來練習如何處理檔案大小遠大於內存的情況吧。</p>
<h2 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h2><p>給予一個 binary file 的檔案名稱，裡面用 4 個位元組為一個 signed 32-bit 整數，有數個直到 <code>EOF</code>，請排序後以 binary mode 導入 stdout 輸出。</p>
<h2 id="輸入格式"><a href="#輸入格式" class="headerlink" title="輸入格式"></a>輸入格式</h2><p>標準輸入串流只有一行一個字串，表示檔案名稱 <span>$F$</span><!-- Has MathJax -->。檔案大小最多 16 MB，而你的程序被限制最多使用 4 MB 的內存。</p>
<p>每個整數 <span>$x$</span><!-- Has MathJax -->，限制條件 <span>$0 \le x \le 10^9$</span><!-- Has MathJax --></p>
<h2 id="輸出格式"><a href="#輸出格式" class="headerlink" title="輸出格式"></a>輸出格式</h2><p>輸出在標準串流以 binary mode 下，請避開使用 console 輸出，會因為特殊字元 (如 「嗶」一聲) 導致系統嚴重當機。</p>
<h2 id="範例輸入"><a href="#範例輸入" class="headerlink" title="範例輸入"></a>範例輸入</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1.dat</div></pre></td></tr></table></figure>
<h2 id="範例輸出"><a href="#範例輸出" class="headerlink" title="範例輸出"></a>範例輸出</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">... binary mode 無法顯示</div></pre></td></tr></table></figure>
<h2 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h2><p>download <a href="/downloads/p10068-in.dat">p10068-in.dat</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">morris821028@morris821028-PC MINGW64 ~/Desktop/10068</div><div class="line">$ ./sort2.exe &gt;test.out</div><div class="line">1.dat</div><div class="line"></div><div class="line">morris821028@morris821028-PC MINGW64 ~/Desktop/10068</div><div class="line">$ xxd test.out</div><div class="line">00000000: 0000 0000 0100 0000 0100 0000 0100 0000  ................</div><div class="line">00000010: 0300 0000 0400 0000 0500 0000 0500 0000  ................</div><div class="line">00000020: 0800 0000 0900 0000                      ........</div></pre></td></tr></table></figure>
<p><code>1.dat</code> 以 binary file 儲存 10 個 4 bytes 整數，依序為 5, 9, 3, 5, 0, 1, 1, 8, 4, 1，排序後即為 0, 1, 1, 1, 3, 4, 5, 5, 8, 9。</p>
<p>由於限制內存使用量，無法寫入暫存檔案，可利用多次讀檔完成。</p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>乍看之下，這一題是最常見的 external sort (外部排序)，外部排序需要額外寫檔案，由於記憶體用量計算，一寫檔案會計算到使用的記憶體中，實際上這一題不寫檔也是能解決的。</p>
<ul>
<li>給定要排序的數據範圍</li>
<li>二分搜尋可容納的排序範圍，利用平衡樹或者 hash 來完成計算 <code>&lt;某整數, 某整數出現個數&gt;</code></li>
<li>將可容納到 hash 的所有數字排序，再將其直接寫到輸出檔案。</li>
<li>不斷地遞增二分搜尋的左邊邊界。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> swap(x, y) &#123;int t; t = x, x = y, y = t;&#125;</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsize</span><span class="params">(FILE *fp)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> prev = ftell(fp);</div><div class="line">    fseek(fp, <span class="number">0L</span>, SEEK_END);</div><div class="line">    <span class="keyword">int</span> size = ftell(fp);</div><div class="line">    fseek(fp, prev, SEEK_SET);</div><div class="line">    <span class="keyword">return</span> size;</div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> USAGEMEM (2&lt;&lt;20)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXELE ((2&lt;&lt;20)/8)</span></div><div class="line"><span class="keyword">int</span> A[MAXELE];</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> HSIZE 100007</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> HNODE 50000</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">HashNode</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> f, cnt;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HashNode</span> *<span class="title">next</span>;</span></div><div class="line">&#125; HashNode;</div><div class="line">HashNode *hhead[HSIZE], hnodes[HNODE];</div><div class="line"><span class="keyword">int</span> nodesize = <span class="number">0</span>;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">cmp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *x, <span class="keyword">const</span> <span class="keyword">void</span> *y)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> ((HashNode*) x)-&gt;f - ((HashNode*) y)-&gt;f;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(<span class="keyword">int</span> f)</span> </span>&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> a = <span class="number">63689</span>, b = <span class="number">378551</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> value = <span class="number">0</span>;</div><div class="line">    value = value * a + f, a = a * b;</div><div class="line">    <span class="keyword">return</span> value;</div><div class="line">&#125; </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">initHash</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="built_in">memset</span>(hhead, <span class="number">0</span>, <span class="keyword">sizeof</span>(hhead));</div><div class="line">    nodesize = <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">insertHash</span><span class="params">(<span class="keyword">int</span> f)</span> </span>&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> hidx = hash(f)%HSIZE;</div><div class="line">    <span class="keyword">for</span> (HashNode *p = hhead[hidx]; p != <span class="literal">NULL</span>; p = p-&gt;next) &#123;</div><div class="line">        <span class="keyword">if</span> (f == p-&gt;f) &#123;</div><div class="line">        	p-&gt;cnt++;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (nodesize &gt;= HNODE)	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    HashNode s = &#123;.f = f, .cnt = <span class="number">1</span>, .next = <span class="literal">NULL</span>&#125;;</div><div class="line">    hnodes[nodesize] = s;</div><div class="line">    hnodes[nodesize].next = hhead[hidx];</div><div class="line">    hhead[hidx] = &amp;hnodes[nodesize];</div><div class="line">    nodesize++;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">merge_int</span><span class="params">(FILE *fp, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</div><div class="line">    initHash();</div><div class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>, x, n = <span class="number">0</span>;</div><div class="line">    fseek(fp, <span class="number">0</span>, SEEK_SET);</div><div class="line">    <span class="keyword">while</span> ((n = fread(A, <span class="keyword">sizeof</span>(<span class="keyword">int</span>), MAXELE, fp))) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (A[i] &gt;= l &amp;&amp; A[i] &lt;= r) &#123;</div><div class="line">                <span class="keyword">if</span> (!insertHash(A[i]))</div><div class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">block_process</span><span class="params">(FILE *fp)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> base = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> l, r, mid, ret;</div><div class="line">    l = base, r = <span class="number">1000000000</span>, ret = <span class="number">0</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></div><div class="line">    <span class="keyword">if</span> (setmode(fileno(<span class="built_in">stdout</span>), O_BINARY) == <span class="number">-1</span>) &#123;</div><div class="line">        perror(<span class="string">"Cannot set stdout to binary mode"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">2</span>;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __linux__</span></div><div class="line">    FILE *<span class="keyword">const</span> out = fdopen(dup(fileno(<span class="built_in">stdout</span>)), <span class="string">"wb"</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    <span class="keyword">while</span> (l &lt;= r) &#123;</div><div class="line">        mid = (l + r)/<span class="number">2</span>;</div><div class="line">        <span class="keyword">int</span> status = merge_int(fp, base, mid);</div><div class="line">        <span class="keyword">if</span> (status == <span class="number">1</span>) &#123;</div><div class="line">            l = mid + <span class="number">1</span>, r = <span class="number">1000000000</span>;</div><div class="line">            base = mid + <span class="number">1</span>;</div><div class="line">            qsort(hnodes, nodesize, <span class="keyword">sizeof</span>(HashNode), cmp);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nodesize; i++) &#123;</div><div class="line">                <span class="keyword">int</span> x = hnodes[i].f;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = hnodes[i].cnt<span class="number">-1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></div><div class="line">                    fwrite(&amp;x, <span class="keyword">sizeof</span>(<span class="keyword">int</span>), <span class="number">1</span>, <span class="built_in">stdout</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __linux__</span></div><div class="line">                    fwrite(&amp;x, <span class="keyword">sizeof</span>(<span class="keyword">int</span>), <span class="number">1</span>, out);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">                &#125;</div><div class="line">                ret += hnodes[i].cnt;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            r = mid - <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">char</span> fName[<span class="number">128</span>];</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%s"</span>, fName);</div><div class="line">    FILE *fin = fopen(fName, <span class="string">"rb"</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> n = fsize(fin) / <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</div><div class="line">    block_process(fin);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-mproblem-find-median-limited-memory" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/22/mproblem-find-median-limited-memory/" class="article-date">
  <time datetime="2016-01-22T04:55:38.000Z" itemprop="datePublished">2016-01-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="http://i.imgur.com/plPcy1p.jpg" rel="gallery_ckxv7t8ua0081lkvnkb9lcbxx">
        <img src="http://i.imgur.com/plPcy1p.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/22/mproblem-find-median-limited-memory/">[讀檔操作] 有限記憶體找中位數</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/01/22/mproblem-find-median-limited-memory/" data-id="ckxv7t8ua0081lkvnkb9lcbxx" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/01/22/mproblem-find-median-limited-memory/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/二分搜尋/">二分搜尋</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化輸入/">優化輸入</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/分桶/">分桶</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/巨量資料/">巨量資料</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/讀檔/">讀檔</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>現在的系統架構中，內存 (Memory，台灣翻譯：記憶體，大陸翻譯：內存) 的大小仍無法完全像硬碟機一樣。如檔案大小 64GB，內存只有 4GB，處理檔案無法全部 In Memory，當然最近的硬體技術也逐漸朝著 All In Memory 的方式進行加速。回過頭來，在內存不足的情況下，來練習如何處理檔案大小遠大於內存的情況吧。</p>
<h2 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h2><p>給予一個 binary file 的檔案名稱，裡面用 4 個位元組為一個 signed 32-bits 整數，有數個直到 <code>EOF</code>，保證恰好有奇數個，請輸出中位數為何？</p>
<h2 id="輸入格式"><a href="#輸入格式" class="headerlink" title="輸入格式"></a>輸入格式</h2><p>標準輸入串流只有一行一個字串，表示檔案名稱 <span>$F$</span><!-- Has MathJax -->。檔案大小最多 16 MB，而你的程序被限制最多使用 4 MB 的內存。</p>
<p>每個整數 <span>$x$</span><!-- Has MathJax -->，限制條件 <span>$0 \le x \le 10^9$</span><!-- Has MathJax --></p>
<h2 id="輸出格式"><a href="#輸出格式" class="headerlink" title="輸出格式"></a>輸出格式</h2><p>輸出一行整數 <span>$Median$</span><!-- Has MathJax --> 為 binary file 的中位數。</p>
<h2 id="範例輸入"><a href="#範例輸入" class="headerlink" title="範例輸入"></a>範例輸入</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">p10067-in.dat</div></pre></td></tr></table></figure>
<h2 id="範例輸出"><a href="#範例輸出" class="headerlink" title="範例輸出"></a>範例輸出</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">97537111</div></pre></td></tr></table></figure>
<h2 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h2><p>二分搜尋，分桶</p>
<p>download <a href="/downloads/p10067-in.dat">p10067-in.dat</a></p>
<h3 id="p10067-in-dat"><a href="#p10067-in-dat" class="headerlink" title="p10067-in.dat"></a>p10067-in.dat</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">10825098</div><div class="line">97537111</div><div class="line">208681850</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>這一個問題很久以前見過，對岸通常叫做「海量資料找中位數」約束在記憶體不夠的情況下，如何高效率找到中位數，操作時允許重複讀檔。</p>
<p>遲遲沒有 Online Judge 進行記憶體用量檢測以及開放讀寫檔案，如今有機會擔任台灣大學計算機程式設計的課程助教，架了一個允許亂來的 Online Judge - Judge Girl (中文翻譯：批改娘系統)，讀寫檔案也不會被封鎖！洽詢 <a href="http://judgegirl.csie.org/" target="_blank" rel="external">網站</a>，目前只針對課堂學生開放。</p>
<p>回到問題，題目給訂 16MB 的整數序列，最多 <span>$n = 4 \times 10^6$</span><!-- Has MathJax -->，由於記憶體不足沒辦法直接宣告陣列大小為 <span>$n$</span><!-- Has MathJax --> 的整數陣列，又由於數字可能會重複，就沒辦法利用 bitmask 進行壓縮，只能倚靠不斷地讀檔案進行計算。若以數值範圍 <span>$[0, V]$</span><!-- Has MathJax -->，大致放分成兩種策略</p>
<ul>
<li>二分搜尋 (AC, 250ms)，效率 <span>$\mathcal{O}(V \log V)$</span><!-- Has MathJax -->，開檔次數 <span>$\mathcal{O}(\log V)$</span><!-- Has MathJax -->。</li>
<li>分桶算法 (AC, 70ms)，效率 <span>$\mathcal{O}(N)$</span><!-- Has MathJax -->，開檔次數 <span>$\mathcal{O}(1)$</span><!-- Has MathJax -->。</li>
</ul>
<p>讀取檔案時，在有限記憶體空間，配置一塊作為緩衝區，一次讀入一坨子序列，一個一個讀取效率非常差，別輕忽從磁碟讀取資料的速度。剩餘空間再進行紀錄用途。從效能比較 <strong>二分搜尋</strong> 慢於 <strong>分桶算法</strong>。</p>
<h3 id="二分搜尋"><a href="#二分搜尋" class="headerlink" title="二分搜尋"></a>二分搜尋</h3><p>二分答案 <span>$x$</span><!-- Has MathJax -->，接著線性掃描序列，計算有多少個整數小於等於 <span>$x$</span><!-- Has MathJax -->，藉此找到中位數。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsize</span><span class="params">(FILE *fp)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> prev = ftell(fp);</div><div class="line">    fseek(fp, <span class="number">0L</span>, SEEK_END);</div><div class="line">    <span class="keyword">int</span> size = ftell(fp);</div><div class="line">    fseek(fp, prev, SEEK_SET);</div><div class="line">    <span class="keyword">return</span> size;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXELE (3&lt;&lt;20)/4</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">countLess</span><span class="params">(FILE *fp, <span class="keyword">int</span> ans)</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> A[MAXELE];</div><div class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>, x, n = <span class="number">0</span>;</div><div class="line">    fseek(fp, <span class="number">0</span>, SEEK_SET);</div><div class="line">    <span class="keyword">while</span> ((n = fread(A, <span class="keyword">sizeof</span>(<span class="keyword">int</span>), MAXELE, fp))) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            ret += A[i] &lt;= ans;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">char</span> fName[<span class="number">128</span>];</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%s"</span>, fName);</div><div class="line">    FILE *fin = fopen(fName, <span class="string">"rb"</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> n = fsize(fin) / <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> m = n/<span class="number">2</span> + <span class="number">1</span>;</div><div class="line">    <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="number">1000000000</span>, mid, ret = <span class="number">0</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">while</span> (l &lt;= r) &#123;</div><div class="line">        mid = (l + r)/<span class="number">2</span>;</div><div class="line">        <span class="keyword">int</span> tn = countLess(fin, mid);</div><div class="line">        <span class="keyword">if</span> (tn &lt; m)</div><div class="line">            l = mid + <span class="number">1</span>, ret = mid+<span class="number">1</span>;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            r = mid - <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, ret);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="分桶算法"><a href="#分桶算法" class="headerlink" title="分桶算法"></a>分桶算法</h3><p>分桶算法分成兩次掃瞄，假設內存分配最多 <span>$I$</span><!-- Has MathJax --> 個 32bits 整數 (<span>$I \ll N$</span><!-- Has MathJax -->)。</p>
<ul>
<li>由於記憶體限制大小關係，將數值範圍分成 <span>$I$</span><!-- Has MathJax --> 堆，如 <code>[0, V/I-1]</code>、<code>[V/I, 2V/I-1]</code>、… 等，計算區間範圍內的個數，讀取一次檔案，可以得到中位數介於 <code>[iV/I, (i+1)V/I-1]</code>。</li>
<li>接著再劃分一次，直到區間長度為 1，中位數便可得到。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsize</span><span class="params">(FILE *fp)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> prev = ftell(fp);</div><div class="line">    fseek(fp, <span class="number">0L</span>, SEEK_END);</div><div class="line">    <span class="keyword">int</span> size = ftell(fp);</div><div class="line">    fseek(fp, prev, SEEK_SET);</div><div class="line">    <span class="keyword">return</span> size;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXELE ((1&lt;&lt;20)/4)</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> A[MAXELE];</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> B[MAXELE];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">countLess</span><span class="params">(FILE *fp, <span class="keyword">int</span> ans)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>, x, n = <span class="number">0</span>;</div><div class="line">    fseek(fp, <span class="number">0</span>, SEEK_SET);</div><div class="line">    <span class="keyword">while</span> ((n = fread(A, <span class="keyword">sizeof</span>(<span class="keyword">int</span>), MAXELE, fp))) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            ret += A[i] &lt;= ans;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">char</span> fName[<span class="number">128</span>];</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%s"</span>, fName);</div><div class="line">    FILE *fin = fopen(fName, <span class="string">"rb"</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> n = fsize(fin) / <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> m = n/<span class="number">2</span> + <span class="number">1</span>;</div><div class="line">    <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="number">1000000000</span>, mid, ret = <span class="number">0</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> WIDTH = r, SHIFT;</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (SHIFT = <span class="number">1</span>; (<span class="number">1</span>&lt;&lt;SHIFT) &lt; MAXELE; SHIFT++);</div><div class="line">    WIDTH = r / (<span class="number">1</span>&lt;&lt;SHIFT);</div><div class="line">    </div><div class="line">    <span class="built_in">memset</span>(B, <span class="number">0</span>, <span class="keyword">sizeof</span>(B));</div><div class="line">    fseek(fin, <span class="number">0</span>, SEEK_SET);</div><div class="line">    <span class="keyword">while</span> ((n = fread(A, <span class="keyword">sizeof</span>(<span class="keyword">int</span>), MAXELE, fin))) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            assert((A[i]&gt;&gt;SHIFT) &lt; MAXELE);</div><div class="line">            B[A[i]&gt;&gt;SHIFT]++;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> BASE = <span class="number">0</span>, SELECT;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = m; i &lt; MAXELE; i++) &#123;</div><div class="line">        sum -= B[i];</div><div class="line">        <span class="keyword">if</span> (sum &lt;= <span class="number">0</span>) &#123;</div><div class="line">            BASE = i * (<span class="number">1</span>&lt;&lt;SHIFT);</div><div class="line">            SELECT = sum + B[i];</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="built_in">memset</span>(B, <span class="number">0</span>, <span class="keyword">sizeof</span>(B));</div><div class="line">    fseek(fin, <span class="number">0</span>, SEEK_SET);</div><div class="line">    <span class="keyword">while</span> ((n = fread(A, <span class="keyword">sizeof</span>(<span class="keyword">int</span>), MAXELE, fin))) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (A[i] - BASE &lt; MAXELE &amp;&amp; A[i] &gt;= BASE)</div><div class="line">                B[A[i] - BASE]++;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = SELECT; i &lt; MAXELE; i++) &#123;</div><div class="line">        sum -= B[i];</div><div class="line">        <span class="keyword">if</span> (sum &lt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, i + BASE);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-mproblem-obstacle" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/05/mproblem-obstacle/" class="article-date">
  <time datetime="2015-06-05T00:27:14.000Z" itemprop="datePublished">2015-06-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/05/mproblem-obstacle/">[ACM 題目] 障礙物轉換</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/05/mproblem-obstacle/" data-id="ckxv7t8ui008llkvnd4v7p4y4" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/05/mproblem-obstacle/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Minkowski/">Minkowski</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/計算幾何/">計算幾何</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>在計算幾何領域中，機器人規劃路線是一個實用的議題， 由於機器人是一個有體積的物體，要避開其他的障礙物，障礙物碰撞計算會變得相當複雜。由於某 M 沒有學好這一部分，知道一種方法可以將地圖轉換，把機器人轉換成一個點，計算得到新的障礙物，如此一來就不用處理障礙物碰撞。</p>
<p><img src="http://i.imgur.com/7uApMKE.png" alt=""></p>
<p>從上圖中，一個箭頭型機器人要從左下角移動到右上角，假設不考慮物體可以旋轉，請問是否能移動過去。若把機器人當作一點看待，則必須將物體邊緣增加，變成中間那張圖 configuration space，只剩下一個點和數個多邊形障礙物。接著可以轉換成 visibility graph，把剩下的白色空間進行梯形剖分或者三角剖分，將區域表示成一個點，相鄰區域拉一條邊，就成 dual graph，就能套用一般的最短路徑算法，來協助機器人行走。</p>
<p>處理這問題對於某 M 過於困難，於是將問題更簡化些，只需要把中間那一張圖其中一個障礙物變化求出即可。</p>
<p><img src="http://i.imgur.com/jH2Rv4A.png" alt=""></p>
<p>現在給定一個凸多邊形障礙物以及移動凸多邊形，假設定位點在深黑色點方形部分，藉由貼著障礙物可以構出新的障礙物，請問新的障礙物為何？</p>
<h2 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h2><p>第一行會有一個整數 <span>$T$</span><!-- Has MathJax -->，表示有多少組測資。</p>
<p>每一組測資會包含兩個凸多邊形。第一行有一個整數 <span>$N$</span><!-- Has MathJax --> 表示移動凸多邊形的頂點數量，接下來會有 <span>$N$</span><!-- Has MathJax --> 行，每一行會有兩個整數 <span>$x, y$</span><!-- Has MathJax --> 表示頂點座標。在 <span>$N+1$</span><!-- Has MathJax --> 行之後，會有一個整數 <span>$M$</span><!-- Has MathJax --> 表示障礙物凸多邊形的頂點數量，接下來會有 <span>$M$</span><!-- Has MathJax --> 行，每一行會有兩個整數 <span>$x, y$</span><!-- Has MathJax --> 表示頂點座標。</p>
<ul>
<li><span>$2 &lt; N, M &lt; 512$</span><!-- Has MathJax --></li>
<li><span>$-32767 &lt; x, y &lt; 32767$</span><!-- Has MathJax --></li>
<li>假設定位點 (深黑色點方形部分) 都設在原點 (0, 0)。</li>
<li>輸入順序會按照順時針或逆時針給定。</li>
</ul>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">2 </div><div class="line"></div><div class="line">5</div><div class="line">-1 -1</div><div class="line">-1 1</div><div class="line">0 3</div><div class="line">1 1</div><div class="line">1 -1</div><div class="line"></div><div class="line">4</div><div class="line">1 1</div><div class="line">8 2</div><div class="line">12 -1</div><div class="line">6 -4</div><div class="line"></div><div class="line">3</div><div class="line">-1 -4</div><div class="line">-1 1</div><div class="line">1 1</div><div class="line"></div><div class="line">5 </div><div class="line">1 0</div><div class="line">6 5</div><div class="line">10 5</div><div class="line">10 -3</div><div class="line">1 -3</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Case #1: 89.0</div><div class="line">Case #2: 115.5</div></pre></td></tr></table></figure>
<h2 id="Hint"><a href="#Hint" class="headerlink" title="Hint"></a>Hint</h2><p><img src="http://i.imgur.com/CsxzEEo.png" alt=""></p>
<p><img src="http://i.imgur.com/8KqjT4W.png" alt=""></p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>可以用 <span>$O(nm \log nm)$</span><!-- Has MathJax --> 來完成此題，方法很簡單，先將機器人的圖形按照原點旋轉 180 度，接著將障礙物每一個頂點座標加上機器人的座標，總共會得到 <span>$nm$</span><!-- Has MathJax --> 的頂點，套用凸包算法求一次即可。</p>
<p>這一題應用 Minkowski Sum 來完成，對於兩個凸多邊形的 Minkowski Sum，可以在 <span>$O(n+m)$</span><!-- Has MathJax --> 時間內完成，將兩個凸包採用逆時針儲存，挑選最左，等價時抓下方 y 座標的點，可以知道新凸包的頂點一定是由兩個凸包的頂點<span>$A_i, B_j$</span><!-- Has MathJax --> 疊加而成，一開始抓到的左下方頂點疊加可以得到第一個頂點，接著要按照凸包順序求出，則比較<span>$(A_i, A_{i+1})$</span><!-- Has MathJax --> 和<span>$(B_j, B_{j+1})$</span><!-- Has MathJax --> 哪一個偏的角度小，就挑選哪一個往前推動 <code>i = i+1</code> 或者是 <code>j = j+1</code>。最後就能在 <span>$O(n+m)$</span><!-- Has MathJax --> 時間內完成。</p>
<p>假設不是凸多邊形，兩個簡單多邊形最慘會到 <span>$O(n^2 m^2)$</span><!-- Has MathJax -->。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"></div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-mproblem-k-dominate" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/05/mproblem-k-dominate/" class="article-date">
  <time datetime="2015-06-05T00:17:11.000Z" itemprop="datePublished">2015-06-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/05/mproblem-k-dominate/">[ACM 題目] 優勢商品</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/05/mproblem-k-dominate/" data-id="ckxv7t8ue008dlkvnnv9pu9s4" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/05/mproblem-k-dominate/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/資料庫/">資料庫</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>一份產品有很多屬性，把每一個屬性當作一個維度，當成 <span>$D$</span><!-- Has MathJax --> 個維度的向量，當維度越多時絕對支配 (各方面都是最好的) 的機率就越低。若把 <span>$D = 2$</span><!-- Has MathJax -->，就是在二維空間中的支配點 (Zerojudge d555 平面上的極大點)。由於絕對優勢的產品隨著維度增加而變少，定義出一種相對優勢產品，給定一個 <span>$K$</span><!-- Has MathJax -->，若 <span>$p_i$</span><!-- Has MathJax --> 支配 (<em>k</em>-dominate) <span>$p_j$</span><!-- Has MathJax -->，必須滿足下列三條：</p>
<ul>
<li><span>$\exists S&apos; \subseteq S, |S&apos;| = K$</span><!-- Has MathJax --></li>
<li><span>$\forall s_r \in S&apos;, p_i.s_r \geq p_j.s_r$</span><!-- Has MathJax --></li>
<li><span>$\exists s_t \in S&apos;, p_i.s_t &gt; p_j.s_t$</span><!-- Has MathJax -->
</li>
</ul>
<p>用中文解釋這幾條數學公式，假設有 6 個維度的產品，目標 <span>$K = 5$</span><!-- Has MathJax -->，則表示要在 6 的維度中任意挑選 5 個維度比較，若存在一種挑法可以支配，則可以說 <span>$p_i$</span><!-- Has MathJax --> <em>k</em>-dominate <span>$p_j$</span><!-- Has MathJax --></p>
<p>例如現在有 8 台筆記型電腦，共有 6 種屬性可以比較，數值越大越好。</p>
<table>
<thead>
<tr>
<th style="text-align:center">Notebook</th>
<th style="text-align:center">CPU</th>
<th style="text-align:center">RAM</th>
<th style="text-align:center">HDD</th>
<th style="text-align:center">HDD S.</th>
<th style="text-align:center">Q.</th>
<th style="text-align:center">VRAM</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><span>$N_1$</span><!-- Has MathJax --></td>
<td style="text-align:center">3</td>
<td style="text-align:center">3</td>
<td style="text-align:center">5</td>
<td style="text-align:center">6</td>
<td style="text-align:center">6</td>
<td style="text-align:center">8</td>
</tr>
<tr>
<td style="text-align:center"><span>$N_2$</span><!-- Has MathJax --></td>
<td style="text-align:center">9</td>
<td style="text-align:center">4</td>
<td style="text-align:center">9</td>
<td style="text-align:center">7</td>
<td style="text-align:center">7</td>
<td style="text-align:center">9</td>
</tr>
<tr>
<td style="text-align:center"><span>$N_3$</span><!-- Has MathJax --></td>
<td style="text-align:center">8</td>
<td style="text-align:center">4</td>
<td style="text-align:center">7</td>
<td style="text-align:center">9</td>
<td style="text-align:center">2</td>
<td style="text-align:center">7</td>
</tr>
<tr>
<td style="text-align:center"><span>$N_4$</span><!-- Has MathJax --></td>
<td style="text-align:center">5</td>
<td style="text-align:center">6</td>
<td style="text-align:center">8</td>
<td style="text-align:center">9</td>
<td style="text-align:center">5</td>
<td style="text-align:center">9</td>
</tr>
<tr>
<td style="text-align:center"><span>$N_5$</span><!-- Has MathJax --></td>
<td style="text-align:center">9</td>
<td style="text-align:center">7</td>
<td style="text-align:center">9</td>
<td style="text-align:center">6</td>
<td style="text-align:center">2</td>
<td style="text-align:center">4</td>
</tr>
<tr>
<td style="text-align:center"><span>$N_6$</span><!-- Has MathJax --></td>
<td style="text-align:center">6</td>
<td style="text-align:center">6</td>
<td style="text-align:center">6</td>
<td style="text-align:center">5</td>
<td style="text-align:center">3</td>
<td style="text-align:center">5</td>
</tr>
<tr>
<td style="text-align:center"><span>$N_7$</span><!-- Has MathJax --></td>
<td style="text-align:center">5</td>
<td style="text-align:center">7</td>
<td style="text-align:center">3</td>
<td style="text-align:center">8</td>
<td style="text-align:center">4</td>
<td style="text-align:center">6</td>
</tr>
<tr>
<td style="text-align:center"><span>$N_8$</span><!-- Has MathJax --></td>
<td style="text-align:center">4</td>
<td style="text-align:center">4</td>
<td style="text-align:center">8</td>
<td style="text-align:center">6</td>
<td style="text-align:center">6</td>
<td style="text-align:center">4</td>
</tr>
</tbody>
</table>
<p>若要判斷 <span>$N_2$</span><!-- Has MathJax --> 是否支配 <span>$N_3$</span><!-- Has MathJax -->，從中挑取 (CPU, RAM, HDD, HDD S., Q.) 這 5 個屬性比較，得到 <span>$N_2$</span><!-- Has MathJax --> 勝過於 <span>$N_3$</span><!-- Has MathJax -->。最後可以發現到 <span>$N_2$</span><!-- Has MathJax --> 這產品可以支配 <span>$N_1, N_3, N_5, N_6, N_8$</span><!-- Has MathJax -->。</p>
<p>現在問題來了，要找到不被任何產品支配的產品 (<em>k</em>-dominant skyline)。如上表 8 項產品的情況，只會有 <span>$N_2, N_4$</span><!-- Has MathJax -->。</p>
<h2 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h2><p>第一行會有一個整數 <span>$T$</span><!-- Has MathJax --> 表示有多少組測資。</p>
<p>每一組測資第一行會有三個整數 <span>$N, D, K$</span><!-- Has MathJax -->，分別表示產品數量、產品屬性種類、以及支配比較的屬性種類。接下來會有 <span>$N$</span><!-- Has MathJax --> 行數據，每一行上會有 <span>$D$</span><!-- Has MathJax --> 個整數 <span>$s_j$</span><!-- Has MathJax --> 表示一個產品的屬性，產品按照輸入順序編號。</p>
<ul>
<li><span>$N &lt; 1024$</span><!-- Has MathJax --></li>
<li><span>$0 &lt; D, K &lt; 8$</span><!-- Has MathJax --></li>
<li><span>$0 &lt; s_j &lt; 1000$</span><!-- Has MathJax -->
</li>
</ul>
<h2 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h2><p>對於每組測資輸出一行，輸出該組測資所有的 <em>k</em>-dominant skyline 的產品編號，由小到大輸出。若不存在則輸出 <code>NONE</code>。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">4</div><div class="line"></div><div class="line">2 3 1</div><div class="line">20 20 20</div><div class="line">20 20 20</div><div class="line"></div><div class="line">2 5 1</div><div class="line">20 5 20 20 20</div><div class="line">5 20 20 20 20</div><div class="line"></div><div class="line">4 6 5</div><div class="line">9 4 9 7 7 9</div><div class="line">9 7 9 6 5 4</div><div class="line">9 6 9 8 3 3</div><div class="line">1 2 3 9 2 2</div><div class="line"></div><div class="line">8 6 5</div><div class="line">3 3 5 6 6 8</div><div class="line">9 4 9 7 7 9</div><div class="line">8 4 7 9 2 7</div><div class="line">5 6 8 9 5 9</div><div class="line">9 7 9 6 2 4</div><div class="line">6 6 6 5 3 5</div><div class="line">5 7 3 8 4 6</div><div class="line">4 4 8 6 6 4</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Case #1: 1 2</div><div class="line">Case #2: NONE</div><div class="line">Case #3: 1</div><div class="line">Case #4: 2 4</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>這是一篇論文題目 <em>k</em>-dominant skyline set，網路上提出不少算法，看起來都是有容錯率。 </p>
<p>這一題只是介紹題，沒有強求高效算法計算，直接 <span>$O(N^2)$</span><!-- Has MathJax --> 的比較，稍微優化一下就可以。若要快一點，按照總和由大排到小，從概念上總和越大，表示支配別人的機率越高，那麼根據這種貪心思路去篩選，可以減少很多不必要的比較，速度會更快些。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;set&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1024</span>;</div><div class="line"><span class="keyword">int</span> N, D, K;</div><div class="line"><span class="built_in">vector</span>&lt; <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &gt; C;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Product</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> v[<span class="number">8</span>], id;</div><div class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Product &amp;a) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">return</span> sum() &gt; a.sum();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> s = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; D; i++)</div><div class="line">            s += v[i];</div><div class="line">        <span class="keyword">return</span> s;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">domain</span><span class="params">(Product &amp;u)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;x : C) &#123;</div><div class="line">            <span class="keyword">int</span> h1 = <span class="number">1</span>, h2 = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;e : x) &#123;</div><div class="line">                h1 &amp;= v[e] &gt;= u.v[e];</div><div class="line">                h2 |= v[e] &gt;  u.v[e];</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (h1 &amp;&amp; h2)   <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">&#125; item[MAXN];</div><div class="line"><span class="keyword">int</span> used[MAXN];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> testcase, cases = <span class="number">0</span>;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;testcase);</div><div class="line">    <span class="keyword">while</span> (testcase--) &#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;N, &amp;D, &amp;K);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; D; j++)</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;item[i].v[j]);</div><div class="line">            item[i].id = i;</div><div class="line">        &#125;</div><div class="line">        sort(item, item+N);</div><div class="line">        </div><div class="line">        C.clear();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (<span class="number">1</span>&lt;&lt;D); i++) &#123;</div><div class="line">            <span class="keyword">if</span> (__builtin_popcount(i) == K) &#123;</div><div class="line">                <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; A;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; D; j++) &#123;</div><div class="line">                    <span class="keyword">if</span> ((i&gt;&gt;j)&amp;<span class="number">1</span>)</div><div class="line">                        A.push_back(j);</div><div class="line">                &#125;</div><div class="line">                C.push_back(A);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="built_in">vector</span>&lt;Product&gt; filter;</div><div class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; ret;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">            used[i] = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (used[i] == <span class="number">0</span>) &#123;</div><div class="line">                filter.push_back(item[i]);</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = i+<span class="number">1</span>; j &lt; N; j++) &#123;</div><div class="line">                    <span class="keyword">if</span> (used[j] == <span class="number">0</span> &amp;&amp; item[i].domain(item[j]))</div><div class="line">                        used[j] = <span class="number">1</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filter.size(); i++) &#123;</div><div class="line">            <span class="keyword">int</span> ok = <span class="number">1</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N &amp;&amp; ok; j++) &#123;</div><div class="line">                <span class="keyword">if</span> (item[j].domain(filter[i]))</div><div class="line">                    ok = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (ok == <span class="number">1</span>)</div><div class="line">                ret.push_back(filter[i].id);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        sort(ret.begin(), ret.end());</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Case #%d:"</span>, ++cases);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ret.size(); i++)</div><div class="line">            <span class="built_in">printf</span>(<span class="string">" %d"</span>, ret[i]+<span class="number">1</span>);</div><div class="line">        <span class="built_in">puts</span>(ret.size() ? <span class="string">""</span> : <span class="string">" NONE"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-mproblem-puppy" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/11/03/mproblem-puppy/" class="article-date">
  <time datetime="2014-11-03T10:33:51.000Z" itemprop="datePublished">2014-11-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="http://i.imgur.com/wPu8hMV.jpg" rel="gallery_ckxv7t8uw009jlkvnxknwge4d">
        <img src="http://i.imgur.com/wPu8hMV.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/03/mproblem-puppy/">[ACM 題目] 竹馬不敵天降</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2014/11/03/mproblem-puppy/" data-id="ckxv7t8uw009jlkvnxknwge4d" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2014/11/03/mproblem-puppy/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Voronoi/">Voronoi</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/蒙地卡羅/">蒙地卡羅</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/計算幾何/">計算幾何</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>「話說，剛剛明明說的是合乎聖誕節的商品。這不是 H-GAME 嗎？哪裡有聖誕元素啊！」<br>「嗯，真虧你發現這點啊，但還是有點可惜，這是全齡版，沒有工口哦！」<br>「不管怎麼樣，一點也沒合聖誕節啊。」<br>「雖然你有好好學習許多東西，但對本質上完全沒有理解。」<br>「最近開始覺得有點明白了 …」<br>「那麼就來說明下這個作品吧」<br>「是一年前發售的大人氣美少女遊戲的續篇吧？」<br>「是的，那為什麼你沒有察覺到－『一年前』這句話所包含的意義」<br>「對於期盼著的人那就意味著 … 與戀人時隔一年的再會！」</p>
<p>在 GALGAME 故事發展過程中，竹馬幾乎沒勝過天降，走哪一條線進行發展正是玩 GALGAME 的樂趣。</p>
<p>然而有一款極為糟糕的 GALGAME 的初始方式則是在一開始選定座標下，系統會根據座標找到附近最鄰近少女，並且在隨後的故事情節都會圍繞這名少女。</p>
<p>遊戲的地圖設計很簡單，用一個矩形表示，現在已知 N 名少女的所在地 (都在矩形內部)。一開始選定的座標也必須落在矩形內，請問玩哪每個線路機率分布為何？</p>
<h2 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h2><p>輸入有多組測資。</p>
<p>每組第一行會有三個整數 N, A, B，表示在<span>$[0:A] \times [0:B]$</span><!-- Has MathJax --> 地圖中有 N 個已知座標。<br>接下來會有 N 行，每行上會有兩個整數 x, y，表示每名少女所在的座標<span>$(x, y)$</span><!-- Has MathJax --> 保證不會有重疊的情況。</p>
<span>$(0 &lt; N \le 100, 0 &lt; A, B \le 1000, 0 \le x \le A, 0 \le y \le B)$</span><!-- Has MathJax -->
<h2 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h2><p>對於每組測資輸出一行，根據輸入順序輸出每一個故事線的機率。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">2 5 3</div><div class="line">1 2</div><div class="line">4 2</div><div class="line">  </div><div class="line">2 5 3</div><div class="line">1 1</div><div class="line">2 2</div><div class="line">  </div><div class="line">3 5 3</div><div class="line">1 1</div><div class="line">2 2</div><div class="line">4 1</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Case 1: 0.500 0.500</div><div class="line">Case 2: 0.300 0.700</div><div class="line">Case 3: 0.292 0.313 0.396</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;set&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> eps 1e-6 </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 32767</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pt</span> &#123;</span></div><div class="line">    <span class="keyword">double</span> x, y;</div><div class="line">    Pt(<span class="keyword">double</span> a = <span class="number">0</span>, <span class="keyword">double</span> b = <span class="number">0</span>):</div><div class="line">    	x(a), y(b) &#123;&#125;	</div><div class="line">    Pt <span class="keyword">operator</span>-(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">return</span> Pt(x - a.x, y - a.y);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="built_in">fabs</span>(x - a.x) &gt; eps)</div><div class="line">            <span class="keyword">return</span> x &lt; a.x;</div><div class="line">        <span class="keyword">if</span> (<span class="built_in">fabs</span>(y - a.y) &gt; eps)</div><div class="line">            <span class="keyword">return</span> y &lt; a.y;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">dot</span><span class="params">(Pt a, Pt b)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> a.x * b.x + a.y * b.y;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">cross</span><span class="params">(Pt o, Pt a, Pt b)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (a.x-o.x)*(b.y-o.y)-(a.y-o.y)*(b.x-o.x);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">between</span><span class="params">(Pt a, Pt b, Pt c)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> dot(c - a, b - a) &gt;= -eps &amp;&amp; dot(c - b, a - b) &gt;= -eps;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">onSeg</span><span class="params">(Pt a, Pt b, Pt c)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> between(a, b, c) &amp;&amp; <span class="built_in">fabs</span>(cross(a, b, c)) &lt; eps;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Seg</span> &#123;</span></div><div class="line">    Pt s, e;</div><div class="line">    <span class="keyword">double</span> angle;</div><div class="line">    <span class="keyword">int</span> label;</div><div class="line">    Seg(Pt a = Pt(), Pt b = Pt(), <span class="keyword">int</span> l=<span class="number">0</span>):s(a), e(b), label(l) &#123;</div><div class="line">        angle = <span class="built_in">atan2</span>(e.y - s.y, e.x - s.x);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Seg &amp;other) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="built_in">fabs</span>(angle - other.angle) &gt; eps)</div><div class="line">            <span class="keyword">return</span> angle &gt; other.angle;</div><div class="line">        <span class="keyword">if</span> (cross(other.s, other.e, s) &gt; -eps)</div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="function">Pt <span class="title">getIntersect</span><span class="params">(Seg a, Seg b)</span> </span>&#123;</div><div class="line">    <span class="keyword">double</span> a1, b1, c1, a2, b2, c2;</div><div class="line">    <span class="keyword">double</span> dx, dy, d;</div><div class="line">    a1 = a.s.y - a.e.y, b1 = a.e.x - a.s.x;</div><div class="line">    c1 = a1 * a.s.x + b1 * a.s.y;</div><div class="line">    a2 = b.s.y - b.e.y, b2 = b.e.x - b.s.x;</div><div class="line">    c2 = a2 * b.s.x + b2 * b.s.y;</div><div class="line">    dx = c1 * b2 - c2 * b1, dy = a1 * c2 - a2 * c1;</div><div class="line">    d = a1 * b2 - a2 * b1;</div><div class="line">    <span class="keyword">return</span> Pt(dx/d, dy/d);</div><div class="line">&#125;</div><div class="line">Seg deq[MAXN];</div><div class="line"><span class="built_in">vector</span>&lt;Pt&gt; halfPlaneIntersect(<span class="built_in">vector</span>&lt;Seg&gt; segs) &#123;</div><div class="line">    sort(segs.begin(), segs.end());</div><div class="line">    <span class="keyword">int</span> n = segs.size(), m = <span class="number">1</span>;</div><div class="line">    <span class="keyword">int</span> front = <span class="number">0</span>, rear = <span class="number">-1</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="built_in">fabs</span>(segs[i].angle - segs[m<span class="number">-1</span>].angle) &gt; eps)</div><div class="line">            segs[m++] = segs[i];</div><div class="line">    &#125;</div><div class="line">    n = m;</div><div class="line">    deq[++rear] = segs[<span class="number">0</span>];</div><div class="line">    deq[++rear] = segs[<span class="number">1</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; n; i++) &#123;</div><div class="line">        <span class="keyword">while</span> (front &lt; rear &amp;&amp; cross(segs[i].s, segs[i].e, getIntersect(deq[rear], deq[rear<span class="number">-1</span>])) &lt; -eps)</div><div class="line">            rear--;</div><div class="line">        <span class="keyword">while</span> (front &lt; rear &amp;&amp; cross(segs[i].s, segs[i].e, getIntersect(deq[front], deq[front+<span class="number">1</span>])) &lt; -eps)</div><div class="line">            front++;</div><div class="line">        deq[++rear] = segs[i];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span> (front &lt; rear &amp;&amp; cross(deq[front].s, deq[front].e, getIntersect(deq[rear], deq[rear<span class="number">-1</span>])) &lt; -eps)</div><div class="line">        rear--;  </div><div class="line">    <span class="keyword">while</span> (front &lt; rear &amp;&amp; cross(deq[rear].s, deq[rear].e, getIntersect(deq[front], deq[front+<span class="number">1</span>])) &lt; -eps)</div><div class="line">    	front++;</div><div class="line">    	</div><div class="line">    <span class="built_in">vector</span>&lt;Pt&gt; ret;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = front; i &lt; rear; i++) &#123;</div><div class="line">        Pt p = getIntersect(deq[i], deq[i+<span class="number">1</span>]);</div><div class="line">        ret.push_back(p);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (rear &gt; front + <span class="number">1</span>) &#123;</div><div class="line">        Pt p = getIntersect(deq[front], deq[rear]);</div><div class="line">        ret.push_back(p);</div><div class="line">    &#125; </div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">calc_convexarea</span><span class="params">(<span class="keyword">const</span> <span class="built_in">vector</span>&lt;Pt&gt; &amp;p)</span> </span>&#123;</div><div class="line">    <span class="keyword">double</span> ret = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> n = p.size();</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>, j = n - <span class="number">1</span>; i &lt; n; j = i++)</div><div class="line">        ret += p[j].x * p[i].y - p[j].y * p[i].x;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">fabs</span>(ret /<span class="number">2.0</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, A, B, cases = <span class="number">0</span>;</div><div class="line">    Pt p[<span class="number">128</span>], mid, vij;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;n, &amp;A, &amp;B) == <span class="number">3</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%lf %lf"</span>, &amp;p[i].x, &amp;p[i].y);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Case %d:"</span>, ++cases);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            <span class="keyword">int</span> m = <span class="number">0</span>;</div><div class="line">            <span class="built_in">vector</span>&lt;Seg&gt; segs;</div><div class="line">            segs.resize(n - <span class="number">1</span> + <span class="number">4</span>);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</div><div class="line">                <span class="keyword">if</span> (i == j)	<span class="keyword">continue</span>;</div><div class="line">                mid.x = (p[i].x + p[j].x) /<span class="number">2.0</span>;</div><div class="line">                mid.y = (p[i].y + p[j].y) /<span class="number">2.0</span>;</div><div class="line">                vij.x = mid.x - (p[j].y - p[i].y);</div><div class="line">                vij.y = mid.y + (p[j].x - p[i].x);</div><div class="line">                segs[m] = Seg(mid, vij), m++;</div><div class="line">            &#125;</div><div class="line">            segs[m++] = Seg(Pt(<span class="number">0</span>, <span class="number">0</span>), Pt(A, <span class="number">0</span>));</div><div class="line">            segs[m++] = Seg(Pt(A, <span class="number">0</span>), Pt(A, B));</div><div class="line">            segs[m++] = Seg(Pt(A, B), Pt(<span class="number">0</span>, B));</div><div class="line">            segs[m++] = Seg(Pt(<span class="number">0</span>, B), Pt(<span class="number">0</span>, <span class="number">0</span>));</div><div class="line">            <span class="built_in">vector</span>&lt;Pt&gt; convex = halfPlaneIntersect(segs);</div><div class="line"><span class="comment">//			for (int j = 0; j &lt; convex.size(); j++)</span></div><div class="line"><span class="comment">//				printf("%lf %lf\n", convex[j].x, convex[j].y);</span></div><div class="line"><span class="comment">//			puts("--");</span></div><div class="line">            <span class="built_in">printf</span>(<span class="string">" %.3lf"</span>, calc_convexarea(convex) / (A * B));</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">puts</span>(<span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">2 5 3</span></div><div class="line"><span class="comment">1 2</span></div><div class="line"><span class="comment">4 2</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">2 5 3</span></div><div class="line"><span class="comment">1 1</span></div><div class="line"><span class="comment">2 2</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">3 5 3</span></div><div class="line"><span class="comment">1 1</span></div><div class="line"><span class="comment">2 2</span></div><div class="line"><span class="comment">4 1</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/categories/解題區/出題解題/page/2/">2</a><a class="page-number" href="/categories/解題區/出題解題/page/3/">3</a><a class="extend next" rel="next" href="/categories/解題區/出題解題/page/2/">Next &raquo;</a>
    </nav>
  
</section>
          
          
            <aside id="sidebar">
  <!-- <div id="ukagaka_panel"></div> -->
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/">學校課程</a><span class="category-list-count">115</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/介面設計/">介面設計</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/作業系統/">作業系統</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/即時系統/">即時系統</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/大學專題/">大學專題</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/巨量資料/">巨量資料</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/平行程式/">平行程式</a><span class="category-list-count">43</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/敏捷方法/">敏捷方法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/編譯器/">編譯器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/自然語言/">自然語言</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/虛擬實境/">虛擬實境</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算型智慧/">計算型智慧</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算幾何/">計算幾何</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算機圖學/">計算機圖學</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資料庫系統/">資料庫系統</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資訊安全/">資訊安全</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/通識課程/">通識課程</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/">工作應用</a><span class="category-list-count">38</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Java/">Java</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Meme/">Meme</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/其他/">其他</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/可持久化/">可持久化</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/鬼故事/">鬼故事</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/手札日記/">手札日記</a><span class="category-list-count">56</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/">網頁設計</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/About-This-Blog/">About This Blog</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/HTML5/">HTML5</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/JQuery/">JQuery</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/Markdown/">Markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/NodeJs/">NodeJs</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/">解題區</a><span class="category-list-count">633</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/Latex/">Latex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/出題解題/">出題解題</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-POJ/">解題區 - POJ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a><span class="category-list-count">483</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a><span class="category-list-count">77</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-未解題目/">解題區 - 未解題目</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/雜言筆記/">雜言筆記</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a class="text" href="/2022/01/01/note/diary-20220101/">
              
                <i class="icon-file-o"></i> 
              
            二八 ‧ 年尾</a>
          </li>
        
          <li>
            <a class="text" href="/2022/01/01/note/clove-letter/">
              
                <i class="icon-file-o"></i> 
              
            《獻給某工程師的情書》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/12/31/note/diary-20211231-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·陸》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/12/26/note/diary-20211226-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·伍》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/11/21/note/diary-20211121-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·肆》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/11/12/note/diary-20211112-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·參》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/31/note/diary-20211031-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·貳》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/28/note/diary-202110-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·序》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/28/note/diary-202110/">
              
                <i class="icon-file-o"></i> 
              
            好多個 28 在這個時刻</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/28/work/company-ghost-story-14/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 14</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">   
        <ul>
          <li><a href="http://mypaper.pchome.com.tw/zerojudge" target="_blank" title="Old Blog"><i class="icon-star"></i> Morris' Blog (pchome)</a></li>
        </ul>
    </div>
</div>

  
    
<script src="/js/jquery-ui.js"></script>
<script src="/js/ukagaka/jquery.morris.ukagaka.resource.js"></script>
<script src="/js/ukagaka/typed.js"></script>
  
  
</aside>
          
        
      </div>
      <footer id="footer">
  
  <div class="outer">    
    <div class="social-group">
      
      <a href="https://github.com/morris821028" target="_blank" title="github"><i class="icon-github"></i></a>
      
      
      <a href="https://www.facebook.com/Morris1028" target="_blank" title="facebook"><i class="icon-facebook-sign"></i></a>
      
      
      <a href="http://uhunt.felix-halim.net/id/46705" target="_blank" title="uhunt" ><span class="icon-uhunt">UVa<span></a>
      
    </div>
    <div id="footer-info" class="inner">
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/morris821028/hexo-theme-landscape" target="_blank" title="landscape">landscape</a> &copy; 2022 Shiang-Yun Yang 
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link"><i class=icon-home ></i>&nbsp&nbspHome</a>
  
    <a href="/about" class="mobile-nav-link"><i class=icon-user ></i>&nbsp&nbspAbout</a>
  
    <a href="/archives" class="mobile-nav-link"><i class=icon-archive ></i>&nbsp&nbspArchives</a>
  
    <a href="/tags" class="mobile-nav-link"><i class=icon-tags ></i>&nbsp&nbspTags</a>
  
    <a href="/picture" class="mobile-nav-link"><i class=icon-camera ></i>&nbsp&nbspPictures</a>
  
    <a href="/works" class="mobile-nav-link"><i class=icon-trophy ></i>&nbsp&nbspWorks</a>
  
</nav>
    
<script>
  var disqus_shortname = 'morris1028';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/jquery.lazyload.js"></script>
<script src="/js/jquery.als-1.6.js"></script>

<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>