<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Category: 解題區 | Morris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Morris&#39; Blog">
<meta property="og:url" content="http://morris821028.github.io/categories/解題區/index.html">
<meta property="og:site_name" content="Morris&#39; Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Morris&#39; Blog">
<link rel="publisher" href="108158678174364350000">
  
    <link rel="alternative" href="/atom.xml" title="Morris&#39; Blog" type="application/atom+xml">
  
  
    <meta name="google-site-verification" content="5mRgj8NanEMpGZuNfHNJNmH90RgNlrnJXsFlTaKD6Gs" />
  
  
    <link rel="shortcut icon" href="/img/f.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script src="/js/jquery-2.1.0.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.5.1.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdn.oesmith.co.uk/morris-0.5.1.min.js"></script>
  <link rel="import" href="/bower_components/app-layout/app-layout.html"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"><div id="banner-right"></div></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Morris&#39; Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class=icon-home title='Home'></i></a>
          
        
          
            <a class="main-nav-link" href="/about"><i class=icon-user title='About'></i></a>
          
        
          
            <a class="main-nav-link" href="/archives"><i class=icon-archive title='Archives'></i></a>
          
        
          
            <a class="main-nav-link" href="/tags"><i class=icon-tags title='Tags'></i></a>
          
        
          
            <a class="main-nav-link" href="/picture"><i class=icon-camera title='Pictures'></i></a>
          
        
          
            <a class="main-nav-link" href="/works"><i class=icon-trophy title='Works'></i></a>
          
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://morris821028.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        
          
          <section id="main">
  
    <article id="post-lesson/ada-2020-hw1-p3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/31/lesson/ada-2020-hw1-p3/" class="article-date">
  <time datetime="2020-10-31T08:30:00.000Z" itemprop="datePublished">2020-10-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/31/lesson/ada-2020-hw1-p3/">ADA 2020 Fall P3. ADA Party</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2020/10/31/lesson/ada-2020-hw1-p3/" data-id="ckpaivcae00c7n8vnew0kgi7f" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2020/10/31/lesson/ada-2020-hw1-p3/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/分治/">分治</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/排容/">排容</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>Algorithm Design and Analysis (NTU CSIE, Fall 2020)</p>
</blockquote>
<h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>給 <span>$N$</span><!-- Has MathJax --> 個堆，每個堆有 <span>$a_i$</span><!-- Has MathJax --> 個糖果，現在邀請 <span>$K$</span><!-- Has MathJax --> 個人，現在問有多少種挑選區間的方法，滿足扣掉最大堆和最小堆後，區間內的糖果總數可以被 <span>$K$</span><!-- Has MathJax --> 整除。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10 2</span><br><span class="line">6 9 3 4 5 6 1 7 8 3</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">25</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><blockquote>
<p>由於沒辦法參與課程，就測測自己產的測試資料，正確性有待確認。</p>
</blockquote>
<p>分治處理可行解的組合，每一次剖半計算，統計跨區間的答案個數。</p>
<p>討論項目分別為</p>
<ul>
<li>最大值、最小值嚴格都在左側</li>
<li>最大值、最小值嚴格都在右側</li>
<li>最大值在左側、最小值在右側</li>
<li>最大值在右側、最小值在左側</li>
</ul>
<p>最後兩項會有交集部分，則扣除 在左側的最大最小值接等於右側的最大最小值。對於每一項回答，搭配單調運行的滑動窗口解決。</p>
<p>時間複雜度 <span>$\mathcal{O}(n \log n)$</span><!-- Has MathJax -->、空間複雜度 <span>$\mathcal{O}(n)$</span><!-- Has MathJax --> </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Algorithm Design and Analysis (NTU CSIE, Fall 2020)</span></span><br><span class="line"><span class="comment">// Problem 3. ADA Party</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">500005</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int32_t</span> MIN = LONG_MIN;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int32_t</span> MAX = LONG_MAX;</span><br><span class="line"><span class="keyword">int32_t</span> a[MAXN];</span><br><span class="line"><span class="keyword">int32_t</span> lsum[MAXN], rsum[MAXN];</span><br><span class="line"><span class="keyword">int32_t</span> lmin[MAXN], lmax[MAXN];</span><br><span class="line"><span class="keyword">int32_t</span> rmin[MAXN], rmax[MAXN];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> cases = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> mark[MAXN];</span><br><span class="line"><span class="keyword">int</span> counter[MAXN];</span><br><span class="line"><span class="keyword">int</span> n, k;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inc</span><span class="params">(<span class="keyword">int32_t</span> val)</span> </span>&#123;</span><br><span class="line">    val = (val%k+k)%k;</span><br><span class="line">    <span class="keyword">if</span> (mark[val] != cases)</span><br><span class="line">        mark[val] = cases, counter[val] = <span class="number">0</span>;</span><br><span class="line">    counter[val]++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dec</span><span class="params">(<span class="keyword">int32_t</span> val)</span> </span>&#123;</span><br><span class="line">    val = (val%k+k)%k;</span><br><span class="line">    <span class="keyword">if</span> (mark[val] != cases)</span><br><span class="line">        mark[val] = cases, counter[val] = <span class="number">0</span>;</span><br><span class="line">    counter[val]--;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get</span><span class="params">(<span class="keyword">int32_t</span> val)</span> </span>&#123;</span><br><span class="line">    val = (val%k+k)%k;</span><br><span class="line">    <span class="keyword">if</span> (mark[val] != cases)</span><br><span class="line">        mark[val] = cases, counter[val] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> counter[val];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int64_t</span> <span class="title">common</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> m, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int64_t</span> ret = <span class="number">0</span>;</span><br><span class="line">    cases++;  <span class="comment">// max and min is same on both end</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = m, j = m+<span class="number">1</span>, jl = m+<span class="number">1</span>; i &gt;= l; i--) &#123;</span><br><span class="line">        <span class="keyword">while</span> (j &lt;= r &amp;&amp; (rmax[j] &lt;= lmax[i] &amp;&amp; rmin[j] &gt;= lmin[i])) &#123;</span><br><span class="line">            <span class="built_in">inc</span>(rsum[j]-rmin[j]);</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (jl &lt; j &amp;&amp; (rmin[jl] &gt; lmin[i] || rmax[jl] &lt; lmax[i])) &#123;</span><br><span class="line">            <span class="built_in">dec</span>(rsum[jl]-rmin[jl]);</span><br><span class="line">            jl++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j &gt; m+<span class="number">1</span> &amp;&amp; lmin[i] == rmin[j<span class="number">-1</span>] &amp;&amp; lmax[i] == rmax[j<span class="number">-1</span>])</span><br><span class="line">            ret += <span class="built_in">get</span>(k-(lsum[i]-lmax[i]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int64_t</span> <span class="title">divide</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (l &gt;= r)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int32_t</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int32_t</span> mn = MAX, mx = MIN;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = m; i &gt;= l; i--) &#123;</span><br><span class="line">        sum += a[i], mn = <span class="built_in">min</span>(mn, a[i]), mx = <span class="built_in">max</span>(mx, a[i]);</span><br><span class="line">        <span class="keyword">if</span> (sum &gt;= k)	sum %= k;</span><br><span class="line">        lsum[i] = sum, lmin[i] = mn, lmax[i] = mx;</span><br><span class="line">    &#125;</span><br><span class="line">    sum = <span class="number">0</span>, mn = MAX, mx = MIN;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = m+<span class="number">1</span>; i &lt;= r; i++) &#123;</span><br><span class="line">        sum += a[i], mn = <span class="built_in">min</span>(mn, a[i]), mx = <span class="built_in">max</span>(mx, a[i]);</span><br><span class="line">        <span class="keyword">if</span> (sum &gt;= k)	sum %= k;</span><br><span class="line">        rsum[i] = sum, rmin[i] = mn, rmax[i] = mx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int64_t</span> c1 = <span class="number">0</span>, c2 = <span class="number">0</span>, c3 = <span class="number">0</span>, c4 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    cases++; <span class="comment">// min max on the left</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = m, j = m+<span class="number">1</span>; i &gt;= l; i--) &#123;</span><br><span class="line">        <span class="keyword">while</span> (j &lt;= r &amp;&amp; lmin[i] &lt; a[j] &amp;&amp; a[j] &lt; lmax[i]) &#123;</span><br><span class="line">            <span class="built_in">inc</span>(rsum[j]);</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; m)</span><br><span class="line">            c1 += <span class="built_in">get</span>(k-(lsum[i]-lmin[i]-lmax[i]));</span><br><span class="line">    &#125;</span><br><span class="line">    cases++; <span class="comment">// min max on the right</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = m+<span class="number">1</span>, j = m; i &lt;= r; i++) &#123;</span><br><span class="line">        <span class="keyword">while</span> (j &gt;= l &amp;&amp; rmin[i] &lt; a[j] &amp;&amp; a[j] &lt; rmax[i]) &#123;</span><br><span class="line">            <span class="built_in">inc</span>(lsum[j]);</span><br><span class="line">            j--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i &gt; m+<span class="number">1</span>)</span><br><span class="line">            c2 += <span class="built_in">get</span>(k-(rsum[i]-rmin[i]-rmax[i]));</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    cases++;  <span class="comment">// min on the left, max on the right</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = m, j = m+<span class="number">1</span>, jl = m+<span class="number">1</span>; i &gt;= l; i--) &#123;</span><br><span class="line">        <span class="keyword">while</span> (j &lt;= r &amp;&amp; rmin[j] &gt;= lmin[i]) &#123;</span><br><span class="line">            <span class="built_in">inc</span>(rsum[j]-rmax[j]);</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (jl &lt; j &amp;&amp; rmax[jl] &lt; lmax[i]) &#123;</span><br><span class="line">            <span class="built_in">dec</span>(rsum[jl]-rmax[jl]);</span><br><span class="line">            jl++;</span><br><span class="line">        &#125;</span><br><span class="line">        c3 += <span class="built_in">get</span>(k-(lsum[i]-lmin[i]));</span><br><span class="line">    &#125;</span><br><span class="line">    cases++; <span class="comment">// min on the right, max on the left</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = m+<span class="number">1</span>, j = m, jl = m; i &lt;= r; i++) &#123;</span><br><span class="line">        <span class="keyword">while</span> (j &gt;= l &amp;&amp; lmin[j] &gt;= rmin[i]) &#123;</span><br><span class="line">            <span class="built_in">inc</span>(lsum[j]-lmax[j]);</span><br><span class="line">            j--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (jl &gt; j &amp;&amp; lmax[jl] &lt; rmax[i]) &#123;</span><br><span class="line">            <span class="built_in">dec</span>(lsum[jl]-lmax[jl]);</span><br><span class="line">            jl--;</span><br><span class="line">        &#125;</span><br><span class="line">        c4 += <span class="built_in">get</span>(k-(rsum[i]-rmin[i]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int64_t</span> local = c1 + c2 + c3 + c4 - <span class="built_in">common</span>(l, m, r);</span><br><span class="line">    <span class="keyword">return</span> local + <span class="built_in">divide</span>(l, m) + <span class="built_in">divide</span>(m+<span class="number">1</span>, r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;k) == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;a[i]);</span><br><span class="line">        <span class="built_in">memset</span>(counter, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(counter[<span class="number">0</span>])*k);</span><br><span class="line">        <span class="keyword">int64_t</span> ret = <span class="built_in">divide</span>(<span class="number">0</span>, n<span class="number">-1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>, ret);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-lesson/ada-2020-hw1-p2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/31/lesson/ada-2020-hw1-p2/" class="article-date">
  <time datetime="2020-10-31T08:00:00.000Z" itemprop="datePublished">2020-10-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/31/lesson/ada-2020-hw1-p2/">ADA 2020 Fall P2. Bomb Game</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2020/10/31/lesson/ada-2020-hw1-p2/" data-id="ckpaivcae00c6n8vn2f771mhz" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2020/10/31/lesson/ada-2020-hw1-p2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BIT/">BIT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/分治/">分治</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/整體二分/">整體二分</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>Algorithm Design and Analysis (NTU CSIE, Fall 2020)</p>
</blockquote>
<h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>有數名玩家依序抵達遊戲，並且落在位置 <span>$c_i$</span><!-- Has MathJax -->，並且具有防禦力 <span>$d_i$</span><!-- Has MathJax -->，過程中會有炸彈發生於 <span>$[l_i, r_i]$</span><!-- Has MathJax -->，對防禦力小於等於 <span>$p_i$</span><!-- Has MathJax --> 造成 <span>$k_i$</span><!-- Has MathJax --> 點傷害。</p>
<p>回報遊戲最後每一名玩家所受的傷害總額。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">10 10</span><br><span class="line">P 3 5</span><br><span class="line">A 2 8 15 5</span><br><span class="line">P 7 10</span><br><span class="line">A 4 10 5 3</span><br><span class="line">A 1 9 10 7</span><br><span class="line">P 6 20</span><br><span class="line">P 5 1</span><br><span class="line">A 4 9 17 2</span><br><span class="line">A 1 2 20 4</span><br><span class="line">P 9 5</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">12</span><br><span class="line">9</span><br><span class="line">0</span><br><span class="line">2</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><blockquote>
<p>由於沒辦法參與課程，就測測自己產的測試資料，正確性有待確認。</p>
</blockquote>
<p>如果這一題目強制在線對答，則需要一個樹套樹在 <span>$\mathcal{O}(\log^2 n)$</span><!-- Has MathJax --> 內回答每一個結果，需要一個動態開區間的實作方法。</p>
<p>如果採用離線處理，則可以透過逆序處理來回答，可以透過二維空間的 BIT 結構來完成，這時候空間上會是另一個問題，即使使用懶惰標記，預期可能會達到 <span>$\mathcal{O}(C \; D)$</span><!-- Has MathJax -->，通常是不允許的。</p>
<p>從分治算法切入，預想防禦能力高影響不受到攻擊力低的炸彈影響，無論時間與否都不受到影響。接下來，對防禦能力和攻擊力統稱力量。在分治的時候，對力量低的累計出答案，在合併階段受時間順序的影響才能回答。最後：</p>
<ol>
<li>對力量從小到大排序</li>
<li>分治算法<ol>
<li>對左區間和右區間按照時間由大到小排序</li>
<li>對於每一個左區間的詢問，插入所有滿足的右區間</li>
</ol>
</li>
</ol>
<p>時間複雜度 <span>$\mathcal{O}(n \log^2 n)$</span><!-- Has MathJax -->、空間複雜度 <span>$\mathcal{O}(n)$</span><!-- Has MathJax --> </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Algorithm Design and Analysis (NTU CSIE, Fall 2020)</span></span><br><span class="line"><span class="comment">// Problem 2. Bomb Game</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">200005</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BIT</span> &#123;</span></span><br><span class="line">    <span class="keyword">int64_t</span> a[MAXN];</span><br><span class="line">    <span class="keyword">int</span> l[MAXN];</span><br><span class="line">    <span class="keyword">int</span> cases = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> val, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (x &lt;= n) &#123;</span><br><span class="line">            <span class="keyword">if</span> (l[x] != cases)</span><br><span class="line">                l[x] = cases, a[x] = <span class="number">0</span>;</span><br><span class="line">            a[x] += val, x += x&amp;(-x);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int64_t</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int64_t</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (x) &#123;</span><br><span class="line">            <span class="keyword">if</span> (l[x] != cases)</span><br><span class="line">                l[x] = cases, a[x] = <span class="number">0</span>;</span><br><span class="line">            ret += a[x], x -= x&amp;(-x);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reset</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        cases++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> k, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">add</span>(l, k, n);</span><br><span class="line">        <span class="built_in">add</span>(r+<span class="number">1</span>, -k, n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; bit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PEvent</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> c, d, i;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AEvent</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> l, r, p, k;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Event</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> type; <span class="comment">// &#x27;P&#x27; 0 or &#x27;A&#x27; 1</span></span><br><span class="line">    <span class="keyword">int</span> time; <span class="comment">// input order</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        PEvent p;</span><br><span class="line">        AEvent a;</span><br><span class="line">    &#125; data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">power</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> data.p.d;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> data.a.p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">println</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="number">0</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;P %d %d\n&quot;</span>, data.p.c, data.p.d);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;A %d %d %d %d\n&quot;</span>, data.a.l, data.a.r, data.a.p, data.a.k);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; events[MAXN];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">cmp_p</span><span class="params">(Event &amp;a, Event &amp;b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pa = a.<span class="built_in">power</span>();</span><br><span class="line">    <span class="keyword">int</span> pb = b.<span class="built_in">power</span>();</span><br><span class="line">    <span class="keyword">if</span> (pa != pb)</span><br><span class="line">        <span class="keyword">return</span> pa &lt; pb;</span><br><span class="line">    <span class="keyword">return</span> a.time &lt; b.time;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">cmp_t</span><span class="params">(Event &amp;a, Event &amp;b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a.time &gt; b.time;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> ret[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">resolve</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> m, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">sort</span>(events+l, events+m+<span class="number">1</span>, <span class="keyword">cmp_t</span>);</span><br><span class="line">    <span class="built_in">sort</span>(events+m+<span class="number">1</span>, events+r+<span class="number">1</span>, <span class="keyword">cmp_t</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//	printf(&quot;resolve %d %d =========\n&quot;, l, r);</span></span><br><span class="line">    <span class="comment">//	for (int i = l; i &lt;= m; i++)</span></span><br><span class="line">    <span class="comment">//		events[i].println();</span></span><br><span class="line">    <span class="comment">//	puts(&quot;---&quot;);</span></span><br><span class="line">    <span class="comment">//	for (int i = m+1; i &lt;= r; i++)</span></span><br><span class="line">    <span class="comment">//		events[i].println();</span></span><br><span class="line">    bit.<span class="built_in">reset</span>(n);</span><br><span class="line">    <span class="keyword">int</span> j = m+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = l; i &lt;= m; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (events[i].type)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">int</span> qtime = events[i].time;</span><br><span class="line">        <span class="keyword">while</span> (j &lt;= r &amp;&amp; events[j].time &gt; qtime) &#123;</span><br><span class="line">            <span class="keyword">if</span> (events[j].type) &#123;</span><br><span class="line">                bit.<span class="built_in">add</span>(events[j].data.a.l,</span><br><span class="line">                        events[j].data.a.r,</span><br><span class="line">                        events[j].data.a.k,</span><br><span class="line">                        n);</span><br><span class="line">                <span class="comment">//				printf(&quot;add %d %d %d %d\n&quot;, events[j].data.a.l,</span></span><br><span class="line">                <span class="comment">//						events[j].data.a.r,</span></span><br><span class="line">                <span class="comment">//						events[j].data.a.p,</span></span><br><span class="line">                <span class="comment">//						events[j].data.a.k);</span></span><br><span class="line">            &#125;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//		printf(&quot;%d --- %d\n&quot;, events[i].data.p.i, bit.sum(events[i].data.p.c));</span></span><br><span class="line">        ret[events[i].data.p.i] += bit.<span class="built_in">sum</span>(events[i].data.p.c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">divide</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (l &gt;= r)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</span><br><span class="line">    <span class="built_in">divide</span>(l, m);</span><br><span class="line">    <span class="built_in">divide</span>(m+<span class="number">1</span>, r);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">resolve</span>(l, m, r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> m;</span><br><span class="line">    <span class="keyword">char</span> s[<span class="number">2</span>];</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> id = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s);</span><br><span class="line">        events[i].time = i;</span><br><span class="line">        <span class="keyword">if</span> (s[<span class="number">0</span>] == <span class="string">&#x27;P&#x27;</span>) &#123;</span><br><span class="line">            events[i].type = <span class="number">0</span>;</span><br><span class="line">            events[i].data.p.i = id++;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>,</span><br><span class="line">                    &amp;events[i].data.p.c,</span><br><span class="line">                    &amp;events[i].data.p.d);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            events[i].type = <span class="number">1</span>;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d %d %d&quot;</span>,</span><br><span class="line">                    &amp;events[i].data.a.l, </span><br><span class="line">                    &amp;events[i].data.a.r,</span><br><span class="line">                    &amp;events[i].data.a.p,</span><br><span class="line">                    &amp;events[i].data.a.k);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sort</span>(events, events+m, cmp_p);</span><br><span class="line">    <span class="built_in">divide</span>(<span class="number">0</span>, m<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; id; i++)	</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, ret[i]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-e021" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/16/zj-e021/" class="article-date">
  <time datetime="2019-02-16T01:11:22.000Z" itemprop="datePublished">2019-02-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/16/zj-e021/">動態幾何 史蒂芙的泡泡 (解法 2)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2019/02/16/zj-e021/" data-id="ckpaivcfo00njn8vngd73d3xs" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2019/02/16/zj-e021/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pbds/">pbds</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rope/">rope</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h2><p>在處理完數以百計的政事後，受盡折磨的史蒂芙，打算回家好好地休息。 拖著疲倦的身軀，再也無法再容納任何一點複雜計算。從王宮走回寢居的路上， 發現身邊所見的事物都不再圓滑，看起來就像是粗糙的幾何多邊形構成的一切。</p>
<p>打算享受著泡泡浴的史蒂芙，看著眼前的多邊形泡泡，失去原本應有的色澤，那透涼的心境更蒙上了一層灰影</p>
<p>「為什麼是我呢？」感嘆道</p>
<p>伸出手戳著眼前的泡泡，卻飄了過去</p>
<p>「區區的泡泡也跟我作對，嗚嗚」</p>
<p>將一個泡泡視為一個簡單多邊形 <span>$A$</span><!-- Has MathJax -->，方便起見用一個序列 <span>$a_0, a_1, ..., a_{n-1}$</span><!-- Has MathJax --> 表示多邊形 <span>$A$</span><!-- Has MathJax --> 的每一個頂點，則會有 <span>$n$</span><!-- Has MathJax --> 個線段 <span>$\overline{a_0 a_1}, \overline{a_1 a_2}, \cdots, \overline{a_{n-1} a_0}$</span><!-- Has MathJax -->。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">5 14</span><br><span class="line"></span><br><span class="line">0 0</span><br><span class="line">10 0 </span><br><span class="line">10 10</span><br><span class="line">0 10</span><br><span class="line">5 5</span><br><span class="line"></span><br><span class="line">1 0 0</span><br><span class="line">1 1 0</span><br><span class="line">1 2 1</span><br><span class="line">1 3 2</span><br><span class="line">3 5.5 5</span><br><span class="line">3 10 -1</span><br><span class="line">3 10 5</span><br><span class="line">1 4 1</span><br><span class="line">3 5.5 5</span><br><span class="line">3 10 -1</span><br><span class="line">3 10 5</span><br><span class="line">2 3</span><br><span class="line">3 5 7.5</span><br><span class="line">3 5 2.5</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>參閱 <a href="/2019/01/26/mproblem-dynamic-point-in-polygon/" title="動態幾何 史蒂芙的泡泡  (解法 1)">動態幾何 史蒂芙的泡泡  (解法 1)</a></p>
<p>相較於先前的解法 <span>$\mathcal{O}(\log n) - \mathcal{O}(\ast \sqrt{n})$</span><!-- Has MathJax -->，相當不穩定的嵌套 KD-BRH 的解法，實際上如果單純針對這一題，可以拋開 region search 的操作，只有完全的詢問點是否在多邊形內部，則可以做到 <span>$\mathcal{O}(\log^2 n)$</span><!-- Has MathJax -->。</p>
<p>如同一般的射線法，對詢問點拉出無限延長的線，找到與多邊形的邊相交個數。如果單純把每一條邊拿出來看，最暴力的複雜度為 <span>$\mathcal{O}(n)$</span><!-- Has MathJax -->，現在要減少查閱的邊數，且透過 rank tree 在 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax --> 累計相交數量。</p>
<p>由於給定的座標不需要動態，則著手離散化 <span>$X = x_0, x_1, \cdots, x_n$</span><!-- Has MathJax -->，線段樹中的每一個點 <span>$u$</span><!-- Has MathJax --> 維護一個 rank tree，把包含者個區段 <span>$[x_l, x_r]$</span><!-- Has MathJax --> 的線段通通放入，且保證放入的線段彼此之間不相交 (除了兩端點)。如此一來，當詢問一個點，需要探訪 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax --> 個節點，每個節點 <span>$u$</span><!-- Has MathJax --> 需要 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax --> 時間來計算相交數量，最後詢問的複雜度為 <span>$\mathcal{O}(\log^2 n)$</span><!-- Has MathJax -->。同理，修改點的操作也會在 <span>$\mathcal{O}(\log^2 n)$</span><!-- Has MathJax -->。</p>
<p>實作時，特別注意到與射線方向相同的線段不予處理，按照下面的寫法則是不處理垂直的線段，一來是射線法也不會去計算，二來是線段樹劃分的時候會造成一些邊界問題，由於我們對於點離散，父節點 <span>$[x_l, x_r]$</span><!-- Has MathJax -->，左右子樹控制的分別為 <span>$[x_l, x_\text{mid}]$</span><!-- Has MathJax -->、<span>$[x_\text{mid}, x_r]$</span><!-- Has MathJax -->，劃分時會共用中間點。</p>
<p>即使有了上述的概念來解題，我們仍需要維護 <a href="https://en.wikipedia.org/wiki/Rope_(data_structure">rope data structrue</a> 來維護節點的相鄰關係，可以自己實作任何的 binary tree 來達到 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax -->，這裡採用 splay tree 示範。</p>
<hr>
<p>接下來介紹內建黑魔法 PBDS (policy-based data structure) 和 rope。很多人都提及到這些非正式的 STL 函式庫，只有在 gcc/g++ 裡面才有附錄，如果是 clang 等其他編譯器可能是沒有辦法的。所以上傳相關代碼要看 OJ 是否採用純正的 gcc/g++。</p>
<p>參考資料：</p>
<ul>
<li><a href="https://codeforces.com/blog/entry/11080">C++ STL: Policy based data structures - Codeforces</a></li>
<li><a href="https://www.luogu.org/blog/Chanis/gnu-pbds">比STL还STL？——平板电视</a></li>
<li><a href="http://www.martinbroadhurst.com/stl/Rope.html">C++ STL: SGI rope</a></li>
</ul>
<p>PBDS 比較常用在 rank tree 和 heap，由於代碼量非常多，用內建防止 code length exceed limitation 的出現，也不妨是個好辦法。用 rank tree 的每一個詢問操作皆在 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax -->，而 heap 選擇 thin heap 或 pairing heap，除了 pop 操作外，皆為 <span>$\mathcal{O}(1)$</span><!-- Has MathJax -->，在對最短路徑問題上別有優勢。</p>
<p>而這一題不太適用 SGI rope，原因在於雖為 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax --> 操作，但它原本就為了仿作 string 而強迫變成可持久化的引數結構，導致每一個操作需要額外的開銷來減少內存使用。由於此題經常在單一元素上操作，SGI rope 對於單一元素效能不彰，以造成嚴重的逾時。</p>
<p>這裡仍提及和示範這些概念的資料結構，哪天正式編入標準函式庫，想必效能問題都已解決。</p>
<hr>
<ul>
<li>KD BRH AC(0.2s, 10 MB)</li>
<li>PBDS + SPLAY AC(0.3s, 38 MB)</li>
<li>PBDS + SGI rope AC(0.5s, 41 MB)<br>本機 MINGW gcc 4.9 c++ 11 編譯完運行最大的測資需要 20 倍慢於其他寫法，但是上傳到 ZJ 的 gcc 7 又追回去了。於是下載 CYGWIN gcc 7 測試結果與 ZJ 運行結果相當，對於需要調適的人，建議在新版上測試。</li>
</ul>
<p>用 splay tree 模擬 rope 的時候，會遇到循序非遞減的走訪，這時候若不斷地旋轉至根，會在之後的操作造成退化，常數稍微大一點，雖然在迭代過程中造就好的快取效能，很快地在 <span>$\mathcal{O}(1)$</span><!-- Has MathJax --> 訪問到相鄰的節點，卻在下一次的插入/刪除操作中變慢。一些變異的版本中，如只在插入/刪除操作中旋轉至根，在查找操作中不旋轉，或者限制旋轉的深度。雖然有一些特別的退化操作，splay 仍舊是某些 OS 場景中使用的資料結構，現實總是很特別的。</p>
<blockquote><p>In 2000, Danny Sleator and Robert Tarjan won the ACM Kanellakis Theory and Practice Award for their papers on splay trees and amortized analysis.  Splay trees are used in Windows NT (in the virtual memory, networking, and file system code), the gcc compiler and GNU C++ library, the sed string editor, Fore Systems network routers, the most popular implementation of Unix malloc, Linux loadable kernel modules, and in much other software.</p>
<footer><strong>Berkeley eecs April 23, 2014</strong><cite><a href="https://people.eecs.berkeley.edu/~jrs/61b/lec/36">people.eecs.berkeley.edu/~jrs/61b/lec/36</a></cite></footer></blockquote>

<h3 id="PBDS-SPLAY"><a href="#PBDS-SPLAY" class="headerlink" title="PBDS + SPLAY"></a>PBDS + SPLAY</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ext/pb_ds/assoc_container.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ext/pb_ds/tree_policy.hpp&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> __gnu_pbds;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Mesh</span> &#123;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1e5</span> + <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">int</span> pt[MAXN][<span class="number">2</span>];</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; X;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;pt[i][<span class="number">0</span>], &amp;pt[i][<span class="number">1</span>]);</span><br><span class="line">        X.<span class="built_in">clear</span>(); X.<span class="built_in">reserve</span>(n);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            X.<span class="built_in">push_back</span>(pt[i][<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">sort</span>(X.<span class="built_in">begin</span>(), X.<span class="built_in">end</span>());</span><br><span class="line">        X.<span class="built_in">erase</span>(<span class="built_in">unique</span>(X.<span class="built_in">begin</span>(), X.<span class="built_in">end</span>()), X.<span class="built_in">end</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125; mesh;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplayTree</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        Node *ch[<span class="number">2</span>], *fa;</span><br><span class="line">        <span class="keyword">int</span> size; <span class="keyword">int</span> data;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;</span><br><span class="line">            ch[<span class="number">0</span>] = ch[<span class="number">1</span>] = fa = <span class="literal">NULL</span>;</span><br><span class="line">            size = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">is_root</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> fa-&gt;ch[<span class="number">0</span>] != <span class="keyword">this</span> &amp;&amp; fa-&gt;ch[<span class="number">1</span>] != <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    Node *root, *EMPTY;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">(Node *u)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u-&gt;ch[<span class="number">0</span>] != EMPTY)	<span class="built_in">pushdown</span>(u-&gt;ch[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (u-&gt;ch[<span class="number">1</span>] != EMPTY)	<span class="built_in">pushdown</span>(u-&gt;ch[<span class="number">1</span>]);</span><br><span class="line">        u-&gt;size = <span class="number">1</span> + u-&gt;ch[<span class="number">0</span>]-&gt;size + u-&gt;ch[<span class="number">1</span>]-&gt;size;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setch</span><span class="params">(Node *p, Node *u, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (p != EMPTY)	p-&gt;ch[i] = u;</span><br><span class="line">        <span class="keyword">if</span> (u != EMPTY)	u-&gt;fa = p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">SplayTree</span>() &#123;</span><br><span class="line">        EMPTY = <span class="keyword">new</span> <span class="built_in">Node</span>();</span><br><span class="line">        EMPTY-&gt;fa = EMPTY-&gt;ch[<span class="number">0</span>] = EMPTY-&gt;ch[<span class="number">1</span>] = EMPTY;</span><br><span class="line">        EMPTY-&gt;size = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        root = EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node *u = <span class="keyword">new</span> <span class="built_in">Node</span>();</span><br><span class="line">        u-&gt;fa = u-&gt;ch[<span class="number">0</span>] = u-&gt;ch[<span class="number">1</span>] = EMPTY;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rotate</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        Node *y;</span><br><span class="line">        <span class="keyword">int</span> d;</span><br><span class="line">        y = x-&gt;fa, d = y-&gt;ch[<span class="number">1</span>] == x ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        x-&gt;ch[d^<span class="number">1</span>]-&gt;fa = y, y-&gt;ch[d] = x-&gt;ch[d^<span class="number">1</span>];</span><br><span class="line">        x-&gt;ch[d^<span class="number">1</span>] = y;</span><br><span class="line">        <span class="keyword">if</span> (!y-&gt;<span class="built_in">is_root</span>())</span><br><span class="line">            y-&gt;fa-&gt;ch[y-&gt;fa-&gt;ch[<span class="number">1</span>] == y] = x;</span><br><span class="line">        x-&gt;fa = y-&gt;fa, y-&gt;fa = x;</span><br><span class="line">        <span class="built_in">pushup</span>(y);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deal</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!x-&gt;<span class="built_in">is_root</span>())	<span class="built_in">deal</span>(x-&gt;fa);</span><br><span class="line">        <span class="built_in">pushdown</span>(x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">(Node *x, Node *below)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x == EMPTY)	<span class="keyword">return</span> ;</span><br><span class="line">        Node *y, *z;</span><br><span class="line">        <span class="built_in">deal</span>(x);</span><br><span class="line">        <span class="keyword">while</span> (!x-&gt;<span class="built_in">is_root</span>() &amp;&amp; x-&gt;fa != below) &#123;</span><br><span class="line">            y = x-&gt;fa, z = y-&gt;fa;</span><br><span class="line">            <span class="keyword">if</span> (!y-&gt;<span class="built_in">is_root</span>() &amp;&amp; y-&gt;fa != below) &#123;</span><br><span class="line">                <span class="keyword">if</span> (y-&gt;ch[<span class="number">0</span>] == x ^ z-&gt;ch[<span class="number">0</span>] == y)</span><br><span class="line">                    <span class="built_in">rotate</span>(x);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">rotate</span>(y);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">rotate</span>(x);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">pushup</span>(x);</span><br><span class="line">        <span class="keyword">if</span> (x-&gt;fa == EMPTY)	root = x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">prevNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">splay</span>(u, EMPTY);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">maxNode</span>(u-&gt;ch[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">nextNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">splay</span>(u, EMPTY);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">minNode</span>(u-&gt;ch[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">minNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        Node *p = u-&gt;fa;</span><br><span class="line">        <span class="keyword">for</span> (; <span class="built_in">pushdown</span>(u), u-&gt;ch[<span class="number">0</span>] != EMPTY; u = u-&gt;ch[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">splay</span>(u, p);</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">maxNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        Node *p = u-&gt;fa;</span><br><span class="line">        <span class="keyword">for</span> (; <span class="built_in">pushdown</span>(u), u-&gt;ch[<span class="number">1</span>] != EMPTY; u = u-&gt;ch[<span class="number">1</span>]);</span><br><span class="line">        <span class="built_in">splay</span>(u, p);</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">findPos</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123; <span class="comment">// [0...]</span></span><br><span class="line">        <span class="keyword">for</span> (Node *u = root; u != EMPTY;) &#123;</span><br><span class="line">            <span class="built_in">pushdown</span>(u);</span><br><span class="line">            <span class="keyword">int</span> t = u-&gt;ch[<span class="number">0</span>]-&gt;size;</span><br><span class="line">            <span class="keyword">if</span> (t == pos) &#123;</span><br><span class="line">                <span class="built_in">splay</span>(u, EMPTY);</span><br><span class="line">                <span class="keyword">return</span> u;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (t &gt; pos)</span><br><span class="line">                u = u-&gt;ch[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                u = u-&gt;ch[<span class="number">1</span>], pos -= t + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; <span class="title">insert</span><span class="params">(<span class="keyword">int</span> data, <span class="keyword">int</span> pos)</span> </span>&#123;	<span class="comment">// make [pos] = data</span></span><br><span class="line">        Node *p, *q = <span class="built_in">findPos</span>(pos);</span><br><span class="line">        Node *x = <span class="built_in">newNode</span>(); x-&gt;data = data;</span><br><span class="line">        <span class="keyword">if</span> (q == EMPTY) &#123;</span><br><span class="line">            p = <span class="built_in">maxNode</span>(root), <span class="built_in">splay</span>(p, EMPTY);</span><br><span class="line">            <span class="built_in">setch</span>(x, p, <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">splay</span>(x, EMPTY);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">splay</span>(q, EMPTY), p = q-&gt;ch[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">setch</span>(x, p, <span class="number">0</span>), <span class="built_in">setch</span>(x, q, <span class="number">1</span>);</span><br><span class="line">            <span class="built_in">setch</span>(q, EMPTY, <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">splay</span>(q, EMPTY);</span><br><span class="line">            p = <span class="built_in">prevNode</span>(x);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (p == EMPTY)	p = <span class="built_in">maxNode</span>(root);</span><br><span class="line">        <span class="keyword">if</span> (q == EMPTY)	q = <span class="built_in">minNode</span>(root);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">make_tuple</span>(p-&gt;data, data, q-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; <span class="title">remove</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">        Node *x = <span class="built_in">findPos</span>(pos), *p, *q;</span><br><span class="line">        p = <span class="built_in">prevNode</span>(x), q = <span class="built_in">nextNode</span>(x);</span><br><span class="line">        <span class="keyword">if</span> (p != EMPTY &amp;&amp; q != EMPTY) &#123;</span><br><span class="line">            <span class="built_in">setch</span>(p, q, <span class="number">1</span>);</span><br><span class="line">            p-&gt;fa = EMPTY, <span class="built_in">splay</span>(q, EMPTY);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p != EMPTY) &#123;</span><br><span class="line">            p-&gt;fa = EMPTY, root = p;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            q-&gt;fa = EMPTY, root = q;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> del = x-&gt;data;</span><br><span class="line">        <span class="keyword">delete</span> x;</span><br><span class="line">        <span class="keyword">if</span> (p == EMPTY)	p = <span class="built_in">maxNode</span>(root);</span><br><span class="line">        <span class="keyword">if</span> (q == EMPTY)	q = <span class="built_in">minNode</span>(root);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">make_tuple</span>(p-&gt;data, del, q-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> root == EMPTY ? <span class="number">0</span> : root-&gt;size;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; mlist;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pt</span> &#123;</span></span><br><span class="line">    <span class="keyword">double</span> x, y;</span><br><span class="line">    <span class="built_in">Pt</span>() &#123;&#125;</span><br><span class="line">    <span class="built_in">Pt</span>(<span class="keyword">int</span> xy[]):<span class="built_in">Pt</span>(xy[<span class="number">0</span>], xy[<span class="number">1</span>]) &#123;&#125;</span><br><span class="line">    <span class="built_in">Pt</span>(<span class="keyword">double</span> x, <span class="keyword">double</span> y):<span class="built_in">x</span>(x), <span class="built_in">y</span>(y) &#123;&#125;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Pt &amp;o) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x != o.x)	<span class="keyword">return</span> x &lt; o.x;</span><br><span class="line">        <span class="keyword">return</span> y &lt; o.y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PtP</span> &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">double</span> x;</span><br><span class="line">    Pt p, q;</span><br><span class="line">    <span class="built_in">PtP</span>(Pt a, Pt b) &#123;</span><br><span class="line">        p = a, q = b;</span><br><span class="line">        <span class="keyword">if</span> (q &lt; p)</span><br><span class="line">            <span class="built_in">swap</span>(p, q);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">interpolate</span><span class="params">(<span class="keyword">const</span> Pt&amp; p1, <span class="keyword">const</span> Pt&amp; p2, <span class="keyword">double</span>&amp; x)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (p1.x == p2.x) <span class="keyword">return</span> <span class="built_in">min</span>(p1.y, p2.y);</span><br><span class="line">        <span class="keyword">return</span> p1.y + (p2.y - p1.y) / (p2.x - p1.x) * (x - p1.x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> PtP &amp;o) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">interpolate</span>(p, q, x) &lt; <span class="built_in">interpolate</span>(o.p, o.q, x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">double</span> PtP::x = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SegSeg</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        Node *lson, *rson;</span><br><span class="line">        tree&lt;pair&lt;PtP, <span class="keyword">int</span>&gt;, null_type, less&lt;pair&lt;PtP, <span class="keyword">int</span>&gt;&gt;, rb_tree_tag, tree_order_statistics_node_update&gt; segs;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;</span><br><span class="line">            lson = rson = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    Node *root;</span><br><span class="line">    <span class="keyword">int</span> xn;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Node</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">freeNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">free</span>(u);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        root = <span class="literal">NULL</span>;</span><br><span class="line">        xn = mesh.X.<span class="built_in">size</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> p, q, r; <span class="built_in">tie</span>(p, q, r) = e;</span><br><span class="line">        <span class="built_in">remove</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[p]), <span class="built_in">Pt</span>(mesh.pt[r])), r&#125;);</span><br><span class="line">        <span class="built_in">insert</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[p]), <span class="built_in">Pt</span>(mesh.pt[q])), q&#125;);</span><br><span class="line">        <span class="built_in">insert</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[q]), <span class="built_in">Pt</span>(mesh.pt[r])), r&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> p, q, r; <span class="built_in">tie</span>(p, q, r) = e;</span><br><span class="line">        <span class="built_in">remove</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[p]), <span class="built_in">Pt</span>(mesh.pt[q])), q&#125;);</span><br><span class="line">        <span class="built_in">remove</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[q]), <span class="built_in">Pt</span>(mesh.pt[r])), r&#125;);</span><br><span class="line">        <span class="built_in">insert</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[p]), <span class="built_in">Pt</span>(mesh.pt[r])), r&#125;);</span><br><span class="line">    &#125;	</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">inside</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</span><br><span class="line">        PtP::x = x;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">count</span>(root, <span class="number">0</span>, xn<span class="number">-1</span>, x, y)&amp;<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">count</span><span class="params">(Node* u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((mesh.X[l] &gt; x) != (mesh.X[r] &gt; x))</span><br><span class="line">            ret += u-&gt;segs.<span class="built_in">order_of_key</span>(&#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(x, y), <span class="built_in">Pt</span>(x, y)), <span class="number">-1</span>&#125;);</span><br><span class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (x &lt;= mesh.X[m])</span><br><span class="line">            ret += <span class="built_in">count</span>(u-&gt;lson, l, m, x, y);</span><br><span class="line">        <span class="keyword">if</span> (x &gt;= mesh.X[m])</span><br><span class="line">            ret += <span class="built_in">count</span>(u-&gt;rson, m, r, x, y);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (s.first.p.x != s.first.q.x)</span><br><span class="line">            <span class="built_in">insert</span>(root, l, r, s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (s.first.p.x != s.first.q.x)</span><br><span class="line">            <span class="built_in">remove</span>(root, l, r, s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</span><br><span class="line">            u = <span class="built_in">newNode</span>();</span><br><span class="line">        <span class="keyword">if</span> (s.first.p.x &lt;= mesh.X[l] &amp;&amp; mesh.X[r] &lt;= s.first.q.x) &#123;</span><br><span class="line">            PtP::x = (mesh.X[l] + mesh.X[r])/<span class="number">2.0</span>;</span><br><span class="line">            u-&gt;segs.<span class="built_in">insert</span>(s);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (s.first.q.x &lt;= mesh.X[m])			<span class="built_in">insert</span>(u-&gt;lson, l, m, s);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s.first.p.x &gt;= mesh.X[m])	<span class="built_in">insert</span>(u-&gt;rson, m, r, s);</span><br><span class="line">        <span class="keyword">else</span>	<span class="built_in">insert</span>(u-&gt;lson, l, m, s), <span class="built_in">insert</span>(u-&gt;rson, m, r, s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(Node* u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (s.first.p.x &lt;= mesh.X[l] &amp;&amp; mesh.X[r] &lt;= s.first.q.x) &#123;</span><br><span class="line">            PtP::x = (mesh.X[l] + mesh.X[r])/<span class="number">2.0</span>;</span><br><span class="line">            u-&gt;segs.<span class="built_in">erase</span>(s);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (s.first.q.x &lt;= mesh.X[m])			<span class="built_in">remove</span>(u-&gt;lson, l, m, s);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s.first.p.x &gt;= mesh.X[m])	<span class="built_in">remove</span>(u-&gt;rson, m, r, s);</span><br><span class="line">        <span class="keyword">else</span>	<span class="built_in">remove</span>(u-&gt;lson, l, m, s), <span class="built_in">remove</span>(u-&gt;rson, m, r, s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; mbrh;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, m, cmd, x, pos;</span><br><span class="line">    <span class="keyword">double</span> px, py;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">    mesh.<span class="built_in">read</span>(n);</span><br><span class="line">    mlist.<span class="built_in">init</span>(), mbrh.<span class="built_in">init</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;x, &amp;pos);</span><br><span class="line">            mbrh.<span class="built_in">insert</span>(mlist.<span class="built_in">insert</span>(x, pos));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;x);</span><br><span class="line">            mbrh.<span class="built_in">remove</span>(mlist.<span class="built_in">remove</span>(x));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%lf %lf&quot;</span>, &amp;px, &amp;py);</span><br><span class="line">            <span class="built_in">puts</span>(mbrh.<span class="built_in">inside</span>(px, py) ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="PBDS-ROPE"><a href="#PBDS-ROPE" class="headerlink" title="PBDS + ROPE"></a>PBDS + ROPE</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ext/rope&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> __gnu_cxx;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ext/pb_ds/assoc_container.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ext/pb_ds/tree_policy.hpp&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> __gnu_pbds;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Mesh</span> &#123;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1e5</span> + <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">int</span> pt[MAXN][<span class="number">2</span>];</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; X;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;pt[i][<span class="number">0</span>], &amp;pt[i][<span class="number">1</span>]);</span><br><span class="line">        X.<span class="built_in">clear</span>(); X.<span class="built_in">reserve</span>(n);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            X.<span class="built_in">push_back</span>(pt[i][<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">sort</span>(X.<span class="built_in">begin</span>(), X.<span class="built_in">end</span>());</span><br><span class="line">        X.<span class="built_in">erase</span>(<span class="built_in">unique</span>(X.<span class="built_in">begin</span>(), X.<span class="built_in">end</span>()), X.<span class="built_in">end</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125; mesh;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rope</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    rope&lt;<span class="keyword">int</span>&gt; r;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        r.<span class="built_in">clear</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">next</span><span class="params">(rope&lt;<span class="keyword">int</span>&gt;::const_iterator it)</span> </span>&#123;</span><br><span class="line">        it++;</span><br><span class="line">        <span class="keyword">if</span> (it == r.<span class="built_in">end</span>())</span><br><span class="line">            <span class="keyword">return</span> *r.<span class="built_in">begin</span>();</span><br><span class="line">        <span class="keyword">return</span> *it;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">prev</span><span class="params">(rope&lt;<span class="keyword">int</span>&gt;::const_iterator it)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (it == r.<span class="built_in">begin</span>())</span><br><span class="line">            <span class="keyword">return</span> *r.<span class="built_in">rbegin</span>();</span><br><span class="line">        it--;</span><br><span class="line">        <span class="keyword">return</span> *it;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; <span class="title">insert</span><span class="params">(<span class="keyword">int</span> data, <span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">        r.<span class="built_in">insert</span>(pos, data);</span><br><span class="line">        <span class="keyword">auto</span> it = r.<span class="built_in">begin</span>() + pos;</span><br><span class="line">        <span class="keyword">int</span> p = <span class="built_in">prev</span>(it);</span><br><span class="line">        <span class="keyword">int</span> q = <span class="built_in">next</span>(it);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">make_tuple</span>(p, data, q);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; <span class="title">remove</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> it = r.<span class="built_in">begin</span>() + pos;</span><br><span class="line">        <span class="keyword">int</span> del = *it;</span><br><span class="line">        <span class="keyword">int</span> p = <span class="built_in">prev</span>(it);</span><br><span class="line">        <span class="keyword">int</span> q = <span class="built_in">next</span>(it);</span><br><span class="line">        r.<span class="built_in">erase</span>(pos, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">make_tuple</span>(p, del, q);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; mlist;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pt</span> &#123;</span></span><br><span class="line">    <span class="keyword">double</span> x, y;</span><br><span class="line">    <span class="built_in">Pt</span>() &#123;&#125;</span><br><span class="line">    <span class="built_in">Pt</span>(<span class="keyword">int</span> xy[]):<span class="built_in">Pt</span>(xy[<span class="number">0</span>], xy[<span class="number">1</span>]) &#123;&#125;</span><br><span class="line">    <span class="built_in">Pt</span>(<span class="keyword">double</span> x, <span class="keyword">double</span> y):<span class="built_in">x</span>(x), <span class="built_in">y</span>(y) &#123;&#125;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Pt &amp;o) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x != o.x)	<span class="keyword">return</span> x &lt; o.x;</span><br><span class="line">        <span class="keyword">return</span> y &lt; o.y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PtP</span> &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">double</span> x;</span><br><span class="line">    Pt p, q;</span><br><span class="line">    <span class="built_in">PtP</span>(Pt a, Pt b) &#123;</span><br><span class="line">        p = a, q = b;</span><br><span class="line">        <span class="keyword">if</span> (q &lt; p)</span><br><span class="line">            <span class="built_in">swap</span>(p, q);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">interpolate</span><span class="params">(<span class="keyword">const</span> Pt&amp; p1, <span class="keyword">const</span> Pt&amp; p2, <span class="keyword">double</span>&amp; x)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (p1.x == p2.x) <span class="keyword">return</span> <span class="built_in">min</span>(p1.y, p2.y);</span><br><span class="line">        <span class="keyword">return</span> p1.y + (p2.y - p1.y) / (p2.x - p1.x) * (x - p1.x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> PtP &amp;o) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">interpolate</span>(p, q, x) &lt; <span class="built_in">interpolate</span>(o.p, o.q, x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">double</span> PtP::x = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SegSeg</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        Node *lson, *rson;</span><br><span class="line">        tree&lt;pair&lt;PtP, <span class="keyword">int</span>&gt;, null_type, less&lt;pair&lt;PtP, <span class="keyword">int</span>&gt;&gt;, rb_tree_tag, tree_order_statistics_node_update&gt; segs;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;</span><br><span class="line">            lson = rson = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    Node *root;</span><br><span class="line">    <span class="keyword">int</span> xn;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Node</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        root = <span class="literal">NULL</span>;</span><br><span class="line">        xn = mesh.X.<span class="built_in">size</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> p, q, r; <span class="built_in">tie</span>(p, q, r) = e;</span><br><span class="line">        <span class="built_in">remove</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[p]), <span class="built_in">Pt</span>(mesh.pt[r])), r&#125;);</span><br><span class="line">        <span class="built_in">insert</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[p]), <span class="built_in">Pt</span>(mesh.pt[q])), q&#125;);</span><br><span class="line">        <span class="built_in">insert</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[q]), <span class="built_in">Pt</span>(mesh.pt[r])), r&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> p, q, r; <span class="built_in">tie</span>(p, q, r) = e;</span><br><span class="line">        <span class="built_in">remove</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[p]), <span class="built_in">Pt</span>(mesh.pt[q])), q&#125;);</span><br><span class="line">        <span class="built_in">remove</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[q]), <span class="built_in">Pt</span>(mesh.pt[r])), r&#125;);</span><br><span class="line">        <span class="built_in">insert</span>(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(mesh.pt[p]), <span class="built_in">Pt</span>(mesh.pt[r])), r&#125;);</span><br><span class="line">    &#125;	</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">inside</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</span><br><span class="line">        PtP::x = x;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">count</span>(root, <span class="number">0</span>, xn<span class="number">-1</span>, x, y)&amp;<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">count</span><span class="params">(Node* u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((mesh.X[l] &gt; x) != (mesh.X[r] &gt; x))</span><br><span class="line">            ret += u-&gt;segs.<span class="built_in">order_of_key</span>(&#123;<span class="built_in">PtP</span>(<span class="built_in">Pt</span>(x, y), <span class="built_in">Pt</span>(x, y)), <span class="number">-1</span>&#125;);</span><br><span class="line">        <span class="keyword">if</span> (l == r)</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (x &lt;= mesh.X[m])</span><br><span class="line">            ret += <span class="built_in">count</span>(u-&gt;lson, l, m, x, y);</span><br><span class="line">        <span class="keyword">if</span> (x &gt;= mesh.X[m])</span><br><span class="line">            ret += <span class="built_in">count</span>(u-&gt;rson, m, r, x, y);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (s.first.p.x != s.first.q.x)</span><br><span class="line">            <span class="built_in">insert</span>(root, l, r, s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (s.first.p.x != s.first.q.x)</span><br><span class="line">            <span class="built_in">remove</span>(root, l, r, s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</span><br><span class="line">            u = <span class="built_in">newNode</span>();</span><br><span class="line">        <span class="keyword">if</span> (s.first.p.x &lt;= mesh.X[l] &amp;&amp; mesh.X[r] &lt;= s.first.q.x) &#123;</span><br><span class="line">            PtP::x = (mesh.X[l] + mesh.X[r])/<span class="number">2.0</span>;</span><br><span class="line">            u-&gt;segs.<span class="built_in">insert</span>(s);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (l == r)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (s.first.q.x &lt;= mesh.X[m])			<span class="built_in">insert</span>(u-&gt;lson, l, m, s);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s.first.p.x &gt;= mesh.X[m])	<span class="built_in">insert</span>(u-&gt;rson, m, r, s);</span><br><span class="line">        <span class="keyword">else</span>	<span class="built_in">insert</span>(u-&gt;lson, l, m, s), <span class="built_in">insert</span>(u-&gt;rson, m, r, s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (s.first.p.x &lt;= mesh.X[l] &amp;&amp; mesh.X[r] &lt;= s.first.q.x) &#123;</span><br><span class="line">            PtP::x = (mesh.X[l] + mesh.X[r])/<span class="number">2.0</span>;</span><br><span class="line">            u-&gt;segs.<span class="built_in">erase</span>(s);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (l == r)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (s.first.q.x &lt;= mesh.X[m])			<span class="built_in">remove</span>(u-&gt;lson, l, m, s);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s.first.p.x &gt;= mesh.X[m])	<span class="built_in">remove</span>(u-&gt;rson, m, r, s);</span><br><span class="line">        <span class="keyword">else</span>	<span class="built_in">remove</span>(u-&gt;lson, l, m, s), <span class="built_in">remove</span>(u-&gt;rson, m, r, s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; mbrh;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, m, cmd, x, pos;</span><br><span class="line">    <span class="keyword">double</span> px, py;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">    mesh.<span class="built_in">read</span>(n);</span><br><span class="line">    mlist.<span class="built_in">init</span>(), mbrh.<span class="built_in">init</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;x, &amp;pos);</span><br><span class="line">            mbrh.<span class="built_in">insert</span>(mlist.<span class="built_in">insert</span>(x, pos));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;x);</span><br><span class="line">            mbrh.<span class="built_in">remove</span>(mlist.<span class="built_in">remove</span>(x));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%lf %lf&quot;</span>, &amp;px, &amp;py);</span><br><span class="line">            <span class="built_in">puts</span>(mbrh.<span class="built_in">inside</span>(px, py) ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-mproblem-dynamic-point-in-polygon" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/26/mproblem-dynamic-point-in-polygon/" class="article-date">
  <time datetime="2019-01-26T12:49:22.000Z" itemprop="datePublished">2019-01-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/26/mproblem-dynamic-point-in-polygon/">動態幾何 史蒂芙的泡泡  (解法 1)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2019/01/26/mproblem-dynamic-point-in-polygon/" data-id="ckpaivc7u0034n8vn39ikhmks" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2019/01/26/mproblem-dynamic-point-in-polygon/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BRH/">BRH</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Splay-tree/">Splay tree</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kd-tree/">kd-tree</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/射線法/">射線法</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>題目描述請至 Zerojudge e021: 史蒂芙的泡泡 查閱詳細內容</p>
</blockquote>
<h2 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h2><p>在處理完數以百計的政事後，受盡折磨的史蒂芙，打算回家好好地休息。 拖著疲倦的身軀，再也無法再容納任何一點複雜計算。從王宮走回寢居的路上， 發現身邊所見的事物都不再圓滑，看起來就像是粗糙的幾何多邊形構成的一切。</p>
<p>打算享受著泡泡浴的史蒂芙，看著眼前的多邊形泡泡，失去原本應有的色澤，那透涼的心境更蒙上了一層灰影</p>
<p>「為什麼是我呢？」感嘆道</p>
<p>伸出手戳著眼前的泡泡，卻飄了過去</p>
<p>「區區的泡泡也跟我作對，嗚嗚」</p>
<p>將一個泡泡視為一個簡單多邊形 <span>$A$</span><!-- Has MathJax -->，方便起見用一個序列 <span>$a_0, a_1, ..., a_{n-1}$</span><!-- Has MathJax --> 表示多邊形 <span>$A$</span><!-- Has MathJax --> 的每一個頂點，則會有 <span>$n$</span><!-- Has MathJax --> 個線段 <span>$\overline{a_0 a_1}, \overline{a_1 a_2}, \cdots, \overline{a_{n-1} a_0}$</span><!-- Has MathJax -->。</p>
<h2 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h2><p>從能找到的論文「A Unified Approach to Dynamic Point Location, Ray Shooting, and Shortest Paths in Planar Maps」 得知操作更新 <span>$\mathcal{O}(\log^3 n)$</span><!-- Has MathJax -->，詢問操作 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax -->，這一個實作難度估計沒辦法在 10K 限制下完成 (代碼上傳長度上限)。</p>
<p>從動態梯形剖分開始，複雜度就相當高了，而論文後要有類似輕重鏈剖分的概念，將對偶圖產生的節點以輕重邊保存，接著再維護雙線輪廓，讓相連的連續重邊可以保存左右兩側的輪廓，… 資訊量龐大，想到一些可能未提及的邊界案例，實作相當困難。而從其他題目的經驗中，當設計到 <span>$\mathcal{O}(\log^2 n)$</span><!-- Has MathJax --> 的操作時，由於操作常數大，運行時間可能無法匹敵 <span>$\mathcal{O}(\sqrt{n})$</span><!-- Has MathJax --> 的算法。</p>
<p>那麼有沒有其他的替代方案，只需要跑得比暴力法還要快就行？特別小心，暴力法找一個點是否在多邊形內，需要 <span>$\mathcal{O}(n)$</span><!-- Has MathJax --> 的時間，且快取效果非常好，很容易做到 SIMD 的平行技術。</p>
<p>首先，解決維護多邊形點集序列，可以使用任何的平衡樹完成，若採用 splay tree 在均攤 <span>$\text{Amortized} \; \mathcal{O}(\log n)$</span><!-- Has MathJax -->。使用 treap 也可以完成這類操作，還可以做到額外的持久化功能。接著，修改點的操作，可以轉換成替換一個點的下一個點，因此將點放在 KD tree 上，而維護下一個點相當於把每一個節點擴充成 BRH。</p>
<p>接著，當解決點是否在多邊形內時，可走訪 BRH 找射線穿過的交點個數，此時複雜度至少為 <span>$\mathcal{O}(\sqrt{n} + k)$</span><!-- Has MathJax -->，其中 <span>$k$</span><!-- Has MathJax --> 為交點個數。我們可以額外維護多邊形的順逆時針來優化搜尋空間，最後一個接觸的線段方向，額外提供奇偶數來判斷該點是否在內側，然後把射線縮短到交點到詢問點之間。不斷地縮短搜尋空間下，大部分的情況為 <span>$\mathcal{O}(\sqrt{n})$</span><!-- Has MathJax -->，拋開了原本存在的 <span>$k$</span><!-- Has MathJax -->。</p>
<p>由於是封閉的簡單多邊形，所以當邊的疏密程度不一時，KD tree 轉換 BRH 會造成額外的負擔，bounding box 無法有效提供分割空間的功能。那麼在實際搜尋情況，額外走訪的節點與平面分布有關，這部分就不好分析。如果有更好的想法，歡迎分享。</p>
<p>現在實作動態 KD tree 必須有替罪羊樹 Scapegoat tree 的概念，再掛上 BRH 的想法，提供了相對有效率的動態方法來查詢點是否在多邊形內部。若把維護點序列的 splay tree 換成 treap，便可以做到持久化的動態幾何操作，這便是一開始想要的目標。</p>
<p>如果梯形剖分也可以持久化？暫時還不想去思考，那思考的容器要多大呢？</p>
<h2 id="參考解法"><a href="#參考解法" class="headerlink" title="參考解法"></a>參考解法</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Mesh</span> &#123;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1e5</span> + <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">int</span> pt[MAXN][<span class="number">2</span>];</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;pt[i][<span class="number">0</span>], &amp;pt[i][<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; mesh;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplayTree</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        Node *ch[<span class="number">2</span>], *fa;</span><br><span class="line">        <span class="keyword">int</span> size; <span class="keyword">int</span> data;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;</span><br><span class="line">            ch[<span class="number">0</span>] = ch[<span class="number">1</span>] = fa = <span class="literal">NULL</span>;</span><br><span class="line">            size = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">is_root</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> fa-&gt;ch[<span class="number">0</span>] != <span class="keyword">this</span> &amp;&amp; fa-&gt;ch[<span class="number">1</span>] != <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    Node *root, *EMPTY;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">(Node *u)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u-&gt;ch[<span class="number">0</span>] != EMPTY)	<span class="built_in">pushdown</span>(u-&gt;ch[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (u-&gt;ch[<span class="number">1</span>] != EMPTY)	<span class="built_in">pushdown</span>(u-&gt;ch[<span class="number">1</span>]);</span><br><span class="line">        u-&gt;size = <span class="number">1</span> + u-&gt;ch[<span class="number">0</span>]-&gt;size + u-&gt;ch[<span class="number">1</span>]-&gt;size;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setch</span><span class="params">(Node *p, Node *u, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (p != EMPTY)	p-&gt;ch[i] = u;</span><br><span class="line">        <span class="keyword">if</span> (u != EMPTY)	u-&gt;fa = p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">SplayTree</span>() &#123;</span><br><span class="line">        EMPTY = <span class="keyword">new</span> <span class="built_in">Node</span>();</span><br><span class="line">        EMPTY-&gt;fa = EMPTY-&gt;ch[<span class="number">0</span>] = EMPTY-&gt;ch[<span class="number">1</span>] = EMPTY;</span><br><span class="line">        EMPTY-&gt;size = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        root = EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node *u = <span class="keyword">new</span> <span class="built_in">Node</span>();</span><br><span class="line">        u-&gt;fa = u-&gt;ch[<span class="number">0</span>] = u-&gt;ch[<span class="number">1</span>] = EMPTY;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rotate</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        Node *y;</span><br><span class="line">        <span class="keyword">int</span> d;</span><br><span class="line">        y = x-&gt;fa, d = y-&gt;ch[<span class="number">1</span>] == x ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        x-&gt;ch[d^<span class="number">1</span>]-&gt;fa = y, y-&gt;ch[d] = x-&gt;ch[d^<span class="number">1</span>];</span><br><span class="line">        x-&gt;ch[d^<span class="number">1</span>] = y;</span><br><span class="line">        <span class="keyword">if</span> (!y-&gt;<span class="built_in">is_root</span>())</span><br><span class="line">            y-&gt;fa-&gt;ch[y-&gt;fa-&gt;ch[<span class="number">1</span>] == y] = x;</span><br><span class="line">        x-&gt;fa = y-&gt;fa, y-&gt;fa = x;</span><br><span class="line">        <span class="built_in">pushup</span>(y);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deal</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!x-&gt;<span class="built_in">is_root</span>())	<span class="built_in">deal</span>(x-&gt;fa);</span><br><span class="line">        <span class="built_in">pushdown</span>(x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">(Node *x, Node *below)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x == EMPTY)	<span class="keyword">return</span> ;</span><br><span class="line">        Node *y, *z;</span><br><span class="line">        <span class="built_in">deal</span>(x);</span><br><span class="line">        <span class="keyword">while</span> (!x-&gt;<span class="built_in">is_root</span>() &amp;&amp; x-&gt;fa != below) &#123;</span><br><span class="line">            y = x-&gt;fa, z = y-&gt;fa;</span><br><span class="line">            <span class="keyword">if</span> (!y-&gt;<span class="built_in">is_root</span>() &amp;&amp; y-&gt;fa != below) &#123;</span><br><span class="line">                <span class="keyword">if</span> (y-&gt;ch[<span class="number">0</span>] == x ^ z-&gt;ch[<span class="number">0</span>] == y)</span><br><span class="line">                    <span class="built_in">rotate</span>(x);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">rotate</span>(y);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">rotate</span>(x);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">pushup</span>(x);</span><br><span class="line">        <span class="keyword">if</span> (x-&gt;fa == EMPTY)	root = x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">prevNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">splay</span>(u, EMPTY);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">maxNode</span>(u-&gt;ch[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">nextNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">splay</span>(u, EMPTY);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">minNode</span>(u-&gt;ch[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">minNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        Node *p = u-&gt;fa;</span><br><span class="line">        <span class="keyword">for</span> (; <span class="built_in">pushdown</span>(u), u-&gt;ch[<span class="number">0</span>] != EMPTY; u = u-&gt;ch[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">splay</span>(u, p);</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">maxNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        Node *p = u-&gt;fa;</span><br><span class="line">        <span class="keyword">for</span> (; <span class="built_in">pushdown</span>(u), u-&gt;ch[<span class="number">1</span>] != EMPTY; u = u-&gt;ch[<span class="number">1</span>]);</span><br><span class="line">        <span class="built_in">splay</span>(u, p);</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">findPos</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123; <span class="comment">// [0...]</span></span><br><span class="line">        <span class="keyword">for</span> (Node *u = root; u != EMPTY;) &#123;</span><br><span class="line">            <span class="built_in">pushdown</span>(u);</span><br><span class="line">            <span class="keyword">int</span> t = u-&gt;ch[<span class="number">0</span>]-&gt;size;</span><br><span class="line">            <span class="keyword">if</span> (t == pos) &#123;</span><br><span class="line">                <span class="built_in">splay</span>(u, EMPTY);</span><br><span class="line">                <span class="keyword">return</span> u;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (t &gt; pos)</span><br><span class="line">                u = u-&gt;ch[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                u = u-&gt;ch[<span class="number">1</span>], pos -= t + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; <span class="title">insert</span><span class="params">(<span class="keyword">int</span> data, <span class="keyword">int</span> pos)</span> </span>&#123;	<span class="comment">// make [pos] = data</span></span><br><span class="line">        Node *p, *q = <span class="built_in">findPos</span>(pos);</span><br><span class="line">        Node *x = <span class="built_in">newNode</span>(); x-&gt;data = data;</span><br><span class="line">        <span class="keyword">if</span> (q == EMPTY) &#123;</span><br><span class="line">            p = <span class="built_in">maxNode</span>(root), <span class="built_in">splay</span>(p, EMPTY);</span><br><span class="line">            <span class="built_in">setch</span>(x, p, <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">splay</span>(x, EMPTY);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">splay</span>(q, EMPTY), p = q-&gt;ch[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">setch</span>(x, p, <span class="number">0</span>), <span class="built_in">setch</span>(x, q, <span class="number">1</span>);</span><br><span class="line">            <span class="built_in">setch</span>(q, EMPTY, <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">splay</span>(q, EMPTY);</span><br><span class="line">            p = <span class="built_in">prevNode</span>(x);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (p == EMPTY)	p = <span class="built_in">maxNode</span>(root);</span><br><span class="line">        <span class="keyword">if</span> (q == EMPTY)	q = <span class="built_in">minNode</span>(root);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">make_tuple</span>(p-&gt;data, data, q-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; <span class="title">remove</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">        Node *x = <span class="built_in">findPos</span>(pos), *p, *q;</span><br><span class="line">        p = <span class="built_in">prevNode</span>(x), q = <span class="built_in">nextNode</span>(x);</span><br><span class="line">        <span class="keyword">if</span> (p != EMPTY &amp;&amp; q != EMPTY) &#123;</span><br><span class="line">            <span class="built_in">setch</span>(p, q, <span class="number">1</span>);</span><br><span class="line">            p-&gt;fa = EMPTY, <span class="built_in">splay</span>(q, EMPTY);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p != EMPTY) &#123;</span><br><span class="line">            p-&gt;fa = EMPTY, root = p;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            q-&gt;fa = EMPTY, root = q;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> del = x-&gt;data;</span><br><span class="line">        <span class="built_in">free</span>(x);</span><br><span class="line">        <span class="keyword">if</span> (p == EMPTY)	p = <span class="built_in">maxNode</span>(root);</span><br><span class="line">        <span class="keyword">if</span> (q == EMPTY)	q = <span class="built_in">minNode</span>(root);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">make_tuple</span>(p-&gt;data, del, q-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> root == EMPTY ? <span class="number">0</span> : root-&gt;size;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; mlist;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">log2int</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">31</span> - __builtin_clz(x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int64_t</span> <span class="title">h</span><span class="params">(<span class="keyword">int</span> p, <span class="keyword">int</span> q)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int64_t</span>) mesh.pt[p][<span class="number">0</span>]*mesh.pt[q][<span class="number">1</span>] - (<span class="keyword">int64_t</span>) mesh.pt[p][<span class="number">1</span>]*mesh.pt[q][<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">KDBRH</span> &#123;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">double</span> ALPHA = <span class="number">0.75</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">double</span> LOG_ALPHA = <span class="built_in">log2</span>(<span class="number">1.0</span> / ALPHA);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Pt</span> &#123;</span></span><br><span class="line">        <span class="keyword">int</span> d[<span class="number">2</span>];</span><br><span class="line">        <span class="built_in">Pt</span>() &#123;&#125;</span><br><span class="line">        <span class="built_in">Pt</span>(<span class="keyword">int</span> xy[]):<span class="built_in">Pt</span>(xy[<span class="number">0</span>], xy[<span class="number">1</span>]) &#123;&#125;</span><br><span class="line">        <span class="built_in">Pt</span>(<span class="keyword">int</span> x, <span class="keyword">int</span> y) &#123;d[<span class="number">0</span>] = x, d[<span class="number">1</span>] = y;&#125;</span><br><span class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> Pt &amp;x) <span class="keyword">const</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> d[<span class="number">0</span>] == x.d[<span class="number">0</span>] &amp;&amp; d[<span class="number">1</span>] == x.d[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> Pt <span class="title">NaN</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> <span class="built_in">Pt</span>(INT_MIN, INT_MIN);&#125;</span><br><span class="line">        <span class="function"><span class="keyword">int</span> <span class="title">isNaN</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> d[<span class="number">0</span>] == INT_MIN;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">PtP</span> &#123;</span></span><br><span class="line">        Pt p, q;</span><br><span class="line">        <span class="built_in">PtP</span>(Pt p, Pt q): <span class="built_in">p</span>(p), <span class="built_in">q</span>(q) &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cmpAxis</span> &#123;</span></span><br><span class="line">        <span class="keyword">int</span> k;</span><br><span class="line">        <span class="built_in">cmpAxis</span>(<span class="keyword">int</span> k): <span class="built_in">k</span>(k) &#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span> <span class="params">(<span class="keyword">const</span> PtP &amp;x, <span class="keyword">const</span> PtP &amp;y)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> x.p.d[k] &lt; y.p.d[k];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BBox</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KDMIN(a, b, c) &#123;a[0] = min(b[0], c[0]), a[1] = min(b[1], c[1]);&#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KDMAX(a, b, c) &#123;a[0] = max(b[0], c[0]), a[1] = max(b[1], c[1]);&#125;</span></span><br><span class="line">        <span class="keyword">int</span> l[<span class="number">2</span>], r[<span class="number">2</span>];</span><br><span class="line">        <span class="built_in">BBox</span>() &#123;&#125;</span><br><span class="line">        <span class="built_in">BBox</span>(<span class="keyword">int</span> a[], <span class="keyword">int</span> b[]) &#123;</span><br><span class="line">            <span class="built_in">KDMIN</span>(l, a, b); <span class="built_in">KDMAX</span>(r, a, b);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">expand</span><span class="params">(Pt p)</span> </span>&#123;</span><br><span class="line">            <span class="built_in">KDMIN</span>(l, l, p.d); <span class="built_in">KDMAX</span>(r, r, p.d);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">expand</span><span class="params">(BBox b)</span> </span>&#123;</span><br><span class="line">            <span class="built_in">KDMIN</span>(l, l, b.l); <span class="built_in">KDMAX</span>(r, r, b.r);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">raycast</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> fx, <span class="keyword">double</span> y)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> l[<span class="number">1</span>] &lt;= y &amp;&amp; y &lt;= r[<span class="number">1</span>] &amp;&amp; r[<span class="number">0</span>] &gt;= x &amp;&amp; l[<span class="number">0</span>] &lt;= fx;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> BBox <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            BBox b; b.l[<span class="number">0</span>] = b.l[<span class="number">1</span>] = INT_MAX, b.r[<span class="number">0</span>] = b.r[<span class="number">1</span>] = INT_MIN;</span><br><span class="line">            <span class="keyword">return</span> b;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        Node *lson, *rson;</span><br><span class="line">        Pt pt, qt;</span><br><span class="line">        BBox box;</span><br><span class="line">        <span class="keyword">int</span> size; <span class="keyword">int8_t</span> used;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            lson = rson = <span class="literal">NULL</span>;</span><br><span class="line">            size = <span class="number">1</span>, used = <span class="number">1</span>;</span><br><span class="line">            pt = qt = Pt::<span class="built_in">NaN</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">hasBox</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> box.l[<span class="number">0</span>] &lt;= box.r[<span class="number">0</span>]; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            size = used;</span><br><span class="line">            <span class="keyword">if</span> (lson)	size += lson-&gt;size;</span><br><span class="line">            <span class="keyword">if</span> (rson)	size += rson-&gt;size;</span><br><span class="line">            <span class="built_in">pushupBox</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushupBox</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            BBox t = BBox::<span class="built_in">init</span>();</span><br><span class="line">            <span class="keyword">if</span> (!qt.<span class="built_in">isNaN</span>())</span><br><span class="line">                t.<span class="built_in">expand</span>(pt), t.<span class="built_in">expand</span>(qt);</span><br><span class="line">            <span class="keyword">if</span> (lson &amp;&amp; lson-&gt;<span class="built_in">hasBox</span>())</span><br><span class="line">                t.<span class="built_in">expand</span>(lson-&gt;box);</span><br><span class="line">            <span class="keyword">if</span> (rson &amp;&amp; rson-&gt;<span class="built_in">hasBox</span>())</span><br><span class="line">                t.<span class="built_in">expand</span>(rson-&gt;box);</span><br><span class="line">            box = t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">double</span> <span class="title">interpolate</span><span class="params">(<span class="keyword">double</span> y)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (pt.d[<span class="number">1</span>] == qt.d[<span class="number">1</span>])	<span class="keyword">return</span> pt.d[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">return</span> pt.d[<span class="number">0</span>] + (qt.d[<span class="number">0</span>] - pt.d[<span class="number">0</span>]) * (y - pt.d[<span class="number">1</span>]) / (qt.d[<span class="number">1</span>] - pt.d[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    Node *root;</span><br><span class="line">    vector&lt;PtP&gt; A;</span><br><span class="line">    <span class="keyword">int64_t</span> area;</span><br><span class="line">    Node _mem[<span class="number">262144</span>];</span><br><span class="line">    <span class="keyword">int</span> gc[<span class="number">262144</span>], gci, memi;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node *u = gci &gt;= <span class="number">0</span> ? &amp;_mem[gc[gci--]] : &amp;_mem[memi++];</span><br><span class="line">        u-&gt;<span class="built_in">init</span>();</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">freeNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        gc[++gci] = u-_mem;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        root = <span class="literal">NULL</span>, area = <span class="number">0</span>;</span><br><span class="line">        gci = <span class="number">-1</span>, memi = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> p, q, r; <span class="built_in">tie</span>(p, q, r) = e;</span><br><span class="line">        <span class="built_in">insert</span>(root, <span class="number">0</span>, <span class="built_in">Pt</span>(mesh.pt[q]), <span class="built_in">Pt</span>(mesh.pt[p]), <span class="built_in">log2int</span>(<span class="built_in">size</span>()) / LOG_ALPHA);</span><br><span class="line">        <span class="built_in">changeNode</span>(root, <span class="number">0</span>, <span class="built_in">Pt</span>(mesh.pt[r]), <span class="built_in">Pt</span>(mesh.pt[q]));</span><br><span class="line">        area += <span class="built_in">h</span>(p, q) + <span class="built_in">h</span>(q, r) - <span class="built_in">h</span>(p, r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> p, q, r; <span class="built_in">tie</span>(p, q, r) = e;</span><br><span class="line">        <span class="built_in">remove</span>(root, <span class="number">0</span>, <span class="built_in">Pt</span>(mesh.pt[q]), <span class="built_in">log2int</span>(<span class="built_in">size</span>()) / LOG_ALPHA);</span><br><span class="line">        <span class="built_in">changeNode</span>(root, <span class="number">0</span>, <span class="built_in">Pt</span>(mesh.pt[r]), <span class="built_in">Pt</span>(mesh.pt[p]));</span><br><span class="line">        area -= <span class="built_in">h</span>(p, q) + <span class="built_in">h</span>(q, r) - <span class="built_in">h</span>(p, r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> RAY_T;</span><br><span class="line">    <span class="keyword">double</span> RAY_X;</span><br><span class="line">    vector&lt;<span class="keyword">double</span>&gt; X;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">inside</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (area == <span class="number">0</span>)	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        X.<span class="built_in">clear</span>(), RAY_X = <span class="number">1e+12</span>, RAY_T = <span class="number">-1</span>;</span><br><span class="line">        <span class="built_in">raycast</span>(root, x, y);</span><br><span class="line">        <span class="keyword">if</span> (RAY_T &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> X.<span class="built_in">size</span>()&amp;<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> pass = (area &gt; <span class="number">0</span>) == RAY_T;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;x : X)</span><br><span class="line">            pass += x &lt;= RAY_X;</span><br><span class="line">        <span class="keyword">return</span> pass&amp;<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> root == <span class="literal">NULL</span> ? <span class="number">0</span> : root-&gt;size; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">isbad</span><span class="params">(Node *u, Node *v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u == root)	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> l = v ? v-&gt;size : <span class="number">0</span>;</span><br><span class="line">        l = <span class="built_in">max</span>(l, u-&gt;size-u-&gt;used-l);</span><br><span class="line">        <span class="keyword">return</span> l &gt; u-&gt;size * ALPHA;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">build</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (l &gt; r)	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">int</span> mid = (l + r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        Node *ret = <span class="built_in">newNode</span>();</span><br><span class="line">        <span class="built_in">sort</span>(A.<span class="built_in">begin</span>()+l, A.<span class="built_in">begin</span>()+r+<span class="number">1</span>, <span class="built_in">cmpAxis</span>(k));</span><br><span class="line">        <span class="keyword">while</span> (mid &gt; l &amp;&amp; A[mid].p.d[k] == A[mid<span class="number">-1</span>].p.d[k])</span><br><span class="line">            mid--;</span><br><span class="line">        <span class="built_in">tie</span>(ret-&gt;pt, ret-&gt;qt) = <span class="built_in">tie</span>(A[mid].p, A[mid].q);</span><br><span class="line">        ret-&gt;lson = <span class="built_in">build</span>(!k, l, mid<span class="number">-1</span>);</span><br><span class="line">        ret-&gt;rson = <span class="built_in">build</span>(!k, mid+<span class="number">1</span>, r);</span><br><span class="line">        ret-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">flatten</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!u)	<span class="keyword">return</span> ;</span><br><span class="line">        <span class="built_in">flatten</span>(u-&gt;lson);</span><br><span class="line">        <span class="built_in">flatten</span>(u-&gt;rson);</span><br><span class="line">        <span class="keyword">if</span> (u-&gt;used)	A.<span class="built_in">emplace_back</span>(u-&gt;pt, u-&gt;qt);</span><br><span class="line">        <span class="built_in">freeNode</span>(u);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">changeNode</span><span class="params">(Node *u, <span class="keyword">int</span> k, Pt x, Pt qt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!u)	<span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (x == u-&gt;pt) &#123;</span><br><span class="line">            u-&gt;qt = qt, u-&gt;<span class="built_in">pushupBox</span>();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">changeNode</span>(x.d[k] &lt; u-&gt;pt.d[k] ? u-&gt;lson : u-&gt;rson, !k, x, qt);</span><br><span class="line">        u-&gt;<span class="built_in">pushupBox</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rebuild</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        A.<span class="built_in">clear</span>(), A.<span class="built_in">reserve</span>(u-&gt;size);</span><br><span class="line">        <span class="built_in">flatten</span>(u);</span><br><span class="line">        u = <span class="built_in">build</span>(k, <span class="number">0</span>, A.<span class="built_in">size</span>()<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">insert</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> k, Pt x, Pt y, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!u) &#123;</span><br><span class="line">            u = <span class="built_in">newNode</span>(), u-&gt;pt = x, u-&gt;qt = y, u-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">            <span class="keyword">return</span> d &lt;= <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (x == u-&gt;pt) &#123;</span><br><span class="line">            u-&gt;used = <span class="number">1</span>, u-&gt;qt = y, u-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">            <span class="keyword">return</span> d &lt;= <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">auto</span> &amp;v = x.d[k] &lt; u-&gt;pt.d[k] ? u-&gt;lson : u-&gt;rson;</span><br><span class="line">        <span class="keyword">int</span> t = <span class="built_in">insert</span>(v, !k, x, y, d<span class="number">-1</span>);</span><br><span class="line">        u-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">        <span class="keyword">if</span> (t &amp;&amp; !<span class="built_in">isbad</span>(u, v))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (t)	<span class="built_in">rebuild</span>(u, k);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">remove</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> k, Pt x, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!u)</span><br><span class="line">            <span class="keyword">return</span> d &lt;= <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (x == u-&gt;pt) &#123;</span><br><span class="line">            <span class="keyword">if</span> (u-&gt;lson || u-&gt;rson)</span><br><span class="line">                u-&gt;used = <span class="number">0</span>, u-&gt;qt = Pt::<span class="built_in">NaN</span>(), u-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">freeNode</span>(u), u = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">return</span> d &lt;= <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">auto</span> &amp;v = x.d[k] &lt; u-&gt;pt.d[k] ? u-&gt;lson : u-&gt;rson;</span><br><span class="line">        <span class="keyword">int</span> t = <span class="built_in">remove</span>(v, !k, x, d<span class="number">-1</span>);</span><br><span class="line">        u-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">        <span class="keyword">if</span> (t &amp;&amp; !<span class="built_in">isbad</span>(u, v))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (t)	<span class="built_in">rebuild</span>(u, k);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">cast</span><span class="params">(Node *u, <span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u-&gt;qt.<span class="built_in">isNaN</span>() || (u-&gt;pt.d[<span class="number">1</span>] &gt; y) == (u-&gt;qt.d[<span class="number">1</span>] &gt; y))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">double</span> tx = u-&gt;<span class="built_in">interpolate</span>(y);</span><br><span class="line">        <span class="keyword">if</span> (tx &lt;= x || tx &gt; RAY_X)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        RAY_X = tx, RAY_T = u-&gt;pt.d[<span class="number">1</span>] &lt; u-&gt;qt.d[<span class="number">1</span>];</span><br><span class="line">        X.<span class="built_in">emplace_back</span>(tx);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Node* stk[<span class="number">128</span>];</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">raycast</span><span class="params">(Node *u, <span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pushstk(u) &#123;*p++ = u;&#125;</span></span><br><span class="line">        Node **p = stk;</span><br><span class="line">        <span class="built_in">pushstk</span>(u);</span><br><span class="line">        <span class="keyword">while</span> (p &gt; stk) &#123;</span><br><span class="line">            u = *--p;</span><br><span class="line">            <span class="keyword">if</span> (!u || !u-&gt;size || !u-&gt;box.<span class="built_in">raycast</span>(x, RAY_X, y))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="built_in">cast</span>(u, x, y);</span><br><span class="line">            <span class="built_in">pushstk</span>(u-&gt;rson);</span><br><span class="line">            <span class="built_in">pushstk</span>(u-&gt;lson);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; mbrh;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, m, cmd, x, pos;</span><br><span class="line">    <span class="keyword">double</span> px, py;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">    mesh.<span class="built_in">read</span>(n);</span><br><span class="line">    mlist.<span class="built_in">init</span>(), mbrh.<span class="built_in">init</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;x, &amp;pos);</span><br><span class="line">            mbrh.<span class="built_in">insert</span>(mlist.<span class="built_in">insert</span>(x, pos));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;x);</span><br><span class="line">            mbrh.<span class="built_in">remove</span>(mlist.<span class="built_in">remove</span>(x));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%lf %lf&quot;</span>, &amp;px, &amp;py);</span><br><span class="line">            <span class="built_in">puts</span>(mbrh.<span class="built_in">inside</span>(px, py) ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-mproblem-dynamic-tree" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/26/mproblem-dynamic-tree/" class="article-date">
  <time datetime="2019-01-26T12:07:42.000Z" itemprop="datePublished">2019-01-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/26/mproblem-dynamic-tree/">動態樹 樹形避難所</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2019/01/26/mproblem-dynamic-tree/" data-id="ckpaivc7v0035n8vn4s8p0nqv" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2019/01/26/mproblem-dynamic-tree/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LCT/">LCT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Link-Cut-Tree/">Link/Cut Tree</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>題目描述請至 Zerojudge e003: 樹形避難所 I、e004: 樹形避難所 II 查閱詳細內容</p>
</blockquote>
<h2 id="樹形避難所-I"><a href="#樹形避難所-I" class="headerlink" title="樹形避難所 I"></a>樹形避難所 I</h2><p>在一個樹形避難所中有 $N$ 個房間，待在充滿監視器房間的你，透過監視器的顯示發現存在一些未知的入侵者出現在某些房間。為了保護同伴，你可以選擇開啟或關閉房間之間的通道，而你也會收到來自於某個房間的同伴求救訊號，此時給予所有可能遇見的入侵者數量，以便同伴做好萬全的作戰準備。然而，操縱通道的控制器已不受限制，你只能眼睜睜地看著同伴與入侵者對抗，現在的你 … 做好準備了嗎？</p>
<ul>
<li>操作 1 <span>$u$</span><!-- Has MathJax --> <span>$v$</span><!-- Has MathJax -->：將房間 <span>$u$</span><!-- Has MathJax --> 與 <span>$v$</span><!-- Has MathJax --> 的通道開啟</li>
<li>操作 2 <span>$u$</span><!-- Has MathJax --> <span>$v$</span><!-- Has MathJax -->：將房間 <span>$u$</span><!-- Has MathJax --> 與 <span>$v$</span><!-- Has MathJax --> 的通道關閉</li>
<li>操作 3 <span>$u$</span><!-- Has MathJax --> <span>$w$</span><!-- Has MathJax -->：更正房間 <span>$u$</span><!-- Has MathJax --> 為 <span>$w$</span><!-- Has MathJax --> 個入侵者</li>
<li>操作 4 <span>$u$</span><!-- Has MathJax -->：回答來自 <span>$u$</span><!-- Has MathJax --> 的求救信號，告知與其可能面臨到的入侵者個數</li>
</ul>
<h2 id="樹形避難所-II"><a href="#樹形避難所-II" class="headerlink" title="樹形避難所 II"></a>樹形避難所 II</h2><p>由於上一個樹形避難所已經不再安全，全員轉移到下一個避難所，新的地方將不再是先前的平面構造，新的避難所建構在地下水層中，每一個房間可以在水中移動，並且打通到上一層的某一個房間。不幸地，新的入侵者更加地難纏，想保護大家的你，想藉由破壞某一個房間，將其相連的下層房間的入侵者一同殲滅，情局不斷地變化，哪一個才是最好的破壞手段呢 …</p>
<ul>
<li>操作 1 <span>$u$</span><!-- Has MathJax --> <span>$v$</span><!-- Has MathJax -->：將房間 <span>$u$</span><!-- Has MathJax --> 與上層房間 <span>$v$</span><!-- Has MathJax --> 的通道開啟</li>
<li>操作 2 <span>$u$</span><!-- Has MathJax -->：關閉房間 <span>$u$</span><!-- Has MathJax --> 與上層的通道</li>
<li>操作 3 <span>$u$</span><!-- Has MathJax --> <span>$w$</span><!-- Has MathJax -->：更正房間 <span>$u$</span><!-- Has MathJax --> 為 <span>$w$</span><!-- Has MathJax --> 個入侵者</li>
<li>操作 4 <span>$u$</span><!-- Has MathJax -->：估算摧毀房間 <span>$u$</span><!-- Has MathJax -->，可以殲滅的入侵者個數</li>
</ul>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>這一題對於樹的操作，牽涉到修改邊，修改點權，詢問整個連通的樹大小、以及子樹大小。可以考慮使用 Link/Cut Tree 完成。也有高手使用了離線算法，對操作分治後計算答案，將一個邊的存在時間記錄在某個時間戳記上，整體落在 <span>$\mathcal{O}(M \log M)$</span><!-- Has MathJax -->，由上而下合併所有存在的邊來完成單一詢問，需要搭配啟發式合併，來指查找根造成的退化，這一點相當地聰明。若強制在線，仍需要使用動態樹完成之。</p>
<p>對於第一題，只有包含前三個操作，可以當作一個無根樹操作，因此在 LCT 中的 <span>$\text{MakeRoot}$</span><!-- Has MathJax --> 打上反轉標記，無視原本的父子關係，額外維護一個虛邊上的子樹大小，如此一來就可以計算整個子樹大小。其餘的點權修改就相較於容易許多。對於第二題，便要求有根樹，因此在轉到根節點時，不能打上反轉標記，此時的左子樹為父節點，扣除掉父節點的大小後，便可以得到子樹大小。</p>
<ul>
<li>動態樹解法：空間複雜度 <span>$\mathcal{O}(N)$</span><!-- Has MathJax -->，操作複雜度 <span>$\text{Amortized} \; \mathcal{O}(\log N)$</span><!-- Has MathJax --></li>
<li>離線解法：空間複雜度 <span>$\mathcal{O}(M \log M)$</span><!-- Has MathJax -->，整體時間複雜度 <span>$\mathcal{O}(M \log M)$</span><!-- Has MathJax --></li>
</ul>
<h2 id="延伸問題"><a href="#延伸問題" class="headerlink" title="延伸問題"></a>延伸問題</h2><p>如果子樹存在等價關係，意即他們會被一個操作同時受到影響，那麼更新會退化嗎？</p>
<p>如果這個問題能被解決，那麼使用相同的概念，便能解決更多的高壓縮架構問題。工作就能輕鬆一些了。</p>
<h2 id="參考解答"><a href="#參考解答" class="headerlink" title="參考解答"></a>參考解答</h2><h3 id="樹形避難所-I-1"><a href="#樹形避難所-I-1" class="headerlink" title="樹形避難所 I"></a>樹形避難所 I</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LCT</span> &#123;</span> <span class="comment">// Link-Cut Tree</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">30005</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span>;</span></span><br><span class="line">    <span class="keyword">static</span> Node *EMPTY;</span><br><span class="line">    <span class="keyword">static</span> Node _mem[MAXN];</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> bufIdx;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        Node *ch[<span class="number">2</span>], *fa;</span><br><span class="line">        <span class="keyword">int</span> rev;</span><br><span class="line">        <span class="keyword">int</span> vsize, size, val;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            ch[<span class="number">0</span>] = ch[<span class="number">1</span>] = fa = <span class="literal">NULL</span>;</span><br><span class="line">            size = <span class="number">0</span>, vsize = <span class="number">0</span>, rev = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">is_root</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> fa-&gt;ch[<span class="number">0</span>] != <span class="keyword">this</span> &amp;&amp; fa-&gt;ch[<span class="number">1</span>] != <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        	<span class="keyword">if</span> (rev) &#123;</span><br><span class="line">        		ch[<span class="number">0</span>]-&gt;rev ^= <span class="number">1</span>;</span><br><span class="line">                ch[<span class="number">1</span>]-&gt;rev ^= <span class="number">1</span>;</span><br><span class="line">        		<span class="built_in">swap</span>(ch[<span class="number">0</span>], ch[<span class="number">1</span>]);</span><br><span class="line">        		rev = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        	<span class="keyword">if</span> (<span class="keyword">this</span> == EMPTY)</span><br><span class="line">        		<span class="keyword">return</span>;</span><br><span class="line">        	size = ch[<span class="number">0</span>]-&gt;size + ch[<span class="number">1</span>]-&gt;size + val + vsize;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">LCT</span>() &#123;</span><br><span class="line">        EMPTY = &amp;_mem[<span class="number">0</span>];</span><br><span class="line">        EMPTY-&gt;fa = EMPTY-&gt;ch[<span class="number">0</span>] = EMPTY-&gt;ch[<span class="number">1</span>] = EMPTY;</span><br><span class="line">        EMPTY-&gt;size = <span class="number">0</span>;</span><br><span class="line">        bufIdx = <span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bufIdx = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node *u = &amp;_mem[bufIdx++];</span><br><span class="line">        u-&gt;<span class="built_in">init</span>();</span><br><span class="line">        u-&gt;fa = u-&gt;ch[<span class="number">0</span>] = u-&gt;ch[<span class="number">1</span>] = EMPTY;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rotate</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        Node *y;</span><br><span class="line">        <span class="keyword">int</span> d;</span><br><span class="line">        y = x-&gt;fa, d = y-&gt;ch[<span class="number">1</span>] == x ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        x-&gt;ch[d^<span class="number">1</span>]-&gt;fa = y, y-&gt;ch[d] = x-&gt;ch[d^<span class="number">1</span>];</span><br><span class="line">        x-&gt;ch[d^<span class="number">1</span>] = y;</span><br><span class="line">        <span class="keyword">if</span> (!y-&gt;<span class="built_in">is_root</span>())</span><br><span class="line">            y-&gt;fa-&gt;ch[y-&gt;fa-&gt;ch[<span class="number">1</span>] == y] = x;</span><br><span class="line">        x-&gt;fa = y-&gt;fa, y-&gt;fa = x;</span><br><span class="line">        y-&gt;<span class="built_in">pushup</span>(), x-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deal</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!x-&gt;<span class="built_in">is_root</span>())   <span class="built_in">deal</span>(x-&gt;fa);</span><br><span class="line">        x-&gt;<span class="built_in">pushdown</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        Node *y, *z;</span><br><span class="line">        <span class="built_in">deal</span>(x);</span><br><span class="line">        <span class="keyword">while</span> (!x-&gt;<span class="built_in">is_root</span>()) &#123;</span><br><span class="line">            y = x-&gt;fa, z = y-&gt;fa;</span><br><span class="line">            <span class="keyword">if</span> (!y-&gt;<span class="built_in">is_root</span>()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (y-&gt;ch[<span class="number">0</span>] == x ^ z-&gt;ch[<span class="number">0</span>] == y)</span><br><span class="line">                    <span class="built_in">rotate</span>(x);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">rotate</span>(y);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">rotate</span>(x);</span><br><span class="line">        &#125;</span><br><span class="line">        x-&gt;<span class="built_in">pushdown</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">access</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        Node *v = EMPTY;</span><br><span class="line">        <span class="keyword">for</span> (; u != EMPTY; u = u-&gt;fa) &#123;</span><br><span class="line">            <span class="built_in">splay</span>(u);</span><br><span class="line">            u-&gt;vsize += u-&gt;ch[<span class="number">1</span>] != EMPTY ? u-&gt;ch[<span class="number">1</span>]-&gt;size : <span class="number">0</span>;</span><br><span class="line">            u-&gt;vsize -= v != EMPTY ? v-&gt;size : <span class="number">0</span>;</span><br><span class="line">            u-&gt;ch[<span class="number">1</span>] = v;</span><br><span class="line">            u-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">            v = u;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">mk_root</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">access</span>(u)-&gt;rev ^= <span class="number">1</span>, <span class="built_in">splay</span>(u);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cut</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</span><br><span class="line">    	<span class="built_in">mk_root</span>(x);</span><br><span class="line">    	<span class="built_in">access</span>(y), <span class="built_in">splay</span>(y);</span><br><span class="line"><span class="comment">//    	debug(10);</span></span><br><span class="line">    	<span class="built_in">assert</span>(y-&gt;ch[<span class="number">0</span>] == x);</span><br><span class="line">        y-&gt;ch[<span class="number">0</span>] = x-&gt;fa = EMPTY;</span><br><span class="line">        y-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">link</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</span><br><span class="line">    	<span class="built_in">mk_root</span>(y);</span><br><span class="line">    	<span class="built_in">access</span>(x), <span class="built_in">splay</span>(x);</span><br><span class="line">        y-&gt;fa = x;</span><br><span class="line">        x-&gt;vsize += y-&gt;size;</span><br><span class="line">        x-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">find</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">access</span>(x), <span class="built_in">splay</span>(x);</span><br><span class="line">        <span class="keyword">for</span> (; x-&gt;ch[<span class="number">0</span>] != EMPTY; x = x-&gt;ch[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(Node *x, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">    	<span class="built_in">mk_root</span>(x);</span><br><span class="line">    	x-&gt;val = val;</span><br><span class="line">    	x-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">    	<span class="built_in">mk_root</span>(u);</span><br><span class="line">    	<span class="keyword">return</span> u-&gt;size;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">same</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">find</span>(x) == <span class="built_in">find</span>(y);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;==================&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            Node *u = &amp;_mem[i];</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[%d] %d, %d %d, %d %d %d\n&quot;</span>, i, u-&gt;fa-_mem, u-&gt;ch[<span class="number">0</span>]-_mem, u-&gt;ch[<span class="number">1</span>]-_mem, u-&gt;size, u-&gt;vsize, u-&gt;val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; lct;</span><br><span class="line">LCT::Node *LCT::EMPTY, LCT::_mem[LCT::MAXN];</span><br><span class="line"><span class="keyword">int</span> LCT::bufIdx;</span><br><span class="line">LCT::Node *node[LCT::MAXN];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, m;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</span><br><span class="line">        lct.<span class="built_in">init</span>();</span><br><span class="line">        <span class="keyword">int</span> cmd, u, v, w;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;w);</span><br><span class="line">            node[i] = lct.<span class="built_in">newNode</span>();</span><br><span class="line">            lct.<span class="built_in">set</span>(node[i], w);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;cmd);</span><br><span class="line">            <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;u, &amp;v);</span><br><span class="line">                lct.<span class="built_in">link</span>(node[u], node[v]);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;u, &amp;v);</span><br><span class="line">                lct.<span class="built_in">cut</span>(node[u], node[v]);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">3</span>) &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;u, &amp;w);</span><br><span class="line">                lct.<span class="built_in">set</span>(node[u], w);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">4</span>) &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;u);</span><br><span class="line">                <span class="keyword">int</span> p = lct.<span class="built_in">get</span>(node[u]);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, p);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;u, &amp;v);</span><br><span class="line">                <span class="keyword">int</span> f = lct.<span class="built_in">same</span>(node[u], node[v]);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, f);</span><br><span class="line">            &#125;</span><br><span class="line">            lct.<span class="built_in">debug</span>(<span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="樹形避難所-II-1"><a href="#樹形避難所-II-1" class="headerlink" title="樹形避難所 II"></a>樹形避難所 II</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LCT</span> &#123;</span> <span class="comment">// Link-Cut Tree</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">30005</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span>;</span></span><br><span class="line">    <span class="keyword">static</span> Node *EMPTY;</span><br><span class="line">    <span class="keyword">static</span> Node _mem[MAXN];</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> bufIdx;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        Node *ch[<span class="number">2</span>], *fa;</span><br><span class="line">        <span class="keyword">int</span> vsize, size, val;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            ch[<span class="number">0</span>] = ch[<span class="number">1</span>] = fa = <span class="literal">NULL</span>;</span><br><span class="line">            size = <span class="number">0</span>, vsize = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">is_root</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> fa-&gt;ch[<span class="number">0</span>] != <span class="keyword">this</span> &amp;&amp; fa-&gt;ch[<span class="number">1</span>] != <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        	<span class="keyword">if</span> (<span class="keyword">this</span> == EMPTY)</span><br><span class="line">        		<span class="keyword">return</span>;</span><br><span class="line">        	size = ch[<span class="number">0</span>]-&gt;size + ch[<span class="number">1</span>]-&gt;size + val + vsize;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">LCT</span>() &#123;</span><br><span class="line">        EMPTY = &amp;_mem[<span class="number">0</span>];</span><br><span class="line">        EMPTY-&gt;fa = EMPTY-&gt;ch[<span class="number">0</span>] = EMPTY-&gt;ch[<span class="number">1</span>] = EMPTY;</span><br><span class="line">        EMPTY-&gt;size = <span class="number">0</span>;</span><br><span class="line">        bufIdx = <span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bufIdx = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node *u = &amp;_mem[bufIdx++];</span><br><span class="line">        u-&gt;<span class="built_in">init</span>();</span><br><span class="line">        u-&gt;fa = u-&gt;ch[<span class="number">0</span>] = u-&gt;ch[<span class="number">1</span>] = EMPTY;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rotate</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        Node *y;</span><br><span class="line">        <span class="keyword">int</span> d;</span><br><span class="line">        y = x-&gt;fa, d = y-&gt;ch[<span class="number">1</span>] == x ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        x-&gt;ch[d^<span class="number">1</span>]-&gt;fa = y, y-&gt;ch[d] = x-&gt;ch[d^<span class="number">1</span>];</span><br><span class="line">        x-&gt;ch[d^<span class="number">1</span>] = y;</span><br><span class="line">        <span class="keyword">if</span> (!y-&gt;<span class="built_in">is_root</span>())</span><br><span class="line">            y-&gt;fa-&gt;ch[y-&gt;fa-&gt;ch[<span class="number">1</span>] == y] = x;</span><br><span class="line">        x-&gt;fa = y-&gt;fa, y-&gt;fa = x;</span><br><span class="line">        y-&gt;<span class="built_in">pushup</span>(), x-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deal</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!x-&gt;<span class="built_in">is_root</span>())   <span class="built_in">deal</span>(x-&gt;fa);</span><br><span class="line">        x-&gt;<span class="built_in">pushdown</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        Node *y, *z;</span><br><span class="line">        <span class="built_in">deal</span>(x);</span><br><span class="line">        <span class="keyword">while</span> (!x-&gt;<span class="built_in">is_root</span>()) &#123;</span><br><span class="line">            y = x-&gt;fa, z = y-&gt;fa;</span><br><span class="line">            <span class="keyword">if</span> (!y-&gt;<span class="built_in">is_root</span>()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (y-&gt;ch[<span class="number">0</span>] == x ^ z-&gt;ch[<span class="number">0</span>] == y)</span><br><span class="line">                    <span class="built_in">rotate</span>(x);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">rotate</span>(y);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">rotate</span>(x);</span><br><span class="line">        &#125;</span><br><span class="line">        x-&gt;<span class="built_in">pushdown</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">access</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        Node *v = EMPTY;</span><br><span class="line">        <span class="keyword">for</span> (; u != EMPTY; u = u-&gt;fa) &#123;</span><br><span class="line">            <span class="built_in">splay</span>(u);</span><br><span class="line">            u-&gt;vsize += u-&gt;ch[<span class="number">1</span>] != EMPTY ? u-&gt;ch[<span class="number">1</span>]-&gt;size : <span class="number">0</span>;</span><br><span class="line">            u-&gt;vsize -= v != EMPTY ? v-&gt;size : <span class="number">0</span>;</span><br><span class="line">            u-&gt;ch[<span class="number">1</span>] = v;</span><br><span class="line">            u-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">            v = u;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">mk_root</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">access</span>(u), <span class="built_in">splay</span>(u);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cut</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">    	<span class="built_in">access</span>(x), <span class="built_in">splay</span>(x);</span><br><span class="line">    	x-&gt;ch[<span class="number">0</span>]-&gt;fa = EMPTY;</span><br><span class="line">        x-&gt;ch[<span class="number">0</span>] = EMPTY;</span><br><span class="line">        x-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">link</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</span><br><span class="line">    	<span class="built_in">access</span>(x), <span class="built_in">splay</span>(x);</span><br><span class="line">    	<span class="built_in">access</span>(y), <span class="built_in">splay</span>(y);</span><br><span class="line">        x-&gt;fa = y;</span><br><span class="line">        y-&gt;vsize += x-&gt;size;</span><br><span class="line">        y-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">find</span><span class="params">(Node *x)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">access</span>(x), <span class="built_in">splay</span>(x);</span><br><span class="line">        <span class="keyword">for</span> (; x-&gt;ch[<span class="number">0</span>] != EMPTY; x = x-&gt;ch[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(Node *x, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">    	<span class="built_in">mk_root</span>(x);</span><br><span class="line">    	x-&gt;val = val;</span><br><span class="line">    	x-&gt;<span class="built_in">pushup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">    	<span class="built_in">mk_root</span>(u);</span><br><span class="line">    	<span class="keyword">int</span> ret = u-&gt;size;</span><br><span class="line">    	<span class="keyword">if</span> (u-&gt;ch[<span class="number">0</span>] != EMPTY)</span><br><span class="line">    		ret -= u-&gt;ch[<span class="number">0</span>]-&gt;size;</span><br><span class="line">    	<span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">same</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">find</span>(x) == <span class="built_in">find</span>(y);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;==================&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            Node *u = &amp;_mem[i];</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[%d] %d, %d %d, %d %d %d\n&quot;</span>, i, u-&gt;fa-_mem, u-&gt;ch[<span class="number">0</span>]-_mem, u-&gt;ch[<span class="number">1</span>]-_mem, u-&gt;size, u-&gt;vsize, u-&gt;val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; lct;</span><br><span class="line">LCT::Node *LCT::EMPTY, LCT::_mem[LCT::MAXN];</span><br><span class="line"><span class="keyword">int</span> LCT::bufIdx;</span><br><span class="line"></span><br><span class="line">    LCT::Node *node[LCT::MAXN];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, m;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</span><br><span class="line">        lct.<span class="built_in">init</span>();</span><br><span class="line">        <span class="keyword">int</span> cmd, u, v, w;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;w);</span><br><span class="line">            node[i] = lct.<span class="built_in">newNode</span>();</span><br><span class="line">            lct.<span class="built_in">set</span>(node[i], w);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;cmd);</span><br><span class="line">            <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;u, &amp;v);</span><br><span class="line">                lct.<span class="built_in">link</span>(node[u], node[v]);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;u);</span><br><span class="line">                lct.<span class="built_in">cut</span>(node[u]);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">3</span>) &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;u, &amp;w);</span><br><span class="line">                lct.<span class="built_in">set</span>(node[u], w);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">4</span>) &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;u);</span><br><span class="line">                <span class="keyword">int</span> p = lct.<span class="built_in">get</span>(node[u]);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, p);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;u, &amp;v);</span><br><span class="line">                <span class="keyword">int</span> f = lct.<span class="built_in">same</span>(node[u], node[v]);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, f);</span><br><span class="line">            &#125;</span><br><span class="line">            lct.<span class="built_in">debug</span>(<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-uva-12254" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/08/19/uva-12254/" class="article-date">
  <time datetime="2018-08-19T00:31:33.000Z" itemprop="datePublished">2018-08-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/19/uva-12254/">UVa 12254 - Electricity Connection</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2018/08/19/uva-12254/" data-id="ckpaivc8x006nn8vn8ka2335m" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2018/08/19/uva-12254/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Steiner-tree/">Steiner tree</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dp/">dp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sse/">sse</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/常數優化/">常數優化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/斯坦納樹/">斯坦納樹</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>給一個 <span>$8 \times 8$</span><!-- Has MathJax --> 平面圖，上面至多有八個住家，我們目標要從發電廠出發，牽電到所有的住家，拉線跨過水路的花費 <span>$pw$</span><!-- Has MathJax -->、一般陸路為 <span>$pl$</span><!-- Has MathJax -->，求最少花費。</p>
<p>經典的斯坦納樹問題，但有別於一般的平面圖，使用歐基里德距離或者曼哈頓距離作為花費函數。接著讓我們細談如何進行常數優化。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">2</span><br><span class="line">0 10</span><br><span class="line">H.W.WH..</span><br><span class="line">..W.W...</span><br><span class="line">..WGW...</span><br><span class="line">........</span><br><span class="line">........</span><br><span class="line">........</span><br><span class="line">........</span><br><span class="line">........</span><br><span class="line">0 0</span><br><span class="line">H.W.WH..</span><br><span class="line">..W.W...</span><br><span class="line">..WGW...</span><br><span class="line">........</span><br><span class="line">........</span><br><span class="line">........</span><br><span class="line">........</span><br><span class="line">........</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Case 1: 12</span><br><span class="line">Case 2: 7</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>斯坦納樹為 NP-hard 問題，因此沒有多項式解法，而要得到確切的最小化解，則必須透過動態規劃來完成。由於題目給定的範圍很小，首先將目標要連通完成的點集，壓縮成 <span>$N$</span><!-- Has MathJax --> 個位元，接著紀錄這個聯通元件的其中一個節點視為根。最後，得到狀態數為 <span>$M \cdot 2^N$</span><!-- Has MathJax -->，可以參考 <a href="http://sunmoon-template.blogspot.com/2017/04/steiner-tree-problem-in-graphs.html">《「Steiner tree problem in graphs」斯坦納樹》 －日月卦長</a>　的說明。</p>
<p>公式可以拆成兩種情況，第一種為從子集合併中著手，另一種為拓展連通元件 (替換根節點，但不改變目前已經連到的目標集合)。定義 <code>dp[s][i]</code> 為根 <code>i</code>，連通集合 <code>s</code> 的最小花費</p>
<ul>
<li><span>$dp[S][i] = \min(dp[T][j]+dp[S&minus;T][j]+\text{dist}(i, j):j \in V,T \subset S)$</span><!-- Has MathJax --></li>
<li><span>$dp[S][i] = \min(dp[S][k] + \text{dist}(S, k))$</span><!-- Has MathJax --></li>
</ul>
<p>由上述的公式，我們便可知道複雜度為 <span>$O(M \cdot 3^N)$</span><!-- Has MathJax -->。</p>
<h3 id="實作細節"><a href="#實作細節" class="headerlink" title="實作細節"></a>實作細節</h3><ul>
<li><p>對於內存布局，有兩個選擇 <code>dp[2^N][M]</code> 或者是 <code>dp[M][2^N]</code>，其中以 <code>dp[2^N][M]</code> 最為適合，在撰寫迴圈的時候，最內層的迴圈為替換根，這麼一來 cache miss 的機會就非常低。更容易透過 unroll loop 和向量化來運作。</p>
<ul>
<li>如果內存布局使用 <code>dp[M][2^N]</code>，在撰寫向量化時，需要使用 gather 相關的指令，這部分只有在 AVX2 有，並不是每一個 online judge 都支援，而 latency 也算挺高的，等到哪天 CPU 架構換了，這解法可能才會快得起來。</li>
</ul>
</li>
<li><p>當我們窮舉子集合時，發現到公式有對稱性，便可只窮舉上半部。這樣可以加速 20% 的效能。</p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, h; i &lt; (<span class="number">1</span>&lt;&lt;n); i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((i&amp;(-i)) == i)</span><br><span class="line">        h = i<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = (i<span class="number">-1</span>)&amp;i; k &gt; h; k = (k<span class="number">-1</span>)&amp;i) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">64</span>; j++)</span><br><span class="line">            dp[i][j] = <span class="built_in">min</span>(dp[i][j], dp[k][j]+dp[i^k][j]-w[j]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">relax</span>(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="基礎篇"><a href="#基礎篇" class="headerlink" title="基礎篇"></a>基礎篇</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC target(<span class="meta-string">&quot;avx&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC optimize (<span class="meta-string">&quot;O3&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> g[<span class="number">8</span>][<span class="number">16</span>], w[<span class="number">64</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> dx[] = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">-1</span>&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> dy[] = &#123;<span class="number">1</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int32_t</span> dp[<span class="number">1</span>&lt;&lt;<span class="number">8</span>][<span class="number">64</span>];</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> INF = <span class="number">0x3f3f3f3f</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">relax</span><span class="params">(<span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int8_t</span> Q[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> inq = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> Qn = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">64</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dp[s][i] != INF)</span><br><span class="line">            Q[Qn++] = i, inq |= <span class="number">1ULL</span>&lt;&lt;i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Qn; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> u = Q[i];</span><br><span class="line">        <span class="keyword">int</span> x = u&gt;&gt;<span class="number">3</span>, y = u&amp;<span class="number">7</span>;</span><br><span class="line">        inq ^= <span class="number">1ULL</span>&lt;&lt;u;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">4</span>; k++) &#123;</span><br><span class="line">            <span class="keyword">int</span> tx = x+dx[k], ty = y+dy[k];</span><br><span class="line">            <span class="keyword">if</span> (tx &lt; <span class="number">0</span> || ty &lt; <span class="number">0</span> || tx &gt;= <span class="number">8</span> || ty &gt;= <span class="number">8</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">int</span> v = tx&lt;&lt;<span class="number">3</span>|ty;</span><br><span class="line">            <span class="keyword">if</span> (dp[s][v] &gt; dp[s][u]+<span class="number">1</span>+w[v]) &#123;</span><br><span class="line">                dp[s][v] = dp[s][u]+<span class="number">1</span>+w[v];</span><br><span class="line">                <span class="keyword">if</span> (((inq&gt;&gt;v)&amp;<span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    inq |= <span class="number">1ULL</span>&lt;&lt;v;</span><br><span class="line">                    Q[Qn++] = v;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> testcase, cases = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> pl, pw;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;testcase);</span><br><span class="line">    <span class="keyword">while</span> (testcase--) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;pl, &amp;pw);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, &amp;g[i]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> n = <span class="number">0</span>, root = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> A[<span class="number">8</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">int</span> u = i&lt;&lt;<span class="number">3</span>|j;</span><br><span class="line">                <span class="keyword">if</span> (g[i][j] == <span class="string">&#x27;H&#x27;</span>)</span><br><span class="line">                    A[n++] = u, w[u] = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (g[i][j] == <span class="string">&#x27;G&#x27;</span>)</span><br><span class="line">                    w[u] = <span class="number">0</span>, root = u;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (g[i][j] == <span class="string">&#x27;W&#x27;</span>)</span><br><span class="line">                    w[u] = pw;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (g[i][j] == <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">                    w[u] = pl;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(dp, <span class="number">0x3f</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(dp));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            dp[<span class="number">1</span>&lt;&lt;i][A[i]] = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, h; i &lt; (<span class="number">1</span>&lt;&lt;n); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((i&amp;(-i)) == i)</span><br><span class="line">                h = i<span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = (i<span class="number">-1</span>)&amp;i; k &gt; h; k = (k<span class="number">-1</span>)&amp;i) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">64</span>; j++)</span><br><span class="line">                    dp[i][j] = <span class="built_in">min</span>(dp[i][j], dp[k][j]+dp[i^k][j]-w[j]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">relax</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> ret = dp[(<span class="number">1</span>&lt;&lt;n)<span class="number">-1</span>][root];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Case %d: %d\n&quot;</span>, ++cases, ret);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SSE-向量化"><a href="#SSE-向量化" class="headerlink" title="SSE 向量化"></a>SSE 向量化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC target(<span class="meta-string">&quot;avx&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC optimize (<span class="meta-string">&quot;O3&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;x86intrin.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> g[<span class="number">8</span>][<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> dx[] = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">-1</span>&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> dy[] = &#123;<span class="number">1</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int32_t</span> w[<span class="number">64</span>] __attribute__ ((<span class="built_in">aligned</span>(<span class="number">16</span>)));</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int32_t</span> dp[<span class="number">1</span>&lt;&lt;<span class="number">8</span>][<span class="number">64</span>] __attribute__ ((<span class="built_in">aligned</span>(<span class="number">16</span>)));</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> INF = <span class="number">0x3f3f3f3f</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">relax</span><span class="params">(<span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int8_t</span> Q[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> inq = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> Qn = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">64</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dp[s][i] != INF)</span><br><span class="line">            Q[Qn++] = i, inq |= <span class="number">1ULL</span>&lt;&lt;i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Qn; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> u = Q[i];</span><br><span class="line">        <span class="keyword">int</span> x = u&gt;&gt;<span class="number">3</span>, y = u&amp;<span class="number">7</span>;</span><br><span class="line">        inq ^= <span class="number">1ULL</span>&lt;&lt;u;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">4</span>; k++) &#123;</span><br><span class="line">            <span class="keyword">int</span> tx = x+dx[k], ty = y+dy[k];</span><br><span class="line">            <span class="keyword">if</span> (tx &lt; <span class="number">0</span> || ty &lt; <span class="number">0</span> || tx &gt;= <span class="number">8</span> || ty &gt;= <span class="number">8</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">int</span> v = tx&lt;&lt;<span class="number">3</span>|ty;</span><br><span class="line">            <span class="keyword">if</span> (dp[s][v] &gt; dp[s][u]+<span class="number">1</span>+w[v]) &#123;</span><br><span class="line">                dp[s][v] = dp[s][u]+<span class="number">1</span>+w[v];</span><br><span class="line">                <span class="keyword">if</span> (((inq&gt;&gt;v)&amp;<span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    inq |= <span class="number">1ULL</span>&lt;&lt;v;</span><br><span class="line">                    Q[Qn++] = v;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> testcase, cases = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> pl, pw;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;testcase);</span><br><span class="line">    <span class="keyword">while</span> (testcase--) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;pl, &amp;pw);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, &amp;g[i]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> n = <span class="number">0</span>, root = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> A[<span class="number">8</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">int</span> u = i&lt;&lt;<span class="number">3</span>|j;</span><br><span class="line">                <span class="keyword">if</span> (g[i][j] == <span class="string">&#x27;H&#x27;</span>)</span><br><span class="line">                    A[n++] = u, w[u] = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (g[i][j] == <span class="string">&#x27;G&#x27;</span>)</span><br><span class="line">                    w[u] = <span class="number">0</span>, root = u;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (g[i][j] == <span class="string">&#x27;W&#x27;</span>)</span><br><span class="line">                    w[u] = pw;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (g[i][j] == <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">                    w[u] = pl;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(dp, <span class="number">0x3f</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(dp));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            dp[<span class="number">1</span>&lt;&lt;i][A[i]] = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, h; i &lt; (<span class="number">1</span>&lt;&lt;n); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((i&amp;(-i)) == i)</span><br><span class="line">                h = i<span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = (i<span class="number">-1</span>)&amp;i; k &gt; h; k = (k<span class="number">-1</span>)&amp;i) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j+<span class="number">4</span> &lt;= <span class="number">64</span>; j += <span class="number">4</span>) &#123;</span><br><span class="line">                    __m128i mv = _mm_load_si128((__m128i*) (dp[i]+j));</span><br><span class="line">                    __m128i a = _mm_load_si128((__m128i*) (dp[k]+j));</span><br><span class="line">                    __m128i b = _mm_load_si128((__m128i*) (dp[i^k]+j));</span><br><span class="line">                    __m128i tm = _mm_add_epi32(a, b);</span><br><span class="line">                    __m128i c = _mm_load_si128((__m128i*) (w+j));</span><br><span class="line">                    __m128i tn = _mm_sub_epi32(tm, c);</span><br><span class="line">                    __m128i mn = _mm_min_epi32(mv, tn);</span><br><span class="line">                    _mm_store_si128((__m128i*) (dp[i]+j), mn);</span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment">//					dp[i][j] = min(dp[i][j], dp[k][j]+dp[i^k][j]-w[j]);</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">relax</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> ret = dp[(<span class="number">1</span>&lt;&lt;n)<span class="number">-1</span>][root];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Case %d: %d\n&quot;</span>, ++cases, ret);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AVX2-Gather"><a href="#AVX2-Gather" class="headerlink" title="AVX2 Gather"></a>AVX2 Gather</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> It doesn&#x27;t work at UVA 2018/08/13 because server CPU does not support </span></span><br><span class="line"><span class="comment"> AVX2 instruction set. Although we could pass the compiler, you still </span></span><br><span class="line"><span class="comment"> get runtime error during executing an illegal instruction.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC target(<span class="meta-string">&quot;avx&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC target(<span class="meta-string">&quot;avx2&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC optimize (<span class="meta-string">&quot;O3&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;x86intrin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;avx2intrin.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> g[<span class="number">8</span>][<span class="number">16</span>], w[<span class="number">64</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> dx[] = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">-1</span>&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> dy[] = &#123;<span class="number">1</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int32_t</span> dp[<span class="number">64</span>][<span class="number">1</span>&lt;&lt;<span class="number">8</span>] __attribute__ ((<span class="built_in">aligned</span>(<span class="number">16</span>)));</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> INF = <span class="number">0x3f3f3f3f</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">relax</span><span class="params">(<span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int8_t</span> Q[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> inq = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> Qn = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">64</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dp[i][s] != INF)</span><br><span class="line">            Q[Qn++] = i, inq |= <span class="number">1ULL</span>&lt;&lt;i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Qn; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> u = Q[i];</span><br><span class="line">        <span class="keyword">int</span> x = u&gt;&gt;<span class="number">3</span>, y = u&amp;<span class="number">7</span>;</span><br><span class="line">        inq ^= <span class="number">1ULL</span>&lt;&lt;u;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">4</span>; k++) &#123;</span><br><span class="line">            <span class="keyword">int</span> tx = x+dx[k], ty = y+dy[k];</span><br><span class="line">            <span class="keyword">if</span> (tx &lt; <span class="number">0</span> || ty &lt; <span class="number">0</span> || tx &gt;= <span class="number">8</span> || ty &gt;= <span class="number">8</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">int</span> v = tx&lt;&lt;<span class="number">3</span>|ty;</span><br><span class="line">            <span class="keyword">if</span> (dp[v][s] &gt; dp[u][s]+<span class="number">1</span>+w[v]) &#123;</span><br><span class="line">                dp[v][s] = dp[u][s]+<span class="number">1</span>+w[v];</span><br><span class="line">                <span class="keyword">if</span> (((inq&gt;&gt;v)&amp;<span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    inq |= <span class="number">1ULL</span>&lt;&lt;v;</span><br><span class="line">                    Q[Qn++] = v;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> testcase, cases = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> pl, pw;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;testcase);</span><br><span class="line">    <span class="keyword">while</span> (testcase--) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;pl, &amp;pw);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, &amp;g[i]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> n = <span class="number">0</span>, root = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> A[<span class="number">8</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">int</span> u = i&lt;&lt;<span class="number">3</span>|j;</span><br><span class="line">                <span class="keyword">if</span> (g[i][j] == <span class="string">&#x27;H&#x27;</span>)</span><br><span class="line">                    A[n++] = u, w[u] = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (g[i][j] == <span class="string">&#x27;G&#x27;</span>)</span><br><span class="line">                    w[u] = <span class="number">0</span>, root = u;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (g[i][j] == <span class="string">&#x27;W&#x27;</span>)</span><br><span class="line">                    w[u] = pw;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (g[i][j] == <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">                    w[u] = pl;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(dp, <span class="number">0x3f</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(dp));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            dp[A[i]][<span class="number">1</span>&lt;&lt;i] = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, h; i &lt; (<span class="number">1</span>&lt;&lt;n); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((i&amp;(-i)) == i)</span><br><span class="line">                h = i<span class="number">-1</span>;</span><br><span class="line">            __attribute__ ((<span class="built_in">aligned</span>(<span class="number">16</span>))) <span class="keyword">static</span> <span class="keyword">int</span> subset1[<span class="number">1</span>&lt;&lt;<span class="number">8</span>] = &#123;&#125;;</span><br><span class="line">            __attribute__ ((<span class="built_in">aligned</span>(<span class="number">16</span>))) <span class="keyword">static</span> <span class="keyword">int</span> subset2[<span class="number">1</span>&lt;&lt;<span class="number">8</span>] = &#123;&#125;;</span><br><span class="line">            <span class="keyword">int</span> sn = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = (i<span class="number">-1</span>)&amp;i; k &gt; h; k = (k<span class="number">-1</span>)&amp;i)</span><br><span class="line">                subset1[sn] = k, subset2[sn] = i^k, sn++;</span><br><span class="line">            <span class="keyword">while</span> (sn&amp;<span class="number">4</span>)</span><br><span class="line">                subset1[sn] = <span class="number">0</span>, subset2[sn] = i, sn++;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">64</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">int32_t</span> mn = dp[j][i]+w[j];</span><br><span class="line">                __m128i mv = _mm_setr_epi32(mn, mn, mn, mn);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> t = <span class="number">0</span>; t &lt;= sn; t += <span class="number">4</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> k;</span><br><span class="line">                    __m128i a = _mm_load_si128((__m128i*) subset1+t);</span><br><span class="line">                    __m128i b = _mm_load_si128((__m128i*) subset2+t);</span><br><span class="line">                    __m128i t1 = _mm_i32gather_epi32(dp[j], a, <span class="number">4</span>);</span><br><span class="line">                    __m128i t2 = _mm_i32gather_epi32(dp[j], b, <span class="number">4</span>);</span><br><span class="line">                    __m128i tm = _mm_add_epi32(t1, t2);</span><br><span class="line">                    mv = _mm_min_epi32(mv, tm);</span><br><span class="line">                &#125;</span><br><span class="line">                __attribute__ ((<span class="built_in">aligned</span>(<span class="number">16</span>))) <span class="keyword">int32_t</span> mr[<span class="number">4</span>];</span><br><span class="line">                _mm_store_si128((__m128i*) mr, mv);</span><br><span class="line">                mn = <span class="built_in">min</span>(<span class="built_in">min</span>(mr[<span class="number">0</span>], mr[<span class="number">1</span>]), <span class="built_in">min</span>(mr[<span class="number">2</span>], mr[<span class="number">3</span>]));</span><br><span class="line">                dp[j][i] = mn-w[j];</span><br><span class="line"><span class="comment">//				mn = min(mn, dp[j][k]+dp[j][i^k]-ww);</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">relax</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> ret = dp[root][(<span class="number">1</span>&lt;&lt;n)<span class="number">-1</span>];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Case %d: %d\n&quot;</span>, ++cases, ret);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-optimize-skill-sort" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/22/optimize-skill-sort/" class="article-date">
  <time datetime="2018-07-22T00:20:18.000Z" itemprop="datePublished">2018-07-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/22/optimize-skill-sort/">優化技巧 - 排序/優先隊列</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2018/07/22/optimize-skill-sort/" data-id="ckpaivc81003tn8vn4i7u583t" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2018/07/22/optimize-skill-sort/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/基數排序/">基數排序</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/堆/">堆</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="主要問題"><a href="#主要問題" class="headerlink" title="主要問題"></a>主要問題</h2><p>在算法問題中，時常結合到排序，而排序的常數也大大影響到我們整體的效能。</p>
<h2 id="基數排序降低常數"><a href="#基數排序降低常數" class="headerlink" title="基數排序降低常數"></a>基數排序降低常數</h2><p>若是一般原始型別的排序，可以透過基數排序 (radix sort)。從排序的範圍來決定是否要劃分 8-bit 一組一組。若範圍介於可容忍的 <span>$[0, v]$</span><!-- Has MathJax -->，當 <span>$v &lt; n$</span><!-- Has MathJax --> 時，直接開 <span>$n$</span><!-- Has MathJax --> 個 bucket 的方式更好。因為大多數的複雜度都大於線性 <span>$O(n)$</span><!-- Has MathJax --></p>
<h3 id="非負整數基數排序"><a href="#非負整數基數排序" class="headerlink" title="非負整數基數排序"></a>非負整數基數排序</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _radix_sort(Pt *A, <span class="keyword">int</span> n) &#123;</span><br><span class="line">    <span class="keyword">static</span> Pt _tmp[MAXN];</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CHUNK = <span class="number">256</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> C[CHUNK];</span><br><span class="line">    Pt *B = _tmp, *T;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; <span class="number">8</span>; x++) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> d = x*<span class="number">8</span>;</span><br><span class="line">        <span class="built_in">memset</span>(C, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(C));</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            C[(A[i].x&gt;&gt;d)&amp;(CHUNK<span class="number">-1</span>)]++;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; CHUNK; i++)</span><br><span class="line">            C[i] += C[i<span class="number">-1</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = n<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            B[--C[(A[i].x&gt;&gt;d)&amp;(CHUNK<span class="number">-1</span>)]] = A[i];</span><br><span class="line">        T = A, A = B, B = T;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="浮點數基數排序"><a href="#浮點數基數排序" class="headerlink" title="浮點數基數排序"></a>浮點數基數排序</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">radix_sort</span><span class="params">(Pt *A, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">int32_t</span> &amp;v = *((<span class="keyword">int32_t</span> *) &amp;(A[i].s));</span><br><span class="line">        <span class="keyword">if</span> ((v&gt;&gt;<span class="number">31</span>)&amp;<span class="number">1</span>)</span><br><span class="line">            v = ~v;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            v = v | <span class="number">0x80000000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> Pt _tmp[MAXN*<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> CHUNK = <span class="number">256</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> C[<span class="number">1</span>&lt;&lt;<span class="number">8</span>];</span><br><span class="line">    Pt *B = _tmp, *T;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; <span class="number">4</span>; x++) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> d = x*<span class="number">8</span>;</span><br><span class="line">        <span class="built_in">memset</span>(C, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(C));</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            C[((*((<span class="keyword">int32_t</span> *) &amp;(A[i].s)))&gt;&gt;d)&amp;(CHUNK<span class="number">-1</span>)]++;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; CHUNK; i++)</span><br><span class="line">            C[i] += C[i<span class="number">-1</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = n<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            B[--C[((*((<span class="keyword">int32_t</span> *) &amp;(A[i].s)))&gt;&gt;d)&amp;(CHUNK<span class="number">-1</span>)]] = A[i];</span><br><span class="line">        T = A, A = B, B = T;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">int32_t</span> &amp;v = *((<span class="keyword">int32_t</span> *) &amp;(A[i].s));</span><br><span class="line">        <span class="keyword">if</span> ((v&gt;&gt;<span class="number">31</span>)&amp;<span class="number">1</span>)</span><br><span class="line">            v = v &amp; <span class="number">0x7fffffff</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            v = ~v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="慎選內建排序"><a href="#慎選內建排序" class="headerlink" title="慎選內建排序"></a>慎選內建排序</h2><p>內建排序常見的有 <code>qsort</code>, <code>sort</code>, <code>stable_sort</code>，我不推薦使用 <code>qsort</code>，因為它在很久以前找到了一個退化情況 <a href="https://news.ycombinator.com/item?id=10476466">A Killer Adversary for Quicksort - 1995</a>，有些題目的測資會出這種特別案例，導致當年的萌新內心受創。除非只有 C 的情況，否則請避開 <code>qsort</code>。如果算法屬於調整某些元素後，再對整體進行排序，這時候 <code>sort</code> 比 <code>stable_sort</code> 慢很多。當情況非常接近已經排序的時候，就使用 <code>stable_sort</code>。</p>
<h2 id="優先隊列"><a href="#優先隊列" class="headerlink" title="優先隊列"></a>優先隊列</h2><p>使用 priority queue 的方法通常有三種 <code>set</code>, <code>priority_queue</code>, <code>heap</code>。</p>
<ul>
<li>功能最多的 <code>set</code>、次少的 <code>priority_queue</code>，最少的 <code>heap</code>。</li>
<li>效能方面則是 <code>heap</code> 最快、次著 <code>priority_queue</code>、最後 <code>set</code>。</li>
<li>代碼維護最容易的 <code>set</code>、最差的 <code>heap</code>。</li>
</ul>
<p>之前很排斥使用 <code>priority_queue</code>，原因在於撰寫 <code>operator&lt;</code> 與我的邏輯相反，因此都偏愛使用 <code>set</code>，但是效能被拉出來的時候，又必須退回類似 C 的 <code>make_heap</code>、<code>pop_heap</code> … 的接口。</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-uva-12310" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/08/uva-12310/" class="article-date">
  <time datetime="2018-07-08T07:32:38.000Z" itemprop="datePublished">2018-07-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/08/uva-12310/">UVa 12310 - Point Location</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2018/07/08/uva-12310/" data-id="ckpaivcfn00nen8vn42jret54" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2018/07/08/uva-12310/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Point-Location/">Point Location</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kd-tree/">kd-tree</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/幾何/">幾何</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/線段樹/">線段樹</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/計算幾何/">計算幾何</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>給定一平面上 <span>$n$</span><!-- Has MathJax --> 個點，接著拉 <span>$m$</span><!-- Has MathJax --> 個線段拼湊成不相交的區域，並將標記數個點位置所在的區域。接著有數個詢問「點在哪一個先前標記的同一區域內」。</p>
<p>這一問題常在幾何處理中出現，詳細可查閱 <a href="https://en.wikipedia.org/wiki/Point_location">Wikipedia - Point location</a>，在此不額外說明。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">14 16 5 5</span><br><span class="line">0 0</span><br><span class="line">30 0</span><br><span class="line">40 0</span><br><span class="line">60 0</span><br><span class="line">60 50</span><br><span class="line">0 50</span><br><span class="line">20 40</span><br><span class="line">10 10</span><br><span class="line">30 10</span><br><span class="line">30 20</span><br><span class="line">40 20</span><br><span class="line">50 30</span><br><span class="line">50 40</span><br><span class="line">30 40</span><br><span class="line">1 2</span><br><span class="line">2 9</span><br><span class="line">9 8</span><br><span class="line">8 7</span><br><span class="line">7 9</span><br><span class="line">9 10</span><br><span class="line">10 11</span><br><span class="line">11 3</span><br><span class="line">3 4</span><br><span class="line">4 5</span><br><span class="line">5 6</span><br><span class="line">6 1</span><br><span class="line">12 13</span><br><span class="line">13 14</span><br><span class="line">14 12</span><br><span class="line">2 3</span><br><span class="line">20 20</span><br><span class="line">10 20</span><br><span class="line">35 10</span><br><span class="line">45 39</span><br><span class="line">1 60</span><br><span class="line">28 11</span><br><span class="line">29 14</span><br><span class="line">34 7</span><br><span class="line">40 38</span><br><span class="line">70 1</span><br><span class="line">0 0 0 0</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td></tr></table></figure>


<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><h3 id="Previously"><a href="#Previously" class="headerlink" title="Previously"></a>Previously</h3><p>在大學修計算幾何的時候，知道這一類的題目要透過梯形剖分的方式，搭配的資料結構類似四分樹，分隔的基準是一個線段，將線段兩個端點分別拉出無限延長的垂直線，但這方法對於線段本身是垂直時，處理情況比較複雜，那時構思了好幾天沒個底，只好放棄。現在，在 Cadence 公司上班快滿一年，解決幾何操作不在少數，成長的我應該能解決這一題了吧。</p>
<h3 id="Detail"><a href="#Detail" class="headerlink" title="Detail"></a>Detail</h3><ul>
<li>相關問題 <a href="http://www.csie.ntnu.edu.tw/~u91029/Triangulation.html#4">演算法筆記 - Polygon Partition / Polygon Trapezoidalization</a></li>
</ul>
<p>題目已經保證給予的線段除了端點外，彼此之間不會相交任何一點。便可以對所有線段建立空間分割相關的資料結構，好讓我們對於解決，從詢問點出發往 <span>$y$</span><!-- Has MathJax --> 無窮遠的射線，最後會打到哪一個線段。</p>
<p>處理的流程如下：</p>
<p><img src="https://i.imgur.com/GO1qBfd.png" alt="Step 1. 輸入線段"></p>
<p><img src="https://i.imgur.com/lJNUxQd.png" alt="Step 2. 套上邊界，需要能包含所有詢問點"></p>
<p><img src="https://i.imgur.com/kRrihgw.png" alt="Step 3. 對每一個相連的線段集合，找出 $y$ 軸最高的點，放出輔助射線"></p>
<p><img src="https://i.imgur.com/LQfivUD.png" alt="Step 4. 對每一個頂點進行極角排序，進行繞行分組"></p>
<p>首先，對於幾何剖分的問題，為處理方便，都會套上一個無限大的外框，把所有頂點包在裡面。你可以透過 GeoGebra 這套數學軟體，將處理過程中的資料丟進去，方便你除錯。如果要批次輸入一大筆，請透過上方的建立按鈕 (Button)，將 command 的語法以行為單位放入，語法類似 javascript。</p>
<p>接著，我們需要對每一個線段集合的最高點放出輔助射線 (這部分已經縮減了不少，原則上對每一個頂點放出射線也可以)，這些輔助射線用來解決內部的孤立形，要把整個圖串成一個連通圖。否則，當詢問屬於內部的孤立形狀的外部時，我們會缺少足夠的資訊連到包含這個孤立形的外框。</p>
<p>最後，對每一個頂點相連的邊進行極角排序，接著才能決定相鄰的邊，而任兩個相鄰的邊所夾的區域屬於同一個集合，因此我們需要對每一個有方向的邊進行編號，將邊與邊合併到同一個集合。對於每一個詢問，只需要對詢問點放出射線找到接觸的線段，便可以知道所在的集合。</p>
<ul>
<li>若使用 KD tree，即使交替選擇 <span>$x$</span><!-- Has MathJax -->-<span>$y$</span><!-- Has MathJax --> 軸分割，也沒辦法保證樹高。因為處理的是線段，而不是點，每一次挑選的分隔軸，將會產生三個子樹，中間的子樹為與分隔軸相交的線段。在大部分的情況下，整體時間複雜度落在 <span>$O(n \log n)$</span><!-- Has MathJax -->，空間複雜度 <span>$O(n)$</span><!-- Has MathJax --> 。</li>
<li>若使用線段樹，將在 <span>$x$</span><!-- Has MathJax --> 軸上劃分，每一個線段至多被拆成 <span>$O(\log n)$</span><!-- Has MathJax --> 個，詢問射線第一個碰觸的線段時，單一詢問的時間複雜度 <span>$O(\log n)$</span><!-- Has MathJax -->，常數相較於 KD tree 多。整體時間複雜度落在 <span>$O(n \log n)$</span><!-- Has MathJax -->，空間複雜度 <span>$O(n \log n)$</span><!-- Has MathJax --> 。</li>
</ul>
<p>還有許多 spatial data structure 可以考慮，這裡只挑選兩個出來實驗，上述皆為在線算法。也可以將所有操作離線，這時候將套用掃描線算法，但對於垂直線段如何在算法中維護二元樹，目前遇到一些實作上的問題，這將在未來才能給各位參考。</p>
<h3 id="KD-tree"><a href="#KD-tree" class="headerlink" title="KD tree"></a>KD tree</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">float</span> eps = <span class="number">1e-6</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">float</span> BOX_MX = <span class="number">2000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pt</span> &#123;</span></span><br><span class="line">    <span class="keyword">float</span> x, y;</span><br><span class="line">    <span class="built_in">Pt</span>() &#123;&#125;</span><br><span class="line">    <span class="built_in">Pt</span>(<span class="keyword">float</span> a, <span class="keyword">float</span> b): <span class="built_in">x</span>(a), <span class="built_in">y</span>(b) &#123;&#125;</span><br><span class="line">    Pt <span class="keyword">operator</span>-(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123; <span class="keyword">return</span> <span class="built_in">Pt</span>(x - a.x, y - a.y); &#125;</span><br><span class="line">    Pt <span class="keyword">operator</span>+(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123; <span class="keyword">return</span> <span class="built_in">Pt</span>(x + a.x, y + a.y); &#125;</span><br><span class="line">    Pt <span class="keyword">operator</span>*(<span class="keyword">const</span> <span class="keyword">double</span> a) <span class="keyword">const</span> &#123; <span class="keyword">return</span> <span class="built_in">Pt</span>(x * a, y * a);  &#125;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">fabs</span>(x - a.x) &gt; eps)	<span class="keyword">return</span> x &lt; a.x;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">fabs</span>(y - a.y) &gt; eps)	<span class="keyword">return</span> y &lt; a.y;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">fabs</span>(x - a.x) &lt; eps &amp;&amp; <span class="built_in">fabs</span>(y - a.y) &lt; eps;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">println</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">&quot;(%lf, %lf)\n&quot;</span>, x, y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Seg</span> &#123;</span></span><br><span class="line">    Pt s, e;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">Seg</span>() &#123;&#125;</span><br><span class="line">    <span class="built_in">Seg</span>(Pt a, Pt b, <span class="keyword">int</span> i):<span class="built_in">s</span>(a), <span class="built_in">e</span>(b), <span class="built_in">i</span>(i) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">println</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">&quot;Segment((%lf, %lf), (%lf, %lf))\n&quot;</span>, s.x, s.y, e.x, e.y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">dot</span><span class="params">(Pt a, Pt b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a.x * b.x + a.y * b.y;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">cross</span><span class="params">(Pt o, Pt a, Pt b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (a.x-o.x)*(b.y-o.y)-(a.y-o.y)*(b.x-o.x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">cross2</span><span class="params">(Pt a, Pt b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a.x * b.y - a.y * b.x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">between</span><span class="params">(Pt a, Pt b, Pt c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">dot</span>(c - a, b - a) &gt;= -eps &amp;&amp; <span class="built_in">dot</span>(c - b, a - b) &gt;= -eps;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">onSeg</span><span class="params">(Pt a, Pt b, Pt c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">between</span>(a, b, c) &amp;&amp; <span class="built_in">fabs</span>(<span class="built_in">cross</span>(a, b, c)) &lt; eps;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">cmpZero</span><span class="params">(<span class="keyword">float</span> v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fabs</span>(v) &gt; eps) <span class="keyword">return</span> v &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Pt <span class="title">getIntersect</span><span class="params">(Seg a, Seg b)</span> </span>&#123;</span><br><span class="line">    Pt u = a.s - b.s;</span><br><span class="line">    <span class="keyword">double</span> t = <span class="built_in">cross2</span>(b.e - b.s, u)/<span class="built_in">cross2</span>(a.e - a.s, b.e - b.s);</span><br><span class="line">    <span class="keyword">return</span> a.s + (a.e - a.s) * t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AngleCmp</span> &#123;</span></span><br><span class="line">    Pt o;</span><br><span class="line">    <span class="built_in">AngleCmp</span>(Pt o = <span class="built_in">Pt</span>()):<span class="built_in">o</span>(o) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span> <span class="params">(<span class="keyword">const</span> pair&lt;Pt, <span class="keyword">int</span>&gt;&amp; ppa, <span class="keyword">const</span> pair&lt;Pt, <span class="keyword">int</span>&gt;&amp; ppb)</span> </span>&#123;</span><br><span class="line">        Pt pa = ppa.first, pb = ppb.first;</span><br><span class="line">        Pt p1 = pa - o, p2 = pb - o;</span><br><span class="line">        <span class="keyword">if</span> (p1.y == <span class="number">0</span> &amp;&amp; p2.y == <span class="number">0</span> &amp;&amp; p1.x * p2.x &lt;= <span class="number">0</span>) <span class="keyword">return</span> p1.x &gt; p2.x;</span><br><span class="line">        <span class="keyword">if</span> (p1.y == <span class="number">0</span> &amp;&amp; p1.x &gt;= <span class="number">0</span> &amp;&amp; p2.y != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (p2.y == <span class="number">0</span> &amp;&amp; p2.x &gt;= <span class="number">0</span> &amp;&amp; p1.y != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (p1.y * p2.y &lt; <span class="number">0</span>) <span class="keyword">return</span> p1.y &gt; p2.y;</span><br><span class="line">        <span class="keyword">double</span> c = <span class="built_in">cross2</span>(p1, p2);</span><br><span class="line">        <span class="keyword">return</span> c &gt; <span class="number">0</span> || (c == <span class="number">0</span> &amp;&amp; <span class="built_in">fabs</span>(p1.x) &lt; <span class="built_in">fabs</span>(p2.x));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Pt pts[<span class="number">10005</span>];</span><br><span class="line"><span class="keyword">static</span> Seg segs[<span class="number">30005</span>];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BSP</span> &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">60005</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXNODE = <span class="number">60005</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        <span class="keyword">float</span> lx, ly, rx, ry;</span><br><span class="line">        Node *ls, *ms, *rs;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">extend</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            lx = <span class="built_in">min</span>(lx, u-&gt;lx), ly = <span class="built_in">min</span>(ly, u-&gt;ly);</span><br><span class="line">            rx = <span class="built_in">max</span>(rx, u-&gt;rx), ry = <span class="built_in">max</span>(ry, u-&gt;ry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; nodes[MAXNODE];</span><br><span class="line">    <span class="keyword">int</span> sn[MAXNODE];</span><br><span class="line">    Seg *seg[MAXNODE];</span><br><span class="line">    <span class="keyword">float</span> axis[MAXN];</span><br><span class="line">    Node *root;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node *p = &amp;nodes[size++];</span><br><span class="line">        <span class="built_in">assert</span>(size &lt; MAXNODE);</span><br><span class="line">        p-&gt;ls = p-&gt;ms = p-&gt;rs = <span class="literal">NULL</span>;</span><br><span class="line">        sn[p-nodes] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    Node* _build(<span class="keyword">int</span> k, Seg segs[], <span class="keyword">int</span> n) &#123;</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (k == <span class="number">2</span>)</span><br><span class="line">            k = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> Lsize = <span class="number">0</span>, Msize = <span class="number">0</span>, Rsize = <span class="number">0</span>;</span><br><span class="line">        Seg *L = <span class="literal">NULL</span>, *M = <span class="literal">NULL</span>, *R = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (k == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">                axis[i&lt;&lt;<span class="number">1</span>] = segs[i].s.x, axis[i&lt;&lt;<span class="number">1</span>|<span class="number">1</span>] = segs[i].e.x;</span><br><span class="line">            <span class="built_in">nth_element</span>(axis, axis+n, axis+<span class="number">2</span>*n);</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">float</span> mval = axis[n];</span><br><span class="line">            L = segs;</span><br><span class="line">            R = std::<span class="built_in">partition</span>(segs, segs+n, [mval](<span class="keyword">const</span> Seg &amp;s) &#123;</span><br><span class="line">            	<span class="keyword">return</span> <span class="built_in">max</span>(s.s.x, s.e.x) &lt;= mval;</span><br><span class="line">        	&#125;);</span><br><span class="line">        	M = std::<span class="built_in">partition</span>(R, segs+n, [mval](<span class="keyword">const</span> Seg &amp;s) &#123;</span><br><span class="line">            	<span class="keyword">return</span> <span class="built_in">min</span>(s.s.x, s.e.x) &lt;= mval;</span><br><span class="line">        	&#125;);</span><br><span class="line">        	Msize = segs+n - M;</span><br><span class="line">        	Rsize = M - R;</span><br><span class="line">        	Lsize = R - segs;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">                axis[i&lt;&lt;<span class="number">1</span>] = segs[i].s.y, axis[i&lt;&lt;<span class="number">1</span>|<span class="number">1</span>] = segs[i].e.y;</span><br><span class="line">            <span class="built_in">nth_element</span>(axis, axis+n, axis+<span class="number">2</span>*n);</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">float</span> mval = axis[n];</span><br><span class="line">            L = segs;</span><br><span class="line">            R = std::<span class="built_in">partition</span>(segs, segs+n, [mval](<span class="keyword">const</span> Seg &amp;s) &#123;</span><br><span class="line">            	<span class="keyword">return</span> <span class="built_in">max</span>(s.s.y, s.e.y) &lt;= mval;</span><br><span class="line">        	&#125;);</span><br><span class="line">        	M = std::<span class="built_in">partition</span>(R, segs+n, [mval](<span class="keyword">const</span> Seg &amp;s) &#123;</span><br><span class="line">            	<span class="keyword">return</span> <span class="built_in">min</span>(s.s.y, s.e.y) &lt;= mval;</span><br><span class="line">        	&#125;);</span><br><span class="line">        	Msize = segs+n - M;</span><br><span class="line">        	Rsize = M - R;</span><br><span class="line">        	Lsize = R - segs;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Node *u = <span class="built_in">newNode</span>();</span><br><span class="line">        u-&gt;lx = BOX_MX, u-&gt;ly = BOX_MX; </span><br><span class="line">        u-&gt;rx = -BOX_MX, u-&gt;ry = -BOX_MX;</span><br><span class="line">        <span class="keyword">if</span> (Lsize == n || Rsize == n || Msize == n) &#123;</span><br><span class="line">            sn[u - nodes] = n, seg[u - nodes] = segs;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">                u-&gt;lx = <span class="built_in">min</span>(u-&gt;lx, <span class="built_in">min</span>(segs[i].s.x, segs[i].e.x));</span><br><span class="line">                u-&gt;rx = <span class="built_in">max</span>(u-&gt;rx, <span class="built_in">max</span>(segs[i].s.x, segs[i].e.x));</span><br><span class="line">                u-&gt;ly = <span class="built_in">min</span>(u-&gt;ly, <span class="built_in">min</span>(segs[i].s.y, segs[i].e.y));</span><br><span class="line">                u-&gt;ry = <span class="built_in">max</span>(u-&gt;ry, <span class="built_in">max</span>(segs[i].s.y, segs[i].e.y));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            u-&gt;ls = _build(k+<span class="number">1</span>, L, Lsize), u-&gt;<span class="built_in">extend</span>(u-&gt;ls);</span><br><span class="line">            u-&gt;ms = _build(k+<span class="number">1</span>, M, Msize), u-&gt;<span class="built_in">extend</span>(u-&gt;ms);</span><br><span class="line">            u-&gt;rs = _build(k+<span class="number">1</span>, R, Rsize), u-&gt;<span class="built_in">extend</span>(u-&gt;rs);</span><br><span class="line">        &#125;		</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">build_tree</span><span class="params">(Seg s[], <span class="keyword">int</span> m)</span> </span>&#123;</span><br><span class="line">        size = <span class="number">0</span>;</span><br><span class="line">        root = _build(<span class="number">0</span>, s, m);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Pt q_st, q_ed;</span><br><span class="line">    <span class="keyword">int</span> q_si;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rayhit</span><span class="params">(Seg &amp;seg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (seg.s.x == seg.e.x) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">cmpZero</span>(seg.s.x - q_st.x) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">double</span> low = <span class="built_in">min</span>(seg.s.y, seg.e.y);</span><br><span class="line">                <span class="keyword">if</span> (low &gt; q_st.y &amp;&amp; low &lt; q_ed.y) &#123;</span><br><span class="line">                    q_ed.y = low;</span><br><span class="line">                    q_si = seg.i;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">max</span>(seg.s.x, seg.e.x) &lt; q_st.x || <span class="built_in">min</span>(seg.s.x, seg.e.x) &gt; q_st.x)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        <span class="keyword">float</span> y = seg.s.y + (<span class="keyword">float</span>) (seg.e.y - seg.s.y) * (q_st.x - seg.s.x) / (seg.e.x - seg.s.x);</span><br><span class="line">        <span class="keyword">if</span> (y &gt; q_st.y &amp;&amp; y &lt; q_ed.y) &#123;</span><br><span class="line">            q_ed.y = y;</span><br><span class="line">            q_si = seg.i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">search</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        <span class="keyword">if</span> (u-&gt;lx &gt; q_st.x || u-&gt;rx &lt; q_st.x || u-&gt;ry &lt;= q_st.y || u-&gt;ly &gt;= q_ed.y)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sn[u - nodes]; i++)</span><br><span class="line">            <span class="built_in">rayhit</span>(seg[u - nodes][i]);</span><br><span class="line">        <span class="built_in">search</span>(u-&gt;ls);</span><br><span class="line">        <span class="built_in">search</span>(u-&gt;ms);</span><br><span class="line">        <span class="built_in">search</span>(u-&gt;rs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">pair&lt;<span class="keyword">int</span>, Pt&gt; <span class="title">raycast</span><span class="params">(Pt st)</span> </span>&#123;</span><br><span class="line">        q_st = st; </span><br><span class="line">        q_ed = <span class="built_in">Pt</span>(st.x, BOX_MX+<span class="number">1</span>);</span><br><span class="line">        q_si = <span class="number">-1</span>;</span><br><span class="line">        <span class="built_in">search</span>(root);</span><br><span class="line">        <span class="keyword">return</span> &#123;q_si, q_ed&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; tree;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Disjoint</span> &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">65536</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> parent[MAXN], weight[MAXN];</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (n &gt;= MAXN)</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= n; i++)</span><br><span class="line">            parent[i] = i, weight[i] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">findp</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> parent[x] == x ? x : parent[x] = <span class="built_in">findp</span>(parent[x]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">joint</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        x = <span class="built_in">findp</span>(x), y = <span class="built_in">findp</span>(y);</span><br><span class="line">        <span class="keyword">if</span> (weight[x] &gt;= weight[y])</span><br><span class="line">            parent[y] = x, weight[x] += weight[y];</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            parent[x] = y, weight[y] += weight[x];</span><br><span class="line">    &#125;	</span><br><span class="line">&#125; egroup, sgroup;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, m, p, q;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d %d %d %d&quot;</span>, &amp;n, &amp;m, &amp;p, &amp;q) == <span class="number">4</span> &amp;&amp; n) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> x, y;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;x, &amp;y);</span><br><span class="line">            pts[i] = <span class="built_in">Pt</span>(x, y);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        sgroup.<span class="built_in">init</span>(n);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> st_i, ed_i;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;st_i, &amp;ed_i);</span><br><span class="line">            st_i--, ed_i--;</span><br><span class="line">            segs[i] = <span class="built_in">Seg</span>(pts[st_i], pts[ed_i], i);</span><br><span class="line">            sgroup.<span class="built_in">joint</span>(st_i, ed_i);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        segs[m] = <span class="built_in">Seg</span>(<span class="built_in">Pt</span>(BOX_MX, BOX_MX), <span class="built_in">Pt</span>(BOX_MX, -BOX_MX), m), m++;</span><br><span class="line">        segs[m] = <span class="built_in">Seg</span>(<span class="built_in">Pt</span>(BOX_MX, -BOX_MX), <span class="built_in">Pt</span>(-BOX_MX, -BOX_MX), m), m++;</span><br><span class="line">        segs[m] = <span class="built_in">Seg</span>(<span class="built_in">Pt</span>(-BOX_MX, -BOX_MX), <span class="built_in">Pt</span>(-BOX_MX, BOX_MX), m), m++;</span><br><span class="line">        segs[m] = <span class="built_in">Seg</span>(<span class="built_in">Pt</span>(-BOX_MX, BOX_MX), <span class="built_in">Pt</span>(BOX_MX, BOX_MX), m), m++;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">static</span> map&lt;Pt, vector&lt;pair&lt;Pt, <span class="keyword">uint8_t</span>&gt;&gt;&gt; g; g.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="keyword">static</span> vector&lt;vector&lt;Pt&gt;&gt; on_seg; on_seg.<span class="built_in">clear</span>(); on_seg.<span class="built_in">resize</span>(m);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            on_seg[segs[i].i].<span class="built_in">reserve</span>(<span class="number">4</span>);</span><br><span class="line">            on_seg[segs[i].i].<span class="built_in">push_back</span>(segs[i].s);</span><br><span class="line">            on_seg[segs[i].i].<span class="built_in">push_back</span>(segs[i].e);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="comment">//		for (int i = 0; i &lt; n; i++)</span></span><br><span class="line"><span class="comment">//			pts[i].println();</span></span><br><span class="line"><span class="comment">//		for (int i = 0; i &lt; m; i++)</span></span><br><span class="line"><span class="comment">//			segs[i].println();</span></span><br><span class="line"></span><br><span class="line">        tree.<span class="built_in">build_tree</span>(segs, m);</span><br><span class="line">        &#123;</span><br><span class="line">            Pt top[<span class="number">10005</span>];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">                top[i] = pts[i];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">                <span class="keyword">int</span> gid = sgroup.<span class="built_in">findp</span>(i);</span><br><span class="line">                <span class="keyword">if</span> (top[gid].y &lt; pts[i].y)</span><br><span class="line">                    top[gid] = pts[i];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (sgroup.<span class="built_in">findp</span>(i) != i)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">auto</span> p = top[i];</span><br><span class="line">                <span class="keyword">auto</span> hit = tree.<span class="built_in">raycast</span>(p);</span><br><span class="line">                <span class="keyword">if</span> (hit.first &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    on_seg[hit.first].<span class="built_in">emplace_back</span>(hit.second);</span><br><span class="line">                    g[p].<span class="built_in">emplace_back</span>(hit.second, <span class="number">1</span>);</span><br><span class="line">                    g[hit.second].<span class="built_in">emplace_back</span>(p, <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            vector&lt;Pt&gt; &amp;a = on_seg[i];</span><br><span class="line">            <span class="built_in">sort</span>(a.<span class="built_in">begin</span>(), a.<span class="built_in">end</span>());</span><br><span class="line">            a.<span class="built_in">resize</span>(<span class="built_in">unique</span>(a.<span class="built_in">begin</span>(), a.<span class="built_in">end</span>()) - a.<span class="built_in">begin</span>());</span><br><span class="line">            <span class="keyword">auto</span> *prev = &amp;g[a[<span class="number">0</span>]];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; a.<span class="built_in">size</span>(); j++) &#123;</span><br><span class="line">                prev-&gt;<span class="built_in">emplace_back</span>(a[j], <span class="number">0</span>);</span><br><span class="line">                prev = &amp;g[a[j]];</span><br><span class="line">                prev-&gt;<span class="built_in">emplace_back</span>(a[j<span class="number">-1</span>], <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;e : g)</span><br><span class="line">            <span class="built_in">sort</span>(e.second.<span class="built_in">begin</span>(), e.second.<span class="built_in">end</span>(), <span class="built_in">AngleCmp</span>(e.first));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">static</span> map&lt;Pt, map&lt;Pt, <span class="keyword">int</span>&gt;&gt; R; R.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="keyword">int</span> Rsize = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;e : g) &#123;</span><br><span class="line">            <span class="keyword">int</span> sz = e.second.<span class="built_in">size</span>();</span><br><span class="line">            map&lt;Pt, <span class="keyword">int</span>&gt; &amp;Rg = R[e.first];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;f : e.second) &#123;</span><br><span class="line">                <span class="keyword">int</span> &amp;eid = Rg[f.first];</span><br><span class="line">                <span class="keyword">if</span> (eid == <span class="number">0</span>)</span><br><span class="line">                    eid = ++Rsize;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        egroup.<span class="built_in">init</span>(Rsize);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;e : g) &#123;</span><br><span class="line">            <span class="keyword">int</span> sz = e.second.<span class="built_in">size</span>();</span><br><span class="line">            map&lt;Pt, <span class="keyword">int</span>&gt; &amp;Rg = R[e.first];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = sz<span class="number">-1</span>, j = <span class="number">0</span>; j &lt; sz; i = j++) &#123;</span><br><span class="line">                <span class="keyword">int</span> l = R[e.second[i].first][e.first];</span><br><span class="line">                <span class="keyword">int</span> r = Rg[e.second[j].first];</span><br><span class="line">                egroup.<span class="built_in">joint</span>(l, r);</span><br><span class="line">                <span class="keyword">if</span> (e.second[i].second != <span class="number">0</span>) &#123;</span><br><span class="line">                    r = Rg[e.second[i].first];</span><br><span class="line">                    <span class="built_in">assert</span>(l &gt; <span class="number">0</span> &amp;&amp; r &gt; <span class="number">0</span>);</span><br><span class="line">                    egroup.<span class="built_in">joint</span>(l, r);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;e : g) &#123;</span><br><span class="line">            <span class="keyword">int</span> sz = e.second.<span class="built_in">size</span>();</span><br><span class="line">            <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.second[i].second == <span class="number">0</span>)</span><br><span class="line">                    e.second[n++] = e.second[i];</span><br><span class="line">            &#125;</span><br><span class="line">            e.second.<span class="built_in">resize</span>(n);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">int</span> region[<span class="number">65536</span>]; <span class="built_in">memset</span>(region, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="number">0</span>)*Rsize);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; p; i++) &#123;</span><br><span class="line">            <span class="keyword">float</span> x, y;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%f %f&quot;</span>, &amp;x, &amp;y);</span><br><span class="line">            pair&lt;<span class="keyword">int</span>, Pt&gt; hit = tree.<span class="built_in">raycast</span>(<span class="built_in">Pt</span>(x, y));</span><br><span class="line">            <span class="keyword">if</span> (hit.first &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (g.<span class="built_in">find</span>(hit.second) != g.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                <span class="keyword">auto</span> &amp;adj = g[hit.second];</span><br><span class="line">                <span class="function">AngleCmp <span class="title">cmp</span><span class="params">(hit.second)</span></span>;</span><br><span class="line">                <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">                <span class="function">pair&lt;Pt, <span class="keyword">int</span>&gt; <span class="title">q</span><span class="params">(Pt(x, y), i+<span class="number">1</span>)</span></span>;</span><br><span class="line">                pos = <span class="built_in">lower_bound</span>(adj.<span class="built_in">begin</span>(), adj.<span class="built_in">end</span>(), q, cmp) - adj.<span class="built_in">begin</span>() - <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">assert</span>(pos &gt;= <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">int</span> l = R[adj[pos].first][hit.second];</span><br><span class="line">                <span class="built_in">assert</span>(l &gt; <span class="number">0</span>);</span><br><span class="line">                l = egroup.<span class="built_in">findp</span>(l);</span><br><span class="line">                region[l] = i+<span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">auto</span> &amp;adj = on_seg[hit.first];</span><br><span class="line">                Pt lpt = adj[<span class="number">0</span>], rpt = adj[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">int</span> l;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">cmpZero</span>(<span class="built_in">cross</span>(lpt, rpt, <span class="built_in">Pt</span>(x, y))) &lt;= <span class="number">0</span>)</span><br><span class="line">                    l = R[lpt][rpt];</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    l = R[rpt][lpt];</span><br><span class="line">                <span class="built_in">assert</span>(l &gt; <span class="number">0</span>);</span><br><span class="line">                l = egroup.<span class="built_in">findp</span>(l);</span><br><span class="line">                region[l] = i+<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; q; i++) &#123;</span><br><span class="line">            <span class="keyword">float</span> x, y;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%f %f&quot;</span>, &amp;x, &amp;y);</span><br><span class="line">            pair&lt;<span class="keyword">int</span>, Pt&gt; hit = tree.<span class="built_in">raycast</span>(<span class="built_in">Pt</span>(x, y));</span><br><span class="line">            <span class="keyword">if</span> (hit.first &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;0\n&quot;</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (g.<span class="built_in">find</span>(hit.second) != g.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                <span class="keyword">auto</span> &amp;adj = g[hit.second];</span><br><span class="line">                <span class="function">AngleCmp <span class="title">cmp</span><span class="params">(hit.second)</span></span>;</span><br><span class="line">                <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">                <span class="function">pair&lt;Pt, <span class="keyword">int</span>&gt; <span class="title">q</span><span class="params">(Pt(x, y), i+<span class="number">1</span>)</span></span>;</span><br><span class="line">                pos = <span class="built_in">lower_bound</span>(adj.<span class="built_in">begin</span>(), adj.<span class="built_in">end</span>(), q, cmp) - adj.<span class="built_in">begin</span>() - <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">assert</span>(pos &gt;= <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">int</span> l = R[adj[pos].first][hit.second];</span><br><span class="line">                <span class="built_in">assert</span>(l &gt; <span class="number">0</span>);</span><br><span class="line">                l = egroup.<span class="built_in">findp</span>(l);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, region[l]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">auto</span> &amp;adj = on_seg[hit.first];</span><br><span class="line">                Pt lpt = adj[<span class="number">0</span>], rpt = adj[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">int</span> l;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">cmpZero</span>(<span class="built_in">cross</span>(lpt, rpt, <span class="built_in">Pt</span>(x, y))) &lt;= <span class="number">0</span>)</span><br><span class="line">                    l = R[lpt][rpt];</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    l = R[rpt][lpt];</span><br><span class="line">                <span class="built_in">assert</span>(l &gt; <span class="number">0</span>);</span><br><span class="line">                l = egroup.<span class="built_in">findp</span>(l);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, region[l]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="線段樹"><a href="#線段樹" class="headerlink" title="線段樹"></a>線段樹</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> eps = <span class="number">1e-8</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> BOX_MX = (<span class="number">3000000</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> AUXID = <span class="number">200000</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pt</span> &#123;</span></span><br><span class="line">    <span class="keyword">double</span> x, y;</span><br><span class="line">    <span class="built_in">Pt</span>(<span class="keyword">double</span> a = <span class="number">0</span>, <span class="keyword">double</span> b = <span class="number">0</span>): <span class="built_in">x</span>(a), <span class="built_in">y</span>(b) &#123;&#125;</span><br><span class="line">    Pt <span class="keyword">operator</span>-(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123; <span class="keyword">return</span> <span class="built_in">Pt</span>(x - a.x, y - a.y); &#125;</span><br><span class="line">    Pt <span class="keyword">operator</span>+(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123; <span class="keyword">return</span> <span class="built_in">Pt</span>(x + a.x, y + a.y); &#125;</span><br><span class="line">    Pt <span class="keyword">operator</span>*(<span class="keyword">const</span> <span class="keyword">double</span> a) <span class="keyword">const</span> &#123; <span class="keyword">return</span> <span class="built_in">Pt</span>(x * a, y * a);  &#125;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">fabs</span>(x - a.x) &gt; eps)	<span class="keyword">return</span> x &lt; a.x;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">fabs</span>(y - a.y) &gt; eps)	<span class="keyword">return</span> y &lt; a.y;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">fabs</span>(x - a.x) &lt; eps &amp;&amp; <span class="built_in">fabs</span>(y - a.y) &lt; eps;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">println</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">&quot;(%lf, %lf)\n&quot;</span>, x, y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Seg</span> &#123;</span></span><br><span class="line">    Pt s, e;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">Seg</span>() &#123;&#125;</span><br><span class="line">    <span class="built_in">Seg</span>(Pt a, Pt b, <span class="keyword">int</span> i):<span class="built_in">s</span>(a), <span class="built_in">e</span>(b), <span class="built_in">i</span>(i) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">println</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">&quot;Segment((%lf, %lf), (%lf, %lf))\n&quot;</span>, s.x, s.y, e.x, e.y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">dot</span><span class="params">(Pt a, Pt b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a.x * b.x + a.y * b.y;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">cross</span><span class="params">(Pt o, Pt a, Pt b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (a.x-o.x)*(b.y-o.y)-(a.y-o.y)*(b.x-o.x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">cross2</span><span class="params">(Pt a, Pt b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a.x * b.y - a.y * b.x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">between</span><span class="params">(Pt a, Pt b, Pt c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">dot</span>(c - a, b - a) &gt;= -eps &amp;&amp; <span class="built_in">dot</span>(c - b, a - b) &gt;= -eps;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">onSeg</span><span class="params">(Pt a, Pt b, Pt c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">between</span>(a, b, c) &amp;&amp; <span class="built_in">fabs</span>(<span class="built_in">cross</span>(a, b, c)) &lt; eps;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">cmpZero</span><span class="params">(<span class="keyword">double</span> v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fabs</span>(v) &gt; eps) <span class="keyword">return</span> v &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Pt <span class="title">getIntersect</span><span class="params">(Seg a, Seg b)</span> </span>&#123;</span><br><span class="line">    Pt u = a.s - b.s;</span><br><span class="line">    <span class="keyword">double</span> t = <span class="built_in">cross2</span>(b.e - b.s, u)/<span class="built_in">cross2</span>(a.e - a.s, b.e - b.s);</span><br><span class="line">    <span class="keyword">return</span> a.s + (a.e - a.s) * t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AngleCmp</span> &#123;</span></span><br><span class="line">    Pt o;</span><br><span class="line">    <span class="built_in">AngleCmp</span>(Pt o = <span class="built_in">Pt</span>()):<span class="built_in">o</span>(o) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span> <span class="params">(<span class="keyword">const</span> pair&lt;Pt, <span class="keyword">int</span>&gt;&amp; ppa, <span class="keyword">const</span> pair&lt;Pt, <span class="keyword">int</span>&gt;&amp; ppb)</span> </span>&#123;</span><br><span class="line">        Pt pa = ppa.first, pb = ppb.first;</span><br><span class="line">        Pt p1 = pa - o, p2 = pb - o;</span><br><span class="line">        <span class="keyword">if</span> (p1.y == <span class="number">0</span> &amp;&amp; p2.y == <span class="number">0</span> &amp;&amp; p1.x * p2.x &lt;= <span class="number">0</span>) <span class="keyword">return</span> p1.x &gt; p2.x;</span><br><span class="line">        <span class="keyword">if</span> (p1.y == <span class="number">0</span> &amp;&amp; p1.x &gt;= <span class="number">0</span> &amp;&amp; p2.y != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (p2.y == <span class="number">0</span> &amp;&amp; p2.x &gt;= <span class="number">0</span> &amp;&amp; p1.y != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (p1.y * p2.y &lt; <span class="number">0</span>) <span class="keyword">return</span> p1.y &gt; p2.y;</span><br><span class="line">        <span class="keyword">double</span> c = <span class="built_in">cross2</span>(p1, p2);</span><br><span class="line">        <span class="keyword">return</span> c &gt; <span class="number">0</span> || (c == <span class="number">0</span> &amp;&amp; <span class="built_in">fabs</span>(p1.x) &lt; <span class="built_in">fabs</span>(p2.x));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Pt pts[<span class="number">10005</span>];</span><br><span class="line"><span class="keyword">static</span> Seg segs[<span class="number">30005</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">double</span> <span class="title">interpolate</span><span class="params">(<span class="keyword">const</span> Pt&amp; p1, <span class="keyword">const</span> Pt&amp; p2, <span class="keyword">double</span>&amp; x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">cmpZero</span>(p1.x - p2.x) == <span class="number">0</span>) <span class="keyword">return</span> <span class="built_in">min</span>(p1.y, p2.y);</span><br><span class="line">    <span class="keyword">return</span> p1.y + (<span class="keyword">double</span>)(p2.y - p1.y) / (p2.x - p1.x) * (x - p1.x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CMP</span> &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">double</span> x;	    </span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span> <span class="params">(<span class="keyword">const</span> Seg &amp;i, <span class="keyword">const</span> Seg &amp;j)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">double</span> l = <span class="built_in">interpolate</span>(i.s, i.e, x);</span><br><span class="line">    	<span class="keyword">double</span> r = <span class="built_in">interpolate</span>(j.s, j.e, x);</span><br><span class="line">        <span class="keyword">return</span> l &lt; r;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">double</span> CMP::x;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BSP</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        <span class="keyword">double</span> ly, ry;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            ly = BOX_MX, ry = -BOX_MX;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">extend</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            ly = <span class="built_in">min</span>(ly, u-&gt;ly);</span><br><span class="line">            ry = <span class="built_in">max</span>(ry, u-&gt;ry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; bbox[<span class="number">262144</span>];</span><br><span class="line">    vector&lt;<span class="keyword">double</span>&gt; x;</span><br><span class="line">    set&lt;Seg, CMP&gt; tree[<span class="number">524288</span>];</span><br><span class="line">    Seg segs[<span class="number">262144</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        tree[k].<span class="built_in">clear</span>();</span><br><span class="line">        bbox[k].<span class="built_in">init</span>();</span><br><span class="line">        <span class="keyword">if</span> (l+<span class="number">1</span> &gt;= r)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</span><br><span class="line">        <span class="built_in">clear</span>(k&lt;&lt;<span class="number">1</span>, l, m);</span><br><span class="line">        <span class="built_in">clear</span>(k&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, m, r);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(Seg &amp;s, <span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (s.s.x &lt;= x[l] &amp;&amp; x[r] &lt;= s.e.x) &#123;</span><br><span class="line">            CMP::x = (x[l] + x[r])/<span class="number">2</span>;</span><br><span class="line">            tree[k].<span class="built_in">insert</span>(s);</span><br><span class="line">            <span class="keyword">double</span> ly = <span class="built_in">interpolate</span>(s.s, s.e, x[l]);</span><br><span class="line">            <span class="keyword">double</span> ry = <span class="built_in">interpolate</span>(s.s, s.e, x[r]);</span><br><span class="line">            bbox[k].ly = <span class="built_in">min</span>(bbox[k].ly, <span class="built_in">min</span>(ly, ry));</span><br><span class="line">            bbox[k].ry = <span class="built_in">max</span>(bbox[k].ry, <span class="built_in">max</span>(ly, ry));</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (l+<span class="number">1</span> &gt;= r)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (s.s.x &lt;= x[m]) &#123;</span><br><span class="line">            <span class="built_in">insert</span>(s, k&lt;&lt;<span class="number">1</span>, l, m);</span><br><span class="line">            bbox[k].<span class="built_in">extend</span>(&amp;bbox[k&lt;&lt;<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (s.e.x &gt; x[m]) &#123;</span><br><span class="line">            <span class="built_in">insert</span>(s, k&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, m, r);</span><br><span class="line">            bbox[k].<span class="built_in">extend</span>(&amp;bbox[k&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">build_tree</span><span class="params">(Seg s[], <span class="keyword">int</span> m)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(segs, s, <span class="built_in"><span class="keyword">sizeof</span></span>(segs[<span class="number">0</span>])*m);</span><br><span class="line">        </span><br><span class="line">        x.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++)</span><br><span class="line">            x.<span class="built_in">push_back</span>(segs[i].s.x), x.<span class="built_in">push_back</span>(segs[i].e.x);</span><br><span class="line">        <span class="built_in">sort</span>(x.<span class="built_in">begin</span>(), x.<span class="built_in">end</span>());</span><br><span class="line">        x.<span class="built_in">resize</span>(<span class="built_in">unique</span>(x.<span class="built_in">begin</span>(), x.<span class="built_in">end</span>()) - x.<span class="built_in">begin</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">clear</span>(<span class="number">1</span>, <span class="number">0</span>, x.<span class="built_in">size</span>()<span class="number">-1</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (segs[i].s.x &gt; segs[i].e.x)</span><br><span class="line">                <span class="built_in">swap</span>(segs[i].s, segs[i].e);</span><br><span class="line">            <span class="keyword">if</span> (segs[i].s.x &lt; segs[i].e.x)</span><br><span class="line">                <span class="built_in">insert</span>(segs[i], <span class="number">1</span>, <span class="number">0</span>, x.<span class="built_in">size</span>()<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Pt q_st, q_ed;</span><br><span class="line">    <span class="keyword">int</span> q_si;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">search</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bbox[k].ly &gt;= q_ed.y || bbox[k].ry &lt;= q_st.y)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        <span class="keyword">if</span> (x[l] &lt;= q_st.x &amp;&amp; q_st.x &lt;= x[r]) &#123;</span><br><span class="line">            CMP::x = q_st.x;</span><br><span class="line">            <span class="keyword">auto</span> it = tree[k].<span class="built_in">upper_bound</span>(<span class="built_in">Seg</span>(q_st, q_st, <span class="number">0</span>));</span><br><span class="line">            <span class="keyword">while</span> (it != tree[k].<span class="built_in">end</span>()) &#123;</span><br><span class="line">                <span class="keyword">double</span> y = <span class="built_in">interpolate</span>(it-&gt;s, it-&gt;e, CMP::x);</span><br><span class="line">                <span class="keyword">if</span> (y &gt; q_st.y) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (y &lt; q_ed.y) &#123;</span><br><span class="line">                        q_ed.y = y;</span><br><span class="line">                        q_si = it-&gt;i;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                it++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (l+<span class="number">1</span> &gt;= r)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (q_st.x &lt;= x[m])</span><br><span class="line">            <span class="built_in">search</span>(k&lt;&lt;<span class="number">1</span>, l, m);</span><br><span class="line">        <span class="keyword">if</span> (q_st.x &gt;= x[m])</span><br><span class="line">            <span class="built_in">search</span>(k&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, m, r);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">pair&lt;<span class="keyword">int</span>, Pt&gt; <span class="title">raycast</span><span class="params">(Pt st)</span> </span>&#123;</span><br><span class="line">        q_st = st; </span><br><span class="line">        q_ed = <span class="built_in">Pt</span>(st.x, BOX_MX+<span class="number">1</span>);</span><br><span class="line">        q_si = <span class="number">-1</span>;</span><br><span class="line">        <span class="built_in">search</span>(<span class="number">1</span>, <span class="number">0</span>, x.<span class="built_in">size</span>()<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">return</span> &#123;q_si, q_ed&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; tree;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Disjoint</span> &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">65536</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> parent[MAXN], weight[MAXN];</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (n &gt;= MAXN)</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= n; i++)</span><br><span class="line">            parent[i] = i, weight[i] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">findp</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> parent[x] == x ? x : parent[x] = <span class="built_in">findp</span>(parent[x]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">joint</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        x = <span class="built_in">findp</span>(x), y = <span class="built_in">findp</span>(y);</span><br><span class="line">        <span class="keyword">if</span> (weight[x] &gt;= weight[y])</span><br><span class="line">            parent[y] = x, weight[x] += weight[y];</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            parent[x] = y, weight[y] += weight[x];</span><br><span class="line">    &#125;	</span><br><span class="line">&#125; egroup, sgroup;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, m, p, q;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d %d %d %d&quot;</span>, &amp;n, &amp;m, &amp;p, &amp;q) == <span class="number">4</span> &amp;&amp; n) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> x, y;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;x, &amp;y);</span><br><span class="line">            pts[i] = <span class="built_in">Pt</span>(x, y);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        sgroup.<span class="built_in">init</span>(n);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> st_i, ed_i;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;st_i, &amp;ed_i);</span><br><span class="line">            st_i--, ed_i--;</span><br><span class="line">            segs[i] = <span class="built_in">Seg</span>(pts[st_i], pts[ed_i], i);</span><br><span class="line">            sgroup.<span class="built_in">joint</span>(st_i, ed_i);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        segs[m] = <span class="built_in">Seg</span>(<span class="built_in">Pt</span>(BOX_MX, BOX_MX), <span class="built_in">Pt</span>(BOX_MX, -BOX_MX), m), m++;</span><br><span class="line">        segs[m] = <span class="built_in">Seg</span>(<span class="built_in">Pt</span>(BOX_MX, -BOX_MX), <span class="built_in">Pt</span>(-BOX_MX, -BOX_MX), m), m++;</span><br><span class="line">        segs[m] = <span class="built_in">Seg</span>(<span class="built_in">Pt</span>(-BOX_MX, -BOX_MX), <span class="built_in">Pt</span>(-BOX_MX, BOX_MX), m), m++;</span><br><span class="line">        segs[m] = <span class="built_in">Seg</span>(<span class="built_in">Pt</span>(-BOX_MX, BOX_MX), <span class="built_in">Pt</span>(BOX_MX, BOX_MX), m), m++;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">static</span> map&lt;Pt, vector&lt;pair&lt;Pt, <span class="keyword">uint8_t</span>&gt;&gt;&gt; g; g.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="keyword">static</span> vector&lt;vector&lt;Pt&gt;&gt; on_seg; on_seg.<span class="built_in">clear</span>(); on_seg.<span class="built_in">resize</span>(m);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            on_seg[segs[i].i].<span class="built_in">reserve</span>(<span class="number">4</span>);</span><br><span class="line">            on_seg[segs[i].i].<span class="built_in">push_back</span>(segs[i].s);</span><br><span class="line">            on_seg[segs[i].i].<span class="built_in">push_back</span>(segs[i].e);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="comment">//		for (int i = 0; i &lt; n; i++)</span></span><br><span class="line"><span class="comment">//			pts[i].println();</span></span><br><span class="line"><span class="comment">//		for (int i = 0; i &lt; m; i++)</span></span><br><span class="line"><span class="comment">//			segs[i].println();</span></span><br><span class="line"></span><br><span class="line">        tree.<span class="built_in">build_tree</span>(segs, m);</span><br><span class="line">        &#123;</span><br><span class="line">            Pt top[<span class="number">10005</span>];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">                top[i] = pts[i];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">                <span class="keyword">int</span> gid = sgroup.<span class="built_in">findp</span>(i);</span><br><span class="line">                <span class="keyword">if</span> (top[gid].y &lt; pts[i].y)</span><br><span class="line">                    top[gid] = pts[i];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (sgroup.<span class="built_in">findp</span>(i) != i)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">auto</span> p = top[i];</span><br><span class="line">                <span class="keyword">auto</span> hit = tree.<span class="built_in">raycast</span>(p);</span><br><span class="line">                <span class="keyword">if</span> (hit.first &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    on_seg[hit.first].<span class="built_in">emplace_back</span>(hit.second);</span><br><span class="line">                    g[p].<span class="built_in">emplace_back</span>(hit.second, <span class="number">1</span>);</span><br><span class="line">                    g[hit.second].<span class="built_in">emplace_back</span>(p, <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            vector&lt;Pt&gt; &amp;a = on_seg[i];</span><br><span class="line">            <span class="built_in">sort</span>(a.<span class="built_in">begin</span>(), a.<span class="built_in">end</span>());</span><br><span class="line">            a.<span class="built_in">resize</span>(<span class="built_in">unique</span>(a.<span class="built_in">begin</span>(), a.<span class="built_in">end</span>()) - a.<span class="built_in">begin</span>());</span><br><span class="line">            <span class="keyword">auto</span> *prev = &amp;g[a[<span class="number">0</span>]];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; a.<span class="built_in">size</span>(); j++) &#123;</span><br><span class="line">                prev-&gt;<span class="built_in">emplace_back</span>(a[j], <span class="number">0</span>);</span><br><span class="line">                prev = &amp;g[a[j]];</span><br><span class="line">                prev-&gt;<span class="built_in">emplace_back</span>(a[j<span class="number">-1</span>], <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;e : g)</span><br><span class="line">            <span class="built_in">sort</span>(e.second.<span class="built_in">begin</span>(), e.second.<span class="built_in">end</span>(), <span class="built_in">AngleCmp</span>(e.first));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">static</span> map&lt;Pt, map&lt;Pt, <span class="keyword">int</span>&gt;&gt; R; R.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="keyword">int</span> Rsize = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;e : g) &#123;</span><br><span class="line">            <span class="keyword">int</span> sz = e.second.<span class="built_in">size</span>();</span><br><span class="line">            map&lt;Pt, <span class="keyword">int</span>&gt; &amp;Rg = R[e.first];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;f : e.second) &#123;</span><br><span class="line">                <span class="keyword">int</span> &amp;eid = Rg[f.first];</span><br><span class="line">                <span class="keyword">if</span> (eid == <span class="number">0</span>)</span><br><span class="line">                    eid = ++Rsize;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        egroup.<span class="built_in">init</span>(Rsize);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;e : g) &#123;</span><br><span class="line">            <span class="keyword">int</span> sz = e.second.<span class="built_in">size</span>();</span><br><span class="line">            map&lt;Pt, <span class="keyword">int</span>&gt; &amp;Rg = R[e.first];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = sz<span class="number">-1</span>, j = <span class="number">0</span>; j &lt; sz; i = j++) &#123;</span><br><span class="line">                <span class="keyword">int</span> l = R[e.second[i].first][e.first];</span><br><span class="line">                <span class="keyword">int</span> r = Rg[e.second[j].first];</span><br><span class="line">                egroup.<span class="built_in">joint</span>(l, r);</span><br><span class="line">                <span class="keyword">if</span> (e.second[i].second != <span class="number">0</span>) &#123;</span><br><span class="line">                    r = Rg[e.second[i].first];</span><br><span class="line">                    <span class="built_in">assert</span>(l &gt; <span class="number">0</span> &amp;&amp; r &gt; <span class="number">0</span>);</span><br><span class="line">                    egroup.<span class="built_in">joint</span>(l, r);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;e : g) &#123;</span><br><span class="line">            <span class="keyword">int</span> sz = e.second.<span class="built_in">size</span>();</span><br><span class="line">            <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.second[i].second == <span class="number">0</span>)</span><br><span class="line">                    e.second[n++] = e.second[i];</span><br><span class="line">            &#125;</span><br><span class="line">            e.second.<span class="built_in">resize</span>(n);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">int</span> region[<span class="number">65536</span>]; <span class="built_in">memset</span>(region, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="number">0</span>)*Rsize);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; p; i++) &#123;</span><br><span class="line">            <span class="keyword">float</span> x, y;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%f %f&quot;</span>, &amp;x, &amp;y);</span><br><span class="line">            pair&lt;<span class="keyword">int</span>, Pt&gt; hit = tree.<span class="built_in">raycast</span>(<span class="built_in">Pt</span>(x, y));</span><br><span class="line">            <span class="keyword">if</span> (hit.first &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (g.<span class="built_in">find</span>(hit.second) != g.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                <span class="keyword">auto</span> &amp;adj = g[hit.second];</span><br><span class="line">                <span class="function">AngleCmp <span class="title">cmp</span><span class="params">(hit.second)</span></span>;</span><br><span class="line">                <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">                <span class="function">pair&lt;Pt, <span class="keyword">int</span>&gt; <span class="title">q</span><span class="params">(Pt(x, y), i+<span class="number">1</span>)</span></span>;</span><br><span class="line">                pos = <span class="built_in">lower_bound</span>(adj.<span class="built_in">begin</span>(), adj.<span class="built_in">end</span>(), q, cmp) - adj.<span class="built_in">begin</span>() - <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">assert</span>(pos &gt;= <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">int</span> l = R[adj[pos].first][hit.second];</span><br><span class="line">                <span class="built_in">assert</span>(l &gt; <span class="number">0</span>);</span><br><span class="line">                l = egroup.<span class="built_in">findp</span>(l);</span><br><span class="line">                region[l] = i+<span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">auto</span> &amp;adj = on_seg[hit.first];</span><br><span class="line">                Pt lpt = adj[<span class="number">0</span>], rpt = adj[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">int</span> l;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">cmpZero</span>(<span class="built_in">cross</span>(lpt, rpt, <span class="built_in">Pt</span>(x, y))) &lt;= <span class="number">0</span>)</span><br><span class="line">                    l = R[lpt][rpt];</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    l = R[rpt][lpt];</span><br><span class="line">                <span class="built_in">assert</span>(l &gt; <span class="number">0</span>);</span><br><span class="line">                l = egroup.<span class="built_in">findp</span>(l);</span><br><span class="line">                region[l] = i+<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; q; i++) &#123;</span><br><span class="line">            <span class="keyword">float</span> x, y;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%f %f&quot;</span>, &amp;x, &amp;y);</span><br><span class="line">            pair&lt;<span class="keyword">int</span>, Pt&gt; hit = tree.<span class="built_in">raycast</span>(<span class="built_in">Pt</span>(x, y));</span><br><span class="line">            <span class="keyword">if</span> (hit.first &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;0\n&quot;</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (g.<span class="built_in">find</span>(hit.second) != g.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                <span class="keyword">auto</span> &amp;adj = g[hit.second];</span><br><span class="line">                <span class="function">AngleCmp <span class="title">cmp</span><span class="params">(hit.second)</span></span>;</span><br><span class="line">                <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">                <span class="function">pair&lt;Pt, <span class="keyword">int</span>&gt; <span class="title">q</span><span class="params">(Pt(x, y), i+<span class="number">1</span>)</span></span>;</span><br><span class="line">                pos = <span class="built_in">lower_bound</span>(adj.<span class="built_in">begin</span>(), adj.<span class="built_in">end</span>(), q, cmp) - adj.<span class="built_in">begin</span>() - <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">assert</span>(pos &gt;= <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">int</span> l = R[adj[pos].first][hit.second];</span><br><span class="line">                <span class="built_in">assert</span>(l &gt; <span class="number">0</span>);</span><br><span class="line">                l = egroup.<span class="built_in">findp</span>(l);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, region[l]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">auto</span> &amp;adj = on_seg[hit.first];</span><br><span class="line">                Pt lpt = adj[<span class="number">0</span>], rpt = adj[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">int</span> l;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">cmpZero</span>(<span class="built_in">cross</span>(lpt, rpt, <span class="built_in">Pt</span>(x, y))) &lt;= <span class="number">0</span>)</span><br><span class="line">                    l = R[lpt][rpt];</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    l = R[rpt][lpt];</span><br><span class="line">                <span class="built_in">assert</span>(l &gt; <span class="number">0</span>);</span><br><span class="line">                l = egroup.<span class="built_in">findp</span>(l);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, region[l]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-uva-13154" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/28/uva-13154/" class="article-date">
  <time datetime="2017-04-28T11:40:58.000Z" itemprop="datePublished">2017-04-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/28/uva-13154/">UVa 13154 - Extreme XOR Sum</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/04/28/uva-13154/" data-id="ckpaivc9f008jn8vn81nj2zrp" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/04/28/uva-13154/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/二項係數/">二項係數</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化輸入/">優化輸入</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/塊狀表/">塊狀表</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>給一長度為 <span>$N$</span><!-- Has MathJax --> 的整數序列，詢問任意區間的極端異或和 Extreme XOR Sum。</p>
<p>定義 Extreme XOR Sum 為一系列操作的最後一個值</p>
<ul>
<li>當長度 <span>$n&gt;1$</span><!-- Has MathJax --> 時，將陣列縮小為 <span>$n-1$</span><!-- Has MathJax --></li>
<li>對 <span>$[a_0, a_1, a_2, \cdots, a_{n-1}]$</span><!-- Has MathJax -->，每一個元素與後一個元素運行互斥或，將會被轉換成 <span>$[a_0 \oplus a_1, a_1\oplus a_2, a_2 \oplus  a_3, \cdots, a_{n-2}\oplus a_{n-1}]$</span><!-- Has MathJax --></li>
<li>直到只剩下一個元素，即為 Extreme XOR Sum</li>
</ul>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">5</span><br><span class="line">1  4  6  7  8</span><br><span class="line">3</span><br><span class="line">0  0</span><br><span class="line">0  1</span><br><span class="line">2  4</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Case 1:</span><br><span class="line">1</span><br><span class="line">5</span><br><span class="line">14</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>這題詢問次數非常多，一般運行將對每一個詢問達到 <span>$O(N)$</span><!-- Has MathJax --> 的複雜度，這很容易得到 TLE。從大多的數據結構，如線段樹、塊狀表 … 等，他們提供高效率的查找效能，但也必須符合某些條件才能使用。因此，在此題若要符合結合律將變得相當困難。</p>
<h3 id="觀察"><a href="#觀察" class="headerlink" title="觀察"></a>觀察</h3><p>假設要計算陣列 <span>$[1,  4,  6,  7,  8]$</span><!-- Has MathJax --> 的值時</p>
<ul>
<li>第一步，<span>$[1 \oplus 4,  4 \oplus 6,  6 \oplus 7,  7 \oplus 8]$</span><!-- Has MathJax --></li>
<li>第二步，<span>$[1 \oplus 4 \oplus 4 \oplus 6,  \cdots]$</span><!-- Has MathJax --></li>
<li>如此類推下去，XOR 有結合律，我們發現到各別使用了 1 次 <span>$a_0$</span><!-- Has MathJax -->、4 次 <span>$a_1$</span><!-- Has MathJax -->、6 次 <span>$a_2$</span><!-- Has MathJax -->、4 次 <span>$a_3$</span><!-- Has MathJax --> 和 1 次 <span>$a_4$</span><!-- Has MathJax --></li>
</ul>
<p>對於不同的長度，我們發現到是二項係數的配對情況。由於偶數次的 XOR 會互消，只需要計算出現奇數次的即可，因此我們列出二項次數模二的情況，進而得到 Sierpinski triangle/Sierpinski sieve。即使知道 Sierpinski sieve 是二項係數模二的結果，我們仍不知道要怎麼套用結合律達到剖分加速的條件。</p>
<p>二項係數的公式如下</p>
<span>$$\begin{align*}
\binom{n}{m} &amp;= \binom{n-1}{m-1} + \binom{n-1}{m} \\
&Tab;&Tab;&Tab;&amp;= \frac{n!}{m!(n-m)!}
\end{align*}$$</span><!-- Has MathJax -->

<p>階層運算在數學運算上的性質並不多，逼得我們只好往碎形上觀察，以下列出前幾項的結果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">1 1</span><br><span class="line">1 0 1</span><br><span class="line">1 1 1 1</span><br><span class="line">1 0 0 0 1</span><br><span class="line">1 1 0 0 1 1</span><br><span class="line">1 0 1 0 1 0 1</span><br><span class="line">1 1 1 1 1 1 1 1</span><br><span class="line">1 0 0 0 0 0 0 0 1</span><br><span class="line">1 1 0 0 0 0 0 0 1 1</span><br><span class="line">1 0 1 0 0 0 0 0 1 0 1</span><br><span class="line">1 1 1 1 0 0 0 0 1 1 1 1</span><br><span class="line">1 0 0 0 1 0 0 0 1 0 0 0 1</span><br><span class="line">1 1 0 0 1 1 0 0 1 1 0 0 1 1</span><br><span class="line">1 0 1 0 1 0 1 0 1 0 1 0 1 0 1</span><br><span class="line">1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span><br></pre></td></tr></table></figure>

<p>發現它是一個很有趣的碎形，每個三角形大小都是以二的冪次的。我們按照 <span>$2^3 = 8$</span><!-- Has MathJax --> 切割一下上圖，並且把右邊斜的補上 0 得到下圖。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">1 1</span><br><span class="line">1 0 1</span><br><span class="line">1 1 1 1</span><br><span class="line">1 0 0 0 1</span><br><span class="line">1 1 0 0 1 1</span><br><span class="line">1 0 1 0 1 0 1</span><br><span class="line">1 1 1 1 1 1 1 1</span><br><span class="line">^---------------</span><br><span class="line">1 0 0 0 0 0 0 0 |1 0 0 0 0 0 0 0</span><br><span class="line">1 1 0 0 0 0 0 0 |1 1 0 0 0 0 0 0</span><br><span class="line">1 0 1 0 0 0 0 0 |1 0 1 0 0 0 0 0</span><br><span class="line">1 1 1 1 0 0 0 0 |1 1 1 1 0 0 0 0</span><br><span class="line">1 0 0 0 1 0 0 0 |1 0 0 0 1 0 0 0</span><br><span class="line">1 1 0 0 1 1 0 0 |1 1 0 0 1 1 0 0</span><br><span class="line">1 0 1 0 1 0 1 0 |1 0 1 0 1 0 1 0</span><br><span class="line">1 1 1 1 1 1 1 1 |1 1 1 1 1 1 1 1</span><br><span class="line">^----------------^--------------</span><br><span class="line">1 0 0 0 0 0 0 0 |0 0 0 0 0 0 0 0 |1 0 0 0 0 0 0 0</span><br><span class="line">1 1 0 0 0 0 0 0 |0 0 0 0 0 0 0 0 |1 1 0 0 0 0 0 0</span><br><span class="line">1 0 1 0 0 0 0 0 |0 0 0 0 0 0 0 0 |1 0 1 0 0 0 0 0</span><br><span class="line">1 1 1 1 0 0 0 0 |0 0 0 0 0 0 0 0 |1 1 1 1 0 0 0 0</span><br><span class="line">1 0 0 0 1 0 0 0 |0 0 0 0 0 0 0 0 |1 0 0 0 1 0 0 0</span><br><span class="line">1 1 0 0 1 1 0 0 |0 0 0 0 0 0 0 0 |1 1 0 0 1 1 0 0</span><br><span class="line">1 0 1 0 1 0 1 0 |0 0 0 0 0 0 0 0 |1 0 1 0 1 0 1 0</span><br><span class="line">1 1 1 1 1 1 1 1 |0 0 0 0 0 0 0 0 |1 1 1 1 1 1 1 1</span><br><span class="line">^                ^                ^ </span><br><span class="line">箭頭表示本身也是 Sierpinski sieve</span><br><span class="line"></span><br><span class="line">區塊縮影得到 miniature pattern 也是 Sierpinski sieve</span><br><span class="line">1</span><br><span class="line">1 1</span><br><span class="line">1 0 1</span><br></pre></td></tr></table></figure>

<p>得到數個一模一樣的子圖，上述全零和非零的區塊，又恰好構成 Sierpinski sieve。這告訴我們任何操作全都要以二的冪次為基準，且合併區段時須以二項係數為係數。設定 pattern 大小為 <span>$M=2^{\lceil \log_2 N\rceil}$</span><!-- Has MathJax -->，最後得到 miniature pattern。在同一層中，非零構成的條紋都是相同的模式，例如上述得圖中，最後一層的箭號組合必然是 101 或者是 000，最後得到下列公式計算條紋。</p>
<span>$A_{i, j} = A_{i-1}{j} \oplus A_{i-1,j+M}$</span><!-- Has MathJax -->

<p>接下來，我們將需要確定每一個條紋 (stripe) 是否使用全零或者非零，只需要查找 miniature pattern 相應的係數即可。</p>
<h3 id="如何在-Sierpinski-sieve-找到非零係數的位置"><a href="#如何在-Sierpinski-sieve-找到非零係數的位置" class="headerlink" title="如何在 Sierpinski sieve 找到非零係數的位置"></a>如何在 Sierpinski sieve 找到非零係數的位置</h3><p>若 <span>$\binom{n}{i} \mod 2 = 1$</span><!-- Has MathJax -->，必滿足 <span>$n\&amp;i = i$</span><!-- Has MathJax -->。其證明從數學歸納法來，由二冪次的長度碎形著手，移除最高位的 1 得到 <span>$i&apos;$</span><!-- Has MathJax -->，從 <span>$i&apos;$</span><!-- Has MathJax --> 舊有位置集合，保留此集合，並對每一個元素增加二的冪次得到碎形的另一邊。</p>
<p>故可利用下述算法，準確地找到每一個非零的係數位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for (int pos = n; pos; pos = (pos-1)&amp;n)</span><br><span class="line">    C[n][pos] mod 2 = 1</span><br></pre></td></tr></table></figure>

<p>最後附上優化後得到 Rank 1 的程序 0.040 s</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> M = (<span class="number">1</span>&lt;&lt;<span class="number">7</span>);</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">10005</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> A[M+<span class="number">1</span>][MAXN];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">miniature</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i*M &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j+i*M &lt; n; j++)</span><br><span class="line">            A[i][j] = A[i<span class="number">-1</span>][j] ^ A[i<span class="number">-1</span>][j+M];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">extract</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> n = r-l;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> m = n/M;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> o = n%M;</span><br><span class="line">    <span class="keyword">int</span> ret = A[m][l];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = o; i; i = (i<span class="number">-1</span>)&amp;o)</span><br><span class="line">        ret ^= A[m][l+i];</span><br><span class="line">    <span class="keyword">return</span> ret;	</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> MM &#123;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">readchar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">char</span> buf[N];</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">char</span> *p = buf, *end = buf;</span><br><span class="line">        <span class="keyword">if</span>(p == end) &#123;</span><br><span class="line">            <span class="keyword">if</span>((end = buf + <span class="built_in">fread</span>(buf, <span class="number">1</span>, N, stdin)) == buf) <span class="keyword">return</span> EOF;</span><br><span class="line">            p = buf;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> *p++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">ReadInt</span><span class="params">(<span class="keyword">int</span> *x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">char</span> c, neg;</span><br><span class="line">        <span class="keyword">while</span>((c = <span class="built_in">readchar</span>()) &lt; <span class="string">&#x27;-&#x27;</span>)    &#123;<span class="keyword">if</span>(c == EOF) <span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line">        neg = (c == <span class="string">&#x27;-&#x27;</span>) ? <span class="number">-1</span> : <span class="number">1</span>;</span><br><span class="line">        *x = (neg == <span class="number">1</span>) ? c-<span class="string">&#x27;0&#x27;</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>((c = <span class="built_in">readchar</span>()) &gt;= <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">            *x = (*x &lt;&lt; <span class="number">3</span>) + (*x &lt;&lt; <span class="number">1</span>) + c-<span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        *x *= neg;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Print</span> &#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</span><br><span class="line">        <span class="keyword">char</span> buf[N], *p, *end;</span><br><span class="line">        <span class="built_in">Print</span>() &#123;</span><br><span class="line">            p = buf, end = buf + N - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">printInt</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">char</span> padding)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">static</span> <span class="keyword">char</span> stk[<span class="number">16</span>];</span><br><span class="line">            <span class="keyword">int</span> idx = <span class="number">0</span>;</span><br><span class="line">            stk[idx++] = padding;</span><br><span class="line">            <span class="keyword">if</span> (!x)	</span><br><span class="line">                stk[idx++] = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            <span class="keyword">while</span> (x)</span><br><span class="line">                stk[idx++] = x%<span class="number">10</span> + <span class="string">&#x27;0&#x27;</span>, x /= <span class="number">10</span>;</span><br><span class="line">            <span class="keyword">while</span> (idx) &#123;</span><br><span class="line">                <span class="keyword">if</span> (p == end) &#123;</span><br><span class="line">                    *p = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buf), p = buf;</span><br><span class="line">                &#125;</span><br><span class="line">                *p = stk[--idx], p++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        	*p = <span class="string">&#x27;\0&#x27;</span>, p = buf;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buf);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">online_printInt</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">static</span> <span class="keyword">char</span> ch[<span class="number">16</span>];</span><br><span class="line">            <span class="keyword">static</span> <span class="keyword">int</span> idx;</span><br><span class="line">            idx = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (x == <span class="number">0</span>)	ch[++idx] = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (x &gt; <span class="number">0</span>) ch[++idx] = x % <span class="number">10</span>, x /= <span class="number">10</span>;</span><br><span class="line">            <span class="keyword">while</span> (idx) </span><br><span class="line">                <span class="built_in">putchar</span>(ch[idx--]+<span class="number">48</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ~<span class="built_in">Print</span>() &#123;</span><br><span class="line">            *p = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buf);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; bprint;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> testcase, cases = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> n, m;</span><br><span class="line"><span class="comment">//	scanf(&quot;%d&quot;, &amp;testcase);</span></span><br><span class="line">    MM::<span class="built_in">ReadInt</span>(&amp;testcase);</span><br><span class="line">    <span class="keyword">while</span> (testcase--) &#123;</span><br><span class="line"><span class="comment">//		scanf(&quot;%d&quot;, &amp;n);</span></span><br><span class="line">        MM::<span class="built_in">ReadInt</span>(&amp;n);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line"><span class="comment">//			scanf(&quot;%d&quot;, &amp;A[0][i]);</span></span><br><span class="line">            MM::<span class="built_in">ReadInt</span>(&amp;A[<span class="number">0</span>][i]);</span><br><span class="line">        <span class="built_in">miniature</span>(n);</span><br><span class="line"><span class="comment">//		scanf(&quot;%d&quot;, &amp;m);</span></span><br><span class="line">        MM::<span class="built_in">ReadInt</span>(&amp;m);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Case %d:\n&quot;</span>, ++cases);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> l, r;</span><br><span class="line"><span class="comment">//			scanf(&quot;%d %d&quot;, &amp;l, &amp;r);</span></span><br><span class="line">            MM::<span class="built_in">ReadInt</span>(&amp;l), MM::<span class="built_in">ReadInt</span>(&amp;r);</span><br><span class="line"><span class="comment">//			printf(&quot;%d\n&quot;, extract(l, r));</span></span><br><span class="line">            MM::bprint.<span class="built_in">printInt</span>(<span class="built_in">extract</span>(l, r), <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        MM::bprint.<span class="built_in">flush</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">5</span></span><br><span class="line"><span class="comment">1  4  6  7  8</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">0  0</span></span><br><span class="line"><span class="comment">0  1</span></span><br><span class="line"><span class="comment">2  4</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-big-integer-division" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/09/big-integer-division/" class="article-date">
  <time datetime="2017-04-09T08:13:14.000Z" itemprop="datePublished">2017-04-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="http://i.imgur.com/BuPUpad.jpg" rel="gallery_ckpaivc6z000jn8vn6thogo40">
        <img src="http://i.imgur.com/BuPUpad.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/09/big-integer-division/">關於高效大數除法的那些事</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/04/09/big-integer-division/" data-id="ckpaivc6z000jn8vn6thogo40" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/04/09/big-integer-division/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FFT/">FFT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/大數/">大數</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>從國小開始學起加減乘除，腦海裡計算加法比減法簡單，減法可以換成加法，乘法則可以換成數個加法。即使到了中國最強的利器——珠心算，我們學習這古老的快速運算時，也都採取這類方法，而除法最為複雜，需要去估算商，嘗試去扣完，再做細微調整。然而，當整數位數為 <span>$N$</span><!-- Has MathJax --> 時，加減法效能為 <span>$N$</span><!-- Has MathJax --> 基礎運算，而乘除法為 <span>$N^2$</span><!-- Has MathJax --> 次基礎運算，一次基礎運算通常定義在查表，例如背誦的九九乘法表，使得我們在借位和乘積運算達到非常快速。</p>
<p>這些方法在計算機發展後，硬體實作大致使用這些算法，直到了快速傅立葉 (FFT) 算法能在 <span>$O(N \log N)$</span><!-- Has MathJax --> 時間內完成旋積 (卷積) 計算，順利地解決了多項式乘法的問題，使得大數乘法能在 <span>$O(N \log N)$</span><!-- Has MathJax --> 時間內完成。</p>
<p>一開始我們知道乘法和除法都可以在 <span>$O(N^2)$</span><!-- Has MathJax --> 時間內完成，有了 FFT 之後，除法是不是也能跟乘法一樣在 <span>$O(N \log N)$</span><!-- Has MathJax --> 內完成？</p>
<h2 id="大數除法"><a href="#大數除法" class="headerlink" title="大數除法"></a>大數除法</h2><p>就目前研究來看，除法可以轉換成乘法運算，在數論的整數域中，若存在乘法反元素，除一個數相當於成一個數，而我們發展的計算機，有效運算為 32/64-bit，其超過的部分視為溢位 (overflow)，溢位則可視為模數。因此，早期 CPU 設計中，除法需要的運行次數比乘法多一些，編譯器會將除法轉換乘法運算 (企圖找到反元素)，來加速運算。現在，由於 intel 的黑魔法，導致幾乎一模一樣快而沒人注意到這些瑣事。</p>
<p>回過頭來，我們介紹一個藉由 FFT 達到的除法運算 <span>$O(N \log N \log N)$</span><!-- Has MathJax --> 的算法。而那多的 <span>$O(\log N)$</span><!-- Has MathJax --> 來自於牛頓迭代法。目標算出 <span>$C = \lfloor A/B \rfloor$</span><!-- Has MathJax -->，轉換成 <span>$C = \lfloor A \ast (1/B) \rfloor$</span><!-- Has MathJax -->，快速算出 <span>$1/B$</span><!-- Has MathJax --> 的值，採用牛頓迭代法。</p>
<p>額外要求整數長度 <span>$n = \text{length}(A)$</span><!-- Has MathJax -->、<span>$m = \text{length}(B)$</span><!-- Has MathJax -->，當計算 <span>$1/B$</span><!-- Has MathJax --> 時，要求精準度到小數點後 <span>$n$</span><!-- Has MathJax --> 位才行。</p>
<h3 id="牛頓迭代法"><a href="#牛頓迭代法" class="headerlink" title="牛頓迭代法"></a>牛頓迭代法</h3><p>目標求 <span>$f(x) = 0$</span><!-- Has MathJax --> 的一組解。</p>
<span>$$\begin{align}
x_{n+1} = x_n - \frac{f(x_n)}{f&apos;(x_n)}
\end{align}$$</span><!-- Has MathJax -->

<p>不斷地迭代逼近找解。若有多組解，則依賴初始值 <span>$x_0$</span><!-- Has MathJax --> 決定優先找到哪一組解。</p>
<blockquote>
<p>這部分也應用在快速開根號——反平方根快速演算法 <a href="https://en.wikipedia.org/wiki/Fast_inverse_square_root">Fast inverse square root</a></p>
</blockquote>
<h3 id="倒數計算"><a href="#倒數計算" class="headerlink" title="倒數計算"></a>倒數計算</h3><p>藉由下述定義，找到 <span>$x = 1/B$</span><!-- Has MathJax --></p>
<span>$$\begin{align}
f(x) = \frac{1}{x} - B, \; f&apos;(x) = -\frac{1}{x^2}
\end{align}$$</span><!-- Has MathJax -->

<p>接著推導牛頓迭代法的公式</p>
<span>$$\begin{align}
x_{n+1} &amp;= x_n - \frac{f(x_n)}{f&apos;(x_n)} \\
&Tab;&Tab;&amp;= x_n - \frac{\frac{1}{x} - B}{-\frac{1}{x^2}} = (2 - x_n B) x_n
\end{align}$$</span><!-- Has MathJax -->

<h3 id="運行範例"><a href="#運行範例" class="headerlink" title="運行範例"></a>運行範例</h3><p>當 <span>$A = 7123456, \; B = 123$</span><!-- Has MathJax -->，計算倒數 <span>$1/B = 1/123$</span><!-- Has MathJax -->，由於 <span>$A$</span><!-- Has MathJax --> 為 <span>$n=7$</span><!-- Has MathJax --> 位數，小數點後精準 7 位，意即迭代比較小數點後 7 位不再變動時停止。</p>
<p>以下描述皆以 <strong>十進制</strong> (在程式運行時我們可能會偏向萬進制，甚至億進制來充分利用 32-bit 暫存器)</p>
<ul>
<li>決定 <span>$x_0$</span><!-- Has MathJax --> 是很重要的一步，這嚴重影響著迭代次數。</li>
<li><span>$x_0$</span><!-- Has MathJax --> 拿 <span>$B$</span><!-- Has MathJax --> 的最高位數 1 進行大數除小數，得到 <span>$x_0 = 0.01$</span><!-- Has MathJax --></li>
<li><span>$x_1 = (2 - x_0 \ast B) \ast x_0 = 0.0077$</span><!-- Has MathJax --></li>
<li><span>$x_2 = (2 - x_1 \ast B) \ast x_1 = 0.0081073$</span><!-- Has MathJax --></li>
<li><span>$x_3 = (2 - x_2 \ast B) \ast x_2 = 0.00813001$</span><!-- Has MathJax --></li>
<li><span>$x_4 = (2 - x_3 \ast B) \ast x_3 = 0.00813008$</span><!-- Has MathJax --></li>
</ul>
<p>接下來進行移位到整數部分，進行乘法後再移回去即可。</p>
<h3 id="實作細節"><a href="#實作細節" class="headerlink" title="實作細節"></a>實作細節</h3><h4 id="精準度"><a href="#精準度" class="headerlink" title="精準度"></a>精準度</h4><p>使用浮點數實作的 FFT，需要小心精準度，網路上有些代碼利用合角公式取代建表。這類型的優化，在精準度不需要很高的時候提供較好的效能，卻無法提供精準的值，誤差修正成了一道難題。</p>
<h4 id="牛頓迭代"><a href="#牛頓迭代" class="headerlink" title="牛頓迭代"></a>牛頓迭代</h4><p>由於有 FFT 造成的誤差，檢查收斂必須更加地保守，我們可能需要保留小數點下 <span>$n+10$</span><!-- Has MathJax --> 位，在收斂時檢查 <span>$n+5$</span><!-- Has MathJax --> 位確保收斂。通常收斂可以在 20 次左右完成，若發現迭代次數過多，有可能是第一個精準度造成的影響，盡可能使用內建函數得到的三角函數值。</p>
<h4 id="加速優化"><a href="#加速優化" class="headerlink" title="加速優化"></a>加速優化</h4><p>一般使用 IEEE-754 的浮點數格式，根據 FFT 的長度，要避開超過的震級，因此，在 Zerojudge b960 中，最多使用十萬進制進行加速。</p>
<h4 id="誤差修正"><a href="#誤差修正" class="headerlink" title="誤差修正"></a>誤差修正</h4><p>儘管算出的商 <span>$C=A \ast (1/B)$</span><!-- Has MathJax -->，得到的 <span>$C$</span><!-- Has MathJax --> 可能會差個 1，需要在後續乘法中檢驗。</p>
<h2 id="參考題目-資料"><a href="#參考題目-資料" class="headerlink" title="參考題目/資料"></a>參考題目/資料</h2><ul>
<li><a href="https://zerojudge.tw/ShowProblem?problemid=b960">Zerojudge b960</a></li>
<li><a href="http://www.spoj.com/problems/VFDIV/">SPOJ VFDIV - Very Fast Division</a></li>
<li><a href="http://edisonx.pixnet.net/blog/post/94569776-%5B%E5%A4%A7%E6%95%B8%5D-c-%E8%AA%9E%E8%A8%80%E5%A4%A7%E6%95%B8%E6%BC%94%E7%AE%97%E6%B3%95-for-general-(iii)---%E5%A4%A7%E6%95%B8">C 語言大數演算法 for general (III) - 大數除法 / Edison.X. Blog</a></li>
</ul>
<h2 id="b960-的亂碼"><a href="#b960-的亂碼" class="headerlink" title="b960 的亂碼"></a>b960 的亂碼</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="class"><span class="keyword">class</span> <span class="title">TOOL_FFT</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">complex</span> &#123;</span></span><br><span class="line">        T x, y;</span><br><span class="line">        <span class="built_in">complex</span>(T x = <span class="number">0</span>, T y = <span class="number">0</span>):</span><br><span class="line">            <span class="built_in">x</span>(x), <span class="built_in">y</span>(y) &#123;&#125;</span><br><span class="line">        complex <span class="keyword">operator</span>+(<span class="keyword">const</span> complex &amp;A) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">complex</span>(x+A.x,y+A.y);</span><br><span class="line">        &#125;</span><br><span class="line">        complex <span class="keyword">operator</span>-(<span class="keyword">const</span> complex &amp;A) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">complex</span>(x-A.x,y-A.y);</span><br><span class="line">        &#125;</span><br><span class="line">        complex <span class="keyword">operator</span>*(<span class="keyword">const</span> complex &amp;A) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">complex</span>(x*A.x-y*A.y,x*A.y+y*A.x);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    T PI;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1</span>&lt;&lt;<span class="number">17</span>;</span><br><span class="line">    complex p[<span class="number">2</span>][MAXN];</span><br><span class="line">    <span class="keyword">int</span> reversePos[MAXN];</span><br><span class="line">    <span class="built_in">TOOL_FFT</span>() &#123;</span><br><span class="line">        PI = <span class="built_in">acos</span>(<span class="number">-1</span>);</span><br><span class="line">        <span class="built_in">preprocessing</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">NumberOfBitsNeeded</span><span class="params">(<span class="keyword">int</span> PowerOfTwo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (PowerOfTwo &amp; (<span class="number">1</span> &lt;&lt; i)) &#123;</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">uint32_t</span> <span class="title">FastReverseBits</span><span class="params">(<span class="keyword">uint32_t</span> a, <span class="keyword">int</span> NumBits)</span> </span>&#123;</span><br><span class="line">        a = ( ( a &amp; <span class="number">0x55555555</span>U ) &lt;&lt; <span class="number">1</span> ) | ( ( a &amp; <span class="number">0xAAAAAAAA</span>U ) &gt;&gt; <span class="number">1</span> ) ;</span><br><span class="line">        a = ( ( a &amp; <span class="number">0x33333333</span>U ) &lt;&lt; <span class="number">2</span> ) | ( ( a &amp; <span class="number">0xCCCCCCCC</span>U ) &gt;&gt; <span class="number">2</span> ) ;</span><br><span class="line">        a = ( ( a &amp; <span class="number">0x0F0F0F0F</span>U ) &lt;&lt; <span class="number">4</span> ) | ( ( a &amp; <span class="number">0xF0F0F0F0</span>U ) &gt;&gt; <span class="number">4</span> ) ;</span><br><span class="line">        a = ( ( a &amp; <span class="number">0x00FF00FF</span>U ) &lt;&lt; <span class="number">8</span> ) | ( ( a &amp; <span class="number">0xFF00FF00</span>U ) &gt;&gt; <span class="number">8</span> ) ;</span><br><span class="line">        a = ( ( a &amp; <span class="number">0x0000FFFF</span>U ) &lt;&lt; <span class="number">16</span> ) | ( ( a &amp; <span class="number">0xFFFF0000</span>U ) &gt;&gt; <span class="number">16</span> ) ;</span><br><span class="line">        <span class="keyword">return</span> a &gt;&gt; (<span class="number">32</span> - NumBits);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">FFT</span><span class="params">(<span class="keyword">bool</span> InverseTransform, complex In[], complex Out[], <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// simultaneous data copy and bit-reversal ordering into outputs</span></span><br><span class="line">        <span class="keyword">int</span> NumSamples = n;</span><br><span class="line">        <span class="keyword">int</span> NumBits = <span class="built_in">NumberOfBitsNeeded</span>(NumSamples);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NumSamples; ++i) </span><br><span class="line">            Out[reversePos[i]] = In[i];</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// the FFT process</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= NumBits; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> BlockSize = <span class="number">1</span>&lt;&lt;i, BlockEnd = BlockSize&gt;&gt;<span class="number">1</span>, BlockCnt = NumSamples/BlockSize;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; NumSamples; j += BlockSize) &#123;</span><br><span class="line">                complex *t = p[InverseTransform];</span><br><span class="line">                <span class="keyword">int</span> k = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOP_SIZE 8</span></span><br><span class="line">                <span class="keyword">for</span> (; k+UNLOOP_SIZE &lt; BlockEnd; ) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOP &#123; \</span></span><br><span class="line"><span class="meta">	complex a = (*t) * Out[k+j+BlockEnd]; \</span></span><br><span class="line"><span class="meta">    Out[k+j+BlockEnd] = Out[k+j] - a; \</span></span><br><span class="line"><span class="meta">    Out[k+j] = Out[k+j] + a;\</span></span><br><span class="line"><span class="meta">    k++, t += BlockCnt;\</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOP4 &#123;UNLOOP UNLOOP UNLOOP UNLOOP;&#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOP8 &#123;UNLOOP4 UNLOOP4;&#125;</span></span><br><span class="line">                    UNLOOP8;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (; k &lt; BlockEnd;)</span><br><span class="line">                    UNLOOP;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// normalize if inverse transform</span></span><br><span class="line">        <span class="keyword">if</span> (InverseTransform) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NumSamples; ++i) &#123;</span><br><span class="line">                Out[i] = Out[i].x / NumSamples;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">convolution</span><span class="params">(T *a, T *b, <span class="keyword">int</span> n, T *c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> complex s[MAXN], d1[MAXN], d2[MAXN], y[MAXN];</span><br><span class="line">    	n = MAXN;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">            s[i] = <span class="built_in">complex</span>(a[i], <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">FFT</span>(<span class="literal">false</span>, s, d1, n);</span><br><span class="line">        s[<span class="number">0</span>] = <span class="built_in">complex</span>(b[<span class="number">0</span>], <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++i)</span><br><span class="line">            s[i] = <span class="built_in">complex</span>(b[n - i], <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">FFT</span>(<span class="literal">false</span>, s, d2, n);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">            y[i] = d1[i] * d2[i];</span><br><span class="line">        <span class="built_in">FFT</span>(<span class="literal">true</span>, y, s, n);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">            c[i] = s[i].x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">preprocessing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = MAXN;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i ++) &#123;</span><br><span class="line">            p[<span class="number">0</span>][i] = <span class="built_in">complex</span>(<span class="built_in">cos</span>(<span class="number">2</span>*i*PI / n), <span class="built_in">sin</span>(<span class="number">2</span>*i*PI / n));</span><br><span class="line">            p[<span class="number">1</span>][i] = <span class="built_in">complex</span>(p[<span class="number">0</span>][i].x, -p[<span class="number">0</span>][i].y);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> NumBits = <span class="built_in">NumberOfBitsNeeded</span>(n);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">        	reversePos[i] = <span class="built_in">FastReverseBits</span>(i, NumBits);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">TOOL_FFT&lt;<span class="keyword">double</span>&gt; tool;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BigInt</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> *v;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> DIGITS = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1</span>&lt;&lt;<span class="number">17</span>;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(<span class="keyword">const</span> BigInt a, <span class="keyword">const</span> BigInt b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = MAXN<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (a.v[i] &lt; b.v[i])</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">if</span> (a.v[i] &gt; b.v[i])</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">str2int</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">long</span> <span class="keyword">long</span> buf[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = <span class="built_in">strlen</span>(s);</span><br><span class="line">        size = (n+DIGITS<span class="number">-1</span>) / DIGITS;</span><br><span class="line">        <span class="keyword">int</span> cnt = n%DIGITS == <span class="number">0</span> ? DIGITS : n%DIGITS;</span><br><span class="line">        <span class="keyword">int</span> x = <span class="number">0</span>, pos = size<span class="number">-1</span>;</span><br><span class="line">        v = buf;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            x = x*<span class="number">10</span> + s[i] - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span> (--cnt == <span class="number">0</span>) &#123;</span><br><span class="line">                cnt = DIGITS;</span><br><span class="line">                v[pos--] = x, x = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">println</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%lld&quot;</span>, v[size<span class="number">-1</span>]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> pos = size<span class="number">-2</span>; pos &gt;= <span class="number">0</span>; pos--)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%05lld&quot;</span>, v[pos]);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">BigInt <span class="title">multiply</span><span class="params">(<span class="keyword">const</span> BigInt &amp;other, <span class="keyword">long</span> <span class="keyword">long</span> buf[])</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> m = MAXN;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">double</span> na[MAXN], nb[MAXN];</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">double</span> tmp[MAXN];</span><br><span class="line">        <span class="built_in">memset</span>(na+size, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(v[<span class="number">0</span>])*(m-size));</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">            na[i] = v[i];</span><br><span class="line">        <span class="built_in">memset</span>(nb+<span class="number">1</span>, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(v[<span class="number">0</span>])*(m-other.size));</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, j = m<span class="number">-1</span>; i &lt; other.size; i++, j--)</span><br><span class="line">            nb[j] = other.v[i];</span><br><span class="line">        nb[<span class="number">0</span>] = other.v[<span class="number">0</span>];</span><br><span class="line">        tool.<span class="built_in">convolution</span>(na, nb, m, tmp);</span><br><span class="line">        BigInt ret;</span><br><span class="line">        ret.size = m;</span><br><span class="line">        ret.v = buf;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++)</span><br><span class="line">        	buf[i] = (<span class="keyword">long</span> <span class="keyword">long</span>) (tmp[i] + <span class="number">1.5e-1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        	<span class="keyword">if</span> (buf[i] &gt;= <span class="number">100000</span>)</span><br><span class="line">        		buf[i+<span class="number">1</span>] += buf[i]/<span class="number">100000</span>, buf[i] %= <span class="number">100000</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ret.<span class="built_in">reduce</span>();</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reduce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (size &gt; <span class="number">1</span> &amp;&amp; <span class="built_in">fabs</span>(v[size<span class="number">-1</span>]) &lt; <span class="number">5e-1</span>)</span><br><span class="line">            size--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">BigInt <span class="title">divide</span><span class="params">(<span class="keyword">const</span> BigInt &amp;other, <span class="keyword">long</span> <span class="keyword">long</span> buf[])</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> cmp = <span class="built_in">compare</span>(*<span class="keyword">this</span>, other);</span><br><span class="line">            BigInt ret;</span><br><span class="line">            ret.size = MAXN<span class="number">-1</span>, ret.v = buf;</span><br><span class="line">            <span class="keyword">if</span> (cmp == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(buf[<span class="number">0</span>])*MAXN);</span><br><span class="line">                buf[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">                ret.<span class="built_in">reduce</span>();</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(buf[<span class="number">0</span>])*MAXN);</span><br><span class="line">                buf[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">                ret.<span class="built_in">reduce</span>();</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// A / B = A * (1/B)</span></span><br><span class="line">        <span class="comment">// x&#x27; = (2 - x * B) * x</span></span><br><span class="line">        <span class="keyword">int</span> m = MAXN;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">double</span> na[MAXN], nb[MAXN];</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">double</span> invB[MAXN], netB[MAXN], tmpB[MAXN];</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">long</span> <span class="keyword">long</span> bufB[MAXN];</span><br><span class="line">        <span class="keyword">int</span> PRECISION = size+<span class="number">10</span>;</span><br><span class="line">        <span class="built_in">memset</span>(nb+<span class="number">1</span>, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(v[<span class="number">0</span>])*(m-other.size));</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, j = m<span class="number">-1</span>; i &lt; other.size; i++, j--)</span><br><span class="line">            nb[j] = other.v[i];</span><br><span class="line">        nb[<span class="number">0</span>] = other.v[<span class="number">0</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">memset</span>(invB, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(invB[<span class="number">0</span>])*m);</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">long</span> <span class="keyword">long</span> t = <span class="number">100000</span>, a = other.v[other.size<span class="number">-1</span>];</span><br><span class="line">            <span class="keyword">if</span> (other.size<span class="number">-2</span> &gt;= <span class="number">0</span>)</span><br><span class="line">                t = t*<span class="number">100000</span>, a = a*<span class="number">100000</span>+other.v[other.size<span class="number">-2</span>];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = PRECISION-other.size; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                invB[i] = t/a;</span><br><span class="line">                t = (t%a)*<span class="number">100000</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> it = <span class="number">0</span>; it &lt; <span class="number">100</span>; it++) &#123;</span><br><span class="line">            <span class="comment">// netB = xi * B</span></span><br><span class="line">            tool.<span class="built_in">convolution</span>(invB, nb, m, netB);</span><br><span class="line">            <span class="keyword">long</span> <span class="keyword">long</span> carry = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= PRECISION*<span class="number">2</span>; i++) &#123;</span><br><span class="line">            	bufB[i] = carry + (<span class="keyword">long</span> <span class="keyword">long</span>) (netB[i] + <span class="number">1.5e-1</span>);</span><br><span class="line">            	<span class="keyword">if</span> (bufB[i] &gt;= <span class="number">100000</span>)</span><br><span class="line">            		carry = bufB[i]/<span class="number">100000</span>, bufB[i] %= <span class="number">100000</span>;</span><br><span class="line">            	<span class="keyword">else</span></span><br><span class="line">            		carry = <span class="number">0</span>;</span><br><span class="line">                bufB[i] = -bufB[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// tmpB = 2 - xi * B</span></span><br><span class="line">            bufB[PRECISION] += <span class="number">2</span>;</span><br><span class="line">            <span class="built_in">memset</span>(tmpB, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(tmpB[<span class="number">0</span>])*m);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= PRECISION*<span class="number">2</span>; i++) &#123;</span><br><span class="line">            	<span class="keyword">if</span> (bufB[i] &lt; <span class="number">0</span>)</span><br><span class="line">            		bufB[i] += <span class="number">100000</span>, bufB[i+<span class="number">1</span>]--;</span><br><span class="line">            	<span class="keyword">if</span> (i != <span class="number">0</span>)</span><br><span class="line">            		tmpB[m-i] = bufB[i];</span><br><span class="line">            	<span class="keyword">else</span></span><br><span class="line">            		tmpB[i] = bufB[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// netB = tmpB * invB</span></span><br><span class="line">            tool.<span class="built_in">convolution</span>(invB, tmpB, m, netB);</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">long</span> <span class="keyword">long</span> carry = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">memset</span>(bufB, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(bufB[<span class="number">0</span>])*m);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= PRECISION*<span class="number">2</span>; i++) &#123;</span><br><span class="line">                    bufB[i] = carry + (<span class="keyword">long</span> <span class="keyword">long</span>) (netB[i] + <span class="number">1.5e-1</span>);</span><br><span class="line">                    <span class="keyword">if</span> (bufB[i] &gt;= <span class="number">100000</span>)</span><br><span class="line">            			carry = bufB[i]/<span class="number">100000</span>, bufB[i] %= <span class="number">100000</span>;</span><br><span class="line">            		<span class="keyword">else</span></span><br><span class="line">            			carry = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">int</span> same = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = PRECISION; same &amp;&amp; i &gt;= <span class="number">5</span>; i--)</span><br><span class="line">                    same &amp;= ((<span class="keyword">long</span> <span class="keyword">long</span>) (invB[i]) == bufB[i+PRECISION]);</span><br><span class="line">                <span class="keyword">if</span> (same)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">memset</span>(invB, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(invB[<span class="number">0</span>])*m);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i+PRECISION &lt;= PRECISION*<span class="number">2</span>; i++)</span><br><span class="line">            	invB[i] = bufB[i+PRECISION];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">memset</span>(na+<span class="number">1</span>, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(v[<span class="number">0</span>])*(m-size));</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, j = m<span class="number">-1</span>; i &lt; size; i++, j--)</span><br><span class="line">            na[j] = v[i];</span><br><span class="line">        na[<span class="number">0</span>] = v[<span class="number">0</span>];</span><br><span class="line">        tool.<span class="built_in">convolution</span>(invB, na, m, netB);</span><br><span class="line">        </span><br><span class="line">        BigInt ret;</span><br><span class="line">        ret.size = m<span class="number">-1</span>;</span><br><span class="line">        ret.v = buf;</span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> carry = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        	buf[i] = carry + (<span class="keyword">long</span> <span class="keyword">long</span>) (netB[i] + <span class="number">1.5e-1</span>);</span><br><span class="line">        	<span class="keyword">if</span> (buf[i] &gt;= <span class="number">100000</span>)</span><br><span class="line">        		carry = buf[i]/<span class="number">100000</span>, buf[i] %= <span class="number">100000</span>;</span><br><span class="line">        	<span class="keyword">else</span></span><br><span class="line">        		carry = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i+PRECISION &lt; m; i++)</span><br><span class="line">            buf[i] = buf[i+PRECISION];</span><br><span class="line">        <span class="built_in">memset</span>(buf+PRECISION, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(buf[<span class="number">0</span>])*(m-PRECISION));</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="built_in">memset</span>(na, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(na[<span class="number">0</span>])*m);</span><br><span class="line">        	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, j = m<span class="number">-1</span>; i &lt; m<span class="number">-1</span>; i++, j--)</span><br><span class="line">                na[j] = buf[i];</span><br><span class="line">            na[<span class="number">0</span>] = buf[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++)</span><br><span class="line">            	nb[i] = other.v[i];</span><br><span class="line">    		tool.<span class="built_in">convolution</span>(nb, na, m, netB);</span><br><span class="line">    		<span class="keyword">long</span> <span class="keyword">long</span> carry = <span class="number">0</span>;</span><br><span class="line">    		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">    			bufB[i] = (carry + (<span class="keyword">long</span> <span class="keyword">long</span>) (netB[i] + <span class="number">1e-1</span>));</span><br><span class="line">            	<span class="keyword">if</span> (bufB[i] &gt;= <span class="number">100000</span>)</span><br><span class="line">            		carry = bufB[i]/<span class="number">100000</span>, bufB[i] %= <span class="number">100000</span>;</span><br><span class="line">            	<span class="keyword">else</span></span><br><span class="line">            		carry = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            carry = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">                bufB[i] = v[i] - bufB[i] + carry;</span><br><span class="line">                <span class="keyword">if</span> (bufB[i] &lt; <span class="number">0</span>)</span><br><span class="line">            		bufB[i] += <span class="number">100000</span>, carry = <span class="number">-1</span>;</span><br><span class="line">            	<span class="keyword">else</span></span><br><span class="line">            		carry = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            BigInt R;</span><br><span class="line">            R.size = m<span class="number">-1</span>, R.v = bufB;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">compare</span>(other, R) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                buf[<span class="number">0</span>]++;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; buf[i] &gt;= <span class="number">100000</span>; i++)</span><br><span class="line">                    buf[i+<span class="number">1</span>]++, buf[i] -= <span class="number">100000</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ret.<span class="built_in">reduce</span>();</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> sa[<span class="number">1</span>&lt;&lt;<span class="number">20</span>], sb[<span class="number">1</span>&lt;&lt;<span class="number">20</span>];</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%s %s&quot;</span>, sa, sb) == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">long</span> <span class="keyword">long</span> da[<span class="number">1</span>&lt;&lt;<span class="number">19</span>], db[<span class="number">1</span>&lt;&lt;<span class="number">19</span>], dc[<span class="number">1</span>&lt;&lt;<span class="number">19</span>];</span><br><span class="line">        </span><br><span class="line">        BigInt a, b, c;</span><br><span class="line">        a.<span class="built_in">str2int</span>(sa, da);</span><br><span class="line">        b.<span class="built_in">str2int</span>(sb, db);</span><br><span class="line">        c = a.<span class="built_in">divide</span>(b, dc);</span><br><span class="line">        c.<span class="built_in">println</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/categories/解題區/page/2/">2</a><a class="page-number" href="/categories/解題區/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/categories/解題區/page/64/">64</a><a class="extend next" rel="next" href="/categories/解題區/page/2/">Next &raquo;</a>
    </nav>
  
</section>
          
          
            <aside id="sidebar">
  <!-- <div id="ukagaka_panel"></div> -->
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/">學校課程</a><span class="category-list-count">115</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/介面設計/">介面設計</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/作業系統/">作業系統</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/即時系統/">即時系統</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/大學專題/">大學專題</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/巨量資料/">巨量資料</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/平行程式/">平行程式</a><span class="category-list-count">43</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/敏捷方法/">敏捷方法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/編譯器/">編譯器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/自然語言/">自然語言</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/虛擬實境/">虛擬實境</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算型智慧/">計算型智慧</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算幾何/">計算幾何</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算機圖學/">計算機圖學</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資料庫系統/">資料庫系統</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資訊安全/">資訊安全</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/通識課程/">通識課程</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/">工作應用</a><span class="category-list-count">30</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Java/">Java</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Meme/">Meme</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/可持久化/">可持久化</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/鬼故事/">鬼故事</a><span class="category-list-count">9</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/手札日記/">手札日記</a><span class="category-list-count">44</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/">網頁設計</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/About-This-Blog/">About This Blog</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/HTML5/">HTML5</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/JQuery/">JQuery</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/Markdown/">Markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/NodeJs/">NodeJs</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/">解題區</a><span class="category-list-count">633</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/Latex/">Latex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/出題解題/">出題解題</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-POJ/">解題區 - POJ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a><span class="category-list-count">483</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a><span class="category-list-count">77</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-未解題目/">解題區 - 未解題目</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/雜言筆記/">雜言筆記</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a class="text" href="/2021/05/30/java/java-memory-optimization-1/">
              
                <i class="icon-file-o"></i> 
              
            Java 優化內存使用 結構篇</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/diary-202101/">
              
                <i class="icon-file-o"></i> 
              
            二八進展</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-file-extension/">
              
                <i class="icon-file-o"></i> 
              
            File Extension</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-globl-var/">
              
                <i class="icon-file-o"></i> 
              
            Global Variable</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-handover/">
              
                <i class="icon-file-o"></i> 
              
            Handover</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-interview-recursion/">
              
                <i class="icon-file-o"></i> 
              
            Interview &amp; Recursion</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-job-build/">
              
                <i class="icon-file-o"></i> 
              
            Job Build</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-lang/">
              
                <i class="icon-file-o"></i> 
              
            Programming Language Impostors</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-machine-learning-newbie/">
              
                <i class="icon-file-o"></i> 
              
            Machine Learning for Newbie</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-parallel-gc/">
              
                <i class="icon-file-o"></i> 
              
            Parallel &amp; Garbage Collection</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">   
      	<ul>
	      <li><a href="http://mypaper.pchome.com.tw/zerojudge" target="_blank" title="Old Blog"><i class="icon-star"></i> Morris' Blog (pchome)</a></li>
	      <li><a href="http://flere114.blogspot.tw/" target="_blank" title="蘿莉勿觸"><i class="icon-googles"></i> flere's Blog</a></li>
	      <li><a href="http://dreamoon4.blogspot.tw/" target="_blank" title="夢月"><i class="icon-googles"></i> dreamoon's Blog</a></li>
	      <li><a href="http://m80126colin.github.io" target="_blank" title="許胖們"><i class="icon-github-alt"></i> m80126colin's Blog</a></li>
	      <li><a href="http://sd12582000.blogspot.tw/" target="_blank" title="妮可妮可"><i class="icon-github-alt"></i> Nico's Blog</a></li>
	      <li><a href="http://kuoe0.logdown.com/" target="_blank" title="郭至軒大神"><i class="icon-github-alt"></i> KuoE0's Dots</a></li>
	      <li><a href="http://tyan.io/" title=""><i class="icon-github-alt"></i> Tyan Blog</a></li>
    	</ul>
    </div>
</div>

  
    
<script src="/js/jquery-ui.js"></script>
<script src="/js/ukagaka/jquery.morris.ukagaka.resource.js"></script>
<script src="/js/ukagaka/typed.js"></script>
<script type="text/javascript">
  $('#ukagaka_panel').ukagaka();
</script>
  
  
</aside>
          
        
      </div>
      <footer id="footer">
  
  <div class="outer">    
    <div class="social-group">
      
      <a href="https://github.com/morris821028" target="_blank" title="github"><i class="icon-github"></i></a>
      
      
      <a href="https://www.facebook.com/Morris1028" target="_blank" title="facebook"><i class="icon-facebook-sign"></i></a>
      
      
      <a href="http://uhunt.felix-halim.net/id/46705" target="_blank" title="uhunt" ><span class="icon-uhunt">UVa<span></a>
      
    </div>
    <div id="footer-info" class="inner">
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/morris821028/hexo-theme-landscape" target="_blank" title="landscape">landscape</a> &copy; 2021 Shiang-Yun Yang 
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link"><i class=icon-home ></i>&nbsp&nbspHome</a>
  
    <a href="/about" class="mobile-nav-link"><i class=icon-user ></i>&nbsp&nbspAbout</a>
  
    <a href="/archives" class="mobile-nav-link"><i class=icon-archive ></i>&nbsp&nbspArchives</a>
  
    <a href="/tags" class="mobile-nav-link"><i class=icon-tags ></i>&nbsp&nbspTags</a>
  
    <a href="/picture" class="mobile-nav-link"><i class=icon-camera ></i>&nbsp&nbspPictures</a>
  
    <a href="/works" class="mobile-nav-link"><i class=icon-trophy ></i>&nbsp&nbspWorks</a>
  
</nav>
    
<script>
  var disqus_shortname = 'morris1028';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/jquery.lazyload.js"></script>
<script src="/js/jquery.als-1.6.js"></script>

<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>