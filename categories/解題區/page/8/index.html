<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Category: 解題區 | Morris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Morris&#39; Blog">
<meta property="og:url" content="http://morris821028.github.io/categories/解題區/page/8/index.html">
<meta property="og:site_name" content="Morris&#39; Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Morris&#39; Blog">
<link rel="publisher" href="108158678174364350000">
  
    <link rel="alternative" href="/atom.xml" title="Morris&#39; Blog" type="application/atom+xml">
  
  
    <meta name="google-site-verification" content="5mRgj8NanEMpGZuNfHNJNmH90RgNlrnJXsFlTaKD6Gs" />
  
  
    <link rel="shortcut icon" href="/img/f.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script src="/js/jquery-2.1.0.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.5.1.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdn.oesmith.co.uk/morris-0.5.1.min.js"></script>
  <!-- <link rel="import" href="/bower_components/app-layout/app-layout.html"> --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"><div id="banner-right"></div></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Morris&#39; Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class=icon-home title='Home'></i></a>
          
        
          
            <a class="main-nav-link" href="/about"><i class=icon-user title='About'></i></a>
          
        
          
            <a class="main-nav-link" href="/archives"><i class=icon-archive title='Archives'></i></a>
          
        
          
            <a class="main-nav-link" href="/tags"><i class=icon-tags title='Tags'></i></a>
          
        
          
            <a class="main-nav-link" href="/picture"><i class=icon-camera title='Pictures'></i></a>
          
        
          
            <a class="main-nav-link" href="/works"><i class=icon-trophy title='Works'></i></a>
          
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://morris821028.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        
          
          <section id="main">
  
    <article id="post-zj-b452" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/04/zj-b452/" class="article-date">
  <time datetime="2015-08-04T00:09:55.000Z" itemprop="datePublished">2015-08-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="http://i.imgur.com/19sRpRE.jpg" rel="gallery_ckq8np006014b1wvn3vaex798">
        <img src="http://i.imgur.com/19sRpRE.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/04/zj-b452/">b452. 傻傻地幫人數錢錢</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/08/04/zj-b452/" data-id="ckq8np006014b1wvn3vaex798" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/08/04/zj-b452/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/圓弧偵測/">圓弧偵測</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/影像處理/">影像處理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/霍夫轉換/">霍夫轉換</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>給一個彩色影像上面有數個相同大小的硬幣，硬幣之間不會重疊，但會有部分碰觸，請問影像中有多少個硬幣。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">10 9</div><div class="line">159 138 133 150 129 124 153 132 127 154 133 128 151 132 126 151 132 126 152 133 129 152 133 129 143 125 125 136 118 118</div><div class="line">147 126 121 163 142 137 146 125 120 86 65 60 60 41 35 57 38 32 68 49 45 111 92 88 143 125 123 138 120 118</div><div class="line">145 125 118 152 132 125 63 44 37 53 34 27 54 35 28 55 36 29 56 39 32 50 32 28 105 87 83 132 114 110</div><div class="line">150 130 123 106 86 79 53 34 27 57 38 31 53 34 27 64 45 38 55 38 31 56 39 32 63 45 41 131 113 109</div><div class="line">151 132 125 87 68 61 52 33 26 56 37 30 58 41 33 49 32 24 57 40 33 53 36 29 43 28 23 131 116 111</div><div class="line">136 117 111 103 84 78 56 37 31 59 40 34 54 37 30 57 40 33 47 30 23 53 35 31 54 39 34 141 126 121</div><div class="line">142 124 120 140 122 118 52 34 30 54 36 32 51 33 29 53 35 31 53 38 33 46 31 28 82 67 64 136 121 118</div><div class="line">145 127 127 125 107 107 116 98 98 54 36 36 53 35 33 54 36 34 46 30 30 65 49 49 138 122 122 145 129 129</div><div class="line">135 119 120 137 121 122 137 121 122 133 117 118 103 87 88 95 79 80 111 95 96 138 122 123 132 118 118 132 118 118</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>若圓形彼此之間不相交，可以用二值化 + 灌水法 (flood fill) + 分團大小檢測。現在圓形有相連可能，出題者給我附前測代碼啊，咱們兩個比一下速度 … 總之步驟是</p>
<ol>
<li>根據亮度二值化</li>
<li>搭配索貝爾運算 (sobel) 選定閥值後找到邊緣</li>
<li>接著窮舉圓半徑，使用霍夫轉換將邊緣點推到同一個圓心</li>
<li>掃描一個 <span>$7 \times 7$</span><!-- Has MathJax --> 的矩形，內部點個數要出現 56 個，同時要滿足 49 格至少出現 36 格或者其中一格出現大於 4 次。</li>
</ol>
<p>關於霍夫轉換，其中<span>$x_c, \; y_c$</span><!-- Has MathJax --> 表示推向圓心的座標，而 <span>$r$</span><!-- Has MathJax --> 表示窮舉的圓半徑，<span>$gx$</span><!-- Has MathJax --> 表示 x 方向的 sobel 差分，同理 <span>$gy$</span><!-- Has MathJax -->，而 <span>$g = \sqrt{gx^2 + gy^2}$</span><!-- Has MathJax -->。</p>
<p><em><span>$x_c = x - r \times (gx / g)$</span><!-- Has MathJax -->
</em><span>$y_c = y - r \times (gy / g)$</span><!-- Has MathJax --></p>
<p>當然閥值判定都還不到位，手動測試好幾個版本，OpenCV 的寫法值得去 trace 一下。代碼僅供玩玩，不代表在其他情況也能使用。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">IMAGE</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Pixel</span> &#123;</span></div><div class="line">        <span class="keyword">int</span> r, g, b;</div><div class="line">        Pixel(<span class="keyword">int</span> x = <span class="number">0</span>, <span class="keyword">int</span> y = <span class="number">0</span>, <span class="keyword">int</span> z = <span class="number">0</span>):</div><div class="line">        r(x), g(y), b(z) &#123;&#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;r, &amp;g, &amp;b);</div><div class="line">        &#125;</div><div class="line">        Pixel <span class="keyword">operator</span>-(<span class="keyword">const</span> Pixel &amp;x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> Pixel(r-x.r, g-x.g, b-x.b);</div><div class="line">        &#125;</div><div class="line">        Pixel <span class="keyword">operator</span>+(<span class="keyword">const</span> Pixel &amp;x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> Pixel(r+x.r, g+x.g, b+x.b);</div><div class="line">        &#125;</div><div class="line">        Pixel <span class="keyword">operator</span>*(<span class="keyword">const</span> <span class="keyword">double</span> x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> Pixel(r*x, g*x, b*x);</div><div class="line">        &#125;</div><div class="line">        Pixel <span class="keyword">operator</span>/(<span class="keyword">const</span> <span class="keyword">double</span> x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> Pixel(r/x, g/x, b/x);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> Pixel &amp;x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> r == x.r &amp;&amp; g == x.g &amp;&amp; b == x.b;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%3d"</span>, length());</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> r + g + b;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">length</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="built_in">abs</span>(r) + <span class="built_in">abs</span>(g) + <span class="built_in">abs</span>(b);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">dist</span><span class="params">(Pixel x)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="built_in">abs</span>((r + g + b) - (x.r + x.g + x.b));</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">int</span> W, H;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">256</span>;</div><div class="line">    Pixel data[MAXN][MAXN];</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;W, &amp;H);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++)</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++)</div><div class="line">                data[i][j].read();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, W, H);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++)</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++)</div><div class="line">                data[i][j].print(), <span class="built_in">printf</span>(<span class="string">"%c"</span>, j == W<span class="number">-1</span> ? <span class="string">'\n'</span> : <span class="string">' '</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> Pixel <span class="title">getPixel</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (x &gt;= <span class="number">0</span> &amp;&amp; y &gt;= <span class="number">0</span> &amp;&amp; x &lt; H &amp;&amp; y &lt; W)</div><div class="line">            <span class="keyword">return</span> data[x][y];</div><div class="line">        <span class="keyword">if</span> (y &lt; <span class="number">0</span>)  <span class="keyword">return</span> data[min(max(x, <span class="number">0</span>), H<span class="number">-1</span>)][<span class="number">0</span>];</div><div class="line">        <span class="keyword">if</span> (y &gt;= W) <span class="keyword">return</span> data[min(max(x, <span class="number">0</span>), H<span class="number">-1</span>)][W<span class="number">-1</span>];</div><div class="line">        <span class="keyword">if</span> (x &lt; <span class="number">0</span>)  <span class="keyword">return</span> data[<span class="number">0</span>][min(max(y, <span class="number">0</span>), W<span class="number">-1</span>)];</div><div class="line">        <span class="keyword">if</span> (x &gt;= H) <span class="keyword">return</span> data[H<span class="number">-1</span>][min(max(y, <span class="number">0</span>), W<span class="number">-1</span>)];</div><div class="line">        <span class="keyword">return</span> Pixel(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sobel</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j, <span class="keyword">int</span> &amp;gx, <span class="keyword">int</span> &amp;gy)</span> </span>&#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> dx[] = &#123;<span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>&#125;;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> dy[] = &#123;<span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>&#125;;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> yw[] = &#123;<span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">-2</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>&#125;;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> xw[] = &#123;<span class="number">-1</span>, <span class="number">-2</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>&#125;;</div><div class="line">        Pixel Dx(0, 0, 0), Dy(0, 0, 0);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">9</span>; k++) &#123;</div><div class="line">            <span class="keyword">if</span> (xw[k])</div><div class="line">                Dx = Dx + getPixel(i+dx[k], j+dy[k]) * xw[k];</div><div class="line">            <span class="keyword">if</span> (yw[k])</div><div class="line">                Dy = Dy + getPixel(i+dx[k], j+dy[k]) * yw[k];</div><div class="line">        &#125;</div><div class="line">        gx = Dx.sum(), gy = Dy.sum();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> used[MAXN][MAXN];</div><div class="line">    <span class="keyword">int</span> gx[MAXN][MAXN], gy[MAXN][MAXN];</div><div class="line">    <span class="keyword">double</span> gxy[MAXN][MAXN];</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">isValid</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> x &gt;= <span class="number">0</span> &amp;&amp; y &gt;= <span class="number">0</span> &amp;&amp; x &lt; H &amp;&amp; y &lt; W;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">hough_circle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> mxb = INT_MIN, mnb = INT_MAX;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++) &#123;</div><div class="line">                <span class="keyword">int</span> b = data[i][j].length();</div><div class="line">                mxb = max(mxb, b), mnb = min(mnb, b);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mxb - mnb &lt; <span class="number">300</span>)</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> threshold = <span class="number">250</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++) &#123;</div><div class="line">                <span class="keyword">if</span> (data[i][j].length() &gt;= threshold)</div><div class="line">                    data[i][j] = Pixel(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    data[i][j] = Pixel(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++) &#123;</div><div class="line">                sobel(i, j, gx[i][j], gy[i][j]), gxy[i][j] = hypot(gx[i][j], gy[i][j]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">double</span> r = <span class="number">4</span>; r &lt;= min(H, W)/<span class="number">2</span>; r += <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++)</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++)</div><div class="line">                    used[i][j] = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++) &#123;</div><div class="line">                    <span class="keyword">if</span> (gxy[i][j] &gt; <span class="number">4</span>) &#123;</div><div class="line">                        <span class="keyword">int</span> xc, yc;</div><div class="line">                        xc = round(i - r * (gx[i][j] / gxy[i][j]));</div><div class="line">                        yc = round(j - r * (gy[i][j] / gxy[i][j]));</div><div class="line">                        <span class="keyword">if</span> (isValid(xc, yc))</div><div class="line">                            used[xc][yc]++;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="keyword">int</span> coins = <span class="number">0</span>;</div><div class="line">            <span class="keyword">const</span> <span class="keyword">int</span> C = <span class="number">3</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++) &#123;</div><div class="line">                    <span class="keyword">if</span> (used[i][j] &lt; <span class="number">3</span>)</div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                    <span class="keyword">int</span> sum = <span class="number">0</span>, mx = <span class="number">0</span>, has = <span class="number">0</span>;</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> p = -C; p &lt;= C; p++) &#123;</div><div class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> q = -C; q &lt;= C; q++) &#123;</div><div class="line">                            <span class="keyword">if</span> (isValid(i+p, j+q))</div><div class="line">                                sum += used[i+p][j+q], mx = max(mx, used[i+p][j+q]), has += used[i+p][j+q] &gt; <span class="number">0</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (sum &gt; <span class="number">56</span> &amp;&amp; (has &gt; <span class="number">36</span> || mx &gt; <span class="number">4</span>)) &#123;</div><div class="line">                        coins++;</div><div class="line">                        <span class="keyword">int</span> cx = i, cy = j;</div><div class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> p = -r<span class="number">-1</span>; p &lt;= r+<span class="number">1</span>; p++) &#123;</div><div class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> q = -r<span class="number">-1</span>; q &lt;= r+<span class="number">1</span>; q++) &#123;</div><div class="line">                                <span class="keyword">if</span> (isValid(cx+p, cy+q))</div><div class="line">                                    used[cx+p][cy+q] = <span class="number">0</span>;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (coins &lt; ret - <span class="number">2</span>)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            ret = max(ret, coins);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125; image;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    image.read();</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, image.hough_circle());</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b448" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/04/zj-b448/" class="article-date">
  <time datetime="2015-08-04T00:03:42.000Z" itemprop="datePublished">2015-08-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/04/zj-b448/">b448. 哈哈鏡</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/08/04/zj-b448/" data-id="ckq8nozzz013y1wvnww46h0gw" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/08/04/zj-b448/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/影像處理/">影像處理</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>進行圖片變形，效果類似哈哈鏡的作用。</p>
<p>對圖片水平中線進行座標 <code>y&#39; = sqrt(y)</code> 變換，將靠近中線的像素盡可能地拉往中間，形成延伸的變形效果。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">1 1</div><div class="line">1 2 3</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">1 1</div><div class="line">1 2 3</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>計算公式</p>
<ul>
<li>中線之上 <code>(H/2) - pow(i-H/2, 2)/ (H/2)</code></li>
<li>中線之下 <code>pow(i-H/2, 2)/ (H/2) + H/2</code></li>
</ul>
<p>分別套用後，逆轉換到原圖上，進行最近鄰居查找，。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">IMAGE</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Pixel</span> &#123;</span></div><div class="line">        <span class="keyword">int</span> r, g, b;</div><div class="line">        Pixel(<span class="keyword">int</span> x = <span class="number">0</span>, <span class="keyword">int</span> y = <span class="number">0</span>, <span class="keyword">int</span> z = <span class="number">0</span>):</div><div class="line">        r(x), g(y), b(z) &#123;&#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;r, &amp;g, &amp;b);</div><div class="line">        &#125;</div><div class="line">        Pixel <span class="keyword">operator</span>-(<span class="keyword">const</span> Pixel &amp;x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> Pixel(r-x.r, g-x.g, b-x.b);</div><div class="line">        &#125;</div><div class="line">        Pixel <span class="keyword">operator</span>+(<span class="keyword">const</span> Pixel &amp;x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> Pixel(r+x.r, g+x.g, b+x.b);</div><div class="line">        &#125;</div><div class="line">        Pixel <span class="keyword">operator</span>*(<span class="keyword">const</span> <span class="keyword">double</span> x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> Pixel(r*x, g*x, b*x);</div><div class="line">        &#125;</div><div class="line">        Pixel <span class="keyword">operator</span>/(<span class="keyword">const</span> <span class="keyword">double</span> x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> Pixel(r/x, g/x, b/x);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> Pixel &amp;x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> r == x.r &amp;&amp; g == x.g &amp;&amp; b == x.b;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d %d %d"</span>, r, g, b);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> r + g + b;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">length</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="built_in">abs</span>(r) + <span class="built_in">abs</span>(g) + <span class="built_in">abs</span>(b);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">dist</span><span class="params">(Pixel x)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="built_in">abs</span>((r + g + b) - (x.r + x.g + x.b));</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">int</span> W, H;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">256</span>;</div><div class="line">    Pixel data[MAXN][MAXN], tmp[MAXN][MAXN];</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;W, &amp;H);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++)</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++)</div><div class="line">                data[i][j].read();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, W, H);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++)</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++)</div><div class="line">                data[i][j].print(), <span class="built_in">printf</span>(<span class="string">"%c"</span>, j == W<span class="number">-1</span> ? <span class="string">'\n'</span> : <span class="string">' '</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">isValid</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> x &gt;= <span class="number">0</span> &amp;&amp; y &gt;= <span class="number">0</span> &amp;&amp; x &lt; H &amp;&amp; y &lt; W;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">distorting_mirror</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> rW = W, rH = H;</div><div class="line">        <span class="keyword">double</span> ch = H / <span class="number">2.0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rH; i++) &#123;</div><div class="line">            <span class="keyword">double</span> x, y;</div><div class="line">            <span class="keyword">if</span> (i &lt; ch)</div><div class="line">                x = ch - <span class="built_in">pow</span>(i-ch, <span class="number">2</span>)/ch;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                x = <span class="built_in">pow</span>(i-ch, <span class="number">2</span>)/ch + ch;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; rW; j++) &#123;</div><div class="line">                y = j;</div><div class="line">                <span class="keyword">int</span> lx, rx, ly, ry;</div><div class="line">                lx = <span class="built_in">floor</span>(x), rx = <span class="built_in">ceil</span>(x);</div><div class="line">                ly = <span class="built_in">floor</span>(y), ry = <span class="built_in">ceil</span>(y);</div><div class="line">                <span class="keyword">int</span> px[] = &#123;lx, lx, rx, rx&#125;;</div><div class="line">                <span class="keyword">int</span> py[] = &#123;ly, ry, ly, ry&#125;;</div><div class="line">                <span class="keyword">int</span> c = <span class="number">-1</span>;</div><div class="line">                <span class="keyword">double</span> mndist = <span class="number">1e+30</span>;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">4</span>; k++) &#123;</div><div class="line">                    <span class="keyword">if</span> (!isValid(px[k], py[k]))</div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                    <span class="keyword">double</span> d = (x-px[k])*(x-px[k])+(y-py[k])*(y-py[k]);</div><div class="line">                    <span class="keyword">if</span> (c == <span class="number">-1</span> || mndist &gt; d)</div><div class="line">                        c = k, mndist = d;</div><div class="line">                &#125;</div><div class="line">                assert (c &gt;= <span class="number">0</span>);</div><div class="line">                tmp[i][j] = data[px[c]][py[c]];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        W = rW, H = rH;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++) &#123;</div><div class="line">                data[i][j] = tmp[i][j];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125; image;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    image.read();</div><div class="line">    image.distorting_mirror();</div><div class="line">    image.print();</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-hdu-5307" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/04/hdu-5307/" class="article-date">
  <time datetime="2015-08-03T23:25:31.000Z" itemprop="datePublished">2015-08-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/04/hdu-5307/">HDU 5307 - He is Flying</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/08/04/hdu-5307/" data-id="ckq8nozli00591wvn5m975k7r" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/08/04/hdu-5307/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CRT/">CRT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FFT/">FFT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NTT/">NTT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/快速傅立葉/">快速傅立葉</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/快速數論變換/">快速數論變換</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p><a href="http://acm.hdu.edu.cn/showproblem.php?pid=5307" target="_blank" rel="external">題目連結</a>，加速以下的程序計算，下方程式需要 <span>$O(N^3)$</span><!-- Has MathJax -->，若用前綴維護總和也需要 <span>$O(N^2)$</span><!-- Has MathJax -->。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">for l = 0 to n-1</div><div class="line">    for r = l+1 to n-1</div><div class="line">        sum = 0</div><div class="line">        for k = l to r</div><div class="line">            sum += A[k]</div><div class="line">        ret[sum] += r-l+1</div></pre></td></tr></table></figure>
<p>最後輸出所有 <code>ret[sum]</code> 的對應結果。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">2</div><div class="line">3</div><div class="line">1 2 3</div><div class="line">4</div><div class="line">0 1 2 3</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">0</div><div class="line">1</div><div class="line">1</div><div class="line">3</div><div class="line">0</div><div class="line">2</div><div class="line">3</div><div class="line">1</div><div class="line">3</div><div class="line">1</div><div class="line">6</div><div class="line">0</div><div class="line">2</div><div class="line">7</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>由於是一個很樸素的計算，為了加速運算不套點資料結構和算法是不行的。看到對於每一個結果都要輸出，因此可以想到快速傅立葉 FFT 的旋積計算，接下來就要思考如何構造多項式 (向量)。</p>
<p>假設前 <span>$i$</span><!-- Has MathJax --> 個數字的前綴和<span>$s_i$</span><!-- Has MathJax -->，為了要計數反應在係數，而索引值要反應在項數，因此得到兩個 <span>$x$</span><!-- Has MathJax --> 多項式相乘，若要統計區間 <span>$[l, r]$</span><!-- Has MathJax --> 的總和，則反應在<span>$(i - j) x^{s_i} \times x^{- s_j} = (i-j) x^{s_i - s_j}$</span><!-- Has MathJax -->。但這樣的計算無法一次完成，因此要拆成兩次計算，分別得到<span>$i x^{s_i - s_j}$</span><!-- Has MathJax --> 和<span>$-j x^{s_i - s_j}$</span><!-- Has MathJax -->。</p>
<p>明顯地前者構造<span>$(\sum i x^s_i) \times (\sum x^{-s_j})$</span><!-- Has MathJax -->，後者構造<span>$(\sum x^s_i) \times (\sum -j x^{-s_j})$</span><!-- Has MathJax -->，利用快速傅立葉 <span>$O(n \log n)$</span><!-- Has MathJax --> 計算多項式相乘，隨後相扣即可。</p>
<p>特別注意到總和 0 要特別判斷，因為構造法無法計算。此外這題非常講究精準度，可以利用 NTT/FNT 全部都在整數運算，又或者使用 FFT 在 <code>double</code> 形態下完成，特別小心 FFT 通常會利用角度疊加 (合角公式) 來加速運算，但不幸地這裡會遇到精準度誤差，必須採用 cos, sin 全建表。其他人容易遇到要用 <code>long double</code> 取代 <code>double</code> 計算是因為這種寫法的問題。</p>
<h3 id="FFT"><a href="#FFT" class="headerlink" title="FFT"></a>FFT</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;complex&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="class"><span class="keyword">class</span> <span class="title">TOOL_FFT</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> UINT32;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 262144</span></div><div class="line">    <span class="keyword">complex</span>&lt;T&gt; p[<span class="number">2</span>][MAXN];</div><div class="line">    <span class="keyword">int</span> pre_n;</div><div class="line">    T PI;</div><div class="line">    TOOL_FFT() &#123;</div><div class="line">        pre_n = <span class="number">0</span>;</div><div class="line">        PI = <span class="built_in">acos</span>(<span class="number">-1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">NumberOfBitsNeeded</span><span class="params">(<span class="keyword">int</span> PowerOfTwo)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; ; ++i) &#123;</div><div class="line">            <span class="keyword">if</span> (PowerOfTwo &amp; (<span class="number">1</span> &lt;&lt; i)) &#123;</div><div class="line">                <span class="keyword">return</span> i;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> UINT32 <span class="title">FastReverseBits</span><span class="params">(UINT32 a, <span class="keyword">int</span> NumBits)</span> </span>&#123;</div><div class="line">        a = ( ( a &amp; <span class="number">0x55555555</span>U ) &lt;&lt; <span class="number">1</span> ) | ( ( a &amp; <span class="number">0xAAAAAAAA</span>U ) &gt;&gt; <span class="number">1</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x33333333</span>U ) &lt;&lt; <span class="number">2</span> ) | ( ( a &amp; <span class="number">0xCCCCCCCC</span>U ) &gt;&gt; <span class="number">2</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x0F0F0F0F</span>U ) &lt;&lt; <span class="number">4</span> ) | ( ( a &amp; <span class="number">0xF0F0F0F0</span>U ) &gt;&gt; <span class="number">4</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x00FF00FF</span>U ) &lt;&lt; <span class="number">8</span> ) | ( ( a &amp; <span class="number">0xFF00FF00</span>U ) &gt;&gt; <span class="number">8</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x0000FFFF</span>U ) &lt;&lt; <span class="number">16</span> ) | ( ( a &amp; <span class="number">0xFFFF0000</span>U ) &gt;&gt; <span class="number">16</span> ) ;</div><div class="line">        <span class="keyword">return</span> a &gt;&gt; (<span class="number">32</span> - NumBits);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">FFT</span><span class="params">(<span class="keyword">bool</span> InverseTransform, <span class="built_in">vector</span>&lt;<span class="keyword">complex</span>&lt;T&gt; &gt;&amp; In, <span class="built_in">vector</span>&lt;<span class="keyword">complex</span>&lt;T&gt; &gt;&amp; Out)</span> </span>&#123;</div><div class="line">        <span class="comment">// simultaneous data copy and bit-reversal ordering into outputs</span></div><div class="line">        <span class="keyword">int</span> NumSamples = In.size();</div><div class="line">        <span class="keyword">int</span> NumBits = NumberOfBitsNeeded(NumSamples);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NumSamples; ++i) &#123;</div><div class="line">            Out[FastReverseBits(i, NumBits)] = In[i];</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// the FFT process</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">register</span> <span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= NumBits; i++) &#123;</div><div class="line">            <span class="keyword">int</span> BlockSize = <span class="number">1</span>&lt;&lt;i, BlockEnd = BlockSize&gt;&gt;<span class="number">1</span>, BlockCnt = NumSamples/BlockSize;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">register</span> <span class="keyword">int</span> j = <span class="number">0</span>; j &lt; NumSamples; j += BlockSize) &#123;</div><div class="line">                <span class="keyword">complex</span>&lt;T&gt; *t = p[InverseTransform];</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">register</span> <span class="keyword">int</span> k = <span class="number">0</span>; k &lt; BlockEnd; k++, t += BlockCnt) &#123;</div><div class="line">                    <span class="keyword">complex</span>&lt;T&gt; a = (*t) * Out[k+j+BlockEnd];</div><div class="line">                    Out[k+j+BlockEnd] = Out[k+j] - a;</div><div class="line">                    Out[k+j] += a;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// normalize if inverse transform</span></div><div class="line">        <span class="keyword">if</span> (InverseTransform) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NumSamples; ++i) &#123;</div><div class="line">                Out[i] /= NumSamples;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">prework</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (pre_n == n)</div><div class="line">            <span class="keyword">return</span> ;</div><div class="line">        pre_n = n;</div><div class="line">        p[<span class="number">0</span>][<span class="number">0</span>] = <span class="keyword">complex</span>&lt;T&gt;(<span class="number">1</span>, <span class="number">0</span>);</div><div class="line">        p[<span class="number">1</span>][<span class="number">0</span>] = <span class="keyword">complex</span>&lt;T&gt;(<span class="number">1</span>, <span class="number">0</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">register</span> <span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; i++) &#123;</div><div class="line">            p[<span class="number">0</span>][i] = <span class="keyword">complex</span>&lt;T&gt;(<span class="built_in">cos</span>(<span class="number">2</span>*i*PI / n ) , <span class="built_in">sin</span>(<span class="number">2</span>*i*PI / n ));</div><div class="line">            p[<span class="number">1</span>][i] = <span class="keyword">complex</span>&lt;T&gt;(<span class="built_in">cos</span>(<span class="number">2</span>*i*PI / n ) , -<span class="built_in">sin</span>(<span class="number">2</span>*i*PI / n ));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">vector</span>&lt;T&gt; convolution(<span class="keyword">complex</span>&lt;T&gt; *a, <span class="keyword">complex</span>&lt;T&gt; *b, <span class="keyword">int</span> n) &#123;</div><div class="line">        prework(n);</div><div class="line">        <span class="built_in">vector</span>&lt; <span class="keyword">complex</span>&lt;T&gt; &gt; s(a, a+n), d1(n), d2(n), y(n);</div><div class="line">        <span class="built_in">vector</span>&lt;T&gt; ret(n);</div><div class="line">        FFT(<span class="literal">false</span>, s, d1);</div><div class="line">        s[<span class="number">0</span>] = b[<span class="number">0</span>];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, j = n<span class="number">-1</span>; i &lt; n; ++i, --j)</div><div class="line">            s[i] = b[j];</div><div class="line">        FFT(<span class="literal">false</span>, s, d2);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</div><div class="line">            y[i] = d1[i] * d2[i];</div><div class="line">        &#125;</div><div class="line">        FFT(<span class="literal">true</span>, y, s);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</div><div class="line">            ret[i] = s[i].real();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">TOOL_FFT&lt;<span class="keyword">double</span>&gt; tool;</div><div class="line"></div><div class="line"><span class="keyword">complex</span>&lt;<span class="keyword">double</span>&gt; a[MAXN], b[MAXN];</div><div class="line"><span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt; c;</div><div class="line"><span class="keyword">int</span> A[MAXN], sum[MAXN];</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> ret[MAXN], pr[<span class="number">262144</span>];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    pr[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; MAXN; i++)</div><div class="line">        pr[i] = pr[i<span class="number">-1</span>] + (<span class="keyword">long</span> <span class="keyword">long</span>)i*(i+<span class="number">1</span>)/<span class="number">2</span>;</div><div class="line">    <span class="keyword">int</span> testcase, n, m, s;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;testcase);</div><div class="line">    <span class="keyword">while</span> (testcase--) &#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;A[i]);</div><div class="line">        sum[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</div><div class="line">            sum[i] = sum[i<span class="number">-1</span>] + A[i];</div><div class="line">        </div><div class="line">        s = sum[n];</div><div class="line">        <span class="built_in">memset</span>(ret, <span class="number">0</span>, <span class="keyword">sizeof</span>(ret[<span class="number">0</span>]) * (s+<span class="number">1</span>));</div><div class="line">        <span class="keyword">for</span> (m = <span class="number">1</span>; m &lt;= (s&lt;&lt;<span class="number">1</span>); m &lt;&lt;= <span class="number">1</span>);</div><div class="line">        </div><div class="line">        <span class="built_in">memset</span>(a, <span class="number">0</span>, <span class="keyword">sizeof</span>(a[<span class="number">0</span>])*m);</div><div class="line">        <span class="built_in">memset</span>(b, <span class="number">0</span>, <span class="keyword">sizeof</span>(b[<span class="number">0</span>])*m);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            a[sum[i]] += <span class="keyword">complex</span>&lt;<span class="keyword">double</span>&gt;(i, <span class="number">0</span>);</div><div class="line">            b[sum[i<span class="number">-1</span>]] += <span class="keyword">complex</span>&lt;<span class="keyword">double</span>&gt;(<span class="number">1</span>, <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        c = tool.convolution(a, b, m);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; m; i++)</div><div class="line">            ret[i] += round(c[i]);</div><div class="line"></div><div class="line">        <span class="built_in">memset</span>(a, <span class="number">0</span>, <span class="keyword">sizeof</span>(a[<span class="number">0</span>])*m);</div><div class="line">        <span class="built_in">memset</span>(b, <span class="number">0</span>, <span class="keyword">sizeof</span>(b[<span class="number">0</span>])*m);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            a[sum[i]] += <span class="keyword">complex</span>&lt;<span class="keyword">double</span>&gt;(<span class="number">1</span>, <span class="number">0</span>);</div><div class="line">            b[sum[i<span class="number">-1</span>]] += <span class="keyword">complex</span>&lt;<span class="keyword">double</span>&gt;(i<span class="number">-1</span>, <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">        c = tool.convolution(a, b, m);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= s; i++)</div><div class="line">            ret[i] -= round(c[i]);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, z = <span class="number">0</span>; i &lt;= n+<span class="number">1</span>; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (i == n+<span class="number">1</span> || A[i] != <span class="number">0</span>)</div><div class="line">                ret[<span class="number">0</span>] += pr[z], z = <span class="number">0</span>;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                z++;</div><div class="line">        &#125;        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= s; i++) &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, ret[i]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="NTT"><a href="#NTT" class="headerlink" title="NTT"></a>NTT</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> UINT32;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> INT64;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TOOL_NTT</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 262144</span></div><div class="line">    <span class="keyword">const</span> INT64 P = <span class="number">50000000001507329L</span>L; <span class="comment">// prime m = kn+1</span></div><div class="line">    <span class="keyword">const</span> INT64 G = <span class="number">3</span>;</div><div class="line">    INT64 wn[<span class="number">20</span>];</div><div class="line">    INT64 s[MAXN], d1[MAXN], d2[MAXN], y[MAXN];</div><div class="line">    TOOL_NTT() &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++)</div><div class="line">            wn[i] = mod_pow(G, (P<span class="number">-1</span>) / (<span class="number">1</span>&lt;&lt;i), P);</div><div class="line">    &#125;</div><div class="line">    <span class="function">INT64 <span class="title">mod_mul</span><span class="params">(INT64 a, INT64 b, INT64 mod)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (a*b - (<span class="keyword">long</span> <span class="keyword">long</span>)(a/(<span class="keyword">long</span> <span class="keyword">double</span>)mod*b+<span class="number">1e-3</span>)*mod+mod)%mod;</div><div class="line">        <span class="comment">//      INT64 ret = 0;</span></div><div class="line">        <span class="comment">//      for (a = a &gt;= mod ? a%mod : a, b = b &gt;= mod ? b%mod : b; b != 0; b&gt;&gt;=1, a &lt;&lt;= 1, a = a &gt;= mod ? a - mod : a) &#123;</span></div><div class="line">        <span class="comment">//          if (b&amp;1) &#123;</span></div><div class="line">        <span class="comment">//              ret += a;</span></div><div class="line">        <span class="comment">//              if (ret &gt;= mod)</span></div><div class="line">        <span class="comment">//                  ret -= mod;</span></div><div class="line">        <span class="comment">//          &#125;</span></div><div class="line">        <span class="comment">//      &#125;</span></div><div class="line">        <span class="comment">//      return ret;</span></div><div class="line">    &#125;</div><div class="line">    <span class="function">INT64 <span class="title">mod_pow</span><span class="params">(INT64 n, INT64 e, INT64 m)</span> </span>&#123;</div><div class="line">        INT64 x = <span class="number">1</span>;</div><div class="line">        <span class="keyword">for</span> (n = n &gt;= m ? n%m : n; e; e &gt;&gt;= <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (e&amp;<span class="number">1</span>)</div><div class="line">                x = mod_mul(x, n, m);</div><div class="line">            n = mod_mul(n, n, m);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> x;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">NumberOfBitsNeeded</span><span class="params">(<span class="keyword">int</span> PowerOfTwo)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;; ++i) &#123;</div><div class="line">            <span class="keyword">if</span> (PowerOfTwo &amp; (<span class="number">1</span> &lt;&lt; i)) &#123;</div><div class="line">                <span class="keyword">return</span> i;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> UINT32 <span class="title">FastReverseBits</span><span class="params">(UINT32 a, <span class="keyword">int</span> NumBits)</span> </span>&#123;</div><div class="line">        a = ( ( a &amp; <span class="number">0x55555555</span>U ) &lt;&lt; <span class="number">1</span> ) | ( ( a &amp; <span class="number">0xAAAAAAAA</span>U ) &gt;&gt; <span class="number">1</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x33333333</span>U ) &lt;&lt; <span class="number">2</span> ) | ( ( a &amp; <span class="number">0xCCCCCCCC</span>U ) &gt;&gt; <span class="number">2</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x0F0F0F0F</span>U ) &lt;&lt; <span class="number">4</span> ) | ( ( a &amp; <span class="number">0xF0F0F0F0</span>U ) &gt;&gt; <span class="number">4</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x00FF00FF</span>U ) &lt;&lt; <span class="number">8</span> ) | ( ( a &amp; <span class="number">0xFF00FF00</span>U ) &gt;&gt; <span class="number">8</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x0000FFFF</span>U ) &lt;&lt; <span class="number">16</span> ) | ( ( a &amp; <span class="number">0xFFFF0000</span>U ) &gt;&gt; <span class="number">16</span> ) ;</div><div class="line">        <span class="keyword">return</span> a &gt;&gt; (<span class="number">32</span> - NumBits);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">NTT</span><span class="params">(<span class="keyword">int</span> on, INT64 *In, INT64 *Out, <span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> NumBits = NumberOfBitsNeeded(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</div><div class="line">            Out[FastReverseBits(i, NumBits)] = In[i];</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> h = <span class="number">2</span>, id = <span class="number">1</span>; h &lt;= n; h &lt;&lt;= <span class="number">1</span>, id++) &#123;</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j += h) &#123;</div><div class="line">                INT64 w = <span class="number">1</span>, u, t;</div><div class="line">                <span class="keyword">int</span> block = h/<span class="number">2</span>, blockEnd = j + h/<span class="number">2</span>;</div><div class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> k = j; k &lt; blockEnd; k++) &#123;</div><div class="line">                    u = Out[k], t = mod_mul(w, Out[k+block], P);</div><div class="line">                    Out[k] = u + t;</div><div class="line">                    Out[k + block] = u - t + P;</div><div class="line">                    <span class="keyword">if</span> (Out[k] &gt;= P)        Out[k] -= P;</div><div class="line">                    <span class="keyword">if</span> (Out[k+block] &gt;= P)  Out[k+block] -= P;</div><div class="line">                    w = mod_mul(w, wn[id], P);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (on == <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n/<span class="number">2</span>; i++)</div><div class="line">                swap(Out[i], Out[n-i]);</div><div class="line">            INT64 invn = mod_pow(n, P<span class="number">-2</span>, P);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">                Out[i] = mod_mul(Out[i], invn, P);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">convolution</span><span class="params">(INT64 *a, INT64 *b, <span class="keyword">int</span> n, INT64 *c)</span> </span>&#123;</div><div class="line">        NTT(<span class="number">0</span>, a, d1, n);</div><div class="line">        s[<span class="number">0</span>] = b[<span class="number">0</span>];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++i)</div><div class="line">            s[i] = b[n-i];</div><div class="line">        NTT(<span class="number">0</span>, s, d2, n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            s[i] = mod_mul(d1[i], d2[i], P);</div><div class="line">        NTT(<span class="number">1</span>, s, c, n);</div><div class="line">    &#125;</div><div class="line">&#125; tool;</div><div class="line"></div><div class="line">INT64 a[MAXN], b[MAXN], c[MAXN];</div><div class="line"><span class="keyword">int</span> A[MAXN], sum[MAXN];</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> ret[MAXN], pr[<span class="number">262144</span>];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    pr[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; MAXN; i++)</div><div class="line">        pr[i] = pr[i<span class="number">-1</span>] + (<span class="keyword">long</span> <span class="keyword">long</span>)i*(i+<span class="number">1</span>)/<span class="number">2</span>;</div><div class="line">    <span class="keyword">int</span> testcase, n, m, s;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;testcase);</div><div class="line">    <span class="keyword">while</span> (testcase--) &#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;A[i]);</div><div class="line">        sum[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</div><div class="line">            sum[i] = sum[i<span class="number">-1</span>] + A[i];</div><div class="line">        </div><div class="line">        s = sum[n];</div><div class="line">        <span class="built_in">memset</span>(ret, <span class="number">0</span>, <span class="keyword">sizeof</span>(ret[<span class="number">0</span>]) * (s+<span class="number">1</span>));</div><div class="line">        <span class="keyword">for</span> (m = <span class="number">1</span>; m &lt;= (s&lt;&lt;<span class="number">1</span>); m &lt;&lt;= <span class="number">1</span>);</div><div class="line">        </div><div class="line">        <span class="built_in">memset</span>(a, <span class="number">0</span>, <span class="keyword">sizeof</span>(a[<span class="number">0</span>])*m);</div><div class="line">        <span class="built_in">memset</span>(b, <span class="number">0</span>, <span class="keyword">sizeof</span>(b[<span class="number">0</span>])*m);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            a[sum[i]] += i;</div><div class="line">            b[sum[i<span class="number">-1</span>]] ++;</div><div class="line">        &#125;</div><div class="line">        tool.convolution(a, b, m, c);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; m; i++)</div><div class="line">            ret[i] += c[i];</div><div class="line"></div><div class="line">        <span class="built_in">memset</span>(a, <span class="number">0</span>, <span class="keyword">sizeof</span>(a[<span class="number">0</span>])*m);</div><div class="line">        <span class="built_in">memset</span>(b, <span class="number">0</span>, <span class="keyword">sizeof</span>(b[<span class="number">0</span>])*m);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            a[sum[i]] ++;</div><div class="line">            b[sum[i<span class="number">-1</span>]] += i<span class="number">-1</span>;</div><div class="line">        &#125;</div><div class="line">        tool.convolution(a, b, m, c);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= s; i++)</div><div class="line">            ret[i] -= c[i];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, z = <span class="number">0</span>; i &lt;= n+<span class="number">1</span>; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (i == n+<span class="number">1</span> || A[i] != <span class="number">0</span>)</div><div class="line">                ret[<span class="number">0</span>] += pr[z], z = <span class="number">0</span>;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                z++;</div><div class="line">        &#125;        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= s; i++) &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, ret[i]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="NTT-CRT"><a href="#NTT-CRT" class="headerlink" title="NTT CRT"></a>NTT CRT</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">uint_fast32_t</span> UINT32;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> INT64;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">uint_fast32_t</span> INT32;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TOOL_NTT</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 262144</span></div><div class="line">    <span class="comment">//  INT64 P = 50000000001507329LL; // prime m = kn+1</span></div><div class="line">    <span class="comment">//  INT64 G = 3;</span></div><div class="line">    INT32 P = <span class="number">3</span>, G = <span class="number">2</span>;</div><div class="line">    INT32 wn[<span class="number">20</span>];</div><div class="line">    INT32 s[MAXN], d1[MAXN], d2[MAXN], c1[MAXN], c2[MAXN];</div><div class="line">    <span class="keyword">const</span> INT32 P1 = <span class="number">998244353</span>; <span class="comment">// P1 = 2^23 * 7 * 17 + 1</span></div><div class="line">    <span class="keyword">const</span> INT32 G1 = <span class="number">3</span>;</div><div class="line">    <span class="keyword">const</span> INT32 P2 = <span class="number">995622913</span>; <span class="comment">// P2 = 2^19 *3*3*211 + 1</span></div><div class="line">    <span class="keyword">const</span> INT32 G2 = <span class="number">5</span>;</div><div class="line">    <span class="keyword">const</span> INT64 M1 = <span class="number">397550359381069386L</span>L;</div><div class="line">    <span class="keyword">const</span> INT64 M2 = <span class="number">596324591238590904L</span>L;</div><div class="line">    <span class="keyword">const</span> INT64 MM = <span class="number">993874950619660289L</span>L; <span class="comment">// MM = P1*P2</span></div><div class="line">    TOOL_NTT() &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++)</div><div class="line">            wn[i] = mod_pow(G, (P<span class="number">-1</span>) / (<span class="number">1</span>&lt;&lt;i), P);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reset</span><span class="params">(INT32 p, INT32 g)</span> </span>&#123;</div><div class="line">        P = p, G = g;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++)</div><div class="line">            wn[i] = mod_pow(G, (P<span class="number">-1</span>) / (<span class="number">1</span>&lt;&lt;i), P);</div><div class="line">    &#125;</div><div class="line">    <span class="function">INT64 <span class="title">mod_mul</span><span class="params">(INT64 a, INT64 b, INT64 mod)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (a*b - (<span class="keyword">long</span> <span class="keyword">long</span>)(a/(<span class="keyword">long</span> <span class="keyword">double</span>)mod*b+<span class="number">1e-3</span>)*mod+mod)%mod;</div><div class="line">        <span class="comment">//      INT64 ret = 0;</span></div><div class="line">        <span class="comment">//      for (a = a &gt;= mod ? a%mod : a, b = b &gt;= mod ? b%mod : b; b != 0; b&gt;&gt;=1, a &lt;&lt;= 1, a = a &gt;= mod ? a - mod : a) &#123;</span></div><div class="line">        <span class="comment">//          if (b&amp;1) &#123;</span></div><div class="line">        <span class="comment">//              ret += a;</span></div><div class="line">        <span class="comment">//              if (ret &gt;= mod)</span></div><div class="line">        <span class="comment">//                  ret -= mod;</span></div><div class="line">        <span class="comment">//          &#125;</span></div><div class="line">        <span class="comment">//      &#125;</span></div><div class="line">        <span class="comment">//      return ret;</span></div><div class="line">    &#125;</div><div class="line">    <span class="function">INT64 <span class="title">mod_pow</span><span class="params">(INT64 n, INT64 e, INT64 m)</span> </span>&#123;</div><div class="line">        INT64 x = <span class="number">1</span>;</div><div class="line">        <span class="keyword">for</span> (n = n &gt;= m ? n%m : n; e; e &gt;&gt;= <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (e&amp;<span class="number">1</span>)</div><div class="line">                x = mod_mul(x, n, m);</div><div class="line">            n = mod_mul(n, n, m);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> x;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">NumberOfBitsNeeded</span><span class="params">(<span class="keyword">int</span> PowerOfTwo)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;; ++i) &#123;</div><div class="line">            <span class="keyword">if</span> (PowerOfTwo &amp; (<span class="number">1</span> &lt;&lt; i)) &#123;</div><div class="line">                <span class="keyword">return</span> i;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> UINT32 <span class="title">FastReverseBits</span><span class="params">(UINT32 a, <span class="keyword">int</span> NumBits)</span> </span>&#123;</div><div class="line">        a = ( ( a &amp; <span class="number">0x55555555</span>U ) &lt;&lt; <span class="number">1</span> ) | ( ( a &amp; <span class="number">0xAAAAAAAA</span>U ) &gt;&gt; <span class="number">1</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x33333333</span>U ) &lt;&lt; <span class="number">2</span> ) | ( ( a &amp; <span class="number">0xCCCCCCCC</span>U ) &gt;&gt; <span class="number">2</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x0F0F0F0F</span>U ) &lt;&lt; <span class="number">4</span> ) | ( ( a &amp; <span class="number">0xF0F0F0F0</span>U ) &gt;&gt; <span class="number">4</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x00FF00FF</span>U ) &lt;&lt; <span class="number">8</span> ) | ( ( a &amp; <span class="number">0xFF00FF00</span>U ) &gt;&gt; <span class="number">8</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x0000FFFF</span>U ) &lt;&lt; <span class="number">16</span> ) | ( ( a &amp; <span class="number">0xFFFF0000</span>U ) &gt;&gt; <span class="number">16</span> ) ;</div><div class="line">        <span class="keyword">return</span> a &gt;&gt; (<span class="number">32</span> - NumBits);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">NTT</span><span class="params">(<span class="keyword">int</span> on, INT32 *In, INT32 *Out, <span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> NumBits = NumberOfBitsNeeded(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</div><div class="line">            Out[FastReverseBits(i, NumBits)] = In[i];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> h = <span class="number">2</span>, id = <span class="number">1</span>; h &lt;= n; h &lt;&lt;= <span class="number">1</span>, id++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j += h) &#123;</div><div class="line">                INT32 w = <span class="number">1</span>, u, t;</div><div class="line">                <span class="keyword">int</span> block = h/<span class="number">2</span>, blockEnd = j + h/<span class="number">2</span>;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = j; k &lt; blockEnd; k++) &#123;</div><div class="line">                    u = Out[k], t = (INT64)w*Out[k+block]%P;</div><div class="line">                    Out[k] = (u + t)%P;</div><div class="line">                    Out[k+block] = (u - t + P)%P;</div><div class="line">                    w = (INT64)w * wn[id]%P;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (on == <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n/<span class="number">2</span>; i++)</div><div class="line">                swap(Out[i], Out[n-i]);</div><div class="line">            INT32 invn = mod_pow(n, P<span class="number">-2</span>, P);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">                Out[i] = (INT64)Out[i]*invn%P;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function">INT64 <span class="title">crt</span><span class="params">(INT32 a, INT32 b)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (mod_mul(a, M1, MM) + mod_mul(b, M2, MM))%MM;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">convolution</span><span class="params">(INT32 *a, INT32 *b, <span class="keyword">int</span> n, INT64 *c)</span> </span>&#123;</div><div class="line">        reset(P1, G1);</div><div class="line">        NTT(<span class="number">0</span>, a, d1, n);</div><div class="line">        s[<span class="number">0</span>] = b[<span class="number">0</span>];    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++i) s[i] = b[n-i];</div><div class="line">        NTT(<span class="number">0</span>, s, d2, n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) s[i] = (INT64)d1[i] * d2[i]%P;</div><div class="line">        NTT(<span class="number">1</span>, s, c1, n);</div><div class="line">        reset(P2, G2);</div><div class="line">        NTT(<span class="number">0</span>, a, d1, n);</div><div class="line">        s[<span class="number">0</span>] = b[<span class="number">0</span>];    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++i) s[i] = b[n-i];</div><div class="line">        NTT(<span class="number">0</span>, s, d2, n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) s[i] = (INT64)d1[i] * d2[i]%P;</div><div class="line">        NTT(<span class="number">1</span>, s, c2, n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            c[i] = crt(c1[i], c2[i]);</div><div class="line">    &#125;</div><div class="line">&#125; tool;</div><div class="line">INT32 a[<span class="number">262144</span>], b[<span class="number">262144</span>];</div><div class="line">INT64 c[<span class="number">262144</span>];</div><div class="line"><span class="keyword">int</span> A[MAXN], sum[MAXN];</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> ret[MAXN], pr[<span class="number">262144</span>];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    pr[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; MAXN; i++)</div><div class="line">        pr[i] = pr[i<span class="number">-1</span>] + (<span class="keyword">long</span> <span class="keyword">long</span>)i*(i+<span class="number">1</span>)/<span class="number">2</span>;</div><div class="line">    <span class="keyword">int</span> testcase, n, m, s;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;testcase);</div><div class="line">    <span class="keyword">while</span> (testcase--) &#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;A[i]);</div><div class="line">        </div><div class="line">        sum[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</div><div class="line">            sum[i] = sum[i<span class="number">-1</span>] + A[i];</div><div class="line">        </div><div class="line">        s = sum[n];</div><div class="line">        <span class="built_in">memset</span>(ret, <span class="number">0</span>, <span class="keyword">sizeof</span>(ret[<span class="number">0</span>]) * (s+<span class="number">1</span>));</div><div class="line">        <span class="keyword">for</span> (m = <span class="number">1</span>; m &lt;= (s&lt;&lt;<span class="number">1</span>); m &lt;&lt;= <span class="number">1</span>);</div><div class="line">        </div><div class="line">        <span class="built_in">memset</span>(a, <span class="number">0</span>, <span class="keyword">sizeof</span>(a[<span class="number">0</span>])*m);</div><div class="line">        <span class="built_in">memset</span>(b, <span class="number">0</span>, <span class="keyword">sizeof</span>(b[<span class="number">0</span>])*m);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            a[sum[i]] += i;</div><div class="line">            b[sum[i<span class="number">-1</span>]] ++;</div><div class="line">        &#125;</div><div class="line">        tool.convolution(a, b, m, c);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; m; i++)</div><div class="line">            ret[i] += c[i];</div><div class="line"></div><div class="line">        <span class="built_in">memset</span>(a, <span class="number">0</span>, <span class="keyword">sizeof</span>(a[<span class="number">0</span>])*m);</div><div class="line">        <span class="built_in">memset</span>(b, <span class="number">0</span>, <span class="keyword">sizeof</span>(b[<span class="number">0</span>])*m);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            a[sum[i]] ++;</div><div class="line">            b[sum[i<span class="number">-1</span>]] += i<span class="number">-1</span>;</div><div class="line">        &#125;</div><div class="line">        tool.convolution(a, b, m, c);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= s; i++)</div><div class="line">            ret[i] -= c[i];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, z = <span class="number">0</span>; i &lt;= n+<span class="number">1</span>; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (i == n+<span class="number">1</span> || A[i] != <span class="number">0</span>)</div><div class="line">                ret[<span class="number">0</span>] += pr[z], z = <span class="number">0</span>;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                z++;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= s; i++) &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, ret[i]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-a994" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/02/zj-a994/" class="article-date">
  <time datetime="2015-08-02T10:07:11.000Z" itemprop="datePublished">2015-08-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/02/zj-a994/">a994. 10325 - The Lottery</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/08/02/zj-a994/" data-id="ckq8nozym01191wvnfiqcokrq" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/08/02/zj-a994/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化/">優化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/排容原理/">排容原理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/窮舉/">窮舉</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/編譯器/">編譯器</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>模擬計算，刪除組合數字的倍數，請問剩下多少個數字可選。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">10 2</div><div class="line">2 3</div><div class="line">20 2</div><div class="line">2 4</div><div class="line">100 3</div><div class="line">3 5 7</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">3</div><div class="line">10</div><div class="line">45</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>這一題是非常容易的題目，利用排容原理可以在 <span>$O(2^m)$</span><!-- Has MathJax --> 的時間內完成，所以複雜度沒有太大的改善，若使用 bitmask 的方式撰寫，複雜度會落在 <span>$O(m \times 2^m)$</span><!-- Has MathJax -->，中間會有大量的 <code>gcd(a, b)</code> 計算，歐基里德輾轉相除法的常數並不大，時間複雜度 <span>$O(\log n)$</span><!-- Has MathJax -->。</p>
<p>為了加速運算，可以利用組合來完成，利用選用組合 <code>1011</code>，可以得到 <code>lcm(1011) = lcm(lcm(1010), A[0])</code> 完成，因此只會有 <span>$O(2^m)$</span><!-- Has MathJax --> 次 <code>gcd()</code> 的成本，整整少了常數 m。</p>
<p>因此需要使用 <code>lowbit = i&amp;(-i)</code> 的位元運算技巧，同時為了得到 2 的冪次的次方數，建議使用內置函數 <code>__builtin</code> 系列，編譯器最佳化計算。而 gcd 使用，也使用內建的 <code>__gcd(a, b)</code> 但內置函數通常只會設置在 <code>unsigned int</code> 意即 32-bits 無號整數，要防止運算 overflow。</p>
<p>有人會提案使用建表，這樣查找只需要 <span>$O(1)$</span><!-- Has MathJax -->，但記憶體置換會造成負擔，有兩個 <span>$O(2^{15})$</span><!-- Has MathJax --> 的 cache page，而且還要前置建表的計算成本。根據實驗測試，建表的方案速度會比較慢。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m, A[<span class="number">16</span>];</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> dp[<span class="number">1</span>&lt;&lt;<span class="number">15</span>], a, b;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;A[i]);</div><div class="line">        <span class="keyword">int</span> ret = n;</div><div class="line">        dp[<span class="number">0</span>] = <span class="number">1</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; (<span class="number">1</span>&lt;&lt;m); i++) &#123;</div><div class="line">            <span class="keyword">long</span> <span class="keyword">long</span> val;</div><div class="line">            a = dp[i-(i&amp;(-i))], b = A[__builtin_ffs(i&amp;(-i))];</div><div class="line">            <span class="keyword">if</span> (a &gt; n) &#123;dp[i] = n+<span class="number">1</span>; <span class="keyword">continue</span>;&#125;</div><div class="line">            val = b / __gcd(a, b) * (<span class="keyword">long</span> <span class="keyword">long</span>) a;</div><div class="line">            <span class="keyword">if</span> (val &lt;= n) &#123;</div><div class="line">                dp[i] = val;</div><div class="line">                <span class="keyword">if</span> (__builtin_popcount(i)&amp;<span class="number">1</span>)</div><div class="line">                    ret -= n / val;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    ret += n / val;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                dp[i] = n+<span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, ret);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b456" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/02/zj-b456/" class="article-date">
  <time datetime="2015-08-02T09:34:28.000Z" itemprop="datePublished">2015-08-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/02/zj-b456/">b454. 困難版 輸出 RGB 數值</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/08/02/zj-b456/" data-id="ckq8np00a014k1wvn4bd7bgvr" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/08/02/zj-b456/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/base64/">base64</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/huffman/">huffman</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lz77/">lz77</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/建表/">建表</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/影像處理/">影像處理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/資料壓縮/">資料壓縮</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/霍夫曼編碼/">霍夫曼編碼</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>給一張 <span>$45 \times 45$</span><!-- Has MathJax --> 的經典 Lena 彩色影像，共有 <span>$2025$</span><!-- Has MathJax --> 個像素，程式碼長度上限 10K，避開打表的長度限制，輸出一模一樣的圖形。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NO INPUT</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">45 45</div><div class="line">225 134 119 223 130 108 220 126 105 (後面省略)</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>由 <a href="http://zerojudge.tw/ShowProblem?problemid=b454" target="_blank" rel="external">Zerojudge b454. 請輸出這張圖片的 RGB 數值</a> 改編，強迫使用 base64 的方案，使用一般的 16 進制輸出編碼會超過限制。16 進制下，共計需要 <span>$6075$</span><!-- Has MathJax --> 個 <code>0 - 255</code> 的整數，共計需要用 <span>$12150$</span><!-- Has MathJax --> 個可視字元。</p>
<p>根據前一題的實驗，雖然霍夫曼編碼會比較短，但是還要附加解壓縮的代碼一起上傳，除非寫短碼否則很容易虧本。而 lz77 是不錯的壓縮方案，但用在影像中很容易虧本，因為重複的片段並不高。因此最後選擇直接使用 base64，則可視字元數量可以降到 10K 以下，接下來就比誰的短碼能力好。</p>
<p>base64 只用到 <code>0-9a-zA-Z+/=</code> 這 64 個字元，為了在一般 <code>C/C++</code> 的字串宣告語法，跳逸字元如 <code>\\</code>、<code>\t</code>、<code>\n</code> … 等必須用兩個字元表示，通常都是在 <code>ASCII [0, 31]</code> 為跳逸字元。蔡神 asas 直接用連續片段，因此會有一些跳逸字元，儘管跳逸字元占用兩個以上的字符，會多好幾個字元，但就不必編寫解碼程序，不用去寫繁複的映射，代碼居然比較短。</p>
<h3 id="產生器"><a href="#產生器" class="headerlink" title="產生器"></a>產生器</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;set&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lz77_encode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line">    m = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (n &lt;= <span class="number">16</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            out[m++] = in[i];</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">memcpy</span>(out, in, <span class="number">16</span>);</div><div class="line">    m += <span class="number">16</span>;</div><div class="line">    <span class="keyword">while</span> (n &gt; <span class="number">16</span>) &#123;</div><div class="line">        <span class="keyword">int</span> mx = <span class="number">0</span>, offset, i, j;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (j = <span class="number">0</span>; i+j &lt; <span class="number">16</span> &amp;&amp; j+<span class="number">16</span> &lt; n &amp;&amp; in[i+j] == in[j+<span class="number">16</span>]; j++);</div><div class="line">            <span class="keyword">if</span> (j &gt; mx)</div><div class="line">                mx = j, offset = i;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mx &lt;= <span class="number">1</span>) &#123;</div><div class="line">            out[m++] = <span class="number">0</span>;</div><div class="line">            out[m++] = in[<span class="number">16</span>];</div><div class="line">            in++, n--;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            out[m++] = (offset&lt;&lt;<span class="number">4</span>)|(mx<span class="number">-1</span>);</div><div class="line">            in += mx, n -= mx;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lz77_decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line">    m = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (n &lt;= <span class="number">16</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            out[m++] = in[i];</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">memcpy</span>(out, in, <span class="number">16</span>);</div><div class="line">    in += <span class="number">16</span>, n -= <span class="number">16</span>, m += <span class="number">16</span>;</div><div class="line">    <span class="keyword">int</span> offset, mx;</div><div class="line">    <span class="keyword">while</span> (n &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (*in) &#123;</div><div class="line">            offset = (*in)&gt;&gt;<span class="number">4</span>, mx = ((*in)&amp;<span class="number">0xf</span>)+<span class="number">1</span>;</div><div class="line">            <span class="built_in">memcpy</span>(out + m, out + m - <span class="number">16</span> + offset, mx);</div><div class="line">            m += mx;</div><div class="line">            in++, n -= <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            out[m++] = in[<span class="number">1</span>];</div><div class="line">            in += <span class="number">2</span>, n -= <span class="number">2</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">base64_encode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> encode_table[] = &#123;<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>, <span class="string">'E'</span>, <span class="string">'F'</span>, <span class="string">'G'</span>, <span class="string">'H'</span>,</div><div class="line">                    <span class="string">'I'</span>, <span class="string">'J'</span>, <span class="string">'K'</span>, <span class="string">'L'</span>, <span class="string">'M'</span>, <span class="string">'N'</span>, <span class="string">'O'</span>, <span class="string">'P'</span>,</div><div class="line">                    <span class="string">'Q'</span>, <span class="string">'R'</span>, <span class="string">'S'</span>, <span class="string">'T'</span>, <span class="string">'U'</span>, <span class="string">'V'</span>, <span class="string">'W'</span>, <span class="string">'X'</span>,</div><div class="line">                    <span class="string">'Y'</span>, <span class="string">'Z'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>,</div><div class="line">                    <span class="string">'g'</span>, <span class="string">'h'</span>, <span class="string">'i'</span>, <span class="string">'j'</span>, <span class="string">'k'</span>, <span class="string">'l'</span>, <span class="string">'m'</span>, <span class="string">'n'</span>,</div><div class="line">                    <span class="string">'o'</span>, <span class="string">'p'</span>, <span class="string">'q'</span>, <span class="string">'r'</span>, <span class="string">'s'</span>, <span class="string">'t'</span>, <span class="string">'u'</span>, <span class="string">'v'</span>,</div><div class="line">                    <span class="string">'w'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>, <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>,</div><div class="line">                    <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>, <span class="string">'+'</span>, <span class="string">'/'</span>&#125;;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> mod_table[] = &#123;<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>&#125;;</div><div class="line"></div><div class="line">    m = <span class="number">4</span> * ((n + <span class="number">2</span>) / <span class="number">3</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; n; ) &#123;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> a, b, c, d;</div><div class="line">        a = i &lt; n ? in[i++] : <span class="number">0</span>;</div><div class="line">        b = i &lt; n ? in[i++] : <span class="number">0</span>;</div><div class="line">        c = i &lt; n ? in[i++] : <span class="number">0</span>;</div><div class="line">        d = (a&lt;&lt;<span class="number">16</span>)|(b&lt;&lt;<span class="number">8</span>)|c;</div><div class="line">        out[j++] = encode_table[(d&gt;&gt;<span class="number">18</span>)&amp;<span class="number">0x3f</span>];</div><div class="line">        out[j++] = encode_table[(d&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0x3f</span>];</div><div class="line">        out[j++] = encode_table[(d&gt;&gt;<span class="number">6</span>)&amp;<span class="number">0x3f</span>];</div><div class="line">        out[j++] = encode_table[d&amp;<span class="number">0x3f</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mod_table[n%<span class="number">3</span>]; i++)</div><div class="line">        out[m - <span class="number">1</span> - i] = <span class="string">'='</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">base64_decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> decode_table[<span class="number">256</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'A'</span>; i &lt;= <span class="string">'Z'</span>; i++)	decode_table[i] = i - <span class="string">'A'</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'a'</span>; i &lt;= <span class="string">'z'</span>; i++)	decode_table[i] = i - <span class="string">'a'</span> + <span class="number">26</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'0'</span>; i &lt;= <span class="string">'9'</span>; i++)	decode_table[i] = i - <span class="string">'0'</span> + <span class="number">52</span>;</div><div class="line">    decode_table[<span class="string">'+'</span>] = <span class="number">62</span>, decode_table[<span class="string">'/'</span>] = <span class="number">63</span>;</div><div class="line">    m = n/<span class="number">4</span>*<span class="number">3</span>;</div><div class="line">    <span class="keyword">if</span> (in[n<span class="number">-1</span>] == <span class="string">'='</span>)	m--;</div><div class="line">    <span class="keyword">if</span> (in[n<span class="number">-2</span>] == <span class="string">'='</span>)	m--;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; n; ) &#123;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> a, val = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">3</span>; k &gt;= <span class="number">0</span>; i++, k--) &#123;</div><div class="line">            a = in[i] == <span class="string">'='</span> ? <span class="number">0</span> : decode_table[in[i]];</div><div class="line">            val |= a&lt;&lt;(k*<span class="number">6</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">0</span>)&amp;<span class="number">0xff</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">huffman_encode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line">    m = <span class="number">0</span>;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Table</span> &#123;</span></div><div class="line">        <span class="keyword">int</span> f, bit, bn;</div><div class="line">    &#125; tables[<span class="number">512</span>];</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></div><div class="line">        <span class="keyword">int</span> f, tid;</div><div class="line">        Node *l, *r;</div><div class="line">        Node(<span class="keyword">int</span> a = <span class="number">0</span>, <span class="keyword">int</span> b = <span class="number">0</span>, Node *ls = <span class="literal">NULL</span>, Node *rs = <span class="literal">NULL</span>):</div><div class="line">            f(a), tid(b), l(ls), r(rs) &#123;&#125;</div><div class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Node &amp;x)  <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> f &lt; x.f;</div><div class="line">        &#125;</div><div class="line">    &#125; nodes[<span class="number">512</span>];</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Stack</span> &#123;</span></div><div class="line">        Node *node;</div><div class="line">        <span class="keyword">int</span> bit, bn;</div><div class="line">        Stack(Node *a = <span class="literal">NULL</span>, <span class="keyword">int</span> b = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>):</div><div class="line">            node(a), bit(b), bn(c) &#123;&#125;</div><div class="line">    &#125; stacks[<span class="number">1024</span>];</div><div class="line">    <span class="keyword">int</span> size = <span class="number">0</span>, leaf;</div><div class="line">    <span class="built_in">multiset</span>&lt; pair&lt;<span class="keyword">int</span>, Node*&gt; &gt; S;</div><div class="line">    <span class="built_in">memset</span>(tables, <span class="number">0</span>, <span class="keyword">sizeof</span>(tables));</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">        tables[in[i]].f++;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (tables[i].f) &#123;</div><div class="line">            nodes[size] = Node(tables[i].f, i);</div><div class="line">            S.insert(&#123;nodes[size].f, &amp;nodes[size]&#125;);</div><div class="line">            size++;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    leaf = size;</div><div class="line">    <span class="keyword">while</span> (S.size() &gt;= <span class="number">2</span>) &#123;</div><div class="line">        pair&lt;<span class="keyword">int</span>, Node*&gt; u, v;</div><div class="line">        u = *S.begin(), S.erase(S.begin());</div><div class="line">        v = *S.begin(), S.erase(S.begin());</div><div class="line">        <span class="keyword">int</span> f = u.second-&gt;f + v.second-&gt;f; </div><div class="line">        nodes[size] = Node(f, <span class="number">-1</span>, u.second, v.second);</div><div class="line">        S.insert(&#123;nodes[size].f, &amp;nodes[size]&#125;);</div><div class="line">        size++;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> stkIdx = <span class="number">0</span>;</div><div class="line">    stacks[stkIdx++] = Stack(&amp;nodes[size<span class="number">-1</span>], <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">while</span> (stkIdx) &#123;</div><div class="line">        Stack u = stacks[--stkIdx], v;</div><div class="line">        <span class="keyword">if</span> (u.bn &gt;= <span class="number">31</span>) &#123;</div><div class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"huffman error: bit length exceeded\n"</span>);</div><div class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (u.node-&gt;l == <span class="literal">NULL</span>) &#123;</div><div class="line">            tables[u.node-&gt;tid].bit = u.bit;</div><div class="line">            tables[u.node-&gt;tid].bn = u.bn;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            v = Stack(u.node-&gt;l, u.bit | (<span class="number">1</span>&lt;&lt;u.bn), u.bn+<span class="number">1</span>);</div><div class="line">            u.node = u.node-&gt;r, u.bn++;</div><div class="line">            stacks[stkIdx++] = u;</div><div class="line">            stacks[stkIdx++] = v;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> bits_cnt = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)</div><div class="line">        bits_cnt += tables[i].f * tables[i].bn;</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"huffman: %d bit length\n"</span>, bits_cnt);</div><div class="line">    </div><div class="line">    <span class="built_in">memcpy</span>(out+m, &amp;bits_cnt, <span class="number">4</span>), m += <span class="number">4</span>;</div><div class="line">    <span class="built_in">memcpy</span>(out+m, &amp;leaf, <span class="number">1</span>), m += <span class="number">1</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; leaf; i++) &#123;</div><div class="line">        Table t = tables[nodes[i].tid];</div><div class="line">        <span class="built_in">memcpy</span>(out+m, &amp;nodes[i].tid, <span class="number">1</span>), m += <span class="number">1</span>;</div><div class="line">        <span class="built_in">memcpy</span>(out+m, &amp;t.bn, <span class="number">1</span>), m += <span class="number">1</span>;</div><div class="line">        <span class="built_in">memcpy</span>(out+m, &amp;t.bit, (t.bn + <span class="number">7</span>)/<span class="number">8</span>), m += (t.bn + <span class="number">7</span>)/<span class="number">8</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>, mask = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">        <span class="keyword">int</span> bit = tables[in[i]].bit;</div><div class="line">        <span class="keyword">int</span> bn = tables[in[i]].bn;</div><div class="line">        <span class="keyword">while</span> (bn) &#123;	<span class="comment">// LBS</span></div><div class="line">            <span class="keyword">int</span> j = min(bn, <span class="number">8</span> - cnt);</div><div class="line">            mask |= (bit&amp;((<span class="number">1</span>&lt;&lt;j)<span class="number">-1</span>))&lt;&lt;cnt;</div><div class="line">            cnt += j, bn -= j, bit &gt;&gt;= j;</div><div class="line">            <span class="keyword">if</span> (cnt == <span class="number">8</span>) &#123;</div><div class="line">                <span class="built_in">memcpy</span>(out+m, &amp;mask, <span class="number">1</span>), m += <span class="number">1</span>;</div><div class="line">                cnt = <span class="number">0</span>, mask = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (cnt)</div><div class="line">        <span class="built_in">memcpy</span>(out+m, &amp;mask, <span class="number">1</span>), m += <span class="number">1</span>;</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"huffman encode length %d\n"</span>, m);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">huffman_decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line">    m = <span class="number">0</span>;</div><div class="line">    <span class="built_in">map</span>&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; R[<span class="number">64</span>];</div><div class="line">    <span class="keyword">int</span> bits_cnt = <span class="number">0</span>, leaf = <span class="number">0</span>;</div><div class="line">    <span class="built_in">memcpy</span>(&amp;bits_cnt, in, <span class="number">4</span>), in += <span class="number">4</span>, n -= <span class="number">4</span>;</div><div class="line">    <span class="built_in">memcpy</span>(&amp;leaf, in, <span class="number">1</span>), in += <span class="number">1</span>, n -= <span class="number">1</span>;</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"huffman: %d bit length\n"</span>, bits_cnt);</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"huffman: %d leaves\n"</span>, leaf);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; leaf; i++) &#123;</div><div class="line">        <span class="keyword">int</span> tid = <span class="number">0</span>, bn = <span class="number">0</span>, bit = <span class="number">0</span>;</div><div class="line">        <span class="built_in">memcpy</span>(&amp;tid, in, <span class="number">1</span>), in += <span class="number">1</span>, n -= <span class="number">1</span>;</div><div class="line">        <span class="built_in">memcpy</span>(&amp;bn, in, <span class="number">1</span>), in += <span class="number">1</span>, n -= <span class="number">1</span>;</div><div class="line">        <span class="built_in">memcpy</span>(&amp;bit, in, (bn+<span class="number">7</span>)/<span class="number">8</span>), in += (bn+<span class="number">7</span>)/<span class="number">8</span>, n -= (bn+<span class="number">7</span>)/<span class="number">8</span>;</div><div class="line">        R[bn][bit] = tid;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> mask = <span class="number">0</span>, cnt = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bits_cnt; i++) &#123;</div><div class="line">        mask |= ((in[(i&gt;&gt;<span class="number">3</span>)]&gt;&gt;(i&amp;<span class="number">7</span>))&amp;<span class="number">1</span>)&lt;&lt;cnt;</div><div class="line">        cnt++;</div><div class="line">        <span class="keyword">if</span> (R[cnt].count(mask)) &#123;</div><div class="line">            out[m++] = R[cnt][mask];</div><div class="line">            cnt = <span class="number">0</span>, mask = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> in[<span class="number">32767</span>], in2[<span class="number">32767</span>], *pin;</div><div class="line">        pin = in;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++) &#123;</div><div class="line">                <span class="keyword">int</span> r, g, b;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;r, &amp;g, &amp;b);</div><div class="line">                *pin = r, pin++;</div><div class="line">                *pin = g, pin++;</div><div class="line">                *pin = b, pin++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> lz77n, b64n, elz77n, tn, hufn, ehufn;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="number">4</span>][<span class="number">32767</span>] = &#123;&#125;, test[<span class="number">32767</span>] = &#123;&#125;;</div><div class="line">        <span class="comment">// Case 1</span></div><div class="line"><span class="comment">//		base64_encode(in, n*m*3, buf[1], b64n);</span></div><div class="line">        <span class="comment">// Case 2</span></div><div class="line"><span class="comment">//		huffman_encode(in, n*m, buf[0], hufn);</span></div><div class="line"><span class="comment">//		base64_encode(buf[0], hufn, buf[1], b64n);</span></div><div class="line"><span class="comment">//		base64_decode(buf[1], b64n, buf[2], ehufn);</span></div><div class="line"><span class="comment">//		huffman_decode(buf[2], ehufn, test, tn);</span></div><div class="line">        <span class="comment">// Case 3</span></div><div class="line"><span class="comment">//		lz77_encode(in, n*m, buf[0], lz77n);</span></div><div class="line"><span class="comment">//		base64_encode(buf[0], lz77n, buf[1], b64n);</span></div><div class="line"><span class="comment">//		base64_decode(buf[1], b64n, buf[2], elz77n);</span></div><div class="line"><span class="comment">//		lz77_decode(buf[2], elz77n, test, tn);</span></div><div class="line">        <span class="comment">// Case 4</span></div><div class="line"><span class="comment">//		huffman_encode(in, n*m, buf[0], hufn);</span></div><div class="line"><span class="comment">//		lz77_encode(buf[0], hufn, buf[2], lz77n);</span></div><div class="line"><span class="comment">//		base64_encode(buf[2], lz77n, buf[1], b64n);</span></div><div class="line">        <span class="comment">// Case 5</span></div><div class="line"><span class="comment">//		lz77_encode(in, n*m, buf[0], lz77n);</span></div><div class="line"><span class="comment">//		huffman_encode(buf[0], hufn, buf[2], hufn);</span></div><div class="line"><span class="comment">//		base64_encode(buf[2], lz77n, buf[1], b64n);</span></div><div class="line">        <span class="comment">// Case 6</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n*m*<span class="number">3</span>; i += <span class="number">3</span>) &#123;</div><div class="line">            in2[i] = in[i] - (i &gt;= <span class="number">3</span> ? in[i<span class="number">-3</span>] : <span class="number">0</span>);</div><div class="line">            in2[i+<span class="number">1</span>] = in[i+<span class="number">1</span>] - (i &gt;= <span class="number">4</span> ? in[i<span class="number">-4</span>] : <span class="number">0</span>);</div><div class="line">            in2[i+<span class="number">2</span>] = in[i+<span class="number">2</span>] - (i &gt;= <span class="number">5</span> ? in[i<span class="number">-5</span>] : <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">        huffman_encode(in2, n*m*<span class="number">3</span>, buf[<span class="number">0</span>], hufn);</div><div class="line">        base64_encode(buf[<span class="number">0</span>], hufn, buf[<span class="number">1</span>], b64n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; b64n; i++)</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%c"</span>, buf[<span class="number">1</span>][i]);</div><div class="line">        <span class="built_in">puts</span>(<span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="base64"><a href="#base64" class="headerlink" title="base64"></a>base64</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> data[] = <span class="string">"4YZ334Js3H5p5o1z8JZ0t01cpEBWsklUsE ... ignore"</span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">base64_decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> R[<span class="number">256</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'A'</span>; i &lt;= <span class="string">'Z'</span>; i++)	R[i] = i - <span class="string">'A'</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'a'</span>; i &lt;= <span class="string">'z'</span>; i++)	R[i] = i - <span class="string">'a'</span> + <span class="number">26</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'0'</span>; i &lt;= <span class="string">'9'</span>; i++)	R[i] = i - <span class="string">'0'</span> + <span class="number">52</span>;</div><div class="line">    R[<span class="string">'+'</span>] = <span class="number">62</span>, R[<span class="string">'/'</span>] = <span class="number">63</span>;</div><div class="line">    m = n/<span class="number">4</span>*<span class="number">3</span>;</div><div class="line">    <span class="keyword">if</span> (in[n<span class="number">-1</span>] == <span class="string">'='</span>)	m--;</div><div class="line">    <span class="keyword">if</span> (in[n<span class="number">-2</span>] == <span class="string">'='</span>)	m--;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; n; ) &#123;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> a, val = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">3</span>; k &gt;= <span class="number">0</span>; i++, k--) &#123;</div><div class="line">            a = in[i] == <span class="string">'='</span> ? <span class="number">0</span> : R[in[i]];</div><div class="line">            val |= a&lt;&lt;(k*<span class="number">6</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">0</span>)&amp;<span class="number">0xff</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> d[<span class="number">32767</span>] = &#123;&#125;;</div><div class="line">    <span class="keyword">int</span> n;</div><div class="line">    base64_decode(data, <span class="keyword">sizeof</span>(data), d, n);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, <span class="number">45</span>, <span class="number">45</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">45</span>; i++) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">45</span>; j++) &#123;</div><div class="line">            <span class="keyword">int</span> v = (i*<span class="number">45</span>+j)*<span class="number">3</span>;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d %d %d%c"</span>, d[v], d[v+<span class="number">1</span>], d[v+<span class="number">2</span>], <span class="string">" \n"</span>[j == <span class="number">44</span>]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="base64-短碼"><a href="#base64-短碼" class="headerlink" title="base64 短碼"></a>base64 短碼</h3><p>利用巨集展開重複的指令</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> UINT8;</div><div class="line">UINT8 data[] = <span class="string">"4YZ334Js3H5p5o1z8JZ0t01cpEBWsklUsE ... ignore"</span>;</div><div class="line">UINT8 d[<span class="number">32767</span>] = &#123;&#125;;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">base64_decode</span><span class="params">(UINT8 *in, <span class="keyword">int</span> n, UINT8 *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MK(st, ed, b) for (int i = st; i &lt;= ed; i++) R[i] = i-st+b;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MG(k) b |= (in[i] == <span class="meta-string">'='</span> ? 0 : R[in[i]])&lt;&lt;(k*6), i++;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MP(k) <span class="meta-keyword">if</span> (j <span class="meta-string">&lt; m)	out[j++] = (b&gt;&gt;(k*8))&amp;0xff;</span></span></div><div class="line">    <span class="keyword">int</span> R[<span class="number">256</span>];</div><div class="line">    MK(<span class="string">'A'</span>, <span class="string">'Z'</span>, <span class="number">0</span>); MK(<span class="string">'a'</span>, <span class="string">'z'</span>, <span class="number">26</span>); MK(<span class="string">'0'</span>, <span class="string">'9'</span>, <span class="number">52</span>);</div><div class="line">    R[<span class="string">'+'</span>] = <span class="number">62</span>, R[<span class="string">'/'</span>] = <span class="number">63</span>;</div><div class="line">    m = n/<span class="number">4</span>*<span class="number">3</span>;</div><div class="line">    <span class="keyword">if</span> (in[n<span class="number">-1</span>] == <span class="string">'='</span>)	m--;</div><div class="line">    <span class="keyword">if</span> (in[n<span class="number">-2</span>] == <span class="string">'='</span>)	m--;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; n; ) &#123;</div><div class="line">        <span class="keyword">int</span> b = <span class="number">0</span>;</div><div class="line">        MG(<span class="number">3</span>); MG(<span class="number">2</span>); MG(<span class="number">1</span>); MG(<span class="number">0</span>);</div><div class="line">        MP(<span class="number">2</span>); MP(<span class="number">1</span>); MP(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, v;</div><div class="line">    base64_decode(data, <span class="keyword">sizeof</span>(data), d, n);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, <span class="number">45</span>, <span class="number">45</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">45</span>; i++) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">45</span>; j++) &#123;</div><div class="line">            v = (i*<span class="number">45</span>+j)*<span class="number">3</span>;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d %d %d%c"</span>, d[v], d[v+<span class="number">1</span>], d[v+<span class="number">2</span>], <span class="string">" \n"</span>[j == <span class="number">44</span>]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-a458" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/23/zj-a458/" class="article-date">
  <time datetime="2015-07-23T08:01:33.000Z" itemprop="datePublished">2015-07-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="http://i.imgur.com/oESgaLX.jpg" rel="gallery_ckq8nozyo011d1wvnnqvi8axz">
        <img src="http://i.imgur.com/oESgaLX.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/23/zj-a458/">a458. Beats of the Angel 加強版</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/23/zj-a458/" data-id="ckq8nozyo011d1wvnnqvi8axz" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/23/zj-a458/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dijkstra/">dijkstra</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sssp/">sssp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/掃描線/">掃描線</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/離線處理/">離線處理</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>給一張圖，給定起點 S、終點 T，把任意邊的權重放大兩倍，請問最多能拉長最短道路長度為何。</p>
<p>意即修改一條邊找替代道路，使得替代道路越長越好。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">5 7</div><div class="line">2 1 5</div><div class="line">1 3 1</div><div class="line">3 2 8</div><div class="line">3 5 7</div><div class="line">3 4 3</div><div class="line">2 4 7</div><div class="line">4 5 2</div><div class="line">1 5</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>終於向 liouzhou101 問到解法，類似 <a href="http://zrt.github.io/2014/08/13/bzoj2725/" target="_blank" rel="external">BZOJ 2725 Violet 6 故乡的梦</a>，過了三年多，才把 Angel Beats 加強版寫出來，終於完成了，代碼是如此地迷人，一堆掃描線算法，找瓶頸也用掃描線代替感覺萌萌哒。</p>
<p>移除掉一條邊，找到 S-T 最短路徑的替代道路 <span>$O(E \log E)$</span><!-- Has MathJax --> 離線處理。</p>
<ol>
<li>先在 DAG 上找瓶頸，只有瓶頸發生變化才受影響。</li>
<li>計算 DAG 上，經過瓶頸的最小次數。</li>
<li>接著，對瓶頸由近至遠進行掃描，維護一個最小堆 <code>multiset</code>，維護替代道路的可行性，保持掃描線左右兩方各自通過的瓶頸數接起來不會通過瓶頸。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">       B -- C        H -- I</div><div class="line">      /      \      /      \</div><div class="line">S - A         D -- G ------ J - T</div><div class="line">      \      /  </div><div class="line">       E -- F</div></pre></td></tr></table></figure>
<p>變數說明</p>
<ul>
<li><code>Ds(u)</code> 表示從起點 S 到 u 的最短路徑</li>
<li><code>De(u)</code> 表示從 u 到終點 T 的最短路徑</li>
<li><code>Bs(u)</code> 表示從起點 S 到 u 保持在最短路徑上，經過最少的瓶頸數</li>
<li><code>Be(u)</code> 表示從 u 到終點 T 保持在最短路徑上，經過最少的瓶頸數</li>
</ul>
<p>例如先找到 shortest-path DAG 圖如上，則 <code>D - G</code> 和 <code>J - T</code> 都是瓶頸。瓶頸有兩種找法，第一種是類似最大流的最小割，第二種是轉換成區間，例如 <code>e(u, v)</code> 則可以得到區間 <code>[Ds(u), Ds(v)]</code>，然後做掃描線算法，得到哪個時候只有一個區間，則那個邊就是瓶頸。</p>
<p>得到所有瓶頸後，依序掃描離 S 近到遠的瓶頸，維護一個 <code>mutliset&lt;int&gt;</code>，當窮舉瓶頸 <code>e(u, v)</code>，則替代道路為 <code>min(Ds(a) + w(a, b) + De(b))</code>，滿足 <code>Bs(a) &lt;= Bs(u)</code> 和 <code>Be(b) &lt;= Be(v)</code>。條件 <code>Bs(a) &lt;= Bs(u)</code> 和 <code>Be(b) &lt;= Be(v)</code> 是為了保證不經過這個瓶頸。</p>
<p>隨著掃描線移動，<code>Be(b)</code> 遞減，<code>Bs(a)</code> 遞增，因此先排序 <code>Bs[]</code> 和 <code>Be[]</code>，每當掃描到一個瓶頸，鬆弛新的路徑，同時移除掉最小堆中 <code>Ds(a) + w(a, b) + De(b)</code> 且 <code>Be(b) &gt; Be(v)</code> 的所有元素。</p>
<p>英文名稱 <a href="http://www.di.univaq.it/~proietti/slide_algdist2009/SelfishSP.ppt" target="_blank" rel="external">The selfish-edges Shortest-Path problem</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="comment">// http://zrt.github.io/2014/08/13/bzoj2725/</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXV = <span class="number">200005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXE = <span class="number">200005</span>&lt;&lt;<span class="number">1</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> INF = <span class="number">1L</span>L&lt;&lt;<span class="number">60</span>;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> to, eid;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> w;</div><div class="line">    Edge *next;</div><div class="line">&#125;;</div><div class="line">Edge edge[MAXE], *adj[MAXV];</div><div class="line"><span class="keyword">int</span> e = <span class="number">0</span>;</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> Ds[MAXV], De[MAXV];</div><div class="line"><span class="keyword">int</span> Bs[MAXV], Be[MAXV], keye[MAXE];</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEdge</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">long</span> <span class="keyword">long</span> v)</span>  </span>&#123;</div><div class="line">    edge[e].to = y, edge[e].w = v, edge[e].eid = e;</div><div class="line">    edge[e].next = adj[x], adj[x] = &amp;edge[e++];</div><div class="line">    edge[e].to = x, edge[e].w = v, edge[e].eid = e;</div><div class="line">    edge[e].next = adj[y], adj[y] = &amp;edge[e++];</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dijkstra</span><span class="params">(<span class="keyword">int</span> st, <span class="keyword">long</span> <span class="keyword">long</span> dist[], <span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line"><span class="keyword">typedef</span> pair&lt;<span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">int</span>&gt; PLL;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= n; i++)</div><div class="line">        dist[i] = INF;</div><div class="line">    <span class="built_in">set</span>&lt;PLL&gt; pQ;</div><div class="line">    PLL u;</div><div class="line">    pQ.insert(PLL(<span class="number">0</span>, st)), dist[st] = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (!pQ.empty()) &#123;</div><div class="line">        u = *pQ.begin(), pQ.erase(pQ.begin());</div><div class="line">        <span class="keyword">for</span> (Edge *p = adj[u.second]; p; p = p-&gt;next) &#123;</div><div class="line">            <span class="keyword">if</span> (dist[p-&gt;to] &gt; dist[u.second] + p-&gt;w) &#123;</div><div class="line">                <span class="keyword">if</span> (dist[p-&gt;to] != INF)</div><div class="line">                    pQ.erase(pQ.find(PLL(dist[p-&gt;to], p-&gt;to)));</div><div class="line">                dist[p-&gt;to] = dist[u.second] + p-&gt;w;</div><div class="line">                pQ.insert(PLL(dist[p-&gt;to], p-&gt;to));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">bottleneck</span><span class="params">(<span class="keyword">int</span> st, <span class="keyword">int</span> ed, <span class="keyword">long</span> <span class="keyword">long</span> Ds[], <span class="keyword">long</span> <span class="keyword">long</span> De[], <span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line"><span class="keyword">typedef</span> pair&lt;<span class="keyword">long</span> <span class="keyword">long</span>, pair&lt;<span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">int</span>&gt; &gt; PLL;</div><div class="line">    <span class="built_in">vector</span>&lt;PLL&gt; A;</div><div class="line">    <span class="comment">// short path DAG st-ed</span></div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> d = Ds[ed];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">        <span class="keyword">for</span> (Edge *p = adj[i]; p; p = p-&gt;next) &#123;</div><div class="line">            <span class="keyword">if</span> (Ds[p-&gt;to] == Ds[i] + p-&gt;w &amp;&amp; Ds[p-&gt;to] + De[p-&gt;to] == d) &#123;</div><div class="line">                A.push_back(PLL(Ds[i], &#123;Ds[p-&gt;to], p-&gt;eid&#125;));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// bottleneck edge st-ed</span></div><div class="line">    sort(A.begin(), A.end());</div><div class="line">    priority_queue&lt;<span class="keyword">long</span> <span class="keyword">long</span>, <span class="built_in">vector</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt;, <span class="built_in">std</span>::greater&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt;&gt; pQ;</div><div class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; e; i++)</div><div class="line">        keye[i] = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; A.size(); ) &#123;</div><div class="line">        <span class="keyword">long</span> <span class="keyword">long</span> l = A[i].first;</div><div class="line">        <span class="keyword">while</span> (!pQ.empty() &amp;&amp; pQ.top() &lt;= l)</div><div class="line">            pQ.pop();</div><div class="line">        <span class="keyword">while</span> (i &lt; A.size() &amp;&amp; A[i].first &lt;= l)</div><div class="line">            pQ.push(A[i].second.first), i++;</div><div class="line">        <span class="keyword">if</span> (pQ.size() == <span class="number">1</span>) &#123;</div><div class="line">            keye[A[i<span class="number">-1</span>].second.second] = <span class="number">1</span>;</div><div class="line">            keye[A[i<span class="number">-1</span>].second.second^<span class="number">1</span>] = <span class="number">-1</span>;</div><div class="line">            cnt++;</div><div class="line">        &#125;</div><div class="line">    &#125; </div><div class="line">    <span class="keyword">return</span> cnt;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">bfs</span><span class="params">(<span class="keyword">int</span> st, <span class="keyword">int</span> dist[], <span class="keyword">long</span> <span class="keyword">long</span> Ds[], <span class="keyword">int</span> n, <span class="keyword">int</span> f)</span> </span>&#123;</div><div class="line"><span class="keyword">typedef</span> pair&lt;<span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">int</span>&gt; PLL;</div><div class="line">    <span class="comment">// work for short-path DAG, weight: key edge</span></div><div class="line">    <span class="built_in">vector</span>&lt;PLL&gt; A;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</div><div class="line">        A.push_back(PLL(Ds[i], i)), dist[i] = <span class="number">0x3f3f3f3f</span>;</div><div class="line">    dist[st] = <span class="number">0</span>;</div><div class="line">    sort(A.begin(), A.end());</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">        <span class="keyword">int</span> x = A[i].second;</div><div class="line">        <span class="keyword">for</span> (Edge *p = adj[x]; p; p = p-&gt;next) &#123;</div><div class="line">            <span class="keyword">if</span> (Ds[p-&gt;to] == Ds[x] + p-&gt;w)</div><div class="line">                dist[p-&gt;to] = min(dist[p-&gt;to], dist[x] + (keye[p-&gt;eid] == f));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">solve</span><span class="params">(<span class="keyword">int</span> st, <span class="keyword">int</span> ed, <span class="keyword">long</span> <span class="keyword">long</span> Ds[], <span class="keyword">long</span> <span class="keyword">long</span> De[], <span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line"><span class="keyword">typedef</span> pair&lt;<span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">int</span>&gt; PLL;</div><div class="line"><span class="keyword">typedef</span> pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; PII;</div><div class="line"><span class="keyword">typedef</span> <span class="built_in">multiset</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt;::iterator MIT;</div><div class="line">    bfs(st, Bs, Ds, n, <span class="number">1</span>);</div><div class="line">    bfs(ed, Be, De, n, <span class="number">-1</span>);</div><div class="line">    <span class="built_in">vector</span>&lt;PLL&gt; A;</div><div class="line">    <span class="built_in">vector</span>&lt;PII&gt; B, C;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">        A.push_back(PLL(Ds[i], i));</div><div class="line">        B.push_back(PII(Bs[i], i));</div><div class="line">        C.push_back(PII(Be[i], i));</div><div class="line">    &#125;</div><div class="line">    sort(A.begin(), A.end());</div><div class="line">    sort(B.begin(), B.end());</div><div class="line">    sort(C.begin(), C.end());</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> d = Ds[ed];</div><div class="line">    <span class="keyword">int</span> Bidx = <span class="number">0</span>, Cidx = n<span class="number">-1</span>;</div><div class="line">    <span class="built_in">multiset</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt; S;</div><div class="line">    <span class="built_in">vector</span>&lt; <span class="built_in">vector</span>&lt;MIT&gt; &gt; RM(n+<span class="number">1</span>, <span class="built_in">vector</span>&lt;MIT&gt;());</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> ret = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">        <span class="keyword">int</span> x = A[i].second;</div><div class="line">        <span class="keyword">for</span> (Edge *p = adj[x]; p; p = p-&gt;next) &#123;</div><div class="line">            <span class="keyword">if</span> (Ds[p-&gt;to] == Ds[x] + p-&gt;w &amp;&amp; Ds[p-&gt;to] + De[p-&gt;to] == d) &#123;</div><div class="line">                <span class="keyword">if</span> (keye[p-&gt;eid]) &#123;</div><div class="line">                    <span class="keyword">int</span> bb = Bs[x], cut = Be[p-&gt;to];</div><div class="line">                    <span class="comment">// relax</span></div><div class="line">                    <span class="keyword">for</span> (; Bidx &lt; B.size() &amp;&amp; B[Bidx].first &lt;= bb; Bidx++) &#123;</div><div class="line">                        <span class="keyword">int</span> u = B[Bidx].second;</div><div class="line">                        <span class="keyword">for</span> (Edge *q = adj[u]; q; q = q-&gt;next) &#123;</div><div class="line">                            <span class="keyword">if</span> (Be[q-&gt;to] &lt;= cut &amp;&amp; p != q) &#123;</div><div class="line">                                MIT it = S.insert(Ds[u] + q-&gt;w + De[q-&gt;to]);</div><div class="line">                                RM[q-&gt;to].push_back(it);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// remove</span></div><div class="line">                    <span class="keyword">for</span> (; Cidx &gt;= <span class="number">0</span> &amp;&amp; C[Cidx].first &gt; cut; Cidx--) &#123;</div><div class="line">                        <span class="keyword">int</span> u = C[Cidx].second;</div><div class="line">                        <span class="keyword">for</span> (<span class="keyword">auto</span> e : RM[u])</div><div class="line">                            S.erase(e);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">long</span> <span class="keyword">long</span> replace_path = INF;</div><div class="line">                    <span class="keyword">if</span> (!S.empty())</div><div class="line">                        replace_path = *S.begin();</div><div class="line">                    replace_path = min(replace_path, d + p-&gt;w); <span class="comment">// this edge double weight</span></div><div class="line">                    ret = max(ret, replace_path - d);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m, x, y;</div><div class="line">    <span class="keyword">int</span> st, ed;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> v;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</div><div class="line">            adj[i] = <span class="literal">NULL</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d %lld"</span>, &amp;x, &amp;y, &amp;v);</div><div class="line">            addEdge(x, y, v);</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;st, &amp;ed);</div><div class="line">        dijkstra(st, Ds, n);</div><div class="line">        dijkstra(ed, De, n);</div><div class="line">        <span class="keyword">int</span> cnt = bottleneck(st, ed, Ds, De, n);</div><div class="line">        <span class="keyword">if</span> (cnt == <span class="number">0</span>)</div><div class="line">            <span class="built_in">puts</span>(<span class="string">"0"</span>);</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, solve(st, ed, Ds, De, n));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b454" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/23/zj-b454/" class="article-date">
  <time datetime="2015-07-23T06:39:45.000Z" itemprop="datePublished">2015-07-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/23/zj-b454/">b454. 請輸出這張圖片的 RGB 數值</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/23/zj-b454/" data-id="ckq8np00e014q1wvnp6nf926r" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/23/zj-b454/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/base64/">base64</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/huffman/">huffman</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lz77/">lz77</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/建表/">建表</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/影像處理/">影像處理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/資料壓縮/">資料壓縮</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/霍夫曼編碼/">霍夫曼編碼</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAgAElEQVR4nGW7V1CcZ5r+Tc3B1s7OrD07Y49sJUsi55yDQAKEBEikJieRc246kKGBhm4yjYAmIyQhRFC2lXMEoWxbnrI9wbVeH7hqZmtrD3//A9f77Oj7DroQTauqn/u9w3Vd9/WYjI2NcezYMYaHhxkcHGRkZIQTJ06wsLCAWq3m8OHDZGRkcPToUY4ePUpmZiaFhYVUVlYil8tRqVTU1dWhVCpRq9XU19dTV1cnXg0NDdTX19PQ0CA+q1KpaGhoQK1Wi99VKhUKhQKlUkltbS0VFRUcPXqU8vJy+vv7MRqN9Pb2MjAwwPDwMP39/eLfQ0NDrKys8N1333Hnzh0OHz5MeXk5FRUVVFVVUVlZSXV1tfjO1dXVlJWV0dfXh8nw8DAGg4Hh4WEGBgYYHx9nYWGBmZkZ5HI54eHhJCcnk5mZSXp6OmlpaeTn51NRUUFNTQ21tbUolUqUSqU4SF1dnTicWq0WwVEoFOLnPx9cOrT0UigUVFZWkpeXR1paGhqNhtHRUQwGA8eOHXvvgQ0ODjIwMEB3dzevXr3ihx9+QKlUiuBVVFS8F4zq6mpaWlrIyMhgy5YtmAwNDWEwGDAYDAwNDTE7O8vU1BRjY2OoVCoiIyNJSkoiKyuLtLQ0UlJSKCgooKysjOrqavHU1Go1KpUKtVotXtIB//m9uro6amtraWxsFJ+RAlhTU4NCoaC2tpbq6mpKSkpIS0ujqqqKoaEhJicnGRsbw2g0iiAMDAzQ39+PTqdjdnaW77//nlevXhETE0NxcTHl5eXi4AqFAq1Wi0wmY/v27VhZWf2SAVJ0p6ammJubY2RkhMnJSWprawkLC3svA9LT08nJyaGiooLq6mrkcrn40lIwVCoVtbW1ItWrq6tFxlRXV4vMkbKlpqYGuVyOXC4Xf6uqqqK0tJSMjAwqKytFGYyNjTE6OsqxY8cYGhpiaGiIwcFB+vr6aG5uZn19nf/6r/9ieHiY9PR0UQKVlZVoNBqio6PZsWMHZmZm2NvbYzIyMsL4+DhTU1PMz88zNTXFyMgIExMT1NbWcvDgQZKTk8nIyBAZkJeXR2lp6XtlUF1dLYIgHU4qj6qqKioqKkQ6lpaWisDV1dUhl8upra0VAZLqtLi4mKNHj1JaWopWq0V6WCMjIyJrpfIdHByku7ub/v5+vv/+e3766SfS09PJy8ujqqqK1tZWYmJi2LJlC05OTtjb22NjY4PJ+Pg44+PjzM7OihqT0qy6upoDBw6QkpIi6l8KwP+3rqSnKKWxQqEQ71VWVlJTU4NKpaKlpYX6+nry8/MpLi6mqqpKBEPKAun/FBUVkZOTQ3FxMe3t7ej1eoaGht6r/6GhIQYGBtDpdGi1Wurq6rh37x4//vgjFy5cIDo6Grlcjkwm49NPP8XGxgYXFxesra0xMzPDZHR0lPn5eUZGRmhqauLYsWOMj48zOTmJQqEgNDSU+Ph4MjIySE1NJT09nfz8fMrLy8XBpCyQMkE6uEKhQK/Xo9frMRqNLC4ucvnyZc6dO8fNmzdZXFykvr6erKwskT3S0y8vL6ewsJDs7GwKCwvp6Oigo6ODnp4ehoaG6O/vp7+/n76+Prq6uujo6ECj0dDW1kZnZyffffcdP//8My0tLURFRbFlyxbMzc1xcnLCzs4Oc3NzLCwsMJmcnGR+fh61Wk1ZWRlTU1NMT08zNTWFQqEgMDCQuLg4kpKSSEpKIi0tjdzcXEpKSqioqKCysvK9LKivr6ezsxO5XE5jYyPNzc3o9Xr6+/uZmJjg+PHjLC8vc+HCBa5evcr6+jorKytkZWVRUlJCZWUlFRUVFBUVkZubS1paGoWFhXR2dqLVaunu7qa3t5e+vj60Wq14Xzq8RqOhrq6O5eVlfv75ZzY3N/n1r3+NmZkZTk5O2NraYm1tjaWl5S8lsLi4iMFgICwsjNLSUmZmZpienmZychK5XI6fnx9RUVEkJiaSnJxMamoqR48epaCggKKiIlEGFRUVtLS0kJWVRXl5OeXl5TQ2NqJUKmloaKCjo4Ph4WFOnz7N2toa586d4+rVq1y7do2HDx/y5MkTqqqqkMlkFBYWUlhYKAKQl5eHTqejp6eHzs5O2tvbRcprNBq0Wi3t7e1oNBo6Ozvp7OykubmZn376CWdnZ3bu3ImdnR2Ojo5YWlpibW2Nra0t27Ztw2R+fp6qqip8fHyorKxkZmaG2dlZxsfHkcvl+Pj4EBsbS2pqKklJSSQnJ5OVlUVRUREFBQWUlpZSXl4u0j8rK4vCwkLR2BobG2lsbKStrY2enh6mpqZYW1vj8uXLXLt2jdu3b3Pt2jWuX7/O119/zfLyMmFhYeTm5pKenk5qaio5OTn09fVhMBjo6emhvLwcuVxOX18fnZ2ddHd3097eTmdnJ11dXXR3dzM7O4u9vT1bt27FxsYGW1tbzMzMcHBwEL9HRUVhMjAwQFhYGKGhoVRXV4tRaDQaqaysJCAggJiYGBITE0lNTRUBKCgooKSk5L1mmJ6eLrJC6hF1dXWiFDo7O5mamuLixYtcuXKFlZUVPv/8cx4/fszr16958eIFP/zwA8vLywQEBJCSkkJ8fDw5OTno9XrR+IqKivD19X0vE9rb29FqtXR0dDA6OkpKSgofffQRVlZWODo6irFnaWmJj48PQUFBzMzMYJKbm0t4eDhhYWFUVlYyMTHB3NwcExMTVFRUsHfvXuLj40lMTCQlJYWUlBSOHj1KUVGRCEB1dTUZGRnk5+dTWlpKfn4+RUVF1NbW0tzcLFJTq9UyNjbG4uIis7Oz3Lt3j1evXvH06VMePHjAxsYGz58/5+9//ztVVVX4+voSHR1NVlYWPT09ovsrFAq2bNlCVlYWvb29IgBSNmi1Wj799FMsLCxwdnYWzc/c3BwXFxciIyMxGAx0dXVhEh4eTnR0NAcPHqS0tFSMRKPRSFVVFQEBAcTGxpKcnExSUpIIQHFxMcXFxVRWVlJYWEh+fj75+fkUFhZSWlpKbW0t9fX1tLa20t7eTlNTk3hi8/PzPH78mEePHnH//n1u3LjBkydPePjwIevr62xubvLTTz/R29uLg4MDmZmZ9Pb2Mjg4iMFgQC6Xs2vXLpycnGhoaKC3t5fW1la0Wi3T09NYWlqyfft2XF1dRbpbWlpib2+Pl5cXfX19AjmaREVFERsbS0REBBUVFYyNjTE1NSVwQGBgINHR0aIEkpKSRAbk5OSg0+mQyWTk5eWRl5cnSqC+vp729naam5tpb2+noqIChULBxYsXuXPnDjdu3ODSpUtcv36dp0+f8uTJE548ecL6+jpPnz7l+fPn/M///A/S9+vu7hbEp7a2FktLSz755BOCgoJQqVQ0NzfT0dFBamoqn3zyCXZ2djg4OIiGZ2dnx2effYZer6e1tRWj0cj09DQmMTExHDlyhNDQUIqLiwUGmJiYQC6X4+/vz5EjR4iLiyMhIUFMgZycHLKysjAajSQmJpKbm0tubi7FxcUolUoBeKTJoNFouH37Nmtra1y8eJGVlRXu3r3LnTt3uHfvHvfv3+fhw4c8fPiQZ8+esbGxwdu3b3n37h0ODg7odDoGBgYwGAwoFAosLS357W9/S2hoKF999RXv3r3jp59+4l//9V+xtrbGyclJID57e3u2bNlCZWUlOp3uPT5hIh0uMjKSwsJCxsfHRQ+orKzEy8uLiIgIMQGSkpJIT08nOzsbg8FAU1MTCQkJ5Ofnk5OTg1wup6qqiqqqKurr60lPT8doNHLu3DmmpqY4c+YMS0tLXL9+nc8//5xr165x5coV7t69y/3790UgNjY2ePz4MT/++CMlJSW0trYyMjLCyMgIVVVVmJiY0NLSwrNnz3jz5g1v377lv//7vzl8+DC7d+/GwcEBS0tLzM3NsbW1JSQkhNHRUfr6+t7jFCYJCQkkJycTGxtLYWEhY2NjzM3NMTs7i1wuZ+/evURHR5OSkkJqaqoYSxkZGZw9e5aSkhISExPJyMigtLSU0tJS0f2zs7MZHR1lYmKCiYkJFhcXOX/+PGfPnuX8+fMsLS1x/vx5rl+/zq1bt7h79y4PHz7kwoULPHjwgMePH/Pw4UO+/fZbkQFdXV0kJydz+fJlHj9+zJs3b3jy5AkPHjzg559/JiYmBgsLC2xtbTE3N8fe3p4//OEPGAwG9Ho9ExMTjIyMCDZpkpKSQmJiIjKZjPLyckZHR1lYWGBhYQGlUom/v7/AAdJns7KyiImJ4erVqxQUFIjpkJ2dTVlZGRUVFRQWFgq42tHRwdTUFCsrK8zMzHDu3DlmZ2dZXl7m7NmzAhdcuXKFM2fO8MUXX3Dv3j1u377N7du3uXHjBnfv3qW5uZmVlRWePXvGw4cP2dzc5P79+zx+/Fj0DInkSE/fzMyMzMxMhoaGGBsbY2xsTJCpoaEhTJKTk0lMTCQ+Pp6ysjImJyc5deoUp06dQqVS4efnR0xMDElJSSQmJpKQkEBGRgYhISG8e/cOhUJBeno6GRkZgiYXFhbS09NDd3c3DQ0NDA4OcuzYMebm5jh+/DgTExMsLS1x+vRpTp48ydraGhcuXGB1dZXLly9z/fp1Ll26xNmzZ7l48SInT558L0uePn3Ko0ePuHv3Luvr69y+fZsXL17w97//nX/5l38RWN/KygofHx+OHTtGX18fExMTgkpLQpCJdKjY2FhKSkqYmpri1KlTnDx5EpVKxd69e4mLixP1n5iYSFpaGuHh4bx9+xadTodcLheNMDs7m46ODrRaLXK5nMHBQXQ6Hd3d3UjEa2FhgdnZWU6cOMHc3ByTk5P/v0Csra0xMzPDwsICFy9e5OrVqzx58oR79+5x584d7t+/z6NHj3j8+DGjo6NcvHiR8fFxwfjMzc0xNzdHoVDQ29vLxMQE4+PjSBKglAkm8fHxxMXFER0dTUVFBVNTUywsLHDixAnUarUIQFJSEgkJCSQmJpKUlERcXByPHz9maGiI5uZmUlNTSUtLQ6vVUl9fT0VFBTqdTsxnvV4vGs/k5CTT09NMT08zOjrK9PS0yI75+Xnm5uYwGAycPn2aS5cuce/ePe7evcu1a9e4efOmmBZv375lfn6esbExLly4wIEDBzA1NRXpHxkZyejoKENDQxiNRkZGRoSeIElrJlL6JyYmUllZ+V4GNDQ04OvrK0agFACZTEZaWhqvX79menqawcFBCgsLhcRVVlZGZ2cnTU1NqNVq2tvbGRgYQK1WC77f0dGBUqlkcnKSyclJZmZm0Ol09PX1MTw8zNmzZ0XtX758mRs3bnDv3j0eP37MkydPePPmDc+ePUOpVBIbG8uf/vQnfvWrX2Fra4ujoyN79uyhvb2dnp4exsfHOXbsGAaDQdS/aIJSWicnJyOXy5mZmWFxcZFTp07R1NSEt7f3e2xQCkJkZCTffPMN58+fp66ujrKyMsrKysjPz0ej0aBSqZDL5ajValEOSqWSrKwsQkJCGB4eJjU1lUOHDhEREYG5uTl//OMfqa6uZnV1lTt37nDr1i3RBCWs8Pz5c968ecPo6CiRkZHs3buXzc1NEhMT2bNnDxYWFlhYWBAQEMDw8DAjIyMYjUbGx8cZGRlheHhYAKqhoSFM0tPTBc6vqalhZmaGkydPcurUKRobG/H39xdkSOoDCQkJeHp68s0333DlyhWht6WkpNDa2iqEDZVKRVtbG2VlZTQ0NJCcnExoaChWVlbk5eURFhZGQkICAQEB/Nu//RtNTU0sLi5y7do1bt26xdWrV7l+/TrXr1/n4cOHvH79muPHj+Pp6UlISAgKhYJXr15x+PBhtmzZgpWVFTY2NpiZmaFWq+nr6xPMdnx8/L0GKPEKk8zMTFJTU0lMTKSmpkb0gJMnT9LS0iL0gPj4eNEEk5KSCA8PZ35+nkePHjEwMEBFRQVqtZqamhpBkJRKJQqFgvz8fLy9vXFzc2P37t3Exsbi4eFBRkYGbm5u+Pj4oNFoOH/+PJcvX+b8+fOcO3eO8+fPc/XqVR49eoTRaOTgwYMUFBSIMn358iVxcXFC57OyssLKygpnZ2eR5rOzs0xPT2M0GoX4K70GBwcxycrKIj09HZlMRklJCdPT0yIDWltb8fLy4siRI8THx5OQkEB8fDwpKSmkpaURFxfHN998w9raGrm5uSiVSsrKyqitrRXpHxISQnBwMI6OjkRERLB9+3b27t2Lo6Mjnp6eJCUlUVhYKNDg2bNnOXv2LIuLi1y4cIEvvviCtbU1bGxsyM7OpqqqipGRER49eoS/vz9//OMfsbOzw9nZGTMzMywtLcnOzqatrY0TJ04wNTXF5OSkkPqlRvxeANLS0oiNjSUvL4+pqSlOnjzJmTNnaGtrw9vbm/DwcHF4iQ/k5eURGRnJ6uoq9+7do7y8XCiwkjB65MgR3N3diYqKwtzcnPDwcEFP3d3d8ff3Jzk5mbGxMS5dusTy8jKLi4ssLS1x6tQprly5wo0bN1hfX6e0tJSgoCByc3MxGo3Y2Niwbds27O3tcXV1xcrKSiDAhoYG9Ho9CwsLQt6bnJzEaDQKDjAyMvJLD5Dk7piYGHJzc5mcnBRNsL29XTRBiQrHx8eTlpZGQUEBCQkJLC8vc/z4cdLS0igpKaGqqoqmpib8/Pzw9PRkx44d+Pv74+/vj7OzM+np6ezZs4c9e/ZQVlaGXq/n2rVrfP7554yOjrK2tsb4+DhXrlzh/v373Llzh83NTQYGBti5cyeBgYGcOnWKHTt2YG5ujqOjIx4eHpiZmWFqakp0dDRtbW0MDQ0xMTHB7OwsExMTYtpIGTA6OsrAwMD/BUDKAAkJnjlzBo1GQ0BAAIcPHxZzPjExUSC+3NxcmpqaGB0d5ejRo4IISU/Z19cXZ2dnLCwscHBwQCaTceTIET744AM0Gg3nzp0TI295eVmM1JWVFW7cuCFg7uvXr/n8889xdHRk27ZtTE9PY21tjZ2dHa6urri5uWFhYcH27dtpampCr9czPj5Ob28ver1eTIOJiQmRAQaD4ZcApKenk5ycTFRUFNnZ2QKmLi0t0d7ezt69e4Ugkp6eTkpKCjk5OUITzM/Pp7GxEblcLsamp6cnu3fvxsvLC3d3d5ycnLCxsSEwMBBzc3OqqqowGo1cunSJ8fFxrl+/ztjYGMPDwywsLLC8vMzt27e5d+8eT5484eXLlzx//pzo6Gh+97vf0d/fj4ODAw4ODnh4eGBnZ4eNjQ3u7u7odDpR8xL6Gxoaoru7G51Oh16vF1hjYGDg/8hQTEwM2dnZTE5Ocvr0adEDAgICiIqKEhkgkZ6SkhKUSiXl5eWkpqbS2dmJTCbDx8eH0NBQtm/fTkhICJ999hkeHh54enpiZWVFdHS0WMCura1x69YtcnJyUCqVTE9Pc+nSJbE/uH79Onfv3uXNmzd8/fXXHD58mA8//JCamhoOHTokJoi1tTV79uwhNzeXtrY20fUldWtiYgKDwUBfXx/d3d1COe7q6volABkZGcTFxZGZmSkCsLKyQmdnpxBFpcNL0nhubi79/f1kZGSI4Hl5eeHl5UVycjJ79uzB1dUVR0dHLCws2L9/P3Z2doyOjnLlyhUWFha4fv06crmczs5O1Go1fn5+5Ofns7CwwMrKCleuXOHOnTtotVqBP3bs2CFUKRcXF5ydncXsb2lpoaenh4mJifeQn5RdBoOB0dFRwU8aGxv/DwlGRkaSkpLCxMQEy8vLLC0todVq8fX1FX+Lj48nOjoapVIp5mxbWxuurq54e3uLxYmpqSkHDx7kD3/4A3FxcVhbW/Ob3/wGjUbD2toaT58+ZWlpCUtLS3bv3s327duxs7PDy8uLuro62tvbOXnyJF9++SVFRUXY29uze/dunJ2d2b17N4cPH6a6uhpnZ2esra2xsbHBycmJ7u5ugfmlA//z/lBaq/X29tLd3U1ra+svXEAmkxEaGkpcXJzg7Wtra7S3txMQECDYYHp6OgcOHKCkpITl5WWUSiUODg74+vri4eGBg4MDFRUVbN26FQsLCwIDA9m1axe7du1i3759TE5OCnwfERHBZ599RkxMDI6Ojvzv//6vUIBVKhUXL15kbW0NKysrYmNjaWtrY9u2bezcuZODBw/S1NSEl5cXlpaWmJqakp6eLpqf1OAGBgbe2x/29fUJTVAul6PRaDCROntoaCixsbFMTU2xurrKuXPn6OrqIiQkhOTkZAoKCggKCiIlJYXp6WmGhoawtbXlwIEDeHh4sH//fo4cOUJtbS1eXl7s2rULKysrIV729vZy8eJFbt26RXp6Om1tbTQ0NFBSUoJer2d6epq+vj6xHrt9+7Zwqej1eoKDg3F1dcXCwoKgoCB0Oh1eXl4C/NTX1wuHi+QZkFboAwMD6PV6Ojo6qK+vR6PRcPr0aa5evfqLIBIVFUVgYCCHDh1icnJSCJd6vZ59+/aRmJhIZmYmzc3NNDc34+fnJ2Tp6upq9u3bh4uLi1hjBQUFsWfPHiwtLdm6dSvJycmcPHmSjY0N9u/fT11dHQMDA+LLSoxtZGQEtVpNSUkJ586dY2Njg56eHlQqFTk5OQQHB7Nnzx48PDwYHx/Hzs4OS0tLbG1t6ezsFLUu2Wf6+vro7+9Hr9fT2dmJQqFgbm6Ou3fvcvPmTa5cufKLKnzw4EG8vb0JCwtjcnJSLC/1ej2BgYHEx8dTU1NDa2sr+fn5hIWF4eHhQX5+Pnl5eWzduhU3NzcSEhJISUkhKytLyFFOTk50dHTw3Xff4ezsTH5+PiqVir6+Pubm5jhz5gyLi4ucPn2awcFBQZ7m5uZ49eoVRqORpqYmlEolhw4dEnLX8vIy27ZtEz1Bqn/piUuBlQ6vUqnEPuL27dt88cUX3Lx5E5Pg4GCCgoJwc3MjJCSEiYkJzpw5w+rqqsgAmUzG0aNHyc7OJjY2lvDwcPz8/CgqKsLJyQlLS0uxeNiyZQsqlYqQkBA+/PBD0tLSuH//PsXFxVhZWYn9gFarZXR0lNOnT7O0tMTx48fp7e2lvb2dyspKDAYD7969w2Aw0NHRQV1dHf7+/tjY2LBz504uXbrEJ598gqWlJWVlZULoGB4epq+vTxxep9PR1NSEVqvl4cOH3LhxQ4Csp0+fYrJ//37279+Pk5MT+/btw2g0CiSo0+nw8PCgrKyMlpYWsT3y9/cnMjIShUJBWFiYQGghISG4uroyNTWFTCbjo48+QqvVsr6+zq9+9St8fX0pKipCoVCg0WgYHBxkcnKSubk5pqenaW9vR6FQUFRUREdHB3/961/p6elBo9GgVquxsrLC09OTbdu2MTs7i7u7Ozt37qSrqwuj0SiETintpaVpbW0tV69eFdrC06dPefHiBY8ePcIkLCyM/fv3Y21tjbe3N0ajkaWlJVZXV+np6cHHx4f8/HwqKytFPwgICCAiIoL6+np8fHywsbFhx44dyGQyqqqq8PDw4Ne//jWVlZWsrKzg4ODAzp07xda3traWpqYmdDod/f39gp1JGoJKpaKxsZEffvgBnU6HRqOhuLiYrVu34ufnx7Zt2+jp6SEyMhJXV1fhH5K8QpJxQq/X09TUxODgII8ePeL69eusr6+zsbHB+vo6z549+78AuLi4EB4eLjJgdXWV3t5eDh06RExMDHl5eQQHB5ORkUFERARubm7k5OTQ0tLCp59+iqurK9u2bUMmk/G73/2OoKAgNjY2kMvlfPDBB5ibm4sVWnV1NY2NjXR3dwvHx8jICHV1dRQXFyOTyUhJSeHzzz+nq6sLjUaDn58fpqam+Pj4YGpqilKpRCaTkZSUJLD+Pzc/SYhVqVScPXuWu3fvigXss2fP2Nzc/CUAEl93d3enqKgIyTGytrbGwMAAgYGBREVFoVarcXR0JDAwkP379xMSEkJhYSEqlQpvb2+qqqoE8+vv76e4uJjp6Wn+/d//HW9vbywsLDh69CglJSVUV1ejVqvRaDR0dXUJ2XxwcJDGxkYGBgbE0kSr1aJSqQRYCgsLw8bGRrjW1Gq1ADsDAwP09vYKEqTValGr1UJO39zcZH19nefPn/P8+XM2NzcxCQwMxM/PD2dnZ4qLi5mcnOT48eOcPXuWoaEh/P39SUxMFEuS6OhoXFxc8PX1JTw8XMz+vXv3Ym9vT3d3NwsLC5SVlWFmZoaVlRUeHh5s375dmCdqamqoq6ujra2N5uZmenp6RMr29vayvr7OgwcPuHTpEh0dHYSFhWFmZoajo6MIQHBwMLW1tXR0dAhuLx1eIj0ajYaWlhbu3bsnUn5jY4ONjQ1evnzJy5cvMXFxccHb2xsXFxfy8/OZmZnh1KlTnDt3jqGhIfz8/MjNzaWiogJHR0f8/Pxwc3MjPj6emJgY9u7dS1lZGcHBwSwsLPDw4UNSUlKIiIjA1dWV3bt34+vry+7du8WYlKSylpYW2tvbhRWupqZGrN2VSiUlJSV0dXUJl4e7uzsHDx7ExcUFR0dHtFotXV1dgtv/cyC7u7tpa2ujra1NMEop7V+8eMGbN2949eoVJhKl9PLyEh6hM2fOcO7cOXp6eigqKiIuLo7i4mL8/f357LPPCA0NpaKiguDgYLKysggICKChoUE8+fb2drZv346ZmRk2Nja4urpib2/PoUOHOHLkiHBvqlQq9Ho9jY2Nwm6j0+mYnp4W7O3AgQPvYYrIyEj8/Pz47LPPmJycpKenRyC+wcFBMf70ej3Nzc3odDrevn3LixcveP78OS9evOD169e8evWK58+fYyJxaW9vb7KzszEajQIKHzt2DAcHB5RKJcHBwSQkJODo6Ii3tzeNjY0UFhYSHByMSqUS3XZxcZEdO3a8t5p2d3fH2dmZ0NBQfH19hb9AcpJJ46+qqoqioiIqKyvFXmHr1q3C5uLm5sbBgwcF0pyfnxfwVyI/g4OD6PV6urq6aGhooKenh++++46XL1/y9u1bsU94+vQpGxsbmEiGwaioKAoLCxkeHhZAaGhoCA8PD974goYAAAvXSURBVIqLiwkJCRGkZ9euXbS2ttLY2Cg8xPHx8Vy5cgVra2vxhaXgOjg44OrqKgQMKXP+2UrX0dGBXq9nbm5OrK88PT357LPPcHJywtnZGQ8PDyIjIwkKCmLXrl2cOXOG3t5eRkdHBdsbHBykt7eXrq4uFAoFfX19/OUvf+HNmze8fv1a1L6UCSaSmCCBHIPBwJkzZ1hbW8NgMODq6kp0dDQ2NjYCMu/evZuysjLc3d1pbm5GpVKJkrCxscHOzg4PDw/s7e0FXpcMC25ubjg4OGBvb096erqA2D09PczNzTEzM8P8/DwajYZPP/0UJycnPD09sba2JjAwkCNHjhASEoKZmRnLy8v09vaKCSJB4O7ubjo6OqiqqmJ+fp6//OUvbG5u8vbtW169esXr1695+/Ytc3NzmFhYWLBz5048PT05evQo4+PjLC4usry8THt7O6WlpSiVSmxtbfHy8sLDw4OPP/6Y7u5ugoODiYqKIj8/n+HhYRobG3F2dsbU1JR9+/Zha2uLlZWVCIJUCnv37iUoKAiZTEZ+fj7V1dUCGUqIrq+vT+gAkrVN4iURERE4Ojpy6tQpjh49SmVlJY2NjWi1WsH82tvbyc/P58GDB3z11Vfvjb7R0VHMzc356KOPfgFCkosiODiY4eFhTpw4weLiIgsLCxw+fJgjR46wfft2goKCcHV1xcvLSxgaJUNzTk4OMpmM0dFR7OzsxLSQAmBlZYWLi4uQsUtKSoRVvqmpSVhhW1tbmZmZ4cGDB3z77becPHkSX19fPvzwQ/bt20dsbCyhoaF4e3szPj6OUqkUAm1aWpqYKBUVFaSlpfHq1SuePHnC5uYmb968YXx8XMjpUVFRmOj1evLy8vD398fa2pre3l4WFhZYWlqiu7ub2tpa3N3d+fjjj8nNzcXd3Z2srCzMzMzIzs4mJyeHsLAwampqaG5uJjo6mtTUVGxtbXFzcxMuLakp+vj4YG9vT25urrjJ0dzcTGtrK83NzfT29gqufuPGDTY2NvjP//xPNBoNn3zyiZgCwcHBGAwGdDodnZ2dtLS0UFtbS15eHtHR0ZSWluLr6yusd19++SWDg4Ps2LGD/fv3ExUVRUREBCYtLS0YjUaKioowMzNjYGBA+HgkV8Unn3yCjY2NQIIuLi4EBwcTEhKCg4MDoaGh5Obm0tfXR2JiIhUVFUIRdnR0xMHBAXd3d1xdXYmNjcXa2lrY6RoaGmhpaRF2utHRUebm5lhZWeHSpUvcunWLJ0+e8MMPPzAyMsK2bdvw9/cnPDycvr4+4RmWbLPS/QSVSkVJSQnv3r3jyy+/5OnTp1haWhIbG0t0dDQ5OTlER0dj4u7uzvHjxxkbG2PXrl0MDw+zurrK6uoqIyMj5OTk8PHHH4suvmvXLpKSkkTfiIqK4sCBAyQmJlJeXo7BYCAgIICCggIsLCyEQVGSrwoKCoT3T7pf1NbWJnwEUh+QVOOrV68KDP+Pf/yD6OhoTE1NiY2NRa/XCydKZ2cnHR0dtLS0iIsbRqORP/3pT3zzzTd0dXURFBREfHw8BQUFxMbGkp6ejsnHH3/MzMwMJ06c4Pe//70IwNraGiMjI2RmZrJz505cXFywsLDA0dGRQ4cO4ejoiLu7Ox4eHqSmpgpILHGG6upqLC0t8fX1xdLSEkdHR6ytrcnLy8PNzY28vDwUCoUYg1IAJE/w/Pw8y8vLXL58mfv37/Ps2TO+/PJLvv76a0xMTMjMzKS/v18InB0dHTQ3N9PY2EhxcTGrq6tsbm7y7t073rx5Q0xMDDExMWKjJVl9TH77298K8vEf//EfDA8Ps7a2xvnz5xkdHeXgwYPY2dlhamrKtm3byM7Oxt3dHRcXF8zMzDAzM8Pf35/09HTKy8tpa2tjYGBAqMHOzs7CsBgcHCyEjfz8fBoaGmhqahI/Ozs70el0GAwGJiYmOH36tDBWbmxs8OLFC/7xj3+IQA4NDaHT6ejq6hKmzJqaGtra2vjb3/7G8+fP+fbbb5mZmeHQoUMkJCRQXFwslkCJiYm/BKC7u5vV1VV27NhBf38/KysrLC0tMTY2RlRUlND3XF1dcXd3x9vbG1dXV8zMzLC1tcXf3x9fX1+6u7uJi4sjMTGRuLg4sQqTTMqZmZk0NDTg4+NDeXk5dXV1aDQaGhsbRSlIo0yy650/f54bN27w+PFjNjc3+f7776mpqaGkpITBwUHhE5bSv6qqivHxcd69e8erV694+/YtFRUVJCUlkZmZKZxuaWlpvzTB3//+91RVVXHhwgWsrKzo7u5mbW2NtbU1JiYmiI2NZdeuXSKdbW1txTLCwcEBZ2dn9u/fj0wmQ6FQUFhYSEhICNbW1jg4OODp6Sn2hFLT8/LyEj7i1tZWWlpaaGhoEIiwt7eXkZERpqenWVpa4tq1azx48ID19XXevn3LpUuXqK6uFqhPmgTNzc2o1Wo6Ozu5efMm79694+rVq2RkZAhfw8GDB8nMzBQPyuSjjz4iKyuLs2fP4u3tTVtbG8vLy6ysrGAwGMjPz2fnzp24u7tjZmYmcICjoyM2NjZ4enoSGBiIj48PgYGBuLu7Mzw8zJ49e7C2tsbU1BRTU1NiYmKora0lOTmZ6Oho0fk7OzsFrJYM1T09PfT39zM+Ps6JEye4dOmSKIOXL1/yww8/UFxczOHDhykpKUGj0QgNoL+/n+bmZrq7u/nxxx+ZmJhAJpMhk8kIDAwkMzOTmJgY4VYx+eCDD4iLi+PGjRuEhoZSV1fH0tISa2trTE5OIpPJsLGxYffu3bi5ueHs7IyTk5MIiIODA/v370ej0bBv3z5iYmKwtrbG3NwcS0tLduzYgbe3NyUlJdTW1mJhYSFukUh0VaPR0NzcLEaiVqsVEHd2dpbV1VVu3rzJkydPePHiBX/+85+pqakhJCSEffv24e/vT2BgIDExMWi1WoaGhrhw4QLff/89mZmZeHp6vudxkMlkZGRk/HJtbu/evaSmpnLv3j3S0tJQKpUsLy9z7tw5RkZGkMlk7Nq1CwcHB2xtbQXAcXd3F4e0sLAgKiqKrq4uCgoK2LFjB6ampuzatQtzc3Pi4+NRqVS4ubkRExMj9gvNzc20tbXR3t5OW1vbexNBp9MxNDTE+Pg4p0+f5osvvuDBgwc8e/aMr776ijNnzhAXF0d2djZHjhzBzc2N3/zmN1RWVnL16lXevn3LwsIC5ubmBAYGiivAISEhZGdnExUVhYODAyaxsbGo1WquXbsm7tYuLy+LxUhSUhJ79uzBysoKBwcHLCwscHNzw8vLS/jvvby8cHNzIzk5mcjISHbv3o2ZmRk7duzg0KFD5Obmikypq6ujvr5eHFQSRaQgSIhQq9WKhcn09LTYJEuK7p///Gf8/PzE9drIyEg8PDyQy+X87W9/w2AwYGZmJrZWubm5YtGbn5/PoUOH8Pb2xkQyK50/fx6lUkllZaUIwPT0NA4ODpibm+Ps7IyVlRXu7u6CE6SmpuLl5YWTkxOBgYHI5XJCQ0NFACQZy9PTk7y8PHG1Tq1Wi6YnZYBOp6Ojo0MEoa2tTYxEyWV+5coVHj58yPPnz/nrX/9KWloaCQkJZGdni9tsZWVldHR04OnpSXBwMPv27aOkpISgoCC8vb0pLS0lJycHT09P3NzcfhFEAgICuHPnDpOTk5SVlQkA0t/fL25Z2dvb4+bmhqurK6GhoezZs4eqqipsbGwIDQ3l0KFDHDhwgIiICLGxCQ0NJS8vj7KyMnGXULonLM3+f26GXV1ddHV1if29JJsbjUZOnjwp7hs+ffqUr7/+ms7OTsLDw4VkV1ZWRm5urnC+R0ZGkpqaSmBgIL6+vmRmZlJbW0t4eLho4ibSbu3Vq1dcu3aNkpISzpw5I0rA1NQUKysrvLy88Pf3x9vbW9jcDhw4QGxsLEeOHMHZ2RlXV1dkMhl+fn4EBASIO3/SFVvJPCUF4J9LQYKyXV1d9PT0oNPpxDUZyeuzsrIiRuKLFy+4du0aISEhJCUlCdpeUlJCQ0ODIEUHDx4kIiICmUxGa2srMplMWHbi4+P5f2Zdu6rP1UixAAAAAElFTkSuQmCC"></p>
<p>給一張 <span>$64 \times 64$</span><!-- Has MathJax --> 的經典 Lena 影像，共有 <span>$4096$</span><!-- Has MathJax --> 個像素，程式碼長度上限 10K，避開打表的長度限制，輸出一模一樣的圖形。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NO INPUT</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">64 64</div><div class="line">153 153 153 151 151 151 148 148 148 (後面省略)</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><h3 id="前處理"><a href="#前處理" class="headerlink" title="前處理"></a>前處理</h3><p>首先遇到的問題是將灰階圖片取出，變成一般常看到的數字格式，直接用 python 來完成，必要時需要安裝 install Python Imaging Library <a href="http://www.pythonware.com/products/pil/" target="_blank" rel="external">PIL</a>，這是前處理，也可以用其他的 OpenCV 來完成。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ python img2txt.py b454.png &gt;in.txt</div></pre></td></tr></table></figure>
<figure class="highlight py"><figcaption><span>img2txt.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> Image</div><div class="line"><span class="keyword">import</span> codecs</div><div class="line">sys.stdout = codecs.getwriter(<span class="string">'utf8'</span>)(sys.stdout)</div><div class="line"><span class="keyword">for</span> infile <span class="keyword">in</span> sys.argv[<span class="number">1</span>:]:</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        im = Image.open(infile)</div><div class="line">        gray = im.convert(<span class="string">'LA'</span>)</div><div class="line">        width = gray.size[<span class="number">0</span>]</div><div class="line">        height = gray.size[<span class="number">1</span>]</div><div class="line">        pix = gray.load()</div><div class="line">        <span class="keyword">print</span> height, width</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(height):</div><div class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(width):</div><div class="line">                <span class="keyword">print</span> pix[j, i][<span class="number">0</span>], </div><div class="line">            <span class="keyword">print</span> </div><div class="line">    <span class="keyword">except</span> IOError:</div><div class="line">        <span class="keyword">pass</span></div></pre></td></tr></table></figure>
<h3 id="建表壓縮"><a href="#建表壓縮" class="headerlink" title="建表壓縮"></a>建表壓縮</h3><p>由於 4096 個像素，若使用十六進制表示每一個 <code>0 - 255</code> 像素，只需要 2 個字元 <code>00 - FF</code>，程式碼長度大約會落在 8192 bytes，若使用十進制，需要使用 3 個字元表示，那麼大約是在 13KB，所以至少要用十六進制表示法。</p>
<p>還有更好的方式，如一般常在網頁上瀏覽的 base64，它充分利用 64 個可視字元進行編碼，相較於十六進制只使用 16 個可視字元來比較會更加地短。利用傳統的霍夫曼編碼 (huffman coding) 來壓縮，結果會短個 10% 到 20%，當每種像素次數分布相當懸殊時，效果就越好，但上傳時還要附加解壓縮的代碼，所以沒辦法短太多，還不如直接 base64。由於是圖片，漸層效果比較普遍，改用與前一個相鄰像素的差值來轉換，得到的分布會比較極端，帶入 huffman 的效果就會不錯。</p>
<p>最後，還有一種比較容易實作的 lz77 壓縮，比較類似最長平台，每一次的訊息為 <code>(起始位置, 重疊長度, 補尾字元)</code>，設定一個 window 長度，然後 sliding 滑動，但是起始位置、長度需要選好，代碼中嘗試用 <code>window size = 16</code>，則起始位置和重疊長度可以用 8-bits 表示，越大不見得越好，太小也不是好事，但不管怎麼做，由於影像的重複 pattern 並不多，沒有像一般數學性質的數列來得強，壓縮實驗不管怎樣都大於 10KB。</p>
<p>關於實作細節，霍夫曼編碼儲存格式是 <code>壓縮位元長度 bits length + 字典表 + 壓縮資料</code>，對於字典表的儲存有很多種，由於是 complete binary tree (只會有兩個、零個子節點)，可以用一個 0 / 1 前序走訪來完成，這會造成解壓縮代碼長度就會有點虧本，所以在代碼中直接使用一般的打表，所以要保證每一個壓縮完的最大 bit-length 小於 32 來方便型態 int32 操作。</p>
<table>
<thead>
<tr>
<th>方法</th>
<th style="text-align:center">代碼長度 (bytes)</th>
</tr>
</thead>
<tbody>
<tr>
<td>base64</td>
<td style="text-align:center">6485</td>
</tr>
<tr>
<td>huffman+base64</td>
<td style="text-align:center">7965</td>
</tr>
<tr>
<td>diff+huffman+base64</td>
<td style="text-align:center">7717</td>
</tr>
<tr>
<td>lz77+base64</td>
<td style="text-align:center">&gt; 10K</td>
</tr>
</tbody>
</table>
<h4 id="產生器"><a href="#產生器" class="headerlink" title="產生器"></a>產生器</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lz77_encode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line">    m = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (n &lt;= <span class="number">16</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            out[m++] = in[i];</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">memcpy</span>(out, in, <span class="number">16</span>);</div><div class="line">    m += <span class="number">16</span>;</div><div class="line">    <span class="keyword">while</span> (n &gt; <span class="number">16</span>) &#123;</div><div class="line">        <span class="keyword">int</span> mx = <span class="number">0</span>, offset, i, j;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (j = <span class="number">0</span>; i+j &lt; <span class="number">16</span> &amp;&amp; j+<span class="number">16</span> &lt; n &amp;&amp; in[i+j] == in[j+<span class="number">16</span>]; j++);</div><div class="line">            <span class="keyword">if</span> (j &gt; mx)</div><div class="line">                mx = j, offset = i;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mx &lt;= <span class="number">1</span>) &#123;</div><div class="line">            out[m++] = <span class="number">0</span>;</div><div class="line">            out[m++] = in[<span class="number">16</span>];</div><div class="line">            in++, n--;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            out[m++] = (offset&lt;&lt;<span class="number">4</span>)|(mx<span class="number">-1</span>);</div><div class="line">            in += mx, n -= mx;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lz77_decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line">    m = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (n &lt;= <span class="number">16</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            out[m++] = in[i];</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">memcpy</span>(out, in, <span class="number">16</span>);</div><div class="line">    in += <span class="number">16</span>, n -= <span class="number">16</span>, m += <span class="number">16</span>;</div><div class="line">    <span class="keyword">int</span> offset, mx;</div><div class="line">    <span class="keyword">while</span> (n &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (*in) &#123;</div><div class="line">            offset = (*in)&gt;&gt;<span class="number">4</span>, mx = ((*in)&amp;<span class="number">0xf</span>)+<span class="number">1</span>;</div><div class="line">            <span class="built_in">memcpy</span>(out + m, out + m - <span class="number">16</span> + offset, mx);</div><div class="line">            m += mx;</div><div class="line">            in++, n -= <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            out[m++] = in[<span class="number">1</span>];</div><div class="line">            in += <span class="number">2</span>, n -= <span class="number">2</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">base64_encode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> encode_table[] = &#123;<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>, <span class="string">'E'</span>, <span class="string">'F'</span>, <span class="string">'G'</span>, <span class="string">'H'</span>,</div><div class="line">                    <span class="string">'I'</span>, <span class="string">'J'</span>, <span class="string">'K'</span>, <span class="string">'L'</span>, <span class="string">'M'</span>, <span class="string">'N'</span>, <span class="string">'O'</span>, <span class="string">'P'</span>,</div><div class="line">                    <span class="string">'Q'</span>, <span class="string">'R'</span>, <span class="string">'S'</span>, <span class="string">'T'</span>, <span class="string">'U'</span>, <span class="string">'V'</span>, <span class="string">'W'</span>, <span class="string">'X'</span>,</div><div class="line">                    <span class="string">'Y'</span>, <span class="string">'Z'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>,</div><div class="line">                    <span class="string">'g'</span>, <span class="string">'h'</span>, <span class="string">'i'</span>, <span class="string">'j'</span>, <span class="string">'k'</span>, <span class="string">'l'</span>, <span class="string">'m'</span>, <span class="string">'n'</span>,</div><div class="line">                    <span class="string">'o'</span>, <span class="string">'p'</span>, <span class="string">'q'</span>, <span class="string">'r'</span>, <span class="string">'s'</span>, <span class="string">'t'</span>, <span class="string">'u'</span>, <span class="string">'v'</span>,</div><div class="line">                    <span class="string">'w'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>, <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>,</div><div class="line">                    <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>, <span class="string">'+'</span>, <span class="string">'/'</span>&#125;;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> mod_table[] = &#123;<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>&#125;;</div><div class="line"></div><div class="line">    m = <span class="number">4</span> * ((n + <span class="number">2</span>) / <span class="number">3</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; n; ) &#123;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> a, b, c, d;</div><div class="line">        a = i &lt; n ? in[i++] : <span class="number">0</span>;</div><div class="line">        b = i &lt; n ? in[i++] : <span class="number">0</span>;</div><div class="line">        c = i &lt; n ? in[i++] : <span class="number">0</span>;</div><div class="line">        d = (a&lt;&lt;<span class="number">16</span>)|(b&lt;&lt;<span class="number">8</span>)|c;</div><div class="line">        out[j++] = encode_table[(d&gt;&gt;<span class="number">18</span>)&amp;<span class="number">0x3f</span>];</div><div class="line">        out[j++] = encode_table[(d&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0x3f</span>];</div><div class="line">        out[j++] = encode_table[(d&gt;&gt;<span class="number">6</span>)&amp;<span class="number">0x3f</span>];</div><div class="line">        out[j++] = encode_table[d&amp;<span class="number">0x3f</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mod_table[n%<span class="number">3</span>]; i++)</div><div class="line">        out[m - <span class="number">1</span> - i] = <span class="string">'='</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">base64_decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> decode_table[<span class="number">256</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'A'</span>; i &lt;= <span class="string">'Z'</span>; i++)	decode_table[i] = i - <span class="string">'A'</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'a'</span>; i &lt;= <span class="string">'z'</span>; i++)	decode_table[i] = i - <span class="string">'a'</span> + <span class="number">26</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'0'</span>; i &lt;= <span class="string">'9'</span>; i++)	decode_table[i] = i - <span class="string">'0'</span> + <span class="number">52</span>;</div><div class="line">    decode_table[<span class="string">'+'</span>] = <span class="number">62</span>, decode_table[<span class="string">'/'</span>] = <span class="number">63</span>;</div><div class="line">    m = n/<span class="number">4</span>*<span class="number">3</span>;</div><div class="line">    <span class="keyword">if</span> (in[n<span class="number">-1</span>] == <span class="string">'='</span>)	m--;</div><div class="line">    <span class="keyword">if</span> (in[n<span class="number">-2</span>] == <span class="string">'='</span>)	m--;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; n; ) &#123;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> a, val = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">3</span>; k &gt;= <span class="number">0</span>; i++, k--) &#123;</div><div class="line">            a = in[i] == <span class="string">'='</span> ? <span class="number">0</span> : decode_table[in[i]];</div><div class="line">            val |= a&lt;&lt;(k*<span class="number">6</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">0</span>)&amp;<span class="number">0xff</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">huffman_encode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line">    m = <span class="number">0</span>;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Table</span> &#123;</span></div><div class="line">        <span class="keyword">int</span> f, bit, bn;</div><div class="line">    &#125; tables[<span class="number">512</span>];</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></div><div class="line">        <span class="keyword">int</span> f, tid;</div><div class="line">        Node *l, *r;</div><div class="line">        Node(<span class="keyword">int</span> a = <span class="number">0</span>, <span class="keyword">int</span> b = <span class="number">0</span>, Node *ls = <span class="literal">NULL</span>, Node *rs = <span class="literal">NULL</span>):</div><div class="line">            f(a), tid(b), l(ls), r(rs) &#123;&#125;</div><div class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Node &amp;x)  <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> f &lt; x.f;</div><div class="line">        &#125;</div><div class="line">    &#125; nodes[<span class="number">512</span>];</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Stack</span> &#123;</span></div><div class="line">        Node *node;</div><div class="line">        <span class="keyword">int</span> bit, bn;</div><div class="line">        Stack(Node *a = <span class="literal">NULL</span>, <span class="keyword">int</span> b = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>):</div><div class="line">            node(a), bit(b), bn(c) &#123;&#125;</div><div class="line">    &#125; stacks[<span class="number">1024</span>];</div><div class="line">    <span class="keyword">int</span> size = <span class="number">0</span>, leaf;</div><div class="line">    <span class="built_in">multiset</span>&lt; pair&lt;<span class="keyword">int</span>, Node*&gt; &gt; S;</div><div class="line">    <span class="built_in">memset</span>(tables, <span class="number">0</span>, <span class="keyword">sizeof</span>(tables));</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">        tables[in[i]].f++;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (tables[i].f) &#123;</div><div class="line">            nodes[size] = Node(tables[i].f, i);</div><div class="line">            S.insert(&#123;nodes[size].f, &amp;nodes[size]&#125;);</div><div class="line">            size++;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    leaf = size;</div><div class="line">    <span class="keyword">while</span> (S.size() &gt;= <span class="number">2</span>) &#123;</div><div class="line">        pair&lt;<span class="keyword">int</span>, Node*&gt; u, v;</div><div class="line">        u = *S.begin(), S.erase(S.begin());</div><div class="line">        v = *S.begin(), S.erase(S.begin());</div><div class="line">        <span class="keyword">int</span> f = u.second-&gt;f + v.second-&gt;f; </div><div class="line">        nodes[size] = Node(f, <span class="number">-1</span>, u.second, v.second);</div><div class="line">        S.insert(&#123;nodes[size].f, &amp;nodes[size]&#125;);</div><div class="line">        size++;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> stkIdx = <span class="number">0</span>;</div><div class="line">    stacks[stkIdx++] = Stack(&amp;nodes[size<span class="number">-1</span>], <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">while</span> (stkIdx) &#123;</div><div class="line">        Stack u = stacks[--stkIdx], v;</div><div class="line">        <span class="keyword">if</span> (u.bn &gt;= <span class="number">31</span>) &#123;</div><div class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"huffman error: bit length exceeded\n"</span>);</div><div class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (u.node-&gt;l == <span class="literal">NULL</span>) &#123;</div><div class="line">            tables[u.node-&gt;tid].bit = u.bit;</div><div class="line">            tables[u.node-&gt;tid].bn = u.bn;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            v = Stack(u.node-&gt;l, u.bit | (<span class="number">1</span>&lt;&lt;u.bn), u.bn+<span class="number">1</span>);</div><div class="line">            u.node = u.node-&gt;r, u.bn++;</div><div class="line">            stacks[stkIdx++] = u;</div><div class="line">            stacks[stkIdx++] = v;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> bits_cnt = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)</div><div class="line">        bits_cnt += tables[i].f * tables[i].bn;</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"huffman: %d bit length\n"</span>, bits_cnt);</div><div class="line">    </div><div class="line">    <span class="built_in">memcpy</span>(out+m, &amp;bits_cnt, <span class="number">4</span>), m += <span class="number">4</span>;</div><div class="line">    <span class="built_in">memcpy</span>(out+m, &amp;leaf, <span class="number">1</span>), m += <span class="number">1</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; leaf; i++) &#123;</div><div class="line">        Table t = tables[nodes[i].tid];</div><div class="line">        <span class="built_in">memcpy</span>(out+m, &amp;nodes[i].tid, <span class="number">1</span>), m += <span class="number">1</span>;</div><div class="line">        <span class="built_in">memcpy</span>(out+m, &amp;t.bn, <span class="number">1</span>), m += <span class="number">1</span>;</div><div class="line">        <span class="built_in">memcpy</span>(out+m, &amp;t.bit, (t.bn + <span class="number">7</span>)/<span class="number">8</span>), m += (t.bn + <span class="number">7</span>)/<span class="number">8</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>, mask = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">        <span class="keyword">int</span> bit = tables[in[i]].bit;</div><div class="line">        <span class="keyword">int</span> bn = tables[in[i]].bn;</div><div class="line">        <span class="keyword">while</span> (bn) &#123;	<span class="comment">// LBS</span></div><div class="line">            <span class="keyword">int</span> j = min(bn, <span class="number">8</span> - cnt);</div><div class="line">            mask |= (bit&amp;((<span class="number">1</span>&lt;&lt;j)<span class="number">-1</span>))&lt;&lt;cnt;</div><div class="line">            cnt += j, bn -= j, bit &gt;&gt;= j;</div><div class="line">            <span class="keyword">if</span> (cnt == <span class="number">8</span>) &#123;</div><div class="line">                <span class="built_in">memcpy</span>(out+m, &amp;mask, <span class="number">1</span>), m += <span class="number">1</span>;</div><div class="line">                cnt = <span class="number">0</span>, mask = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (cnt)</div><div class="line">        <span class="built_in">memcpy</span>(out+m, &amp;mask, <span class="number">1</span>), m += <span class="number">1</span>;</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"huffman encode length %d\n"</span>, m);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">huffman_decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line">    m = <span class="number">0</span>;</div><div class="line">    <span class="built_in">map</span>&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; R[<span class="number">64</span>];</div><div class="line">    <span class="keyword">int</span> bits_cnt = <span class="number">0</span>, leaf = <span class="number">0</span>;</div><div class="line">    <span class="built_in">memcpy</span>(&amp;bits_cnt, in, <span class="number">4</span>), in += <span class="number">4</span>, n -= <span class="number">4</span>;</div><div class="line">    <span class="built_in">memcpy</span>(&amp;leaf, in, <span class="number">1</span>), in += <span class="number">1</span>, n -= <span class="number">1</span>;</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"huffman: %d bit length\n"</span>, bits_cnt);</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"huffman: %d leaves\n"</span>, leaf);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; leaf; i++) &#123;</div><div class="line">        <span class="keyword">int</span> tid = <span class="number">0</span>, bn = <span class="number">0</span>, bit = <span class="number">0</span>;</div><div class="line">        <span class="built_in">memcpy</span>(&amp;tid, in, <span class="number">1</span>), in += <span class="number">1</span>, n -= <span class="number">1</span>;</div><div class="line">        <span class="built_in">memcpy</span>(&amp;bn, in, <span class="number">1</span>), in += <span class="number">1</span>, n -= <span class="number">1</span>;</div><div class="line">        <span class="built_in">memcpy</span>(&amp;bit, in, (bn+<span class="number">7</span>)/<span class="number">8</span>), in += (bn+<span class="number">7</span>)/<span class="number">8</span>, n -= (bn+<span class="number">7</span>)/<span class="number">8</span>;</div><div class="line">        R[bn][bit] = tid;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> mask = <span class="number">0</span>, cnt = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bits_cnt; i++) &#123;</div><div class="line">        mask |= ((in[(i&gt;&gt;<span class="number">3</span>)]&gt;&gt;(i&amp;<span class="number">7</span>))&amp;<span class="number">1</span>)&lt;&lt;cnt;</div><div class="line">        cnt++;</div><div class="line">        <span class="keyword">if</span> (R[cnt].count(mask)) &#123;</div><div class="line">            out[m++] = R[cnt][mask];</div><div class="line">            cnt = <span class="number">0</span>, mask = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m;</div><div class="line">    <span class="keyword">int</span> data[<span class="number">64</span>][<span class="number">64</span>];</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> in[<span class="number">32767</span>], in2[<span class="number">32767</span>];</div><div class="line">        <span class="keyword">int</span> stat[<span class="number">256</span>] = &#123;&#125;;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;data[i][j]);</div><div class="line">                in[i*m+j] = data[i][j];</div><div class="line">                stat[data[i][j]]++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> lz77n, b64n, elz77n, tn, hufn, ehufn;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="number">4</span>][<span class="number">32767</span>] = &#123;&#125;, test[<span class="number">32767</span>] = &#123;&#125;;</div><div class="line">        <span class="comment">// Case 1</span></div><div class="line">        base64_encode(in, n*m, buf[<span class="number">1</span>], b64n); </div><div class="line">        <span class="comment">// Case 2</span></div><div class="line"><span class="comment">//		huffman_encode(in, n*m, buf[0], hufn);</span></div><div class="line"><span class="comment">//		base64_encode(buf[0], hufn, buf[1], b64n);</span></div><div class="line"><span class="comment">//		base64_decode(buf[1], b64n, buf[2], ehufn);</span></div><div class="line"><span class="comment">//		huffman_decode(buf[2], ehufn, test, tn);</span></div><div class="line">        <span class="comment">// Case 3</span></div><div class="line"><span class="comment">//		lz77_encode(in, n*m, buf[0], lz77n);</span></div><div class="line"><span class="comment">//		base64_encode(buf[0], lz77n, buf[1], b64n);</span></div><div class="line"><span class="comment">//		base64_decode(buf[1], b64n, buf[2], elz77n);</span></div><div class="line"><span class="comment">//		lz77_decode(buf[2], elz77n, test, tn);</span></div><div class="line">        <span class="comment">// Case 4</span></div><div class="line"><span class="comment">//		huffman_encode(in, n*m, buf[0], hufn);</span></div><div class="line"><span class="comment">//		lz77_encode(buf[0], hufn, buf[2], lz77n);</span></div><div class="line"><span class="comment">//		base64_encode(buf[2], lz77n, buf[1], b64n);</span></div><div class="line">        <span class="comment">// Case 5</span></div><div class="line"><span class="comment">//		lz77_encode(in, n*m, buf[0], lz77n);</span></div><div class="line"><span class="comment">//		huffman_encode(buf[0], hufn, buf[2], hufn);</span></div><div class="line"><span class="comment">//		base64_encode(buf[2], lz77n, buf[1], b64n);</span></div><div class="line">        <span class="comment">// Case 6</span></div><div class="line"><span class="comment">//		for (int i = 0; i &lt; n*m; i++) </span></div><div class="line"><span class="comment">//			in2[i] = in[i] - (i ? in[i-1] : 0);</span></div><div class="line"><span class="comment">//		huffman_encode(in2, n*m, buf[0], hufn);</span></div><div class="line"><span class="comment">//		base64_encode(buf[0], hufn, buf[1], b64n);</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; b64n; i++)</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%c"</span>, buf[<span class="number">1</span>][i]);</div><div class="line">        <span class="built_in">puts</span>(<span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="base64"><a href="#base64" class="headerlink" title="base64"></a>base64</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> data[] = <span class="string">"mZeUkpampXpOX2FhYGlxd ... ignore"</span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">base64_decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> R[<span class="number">256</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'A'</span>; i &lt;= <span class="string">'Z'</span>; i++)	R[i] = i - <span class="string">'A'</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'a'</span>; i &lt;= <span class="string">'z'</span>; i++)	R[i] = i - <span class="string">'a'</span> + <span class="number">26</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'0'</span>; i &lt;= <span class="string">'9'</span>; i++)	R[i] = i - <span class="string">'0'</span> + <span class="number">52</span>;</div><div class="line">    R[<span class="string">'+'</span>] = <span class="number">62</span>, R[<span class="string">'/'</span>] = <span class="number">63</span>;</div><div class="line">    m = n/<span class="number">4</span>*<span class="number">3</span>;</div><div class="line">    <span class="keyword">if</span> (in[n<span class="number">-1</span>] == <span class="string">'='</span>)	m--;</div><div class="line">    <span class="keyword">if</span> (in[n<span class="number">-2</span>] == <span class="string">'='</span>)	m--;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; n; ) &#123;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> a, val = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">3</span>; k &gt;= <span class="number">0</span>; i++, k--) &#123;</div><div class="line">            a = in[i] == <span class="string">'='</span> ? <span class="number">0</span> : R[in[i]];</div><div class="line">            val |= a&lt;&lt;(k*<span class="number">6</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">0</span>)&amp;<span class="number">0xff</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> d[<span class="number">32767</span>] = &#123;&#125;;</div><div class="line">    <span class="keyword">int</span> n;</div><div class="line">    base64_decode(data, <span class="keyword">sizeof</span>(data), d, n);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, <span class="number">64</span>, <span class="number">64</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">64</span>; i++) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">64</span>; j++) &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d %d %d%c"</span>, d[i*<span class="number">64</span>+j], d[i*<span class="number">64</span>+j], d[i*<span class="number">64</span>+j], j == <span class="number">63</span> ? <span class="string">'\n'</span> : <span class="string">' '</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="huffman-base64"><a href="#huffman-base64" class="headerlink" title="huffman+base64"></a>huffman+base64</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> data[] = <span class="string">"RHkAAOoAC4kCAguWBwYMFggIDBYA ... ignore"</span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">base64_decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> R[<span class="number">256</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'A'</span>; i &lt;= <span class="string">'Z'</span>; i++)	R[i] = i - <span class="string">'A'</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'a'</span>; i &lt;= <span class="string">'z'</span>; i++)	R[i] = i - <span class="string">'a'</span> + <span class="number">26</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'0'</span>; i &lt;= <span class="string">'9'</span>; i++)	R[i] = i - <span class="string">'0'</span> + <span class="number">52</span>;</div><div class="line">    R[<span class="string">'+'</span>] = <span class="number">62</span>, R[<span class="string">'/'</span>] = <span class="number">63</span>;</div><div class="line">    m = n/<span class="number">4</span>*<span class="number">3</span>;</div><div class="line">    <span class="keyword">if</span> (in[n<span class="number">-1</span>] == <span class="string">'='</span>)	m--;</div><div class="line">    <span class="keyword">if</span> (in[n<span class="number">-2</span>] == <span class="string">'='</span>)	m--;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; n; ) &#123;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> a, val = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">3</span>; k &gt;= <span class="number">0</span>; i++, k--) &#123;</div><div class="line">            a = in[i] == <span class="string">'='</span> ? <span class="number">0</span> : R[in[i]];</div><div class="line">            val |= a&lt;&lt;(k*<span class="number">6</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">0</span>)&amp;<span class="number">0xff</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">huffman_decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line">    m = <span class="number">0</span>;</div><div class="line">    <span class="built_in">map</span>&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; R[<span class="number">64</span>];</div><div class="line">    <span class="keyword">int</span> bits_cnt = <span class="number">0</span>, leaf = <span class="number">0</span>;</div><div class="line">    <span class="built_in">memcpy</span>(&amp;bits_cnt, in, <span class="number">4</span>), in += <span class="number">4</span>, n -= <span class="number">4</span>;</div><div class="line">    <span class="built_in">memcpy</span>(&amp;leaf, in, <span class="number">1</span>), in += <span class="number">1</span>, n -= <span class="number">1</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; leaf; i++) &#123;</div><div class="line">        <span class="keyword">int</span> tid = <span class="number">0</span>, bn = <span class="number">0</span>, bit = <span class="number">0</span>;</div><div class="line">        <span class="built_in">memcpy</span>(&amp;tid, in, <span class="number">1</span>), in += <span class="number">1</span>, n -= <span class="number">1</span>;</div><div class="line">        <span class="built_in">memcpy</span>(&amp;bn, in, <span class="number">1</span>), in += <span class="number">1</span>, n -= <span class="number">1</span>;</div><div class="line">        <span class="built_in">memcpy</span>(&amp;bit, in, (bn+<span class="number">7</span>)/<span class="number">8</span>), in += (bn+<span class="number">7</span>)/<span class="number">8</span>, n -= (bn+<span class="number">7</span>)/<span class="number">8</span>;</div><div class="line">        R[bn][bit] = tid;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> mask = <span class="number">0</span>, cnt = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bits_cnt; i++) &#123;</div><div class="line">        mask |= ((in[(i&gt;&gt;<span class="number">3</span>)]&gt;&gt;(i&amp;<span class="number">7</span>))&amp;<span class="number">1</span>)&lt;&lt;cnt;</div><div class="line">        cnt++;</div><div class="line">        <span class="keyword">if</span> (R[cnt].count(mask)) &#123;</div><div class="line">            out[m++] = R[cnt][mask];</div><div class="line">            cnt = <span class="number">0</span>, mask = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> d[<span class="number">2</span>][<span class="number">32767</span>] = &#123;&#125;;</div><div class="line">    <span class="keyword">int</span> n, m;</div><div class="line">    base64_decode(data, <span class="keyword">sizeof</span>(data), d[<span class="number">0</span>], n);</div><div class="line">    huffman_decode(d[<span class="number">0</span>], n, d[<span class="number">1</span>], m);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, <span class="number">64</span>, <span class="number">64</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">64</span>; i++) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">64</span>; j++) &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d %d %d%c"</span>, d[<span class="number">1</span>][i*<span class="number">64</span>+j], d[<span class="number">1</span>][i*<span class="number">64</span>+j], d[<span class="number">1</span>][i*<span class="number">64</span>+j], j == <span class="number">63</span> ? <span class="string">'\n'</span> : <span class="string">' '</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="diff-huffman-base64"><a href="#diff-huffman-base64" class="headerlink" title="diff+huffman+base64"></a>diff+huffman+base64</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> data[] = <span class="string">"nG0AAPkABQIBBRICBRoDBRMEBQ0FB ... ignore"</span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">base64_decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> R[<span class="number">256</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'A'</span>; i &lt;= <span class="string">'Z'</span>; i++)	R[i] = i - <span class="string">'A'</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'a'</span>; i &lt;= <span class="string">'z'</span>; i++)	R[i] = i - <span class="string">'a'</span> + <span class="number">26</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="string">'0'</span>; i &lt;= <span class="string">'9'</span>; i++)	R[i] = i - <span class="string">'0'</span> + <span class="number">52</span>;</div><div class="line">    R[<span class="string">'+'</span>] = <span class="number">62</span>, R[<span class="string">'/'</span>] = <span class="number">63</span>;</div><div class="line">    m = n/<span class="number">4</span>*<span class="number">3</span>;</div><div class="line">    <span class="keyword">if</span> (in[n<span class="number">-1</span>] == <span class="string">'='</span>)	m--;</div><div class="line">    <span class="keyword">if</span> (in[n<span class="number">-2</span>] == <span class="string">'='</span>)	m--;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; n; ) &#123;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> a, val = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">3</span>; k &gt;= <span class="number">0</span>; i++, k--) &#123;</div><div class="line">            a = in[i] == <span class="string">'='</span> ? <span class="number">0</span> : R[in[i]];</div><div class="line">            val |= a&lt;&lt;(k*<span class="number">6</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>;</div><div class="line">        <span class="keyword">if</span> (j &lt; m)	out[j++] = (val&gt;&gt;<span class="number">0</span>)&amp;<span class="number">0xff</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">huffman_decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">int</span> &amp;m)</span>  </span>&#123;</div><div class="line">    m = <span class="number">0</span>;</div><div class="line">    <span class="built_in">map</span>&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; R[<span class="number">64</span>];</div><div class="line">    <span class="keyword">int</span> bits_cnt = <span class="number">0</span>, leaf = <span class="number">0</span>;</div><div class="line">    <span class="built_in">memcpy</span>(&amp;bits_cnt, in, <span class="number">4</span>), in += <span class="number">4</span>, n -= <span class="number">4</span>;</div><div class="line">    <span class="built_in">memcpy</span>(&amp;leaf, in, <span class="number">1</span>), in += <span class="number">1</span>, n -= <span class="number">1</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; leaf; i++) &#123;</div><div class="line">        <span class="keyword">int</span> tid = <span class="number">0</span>, bn = <span class="number">0</span>, bit = <span class="number">0</span>;</div><div class="line">        <span class="built_in">memcpy</span>(&amp;tid, in, <span class="number">1</span>), in += <span class="number">1</span>, n -= <span class="number">1</span>;</div><div class="line">        <span class="built_in">memcpy</span>(&amp;bn, in, <span class="number">1</span>), in += <span class="number">1</span>, n -= <span class="number">1</span>;</div><div class="line">        <span class="built_in">memcpy</span>(&amp;bit, in, (bn+<span class="number">7</span>)/<span class="number">8</span>), in += (bn+<span class="number">7</span>)/<span class="number">8</span>, n -= (bn+<span class="number">7</span>)/<span class="number">8</span>;</div><div class="line">        R[bn][bit] = tid;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> mask = <span class="number">0</span>, cnt = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bits_cnt; i++) &#123;</div><div class="line">        mask |= ((in[(i&gt;&gt;<span class="number">3</span>)]&gt;&gt;(i&amp;<span class="number">7</span>))&amp;<span class="number">1</span>)&lt;&lt;cnt;</div><div class="line">        cnt++;</div><div class="line">        <span class="keyword">if</span> (R[cnt].count(mask)) &#123;</div><div class="line">            out[m++] = R[cnt][mask];</div><div class="line">            cnt = <span class="number">0</span>, mask = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> d[<span class="number">2</span>][<span class="number">32767</span>] = &#123;&#125;;</div><div class="line">    <span class="keyword">int</span> n, m;</div><div class="line">    base64_decode(data, <span class="keyword">sizeof</span>(data), d[<span class="number">0</span>], n);</div><div class="line">    huffman_decode(d[<span class="number">0</span>], n, d[<span class="number">1</span>], m);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; m; i++)</div><div class="line">        d[<span class="number">1</span>][i] = d[<span class="number">1</span>][i] + d[<span class="number">1</span>][i<span class="number">-1</span>];</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, <span class="number">64</span>, <span class="number">64</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">64</span>; i++) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">64</span>; j++) &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d %d %d%c"</span>, d[<span class="number">1</span>][i*<span class="number">64</span>+j], d[<span class="number">1</span>][i*<span class="number">64</span>+j], d[<span class="number">1</span>][i*<span class="number">64</span>+j], j == <span class="number">63</span> ? <span class="string">'\n'</span> : <span class="string">' '</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b451" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/21/zj-b451/" class="article-date">
  <time datetime="2015-07-21T00:24:52.000Z" itemprop="datePublished">2015-07-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/21/zj-b451/">b451. 圖片匹配</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/21/zj-b451/" data-id="ckq8np00c014n1wvntlx4pyql" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/21/zj-b451/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CRT/">CRT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FFT/">FFT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FNT/">FNT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NTT/">NTT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/中國餘式定理/">中國餘式定理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/影像處理/">影像處理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/快速傅立葉/">快速傅立葉</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/快速數論變換/">快速數論變換</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>圖片匹配和字串匹配有一點不同，字串匹配通常要求其子字串與搜尋字串完全相符，而圖片匹配則用相似度為依據，當圖片大、複雜且具有干擾，或者需要匹配數量非常多，更先進的領域會利用特徵擷取，用機率統計的方式來篩選可能的匹配數量，篩選過後才進行圖片的細節匹配。</p>
<h3 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h3><p>給予兩個圖片 <span>$A, B$</span><!-- Has MathJax -->，圖片格式為灰階影像，每個像素 <span>$\mathit{pixel}(x, y)$</span><!-- Has MathJax --> 採用 8-bits 表示，範圍為 <span>$\mathit{pixel}(x, y) \in [0, 255]$</span><!-- Has MathJax -->。</p>
<p>舉一個例子，有一個 <span>$3 \times 3$</span><!-- Has MathJax --> 的圖片 <span>$A$</span><!-- Has MathJax --> 和一個 <span>$2 \times 2$</span><!-- Has MathJax --> 的圖片 <span>$B$</span><!-- Has MathJax -->，用矩陣表示如下：</p>
<span>$$A := \begin{bmatrix}
a1 &amp; a2 &amp; a3 \\
a4 &amp; a5 &amp; a6 \\
a7 &amp; a8 &amp; a9
\end{bmatrix} ,\; B := \begin{bmatrix}
b1 &amp; b2\\
b3 &amp; b4\\
\end{bmatrix}$$</span><!-- Has MathJax -->
<p>假設左上角座標 <span>$(1, 1)$</span><!-- Has MathJax --> 即 <span>$a1$</span><!-- Has MathJax --> 的位置、<span>$(1, 2)$</span><!-- Has MathJax --> 即 <span>$a2$</span><!-- Has MathJax --> 的位置。</p>
<ul>
<li>把影像 <span>$B$</span><!-- Has MathJax --> 左上角對齊 <span>$A$</span><!-- Has MathJax --> 的 <span>$(1, 1)$</span><!-- Has MathJax --> 位置，其差異程度 <span>$\mathit{diff}(A, B) = (a1 - b1)^2 + (a2 - b2)^2 + (a4 - b3)^2 + (a5 - b4)^2$</span><!-- Has MathJax --></li>
<li>相同地，對齊 <span>$(2, 1)$</span><!-- Has MathJax --> 位置，其差異程度 <span>$\mathit{diff}(A, B) = (a4 - b1)^2 + (a5 - b2)^2 + (a7 - b3)^2 + (a8 - b4)^2$</span><!-- Has MathJax --></li>
</ul>
<p>比較時，整張 <span>$B$</span><!-- Has MathJax --> 都要落在 <span>$A$</span><!-- Has MathJax --> 中。現在要找到一個對齊位置 <span>$(x, y)$</span><!-- Has MathJax -->，使得 <span>$\mathit{diff}(A, B)$</span><!-- Has MathJax --> 最小。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">4 4 2 2</div><div class="line">0 3 3 0</div><div class="line">0 3 3 0</div><div class="line">0 0 5 5</div><div class="line">0 0 5 5</div><div class="line">5 5</div><div class="line">5 5</div><div class="line">3 5 1 2</div><div class="line">2 3 0 4 5</div><div class="line">0 0 7 0 0</div><div class="line">0 0 7 0 0</div><div class="line">3 4</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">3 3</div><div class="line">1 1</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><ul>
<li><a href="http://blog.miskcoo.com/2015/04/polynomial-multiplication-and-fast-fourier-transform" target="_blank" rel="external">《从多项式乘法到快速傅里叶变换》- Miskcoo</a></li>
<li><a href="http://www.kuangbin.net/archives/hdu4656" target="_blank" rel="external">《快速数论变换 NTT》- Kuangbin</a></li>
<li><a href="http://blog.csdn.net/acdreamers/article/details/39026505" target="_blank" rel="external">《多项式乘法运算终极版》- ACdreamer</a></li>
</ul>
<p>相同樸素 FFT 題目 <a href="http://acm.zju.edu.cn/onlinejudge/showProblem.do?problemCode=1637" target="_blank" rel="external">ZOJ 1637 - Fast Image Match</a></p>
<h3 id="小記"><a href="#小記" class="headerlink" title="小記"></a>小記</h3><p>雖然不是很明白 FFT，參考上面的資料，了解 FFT 的旋積 (convolution) 可以在 <span>$O(n \log n)$</span><!-- Has MathJax --> 完成就好，接著套模板。</p>
<p>從差異公式中得到<span>$\mathit{diff}(A, B) = \sum (a_i - b_i)^2 = \sum a_{i}^{2} - \sum 2 a_i b_i + \sum b_{i}^{2}$</span><!-- Has MathJax --><span>$\sum a_{i}^{2}$</span><!-- Has MathJax --> 和<span>$\sum b_{i}^{2}$</span><!-- Has MathJax --> 都是獨立的，麻煩的是在於<span>$\sum 2 a_i b_i$</span><!-- Has MathJax --> 向量內積，若樸素去計算會在 <span>$O(H^4)$</span><!-- Has MathJax --> 完成，套用 FFT 旋積計算，得到 <span>$O(H^2 \log H)$</span><!-- Has MathJax -->。FFT 有一個缺點，在浮點數的複數域下運行，計算時會失去精準度，要四捨五入到整數。儘管如此，由於不用像 NTT 那樣有很多模運算，速度是最快的。</p>
<p>數論變換 (NTT) / 快速數論變換 (FNT)，採用費馬數數論變換，取代複數根的疊加，利用原根的性質來完成。NTT/FNT 處理整數域內積時不存在誤差，所有計算皆在整數，但是要取模變得非常慢。</p>
<p>為了加速計算，丟 CRT 下去降一半的 bits，乘法速度只能提升兩倍，但要做兩次計算，速度稍微快一點點而已。在實作時，特別要注意到，CRT 運作時，挑選兩個質數 <span>$P1, \; P2$</span><!-- Has MathJax --> 分別計算 FNT，最後 CRT 逆推回去。</p>
<p>其他實作細節</p>
<ol>
<li>Fast Reverse Bit 使用位元運算取代建表、迴圈方案。除非多測資。</li>
<li><code>std::complex&lt;double&gt;</code> 帶 <code>struct complex</code> 取代，加速 method interface 拷貝。</li>
<li><code>sin() cos()</code> 不考慮建表，採用乘法和加法疊加，這會損失一點點精度。若固定測資考慮內存池去搞。</li>
</ol>
<p>在 O1 下編輯跟 O3 一樣快，由於第二點的貢獻，速度直接從快兩倍。0.3s -&gt; 90ms。</p>
<h3 id="FFT"><a href="#FFT" class="headerlink" title="FFT"></a>FFT</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="class"><span class="keyword">class</span> <span class="title">TOOL_FFT</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> UINT32;	</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">NumberOfBitsNeeded</span><span class="params">(<span class="keyword">int</span> PowerOfTwo)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;; ++i) &#123;</div><div class="line">            <span class="keyword">if</span> (PowerOfTwo &amp; (<span class="number">1</span> &lt;&lt; i)) &#123;</div><div class="line">                <span class="keyword">return</span> i;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> UINT32 <span class="title">FastReverseBits</span><span class="params">(UINT32 a, <span class="keyword">int</span> NumBits)</span> </span>&#123;</div><div class="line">        a = ( ( a &amp; <span class="number">0x55555555</span>U ) &lt;&lt; <span class="number">1</span> ) | ( ( a &amp; <span class="number">0xAAAAAAAA</span>U ) &gt;&gt; <span class="number">1</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x33333333</span>U ) &lt;&lt; <span class="number">2</span> ) | ( ( a &amp; <span class="number">0xCCCCCCCC</span>U ) &gt;&gt; <span class="number">2</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x0F0F0F0F</span>U ) &lt;&lt; <span class="number">4</span> ) | ( ( a &amp; <span class="number">0xF0F0F0F0</span>U ) &gt;&gt; <span class="number">4</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x00FF00FF</span>U ) &lt;&lt; <span class="number">8</span> ) | ( ( a &amp; <span class="number">0xFF00FF00</span>U ) &gt;&gt; <span class="number">8</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x0000FFFF</span>U ) &lt;&lt; <span class="number">16</span> ) | ( ( a &amp; <span class="number">0xFFFF0000</span>U ) &gt;&gt; <span class="number">16</span> ) ;</div><div class="line">        <span class="keyword">return</span> a &gt;&gt; (<span class="number">32</span> - NumBits);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">FFT</span><span class="params">(<span class="keyword">bool</span> InverseTransform, <span class="built_in">vector</span>&lt;<span class="keyword">complex</span>&lt;T&gt; &gt;&amp; In, <span class="built_in">vector</span>&lt;<span class="keyword">complex</span>&lt;T&gt; &gt;&amp; Out)</span> </span>&#123;</div><div class="line">        <span class="comment">// simultaneous data copy and bit-reversal ordering into outputs</span></div><div class="line">        <span class="keyword">int</span> NumSamples = In.size();</div><div class="line">        <span class="keyword">int</span> NumBits = NumberOfBitsNeeded(NumSamples);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NumSamples; ++i) &#123;</div><div class="line">            Out[FastReverseBits(i, NumBits)] = In[i];</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// the FFT process</span></div><div class="line">        T angle_numerator = <span class="built_in">acos</span>(<span class="number">-1.</span>) * (InverseTransform ? <span class="number">-2</span> : <span class="number">2</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> BlockEnd = <span class="number">1</span>, BlockSize = <span class="number">2</span>; BlockSize &lt;= NumSamples; BlockSize &lt;&lt;= <span class="number">1</span>) &#123;</div><div class="line">            T delta_angle = angle_numerator / BlockSize;</div><div class="line">            T sin1 = <span class="built_in">sin</span>(-delta_angle);</div><div class="line">            T cos1 = <span class="built_in">cos</span>(-delta_angle);</div><div class="line">            T sin2 = <span class="built_in">sin</span>(-delta_angle * <span class="number">2</span>);</div><div class="line">            T cos2 = <span class="built_in">cos</span>(-delta_angle * <span class="number">2</span>);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NumSamples; i += BlockSize) &#123;</div><div class="line">                <span class="keyword">complex</span>&lt;T&gt; a1(cos1, sin1), a2(cos2, sin2), a0;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = i, n = <span class="number">0</span>; n &lt; BlockEnd; ++j, ++n) &#123;</div><div class="line">                    a0 = <span class="keyword">complex</span>&lt;T&gt;(<span class="number">2</span> * cos1 * a1.real() - a2.real(), <span class="number">2</span> * cos1 * a1.imag() - a2.imag());</div><div class="line">                    a2 = a1;</div><div class="line">                    a1 = a0;</div><div class="line">                    <span class="keyword">complex</span>&lt;T&gt; a = a0 * Out[j + BlockEnd];</div><div class="line">                    Out[j + BlockEnd] = Out[j] - a;</div><div class="line">                    Out[j] += a;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            BlockEnd = BlockSize;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// normalize if inverse transform</span></div><div class="line">        <span class="keyword">if</span> (InverseTransform) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NumSamples; ++i) &#123;</div><div class="line">                Out[i] /= NumSamples;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="built_in">vector</span>&lt;T&gt; convolution(T *a, T *b, <span class="keyword">int</span> n) &#123;</div><div class="line">        <span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="keyword">complex</span>&lt;T&gt;&gt; s(n), d1(n), d2(n), y(n);</div><div class="line">        <span class="built_in">vector</span>&lt;T&gt; ret(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</div><div class="line">            s[i] = <span class="keyword">complex</span>&lt;T&gt;(a[i], <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">        FFT(<span class="literal">false</span>, s, d1);</div><div class="line">        s[<span class="number">0</span>] = <span class="keyword">complex</span>&lt;T&gt;(b[<span class="number">0</span>], <span class="number">0</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++i) &#123;</div><div class="line">            s[i] = <span class="keyword">complex</span>&lt;T&gt;(b[n - i], <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">        FFT(<span class="literal">false</span>, s, d2);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</div><div class="line">            y[i] = d1[i] * d2[i];</div><div class="line">        &#125;</div><div class="line">        FFT(<span class="literal">true</span>, y, s);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</div><div class="line">            ret[i] = s[i].real();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">TOOL_FFT&lt;<span class="keyword">double</span>&gt; tool;</div><div class="line"></div><div class="line"><span class="keyword">double</span> a[<span class="number">262144</span>], b[<span class="number">262144</span>];</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> sum[<span class="number">512</span>][<span class="number">512</span>];</div><div class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">getArea</span><span class="params">(<span class="keyword">int</span> lx, <span class="keyword">int</span> ly, <span class="keyword">int</span> rx, <span class="keyword">int</span> ry)</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> ret = sum[rx][ry];</div><div class="line">    <span class="keyword">if</span>(lx<span class="number">-1</span> &gt;= <span class="number">0</span>)</div><div class="line">        ret -= sum[lx<span class="number">-1</span>][ry];</div><div class="line">    <span class="keyword">if</span>(ly<span class="number">-1</span> &gt;= <span class="number">0</span>)</div><div class="line">        ret -= sum[rx][ly<span class="number">-1</span>];</div><div class="line">    <span class="keyword">if</span>(lx<span class="number">-1</span> &gt;= <span class="number">0</span> &amp;&amp; ly<span class="number">-1</span> &gt;= <span class="number">0</span>)	</div><div class="line">        ret += sum[lx<span class="number">-1</span>][ly<span class="number">-1</span>];</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">readchar</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> buf[N];</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> *p = buf, *end = buf;</div><div class="line">    <span class="keyword">if</span>(p == end) &#123;</div><div class="line">        <span class="keyword">if</span>((end = buf + fread(buf, <span class="number">1</span>, N, <span class="built_in">stdin</span>)) == buf) <span class="keyword">return</span> EOF;</div><div class="line">        p = buf;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> *p++;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">ReadInt</span><span class="params">(<span class="keyword">int</span> *x)</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> c, neg;</div><div class="line">    <span class="keyword">while</span>((c = readchar()) &lt; <span class="string">'-'</span>)    &#123;<span class="keyword">if</span>(c == EOF) <span class="keyword">return</span> <span class="number">0</span>;&#125;</div><div class="line">    neg = (c == <span class="string">'-'</span>) ? <span class="number">-1</span> : <span class="number">1</span>;</div><div class="line">    *x = (neg == <span class="number">1</span>) ? c-<span class="string">'0'</span> : <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span>((c = readchar()) &gt;= <span class="string">'0'</span>)</div><div class="line">        *x = (*x &lt;&lt; <span class="number">3</span>) + (*x &lt;&lt; <span class="number">1</span>) + c-<span class="string">'0'</span>;</div><div class="line">    *x *= neg;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> m, n, p, q, x, N, M, S;</div><div class="line">    <span class="keyword">while</span> (ReadInt(&amp;m)) &#123;</div><div class="line">    	ReadInt(&amp;n), ReadInt(&amp;p), ReadInt(&amp;q);</div><div class="line">        N = max(m, p), M = max(n, q);</div><div class="line">        S = <span class="number">1</span>;</div><div class="line">        <span class="keyword">for</span> (; S &lt; N*M; S &lt;&lt;= <span class="number">1</span>);</div><div class="line">        <span class="built_in">memset</span>(a, <span class="number">0</span>, <span class="keyword">sizeof</span>(a[<span class="number">0</span>]) * S);</div><div class="line">        <span class="built_in">memset</span>(b, <span class="number">0</span>, <span class="keyword">sizeof</span>(b[<span class="number">0</span>]) * S);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</div><div class="line">            	ReadInt(&amp;x);</div><div class="line">            	a[i*M+j] = x;                </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; p; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; q; j++) &#123;</div><div class="line">            	ReadInt(&amp;x);</div><div class="line">            	b[i*M+j] = x;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">        	<span class="keyword">long</span> <span class="keyword">long</span> s = <span class="number">0</span>;</div><div class="line">        	<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</div><div class="line">        		x = a[i*M+j];</div><div class="line">        		s += x*x;</div><div class="line">        		sum[i][j] = (i &gt; <span class="number">0</span> ? sum[i<span class="number">-1</span>][j] : <span class="number">0</span>) + s;</div><div class="line">        	&#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt; r = tool.convolution(a, b, S);</div><div class="line">        <span class="keyword">int</span> qx = m - p, qy = n - q, bX = <span class="number">0</span>, bY = <span class="number">0</span>;</div><div class="line">        <span class="keyword">long</span> <span class="keyword">long</span> diff = LONG_MAX;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= qx; i++)    &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= qy; j++) &#123;</div><div class="line">                <span class="keyword">long</span> <span class="keyword">long</span> v = round(getArea(i, j, i+p<span class="number">-1</span>, j+q<span class="number">-1</span>) - <span class="number">2</span>*r[i*M + j]);</div><div class="line">                <span class="keyword">if</span> (v &lt; diff) &#123;</div><div class="line">                    diff = v, bX = i, bY = j;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, bX+<span class="number">1</span>, bY+<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="FFT-編譯優化"><a href="#FFT-編譯優化" class="headerlink" title="FFT 編譯優化"></a>FFT 編譯優化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="class"><span class="keyword">class</span> <span class="title">TOOL_FFT</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">complex</span> &#123;</span></div><div class="line">        T x, y;</div><div class="line">        <span class="keyword">complex</span>(T x = <span class="number">0</span>, T y = <span class="number">0</span>):</div><div class="line">            x(x), y(y) &#123;&#125;</div><div class="line">        <span class="keyword">complex</span> <span class="keyword">operator</span>+(<span class="keyword">const</span> <span class="keyword">complex</span> &amp;A) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">complex</span>(x+A.x,y+A.y);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">complex</span> <span class="keyword">operator</span>-(<span class="keyword">const</span> <span class="keyword">complex</span> &amp;A) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">complex</span>(x-A.x,y-A.y);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">complex</span> <span class="keyword">operator</span>*(<span class="keyword">const</span> <span class="keyword">complex</span> &amp;A) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">complex</span>(x*A.x-y*A.y,x*A.y+y*A.x);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> UINT32;	</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">NumberOfBitsNeeded</span><span class="params">(<span class="keyword">int</span> PowerOfTwo)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;; ++i) &#123;</div><div class="line">            <span class="keyword">if</span> (PowerOfTwo &amp; (<span class="number">1</span> &lt;&lt; i)) &#123;</div><div class="line">                <span class="keyword">return</span> i;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> UINT32 <span class="title">FastReverseBits</span><span class="params">(UINT32 a, <span class="keyword">int</span> NumBits)</span> </span>&#123;</div><div class="line">        a = ( ( a &amp; <span class="number">0x55555555</span>U ) &lt;&lt; <span class="number">1</span> ) | ( ( a &amp; <span class="number">0xAAAAAAAA</span>U ) &gt;&gt; <span class="number">1</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x33333333</span>U ) &lt;&lt; <span class="number">2</span> ) | ( ( a &amp; <span class="number">0xCCCCCCCC</span>U ) &gt;&gt; <span class="number">2</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x0F0F0F0F</span>U ) &lt;&lt; <span class="number">4</span> ) | ( ( a &amp; <span class="number">0xF0F0F0F0</span>U ) &gt;&gt; <span class="number">4</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x00FF00FF</span>U ) &lt;&lt; <span class="number">8</span> ) | ( ( a &amp; <span class="number">0xFF00FF00</span>U ) &gt;&gt; <span class="number">8</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x0000FFFF</span>U ) &lt;&lt; <span class="number">16</span> ) | ( ( a &amp; <span class="number">0xFFFF0000</span>U ) &gt;&gt; <span class="number">16</span> ) ;</div><div class="line">        <span class="keyword">return</span> a &gt;&gt; (<span class="number">32</span> - NumBits);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">FFT</span><span class="params">(<span class="keyword">bool</span> InverseTransform, <span class="built_in">vector</span>&lt;<span class="keyword">complex</span>&gt;&amp; In, <span class="built_in">vector</span>&lt;<span class="keyword">complex</span>&gt;&amp; Out)</span> </span>&#123;</div><div class="line">        <span class="comment">// simultaneous data copy and bit-reversal ordering into outputs</span></div><div class="line">        <span class="keyword">int</span> NumSamples = In.size();</div><div class="line">        <span class="keyword">int</span> NumBits = NumberOfBitsNeeded(NumSamples);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NumSamples; ++i) &#123;</div><div class="line">            Out[FastReverseBits(i, NumBits)] = In[i];</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// the FFT process</span></div><div class="line">        T angle_numerator = <span class="built_in">acos</span>(<span class="number">-1.</span>) * (InverseTransform ? <span class="number">-2</span> : <span class="number">2</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> BlockEnd = <span class="number">1</span>, BlockSize = <span class="number">2</span>; BlockSize &lt;= NumSamples; BlockSize &lt;&lt;= <span class="number">1</span>) &#123;</div><div class="line">            T delta_angle = angle_numerator / BlockSize;</div><div class="line">            T sin1 = <span class="built_in">sin</span>(-delta_angle);</div><div class="line">            T cos1 = <span class="built_in">cos</span>(-delta_angle);</div><div class="line">            T sin2 = <span class="built_in">sin</span>(-delta_angle * <span class="number">2</span>);</div><div class="line">            T cos2 = <span class="built_in">cos</span>(-delta_angle * <span class="number">2</span>);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NumSamples; i += BlockSize) &#123;</div><div class="line">                complex a1(cos1, sin1), a2(cos2, sin2), a0, a;</div><div class="line">                <span class="keyword">int</span> j, n;</div><div class="line">                <span class="keyword">for</span> (j = i, n = <span class="number">0</span>; n+<span class="number">8</span> &lt; BlockEnd; ) &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOP &#123;\</span></div><div class="line">    a0 = <span class="keyword">complex</span>(<span class="number">2</span> * cos1 * a1.x - a2.x, <span class="number">2</span> * cos1 * a1.y - a2.y); \</div><div class="line">    a2 = a1, a1 = a0; \</div><div class="line">    a = a0 * Out[j + BlockEnd]; \</div><div class="line">    Out[j + BlockEnd] = Out[j] - a; \</div><div class="line">    Out[j] = Out[j] + a; \</div><div class="line">    ++j, ++n; &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOP8	&#123;UNLOOP UNLOOP UNLOOP UNLOOP UNLOOP UNLOOP UNLOOP UNLOOP&#125;</span></div><div class="line">                    UNLOOP8;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">for</span> (; n &lt; BlockEnd; )</div><div class="line">                	UNLOOP;</div><div class="line">            &#125;</div><div class="line">            BlockEnd = BlockSize;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// normalize if inverse transform</span></div><div class="line">        <span class="keyword">if</span> (InverseTransform) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NumSamples; ++i) &#123;</div><div class="line">                Out[i] = Out[i].x / NumSamples;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">convolution</span><span class="params">(T *a, T *b, <span class="keyword">int</span> n, T *c)</span> </span>&#123;</div><div class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">complex</span>&gt; s(n), d1(n), d2(n), y(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</div><div class="line">            s[i] = <span class="keyword">complex</span>(a[i], <span class="number">0</span>);</div><div class="line">        FFT(<span class="literal">false</span>, s, d1);</div><div class="line">        s[<span class="number">0</span>] = <span class="keyword">complex</span>(b[<span class="number">0</span>], <span class="number">0</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++i)</div><div class="line">            s[i] = <span class="keyword">complex</span>(b[n - i], <span class="number">0</span>);</div><div class="line">        FFT(<span class="literal">false</span>, s, d2);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</div><div class="line">            y[i] = d1[i] * d2[i];</div><div class="line">        FFT(<span class="literal">true</span>, y, s);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</div><div class="line">            c[i] = s[i].x;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">TOOL_FFT&lt;<span class="keyword">double</span>&gt; tool;</div><div class="line"></div><div class="line"><span class="keyword">double</span> a[<span class="number">262144</span>], b[<span class="number">262144</span>], c[<span class="number">262144</span>];</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> sum[<span class="number">512</span>][<span class="number">512</span>];</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="title">getArea</span><span class="params">(<span class="keyword">int</span> lx, <span class="keyword">int</span> ly, <span class="keyword">int</span> rx, <span class="keyword">int</span> ry)</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> ret = sum[rx][ry];</div><div class="line">    <span class="keyword">if</span>(lx)	ret -= sum[lx<span class="number">-1</span>][ry];</div><div class="line">    <span class="keyword">if</span>(ly)	ret -= sum[rx][ly<span class="number">-1</span>];</div><div class="line">    <span class="keyword">if</span>(lx &amp;&amp; ly)	ret += sum[lx<span class="number">-1</span>][ly<span class="number">-1</span>];</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">readchar</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> buf[N];</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> *p = buf, *end = buf;</div><div class="line">    <span class="keyword">if</span>(p == end) &#123;</div><div class="line">        <span class="keyword">if</span>((end = buf + fread(buf, <span class="number">1</span>, N, <span class="built_in">stdin</span>)) == buf) <span class="keyword">return</span> EOF;</div><div class="line">        p = buf;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> *p++;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">ReadInt</span><span class="params">(<span class="keyword">int</span> *x)</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> c, neg;</div><div class="line">    <span class="keyword">while</span>((c = readchar()) &lt; <span class="string">'-'</span>)    &#123;<span class="keyword">if</span>(c == EOF) <span class="keyword">return</span> <span class="number">0</span>;&#125;</div><div class="line">    neg = (c == <span class="string">'-'</span>) ? <span class="number">-1</span> : <span class="number">1</span>;</div><div class="line">    *x = (neg == <span class="number">1</span>) ? c-<span class="string">'0'</span> : <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span>((c = readchar()) &gt;= <span class="string">'0'</span>)</div><div class="line">        *x = (*x &lt;&lt; <span class="number">3</span>) + (*x &lt;&lt; <span class="number">1</span>) + c-<span class="string">'0'</span>;</div><div class="line">    *x *= neg;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> m, n, p, q, x, N, M, S;</div><div class="line">    <span class="keyword">while</span> (ReadInt(&amp;m)) &#123;</div><div class="line">    	ReadInt(&amp;n), ReadInt(&amp;p), ReadInt(&amp;q);</div><div class="line">        N = max(m, p), M = max(n, q);</div><div class="line">        S = <span class="number">1</span>;</div><div class="line">        <span class="keyword">for</span> (; S &lt; N*M; S &lt;&lt;= <span class="number">1</span>);</div><div class="line">        <span class="built_in">memset</span>(a, <span class="number">0</span>, <span class="keyword">sizeof</span>(a[<span class="number">0</span>]) * S);</div><div class="line">        <span class="built_in">memset</span>(b, <span class="number">0</span>, <span class="keyword">sizeof</span>(b[<span class="number">0</span>]) * S);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">        	<span class="keyword">long</span> <span class="keyword">long</span> s = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</div><div class="line">            	ReadInt(&amp;x);</div><div class="line">            	a[i*M+j] = x;</div><div class="line">        		s += x*x;</div><div class="line">        		sum[i][j] = (i &gt; <span class="number">0</span> ? sum[i<span class="number">-1</span>][j] : <span class="number">0</span>) + s;          </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; p; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; q; j++) &#123;</div><div class="line">            	ReadInt(&amp;x);</div><div class="line">            	b[i*M+j] = x;</div><div class="line">            &#125;</div><div class="line">        &#125;        </div><div class="line">        tool.convolution(a, b, S, c);</div><div class="line">        <span class="keyword">int</span> qx = m - p, qy = n - q, bX = <span class="number">0</span>, bY = <span class="number">0</span>;</div><div class="line">        <span class="keyword">long</span> <span class="keyword">long</span> diff = LONG_MAX;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= qx; i++)    &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= qy; j++) &#123;</div><div class="line">                <span class="keyword">long</span> <span class="keyword">long</span> v = getArea(i, j, i+p<span class="number">-1</span>, j+q<span class="number">-1</span>) - <span class="number">2</span>*c[i*M + j] + <span class="number">0.5</span>;</div><div class="line">                <span class="keyword">if</span> (v &lt; diff)</div><div class="line">                    diff = v, bX = i, bY = j;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%lld\n"</span>, diff);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, bX+<span class="number">1</span>, bY+<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="NTT-FNT"><a href="#NTT-FNT" class="headerlink" title="NTT/FNT"></a>NTT/FNT</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> UINT32;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> INT64;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TOOL_NTT</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 262144</span></div><div class="line">    <span class="keyword">const</span> INT64 P = <span class="number">50000000001507329L</span>L; <span class="comment">// prime m = kn+1</span></div><div class="line">    <span class="keyword">const</span> INT64 G = <span class="number">3</span>;</div><div class="line">    INT64 wn[<span class="number">20</span>];</div><div class="line">    INT64 s[MAXN], d1[MAXN], d2[MAXN], y[MAXN];</div><div class="line">    TOOL_NTT() &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++)</div><div class="line">            wn[i] = mod_pow(G, (P<span class="number">-1</span>) / (<span class="number">1</span>&lt;&lt;i), P);</div><div class="line">    &#125;</div><div class="line">    <span class="function">INT64 <span class="title">mod_mul</span><span class="params">(INT64 a, INT64 b, INT64 mod)</span> </span>&#123; </div><div class="line">        <span class="keyword">long</span> <span class="keyword">long</span> y = (<span class="keyword">long</span> <span class="keyword">long</span>)((<span class="keyword">double</span>)a*b/mod+<span class="number">0.5</span>); <span class="comment">// fast for P &lt; 2^58</span></div><div class="line">    	<span class="keyword">long</span> <span class="keyword">long</span> r = (a*b-y*mod)%mod;</div><div class="line">    	<span class="keyword">return</span> r &lt; <span class="number">0</span> ? r + mod : r;</div><div class="line"><span class="comment">//	  	INT64 ret = 0; </span></div><div class="line"><span class="comment">//		for (a = a &gt;= mod ? a%mod : a, b = b &gt;= mod ? b%mod : b; b != 0; b&gt;&gt;=1, a &lt;&lt;= 1, a = a &gt;= mod ? a - mod : a) &#123; </span></div><div class="line"><span class="comment">//			if (b&amp;1) &#123;</span></div><div class="line"><span class="comment">//				ret += a;</span></div><div class="line"><span class="comment">//				if (ret &gt;= mod) </span></div><div class="line"><span class="comment">//					ret -= mod;</span></div><div class="line"><span class="comment">//			&#125; </span></div><div class="line"><span class="comment">//		&#125; </span></div><div class="line"><span class="comment">//		return ret; </span></div><div class="line">    &#125;</div><div class="line">    <span class="function">INT64 <span class="title">mod_pow</span><span class="params">(INT64 n, INT64 e, INT64 m)</span> </span>&#123;</div><div class="line">    	INT64 x = <span class="number">1</span>;</div><div class="line">    	<span class="keyword">for</span> (n = n &gt;= m ? n%m : n; e; e &gt;&gt;= <span class="number">1</span>) &#123;</div><div class="line">        	<span class="keyword">if</span> (e&amp;<span class="number">1</span>) </div><div class="line">                x = mod_mul(x, n, m);</div><div class="line">        	n = mod_mul(n, n, m);</div><div class="line">    	&#125;</div><div class="line">        <span class="keyword">return</span> x;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">NumberOfBitsNeeded</span><span class="params">(<span class="keyword">int</span> PowerOfTwo)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;; ++i) &#123;</div><div class="line">            <span class="keyword">if</span> (PowerOfTwo &amp; (<span class="number">1</span> &lt;&lt; i)) &#123;</div><div class="line">                <span class="keyword">return</span> i;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> UINT32 <span class="title">FastReverseBits</span><span class="params">(UINT32 a, <span class="keyword">int</span> NumBits)</span> </span>&#123;</div><div class="line">        a = ( ( a &amp; <span class="number">0x55555555</span>U ) &lt;&lt; <span class="number">1</span> ) | ( ( a &amp; <span class="number">0xAAAAAAAA</span>U ) &gt;&gt; <span class="number">1</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x33333333</span>U ) &lt;&lt; <span class="number">2</span> ) | ( ( a &amp; <span class="number">0xCCCCCCCC</span>U ) &gt;&gt; <span class="number">2</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x0F0F0F0F</span>U ) &lt;&lt; <span class="number">4</span> ) | ( ( a &amp; <span class="number">0xF0F0F0F0</span>U ) &gt;&gt; <span class="number">4</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x00FF00FF</span>U ) &lt;&lt; <span class="number">8</span> ) | ( ( a &amp; <span class="number">0xFF00FF00</span>U ) &gt;&gt; <span class="number">8</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x0000FFFF</span>U ) &lt;&lt; <span class="number">16</span> ) | ( ( a &amp; <span class="number">0xFFFF0000</span>U ) &gt;&gt; <span class="number">16</span> ) ;</div><div class="line">        <span class="keyword">return</span> a &gt;&gt; (<span class="number">32</span> - NumBits);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">NTT</span><span class="params">(<span class="keyword">int</span> on, INT64 *In, INT64 *Out, <span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> NumBits = NumberOfBitsNeeded(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</div><div class="line">            Out[FastReverseBits(i, NumBits)] = In[i];</div><div class="line">    	<span class="keyword">for</span>(<span class="keyword">int</span> h = <span class="number">2</span>, id = <span class="number">1</span>; h &lt;= n; h &lt;&lt;= <span class="number">1</span>, id++) &#123;</div><div class="line">        	<span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j += h) &#123;</div><div class="line">                INT64 w = <span class="number">1</span>, u, t;</div><div class="line">                <span class="keyword">int</span> block = h/<span class="number">2</span>, blockEnd = j + h/<span class="number">2</span>;</div><div class="line">            	<span class="keyword">for</span>(<span class="keyword">int</span> k = j; k &lt; blockEnd; k++) &#123;</div><div class="line">                	u = Out[k], t = mod_mul(w, Out[k+block], P);</div><div class="line">                	Out[k] = u + t;</div><div class="line">                	Out[k+block] = u - t + P;</div><div class="line">                	<span class="keyword">if</span> (Out[k] &gt;= P)		Out[k] -= P;</div><div class="line">                	<span class="keyword">if</span> (Out[k+block] &gt;= P)	Out[k+block] -= P;</div><div class="line">                	w = mod_mul(w, wn[id], P);</div><div class="line">            	&#125;</div><div class="line">        	&#125;</div><div class="line">    	&#125;</div><div class="line">        <span class="keyword">if</span> (on == <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n/<span class="number">2</span>; i++)</div><div class="line">                swap(Out[i], Out[n-i]);</div><div class="line">            INT64 invn = mod_pow(n, P<span class="number">-2</span>, P);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">                Out[i] = mod_mul(Out[i], invn, P);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">convolution</span><span class="params">(INT64 *a, INT64 *b, <span class="keyword">int</span> n, INT64 *c)</span> </span>&#123;</div><div class="line">        NTT(<span class="number">0</span>, a, d1, n);</div><div class="line">        s[<span class="number">0</span>] = b[<span class="number">0</span>];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++i)</div><div class="line">            s[i] = b[n-i];</div><div class="line">        NTT(<span class="number">0</span>, s, d2, n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            s[i] = mod_mul(d1[i], d2[i], P);</div><div class="line">        NTT(<span class="number">1</span>, s, c, n);</div><div class="line">    &#125;</div><div class="line">&#125; tool;</div><div class="line">INT64 a[<span class="number">262144</span>], b[<span class="number">262144</span>], c[<span class="number">262144</span>];</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> sum[<span class="number">512</span>][<span class="number">512</span>];</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="title">getArea</span><span class="params">(<span class="keyword">int</span> lx, <span class="keyword">int</span> ly, <span class="keyword">int</span> rx, <span class="keyword">int</span> ry)</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> ret = sum[rx][ry];</div><div class="line">    <span class="keyword">if</span>(lx)	ret -= sum[lx<span class="number">-1</span>][ry];</div><div class="line">    <span class="keyword">if</span>(ly)	ret -= sum[rx][ly<span class="number">-1</span>];</div><div class="line">    <span class="keyword">if</span>(lx &amp;&amp; ly)	ret += sum[lx<span class="number">-1</span>][ly<span class="number">-1</span>];</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">readchar</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> buf[N];</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> *p = buf, *end = buf;</div><div class="line">    <span class="keyword">if</span>(p == end) &#123;</div><div class="line">        <span class="keyword">if</span>((end = buf + fread(buf, <span class="number">1</span>, N, <span class="built_in">stdin</span>)) == buf) <span class="keyword">return</span> EOF;</div><div class="line">        p = buf;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> *p++;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">ReadInt</span><span class="params">(<span class="keyword">int</span> *x)</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> c, neg;</div><div class="line">    <span class="keyword">while</span>((c = readchar()) &lt; <span class="string">'-'</span>)    &#123;<span class="keyword">if</span>(c == EOF) <span class="keyword">return</span> <span class="number">0</span>;&#125;</div><div class="line">    neg = (c == <span class="string">'-'</span>) ? <span class="number">-1</span> : <span class="number">1</span>;</div><div class="line">    *x = (neg == <span class="number">1</span>) ? c-<span class="string">'0'</span> : <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span>((c = readchar()) &gt;= <span class="string">'0'</span>)</div><div class="line">        *x = (*x &lt;&lt; <span class="number">3</span>) + (*x &lt;&lt; <span class="number">1</span>) + c-<span class="string">'0'</span>;</div><div class="line">    *x *= neg;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> m, n, p, q, x, N, M, S;</div><div class="line">    <span class="keyword">while</span> (ReadInt(&amp;m)) &#123;</div><div class="line">    	ReadInt(&amp;n), ReadInt(&amp;p), ReadInt(&amp;q);</div><div class="line">    	N = max(m, p), M = max(n, q);</div><div class="line">        S = <span class="number">1</span>;</div><div class="line">        <span class="keyword">for</span> (; S &lt; N*M; S &lt;&lt;= <span class="number">1</span>);</div><div class="line">        <span class="built_in">memset</span>(a, <span class="number">0</span>, <span class="keyword">sizeof</span>(a[<span class="number">0</span>]) * S);</div><div class="line">        <span class="built_in">memset</span>(b, <span class="number">0</span>, <span class="keyword">sizeof</span>(b[<span class="number">0</span>]) * S);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">        	<span class="keyword">long</span> <span class="keyword">long</span> s = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</div><div class="line">        		ReadInt(&amp;x);</div><div class="line">            	a[i*M+j] = x;</div><div class="line">        		s += x*x;</div><div class="line">        		sum[i][j] = (i &gt; <span class="number">0</span> ? sum[i<span class="number">-1</span>][j] : <span class="number">0</span>) + s;          </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; p; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; q; j++) &#123;</div><div class="line">            	ReadInt(&amp;x);</div><div class="line">            	b[i*M+j] = x;</div><div class="line">            &#125;</div><div class="line">        &#125;        </div><div class="line">        tool.convolution(a, b, S, c);</div><div class="line">        <span class="keyword">int</span> qx = m - p, qy = n - q, bX = <span class="number">0</span>, bY = <span class="number">0</span>;</div><div class="line">        <span class="keyword">long</span> <span class="keyword">long</span> diff = LONG_MAX;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= qx; i++)    &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= qy; j++) &#123;</div><div class="line">                <span class="keyword">long</span> <span class="keyword">long</span> v = getArea(i, j, i+p<span class="number">-1</span>, j+q<span class="number">-1</span>) - <span class="number">2</span>*c[i*M + j];</div><div class="line">                <span class="keyword">if</span> (v &lt; diff)</div><div class="line">                    diff = v, bX = i, bY = j;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"diff = %lld\n"</span>, diff);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, bX+<span class="number">1</span>, bY+<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="NTT-FNT-CRT-加速"><a href="#NTT-FNT-CRT-加速" class="headerlink" title="NTT/FNT CRT 加速"></a>NTT/FNT CRT 加速</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">uint_fast32_t</span> UINT32;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> INT64;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">uint_fast32_t</span> INT32;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TOOL_NTT</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 262144</span></div><div class="line"><span class="comment">//	INT64 P = 50000000001507329LL; // prime m = kn+1</span></div><div class="line"><span class="comment">//	INT64 G = 3;</span></div><div class="line">    INT32 P = <span class="number">3</span>, G = <span class="number">2</span>;</div><div class="line">    INT32 wn[<span class="number">20</span>];</div><div class="line">    INT32 s[MAXN], d1[MAXN], d2[MAXN], c1[MAXN], c2[MAXN];</div><div class="line">    <span class="keyword">const</span> INT32 P1 = <span class="number">998244353</span>;	<span class="comment">// P1 = 2^23 * 7 * 17 + 1</span></div><div class="line">    <span class="keyword">const</span> INT32 G1 = <span class="number">3</span>;</div><div class="line">    <span class="keyword">const</span> INT32 P2 = <span class="number">995622913</span>; <span class="comment">// P2 = 2^19 *3*3*211 + 1</span></div><div class="line">    <span class="keyword">const</span> INT32 G2 = <span class="number">5</span>;</div><div class="line">    <span class="keyword">const</span> INT64 M1 = <span class="number">397550359381069386L</span>L;</div><div class="line">    <span class="keyword">const</span> INT64 M2 = <span class="number">596324591238590904L</span>L;</div><div class="line">    <span class="keyword">const</span> INT64 MM = <span class="number">993874950619660289L</span>L; <span class="comment">// MM = P1*P2</span></div><div class="line">    TOOL_NTT() &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++)</div><div class="line">            wn[i] = mod_pow(G, (P<span class="number">-1</span>) / (<span class="number">1</span>&lt;&lt;i), P);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reset</span><span class="params">(INT32 p, INT32 g)</span> </span>&#123;</div><div class="line">        P = p, G = g;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++)</div><div class="line">            wn[i] = mod_pow(G, (P<span class="number">-1</span>) / (<span class="number">1</span>&lt;&lt;i), P);</div><div class="line">    &#125;</div><div class="line">    <span class="function">INT64 <span class="title">mod_mul</span><span class="params">(INT64 a, INT64 b, INT64 mod)</span> </span>&#123; </div><div class="line">        <span class="keyword">long</span> <span class="keyword">long</span> y = (<span class="keyword">long</span> <span class="keyword">long</span>)((<span class="keyword">double</span>)a*b/mod+<span class="number">0.5</span>); <span class="comment">// fast for P &lt; 2^58</span></div><div class="line">    	<span class="keyword">long</span> <span class="keyword">long</span> r = (a*b-y*mod)%mod;</div><div class="line">    	<span class="keyword">return</span> r &lt; <span class="number">0</span> ? r + mod : r;</div><div class="line"><span class="comment">//	  	INT64 ret = 0; </span></div><div class="line"><span class="comment">//		for (a = a &gt;= mod ? a%mod : a, b = b &gt;= mod ? b%mod : b; b != 0; b&gt;&gt;=1, a &lt;&lt;= 1, a = a &gt;= mod ? a - mod : a) &#123; </span></div><div class="line"><span class="comment">//			if (b&amp;1) &#123;</span></div><div class="line"><span class="comment">//				ret += a;</span></div><div class="line"><span class="comment">//				if (ret &gt;= mod) </span></div><div class="line"><span class="comment">//					ret -= mod;</span></div><div class="line"><span class="comment">//			&#125; </span></div><div class="line"><span class="comment">//		&#125; </span></div><div class="line"><span class="comment">//		return ret; </span></div><div class="line">    &#125;</div><div class="line">    <span class="function">INT64 <span class="title">mod_pow</span><span class="params">(INT64 n, INT64 e, INT64 m)</span> </span>&#123;</div><div class="line">    	INT64 x = <span class="number">1</span>;</div><div class="line">    	<span class="keyword">for</span> (n = n &gt;= m ? n%m : n; e; e &gt;&gt;= <span class="number">1</span>) &#123;</div><div class="line">        	<span class="keyword">if</span> (e&amp;<span class="number">1</span>) </div><div class="line">                x = mod_mul(x, n, m);</div><div class="line">        	n = mod_mul(n, n, m);</div><div class="line">    	&#125;</div><div class="line">        <span class="keyword">return</span> x;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">NumberOfBitsNeeded</span><span class="params">(<span class="keyword">int</span> PowerOfTwo)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;; ++i) &#123;</div><div class="line">            <span class="keyword">if</span> (PowerOfTwo &amp; (<span class="number">1</span> &lt;&lt; i)) &#123;</div><div class="line">                <span class="keyword">return</span> i;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> UINT32 <span class="title">FastReverseBits</span><span class="params">(UINT32 a, <span class="keyword">int</span> NumBits)</span> </span>&#123;</div><div class="line">        a = ( ( a &amp; <span class="number">0x55555555</span>U ) &lt;&lt; <span class="number">1</span> ) | ( ( a &amp; <span class="number">0xAAAAAAAA</span>U ) &gt;&gt; <span class="number">1</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x33333333</span>U ) &lt;&lt; <span class="number">2</span> ) | ( ( a &amp; <span class="number">0xCCCCCCCC</span>U ) &gt;&gt; <span class="number">2</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x0F0F0F0F</span>U ) &lt;&lt; <span class="number">4</span> ) | ( ( a &amp; <span class="number">0xF0F0F0F0</span>U ) &gt;&gt; <span class="number">4</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x00FF00FF</span>U ) &lt;&lt; <span class="number">8</span> ) | ( ( a &amp; <span class="number">0xFF00FF00</span>U ) &gt;&gt; <span class="number">8</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x0000FFFF</span>U ) &lt;&lt; <span class="number">16</span> ) | ( ( a &amp; <span class="number">0xFFFF0000</span>U ) &gt;&gt; <span class="number">16</span> ) ;</div><div class="line">        <span class="keyword">return</span> a &gt;&gt; (<span class="number">32</span> - NumBits);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">NTT</span><span class="params">(<span class="keyword">int</span> on, INT32 *In, INT32 *Out, <span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> NumBits = NumberOfBitsNeeded(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</div><div class="line">            Out[FastReverseBits(i, NumBits)] = In[i];</div><div class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> h = <span class="number">2</span>, id = <span class="number">1</span>; h &lt;= n; h &lt;&lt;= <span class="number">1</span>, id++) &#123;</div><div class="line">        	<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j += h) &#123;</div><div class="line">                INT32 w = <span class="number">1</span>, u, t;</div><div class="line">                <span class="keyword">int</span> block = h/<span class="number">2</span>, blockEnd = j + h/<span class="number">2</span>;</div><div class="line">            	<span class="keyword">for</span> (<span class="keyword">int</span> k = j; k &lt; blockEnd; k++) &#123;</div><div class="line">                	u = Out[k], t = (INT64)w*Out[k+block]%P;</div><div class="line">                	Out[k] = (u + t)%P;</div><div class="line">                	Out[k+block] = (u - t + P)%P;</div><div class="line">                	w = (INT64)w * wn[id]%P;</div><div class="line">            	&#125;</div><div class="line">        	&#125;</div><div class="line">    	&#125;</div><div class="line">        <span class="keyword">if</span> (on == <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n/<span class="number">2</span>; i++)</div><div class="line">                swap(Out[i], Out[n-i]);</div><div class="line">            INT32 invn = mod_pow(n, P<span class="number">-2</span>, P);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">                Out[i] = (INT64)Out[i]*invn%P;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function">INT64 <span class="title">crt</span><span class="params">(INT32 a, INT32 b)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (mod_mul(a, M1, MM) + mod_mul(b, M2, MM))%MM;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">convolution</span><span class="params">(INT32 *a, INT32 *b, <span class="keyword">int</span> n, INT64 *c)</span> </span>&#123;</div><div class="line">        reset(P1, G1);</div><div class="line">        NTT(<span class="number">0</span>, a, d1, n);</div><div class="line">        s[<span class="number">0</span>] = b[<span class="number">0</span>];	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++i) s[i] = b[n-i];</div><div class="line">        NTT(<span class="number">0</span>, s, d2, n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)	s[i] = (INT64)d1[i] * d2[i]%P;</div><div class="line">        NTT(<span class="number">1</span>, s, c1, n);</div><div class="line">        reset(P2, G2);</div><div class="line">        NTT(<span class="number">0</span>, a, d1, n);</div><div class="line">        s[<span class="number">0</span>] = b[<span class="number">0</span>];	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++i) s[i] = b[n-i];</div><div class="line">        NTT(<span class="number">0</span>, s, d2, n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)	s[i] = (INT64)d1[i] * d2[i]%P;</div><div class="line">        NTT(<span class="number">1</span>, s, c2, n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            c[i] = crt(c1[i], c2[i]);</div><div class="line">    &#125;</div><div class="line">&#125; tool;</div><div class="line">INT32 a[<span class="number">262144</span>], b[<span class="number">262144</span>];</div><div class="line">INT64 c[<span class="number">262144</span>];</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> sum[<span class="number">512</span>][<span class="number">512</span>];</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="title">getArea</span><span class="params">(<span class="keyword">int</span> lx, <span class="keyword">int</span> ly, <span class="keyword">int</span> rx, <span class="keyword">int</span> ry)</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> ret = sum[rx][ry];</div><div class="line">    <span class="keyword">if</span>(lx)	ret -= sum[lx<span class="number">-1</span>][ry];</div><div class="line">    <span class="keyword">if</span>(ly)	ret -= sum[rx][ly<span class="number">-1</span>];</div><div class="line">    <span class="keyword">if</span>(lx &amp;&amp; ly)	ret += sum[lx<span class="number">-1</span>][ly<span class="number">-1</span>];</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">readchar</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> buf[N];</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> *p = buf, *end = buf;</div><div class="line">    <span class="keyword">if</span>(p == end) &#123;</div><div class="line">        <span class="keyword">if</span>((end = buf + fread(buf, <span class="number">1</span>, N, <span class="built_in">stdin</span>)) == buf) <span class="keyword">return</span> EOF;</div><div class="line">        p = buf;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> *p++;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">ReadInt</span><span class="params">(<span class="keyword">int</span> *x)</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> c, neg;</div><div class="line">    <span class="keyword">while</span>((c = readchar()) &lt; <span class="string">'-'</span>)    &#123;<span class="keyword">if</span>(c == EOF) <span class="keyword">return</span> <span class="number">0</span>;&#125;</div><div class="line">    neg = (c == <span class="string">'-'</span>) ? <span class="number">-1</span> : <span class="number">1</span>;</div><div class="line">    *x = (neg == <span class="number">1</span>) ? c-<span class="string">'0'</span> : <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span>((c = readchar()) &gt;= <span class="string">'0'</span>)</div><div class="line">        *x = (*x &lt;&lt; <span class="number">3</span>) + (*x &lt;&lt; <span class="number">1</span>) + c-<span class="string">'0'</span>;</div><div class="line">    *x *= neg;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> m, n, p, q, x, N, M, S;</div><div class="line">    <span class="keyword">while</span> (ReadInt(&amp;m)) &#123;</div><div class="line">    	ReadInt(&amp;n), ReadInt(&amp;p), ReadInt(&amp;q);</div><div class="line">    	N = max(m, p), M = max(n, q);</div><div class="line">        S = <span class="number">1</span>;</div><div class="line">        <span class="keyword">for</span> (; S &lt; N*M; S &lt;&lt;= <span class="number">1</span>);</div><div class="line">        <span class="built_in">memset</span>(a, <span class="number">0</span>, <span class="keyword">sizeof</span>(a[<span class="number">0</span>]) * S);</div><div class="line">        <span class="built_in">memset</span>(b, <span class="number">0</span>, <span class="keyword">sizeof</span>(b[<span class="number">0</span>]) * S);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">        	<span class="keyword">long</span> <span class="keyword">long</span> s = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</div><div class="line">        		ReadInt(&amp;x);</div><div class="line">            	a[i*M+j] = x;</div><div class="line">        		s += x*x;</div><div class="line">        		sum[i][j] = (i &gt; <span class="number">0</span> ? sum[i<span class="number">-1</span>][j] : <span class="number">0</span>) + s;          </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; p; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; q; j++) &#123;</div><div class="line">            	ReadInt(&amp;x);</div><div class="line">            	b[i*M+j] = x;</div><div class="line">            &#125;</div><div class="line">        &#125;        </div><div class="line">        tool.convolution(a, b, S, c);</div><div class="line">        <span class="keyword">int</span> qx = m - p, qy = n - q, bX = <span class="number">0</span>, bY = <span class="number">0</span>;</div><div class="line">        <span class="keyword">long</span> <span class="keyword">long</span> diff = LONG_MAX;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= qx; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= qy; j++) &#123;</div><div class="line">                <span class="keyword">long</span> <span class="keyword">long</span> v = getArea(i, j, i+p<span class="number">-1</span>, j+q<span class="number">-1</span>) - <span class="number">2</span>*c[i*M + j];</div><div class="line">                <span class="keyword">if</span> (v &lt; diff)</div><div class="line">                    diff = v, bX = i, bY = j;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"diff = %lld\n"</span>, diff);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, bX+<span class="number">1</span>, bY+<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b325" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/21/zj-b325/" class="article-date">
  <time datetime="2015-07-21T00:09:19.000Z" itemprop="datePublished">2015-07-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/21/zj-b325/">b325. 人格分裂</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/21/zj-b325/" data-id="ckq8nozyr011k1wvnjoon8ij5" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/21/zj-b325/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/射線/">射線</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/幾何/">幾何</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/掃描線/">掃描線</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/極角排序/">極角排序</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>某 M 現在正在平面座標上的原點 <span>$(0, 0)$</span><!-- Has MathJax -->，現在四周被擺放了很多很多鏡子，某 M 可以藉由鏡子與他的人格小夥伴對話，請問那些鏡子可以見到小夥伴。</p>
<p>鏡子可以當作一個線段，線段之間不會交任何一點，只要能見到該鏡子中一小段區域就算可見到。</p>
<p>備註：不考慮反射看到，保證鏡子不會通過原點。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">5 -5 5 5</div><div class="line">4</div><div class="line">4 2 5 -2</div><div class="line">2 4 6 1</div><div class="line">5 5 8 1</div><div class="line">3 -4 7 -1</div><div class="line">7</div><div class="line">-1 2 3 1</div><div class="line">2 4 5 -1</div><div class="line">-3 -1 1 -2</div><div class="line">-1 -4 3 -2</div><div class="line">-2 -4 1 -5</div><div class="line">-4 1 -1 4</div><div class="line">-3 4 -4 3</div><div class="line">1</div><div class="line">1 1 2 2</div><div class="line">2</div><div class="line">-1 3 -2 -2</div><div class="line">-2 -1 -3 -1</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">1 1 0 1</div><div class="line">1 1 1 1 0 1 0</div><div class="line">0</div><div class="line">1 0</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>對於每一個線段，可以化作極角座標上的一個角度區間<span>$[\theta_{start}, \theta_{end}]$</span><!-- Has MathJax -->，做一次極角排序，維護從原點射出的射線，找到該射線交到的所有角度區間，意即維護射線和線段交的最近距離，用一個平衡樹 <code>set&lt;Seg&gt;</code> 維護。由於線段之間不會相交，平衡樹靠遠近當作權重比較，遠近關係是單調的，故不影響插入和刪除。若發生遠近問題可採用 <code>multiset&lt;Seg&gt;</code> 來進行。</p>
<p>由於每一個線段可能拆分好幾個可視線段，而大多數的線段全是不可視的，可以考慮分治去處理，但我的實作效果並不好，其原因在於並沒有維護極角的 skyline，而是保留整個線段。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> eps 1e-12</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pt</span> &#123;</span></div><div class="line">    <span class="keyword">double</span> x, y;</div><div class="line">    Pt(<span class="keyword">double</span> a = <span class="number">0</span>, <span class="keyword">double</span> b = <span class="number">0</span>):</div><div class="line">    x(a), y(b) &#123;&#125;</div><div class="line">    Pt <span class="keyword">operator</span>-(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">return</span> Pt(x - a.x, y - a.y);</div><div class="line">    &#125;</div><div class="line">    Pt <span class="keyword">operator</span>+(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">return</span> Pt(x + a.x, y + a.y);</div><div class="line">    &#125;</div><div class="line">    Pt <span class="keyword">operator</span>*(<span class="keyword">const</span> <span class="keyword">double</span> a) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">return</span> Pt(x * a, y * a);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="built_in">fabs</span>(x - a.x) &gt; eps)</div><div class="line">            <span class="keyword">return</span> x &lt; a.x;</div><div class="line">        <span class="keyword">if</span> (<span class="built_in">fabs</span>(y - a.y) &gt; eps)</div><div class="line">            <span class="keyword">return</span> y &lt; a.y;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">double</span> <span class="title">dist2</span><span class="params">(Pt a)</span> </span>&#123;</div><div class="line">    	<span class="keyword">return</span> (x - a.x)*(x - a.x)+(y - a.y)*(y - a.y);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">dot</span><span class="params">(Pt a, Pt b)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> a.x * b.x + a.y * b.y;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">cross</span><span class="params">(Pt o, Pt a, Pt b)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (a.x-o.x)*(b.y-o.y)-(a.y-o.y)*(b.x-o.x);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">cross2</span><span class="params">(Pt a, Pt b)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> a.x * b.y - a.y * b.x;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">between</span><span class="params">(Pt a, Pt b, Pt c)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> dot(c - a, b - a) &gt;= -eps &amp;&amp; dot(c - b, a - b) &gt;= -eps;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">onSeg</span><span class="params">(Pt a, Pt b, Pt c)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> between(a, b, c) &amp;&amp; <span class="built_in">fabs</span>(cross(a, b, c)) &lt; eps;</div><div class="line">&#125;</div><div class="line"><span class="function">Pt <span class="title">getIntersect</span><span class="params">(Pt as, Pt ae, Pt bs, Pt be)</span> </span>&#123;</div><div class="line">    Pt u = as - bs;</div><div class="line">    <span class="keyword">double</span> t = cross2(be - bs, u)/cross2(ae - as, be - bs);</div><div class="line">    <span class="keyword">return</span> as + (ae - as) * t;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Seg</span> &#123;</span></div><div class="line">    Pt s, e;</div><div class="line">    <span class="keyword">int</span> id;</div><div class="line">    Seg(Pt a = Pt(), Pt b = Pt(), <span class="keyword">int</span> c = <span class="number">0</span>):</div><div class="line">        s(a), e(b), id(c) &#123;&#125;</div><div class="line">&#125;;</div><div class="line"><span class="function"><span class="keyword">bool</span> <span class="title">polar_cmp</span><span class="params">(<span class="keyword">const</span> Pt&amp; p1, <span class="keyword">const</span> Pt&amp; p2)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (p1.y == <span class="number">0</span> &amp;&amp; p2.y == <span class="number">0</span> &amp;&amp; p1.x * p2.x &lt;= <span class="number">0</span>) <span class="keyword">return</span> p1.x &gt; p2.x;</div><div class="line">    <span class="keyword">if</span> (p1.y == <span class="number">0</span> &amp;&amp; p1.x &gt;= <span class="number">0</span> &amp;&amp; p2.y != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    <span class="keyword">if</span> (p2.y == <span class="number">0</span> &amp;&amp; p2.x &gt;= <span class="number">0</span> &amp;&amp; p1.y != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    <span class="keyword">if</span> (p1.y * p2.y &lt; <span class="number">0</span>) <span class="keyword">return</span> p1.y &gt; p2.y;</div><div class="line">    <span class="keyword">double</span> c = cross2(p1, p2);</div><div class="line">    <span class="keyword">return</span> c &gt; <span class="number">0</span> || (c == <span class="number">0</span> &amp;&amp; <span class="built_in">fabs</span>(p1.x) &lt; <span class="built_in">fabs</span>(p2.x));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">bool</span> <span class="title">polar_cmp2</span><span class="params">(pair&lt;Pt, <span class="keyword">int</span>&gt; x, pair&lt;Pt, <span class="keyword">int</span>&gt; y)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> polar_cmp(x.first, y.first);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">cmpZero</span><span class="params">(<span class="keyword">double</span> x)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="built_in">fabs</span>(x) &lt; eps)	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">return</span> x &lt; <span class="number">0</span> ? <span class="number">-1</span> : <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CMP</span> &#123;</span></div><div class="line">    <span class="keyword">static</span> Pt ray_s, ray_e;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">const</span> Seg &amp;x, <span class="keyword">const</span> Seg &amp;y)</span> </span>&#123;</div><div class="line">        Pt v1 = getIntersect(ray_s, ray_e, x.s, x.e);</div><div class="line">        Pt v2 = getIntersect(ray_s, ray_e, y.s, y.e);</div><div class="line">        <span class="keyword">return</span> cmpZero(ray_s.dist2(v1) - ray_s.dist2(v2)) &lt; <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">ray2seg</span><span class="params">(Seg x)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (cmpZero(cross(ray_s, ray_e, x.s))*cmpZero(cross(ray_s, ray_e, x.e)) &lt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> cmpZero(cross(x.s, ray_s, ray_s+ray_e))*cmpZero(cross(x.s, ray_s, x.e)) &gt;= <span class="number">0</span> &amp;&amp;</div><div class="line">                    cmpZero(cross(x.e, ray_s, ray_s+ray_e))*cmpZero(cross(x.e, ray_s, x.s)) &gt;= <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">Pt CMP::ray_s, CMP::ray_e;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">32768</span>;</div><div class="line"><span class="keyword">int</span> visual[MAXN];</div><div class="line">Seg segs[MAXN];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> N, sx, sy, ex, ey;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;N) == <span class="number">1</span>) &#123;</div><div class="line">        <span class="built_in">vector</span>&lt; pair&lt;Pt, <span class="keyword">int</span>&gt; &gt; A;</div><div class="line">        <span class="built_in">set</span>&lt;Seg, CMP&gt; S;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d %d %d"</span>, &amp;sx, &amp;sy, &amp;ex, &amp;ey);</div><div class="line">            A.push_back(make_pair(Pt(sx, sy), i));</div><div class="line">            A.push_back(make_pair(Pt(ex, ey), -i));</div><div class="line">            segs[i] = Seg(Pt(sx, sy), Pt(ex, ey), i);</div><div class="line">            visual[i] = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        sort(A.begin(), A.end(), polar_cmp2);</div><div class="line">        CMP::ray_s = Pt(<span class="number">0</span>, <span class="number">0</span>), CMP::ray_e = A[<span class="number">0</span>].first;</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (CMP::ray2seg(segs[i]))</div><div class="line">                S.insert(segs[i]);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; A.size(); ) &#123;</div><div class="line">            CMP::ray_e = A[i].first;</div><div class="line">            <span class="keyword">while</span> (i &lt; A.size() &amp;&amp; cmpZero(cross(CMP::ray_s, CMP::ray_e, A[i].first)) == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">int</span> clockwise, id = <span class="built_in">abs</span>(A[i].second);</div><div class="line">                <span class="keyword">if</span> (A[i].second &gt; <span class="number">0</span>) </div><div class="line">                    clockwise = cmpZero(cross(CMP::ray_s, segs[id].s, segs[id].e));</div><div class="line">                <span class="keyword">else</span> </div><div class="line">                    clockwise = cmpZero(cross(CMP::ray_s, segs[id].e, segs[id].s));</div><div class="line">                <span class="keyword">if</span> (clockwise) &#123;</div><div class="line">                    <span class="keyword">if</span> (clockwise &gt; <span class="number">0</span>)</div><div class="line">                        S.insert(segs[id]);</div><div class="line">                    <span class="keyword">else</span></div><div class="line">                        S.erase(segs[id]);</div><div class="line">                &#125;</div><div class="line">                i++;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (S.size() &gt; <span class="number">0</span>) </div><div class="line">                visual[S.begin()-&gt;id] = <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++)</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d%c"</span>, visual[i], i == N ? <span class="string">'\n'</span> : <span class="string">' '</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="附錄-DC"><a href="#附錄-DC" class="headerlink" title="附錄 DC"></a>附錄 DC</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> eps 1e-9</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pt</span> &#123;</span></div><div class="line">    <span class="keyword">double</span> x, y;</div><div class="line">    Pt(<span class="keyword">double</span> a = <span class="number">0</span>, <span class="keyword">double</span> b = <span class="number">0</span>):</div><div class="line">    x(a), y(b) &#123;&#125;</div><div class="line">    Pt <span class="keyword">operator</span>-(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">return</span> Pt(x - a.x, y - a.y);</div><div class="line">    &#125;</div><div class="line">    Pt <span class="keyword">operator</span>+(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">return</span> Pt(x + a.x, y + a.y);</div><div class="line">    &#125;</div><div class="line">    Pt <span class="keyword">operator</span>*(<span class="keyword">const</span> <span class="keyword">double</span> a) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">return</span> Pt(x * a, y * a);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="built_in">fabs</span>(x - a.x) &gt; eps)</div><div class="line">            <span class="keyword">return</span> x &lt; a.x;</div><div class="line">        <span class="keyword">if</span> (<span class="built_in">fabs</span>(y - a.y) &gt; eps)</div><div class="line">            <span class="keyword">return</span> y &lt; a.y;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">double</span> <span class="title">dist2</span><span class="params">(Pt a)</span> </span>&#123;</div><div class="line">    	<span class="keyword">return</span> (x - a.x)*(x - a.x)+(y - a.y)*(y - a.y);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">dot</span><span class="params">(Pt a, Pt b)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> a.x * b.x + a.y * b.y;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">cross</span><span class="params">(Pt o, Pt a, Pt b)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (a.x-o.x)*(b.y-o.y)-(a.y-o.y)*(b.x-o.x);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">cross2</span><span class="params">(Pt a, Pt b)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> a.x * b.y - a.y * b.x;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">between</span><span class="params">(Pt a, Pt b, Pt c)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> dot(c - a, b - a) &gt;= -eps &amp;&amp; dot(c - b, a - b) &gt;= -eps;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">onSeg</span><span class="params">(Pt a, Pt b, Pt c)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> between(a, b, c) &amp;&amp; <span class="built_in">fabs</span>(cross(a, b, c)) &lt; eps;</div><div class="line">&#125;</div><div class="line"><span class="function">Pt <span class="title">getIntersect</span><span class="params">(Pt as, Pt ae, Pt bs, Pt be)</span> </span>&#123;</div><div class="line">    Pt u = as - bs;</div><div class="line">    <span class="keyword">double</span> t = cross2(be - bs, u)/cross2(ae - as, be - bs);</div><div class="line">    <span class="keyword">return</span> as + (ae - as) * t;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Seg</span> &#123;</span></div><div class="line">    Pt s, e;</div><div class="line">    <span class="keyword">int</span> id;</div><div class="line">    Seg(Pt a = Pt(), Pt b = Pt(), <span class="keyword">int</span> c = <span class="number">0</span>):</div><div class="line">        s(a), e(b), id(c) &#123;&#125;</div><div class="line">&#125;;</div><div class="line"><span class="function"><span class="keyword">bool</span> <span class="title">polar_cmp</span><span class="params">(<span class="keyword">const</span> Pt&amp; p1, <span class="keyword">const</span> Pt&amp; p2)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (p1.y == <span class="number">0</span> &amp;&amp; p2.y == <span class="number">0</span> &amp;&amp; p1.x * p2.x &lt;= <span class="number">0</span>) <span class="keyword">return</span> p1.x &gt; p2.x;</div><div class="line">    <span class="keyword">if</span> (p1.y == <span class="number">0</span> &amp;&amp; p1.x &gt;= <span class="number">0</span> &amp;&amp; p2.y != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    <span class="keyword">if</span> (p2.y == <span class="number">0</span> &amp;&amp; p2.x &gt;= <span class="number">0</span> &amp;&amp; p1.y != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    <span class="keyword">if</span> (p1.y * p2.y &lt; <span class="number">0</span>) <span class="keyword">return</span> p1.y &gt; p2.y;</div><div class="line">    <span class="keyword">double</span> c = cross2(p1, p2);</div><div class="line">    <span class="keyword">return</span> c &gt; <span class="number">0</span> || (c == <span class="number">0</span> &amp;&amp; <span class="built_in">fabs</span>(p1.x) &lt; <span class="built_in">fabs</span>(p2.x));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">bool</span> <span class="title">polar_cmp2</span><span class="params">(pair&lt;Pt, <span class="keyword">int</span>&gt; x, pair&lt;Pt, <span class="keyword">int</span>&gt; y)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> polar_cmp(x.first, y.first);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">cmpZero</span><span class="params">(<span class="keyword">double</span> x)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="built_in">fabs</span>(x) &lt; eps)	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">return</span> x &lt; <span class="number">0</span> ? <span class="number">-1</span> : <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CMP</span> &#123;</span></div><div class="line">    <span class="keyword">static</span> Pt ray_s, ray_e;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">const</span> Seg &amp;x, <span class="keyword">const</span> Seg &amp;y)</span> </span>&#123;</div><div class="line">        Pt v1 = getIntersect(ray_s, ray_e, x.s, x.e);</div><div class="line">        Pt v2 = getIntersect(ray_s, ray_e, y.s, y.e);</div><div class="line">        <span class="keyword">return</span> cmpZero(ray_s.dist2(v1) - ray_s.dist2(v2)) &lt; <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">ray2seg</span><span class="params">(Seg x)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (cmpZero(cross(ray_s, ray_e, x.s))*cmpZero(cross(ray_s, ray_e, x.e)) &lt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> cmpZero(cross(x.s, ray_s, ray_s+ray_e))*cmpZero(cross(x.s, ray_s, x.e)) &gt;= <span class="number">0</span> &amp;&amp;</div><div class="line">                    cmpZero(cross(x.e, ray_s, ray_s+ray_e))*cmpZero(cross(x.e, ray_s, x.s)) &gt;= <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">Pt CMP::ray_s, CMP::ray_e;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">32768</span>;</div><div class="line"><span class="keyword">int</span> visual[MAXN];</div><div class="line">Seg mirror[MAXN], sm[MAXN];</div><div class="line"></div><div class="line"><span class="built_in">vector</span>&lt;Seg&gt; computePolar(<span class="built_in">vector</span>&lt;Seg&gt; segs) &#123;</div><div class="line">    <span class="keyword">if</span> (segs.size() == <span class="number">0</span>)</div><div class="line">        <span class="keyword">return</span> <span class="built_in">vector</span>&lt;Seg&gt;();</div><div class="line">    <span class="built_in">vector</span>&lt; pair&lt;Pt, <span class="keyword">int</span>&gt; &gt; A;</div><div class="line">    <span class="built_in">set</span>&lt;Seg, CMP&gt; S;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; segs.size(); i++) &#123;</div><div class="line">        A.push_back(make_pair(segs[i].s, segs[i].id));</div><div class="line">        A.push_back(make_pair(segs[i].e, -segs[i].id));</div><div class="line">        visual[segs[i].id] = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    sort(A.begin(), A.end(), polar_cmp2);</div><div class="line">    CMP::ray_s = Pt(<span class="number">0</span>, <span class="number">0</span>), CMP::ray_e = A[<span class="number">0</span>].first;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; segs.size(); i++) &#123;</div><div class="line">        <span class="keyword">if</span> (CMP::ray2seg(segs[i]))</div><div class="line">            S.insert(segs[i]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; A.size(); ) &#123;</div><div class="line">        CMP::ray_e = A[i].first;</div><div class="line">        <span class="keyword">while</span> (i &lt; A.size() &amp;&amp; cmpZero(cross(CMP::ray_s, CMP::ray_e, A[i].first)) == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">int</span> clockwise, id = <span class="built_in">abs</span>(A[i].second);</div><div class="line">            <span class="keyword">if</span> (A[i].second &gt; <span class="number">0</span>) </div><div class="line">                clockwise = cmpZero(cross(CMP::ray_s, sm[id].s, sm[id].e));</div><div class="line">            <span class="keyword">else</span> </div><div class="line">                clockwise = cmpZero(cross(CMP::ray_s, sm[id].e, sm[id].s));</div><div class="line">            <span class="keyword">if</span> (clockwise) &#123;</div><div class="line">                <span class="keyword">if</span> (clockwise &gt; <span class="number">0</span>)</div><div class="line">                    S.insert(sm[id]);</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    S.erase(sm[id]);</div><div class="line">            &#125;</div><div class="line">            i++;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (S.size() &gt; <span class="number">0</span>) </div><div class="line">            visual[S.begin()-&gt;id] = <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">vector</span>&lt;Seg&gt; ret;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; segs.size(); i++) &#123;</div><div class="line">        <span class="keyword">if</span> (visual[segs[i].id])</div><div class="line">            ret.push_back(segs[i]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="built_in">vector</span>&lt;Seg&gt; dfs(<span class="keyword">int</span> l, <span class="keyword">int</span> r) &#123;</div><div class="line">    <span class="built_in">vector</span>&lt;Seg&gt; L, R;</div><div class="line">    <span class="keyword">if</span> (l &gt; r)	<span class="keyword">return</span> L;</div><div class="line">    <span class="keyword">if</span> (l == r)</div><div class="line">        <span class="keyword">return</span> computePolar(<span class="built_in">vector</span>&lt;Seg&gt;(mirror+l, mirror+l+<span class="number">1</span>));</div><div class="line">    <span class="keyword">int</span> mid = (l+r)/<span class="number">2</span>;</div><div class="line">    L = dfs(l, mid);</div><div class="line">    R = dfs(mid+<span class="number">1</span>, r);</div><div class="line">    L.insert(L.end(), R.begin(), R.end());</div><div class="line">    <span class="keyword">return</span> computePolar(L);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">bool</span> <span class="title">cmp</span><span class="params">(Seg a, Seg b)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> polar_cmp(a.s, b.s);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> N, sx, sy, ex, ey;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;N) == <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d %d %d"</span>, &amp;sx, &amp;sy, &amp;ex, &amp;ey);</div><div class="line">            Pt s(sx, sy), e(ex, ey);</div><div class="line">            <span class="keyword">if</span> (polar_cmp(s, e))</div><div class="line">                swap(s, e);</div><div class="line">            sm[i] = mirror[i] = Seg(s, e, i);</div><div class="line">        &#125;</div><div class="line">        sort(mirror+<span class="number">1</span>, mirror+N, cmp);</div><div class="line">        dfs(<span class="number">1</span>, N);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++)</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d%c"</span>, visual[i], i == N ? <span class="string">'\n'</span> : <span class="string">' '</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-a739" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/20/zj-a739/" class="article-date">
  <time datetime="2015-07-20T00:47:12.000Z" itemprop="datePublished">2015-07-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/20/zj-a739/">a739. 道路架設</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/20/zj-a739/" data-id="ckq8nozyi010x1wvn9swkmooy" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/20/zj-a739/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LCA/">LCA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tarjan/">tarjan</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/離線處理/">離線處理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/非遞迴/">非遞迴</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>給定一個有根樹，詢問兩個節點 <span>$(u, v)$</span><!-- Has MathJax --> 的距離，點數最多 <span>$V = 2000000$</span><!-- Has MathJax -->。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">4</div><div class="line">1 3</div><div class="line">1 7</div><div class="line">2 5</div><div class="line">3</div><div class="line">1 4</div><div class="line">2 3</div><div class="line">1 4</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">8</div><div class="line">10</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>明顯地不可能使用 <code>LCA-RMQ</code> 的 <span>$O(Q \log V)$</span><!-- Has MathJax --> 在線詢問，要套用 tarjan 算法中的 Offline-LCA，但 tarjan 算法靠的是遞迴遍歷，在 <code>V = 20000000</code> 很容易發生 stackoverflow，為了解決這一點採用非遞迴的方式實作。</p>
<p>這一題還有特別卡的地方，有向邊的儲存，之前 tarjan 都用在無向樹上，所以普遍都會儲存 <span>$2 E$</span><!-- Has MathJax --> 條邊，這一題必須只儲存 <span>$E$</span><!-- Has MathJax --> 條邊，常數卡得緊，不掛上優化輸入時間限制是在 TLE 邊緣。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXV = <span class="number">2000005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXQ = <span class="number">100005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXE = <span class="number">2000005</span>;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LCA</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span></div><div class="line">    	<span class="keyword">int</span> v;</div><div class="line">    	Edge *next;</div><div class="line">    &#125;;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">QEdge</span> &#123;</span></div><div class="line">        <span class="keyword">int</span> qid, u;</div><div class="line">        QEdge *next;</div><div class="line">    &#125;;</div><div class="line">    Edge edge[MAXE], *adj[MAXV], *arc[MAXV];</div><div class="line">    QEdge qedge[MAXQ&lt;&lt;<span class="number">1</span>], *qadj[MAXV], *qarc[MAXV];</div><div class="line">    <span class="keyword">int</span> e, eq, n;</div><div class="line">    <span class="keyword">int</span> parent[MAXV], weight[MAXV], visited[MAXV], LCA[MAXQ];</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        e = eq = <span class="number">0</span>, <span class="keyword">this</span>-&gt;n = n;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            adj[i] = <span class="literal">NULL</span>, qadj[i] = <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addDedge</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">        edge[e].v = y, edge[e].next = adj[x], adj[x] = &amp;edge[e++];</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addQuery</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> qid)</span> </span>&#123;</div><div class="line">        qedge[eq].qid = qid, qedge[eq].u = y, qedge[eq].next = qadj[x], qadj[x] = &amp;qedge[eq++];</div><div class="line">        qedge[eq].qid = qid, qedge[eq].u = x, qedge[eq].next = qadj[y], qadj[y] = &amp;qedge[eq++];</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">(<span class="keyword">int</span> root)</span> </span>&#123;</div><div class="line">        tarjan(root);</div><div class="line">    &#125;</div><div class="line"><span class="keyword">private</span>:	</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">findp</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> parent[x] == x ? x : (parent[x] = findp(parent[x]));</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">joint</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">        x = findp(x), y = findp(y);</div><div class="line">        <span class="keyword">if</span>(x == y)	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span>(weight[x] &gt; weight[y])</div><div class="line">            weight[x] += weight[y], parent[y] = x;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            weight[y] += weight[x], parent[x] = y;</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></div><div class="line">        <span class="keyword">int</span> u, p, line;</div><div class="line">        Node(<span class="keyword">int</span> a = <span class="number">0</span>, <span class="keyword">int</span> b = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>):</div><div class="line">            u(a), p(b), line(c) &#123;&#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">tarjan</span><span class="params">(<span class="keyword">int</span> root)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) </div><div class="line">            arc[i] = adj[i], qarc[i] = qadj[i], visited[i] = <span class="number">0</span>;</div><div class="line">        <span class="built_in">stack</span>&lt;Node&gt; stk;</div><div class="line">        Node u;</div><div class="line">        <span class="keyword">int</span> x, y;</div><div class="line">        stk.push(Node(root, <span class="number">-1</span>, <span class="number">0</span>));</div><div class="line">        parent[root] = root;</div><div class="line">        <span class="keyword">while</span> (!stk.empty()) &#123;</div><div class="line">            u = stk.top(), stk.pop();</div><div class="line">            <span class="keyword">if</span> (u.line == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (arc[u.u]) &#123;</div><div class="line">                    y = arc[u.u]-&gt;v, arc[u.u] = arc[u.u]-&gt;next;</div><div class="line">        			stk.push(u);</div><div class="line">                    parent[y] = y;</div><div class="line">        			stk.push(Node(y, u.u, <span class="number">0</span>));</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    visited[u.u] = <span class="number">1</span>;</div><div class="line">                    u.line++;</div><div class="line">                    stk.push(u);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (qarc[u.u]) &#123;</div><div class="line">                    x = qarc[u.u]-&gt;qid, y = qarc[u.u]-&gt;u, qarc[u.u] = qarc[u.u]-&gt;next;</div><div class="line">            		stk.push(u);</div><div class="line">            		<span class="keyword">if</span> (visited[y])</div><div class="line">            			LCA[x] = findp(y);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (u.p != <span class="number">-1</span>)</div><div class="line">                        parent[findp(u.u)] = u.p;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125; lca;</div><div class="line"><span class="keyword">int</span> A[MAXQ], B[MAXQ], dist[MAXV];</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> C[MAXV];</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> u, line;</div><div class="line">    Node(<span class="keyword">int</span> a = <span class="number">0</span>, <span class="keyword">int</span> b = <span class="number">0</span>):</div><div class="line">        u(a), line(b) &#123;&#125;</div><div class="line">&#125;;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> root)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; lca.n; i++) </div><div class="line">        lca.arc[i] = lca.adj[i];</div><div class="line">    <span class="built_in">stack</span>&lt;Node&gt; stk;</div><div class="line">    Node u;</div><div class="line">    <span class="keyword">int</span> x, y;</div><div class="line">    dist[<span class="number">0</span>] = <span class="number">0</span>, C[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">    stk.push(Node(root, <span class="number">0</span>));</div><div class="line">    <span class="keyword">while</span> (!stk.empty()) &#123;</div><div class="line">        u = stk.top(), stk.pop();</div><div class="line">        <span class="keyword">if</span> (lca.arc[u.u] != <span class="literal">NULL</span>) &#123;</div><div class="line">            y = lca.arc[u.u]-&gt;v;</div><div class="line">            lca.arc[u.u] = lca.arc[u.u]-&gt;next;</div><div class="line">            stk.push(u);</div><div class="line">            dist[y] = dist[u.u]+<span class="number">1</span>;</div><div class="line">            C[y] += C[u.u];</div><div class="line">            stk.push(Node(y, <span class="number">0</span>));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">namespace</span> mLocalStream &#123;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">readchar</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> buf[N];</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> *p = buf, *end = buf;</div><div class="line">        <span class="keyword">if</span>(p == end) &#123;</div><div class="line">            <span class="keyword">if</span>((end = buf + fread(buf, <span class="number">1</span>, N, <span class="built_in">stdin</span>)) == buf) <span class="keyword">return</span> EOF;</div><div class="line">            p = buf;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> *p++;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">ReadInt</span><span class="params">(<span class="keyword">int</span> *x)</span> </span>&#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> c, neg;</div><div class="line">        <span class="keyword">while</span>((c = readchar()) &lt; <span class="string">'-'</span>)    &#123;<span class="keyword">if</span>(c == EOF) <span class="keyword">return</span> <span class="number">0</span>;&#125;</div><div class="line">        neg = (c == <span class="string">'-'</span>) ? <span class="number">-1</span> : <span class="number">1</span>;</div><div class="line">        *x = (neg == <span class="number">1</span>) ? c-<span class="string">'0'</span> : <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>((c = readchar()) &gt;= <span class="string">'0'</span>)</div><div class="line">            *x = (*x &lt;&lt; <span class="number">3</span>) + (*x &lt;&lt; <span class="number">1</span>) + c-<span class="string">'0'</span>;</div><div class="line">        *x *= neg;</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Print</span> &#123;</span></div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">        <span class="keyword">char</span> buf[N], *p, *end;</div><div class="line">        Print() &#123;</div><div class="line">            p = buf, end = buf + N - <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">printInt</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">char</span> padding)</span> </span>&#123;</div><div class="line">            <span class="keyword">static</span> <span class="keyword">char</span> stk[<span class="number">16</span>];</div><div class="line">            <span class="keyword">int</span> idx = <span class="number">0</span>;</div><div class="line">            stk[idx++] = padding;</div><div class="line">            <span class="keyword">if</span> (!x)	</div><div class="line">                stk[idx++] = <span class="string">'0'</span>;</div><div class="line">            <span class="keyword">while</span> (x)</div><div class="line">                stk[idx++] = x%<span class="number">10</span> + <span class="string">'0'</span>, x /= <span class="number">10</span>;</div><div class="line">            <span class="keyword">while</span> (idx) &#123;</div><div class="line">                <span class="keyword">if</span> (p == end) &#123;</div><div class="line">                    *p = <span class="string">'\0'</span>;</div><div class="line">                    <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf), p = buf;</div><div class="line">                &#125;</div><div class="line">                *p = stk[--idx], p++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">online_printInt</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">            <span class="keyword">static</span> <span class="keyword">char</span> ch[<span class="number">16</span>];</div><div class="line">            <span class="keyword">static</span> <span class="keyword">int</span> idx;</div><div class="line">            idx = <span class="number">0</span>;</div><div class="line">            <span class="keyword">if</span> (x == <span class="number">0</span>)	ch[++idx] = <span class="number">0</span>;</div><div class="line">            <span class="keyword">while</span> (x &gt; <span class="number">0</span>) ch[++idx] = x % <span class="number">10</span>, x /= <span class="number">10</span>;</div><div class="line">            <span class="keyword">while</span> (idx) </div><div class="line">                <span class="built_in">putchar</span>(ch[idx--]+<span class="number">48</span>);</div><div class="line">        &#125;</div><div class="line">        ~Print() &#123;</div><div class="line">            *p = <span class="string">'\0'</span>;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf);</div><div class="line">        &#125;</div><div class="line">    &#125; bprint;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> N, Q, P, c;</div><div class="line">    mLocalStream::ReadInt(&amp;N);</div><div class="line">    lca.init(N);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; N; i++) &#123;</div><div class="line">        mLocalStream::ReadInt(&amp;P);</div><div class="line">        mLocalStream::ReadInt(&amp;c);</div><div class="line">        C[i] = c, P--;</div><div class="line">        lca.addDedge(P, i);</div><div class="line">    &#125;</div><div class="line">    mLocalStream::ReadInt(&amp;Q);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Q; i++) &#123;</div><div class="line">        mLocalStream::ReadInt(A+i);</div><div class="line">        mLocalStream::ReadInt(B+i);</div><div class="line">        A[i]--, B[i]--;</div><div class="line">        lca.addQuery(A[i], B[i], i);</div><div class="line">    &#125;</div><div class="line">    dfs(<span class="number">0</span>);</div><div class="line">    lca.offline(<span class="number">0</span>);</div><div class="line">    <span class="keyword">int</span> lazy = <span class="number">0</span>;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> d1, d2;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Q; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (A[i] == B[i] || lca.LCA[i] != A[i])</div><div class="line">            lazy++;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            d1 = dist[A[i]] + dist[B[i]] - <span class="number">2</span>*dist[lca.LCA[i]];</div><div class="line">            d2 = C[A[i]] + C[B[i]] - <span class="number">2</span>*C[lca.LCA[i]];</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, d1*lazy + d2);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/categories/解題區/page/7/">&laquo; Prev</a><a class="page-number" href="/categories/解題區/">1</a><span class="space">&hellip;</span><a class="page-number" href="/categories/解題區/page/6/">6</a><a class="page-number" href="/categories/解題區/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/categories/解題區/page/9/">9</a><a class="page-number" href="/categories/解題區/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/categories/解題區/page/64/">64</a><a class="extend next" rel="next" href="/categories/解題區/page/9/">Next &raquo;</a>
    </nav>
  
</section>
          
          
            <aside id="sidebar">
  <!-- <div id="ukagaka_panel"></div> -->
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/">學校課程</a><span class="category-list-count">115</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/介面設計/">介面設計</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/作業系統/">作業系統</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/即時系統/">即時系統</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/大學專題/">大學專題</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/巨量資料/">巨量資料</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/平行程式/">平行程式</a><span class="category-list-count">43</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/敏捷方法/">敏捷方法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/編譯器/">編譯器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/自然語言/">自然語言</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/虛擬實境/">虛擬實境</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算型智慧/">計算型智慧</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算幾何/">計算幾何</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算機圖學/">計算機圖學</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資料庫系統/">資料庫系統</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資訊安全/">資訊安全</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/通識課程/">通識課程</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/">工作應用</a><span class="category-list-count">32</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Java/">Java</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Meme/">Meme</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/可持久化/">可持久化</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/鬼故事/">鬼故事</a><span class="category-list-count">10</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/手札日記/">手札日記</a><span class="category-list-count">46</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/">網頁設計</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/About-This-Blog/">About This Blog</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/HTML5/">HTML5</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/JQuery/">JQuery</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/Markdown/">Markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/NodeJs/">NodeJs</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/">解題區</a><span class="category-list-count">633</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/Latex/">Latex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/出題解題/">出題解題</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-POJ/">解題區 - POJ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a><span class="category-list-count">483</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a><span class="category-list-count">77</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-未解題目/">解題區 - 未解題目</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/雜言筆記/">雜言筆記</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a class="text" href="/2021/06/21/diary-202106/">
              
                <i class="icon-file-o"></i> 
              
            疫情下的工作變化</a>
          </li>
        
          <li>
            <a class="text" href="/2021/06/21/work/company-ghost-story-10/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 10</a>
          </li>
        
          <li>
            <a class="text" href="/2021/05/30/diary-202105/">
              
                <i class="icon-file-o"></i> 
              
            前思後想 新居落成</a>
          </li>
        
          <li>
            <a class="text" href="/2021/05/30/java/java-memory-optimization-2/">
              
                <i class="icon-file-o"></i> 
              
            Java 優化內存使用 組合篇</a>
          </li>
        
          <li>
            <a class="text" href="/2021/05/30/java/java-memory-optimization-1/">
              
                <i class="icon-file-o"></i> 
              
            Java 優化內存使用 結構篇</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/diary-202101/">
              
                <i class="icon-file-o"></i> 
              
            二八進展</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-globl-var/">
              
                <i class="icon-file-o"></i> 
              
            Global Variable</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-file-extension/">
              
                <i class="icon-file-o"></i> 
              
            File Extension</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-handover/">
              
                <i class="icon-file-o"></i> 
              
            Handover</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-interview-recursion/">
              
                <i class="icon-file-o"></i> 
              
            Interview &amp; Recursion</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">   
      	<ul>
	      <li><a href="http://mypaper.pchome.com.tw/zerojudge" target="_blank" title="Old Blog"><i class="icon-star"></i> Morris' Blog (pchome)</a></li>
	      <li><a href="http://flere114.blogspot.tw/" target="_blank" title="蘿莉勿觸"><i class="icon-googles"></i> flere's Blog</a></li>
	      <li><a href="http://dreamoon4.blogspot.tw/" target="_blank" title="夢月"><i class="icon-googles"></i> dreamoon's Blog</a></li>
	      <li><a href="http://m80126colin.github.io" target="_blank" title="許胖們"><i class="icon-github-alt"></i> m80126colin's Blog</a></li>
	      <li><a href="http://sd12582000.blogspot.tw/" target="_blank" title="妮可妮可"><i class="icon-github-alt"></i> Nico's Blog</a></li>
	      <li><a href="http://kuoe0.logdown.com/" target="_blank" title="郭至軒大神"><i class="icon-github-alt"></i> KuoE0's Dots</a></li>
	      <li><a href="http://tyan.io/" title=""><i class="icon-github-alt"></i> Tyan Blog</a></li>
    	</ul>
    </div>
</div>

  
    
<script src="/js/jquery-ui.js"></script>
<script src="/js/ukagaka/jquery.morris.ukagaka.resource.js"></script>
<script src="/js/ukagaka/typed.js"></script>
  
  
</aside>
          
        
      </div>
      <footer id="footer">
  
  <div class="outer">    
    <div class="social-group">
      
      <a href="https://github.com/morris821028" target="_blank" title="github"><i class="icon-github"></i></a>
      
      
      <a href="https://www.facebook.com/Morris1028" target="_blank" title="facebook"><i class="icon-facebook-sign"></i></a>
      
      
      <a href="http://uhunt.felix-halim.net/id/46705" target="_blank" title="uhunt" ><span class="icon-uhunt">UVa<span></a>
      
    </div>
    <div id="footer-info" class="inner">
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/morris821028/hexo-theme-landscape" target="_blank" title="landscape">landscape</a> &copy; 2021 Shiang-Yun Yang 
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link"><i class=icon-home ></i>&nbsp&nbspHome</a>
  
    <a href="/about" class="mobile-nav-link"><i class=icon-user ></i>&nbsp&nbspAbout</a>
  
    <a href="/archives" class="mobile-nav-link"><i class=icon-archive ></i>&nbsp&nbspArchives</a>
  
    <a href="/tags" class="mobile-nav-link"><i class=icon-tags ></i>&nbsp&nbspTags</a>
  
    <a href="/picture" class="mobile-nav-link"><i class=icon-camera ></i>&nbsp&nbspPictures</a>
  
    <a href="/works" class="mobile-nav-link"><i class=icon-trophy ></i>&nbsp&nbspWorks</a>
  
</nav>
    
<script>
  var disqus_shortname = 'morris1028';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/jquery.lazyload.js"></script>
<script src="/js/jquery.als-1.6.js"></script>

<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>