<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Category: 解題區 | Morris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Morris&#39; Blog">
<meta property="og:url" content="http://morris821028.github.io/categories/解題區/page/9/index.html">
<meta property="og:site_name" content="Morris&#39; Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Morris&#39; Blog">
<link rel="publisher" href="108158678174364350000">
  
    <link rel="alternative" href="/atom.xml" title="Morris&#39; Blog" type="application/atom+xml">
  
  
    <meta name="google-site-verification" content="5mRgj8NanEMpGZuNfHNJNmH90RgNlrnJXsFlTaKD6Gs" />
  
  
    <link rel="shortcut icon" href="/img/f.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script src="/js/jquery-2.1.0.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.5.1.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdn.oesmith.co.uk/morris-0.5.1.min.js"></script>
  <link rel="import" href="/bower_components/app-layout/app-layout.html"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"><div id="banner-right"></div></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Morris&#39; Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class=icon-home title='Home'></i></a>
          
        
          
            <a class="main-nav-link" href="/about"><i class=icon-user title='About'></i></a>
          
        
          
            <a class="main-nav-link" href="/archives"><i class=icon-archive title='Archives'></i></a>
          
        
          
            <a class="main-nav-link" href="/tags"><i class=icon-tags title='Tags'></i></a>
          
        
          
            <a class="main-nav-link" href="/picture"><i class=icon-camera title='Pictures'></i></a>
          
        
          
            <a class="main-nav-link" href="/works"><i class=icon-trophy title='Works'></i></a>
          
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://morris821028.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        
          
          <section id="main">
  
    <article id="post-zj-b449" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/20/zj-b449/" class="article-date">
  <time datetime="2015-07-20T00:11:25.000Z" itemprop="datePublished">2015-07-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/20/zj-b449/">b449. 加速策略 圈出角點</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/20/zj-b449/" data-id="ckpaivca800bhn8vnclep9orf" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/20/zj-b449/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bitmask/">bitmask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化/">優化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/巨集/">巨集</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/影像處理/">影像處理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/編譯器/">編譯器</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>影像處理中，給定一張圖，準確地找到點、線、邊、角都是相當困難的，由於圖片會受到干擾、顏色屬性的差異，使得擷取特徵相當困難。</p>
<h3 id="問題描述"><a href="#問題描述" class="headerlink" title="問題描述"></a>問題描述</h3><p>對於 <span>$N \times M$</span><!-- Has MathJax --> 的像素圖片，方便起見只由黑白影像構成，0 表示暗、1 表示亮，對於每一個像素位置判斷是否可能是角點。</p>
<p>在角點偵測的算法中，有一個由 Rosten and Drummond 提出的 FAST (Features from Accelerated Segment Test)  方法。概念由一個 <span>$7 \times 7$</span><!-- Has MathJax --> 的遮罩，待測點 <span>$p$</span><!-- Has MathJax --> 位於遮罩中心，由遮罩內圈上的 16 個像素的灰階判斷 <span>$p$</span><!-- Has MathJax --> 是否為角點。遮罩樣子如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">+--------------------+  </span><br><span class="line">|  |  |16| 1| 2|  |  |  </span><br><span class="line">+--------------------+  </span><br><span class="line">|  |15|  |  |  | 3|  |  </span><br><span class="line">+--------------------+  </span><br><span class="line">|14|  |  |  |  |  | 4|  </span><br><span class="line">+--------------------+  </span><br><span class="line">|13|  |  | p|  |  | 5|  </span><br><span class="line">+--------------------+  </span><br><span class="line">|12|  |  |  |  |  | 6|  </span><br><span class="line">+--------------------+  </span><br><span class="line">|  |11|  |  |  | 7|  |  </span><br><span class="line">+--------------------+  </span><br><span class="line">|  |  |10| 9| 8|  |  |  </span><br><span class="line">+---------------------  </span><br></pre></td></tr></table></figure>

<p>只要這個圈上出現連續大於等於 12 個相同的暗像素或者是亮像素，則 <span>$p$</span><!-- Has MathJax --> 就被視為一個角點。</p>
<p>不幸地，這會造成在一個角上出現很多角點，通常會根據掃描的順序找到角點，當找到一個角點後，會抑制鄰近區域不可以是角點。此題不考慮抑制情況，對於每一個角點必須在 16 個像素在圖片上才進行判斷，圖片邊界不進行偵測。</p>
<p>輸出一個 <span>$N \times M$</span><!-- Has MathJax --> 的矩陣，按照原圖片位置，若該點是角點則為 1，反之為 0。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">7 7</span><br><span class="line">0011100</span><br><span class="line">0100010</span><br><span class="line">1000001 </span><br><span class="line">1000001 </span><br><span class="line">1000001 </span><br><span class="line">0100010</span><br><span class="line">0011100</span><br><span class="line">7 7</span><br><span class="line">0011100</span><br><span class="line">0100010</span><br><span class="line">1000001 </span><br><span class="line">0000001 </span><br><span class="line">1000001 </span><br><span class="line">0100010</span><br><span class="line">0010100</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Case #1:</span><br><span class="line">0000000</span><br><span class="line">0000000</span><br><span class="line">0000000</span><br><span class="line">0001000</span><br><span class="line">0000000</span><br><span class="line">0000000</span><br><span class="line">0000000</span><br><span class="line">Case #2:</span><br><span class="line">0000000</span><br><span class="line">0000000</span><br><span class="line">0000000</span><br><span class="line">0000000</span><br><span class="line">0000000</span><br><span class="line">0000000</span><br><span class="line">0000000</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>這一題的技巧不是演算法，而是實作的加速細節。</p>
<p>同時，來實驗老師上課說的優化策略的用處，由於要連續 12 個，根據鴿籠原理的方式，挑選位置 1, 5, 9, 13 出來，若連續三個狀態相同再進行 <span>$O(16)$</span><!-- Has MathJax --> 的判斷。然而挑出這四個位置，可以加速 50%，相較於只有 <span>$O(16)$</span><!-- Has MathJax --> 的判斷效能，可以參考下方的樸素解。</p>
<p>樸素寫法並不是最快的，因為 branch 太多，導致速度至少為 800ms，去處理一張 <span>$1920 \times 1080$</span><!-- Has MathJax --> 的影像，更好的方案是使用 bitmask，預處理在 16bits 下，連續 9 個相同狀態的位元情況，搭配 loop unrolling 的方式去撰寫，直接 <span>$O(16)$</span><!-- Has MathJax --> 判斷，為了減少代碼量，採用巨集的前處理展開。請參考 bitmask 版本。速度來到 140ms，加速幾乎 8 倍。</p>
<p>單純的 bitmask 還不是最快，直接建表 <span>$O(2^{16} \times 16)$</span><!-- Has MathJax --> 得到 16bits 是否是角點，建表消耗時間，但單一判斷變成 <span>$O(1)$</span><!-- Has MathJax -->。請參考 bitmask2 版本。速度來到 76ms，直接翻了快兩倍。</p>
<p>最終 bitmask3 版本 56ms，採用以下的方案：</p>
<ol>
<li>減少型別轉換 movz 的出現，用補數來抽換判斷。<br>意即 <code>(a&amp;mask) == 0 || (a&amp;mask) == mask)</code> 將只會有 <code>(a&amp;mask) == mask</code>，需要 <code>(a&amp;mask) == 0</code> 的判斷，則先 <code>a = ~a</code> 再進行 <code>(a&amp;mask) == mask</code>。</li>
<li>利用編譯的常數展開，減少二維陣列取址時的一次乘法。<br>意即 <code>g[x][y]</code> 取址使用時，會動用到一次乘法和一次加法，對於每一個角點偵測，動用到 16 次的乘法運算。若矩陣大小事先已知，那麼對於某一行的角點，<code>g[x]</code> 可以用一次乘法計算，接著該行所有角點偵測，只會剩下 16 次的加法。</li>
<li>建表太慢，用 <code>__builtin_popcount()</code> 提供剪枝。</li>
</ol>
<p>當然，以上變態至極的作法，倒不如樸素解直接開 <code>g++ -O3</code> 或者是 <code>g++ -Ofast</code> 來的省事，速度慢一點也是沒問題的對吧。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#pragma GCC optimize (&quot;O3&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="樸素解"><a href="#樸素解" class="headerlink" title="樸素解"></a>樸素解</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> dx[] = &#123;<span class="number">-3</span>, <span class="number">-3</span>, <span class="number">-2</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">-1</span>, <span class="number">-2</span>, <span class="number">-3</span>&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> dy[] = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">-1</span>, <span class="number">-2</span>, <span class="number">-3</span>, <span class="number">-3</span>, <span class="number">-3</span>, <span class="number">-2</span>, <span class="number">-1</span>&#125;;</span><br><span class="line"><span class="keyword">char</span> g[<span class="number">2048</span>][<span class="number">2048</span>], ret[<span class="number">2048</span>][<span class="number">2048</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FAST</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> c[<span class="number">4</span>] = &#123;g[x+dx[<span class="number">0</span>]][y+dy[<span class="number">0</span>]], g[x+dx[<span class="number">4</span>]][y+dy[<span class="number">4</span>]], </span><br><span class="line">                g[x+dx[<span class="number">8</span>]][y+dy[<span class="number">8</span>]], g[x+dx[<span class="number">12</span>]][y+dy[<span class="number">12</span>]]&#125;;</span><br><span class="line">    <span class="keyword">if</span> (c[<span class="number">0</span>] == c[<span class="number">1</span>] &amp;&amp; c[<span class="number">1</span>] == c[<span class="number">2</span>] || </span><br><span class="line">        c[<span class="number">1</span>] == c[<span class="number">2</span>] &amp;&amp; c[<span class="number">2</span>] == c[<span class="number">3</span>] ||</span><br><span class="line">        c[<span class="number">2</span>] == c[<span class="number">3</span>] &amp;&amp; c[<span class="number">3</span>] == c[<span class="number">0</span>] ||</span><br><span class="line">        c[<span class="number">3</span>] == c[<span class="number">0</span>] &amp;&amp; c[<span class="number">0</span>] == c[<span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="keyword">int</span> cc = <span class="number">-1</span>, p = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> it = <span class="number">1</span>, i = <span class="number">1</span>, j = <span class="number">0</span>; it &lt; <span class="number">16</span>; it++, i++, i = i &gt;= <span class="number">16</span> ? <span class="number">0</span> : i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (g[x+dx[i]][y+dy[i]] == g[x+dx[j]][y+dy[j]])</span><br><span class="line">                j ++, j = j &gt;= <span class="number">16</span> ? <span class="number">0</span> : j, p++;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (cc == <span class="number">-1</span>)</span><br><span class="line">                    cc = p;</span><br><span class="line">                j = i, p = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (p &gt;= <span class="number">12</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (g[x+dx[<span class="number">0</span>]][y+dy[<span class="number">0</span>]] == g[x+dx[<span class="number">15</span>]][y+dy[<span class="number">15</span>]] &amp;&amp; p+cc &gt;= <span class="number">12</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> N, M, cases = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;N, &amp;M) == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">getchar</span>() != <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">            <span class="built_in">fgets</span>(g[i], <span class="number">2000</span>, stdin);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; M; j++) &#123;</span><br><span class="line">                ret[i][j] = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">                <span class="keyword">if</span> (i<span class="number">-3</span> &gt;= <span class="number">0</span> &amp;&amp; j<span class="number">-3</span> &gt;= <span class="number">0</span> &amp;&amp; i+<span class="number">3</span> &lt; N &amp;&amp; j+<span class="number">3</span> &lt; M)</span><br><span class="line">                    ret[i][j] = <span class="built_in">FAST</span>(i, j) + <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Case #%d:\n&quot;</span>, ++cases);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            ret[i][M] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            <span class="built_in">puts</span>(ret[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="bitmask"><a href="#bitmask" class="headerlink" title="bitmask"></a>bitmask</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> dx[] = &#123;<span class="number">-3</span>, <span class="number">-3</span>, <span class="number">-2</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">-1</span>, <span class="number">-2</span>, <span class="number">-3</span>&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> dy[] = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">-1</span>, <span class="number">-2</span>, <span class="number">-3</span>, <span class="number">-3</span>, <span class="number">-3</span>, <span class="number">-2</span>, <span class="number">-1</span>&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXH = <span class="number">2048</span>, MAXW = <span class="number">2048</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = MAXH * MAXW;</span><br><span class="line"><span class="keyword">char</span> g[MAXH][MAXW], ret[MAXH*MAXW];</span><br><span class="line"><span class="keyword">int</span> n, m;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> T(x, y, z) ((g[x+dx[z]][y+dy[z]])&lt;&lt;z)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOPX(i) (val&amp;corner[i]) == 0 || (val&amp;corner[i]) == corner[i] || \</span></span><br><span class="line"><span class="meta">(val&amp;corner[i+1]) == 0 || (val&amp;corner[i+1]) == corner[i+1] || \</span></span><br><span class="line"><span class="meta">(val&amp;corner[i+2]) == 0 || (val&amp;corner[i+2]) == corner[i+2] || \</span></span><br><span class="line"><span class="meta">(val&amp;corner[i+3]) == 0 || (val&amp;corner[i+3]) == corner[i+3]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOPXALL UNLOOPX(0) || UNLOOPX(4) || UNLOOPX(8) || UNLOOPX(12)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOPY(i)  T(x, y, i) | T(x, y, i+1) | T(x, y, i+2) | T(x, y, i+3) </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOPYALL UNLOOPY(0) | UNLOOPY(4) | UNLOOPY(8) | UNLOOPY(12)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> UINT16;</span><br><span class="line">UINT16 corner[<span class="number">16</span>] = &#123;&#125;;</span><br><span class="line"><span class="function">UINT16 <span class="title">rotate_left</span><span class="params">(UINT16 x, UINT16 n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span>  (x &lt;&lt; n) | (x &gt;&gt; (<span class="number">16</span>-n));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">FAST</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">    UINT16 val = UNLOOPYALL;</span><br><span class="line">    <span class="keyword">return</span> UNLOOPXALL;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = (<span class="number">1</span>&lt;&lt;<span class="number">12</span>)<span class="number">-1</span>; i &lt; <span class="number">16</span>; i++, j = <span class="built_in">rotate_left</span>(j, <span class="number">1</span>))</span><br><span class="line">        corner[i] = j;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">int</span> cases = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">getchar</span>() != <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="built_in">fgets</span>(g[i], MAXW, stdin);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++)</span><br><span class="line">                g[i][j] -= <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> bn = n<span class="number">-3</span>, bm = m<span class="number">-3</span>;</span><br><span class="line">        <span class="keyword">char</span> *p = ret;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="built_in">memset</span>(p, <span class="string">&#x27;0&#x27;</span>, m), p += m;</span><br><span class="line">            *p = <span class="string">&#x27;\n&#x27;</span>, p++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">3</span>; i &lt; bn; i++) &#123;</span><br><span class="line">            *p = <span class="string">&#x27;0&#x27;</span>, p++;</span><br><span class="line">            *p = <span class="string">&#x27;0&#x27;</span>, p++;</span><br><span class="line">            *p = <span class="string">&#x27;0&#x27;</span>, p++;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">3</span>; j &lt; bm; j++)</span><br><span class="line">                *p = <span class="built_in">FAST</span>(i, j) + <span class="string">&#x27;0&#x27;</span>, p++;</span><br><span class="line">            *p = <span class="string">&#x27;0&#x27;</span>, p++;</span><br><span class="line">            *p = <span class="string">&#x27;0&#x27;</span>, p++;</span><br><span class="line">            *p = <span class="string">&#x27;0&#x27;</span>, p++;</span><br><span class="line">            *p = <span class="string">&#x27;\n&#x27;</span>, p++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="built_in">memset</span>(p, <span class="string">&#x27;0&#x27;</span>, m), p += m;</span><br><span class="line">            *p = <span class="string">&#x27;\n&#x27;</span>, p++;</span><br><span class="line">        &#125;</span><br><span class="line">        *p = <span class="string">&#x27;\0&#x27;</span>, p++;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Case #%d:\n&quot;</span>, ++cases);</span><br><span class="line">        <span class="built_in">puts</span>(ret);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="bitmask2"><a href="#bitmask2" class="headerlink" title="bitmask2"></a>bitmask2</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC optimize (<span class="meta-string">&quot;O3&quot;</span>)</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//const int dx[] = &#123;-3, -3, -2, -1, 0, 1, 2, 3, 3, 3, 2, 1, 0, -1, -2, -3&#125;;</span></span><br><span class="line"><span class="comment">//const int dy[] = &#123;0, 1, 2, 3, 3, 3, 2, 1, 0, -1, -2, -3, -3, -3, -2, -1&#125;;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXH = <span class="number">2048</span>, MAXW = <span class="number">2048</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = MAXH * MAXW;</span><br><span class="line"><span class="keyword">char</span> g[MAXH][MAXW], ret[MAXH*MAXW];</span><br><span class="line"><span class="keyword">int</span> n, m;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dx_00 -3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dx_01 -3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dx_02 -2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dx_03 -1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dx_40 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dx_41 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dx_42 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dx_43 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dx_80 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dx_81 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dx_82 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dx_83 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dx_120 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dx_121 -1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dx_122 -2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dx_123 -3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dy_00 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dy_01 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dy_02 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dy_03 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dy_40 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dy_41 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dy_42 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dy_43 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dy_80 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dy_81 -1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dy_82 -2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dy_83 -3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dy_120 -3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dy_121 -3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dy_122 -2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dy_123 -1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> T(x, y, z, w) ((g[x + dx_##z##w][y + dy_##z##w])&lt;&lt;(z+w)) </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOPX(i) ((val&amp;cor[i]) == cor[i] || (val&amp;cor[i+1]) == cor[i+1] || \</span></span><br><span class="line"><span class="meta"> 					(val&amp;cor[i+2]) == cor[i+2] || (val&amp;cor[i+3]) == cor[i+3]) </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOPXALL UNLOOPX(0) || UNLOOPX(4) || UNLOOPX(8) || UNLOOPX(12)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOPY(i) T(x, y, i, 0) | T(x, y, i, 1) | T(x, y, i, 2) | T(x, y, i, 3) </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOPYALL UNLOOPY(0) | UNLOOPY(4) | UNLOOPY(8) | UNLOOPY(12)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> UINT16;</span><br><span class="line">UINT16 cor[<span class="number">16</span>] = &#123;&#125;;</span><br><span class="line"><span class="function">UINT16 <span class="title">rotate_left</span><span class="params">(UINT16 x, UINT16 n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span>  (x &lt;&lt; n) | (x &gt;&gt; (<span class="number">16</span>-n));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> f[<span class="number">1</span>&lt;&lt;<span class="number">16</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UINT16 val;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = (<span class="number">1</span>&lt;&lt;<span class="number">12</span>)<span class="number">-1</span>; i &lt; <span class="number">16</span>; i++, j = <span class="built_in">rotate_left</span>(j, <span class="number">1</span>))</span><br><span class="line">        cor[i] = j;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1</span>&lt;&lt;<span class="number">16</span>; i++) &#123;</span><br><span class="line">        val = i;</span><br><span class="line">        f[i] = UNLOOPXALL ? <span class="number">1</span> : (val = ~val, UNLOOPXALL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> cases = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> c;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">getchar</span>() != <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="built_in">fgets</span>(g[i], <span class="number">2000</span>, stdin);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++)</span><br><span class="line">                g[i][j] -= <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> bn = n<span class="number">-3</span>, bm = m<span class="number">-3</span>;</span><br><span class="line">        <span class="keyword">char</span> *p = ret;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="built_in">memset</span>(p, <span class="string">&#x27;0&#x27;</span>, m), p += m;</span><br><span class="line">            *p = <span class="string">&#x27;\n&#x27;</span>, p++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">3</span>; x &lt; bn; x++) &#123;</span><br><span class="line">            *p = <span class="string">&#x27;0&#x27;</span>, p++, *p = <span class="string">&#x27;0&#x27;</span>, p++, *p = <span class="string">&#x27;0&#x27;</span>, p++;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOP &#123; \</span></span><br><span class="line"><span class="meta">	val = UNLOOPYALL; \</span></span><br><span class="line"><span class="meta">	*p = f[val] | <span class="meta-string">&#x27;0&#x27;</span>; \</span></span><br><span class="line"><span class="meta">	p++, y++; \</span></span><br><span class="line"><span class="meta">&#125; </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOP4 UNLOOP UNLOOP UNLOOP UNLOOP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOP8 &#123;UNLOOP4 UNLOOP4&#125;</span></span><br><span class="line">            <span class="keyword">int</span> y = <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">for</span> (; y+<span class="number">8</span> &lt; bm; )</span><br><span class="line">                UNLOOP8;</span><br><span class="line">            <span class="keyword">for</span> (; y &lt; bm; )</span><br><span class="line">                UNLOOP;</span><br><span class="line">            *p = <span class="string">&#x27;0&#x27;</span>, p++, *p = <span class="string">&#x27;0&#x27;</span>, p++, *p = <span class="string">&#x27;0&#x27;</span>, p++;</span><br><span class="line">            *p = <span class="string">&#x27;\n&#x27;</span>, p++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="built_in">memset</span>(p, <span class="string">&#x27;0&#x27;</span>, m), p += m;</span><br><span class="line">            *p = <span class="string">&#x27;\n&#x27;</span>, p++;</span><br><span class="line">        &#125;</span><br><span class="line">        *p = <span class="string">&#x27;\0&#x27;</span>, p++;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Case #%d:\n&quot;</span>, ++cases);</span><br><span class="line">        <span class="built_in">puts</span>(ret);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="bitmask3"><a href="#bitmask3" class="headerlink" title="bitmask3"></a>bitmask3</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC optimize (<span class="meta-string">&quot;O3&quot;</span>)</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//const int dx[] = &#123;-3, -3, -2, -1, 0, 1, 2, 3, 3, 3, 2, 1, 0, -1, -2, -3&#125;;</span></span><br><span class="line"><span class="comment">//const int dy[] = &#123;0, 1, 2, 3, 3, 3, 2, 1, 0, -1, -2, -3, -3, -3, -2, -1&#125;;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXH 2048</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXW 2048</span></span><br><span class="line"><span class="keyword">char</span> g[MAXH][MAXW], ret[MAXH*MAXW];</span><br><span class="line"><span class="keyword">char</span> *ptr_g;</span><br><span class="line"><span class="keyword">int</span> n, m;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AB00  -3*MAXW </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AB01  -3*MAXW+1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AB02  -2*MAXW+2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AB03  -MAXW+3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AB40  3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AB41  MAXW+3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AB42  2*MAXW+2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AB43  3*MAXW+1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AB80  3*MAXW</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AB81  3*MAXW-1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AB82  2*MAXW-2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AB83  MAXW-3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AB120 -3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AB121 -MAXW-3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AB122 -2*MAXW-2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AB123 -3*MAXW-1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> T(x, y, z, w) (*(ptr_g + AB##z##w)&lt;&lt;(z+w)) </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOPX(i) ((val&amp;cor[i]) == cor[i] || (val&amp;cor[i+1]) == cor[i+1] || \</span></span><br><span class="line"><span class="meta"> 					(val&amp;cor[i+2]) == cor[i+2] || (val&amp;cor[i+3]) == cor[i+3]) </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOPXALL UNLOOPX(0) || UNLOOPX(4) || UNLOOPX(8) || UNLOOPX(12)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOPY(i) T(x, y, i, 0) | T(x, y, i, 1) | T(x, y, i, 2) | T(x, y, i, 3) </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOPYALL UNLOOPY(0) | UNLOOPY(4) | UNLOOPY(8) | UNLOOPY(12)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> UINT16;</span><br><span class="line">UINT16 cor[<span class="number">16</span>] = &#123;&#125;;</span><br><span class="line"><span class="function">UINT16 <span class="title">rotate_left</span><span class="params">(UINT16 x, UINT16 n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span>  (x &lt;&lt; n) | (x &gt;&gt; (<span class="number">16</span>-n));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">char</span> f[<span class="number">1</span>&lt;&lt;<span class="number">16</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UINT16 val;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = (<span class="number">1</span>&lt;&lt;<span class="number">12</span>)<span class="number">-1</span>; i &lt; <span class="number">16</span>; i++, j = <span class="built_in">rotate_left</span>(j, <span class="number">1</span>))</span><br><span class="line">        cor[i] = j;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, one; i &lt; <span class="number">1</span>&lt;&lt;<span class="number">16</span>; i++) &#123;</span><br><span class="line">        val = i, one = __builtin_popcount(val);</span><br><span class="line">        <span class="keyword">if</span> (one &lt; <span class="number">12</span> &amp;&amp; one &gt; <span class="number">4</span>)</span><br><span class="line">            f[i] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            f[i] = UNLOOPXALL ? <span class="number">1</span> : (val = ~val, UNLOOPXALL);</span><br><span class="line">        f[i] |= <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> cases = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> c;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">getchar</span>() != <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="built_in">fgets</span>(g[i], <span class="number">2000</span>, stdin);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++)</span><br><span class="line">                g[i][j] -= <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> bn = n<span class="number">-3</span>, bm = m<span class="number">-3</span>;</span><br><span class="line">        <span class="keyword">char</span> *p = ret;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="built_in">memset</span>(p, <span class="string">&#x27;0&#x27;</span>, m), p += m;</span><br><span class="line">            *p = <span class="string">&#x27;\n&#x27;</span>, p++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">3</span>, y; x &lt; bn; x++) &#123;</span><br><span class="line">            *p = <span class="string">&#x27;0&#x27;</span>, p++, *p = <span class="string">&#x27;0&#x27;</span>, p++, *p = <span class="string">&#x27;0&#x27;</span>, p++;</span><br><span class="line">            ptr_g = g[x]+<span class="number">3</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOP &#123; \</span></span><br><span class="line"><span class="meta">	val = UNLOOPYALL; \</span></span><br><span class="line"><span class="meta">	*p = f[val]; \</span></span><br><span class="line"><span class="meta">	p++, y++, ptr_g++; \</span></span><br><span class="line"><span class="meta">&#125; </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOP4 UNLOOP UNLOOP UNLOOP UNLOOP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOP8 &#123;UNLOOP4 UNLOOP4&#125;</span></span><br><span class="line">            <span class="keyword">for</span> (y = <span class="number">3</span>; y+<span class="number">8</span> &lt; bm; )</span><br><span class="line">                UNLOOP8;</span><br><span class="line">            <span class="keyword">for</span> (; y &lt; bm; )</span><br><span class="line">                UNLOOP;</span><br><span class="line">            *p = <span class="string">&#x27;0&#x27;</span>, p++, *p = <span class="string">&#x27;0&#x27;</span>, p++, *p = <span class="string">&#x27;0&#x27;</span>, p++;</span><br><span class="line">            *p = <span class="string">&#x27;\n&#x27;</span>, p++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="built_in">memset</span>(p, <span class="string">&#x27;0&#x27;</span>, m), p += m;</span><br><span class="line">            *p = <span class="string">&#x27;\n&#x27;</span>, p++;</span><br><span class="line">        &#125;</span><br><span class="line">        *p = <span class="string">&#x27;\0&#x27;</span>, p++;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Case #%d:\n&quot;</span>, ++cases);</span><br><span class="line">        <span class="built_in">puts</span>(ret);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b446" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/15/zj-b446/" class="article-date">
  <time datetime="2015-07-15T11:39:38.000Z" itemprop="datePublished">2015-07-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/15/zj-b446/">b446. 搜索美學 史蒂芙的煩惱</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/15/zj-b446/" data-id="ckpaivca800bfn8vn0ovf9u4u" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/15/zj-b446/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CDQ-分治/">CDQ 分治</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kd-tree/">kd-tree</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/在線處理/">在線處理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/替罪羊樹/">替罪羊樹</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/樹套樹/">樹套樹</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/離線處理/">離線處理</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>動畫 遊戲人生《No Game No Life》中，史蒂芙 (Stephanie Dola) 常常被欺負，儘管她以學院第一畢業，對於遊戲一竅不通的她在這個世界常常被欺負。現在就交給你來幫幫她。</p>
<h3 id="問題描述"><a href="#問題描述" class="headerlink" title="問題描述"></a>問題描述</h3><p>兩個人輪流在一個大棋盤上下棋，每一步棋的得分根據這一步棋與最鄰近的敵方棋子的曼哈頓距離。</p>
<p>對於兩個點 <span>$p, q$</span><!-- Has MathJax --> 座標 <span>$(p_x, p_y), (q_x, q_y)$</span><!-- Has MathJax -->，曼哈頓距離 (Manhattan distance) 為 <span>$|p_x - q_x| + |p_y - q_y|$</span><!-- Has MathJax -->。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">3</span><br><span class="line">1 1</span><br><span class="line">5 5</span><br><span class="line">4 4</span><br><span class="line">3 2</span><br><span class="line">2 4</span><br><span class="line">2 3</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">8</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">3</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>把鄰近搜索問題做個總結，普遍處理的是靜態資料跟單一詢問，而在最近餐館那一題已經用 KD-tree 處理過 KNN 問題。這一題是採用動態插入和詢問以及數學性質較強的曼哈頓距離，離線處理也是個選擇。</p>
<p>此問題限制在 <span>$n = 50000$</span><!-- Has MathJax --> 的情況下，進行測試討論，除了分桶、方格法外，探討三種思路：</p>
<ul>
<li><p>Dynamic KD-tree 利用替罪羊樹的概念完成，看著卦長的代碼以及卡車口述概要，終於敲敲打打拼湊起來，掛上啟發式的搭配具有不錯的成效。空間複雜度 <span>$O(n)$</span><!-- Has MathJax -->，插入複雜度 <span>$O(\log^2 n)$</span><!-- Has MathJax -->，查詢 <span>$O(\log n)$</span><!-- Has MathJax --> (據說是在曼哈頓距離下的緣故)，速度是暴力法 <span>$O(n^2)$</span><!-- Has MathJax --> 二十倍左右。  </p>
</li>
<li><p>Segment tree + 平衡樹，空間複雜度 <span>$O(n \log n)$</span><!-- Has MathJax -->，時間複雜度 <span>$O(\log^3 n)$</span><!-- Has MathJax -->，使用座標轉換將菱形轉換成正方形，套上二分邊長去查找區域內部是否有點。由於 <span>$n$</span><!-- Has MathJax --> 的緣故，速度比 Dynamic KD-tree 慢上許多，若用暴力法 <span>$O(n^2)$</span><!-- Has MathJax --> 只快兩倍之多。實作測試提供者 liouzhou_101。  </p>
</li>
<li><p>離線處理 CDQ 分治，空間複雜度 <span>$O(n)$</span><!-- Has MathJax -->，總時間複雜度 <span>$O(n \log^2 n)$</span><!-- Has MathJax -->，採用思路為曼哈頓距離切割成四個象限進行極值查找。比暴力法快十倍所右。</p>
</li>
</ul>
<p>前兩個作法比較裸，在此特別補充 CDQ 分治，曼哈頓距離可以考慮成四個象限，詢問 <span>$(x, y)$</span><!-- Has MathJax --> 的最鄰近點，首先考慮左下角 <span>$(x&apos;, y&apos;)$</span><!-- Has MathJax -->，亦即 <span>$x&apos; \le x, \; y&apos; \le y$</span><!-- Has MathJax -->，則曼哈頓距離 <span>$dist = (x - x&apos;) + (y - y&apos;) = (x + y) - (x&apos; + y&apos;)$</span><!-- Has MathJax -->，明顯地求最近距離要讓 <span>$x&apos; + y&apos;$</span><!-- Has MathJax --> 最大化。同理其他象限。</p>
<p>為了解決這詢問，套用 CDQ 分治，按照 <span>$x$</span><!-- Has MathJax --> 座標排序，接著二分操作順序，切割操作 <span>$[l, mid], [mid+1, r]$</span><!-- Has MathJax -->，在左右兩塊仍然按照 <span>$x$</span><!-- Has MathJax --> 排序。單獨看 <span>$[mid+1, r]$</span><!-- Has MathJax --> 的操作會受 <span>$[l, mid]$</span><!-- Has MathJax --> 和自己本身影響，對於前者而言，採用歸併排序那樣，按照 <span>$x$</span><!-- Has MathJax --> 座標慢慢合併 (概念上)，合併過程套用 Binary indexed tree 進行極值查找。對於後者，就進行遞迴求解，明顯地 <span>$[l, mid]$</span><!-- Has MathJax --> 只會受 <span>$[l, mid]$</span><!-- Has MathJax --> 影響。</p>
<p>CDQ 分治的概要，按照其中一個關鍵排序，接著二分操作順序進行分置處理。國外是有論文在描述這個 Online to Offline 的算法，CDQ 命名就是人名，會給國外看笑話吧。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sort(key)</span><br><span class="line"></span><br><span class="line">solve(l, r)</span><br><span class="line">    solve(l, mid)</span><br><span class="line">    process([l, mid], [mid+1, r])</span><br><span class="line">    solve(mid+1, r)</span><br></pre></td></tr></table></figure>

<p>備註「欸欸，加上悔棋的話，是不是持久化 kd-tree」</p>
<h3 id="實作探討"><a href="#實作探討" class="headerlink" title="實作探討"></a>實作探討</h3><p>關於 kd-tree 實作細節探討，與通常會犯的錯誤，關係到速度有常數差異。</p>
<p>在 <code>closest()</code> 中，常犯的錯誤是 ** 探索順序 **，盡可能先靠近，啟發式才能更加快速，別像我打出錯誤的搜索順序如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (x.d[k] &lt;= u-&gt;pid.d[k]) &#123;    		</span><br><span class="line">    closest(u-&gt;lson, (k+1)%kD, x, h, mndist);</span><br><span class="line">    h[k] = abs(x.d[k] - u-&gt;pid.d[k]);</span><br><span class="line">    closest(u-&gt;rson, (k+1)%kD, x, h, mndist);</span><br><span class="line">    h[k] = old;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    h[k] = abs(x.d[k] - u-&gt;pid.d[k]);</span><br><span class="line">    closest(u-&gt;lson, (k+1)%kD, x, h, mndist);</span><br><span class="line">    h[k] = old;</span><br><span class="line">    closest(u-&gt;rson, (k+1)%kD, x, h, mndist);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>實作的順序應該如下，別總是先探訪左子樹、在去探訪右子樹，kd-tree 必須注意順序。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (x.d[k] &lt;= u-&gt;pid.d[k]) &#123;    		</span><br><span class="line">    closest(u-&gt;lson, (k+1)%kD, x, h, mndist);</span><br><span class="line">    h[k] = abs(x.d[k] - u-&gt;pid.d[k]);</span><br><span class="line">    closest(u-&gt;rson, (k+1)%kD, x, h, mndist);</span><br><span class="line">    h[k] = old;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    closest(u-&gt;rson, (k+1)%kD, x, h, mndist);</span><br><span class="line">    h[k] = abs(x.d[k] - u-&gt;pid.d[k]);</span><br><span class="line">    closest(u-&gt;lson, (k+1)%kD, x, h, mndist);</span><br><span class="line">    h[k] = old;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假設資料大小 <code>sizeof(dim_element)</code> 很大，通常會利用指針陣列來進行排序，這樣可以降低搬運大型資料複製時間，但奇怪的是由於指針陣列佔有一定空間，索引資料時又會佔據一段空間，估計是快取方面出了點問題 (或者是我寫不好)，導致直接搬運資料是來得比較快速，這個修改在 b348. 最近餐館 也有進行測試，速度有提升。</p>
<p>接著可以藉由函數參數少量，來拉快程式在堆疊參數所需要的時間，在節點內部宣告採用維度 <code>d</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct Node &#123;</span><br><span class="line">    Node *lson, *rson;</span><br><span class="line">    Point pid; </span><br><span class="line">    int size, d;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>這個修改造成詢問時，不僅僅在走訪傳遞參數少了一個，還少 <code>k+1</code> 的計算。測試結果中，光靠這一點速度沒有明顯提升。kd tree 還有一個靠臉吃飯的邊界分割，要是相同時分左分右，這一點是最痛苦的，在此就不去討論，當然可以利用隨機擾動來解決這問題。</p>
<p>至於要使用 <code>sort()</code> 進行 <span>$O(n \log n)$</span><!-- Has MathJax -->、還是使用 <code>nth_element()</code> 的 <span>$O(n)$</span><!-- Has MathJax --> 找到中位數，根據兩題的測試，由於 <span>$n$</span><!-- Has MathJax --> 都不大，照理來講 <code>nth_element()</code> 快於 <code>sort()</code>，但根據實際測試於 liouzhou_101 的代碼，<code>sort()</code> 的速度會比較快，其一是運氣、其二是未知情況。就從以下代碼中，差異並不明顯。</p>
<h3 id="Dynamic-Kd-tree"><a href="#Dynamic-Kd-tree" class="headerlink" title="Dynamic Kd tree"></a>Dynamic Kd tree</h3><p>沒有提供垃圾回收，靠內存持運作，要是 RE 就放大一點。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">131072</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXM = <span class="number">50005</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXD = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> INF = INT_MAX;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> ALPHA = <span class="number">0.75</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> LOG_ALPHA = <span class="built_in">log2</span>(<span class="number">1.0</span> / ALPHA);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KD_TREE</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Point</span> &#123;</span></span><br><span class="line">    	<span class="keyword">static</span> <span class="keyword">int</span> kD;</span><br><span class="line">        <span class="keyword">int</span> d[MAXD], pid;</span><br><span class="line">        <span class="function"><span class="keyword">int</span> <span class="title">dist</span><span class="params">(Point &amp;x)</span> </span>&#123;</span><br><span class="line">        	<span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; kD; i++)</span><br><span class="line">        		ret += <span class="built_in">abs</span>(d[i] - x.d[i]);</span><br><span class="line">        	<span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> id = <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">        	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; kD; i++)</span><br><span class="line">        		<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;d[i]);</span><br><span class="line">        	pid = id;</span><br><span class="line">        &#125;    	</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">int</span> sortIdx;</span><br><span class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Point &amp;x) <span class="keyword">const</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> d[sortIdx] &lt; x.d[sortIdx];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">        Node *lson, *rson;</span><br><span class="line">        Point pid; </span><br><span class="line">        <span class="keyword">int</span> size;</span><br><span class="line">        <span class="built_in">Node</span>() &#123;</span><br><span class="line">        	lson = rson = <span class="literal">NULL</span>;</span><br><span class="line">        	size = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        	size = <span class="number">1</span>;</span><br><span class="line">        	<span class="keyword">if</span> (lson)	size += lson-&gt;size;</span><br><span class="line">        	<span class="keyword">if</span> (rson)	size += rson-&gt;size;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; nodes[MAXN];</span><br><span class="line">    Node *root;</span><br><span class="line">    Point A[MAXM];</span><br><span class="line">    <span class="keyword">int</span> bufsize, size, kD;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> kd)</span> </span>&#123;</span><br><span class="line">    	size = bufsize = <span class="number">0</span>;</span><br><span class="line">    	root = <span class="literal">NULL</span>;</span><br><span class="line">    	Point::sortIdx = <span class="number">0</span>;</span><br><span class="line">        Point::kD = kD = kd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(Point x)</span> </span>&#123;</span><br><span class="line">    	<span class="built_in">insert</span>(root, <span class="number">0</span>, x, <span class="built_in">log2int</span>(size) / LOG_ALPHA);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">closest</span><span class="params">(Point x)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">int</span> mndist = INF, h[MAXD] = &#123;&#125;;</span><br><span class="line">    	<span class="built_in">closest</span>(root, <span class="number">0</span>, x, h, mndist);</span><br><span class="line">    	<span class="keyword">return</span> mndist;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">log2int</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> __builtin_clz((<span class="keyword">int</span>)<span class="number">1</span>)-__builtin_clz(x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">isbad</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">if</span> (u-&gt;lson &amp;&amp; u-&gt;lson-&gt;size &gt; u-&gt;size * ALPHA)</span><br><span class="line">    		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    	<span class="keyword">if</span> (u-&gt;rson &amp;&amp; u-&gt;rson-&gt;size &gt; u-&gt;size * ALPHA)</span><br><span class="line">    		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">    	Node *ret = &amp;nodes[bufsize++];</span><br><span class="line">    	*ret = <span class="built_in">Node</span>();</span><br><span class="line">    	<span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">build</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">if</span> (l &gt; r)	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    	<span class="keyword">if</span> (k == kD)	k = <span class="number">0</span>;</span><br><span class="line">    	Node *ret = <span class="built_in">newNode</span>();</span><br><span class="line">    	<span class="keyword">int</span> mid = (l + r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">    	Point::sortIdx = k;</span><br><span class="line">    	<span class="built_in">sort</span>(A+l, A+r+<span class="number">1</span>);</span><br><span class="line">    	ret-&gt;pid = A[mid];</span><br><span class="line">        ret-&gt;lson = <span class="built_in">build</span>(k+<span class="number">1</span>, l, mid<span class="number">-1</span>);</span><br><span class="line">        ret-&gt;rson = <span class="built_in">build</span>(k+<span class="number">1</span>, mid+<span class="number">1</span>, r);</span><br><span class="line">    	ret-&gt;<span class="built_in">update</span>();</span><br><span class="line">    	<span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">flatten</span><span class="params">(Node *u, Point* &amp;buf)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">if</span> (u == <span class="literal">NULL</span>)	<span class="keyword">return</span> ;</span><br><span class="line">    	<span class="built_in">flatten</span>(u-&gt;lson, buf);</span><br><span class="line">    	*buf = u-&gt;pid, buf++;</span><br><span class="line">    	<span class="built_in">flatten</span>(u-&gt;rson, buf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">insert</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> k, Point &amp;x, <span class="keyword">int</span> dep)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">if</span> (u == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    		u = <span class="built_in">newNode</span>(), u-&gt;pid = x;</span><br><span class="line">    		<span class="keyword">return</span> dep &lt;= <span class="number">0</span>;</span><br><span class="line">    	&#125;</span><br><span class="line">    	u-&gt;size++;</span><br><span class="line">    	<span class="keyword">int</span> t = <span class="number">0</span>;</span><br><span class="line">    	<span class="keyword">if</span> (x.d[k] &lt;= u-&gt;pid.d[k])</span><br><span class="line">    		t = <span class="built_in">insert</span>(u-&gt;lson, (k+<span class="number">1</span>)%kD, x, dep<span class="number">-1</span>);</span><br><span class="line">    	<span class="keyword">else</span></span><br><span class="line">    		t = <span class="built_in">insert</span>(u-&gt;rson, (k+<span class="number">1</span>)%kD, x, dep<span class="number">-1</span>);</span><br><span class="line">    	<span class="keyword">if</span> (t &amp;&amp; !<span class="built_in">isbad</span>(u))</span><br><span class="line">    		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    	<span class="keyword">if</span> (t) &#123;</span><br><span class="line">    		Point *ptr = &amp;A[<span class="number">0</span>];</span><br><span class="line">    		<span class="built_in">flatten</span>(u, ptr);</span><br><span class="line">    		u = <span class="built_in">build</span>(k, <span class="number">0</span>, u-&gt;size<span class="number">-1</span>);</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">heuristic</span><span class="params">(<span class="keyword">int</span> h[])</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; kD; i++)</span><br><span class="line">    		ret += h[i];</span><br><span class="line">    	<span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">closest</span><span class="params">(Node *u, <span class="keyword">int</span> k, Point &amp;x, <span class="keyword">int</span> h[], <span class="keyword">int</span> &amp;mndist)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">if</span> (u == <span class="literal">NULL</span> || <span class="built_in">heuristic</span>(h) &gt;= mndist)</span><br><span class="line">    		<span class="keyword">return</span> ;</span><br><span class="line">    	<span class="keyword">int</span> dist = u-&gt;pid.<span class="built_in">dist</span>(x), old;</span><br><span class="line">    	mndist = <span class="built_in">min</span>(mndist, dist), old = h[k];</span><br><span class="line">    	<span class="keyword">if</span> (x.d[k] &lt;= u-&gt;pid.d[k]) &#123;    		</span><br><span class="line">            <span class="built_in">closest</span>(u-&gt;lson, (k+<span class="number">1</span>)%kD, x, h, mndist);</span><br><span class="line">            h[k] = <span class="built_in">abs</span>(x.d[k] - u-&gt;pid.d[k]);</span><br><span class="line">            <span class="built_in">closest</span>(u-&gt;rson, (k+<span class="number">1</span>)%kD, x, h, mndist);</span><br><span class="line">            h[k] = old;</span><br><span class="line">    	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    		<span class="built_in">closest</span>(u-&gt;rson, (k+<span class="number">1</span>)%kD, x, h, mndist);</span><br><span class="line">            h[k] = <span class="built_in">abs</span>(x.d[k] - u-&gt;pid.d[k]);</span><br><span class="line">            <span class="built_in">closest</span>(u-&gt;lson, (k+<span class="number">1</span>)%kD, x, h, mndist);</span><br><span class="line">            h[k] = old;</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; A, B;</span><br><span class="line"><span class="keyword">int</span> KD_TREE::Point::sortIdx = <span class="number">0</span>, KD_TREE::Point::kD = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> N;</span><br><span class="line">    KD_TREE::Point pt;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;N) == <span class="number">1</span>) &#123;</span><br><span class="line">        A.<span class="built_in">init</span>(<span class="number">2</span>), B.<span class="built_in">init</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            pt.<span class="built_in">read</span>(i);</span><br><span class="line">            <span class="keyword">if</span> (i)	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, B.<span class="built_in">closest</span>(pt));</span><br><span class="line">            A.<span class="built_in">insert</span>(pt);</span><br><span class="line">            pt.<span class="built_in">read</span>(i);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, A.<span class="built_in">closest</span>(pt));</span><br><span class="line">            B.<span class="built_in">insert</span>(pt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="CDQ-分治"><a href="#CDQ-分治" class="headerlink" title="CDQ 分治"></a>CDQ 分治</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;bits/stdc++.h&gt;</span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">const int MAXQ = 131072;</span><br><span class="line">const int MAXN = 40000;</span><br><span class="line">const int INF = INT_MAX;</span><br><span class="line">class Offline &#123;</span><br><span class="line">public:</span><br><span class="line">    struct Point &#123;</span><br><span class="line">        int x, y;</span><br><span class="line">        Point(int a = 0, int b = 0):</span><br><span class="line">            x(a), y(b) &#123;&#125;</span><br><span class="line">        bool operator&lt;(const Point &amp;a) const &#123;</span><br><span class="line">            return x &lt; a.x || (x == a.x &amp;&amp; y &lt; a.y);</span><br><span class="line">        &#125;</span><br><span class="line">        void read() &#123;</span><br><span class="line">            scanf(&quot;%d %d&quot;, &amp;x, &amp;y);</span><br><span class="line">            x++, y++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    struct Event &#123;</span><br><span class="line">        Point p;</span><br><span class="line">        int qtype, qid;</span><br><span class="line">        Event(int a = 0, int b = 0, Point c = Point()):</span><br><span class="line">            qtype(a), qid(b), p(c) &#123;&#125;</span><br><span class="line">        bool operator&lt;(const Event &amp;e) const &#123;</span><br><span class="line">            if (p.x != e.p.x)	return p.x &lt; e.p.x;</span><br><span class="line">            return qid &lt; e.qid;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    vector&lt;Event&gt; event;</span><br><span class="line">    int ret[MAXQ], N;</span><br><span class="line">    void init(int n) &#123;</span><br><span class="line">        event.clear();</span><br><span class="line">        N = n; </span><br><span class="line">    &#125;</span><br><span class="line">    void addEvent(int qtype, int qid, Point x) &#123;</span><br><span class="line">        event.push_back(Event(qtype, qid, x));</span><br><span class="line">    &#125;</span><br><span class="line">    void run() &#123;</span><br><span class="line">        for (int i = 0; i &lt; event.size(); i++)</span><br><span class="line">            ret[i] = 0x3f3f3f3f;		</span><br><span class="line">        cases = 0;</span><br><span class="line">        for (int i = 0; i &lt;= N; i++)</span><br><span class="line">            used[i] = 0;		</span><br><span class="line">        sort(event.begin(), event.end());</span><br><span class="line">        CDQ(0, event.size()-1);</span><br><span class="line">    &#125;</span><br><span class="line">private:</span><br><span class="line">    Event ebuf[MAXQ];</span><br><span class="line">    int BIT[MAXN], used[MAXN];</span><br><span class="line">    int cases = 0;</span><br><span class="line">    void modify(int x, int val, int dir) &#123;</span><br><span class="line">        for (; x &amp;&amp; x &lt;= N; x += (x&amp;(-x)) * dir) &#123;</span><br><span class="line">            if (used[x] != cases)</span><br><span class="line">                BIT[x] = -0x3f3f3f3f, used[x] = cases;</span><br><span class="line">            BIT[x] = max(BIT[x], val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    int query(int x, int dir) &#123;</span><br><span class="line">        int ret = -0x3f3f3f3f;</span><br><span class="line">        for (; x &amp;&amp; x &lt;= N; x += (x&amp;(-x)) * dir) &#123;</span><br><span class="line">            if (used[x] == cases)</span><br><span class="line">                ret = max(ret, BIT[x]);</span><br><span class="line">        &#125;</span><br><span class="line">        return ret;</span><br><span class="line">    &#125;</span><br><span class="line">    void merge(int l, int mid, int r) &#123;</span><br><span class="line">        cases++;</span><br><span class="line">        for (int i = mid+1, j = l; i &lt;= r; i++) &#123;</span><br><span class="line">            if (event[i].qtype == 0) &#123;</span><br><span class="line">                for (; j &lt;= mid &amp;&amp; event[j].p.x &lt;= event[i].p.x; j++) &#123;</span><br><span class="line">                    if (event[j].qtype == 1) </span><br><span class="line">                        modify(event[j].p.y, event[j].p.x+event[j].p.y, 1);</span><br><span class="line">                &#125; </span><br><span class="line">                ret[event[i].qid] = min(ret[event[i].qid], event[i].p.x+event[i].p.y-query(event[i].p.y, -1));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cases++;</span><br><span class="line">        for (int i = mid+1, j = l; i &lt;= r; i++) &#123;</span><br><span class="line">            if (event[i].qtype == 0) &#123;</span><br><span class="line">                for (; j &lt;= mid &amp;&amp; event[j].p.x &lt;= event[i].p.x; j++) &#123;</span><br><span class="line">                    if (event[j].qtype == 1)</span><br><span class="line">                        modify(event[j].p.y, event[j].p.x-event[j].p.y, -1);</span><br><span class="line">                &#125; </span><br><span class="line">                ret[event[i].qid] = min(ret[event[i].qid], event[i].p.x-event[i].p.y-query(event[i].p.y, 1));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cases++;</span><br><span class="line">        for (int i = r, j = mid; i &gt; mid; i--) &#123;</span><br><span class="line">            if (event[i].qtype == 0) &#123;</span><br><span class="line">                for (; j &gt;= l &amp;&amp; event[j].p.x &gt;= event[i].p.x; j--) &#123;</span><br><span class="line">                    if (event[j].qtype == 1) </span><br><span class="line">                        modify(event[j].p.y, event[j].p.y-event[j].p.x, 1);</span><br><span class="line">                &#125; </span><br><span class="line">                ret[event[i].qid] = min(ret[event[i].qid], event[i].p.y-event[i].p.x-query(event[i].p.y, -1));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cases++;</span><br><span class="line">        for (int i = r, j = mid; i &gt; mid; i--) &#123;</span><br><span class="line">            if (event[i].qtype == 0) &#123;</span><br><span class="line">                for (; j &gt;= l &amp;&amp; event[j].p.x &gt;= event[i].p.x; j--) &#123;</span><br><span class="line">                    if (event[j].qtype == 1) </span><br><span class="line">                        modify(event[j].p.y, -event[j].p.x-event[j].p.y, -1);</span><br><span class="line">                &#125; </span><br><span class="line">                ret[event[i].qid] = min(ret[event[i].qid], -event[i].p.x-event[i].p.y-query(event[i].p.y, 1));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    void CDQ(int l, int r) &#123;</span><br><span class="line">        if (l == r)</span><br><span class="line">            return ;</span><br><span class="line">        int mid = (l + r)/2, lidx, ridx;</span><br><span class="line">        lidx = l, ridx = mid+1;</span><br><span class="line">        for (int i = l; i &lt;= r; i++) &#123;</span><br><span class="line">            if (event[i].qid &lt;= mid)</span><br><span class="line">                ebuf[lidx++] = event[i];</span><br><span class="line">            else</span><br><span class="line">                ebuf[ridx++] = event[i];</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i = l; i &lt;= r; i++)</span><br><span class="line">            event[i] = ebuf[i];</span><br><span class="line">            </span><br><span class="line">        CDQ(l, mid);</span><br><span class="line">        merge(l, mid, r);</span><br><span class="line">        CDQ(mid+1, r);</span><br><span class="line">        </span><br><span class="line">        lidx = l, ridx = mid+1;</span><br><span class="line">        for (int i = l; i &lt;= r; i++) &#123;</span><br><span class="line">            if ((lidx &lt;= mid &amp;&amp; event[lidx] &lt; event[ridx]) || ridx &gt; r)</span><br><span class="line">                ebuf[i]	= event[lidx++];</span><br><span class="line">            else</span><br><span class="line">                ebuf[i] = event[ridx++];</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i = l; i &lt;= r; i++)</span><br><span class="line">            event[i] = ebuf[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125; A, B;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    int N;</span><br><span class="line">    Offline::Point pt;</span><br><span class="line">    while (scanf(&quot;%d&quot;, &amp;N) == 1) &#123;</span><br><span class="line">        A.init(65536), B.init(65536);</span><br><span class="line">        int max_y = 0;</span><br><span class="line">        for (int i = 0; i &lt; N; i++) &#123;</span><br><span class="line">            pt.read(), max_y = max(max_y, pt.y);</span><br><span class="line">            B.addEvent(0, 2*i, pt);</span><br><span class="line">            A.addEvent(1, 2*i, pt);</span><br><span class="line">            pt.read(), max_y = max(max_y, pt.y);</span><br><span class="line">            A.addEvent(0, 2*i+1, pt);</span><br><span class="line">            B.addEvent(1, 2*i+1, pt);</span><br><span class="line">        &#125;</span><br><span class="line">        A.N = B.N = max_y;	// y in [1, max_y]</span><br><span class="line">        A.run(), B.run();</span><br><span class="line">        for (int i = 0; i &lt; N; i++) &#123;</span><br><span class="line">            if (i)	printf(&quot;%d\n&quot;, B.ret[2*i]);</span><br><span class="line">            printf(&quot;%d\n&quot;, A.ret[2*i+1]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b443" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/15/zj-b443/" class="article-date">
  <time datetime="2015-07-15T07:35:28.000Z" itemprop="datePublished">2015-07-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/15/zj-b443/">b443. 我愛 Fibonacci</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/15/zj-b443/" data-id="ckpaivca700bdn8vn1kl6ewnj" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/15/zj-b443/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/miller-rabin/">miller-rabin</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pollard-rho/">pollard-rho</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/二次剩餘/">二次剩餘</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/分治/">分治</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/判斷質數/">判斷質數</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/數論基礎/">數論基礎</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/模乘法/">模乘法</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/生成因數/">生成因數</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/矩陣/">矩陣</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/規律/">規律</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><span>$$F_n=\begin{cases}
n, &amp; n=0,1 \\
F_{n-1}+F_{n-2}, &amp; n \geq 2
\end{cases}$$</span><!-- Has MathJax -->

<p>求出<span>$F_{2^n} \mod m$</span><!-- Has MathJax --> 的結果。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">3</span><br><span class="line">1 1000000007</span><br><span class="line">2 1000000007</span><br><span class="line">3 1000000007</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">3</span><br><span class="line">21</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>一般的矩陣計算，利用 <span>$M^n$</span><!-- Has MathJax --> 求出<span>$F_n$</span><!-- Has MathJax -->，其中</p>
<span>$$M = \begin{bmatrix}
1 &amp; 1\\ 
1 &amp; 0 
\end{bmatrix}$$</span><!-- Has MathJax -->

<p>如果是求<span>$F_n$</span><!-- Has MathJax --> 時間複雜度 <span>$O(\log n)$</span><!-- Has MathJax -->，而這一題求的是<span>$F_{2^n}$</span><!-- Has MathJax -->，時間複雜度 <span>$O(n)$</span><!-- Has MathJax -->。</p>
<p>為了加速運算，目標是要找到 <span>$\mod p$</span><!-- Has MathJax --> 下的循環長度 <span>$L$</span><!-- Has MathJax -->，最後求出<span>$F_{2^n \mod L}$</span><!-- Has MathJax -->，根據待會的證明，保證 <span>$L \le p$</span><!-- Has MathJax -->，那複雜度就可以回到 <span>$O(\log L)$</span><!-- Has MathJax --> 解決。但為了要找到 <span>$L$</span><!-- Has MathJax --> 又是一段很長的故事，總時間複雜度為 <span>$O(\sqrt{p})$</span><!-- Has MathJax -->，不用保證 <span>$p$</span><!-- Has MathJax --> 是質數。</p>
<h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><ul>
<li><a href="http://wenku.baidu.com/view/20ce902e2af90242a895e5c1">《HDOJ3977 Evil teacher 斐波拉契数列模 p 循环节》</a></li>
</ul>
<h3 id="故事"><a href="#故事" class="headerlink" title="故事"></a>故事</h3><p>數列<span>$F_0 = 1, F_1 = 1, F_2 = 2, \cdots$</span><!-- Has MathJax -->，循環是連續兩項出現重複，而費氏數列會完全循環，也就是出現連續兩項<span>$F_i = 0, F_{i-1} = 1$</span><!-- Has MathJax -->。下方是一個 <span>$\mod 4$</span><!-- Has MathJax --> 的情況。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 1 2 3 1 0 | 1 2 3 1 0 | ...</span><br></pre></td></tr></table></figure>

<p>要找到恰好連續兩項<span>$F_i = 0, F_{i-1} = 1$</span><!-- Has MathJax --> 是困難的，考慮去找到<span>$F_i = 0$</span><!-- Has MathJax --> 即可，接著再去想辦法讓<span>$F_{i-1} = 1$</span><!-- Has MathJax -->。</p>
<p>假設最小的 <span>$k$</span><!-- Has MathJax --> 滿足<span>$F_k = 0 \mod p$</span><!-- Has MathJax -->，而<span>$F_{k-1} = a \mod p$</span><!-- Has MathJax -->，那麼之後的序列<span>$F_{i} = a^j F_{i+j \times k} \mod p$</span><!-- Has MathJax -->。從矩陣乘法的概念中可以理解，是一個常數為 <span>$a$</span><!-- Has MathJax --> 的初始項，第二輪循環常數就會變成 <span>$a^2$</span><!-- Has MathJax -->，類推。</p>
<p>接下來</p>
<ul>
<li>考慮一個嚴重的問題「** 何種模 <span>$p$</span><!-- Has MathJax --> 情況一定循環，即從<span>$F_0$</span><!-- Has MathJax --> 再次循環。 **」答案是 ** 質數 <span>$p$</span><!-- Has MathJax --> **。<br>原因是<span>$F_{i} = a^j F_{i+j \times k} \mod p$</span><!-- Has MathJax -->，由於 <span>$a$</span><!-- Has MathJax --> 與 <span>$p$</span><!-- Has MathJax --> 互質，<span>$a^j \mod p \neq 0$</span><!-- Has MathJax --> 恆成立，同時還是一個 <span>$ord_{p}(a) = p-1$</span><!-- Has MathJax -->，這部分從歐拉定理中可以了解，那麼只有可能在<span>$F_{i} = 0$</span><!-- Has MathJax --> 的情況成立，就是 <span>$k$</span><!-- Has MathJax --> 的倍數之外，不發生<span>$F_i = 0$</span><!-- Has MathJax --> 的出現。</li>
<li>接續上一個問題「模 <span>$p$</span><!-- Has MathJax --> 不是質數怎麼處理？」<br>進行質因數分解，對於每一個質因子找到模循環長度，模 <span>$p$</span><!-- Has MathJax --> 循環長度就是所有質因子循環長度的最小公倍數 lcm。</li>
</ul>
<p>現在問題落在 <span>$k$</span><!-- Has MathJax --> 怎麼找到，若能找到 <span>$k$</span><!-- Has MathJax -->，其循環長度落在 <span>$k$</span><!-- Has MathJax --> 的倍數，或者有更好的獲取方式。</p>
<ul>
<li>若模質數 <span>$p$</span><!-- Has MathJax --> 且滿足 <span>$p &gt; 5$</span><!-- Has MathJax -->，5 是 <span>$p$</span><!-- Has MathJax --> 的二次剩餘 (quadratic residue)，意即滿足 <span>$\exists \; x^2 \equiv 5 \mod p$</span><!-- Has MathJax -->，循環長度為 <span>$p-1$</span><!-- Has MathJax --> 的因數。反之，循環長度是 <span>$2(p+1)$</span><!-- Has MathJax --> 的因數。</li>
</ul>
<p>關於二次剩餘的判斷，在模質數 <span>$p$</span><!-- Has MathJax --> 下，對於 <span>$gcd(x, p) = 1$</span><!-- Has MathJax -->，藉由歐拉定理得到 <span>$x^{p-1} \equiv 1 \mod p$</span><!-- Has MathJax -->，以下不保證是正確的說法，提供理解的一個方案。</p>
<ul>
<li>若 <span>$d$</span><!-- Has MathJax --> 是 <span>$p$</span><!-- Has MathJax --> 的二次剩餘，則滿足 <span>$d^{(p-1)/2} \equiv 1 \mod p$</span><!-- Has MathJax -->，因為<span>$x^{2 \times (p-1)/2} \equiv 1 \mod p \Rightarrow  x^{p-1} \equiv 1 \mod p$</span><!-- Has MathJax -->。</li>
<li>若非二次剩餘，則滿足 <span>$d^{(p-1)/2} \equiv -1 \mod p$</span><!-- Has MathJax -->，因為 <span>$\left [ d^{(p-1)/2} \right ]^2 \equiv 1 \mod p \Rightarrow d^{p-1} \equiv 1 \mod p$</span><!-- Has MathJax --></li>
<li>數學上用 Legendre symbol 來表示這個判斷 <a href="https://en.wikipedia.org/wiki/Legendre_symbol">wiki</a>。</li>
</ul>
<p>回過頭來，看一下費氏數列的公式解</p>
<span>$F_n = \frac{1}{\sqrt{5}} \left [ \left ( \frac{1+\sqrt{5}}{2} \right )^n - \left (\frac{1-\sqrt{5}}{2} \right )^n \right ]$</span><!-- Has MathJax -->

<p>藉由展開公式，儘管它是實數、根號，展開之後一定只會剩下整數冪次的總和。令 <span>$a = \sqrt{5}$</span><!-- Has MathJax -->，觀察二次剩餘與否和滿足<span>$F_n = 0$</span><!-- Has MathJax --> 的關係。</p>
<p>在模質數 <span>$p$</span><!-- Has MathJax --> 下，滿足二次剩餘<span>$F_n \equiv 0 \mod p$</span><!-- Has MathJax -->，當 <span>$n = p-1$</span><!-- Has MathJax --> 的時候成立，可以藉由噁心的展開式得到。同理在非二次剩餘情況，<span>$n = 2(p+1)$</span><!-- Has MathJax -->，找到一個最大的倍數情況，答案一定落在其因數下。詳細推導請看參考資料，太噁心就不提。</p>
<p>參考資料中有特別提到，有一個地方還 ** 沒有確認 **，對於模數 <span>$p^k$</span><!-- Has MathJax --> 的循環長度 <span>$g(p) \times p^{k-1}$</span><!-- Has MathJax --> 如何證明。但我想根據中國餘式定理，能了解循環長度倍數的模關係吧。接著由於大整數分解期望是 <span>$O(\sqrt{n})$</span><!-- Has MathJax -->，中間也要找到所有因數來得到循環長度的驗證，還要搭配快速矩陣乘法，最後也是 <span>$O(\sqrt{n})$</span><!-- Has MathJax -->。</p>
<p>這一題是更進階的費氏數列計算，從建表、矩陣乘法，最後來到循環搜尋，這些證明不久之後就會忘記了，二次剩餘判斷的想法還會留著，其他就忘得一乾二淨吧。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MILLER_BABIN 4</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> UINT64;</span><br><span class="line"><span class="function">UINT64 <span class="title">mul</span><span class="params">(UINT64 a, UINT64 b, UINT64 mod)</span> </span>&#123; </span><br><span class="line">    UINT64 ret = <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">for</span> (a = a &gt;= mod ? a%mod : a, b = b &gt;= mod ? b%mod : b; b != <span class="number">0</span>; b&gt;&gt;=<span class="number">1</span>, a &lt;&lt;= <span class="number">1</span>, a = a &gt;= mod ? a - mod : a) &#123; </span><br><span class="line">        <span class="keyword">if</span> (b&amp;<span class="number">1</span>) &#123;</span><br><span class="line">            ret += a;</span><br><span class="line">            <span class="keyword">if</span> (ret &gt;= mod) </span><br><span class="line">                ret -= mod;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> ret; </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Matrix</span> &#123;</span></span><br><span class="line">    UINT64 v[<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> row, col; <span class="comment">// row x col</span></span><br><span class="line">    <span class="built_in">Matrix</span>(<span class="keyword">int</span> n, <span class="keyword">int</span> m, <span class="keyword">int</span> a = <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(v, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(v));</span><br><span class="line">        row = n, col = m;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row &amp;&amp; i &lt; col; i++)</span><br><span class="line">            v[i][i] = a;</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="function">Matrix <span class="title">multiply</span><span class="params">(<span class="keyword">const</span> Matrix&amp; x, <span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> mod)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="function">Matrix <span class="title">ret</span><span class="params">(row, x.col)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; col; k++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!v[i][k])</span><br><span class="line">                	<span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; x.col; j++) &#123;</span><br><span class="line">                    ret.v[i][j] += <span class="built_in">mul</span>(v[i][k], x.v[k][j], mod);</span><br><span class="line">                    <span class="keyword">if</span> (ret.v[i][j] &gt;= mod)</span><br><span class="line">                    	ret.v[i][j] -= mod;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Matrix <span class="title">pow</span><span class="params">(<span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span>&amp; n, <span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> mod)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="function">Matrix <span class="title">ret</span><span class="params">(row, col, <span class="number">1</span>)</span>, x </span>= *<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> y = n;</span><br><span class="line">        <span class="keyword">while</span>(y) &#123;</span><br><span class="line">            <span class="keyword">if</span>(y&amp;<span class="number">1</span>)	ret = ret.<span class="built_in">multiply</span>(x, mod);</span><br><span class="line">            y = y&gt;&gt;<span class="number">1</span>, x = x.<span class="built_in">multiply</span>(x, mod);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="built_in">FibA</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXL (50000&gt;&gt;5)+1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GET(x) (mark[x&gt;&gt;5]&gt;&gt;(x&amp;31)&amp;1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SET(x) (mark[x&gt;&gt;5] |= 1&lt;&lt;(x&amp;31))</span></span><br><span class="line"><span class="keyword">int</span> mark[MAXL], P[<span class="number">50000</span>], Pt = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sieve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">int</span> i, j, k;</span><br><span class="line">    <span class="built_in">SET</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">46340</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">GET</span>(i)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (k = n/i, j = i*k; k &gt;= i; k--, j -= i)</span><br><span class="line">                <span class="built_in">SET</span>(j);</span><br><span class="line">            P[Pt++] = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UINT64 <span class="title">mpow</span><span class="params">(UINT64 x, UINT64 y, UINT64 mod)</span> </span>&#123; <span class="comment">// mod &lt; 2^32 </span></span><br><span class="line">    UINT64 ret = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (y) &#123;</span><br><span class="line">        <span class="keyword">if</span> (y&amp;<span class="number">1</span>) </span><br><span class="line">            ret = (ret * x)%mod;</span><br><span class="line">        y &gt;&gt;= <span class="number">1</span>, x = (x * x)%mod;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret % mod;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">UINT64 <span class="title">mpow2</span><span class="params">(UINT64 x, UINT64 y, UINT64 mod)</span> </span>&#123;</span><br><span class="line">    UINT64 ret = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (y) &#123;</span><br><span class="line">        <span class="keyword">if</span> (y&amp;<span class="number">1</span>)</span><br><span class="line">            ret = <span class="built_in">mul</span>(ret, x, mod);</span><br><span class="line">        y &gt;&gt;= <span class="number">1</span>, x = <span class="built_in">mul</span>(x, x, mod);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exgcd</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> x, <span class="keyword">long</span> <span class="keyword">long</span> y, <span class="keyword">long</span> <span class="keyword">long</span> &amp;g, <span class="keyword">long</span> <span class="keyword">long</span> &amp;a, <span class="keyword">long</span> <span class="keyword">long</span> &amp;b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (y == <span class="number">0</span>)</span><br><span class="line">        g = x, a = <span class="number">1</span>, b = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">exgcd</span>(y, x%y, g, b, a), b -= (x/y) * a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">llgcd</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> x, <span class="keyword">long</span> <span class="keyword">long</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">0</span>)    x = -x;</span><br><span class="line">    <span class="keyword">if</span> (y &lt; <span class="number">0</span>)    y = -y;</span><br><span class="line">    <span class="keyword">if</span> (!x || !y)    <span class="keyword">return</span> x + y;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> t;</span><br><span class="line">    <span class="keyword">while</span> (x%y)</span><br><span class="line">        t = x, x = y, y = t%y;</span><br><span class="line">    <span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">inverse</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> x, <span class="keyword">long</span> <span class="keyword">long</span> p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> g, b, r;</span><br><span class="line">    <span class="built_in">exgcd</span>(x, p, g, r, b);</span><br><span class="line">    <span class="keyword">if</span> (g &lt; <span class="number">0</span>)	r = -r;</span><br><span class="line">    <span class="keyword">return</span> (r%p + p)%p;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">isPrime</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> p)</span> </span>&#123; <span class="comment">// implements by miller-babin</span></span><br><span class="line">    <span class="keyword">if</span> (p &lt; <span class="number">2</span> || !(p&amp;<span class="number">1</span>))	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="number">2</span>)				<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> q = p<span class="number">-1</span>, a, t;</span><br><span class="line">    <span class="keyword">int</span> k = <span class="number">0</span>, b = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (!(q&amp;<span class="number">1</span>))	q &gt;&gt;= <span class="number">1</span>, k++;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> it = <span class="number">0</span>; it &lt; MILLER_BABIN; it++) &#123;</span><br><span class="line">        a = <span class="built_in">rand</span>()%(p<span class="number">-4</span>) + <span class="number">2</span>;</span><br><span class="line">        t = <span class="built_in">mpow2</span>(a, q, p);</span><br><span class="line">        b = (t == <span class="number">1</span>) || (t == p<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; k &amp;&amp; !b; i++) &#123;</span><br><span class="line">            t = <span class="built_in">mul</span>(t, t, p);</span><br><span class="line">            <span class="keyword">if</span> (t == p<span class="number">-1</span>)</span><br><span class="line">                b = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (b == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">pollard_rho</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> n, <span class="keyword">long</span> <span class="keyword">long</span> c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> x = <span class="number">2</span>, y = <span class="number">2</span>, i = <span class="number">1</span>, k = <span class="number">2</span>, d;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        x = (<span class="built_in">mul</span>(x, x, n) + c);</span><br><span class="line">        <span class="keyword">if</span> (x &gt;= n)	x -= n;</span><br><span class="line">        d = <span class="built_in">llgcd</span>(x - y, n);</span><br><span class="line">        <span class="keyword">if</span> (d &gt; <span class="number">1</span>) <span class="keyword">return</span> d;</span><br><span class="line">        <span class="keyword">if</span> (++i == k) y = x, k &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">factorize</span><span class="params">(<span class="keyword">int</span> n, vector&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt; &amp;f)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Pt &amp;&amp; P[i]*P[i] &lt;= n; i++) &#123;</span><br><span class="line">    	<span class="keyword">if</span> (n%P[i] == <span class="number">0</span>) &#123;</span><br><span class="line">    		<span class="keyword">while</span> (n%P[i] == <span class="number">0</span>)</span><br><span class="line">    			f.<span class="built_in">push_back</span>(P[i]), n /= P[i];</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n != <span class="number">1</span>)	f.<span class="built_in">push_back</span>(n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">llfactorize</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> n, vector&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt; &amp;f)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">1</span>)	</span><br><span class="line">        <span class="keyword">return</span> ;	</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">1e+9</span>) &#123;</span><br><span class="line">        <span class="built_in">factorize</span>(n, f);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isPrime</span>(n)) &#123;</span><br><span class="line">        f.<span class="built_in">push_back</span>(n);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> d = n;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; d == n; i++)</span><br><span class="line">        d = <span class="built_in">pollard_rho</span>(n, i);</span><br><span class="line">    <span class="built_in">llfactorize</span>(d, f);</span><br><span class="line">    <span class="built_in">llfactorize</span>(n/d, f);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// above largest factor</span></span><br><span class="line"><span class="comment">// ---------------------- //</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">legendre_symbol</span><span class="params">(UINT64 d, UINT64 p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (d%p == <span class="number">0</span>)	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">mpow2</span>(d, (p<span class="number">-1</span>)&gt;&gt;<span class="number">1</span>, p) == <span class="number">1</span> ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">factor_gen</span><span class="params">(<span class="keyword">int</span> idx, <span class="keyword">long</span> <span class="keyword">long</span> x, vector&lt; pair&lt;<span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">int</span>&gt; &gt; &amp;f, vector&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt; &amp;ret)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (idx == f.<span class="built_in">size</span>()) &#123;</span><br><span class="line">        ret.<span class="built_in">push_back</span>(x);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">long</span> <span class="keyword">long</span> i = <span class="number">0</span>, a = <span class="number">1</span>; i &lt;= f[idx].second; i++, a *= f[idx].first)</span><br><span class="line">        <span class="built_in">factor_gen</span>(idx+<span class="number">1</span>, x*a, f, ret);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">factor_gen</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> n, vector&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt; &amp;ret)</span> </span>&#123;</span><br><span class="line">    vector&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt; f;</span><br><span class="line">    vector&lt; pair&lt;<span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">int</span>&gt; &gt; f2;</span><br><span class="line">    <span class="built_in">llfactorize</span>(n, f);</span><br><span class="line">    <span class="built_in">sort</span>(f.<span class="built_in">begin</span>(), f.<span class="built_in">end</span>());</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= f.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == f.<span class="built_in">size</span>() || f[i] != f[i<span class="number">-1</span>])</span><br><span class="line">            f2.<span class="built_in">push_back</span>(<span class="built_in">make_pair</span>(f[i<span class="number">-1</span>], cnt)), cnt = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            cnt ++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">factor_gen</span>(<span class="number">0</span>, <span class="number">1</span>, f2, ret);</span><br><span class="line">    <span class="built_in">sort</span>(ret.<span class="built_in">begin</span>(), ret.<span class="built_in">end</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">UINT64 <span class="title">cycleInFib</span><span class="params">(UINT64 p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="number">2</span>)	<span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="number">3</span>)	<span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="number">5</span>)	<span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line">    vector&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt; f;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">legendre_symbol</span>(<span class="number">5</span>, p) == <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">factor_gen</span>(p<span class="number">-1</span>, f);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">factor_gen</span>(<span class="number">2</span>*(p+<span class="number">1</span>), f);</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> f1, f2;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; f.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        Matrix t = FibA.<span class="built_in">pow</span>(f[i]<span class="number">-1</span>, p);</span><br><span class="line">        f1 = (t.v[<span class="number">0</span>][<span class="number">0</span>] + t.v[<span class="number">0</span>][<span class="number">1</span>])%p;</span><br><span class="line">        f2 = (t.v[<span class="number">1</span>][<span class="number">0</span>] + t.v[<span class="number">1</span>][<span class="number">1</span>])%p;</span><br><span class="line">        <span class="keyword">if</span> (f1 == <span class="number">1</span> &amp;&amp; f2 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> f[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">UINT64 <span class="title">cycleInFib</span><span class="params">(UINT64 p, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    UINT64 s = <span class="built_in">cycleInFib</span>(p);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; k; i++)</span><br><span class="line">        s = s * p;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">sieve</span>();</span><br><span class="line">    FibA.v[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span>, FibA.v[<span class="number">0</span>][<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    FibA.v[<span class="number">1</span>][<span class="number">0</span>] = <span class="number">1</span>, FibA.v[<span class="number">1</span>][<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> testcase;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;testcase);</span><br><span class="line">    <span class="keyword">while</span> (testcase--) &#123;</span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> n, m;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%lld %lld&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">        </span><br><span class="line">        vector&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt; f;</span><br><span class="line">        map&lt;<span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">int</span>&gt; r;</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">llfactorize</span>(m, f);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;x : f)</span><br><span class="line">            r[x]++;</span><br><span class="line">            </span><br><span class="line">        UINT64 cycle = <span class="number">1</span>; </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;x : r) &#123;</span><br><span class="line">            UINT64 t = <span class="built_in">cycleInFib</span>(x.first, x.second);</span><br><span class="line">            cycle = cycle / <span class="built_in">llgcd</span>(t, cycle) * t;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        n = <span class="built_in">mpow2</span>(<span class="number">2</span>, n, cycle);</span><br><span class="line">        Matrix t = FibA.<span class="built_in">pow</span>(n, m);</span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> fn = t.v[<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>, fn);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b444" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/13/zj-b444/" class="article-date">
  <time datetime="2015-07-12T22:40:23.000Z" itemprop="datePublished">2015-07-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/13/zj-b444/">b444. 期望試驗 快速冪次</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/13/zj-b444/" data-id="ckpaivca800ben8vnhdwkc3ca" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/13/zj-b444/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/密碼基礎/">密碼基礎</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>曾經某 M 被期望值坑，就只是在計算 <span>$x^y \mod z$</span><!-- Has MathJax --> 時偷偷替換成 <span>$x^{y-1} \times x \mod z$</span><!-- Has MathJax -->，結果得到 Time Limit Exceeded。</p>
<p>根據分析 <span>$y = 16$</span><!-- Has MathJax --> 時，用二進制表示為<span>$(10000)_{2}$</span><!-- Has MathJax -->，若變成 <span>$y = 15$</span><!-- Has MathJax -->，就會變成<span>$(01111)_{2}$</span><!-- Has MathJax -->，通常快速求冪的乘法次數與二進制的 1 個數成正比，所以速度就慢非常多。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">typedef unsigned long long UINT64;</span><br><span class="line">UINT64 mul(UINT64 a, UINT64 b, UINT64 mod) &#123; </span><br><span class="line">    UINT64 ret = 0; </span><br><span class="line">    for (a = a &gt;= mod ? a%mod : a, b = b &gt;= mod ? b%mod : b; b != 0; b&gt;&gt;=1, a &lt;&lt;= 1, a = a &gt;= mod ? a - mod : a) &#123; </span><br><span class="line">        if (b&amp;1) &#123;</span><br><span class="line">            ret += a;</span><br><span class="line">            if (ret &gt;= mod) </span><br><span class="line">                ret -= mod;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    return ret; </span><br><span class="line">&#125;</span><br><span class="line">UINT64 mpow(UINT64 x, UINT64 y, UINT64 mod) &#123;</span><br><span class="line">    UINT64 ret = 1;</span><br><span class="line">    while (y) &#123;</span><br><span class="line">        if (y&amp;1)</span><br><span class="line">            ret = mul(ret, x, mod);</span><br><span class="line">        y &gt;&gt;= 1, x = mul(x, x, mod);</span><br><span class="line">    &#125;</span><br><span class="line">    return ret;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="問題描述"><a href="#問題描述" class="headerlink" title="問題描述"></a>問題描述</h3><p>讓我們來一場 <span>$x^y \mod z$</span><!-- Has MathJax --> 的期望值試驗吧，基礎目標是減少乘法次數。</p>
<p>其中 <span>$1 \le x, z \le 10^{18}$</span><!-- Has MathJax -->, <span>$0 \le y \le 2^{2^{20}}$</span><!-- Has MathJax -->，在這場試驗中展現你的優化吧。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">5 01 7</span><br><span class="line">5 10 7</span><br><span class="line">5 0101 7</span><br><span class="line">3 0110 7</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">5</span><br><span class="line">4</span><br><span class="line">3</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>詳細可以參考《資訊安全 - 近代加密 快速冪次計算》那一篇。</p>
<table>
<thead>
<tr>
<th>Algorithm</th>
<th>Table Size</th>
<th>#squaring</th>
<th>Average #Multiplication</th>
</tr>
</thead>
<tbody><tr>
<td>Right-To-Left</td>
<td>1: <span>$x^{2^i}$</span><!-- Has MathJax --></td>
<td><span>$n$</span><!-- Has MathJax --></td>
<td><span>$n/2$</span><!-- Has MathJax --></td>
</tr>
<tr>
<td>Left-To-Right</td>
<td>1: <span>$x$</span><!-- Has MathJax --></td>
<td><span>$n$</span><!-- Has MathJax --></td>
<td><span>$n/2$</span><!-- Has MathJax --></td>
</tr>
<tr>
<td>Left-To-Right(2-bits)</td>
<td>3: <span>$x$</span><!-- Has MathJax -->, <span>$x^2$</span><!-- Has MathJax -->, <span>$x^3$</span><!-- Has MathJax --></td>
<td><span>$n$</span><!-- Has MathJax --></td>
<td><span>$3n/8$</span><!-- Has MathJax --></td>
</tr>
<tr>
<td>Left-To-Right(sliding)</td>
<td>2: <span>$x$</span><!-- Has MathJax -->, <span>$x^3$</span><!-- Has MathJax --></td>
<td><span>$n$</span><!-- Has MathJax --></td>
<td><span>$n/3$</span><!-- Has MathJax --></td>
</tr>
</tbody></table>
<p>減少乘法次數，但以上期望乘法次數是跟 1 的個數有關，雖然最好是從 <span>$n/2$</span><!-- Has MathJax --> 降到 <span>$n/3$</span><!-- Has MathJax -->，並不表示速度會真的快上 <span>$1.5$</span><!-- Has MathJax --> 倍左右，畢竟還有所謂的基礎乘法次數需求，根據實驗下來大約能快個 10% 到 20% 之間，加上 <code>-Ofast</code> 編譯此時的差異又會再少一點，看起來實作方法影響很嚴重。</p>
<p>例如在不加編譯優化參數下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if a[i] == 0 &amp;&amp; a[i+1] == 0</span><br><span class="line">else if a[i] == 0 &amp;&amp; a[i+1] == 1</span><br><span class="line">else if a[i] == 1 &amp;&amp; a[i+1] == 0</span><br><span class="line">else </span><br></pre></td></tr></table></figure>

<p>上述做法會比下述來得快上許多</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if a[i] == 0</span><br><span class="line">    if a[i+1] == 0</span><br><span class="line">    else</span><br><span class="line">else</span><br><span class="line">    if a[i+1] == 0</span><br><span class="line">    else</span><br></pre></td></tr></table></figure>

<p>最後，產出一個 cheat 版本，使用 L-to-R-2bits 的概念下去擴充，使用 loop unrolling 進行加速，由於會發生不被整除的問題，小測資就靠 L-to-R-sliding 的方案去解決。</p>
<p>在 zerojudge 主機上平台上，隨機測資下的運作情況如下：</p>
<table>
<thead>
<tr>
<th>Algorithm</th>
<th>Time</th>
</tr>
</thead>
<tbody><tr>
<td>Right-To-Left</td>
<td>5.4s</td>
</tr>
<tr>
<td>Left-To-Right(2-bits)</td>
<td>4.9s</td>
</tr>
<tr>
<td>Left-To-Right(sliding)</td>
<td>4.8s</td>
</tr>
<tr>
<td>Left-To-Right-sliding-cheat</td>
<td>4.2s</td>
</tr>
</tbody></table>
<h3 id="R-to-L"><a href="#R-to-L" class="headerlink" title="R-to-L"></a>R-to-L</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> UINT64;</span><br><span class="line"><span class="function">UINT64 <span class="title">mul</span><span class="params">(UINT64 a, UINT64 b, UINT64 mod)</span> </span>&#123; </span><br><span class="line">    UINT64 ret = <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">for</span> (a = a &gt;= mod ? a%mod : a, b = b &gt;= mod ? b%mod : b; b != <span class="number">0</span>; b&gt;&gt;=<span class="number">1</span>, a &lt;&lt;= <span class="number">1</span>, a = a &gt;= mod ? a - mod : a) &#123; </span><br><span class="line">        <span class="keyword">if</span> (b&amp;<span class="number">1</span>) &#123;</span><br><span class="line">            ret += a;</span><br><span class="line">            <span class="keyword">if</span> (ret &gt;= mod) </span><br><span class="line">                ret -= mod;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> ret; </span><br><span class="line">&#125;</span><br><span class="line"><span class="function">UINT64 <span class="title">mpowR2L</span><span class="params">(UINT64 x, <span class="keyword">char</span> y[], UINT64 z)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">1</span>; y[n]; n &lt;&lt;= <span class="number">1</span>);</span><br><span class="line">    UINT64 ret = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = n<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (y[i] == <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">            ret = <span class="built_in">mul</span>(ret, x, z);</span><br><span class="line">        x = <span class="built_in">mul</span>(x, x, z);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">char</span> y[(<span class="number">1</span>&lt;&lt;<span class="number">20</span>) + <span class="number">5</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> x, z;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%lld %s %lld&quot;</span>, &amp;x, y, &amp;z) == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%llu\n&quot;</span>, <span class="built_in">mpowR2L</span>(x, y, z));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="L-to-R-2bits"><a href="#L-to-R-2bits" class="headerlink" title="L-to-R-2bits"></a>L-to-R-2bits</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> UINT64;</span><br><span class="line"><span class="function">UINT64 <span class="title">mul</span><span class="params">(UINT64 a, UINT64 b, UINT64 mod)</span> </span>&#123; </span><br><span class="line">    UINT64 ret = <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">for</span> (a = a &gt;= mod ? a%mod : a, b = b &gt;= mod ? b%mod : b; b != <span class="number">0</span>; b&gt;&gt;=<span class="number">1</span>, a &lt;&lt;= <span class="number">1</span>, a = a &gt;= mod ? a - mod : a) &#123; </span><br><span class="line">        <span class="keyword">if</span> (b&amp;<span class="number">1</span>) &#123;</span><br><span class="line">            ret += a;</span><br><span class="line">            <span class="keyword">if</span> (ret &gt;= mod) </span><br><span class="line">                ret -= mod;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> ret; </span><br><span class="line">&#125;</span><br><span class="line"><span class="function">UINT64 <span class="title">mpowL2R2</span><span class="params">(UINT64 x, <span class="keyword">char</span> y[], UINT64 z)</span> </span>&#123;</span><br><span class="line">    UINT64 x2 = <span class="built_in">mul</span>(x, x, z);</span><br><span class="line">    UINT64 x3 = <span class="built_in">mul</span>(x2, x, z);</span><br><span class="line">    UINT64 ret = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; y[i]; i += <span class="number">2</span>) &#123;</span><br><span class="line">        ret = <span class="built_in">mul</span>(ret, ret, z);</span><br><span class="line">        ret = <span class="built_in">mul</span>(ret, ret, z);</span><br><span class="line">        <span class="keyword">if</span> (y[i] == <span class="string">&#x27;1&#x27;</span> &amp;&amp; y[i+<span class="number">1</span>] == <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">            ret = <span class="built_in">mul</span>(ret, x3, z);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (y[i] == <span class="string">&#x27;1&#x27;</span> &amp;&amp; y[i+<span class="number">1</span>] == <span class="string">&#x27;0&#x27;</span>) &#123;</span><br><span class="line">            ret = <span class="built_in">mul</span>(ret, x2, z); </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (y[i+<span class="number">1</span>] == <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">            ret = <span class="built_in">mul</span>(ret, x, z);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">char</span> y[(<span class="number">1</span>&lt;&lt;<span class="number">20</span>) + <span class="number">5</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> x, z;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%lld %s %lld&quot;</span>, &amp;x, y, &amp;z) == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%llu\n&quot;</span>, <span class="built_in">mpowL2R2</span>(x, y, z));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="L-to-R-sliding"><a href="#L-to-R-sliding" class="headerlink" title="L-to-R-sliding"></a>L-to-R-sliding</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> UINT64;</span><br><span class="line"><span class="function">UINT64 <span class="title">mul</span><span class="params">(UINT64 a, UINT64 b, UINT64 mod)</span> </span>&#123; </span><br><span class="line">    UINT64 ret = <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">for</span> (a = a &gt;= mod ? a%mod : a, b = b &gt;= mod ? b%mod : b; b != <span class="number">0</span>; b&gt;&gt;=<span class="number">1</span>, a &lt;&lt;= <span class="number">1</span>, a = a &gt;= mod ? a - mod : a) &#123; </span><br><span class="line">        <span class="keyword">if</span> (b&amp;<span class="number">1</span>) &#123;</span><br><span class="line">            ret += a;</span><br><span class="line">            <span class="keyword">if</span> (ret &gt;= mod) </span><br><span class="line">                ret -= mod;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> ret; </span><br><span class="line">&#125;</span><br><span class="line"><span class="function">UINT64 <span class="title">mpowL2RS</span><span class="params">(UINT64 x, <span class="keyword">char</span> y[], UINT64 z)</span> </span>&#123;</span><br><span class="line">    UINT64 x3 = <span class="built_in">mul</span>(<span class="built_in">mul</span>(x, x, z), x, z);</span><br><span class="line">    UINT64 ret = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; y[i]; ) &#123;</span><br><span class="line">        ret = <span class="built_in">mul</span>(ret, ret, z);</span><br><span class="line">        <span class="keyword">if</span> (y[i] == <span class="string">&#x27;1&#x27;</span> &amp;&amp; y[i+<span class="number">1</span>] == <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">            ret = <span class="built_in">mul</span>(ret, ret, z);</span><br><span class="line">            ret = <span class="built_in">mul</span>(ret, x3, z);</span><br><span class="line">            i += <span class="number">2</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (y[i] == <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">            ret = <span class="built_in">mul</span>(ret, x, z);</span><br><span class="line">            i ++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (y[i+<span class="number">1</span>] == <span class="string">&#x27;0&#x27;</span>) &#123;</span><br><span class="line">            ret = <span class="built_in">mul</span>(ret, ret, z);</span><br><span class="line">            i += <span class="number">2</span>; </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">char</span> y[(<span class="number">1</span>&lt;&lt;<span class="number">20</span>) + <span class="number">5</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> x, z;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%lld %s %lld&quot;</span>, &amp;x, y, &amp;z) == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%llu\n&quot;</span>, <span class="built_in">mpowL2RS</span>(x, y, z));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="L-to-R-sliding-cheat"><a href="#L-to-R-sliding-cheat" class="headerlink" title="L-to-R-sliding-cheat"></a>L-to-R-sliding-cheat</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> UINT64;</span><br><span class="line"><span class="function">UINT64 <span class="title">mul</span><span class="params">(UINT64 a, UINT64 b, UINT64 mod)</span> </span>&#123; </span><br><span class="line">    UINT64 ret = <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">for</span> (a = a &gt;= mod ? a%mod : a, b = b &gt;= mod ? b%mod : b; b != <span class="number">0</span>; b&gt;&gt;=<span class="number">1</span>, a &lt;&lt;= <span class="number">1</span>, a = a &gt;= mod ? a - mod : a) &#123; </span><br><span class="line">        <span class="keyword">if</span> (b&amp;<span class="number">1</span>) &#123;</span><br><span class="line">            ret += a;</span><br><span class="line">            <span class="keyword">if</span> (ret &gt;= mod) </span><br><span class="line">                ret -= mod;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> ret; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UINT64 <span class="title">mpowL2RS</span><span class="params">(UINT64 x, <span class="keyword">char</span> y[], UINT64 z)</span> </span>&#123;</span><br><span class="line">    UINT64 x3 = <span class="built_in">mul</span>(<span class="built_in">mul</span>(x, x, z), x, z);</span><br><span class="line">    UINT64 ret = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; y[i]; ) &#123;</span><br><span class="line">        ret = <span class="built_in">mul</span>(ret, ret, z);</span><br><span class="line">        <span class="keyword">if</span> (y[i] == <span class="string">&#x27;1&#x27;</span> &amp;&amp; y[i+<span class="number">1</span>] == <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">            ret = <span class="built_in">mul</span>(ret, ret, z);</span><br><span class="line">            ret = <span class="built_in">mul</span>(ret, x3, z);</span><br><span class="line">            i += <span class="number">2</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (y[i] == <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">            ret = <span class="built_in">mul</span>(ret, x, z);</span><br><span class="line">            i ++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (y[i+<span class="number">1</span>] == <span class="string">&#x27;0&#x27;</span>) &#123;</span><br><span class="line">            ret = <span class="built_in">mul</span>(ret, ret, z);</span><br><span class="line">            i += <span class="number">2</span>; </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PREPROC 8</span></span><br><span class="line"><span class="function">UINT64 <span class="title">mpowCHEAT</span><span class="params">(UINT64 x, <span class="keyword">char</span> y[], UINT64 z)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">1</span>; y[n]; n &lt;&lt;= <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">1</span>&lt;&lt;PREPROC)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">mpowL2RS</span>(x, y, z);</span><br><span class="line">    UINT64 X[<span class="number">1</span>&lt;&lt;PREPROC] = &#123;<span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; (<span class="number">1</span>&lt;&lt;PREPROC); i++)</span><br><span class="line">        X[i] = <span class="built_in">mul</span>(X[i<span class="number">-1</span>], x, z);</span><br><span class="line">    UINT64 ret = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, v; y[i]; i += PREPROC) &#123;</span><br><span class="line">        ret = <span class="built_in">mul</span>(ret, ret, z);</span><br><span class="line">        ret = <span class="built_in">mul</span>(ret, ret, z);</span><br><span class="line">        ret = <span class="built_in">mul</span>(ret, ret, z);</span><br><span class="line">        ret = <span class="built_in">mul</span>(ret, ret, z);</span><br><span class="line">        ret = <span class="built_in">mul</span>(ret, ret, z);</span><br><span class="line">        ret = <span class="built_in">mul</span>(ret, ret, z);</span><br><span class="line">        ret = <span class="built_in">mul</span>(ret, ret, z);</span><br><span class="line">        ret = <span class="built_in">mul</span>(ret, ret, z);</span><br><span class="line">        v = (y[i]-<span class="string">&#x27;0&#x27;</span>)&lt;&lt;<span class="number">7</span>|(y[i+<span class="number">1</span>]-<span class="string">&#x27;0&#x27;</span>)&lt;&lt;<span class="number">6</span>|(y[i+<span class="number">2</span>]-<span class="string">&#x27;0&#x27;</span>)&lt;&lt;<span class="number">5</span>|(y[i+<span class="number">3</span>]-<span class="string">&#x27;0&#x27;</span>)&lt;&lt;<span class="number">4</span>|(y[i+<span class="number">4</span>]-<span class="string">&#x27;0&#x27;</span>)&lt;&lt;<span class="number">3</span>|(y[i+<span class="number">5</span>]-<span class="string">&#x27;0&#x27;</span>)&lt;&lt;<span class="number">2</span>|(y[i+<span class="number">6</span>]-<span class="string">&#x27;0&#x27;</span>)&lt;&lt;<span class="number">1</span>|(y[i+<span class="number">7</span>]-<span class="string">&#x27;0&#x27;</span>); </span><br><span class="line">        ret = <span class="built_in">mul</span>(ret, X[v], z);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">char</span> y[(<span class="number">1</span>&lt;&lt;<span class="number">20</span>) + <span class="number">5</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> x, z;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%lld %s %lld&quot;</span>, &amp;x, y, &amp;z) == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%llu\n&quot;</span>, <span class="built_in">mpowCHEAT</span>(x, y, z));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b440" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/12/zj-b440/" class="article-date">
  <time datetime="2015-07-12T07:53:49.000Z" itemprop="datePublished">2015-07-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/12/zj-b440/">b440. 互質對</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/12/zj-b440/" data-id="ckpaivca700ban8vn2seae816" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/12/zj-b440/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/分塊/">分塊</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/數論基礎/">數論基礎</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/莫比烏斯反演/">莫比烏斯反演</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>給定 <span>$n$</span><!-- Has MathJax --> 和 <span>$m$</span><!-- Has MathJax -->，請你統計有序對 <span>$(a,b)$</span><!-- Has MathJax --> 的個數，其中 <span>$1 \le a \le n, 1 \le b \le m$</span><!-- Has MathJax --> 且 <span>$a$</span><!-- Has MathJax --> 與 <span>$b$</span><!-- Has MathJax --> 互質。</p>
<span>$a$</span><!-- Has MathJax --> 與 <span>$b$</span><!-- Has MathJax --> 互質的定義是：<span>$a$</span><!-- Has MathJax --> 與 <span>$b$</span><!-- Has MathJax --> 的最大公約數等於 <span>$1$</span><!-- Has MathJax -->。

<blockquote>
<p>count coprime pair</p>
</blockquote>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2</span><br><span class="line">3 4</span><br><span class="line">10000000 10000000</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">9</span><br><span class="line">60792712854483</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>柳柳州出數論基礎－「莫比烏斯反演 (Möbius inversion formula)」</p>
<p>之前放棄看完的內容又要撿回來看，百般痛苦，之前沒看懂啊。但能知道的是莫比烏斯反演類似排容原理，就像錯排依樣。先不管莫比烏斯，看到「線性時間求出所有乘法反元素」真的可以嗎？那也是件很有趣的事情。</p>
<h3 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h3><ul>
<li>莫比烏斯參考《線性篩法與積性函數》－賈志鵬 <a href="http://wenku.baidu.com/view/542961fdba0d4a7302763ad5.html">link</a></li>
<li>分塊優化參考《POI XIV Stage.1 Queries Zap 解题报告》－Kwc Oliver <a href="http://wenku.baidu.com/view/fbe263d384254b35eefd34eb.html">link</a></li>
</ul>
<h3 id="基礎定義"><a href="#基礎定義" class="headerlink" title="基礎定義"></a>基礎定義</h3><p>了解莫比烏斯反演之前，要先介紹積性函數</p>
<h4 id="積性函數"><a href="#積性函數" class="headerlink" title="積性函數"></a>積性函數</h4><ul>
<li>何謂積性函數 (Multiplicative function)？<br>對於定義域 <span>$\mathbb{N}^+$</span><!-- Has MathJax --> 的函數 <span>$f$</span><!-- Has MathJax --> 而言，任兩個互質的 <span>$gcd(a, b) = 1$</span><!-- Has MathJax --> 正整數 <span>$a, b$</span><!-- Has MathJax --> 滿足 <span>$f(ab) = f(a)f(b)$</span><!-- Has MathJax -->。</li>
<li>何謂完全積性函數？  <span>$f$</span><!-- Has MathJax --> 是一個積性函數，同時滿足 <span>$f(p^n) = f(p)^n$</span><!-- Has MathJax -->。</li>
<li>若 <span>$f(n), g(n)$</span><!-- Has MathJax --> 是積性函數，則 <span>$h(n) = f(n) g(n)$</span><!-- Has MathJax --> 也是積性函數。</li>
<li>若 <span>$f(n)$</span><!-- Has MathJax --> 為積性函數，則函數 <span>$g(n) = \sum_{d|n} f(d)$</span><!-- Has MathJax --> 也是積性函數。</li>
</ul>
<h4 id="歐拉函數"><a href="#歐拉函數" class="headerlink" title="歐拉函數"></a>歐拉函數</h4><p>回顧歐拉函數 (Euler’s totient function) <span>$\phi$</span><!-- Has MathJax --></p>
<ul>
<li><p>定義 <span>$\phi(n)$</span><!-- Has MathJax --> 為 <span>$1 \cdots n$</span><!-- Has MathJax --> 中與 <span>$n$</span><!-- Has MathJax --> 互質的個數。</p>
</li>
<li><span>$\phi(n)$</span><!-- Has MathJax --> 是一個積性函數，但不是完全積性函數。根據中國餘數定理 或者 基本算術可以證明之。</li>
<li><p>歐拉定理 <span>$a^{\phi(n)} \equiv 1 \mod n, \text{ when } gcd(a, n) = 1$</span><!-- Has MathJax -->。</p>
</li>
<li><p>特性 1：<span>$\sum_{d|n} \phi(d) = n$</span><!-- Has MathJax -->。當作把互質個數 <span>$\phi(n)$</span><!-- Has MathJax --> 相加不互質個數 <span>$s$</span><!-- Has MathJax -->，由於 <span>$d$</span><!-- Has MathJax --> 是 <span>$n$</span><!-- Has MathJax --> 的因數，則與 <span>$d$</span><!-- Has MathJax --> 互質 <span>$x$</span><!-- Has MathJax --> 個數 <span>$\phi(d)$</span><!-- Has MathJax -->，把那些 <span>$x&apos; = x \times d/n$</span><!-- Has MathJax --> 就會補上那些不互質的個數 <span>$s = |set(x&apos;)|$</span><!-- Has MathJax -->。</p>
</li>
<li><p>特性 2：<span>$1 \cdots n$</span><!-- Has MathJax --> 與 <span>$n$</span><!-- Has MathJax --> 互質的數和為 <span>$n\phi(n)/2$</span><!-- Has MathJax -->。原因很簡單，若 <span>$gcd(x, n) = 1$</span><!-- Has MathJax -->，則會滿足 <span>$gcd(n-x, n) = 1$</span><!-- Has MathJax -->，看起來就是一個對稱總和。</p>
</li>
</ul>
<h4 id="莫比烏斯"><a href="#莫比烏斯" class="headerlink" title="莫比烏斯"></a>莫比烏斯</h4><p>根據積性函數的性質，我們得到莫比烏斯反演的基礎：</p>
<p>莫比烏斯反演公式 <span>$f(n)$</span><!-- Has MathJax --></p>
<span>$f(n) = \sum_{d|n} \mu(d) g(\frac{n}{d})$</span><!-- Has MathJax -->

<p>莫比烏斯函數 <span>$\mu(n)$</span><!-- Has MathJax --></p>
<span>$$\mu(n) = \left\{\begin{matrix}
1 &amp;&amp; n = 1\\
(-1)^k &amp;&amp; n = p_1 p_2 \cdots p_k \\
0 &amp;&amp; \text{otherwise}
\end{matrix}\right.$$</span><!-- Has MathJax -->

<ul>
<li>特性 1：<span>$\sum_{d|n} \mu(d) = [n = 1]$</span><!-- Has MathJax --></li>
</ul>
<p>在此簡單說一次，莫比烏斯反演公式就像排容原理，而莫比烏斯函數 <span>$\mu(n)$</span><!-- Has MathJax --> 就像一加一減，之所以在 <span>$n = p_1 p_2 \cdots p_k$</span><!-- Has MathJax --> 為 <span>$\mu(n) = (-1)^k$</span><!-- Has MathJax -->，也就是說當 <span>$n$</span><!-- Has MathJax --> 只全由質數相乘 (不允許冪次方大於 1，否則為 0)，相當於一般認知，奇數次要扣，偶數次要補回來的排容口訣。而特定自然不必多說，其中數學表達 <span>$[n = 1]$</span><!-- Has MathJax --> 相當於程式中的 <code>n == 1 ? 1 : 0</code>。</p>
<p>簡單展示歐拉函數 <span>$\phi(n)$</span><!-- Has MathJax --></p>
<ul>
<li><span>$f(n) = \sum_{d|n} \phi(d) = n$</span><!-- Has MathJax -->，由歐拉函數特性 2 得知。</li>
<li><span>$\phi(n) = \sum_{d|n} \mu(d) f(\frac{n}{d}) = \sum_{d|n} \frac{\mu(d) n}{d}$</span><!-- Has MathJax -->，套用莫比烏斯公式後整理。</li>
</ul>
<p>關於公式<span>$\phi(n) = \sum_{d|n} \frac{\mu(d) n}{d}$</span><!-- Has MathJax --> 可以這麼理解。</p>
<ul>
<li>求出 <span>$gcd(n, k) = 1$</span><!-- Has MathJax --> 的個數，其餘要捨棄掉。</li>
<li>計算 <span>$gcd(n, k) = d$</span><!-- Has MathJax --> 的個數，利用排容原理即莫比烏斯函數，顯而易見排容方案只當 <span>$d$</span><!-- Has MathJax --> 為 <span>$n$</span><!-- Has MathJax --> 個質因數組合而成。</li>
</ul>
<h3 id="應用此題"><a href="#應用此題" class="headerlink" title="應用此題"></a>應用此題</h3><p>利用莫比烏斯函數 特性 1：<span>$\sum_{d|n} \mu(d) = [n = 1]$</span><!-- Has MathJax --></p>
<span>$$\begin{align*}
&amp; \sum_{a = 1}^{N} \sum_{b = 1}^{M} [gcd(a, b) = 1] \\
&amp; = \sum_{a = 1}^{N} \sum_{b = 1}^{M} \sum_{d|gcd(a, b)} \mu(d) \\
&amp; = \sum \mu(d) \left ( \sum_{1 \le a \le N \text{ and } d | a} \left ( \sum_{1 \le b \le M \text{ and } d | b} 1 \right ) \right )\\
&amp; = \sum \mu(d) \left \lfloor \frac{n}{d} \right \rfloor \left \lfloor \frac{m}{d} \right \rfloor
\end{align*}$$</span><!-- Has MathJax -->

<p>第二行就是抽換莫比烏斯，第三行則是交換順序，第四行則是可以快速找到 <span>$d|a$</span><!-- Has MathJax --> 的總數為 <span>$\lfloor n/d \rfloor$</span><!-- Has MathJax --> 所導致。</p>
<p>若直接窮舉 <span>$d$</span><!-- Has MathJax --> 時間複雜度為 <span>$O(min(n, m))$</span><!-- Has MathJax -->，可以利用塊狀的概念優化到 <span>$O(\sqrt{n} + \sqrt{m})$</span><!-- Has MathJax -->。因為 <span>$\lfloor n/d \rfloor$</span><!-- Has MathJax --> 的值只有 <span>$2\lfloor \sqrt{n} \rfloor$</span><!-- Has MathJax --> 種可能，同理 <span>$\lfloor m/d \rfloor$</span><!-- Has MathJax --> 也是，那麼對於同一個 <span>$d$</span><!-- Has MathJax --> 的計數會是一個連續區間不斷地移動。</p>
<p>以下是一個簡單的 <span>$\lfloor n/d \rfloor$</span><!-- Has MathJax --> 示意圖，用 <span>$\lfloor n/d \rfloor$</span><!-- Has MathJax --> 不同當作劃分。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">                 X  X        X     X X   X  X XX  X  X                        </span><br><span class="line">                 X  X        X     X X   X  X XX  X  X                        </span><br><span class="line">+----------------------------------------------------+                        </span><br><span class="line">|                |           |       |   |  |  |  |  | n                        </span><br><span class="line">+----------------------------------------------------+                        </span><br><span class="line">012345678901234567890123456789012345678901234567890123</span><br><span class="line">+---------------------------------------------------------------------------+ </span><br><span class="line">|                   |              |          |      |   |   |  |  |  |  |  | m</span><br><span class="line">+---------------------------------------------------------------------------+ </span><br><span class="line">                 X  X        X     X X   X  X XX  X  X                        </span><br><span class="line">                 X  X        X     X X   X  X XX  X  X                        </span><br></pre></td></tr></table></figure>

<p>程式只要處理打 <code>X</code> 的位置即可，時間複雜度 <span>$O(\sqrt{n} + \sqrt{m})$</span><!-- Has MathJax -->，可以參照一般解。代碼短，但除法次數多。</p>
<p>加速一般解由 liouzhou_101 提供。開一次根號 <code>sqrt()</code>，省下 <span>$O(\sqrt{n})$</span><!-- Has MathJax --> 次的除法，賺了 400 ms，代碼長了 800 B。加速 25% 的效能，可謂除法的可怕，根據研究差異後才發現到這一點。</p>
<h3 id="一般解"><a href="#一般解" class="headerlink" title="一般解"></a>一般解</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GET(x) (mark[(x)&gt;&gt;5]&gt;&gt;((x)&amp;31)&amp;1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SET(x) (mark[(x)&gt;&gt;5] |= 1&lt;&lt;((x)&amp;31))</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">10000005</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXL = (MAXN&gt;&gt;<span class="number">5</span>)+<span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> mark[MAXL];</span><br><span class="line"><span class="keyword">int</span> P[<span class="number">700000</span>], Pt = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">short</span> mu[MAXN], sum[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sieve_mobius</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">int</span> i, j, k;</span><br><span class="line">    <span class="built_in">SET</span>(<span class="number">1</span>), mu[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">10000000</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">GET</span>(i))</span><br><span class="line">            P[Pt++] = i, mu[i] = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; Pt &amp;&amp; (k = i*P[j]) &lt;= n; j++) &#123;</span><br><span class="line">            <span class="built_in">SET</span>(k);</span><br><span class="line">            <span class="keyword">if</span> (i%P[j] == <span class="number">0</span>) &#123;</span><br><span class="line">                mu[k] = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; </span><br><span class="line">            mu[k] = -mu[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">coprime_pair</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> m)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (n &gt; m)	<span class="built_in">swap</span>(n, m);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> d = <span class="number">1</span>, r; d &lt;= n; d = r+<span class="number">1</span>) &#123;</span><br><span class="line">        r = <span class="built_in">min</span>(n / (n/d), m / (m/d));</span><br><span class="line">        ret += (<span class="keyword">long</span> <span class="keyword">long</span>)(sum[r] - sum[d<span class="number">-1</span>]) * (n/d) * (m/d);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">sieve_mobius</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; MAXN; i++)</span><br><span class="line">        sum[i] = sum[i<span class="number">-1</span>] + mu[i];</span><br><span class="line">    <span class="keyword">int</span> testcase, N, M;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;testcase);</span><br><span class="line">    <span class="keyword">while</span> (testcase--) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;N, &amp;M);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>, <span class="built_in">coprime_pair</span>(N, M));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="加速運算解"><a href="#加速運算解" class="headerlink" title="加速運算解"></a>加速運算解</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GET(x) (mark[(x)&gt;&gt;5]&gt;&gt;((x)&amp;31)&amp;1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SET(x) (mark[(x)&gt;&gt;5] |= 1&lt;&lt;((x)&amp;31))</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">10000005</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> SQRN = <span class="number">3200</span> * <span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXL = (MAXN&gt;&gt;<span class="number">5</span>)+<span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> mark[MAXL];</span><br><span class="line"><span class="keyword">int</span> P[<span class="number">700000</span>], Pt = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">short</span> mu[MAXN], sum[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sieve_mobius</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">int</span> i, j, k;</span><br><span class="line">    <span class="built_in">SET</span>(<span class="number">1</span>), mu[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">10000000</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">GET</span>(i))</span><br><span class="line">            P[Pt++] = i, mu[i] = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; Pt &amp;&amp; (k = i*P[j]) &lt;= n; j++) &#123;</span><br><span class="line">            <span class="built_in">SET</span>(k);</span><br><span class="line">            <span class="keyword">if</span> (i%P[j] == <span class="number">0</span>) &#123;</span><br><span class="line">                mu[k] = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; </span><br><span class="line">            mu[k] = -mu[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">coprime_pair</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> m)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> An[SQRN][<span class="number">2</span>], Bn[SQRN][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (n &gt; m)	<span class="built_in">swap</span>(n, m);</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> aidx = <span class="number">0</span>, bidx = <span class="number">0</span>, sq;</span><br><span class="line">    sq = <span class="built_in">sqrt</span>(n);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= sq; i++, aidx++)	An[aidx][<span class="number">1</span>] = n/(An[aidx][<span class="number">0</span>] = n / i);</span><br><span class="line">    <span class="keyword">if</span> (sq * sq == n)	aidx--;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = sq; i &gt;= <span class="number">1</span>; i--, aidx++)	An[aidx][<span class="number">1</span>] = n/(An[aidx][<span class="number">0</span>] = i);</span><br><span class="line">    sq = <span class="built_in">sqrt</span>(m);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= sq; i++, bidx++)	Bn[bidx][<span class="number">1</span>] = m/(Bn[bidx][<span class="number">0</span>] = m / i);</span><br><span class="line">    <span class="keyword">if</span> (sq * sq == m)	bidx--;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = sq; i &gt;= <span class="number">1</span>; i--, bidx++)	Bn[bidx][<span class="number">1</span>] = m/(Bn[bidx][<span class="number">0</span>] = i);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">1</span>, r, *a = &amp;An[<span class="number">0</span>][<span class="number">1</span>], *b = &amp;Bn[<span class="number">0</span>][<span class="number">1</span>], *A = &amp;An[<span class="number">0</span>][<span class="number">0</span>], *B = &amp;Bn[<span class="number">0</span>][<span class="number">0</span>]; l &lt;= n; l = r+<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (*a &lt; *b)</span><br><span class="line">            r = *a, ret += (<span class="keyword">long</span> <span class="keyword">long</span>) (sum[r] - sum[l<span class="number">-1</span>]) * *A * *B, A+=<span class="number">2</span>, a+=<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (*a &gt; *b)</span><br><span class="line">            r = *b, ret += (<span class="keyword">long</span> <span class="keyword">long</span>) (sum[r] - sum[l<span class="number">-1</span>]) * *A * *B, B+=<span class="number">2</span>, b+=<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            r = *a, ret += (<span class="keyword">long</span> <span class="keyword">long</span>) (sum[r] - sum[l<span class="number">-1</span>]) * *A * *B, A+=<span class="number">2</span>, B+=<span class="number">2</span>, a+=<span class="number">2</span>, b+=<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">sieve_mobius</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; MAXN; i++)</span><br><span class="line">        sum[i] = sum[i<span class="number">-1</span>] + mu[i];</span><br><span class="line">    <span class="keyword">int</span> testcase, N, M;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;testcase);</span><br><span class="line">    <span class="keyword">while</span> (testcase--) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;N, &amp;M);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>, <span class="built_in">coprime_pair</span>(N, M));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b441" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/12/zj-b441/" class="article-date">
  <time datetime="2015-07-12T07:39:05.000Z" itemprop="datePublished">2015-07-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/12/zj-b441/">b441. 延展尺寸</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/12/zj-b441/" data-id="ckpaivca700bbn8vn613b8fsk" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/12/zj-b441/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dp/">dp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/影像處理/">影像處理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/模擬/">模擬</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>將 N 張小正方形拼成長條圖，並且每一次挑選一個正方形區域黏貼在長條後，黏貼的條件是比較重疊一半的區域，利用能量最少路徑進行裁剪後併在一起。</p>
<p>如果最少能量大於等於某個值，則再隨機挑選一個正方形區域進行黏貼，捨棄掉這次黏貼操作，若嘗試 50 次沒有成功低於閥值，則取消全部的黏貼操作。</p>
<p>當初的問題在於 ** 連續 50 次 ** 看得似懂非懂，然後還以為是要碎形圖，只找一個正方形去重疊得到 N 個。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2 1</span><br><span class="line">2 2</span><br><span class="line">1 2 3 4 5 6</span><br><span class="line">7 8 9 10 11 12</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2 2</span><br><span class="line">1 2 3 4 5 6</span><br><span class="line">7 8 9 10 11 12</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>接續上一題 b438. 裁剪尺寸 的作法，現在多一個串接和重疊的操作。</p>
<p>感謝蔡星 asas 對此題描述的解說。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IMAGE</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Pixel</span> &#123;</span></span><br><span class="line">        <span class="keyword">int</span> r, g, b;</span><br><span class="line">        <span class="built_in">Pixel</span>(<span class="keyword">int</span> x = <span class="number">0</span>, <span class="keyword">int</span> y = <span class="number">0</span>, <span class="keyword">int</span> z = <span class="number">0</span>):</span><br><span class="line">            <span class="built_in">r</span>(x), <span class="built_in">g</span>(y), <span class="built_in">b</span>(z) &#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d %d&quot;</span>, &amp;r, &amp;g, &amp;b);</span><br><span class="line">        &#125;</span><br><span class="line">        Pixel <span class="keyword">operator</span>-(<span class="keyword">const</span> Pixel &amp;x) <span class="keyword">const</span> &#123;</span><br><span class="line">        	<span class="keyword">return</span> <span class="built_in">Pixel</span>(r-x.r, g-x.g, b-x.b);</span><br><span class="line">    	&#125;</span><br><span class="line">    	Pixel <span class="keyword">operator</span>+(<span class="keyword">const</span> Pixel &amp;x) <span class="keyword">const</span> &#123;</span><br><span class="line">        	<span class="keyword">return</span> <span class="built_in">Pixel</span>(r+x.r, g+x.g, b+x.b);</span><br><span class="line">    	&#125;</span><br><span class="line">    	Pixel <span class="keyword">operator</span>*(<span class="keyword">const</span> <span class="keyword">double</span> x) <span class="keyword">const</span> &#123;</span><br><span class="line">        	<span class="keyword">return</span> <span class="built_in">Pixel</span>(r*x, g*x, b*x);</span><br><span class="line">    	&#125;</span><br><span class="line">        Pixel <span class="keyword">operator</span>/(<span class="keyword">const</span> <span class="keyword">double</span> x) <span class="keyword">const</span> &#123;</span><br><span class="line">        	<span class="keyword">return</span> <span class="built_in">Pixel</span>(r/x, g/x, b/x);</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    		<span class="built_in">printf</span>(<span class="string">&quot;%d %d %d&quot;</span>, r, g, b);</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="function"><span class="keyword">int</span> <span class="title">length</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    		<span class="keyword">return</span> <span class="built_in">abs</span>(r) + <span class="built_in">abs</span>(g) + <span class="built_in">abs</span>(b);</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="function"><span class="keyword">double</span> <span class="title">dist</span><span class="params">(Pixel x)</span> </span>&#123;</span><br><span class="line">    		<span class="keyword">return</span> <span class="built_in">sqrt</span>((r-x.r)*(r-x.r)+(g-x.g)*(g-x.g)+(b-x.b)*(b-x.b));</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> W, H;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">256</span>;</span><br><span class="line">    Pixel data[MAXN][MAXN*<span class="number">3</span>], tmp[MAXN][MAXN*<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">int</span> energy[MAXN][MAXN], dp[MAXN][MAXN];</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> seed;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">random</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">return</span> seed = ( seed * <span class="number">9301</span> + <span class="number">49297</span> ) % <span class="number">233280</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getSquarePosition</span><span class="params">(<span class="keyword">int</span> &amp;x, <span class="keyword">int</span> &amp;y, <span class="keyword">int</span> L)</span> </span>&#123;</span><br><span class="line"> 		y = (W &lt;= L) ? <span class="number">0</span> : <span class="built_in">random</span>() % (W - L);</span><br><span class="line">    	x = (H &lt;= L) ? <span class="number">0</span> : <span class="built_in">random</span>() % (H - L); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;W, &amp;H);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++)</span><br><span class="line">                data[i][j].<span class="built_in">read</span>();</span><br><span class="line">        seed = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">isValid</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x &gt;= <span class="number">0</span> &amp;&amp; y &gt;= <span class="number">0</span> &amp;&amp; x &lt; H &amp;&amp; y &lt; W;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pattern</span><span class="params">(<span class="keyword">int</span> L, <span class="keyword">int</span> N)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> ERROR_TRY = <span class="number">50</span>;</span><br><span class="line">        <span class="keyword">int</span> threshold = <span class="built_in">round</span>(L*<span class="number">255</span>/<span class="number">8.0</span>);</span><br><span class="line">        <span class="keyword">int</span> overlap = <span class="built_in">round</span>(L/<span class="number">2.0</span>);</span><br><span class="line">        <span class="keyword">int</span> lx, ly, tW = <span class="number">0</span>, path[MAXN] = &#123;&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> n = <span class="number">0</span>, it; n &lt; N; n++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (it = <span class="number">0</span>; it &lt; ERROR_TRY; it++) &#123;</span><br><span class="line">                <span class="built_in">getSquarePosition</span>(lx, ly, L);</span><br><span class="line">                <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; L; i++)</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; L; j++)</span><br><span class="line">                            tmp[i][j] = data[lx+i][ly+j];</span><br><span class="line">                    tW = L;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; L; i++) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; overlap; j++) &#123;</span><br><span class="line">                        energy[i][j] = <span class="built_in">round</span>(data[lx+i][ly+j].<span class="built_in">dist</span>(tmp[i][tW-overlap+j]));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">int</span> cost = <span class="built_in">shrink</span>(path, L, overlap);</span><br><span class="line">                <span class="keyword">if</span> (cost &lt; threshold) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; L; i++) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> j = L<span class="number">-1</span>; j &gt;= path[i]; j--)</span><br><span class="line">                            tmp[i][tW-overlap+j] = data[lx+i][ly+j];</span><br><span class="line">                    &#125;</span><br><span class="line">                    tW += L - overlap;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (it == ERROR_TRY)</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        W = tW, H = L;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++)</span><br><span class="line">                data[i][j] = tmp[i][j];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">shrink</span><span class="params">(<span class="keyword">int</span> path[], <span class="keyword">int</span> H, <span class="keyword">int</span> W)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++) &#123;</span><br><span class="line">                <span class="keyword">int</span> &amp;val = dp[i][j];</span><br><span class="line">                <span class="keyword">if</span> (i == <span class="number">0</span>)	val = energy[i][j];</span><br><span class="line">                <span class="keyword">else</span> &#123;	</span><br><span class="line">                    val = dp[i<span class="number">-1</span>][j];</span><br><span class="line">                    <span class="keyword">if</span> (j<span class="number">-1</span> &gt;= <span class="number">0</span>)</span><br><span class="line">                        val = <span class="built_in">min</span>(val, dp[i<span class="number">-1</span>][j<span class="number">-1</span>]);</span><br><span class="line">                    <span class="keyword">if</span> (j+<span class="number">1</span> &lt; W)</span><br><span class="line">                        val = <span class="built_in">min</span>(val, dp[i<span class="number">-1</span>][j+<span class="number">1</span>]);</span><br><span class="line">                    val += energy[i][j];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> st = <span class="number">0</span>, cost;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; W; i++)</span><br><span class="line">            <span class="keyword">if</span> (dp[H<span class="number">-1</span>][i] &lt; dp[H<span class="number">-1</span>][st])</span><br><span class="line">                st = i;</span><br><span class="line">        cost = dp[H<span class="number">-1</span>][st];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = H<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            path[i] = st;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>)	<span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">int</span> val = dp[i][st] - energy[i][st];</span><br><span class="line">            <span class="keyword">if</span> (st<span class="number">-1</span> &gt;= <span class="number">0</span> &amp;&amp; val == dp[i<span class="number">-1</span>][st<span class="number">-1</span>])</span><br><span class="line">                st = st<span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (val == dp[i<span class="number">-1</span>][st])</span><br><span class="line">                st = st;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                st = st+<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cost;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d %d\n&quot;</span>, W, H);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++)</span><br><span class="line">                data[i][j].<span class="built_in">print</span>(), <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, j == W<span class="number">-1</span> ? <span class="string">&#x27;\n&#x27;</span> : <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; test;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, L, N;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;L, &amp;N);</span><br><span class="line">    test.<span class="built_in">read</span>();</span><br><span class="line">    test.<span class="built_in">pattern</span>(L, N);</span><br><span class="line">    test.<span class="built_in">print</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b438" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/12/zj-b438/" class="article-date">
  <time datetime="2015-07-12T07:27:55.000Z" itemprop="datePublished">2015-07-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/12/zj-b438/">b438. 裁剪尺寸</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/12/zj-b438/" data-id="ckpaivca600b8n8vn9mp5d64b" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/12/zj-b438/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dp/">dp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/影像處理/">影像處理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/模擬/">模擬</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>要讓影像的寬度減少，其一的方案就是每一列刪除一個像素，為了讓刪除更加地完善、盡可能看不出來突兀的地方，採用一個一條由上而下路徑進行刪除。</p>
<p>刪除路徑採用最少費用，這個費用採用 sobel operator，也就是說費用越高表示可能是邊緣像素，減少突兀就是盡可能不要去刪除到邊緣像素，這是顯而易見的方案。接著就是採用貪心方案，依序刪除 n 次路徑。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0</span><br><span class="line">1 1</span><br><span class="line">255 255 255</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1 1</span><br><span class="line">255 255 255</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>題目說明最好的選擇方案是一次 n 條不相交的由上而下的路徑，但這個定義是總花費，還是最小化最大花費路徑這是有疑惑的，若單純總花費可以採用最小費用流去完成，但複雜度對這個影像處理會可怕，點數跟邊數都是破萬，複雜度 <span>$O(VE)$</span><!-- Has MathJax --> 的算法要跑非常久，因此貪心是個好選擇。</p>
<p>找尋花費最小的路徑是採用 dynamic programming 的方式得到，並且要回溯得到左側最小的一條路徑。每刪除一條路徑後，sobel operator 要重新計算每一個像素的異動，刷新這一塊可以指更動路徑的右側和鄰近路徑的像素即可，這可以大幅度地增加速度。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IMAGE</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Pixel</span> &#123;</span></span><br><span class="line">        <span class="keyword">int</span> r, g, b;</span><br><span class="line">        <span class="built_in">Pixel</span>(<span class="keyword">int</span> x = <span class="number">0</span>, <span class="keyword">int</span> y = <span class="number">0</span>, <span class="keyword">int</span> z = <span class="number">0</span>):</span><br><span class="line">            <span class="built_in">r</span>(x), <span class="built_in">g</span>(y), <span class="built_in">b</span>(z) &#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d %d&quot;</span>, &amp;r, &amp;g, &amp;b);</span><br><span class="line">        &#125;</span><br><span class="line">        Pixel <span class="keyword">operator</span>-(<span class="keyword">const</span> Pixel &amp;x) <span class="keyword">const</span> &#123;</span><br><span class="line">        	<span class="keyword">return</span> <span class="built_in">Pixel</span>(r-x.r, g-x.g, b-x.b);</span><br><span class="line">    	&#125;</span><br><span class="line">    	Pixel <span class="keyword">operator</span>+(<span class="keyword">const</span> Pixel &amp;x) <span class="keyword">const</span> &#123;</span><br><span class="line">        	<span class="keyword">return</span> <span class="built_in">Pixel</span>(r+x.r, g+x.g, b+x.b);</span><br><span class="line">    	&#125;</span><br><span class="line">    	Pixel <span class="keyword">operator</span>*(<span class="keyword">const</span> <span class="keyword">int</span> x) <span class="keyword">const</span> &#123;</span><br><span class="line">        	<span class="keyword">return</span> <span class="built_in">Pixel</span>(r*x, g*x, b*x);</span><br><span class="line">    	&#125;</span><br><span class="line">        Pixel <span class="keyword">operator</span>/(<span class="keyword">const</span> <span class="keyword">int</span> x) <span class="keyword">const</span> &#123;</span><br><span class="line">        	<span class="keyword">return</span> <span class="built_in">Pixel</span>(r/x, g/x, b/x);</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    		<span class="built_in">printf</span>(<span class="string">&quot;%d %d %d&quot;</span>, r, g, b);</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="function"><span class="keyword">int</span> <span class="title">length</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    		<span class="keyword">return</span> <span class="built_in">abs</span>(r) + <span class="built_in">abs</span>(g) + <span class="built_in">abs</span>(b);</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> W, H;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">256</span>;</span><br><span class="line">    Pixel data[MAXN][MAXN];</span><br><span class="line">    <span class="keyword">int</span> energy[MAXN][MAXN], dp[MAXN][MAXN];</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;W, &amp;H);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++)</span><br><span class="line">                data[i][j].<span class="built_in">read</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Pixel <span class="title">pabs</span><span class="params">(Pixel x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Pixel</span>(<span class="built_in">fabs</span>(x.r), <span class="built_in">fabs</span>(x.g), <span class="built_in">fabs</span>(x.b));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> Pixel <span class="title">getPixel</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x &gt;= <span class="number">0</span> &amp;&amp; y &gt;= <span class="number">0</span> &amp;&amp; x &lt; H &amp;&amp; y &lt; W)</span><br><span class="line">            <span class="keyword">return</span> data[x][y];</span><br><span class="line">        <span class="keyword">if</span> (y &lt; <span class="number">0</span>)	<span class="keyword">return</span> data[<span class="built_in">min</span>(<span class="built_in">max</span>(x, <span class="number">0</span>), H<span class="number">-1</span>)][<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (y &gt;= W)	<span class="keyword">return</span> data[<span class="built_in">min</span>(<span class="built_in">max</span>(x, <span class="number">0</span>), H<span class="number">-1</span>)][W<span class="number">-1</span>];</span><br><span class="line">        <span class="keyword">if</span> (x &lt; <span class="number">0</span>)	<span class="keyword">return</span> data[<span class="number">0</span>][<span class="built_in">min</span>(<span class="built_in">max</span>(y, <span class="number">0</span>), W<span class="number">-1</span>)];</span><br><span class="line">        <span class="keyword">if</span> (x &gt;= H)	<span class="keyword">return</span> data[H<span class="number">-1</span>][<span class="built_in">min</span>(<span class="built_in">max</span>(y, <span class="number">0</span>), W<span class="number">-1</span>)];</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Pixel</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">sobel</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">int</span> dx[] = &#123;<span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>&#125;;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">int</span> dy[] = &#123;<span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>&#125;;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">int</span> xw[] = &#123;<span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">-2</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>&#125;;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">int</span> yw[] = &#123;<span class="number">-1</span>, <span class="number">-2</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>&#125;;				</span><br><span class="line">        <span class="function">Pixel <span class="title">Dx</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span>, <span class="title">Dy</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">9</span>; k++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (xw[k])</span><br><span class="line">                Dx = Dx + <span class="built_in">getPixel</span>(i+dx[k], j+dy[k]) * xw[k];</span><br><span class="line">            <span class="keyword">if</span> (yw[k])</span><br><span class="line">                Dy = Dy + <span class="built_in">getPixel</span>(i+dx[k], j+dy[k]) * yw[k];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Dx.<span class="built_in">length</span>() + Dy.<span class="built_in">length</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shrink</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++)</span><br><span class="line">                energy[i][j] = <span class="built_in">sobel</span>(i, j);</span><br><span class="line">        <span class="keyword">int</span> path[MAXN];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> it = <span class="number">0</span>; it &lt; n; it++) &#123;</span><br><span class="line">            <span class="built_in">shrink</span>(path);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++) &#123;</span><br><span class="line">                <span class="keyword">int</span> y = path[i];</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = y - <span class="number">3</span>; j &lt; W; j++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (j &gt;= <span class="number">0</span>)</span><br><span class="line">                        energy[i][j] = <span class="built_in">sobel</span>(i, j);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shrink</span><span class="params">(<span class="keyword">int</span> path[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++) &#123;</span><br><span class="line">                <span class="keyword">int</span> &amp;val = dp[i][j];</span><br><span class="line">                <span class="keyword">if</span> (i == <span class="number">0</span>)	val = energy[i][j];</span><br><span class="line">                <span class="keyword">else</span> &#123;	</span><br><span class="line">                    val = dp[i<span class="number">-1</span>][j];</span><br><span class="line">                    <span class="keyword">if</span> (j<span class="number">-1</span> &gt;= <span class="number">0</span>)</span><br><span class="line">                        val = <span class="built_in">min</span>(val, dp[i<span class="number">-1</span>][j<span class="number">-1</span>]);</span><br><span class="line">                    <span class="keyword">if</span> (j+<span class="number">1</span> &lt; W)</span><br><span class="line">                        val = <span class="built_in">min</span>(val, dp[i<span class="number">-1</span>][j+<span class="number">1</span>]);</span><br><span class="line">                    val += energy[i][j];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> st = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; W; i++)</span><br><span class="line">            <span class="keyword">if</span> (dp[H<span class="number">-1</span>][i] &lt; dp[H<span class="number">-1</span>][st])</span><br><span class="line">                st = i;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = H<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            path[i] = st;</span><br><span class="line">            <span class="keyword">int</span> v = dp[i][st] - energy[i][st];</span><br><span class="line">            <span class="keyword">for</span> (Pixel *p = &amp;data[i][st], *q = &amp;data[i][st+<span class="number">1</span>], *end = &amp;data[i][W]; q != end; p++, q++)</span><br><span class="line">                *p = *q;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>)	<span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (st<span class="number">-1</span> &gt;= <span class="number">0</span> &amp;&amp; v == dp[i<span class="number">-1</span>][st<span class="number">-1</span>])</span><br><span class="line">                st = st<span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (v == dp[i<span class="number">-1</span>][st])</span><br><span class="line">                st = st;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                st = st+<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        W--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d %d\n&quot;</span>, W, H);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++)</span><br><span class="line">                data[i][j].<span class="built_in">print</span>(), <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, j == W<span class="number">-1</span> ? <span class="string">&#x27;\n&#x27;</span> : <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; test;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;n);</span><br><span class="line">    test.<span class="built_in">read</span>();</span><br><span class="line">    test.<span class="built_in">shrink</span>(n);</span><br><span class="line">    test.<span class="built_in">print</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b442" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/11/zj-b442/" class="article-date">
  <time datetime="2015-07-11T13:34:56.000Z" itemprop="datePublished">2015-07-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/11/zj-b442/">b442. 快取實驗 矩陣乘法</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/11/zj-b442/" data-id="ckpaivca700bcn8vn5levfm7b" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/11/zj-b442/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/作業系統/">作業系統</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>記得 b439: 快取置換機制 提到的快取置換機制嗎？現在來一場實驗吧！</p>
<h3 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h3><p>相信不少人都已經實作所謂的矩陣乘法，計算兩個方陣大小為 <span>$N \times N$</span><!-- Has MathJax --> 的矩陣 <span>$A, B$</span><!-- Has MathJax -->。為了方便起見，提供一個偽隨機數的生成，減少在輸入處理浪費的時間，同時也減少上傳測資的辛苦。</p>
<p>根據種子 <span>$c = S1$</span><!-- Has MathJax --> 生成矩陣 <span>$A$</span><!-- Has MathJax -->，種子 <span>$c = S2$</span><!-- Has MathJax --> 生成矩陣 <span>$B$</span><!-- Has MathJax -->，計算矩陣相乘 <span>$A \times B$</span><!-- Has MathJax -->，為了方便起見，使用 hash 函數進行簽章，最後輸出一個值。由於會牽涉到 overflow 問題，此題作為快取實驗就不考慮這個，overflow 問題大家都會相同。</p>
<p>請利用快取優勢修改代碼如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;bits/stdc++.h&gt;</span><br><span class="line">using namespace std;</span><br><span class="line">class Matrix &#123;</span><br><span class="line">public:</span><br><span class="line">    vector&lt; vector&lt;int&gt; &gt; data;</span><br><span class="line">    int row, col;</span><br><span class="line">    Matrix(int n = 1, int m = 1) &#123;</span><br><span class="line">        data = vector&lt; vector&lt;int&gt; &gt;(n, vector&lt;int&gt;(m, 0));</span><br><span class="line">        row = n, col = m;</span><br><span class="line">    &#125;</span><br><span class="line">    void rand_gen(int c) &#123;</span><br><span class="line">        int x = 2, n = row * col;</span><br><span class="line">        for (int i = 0; i &lt; row; i++) &#123;</span><br><span class="line">            for (int j = 0; j &lt; col; j++) &#123;</span><br><span class="line">                x = ((long long) x * x + c + i + j)%n;</span><br><span class="line">                data[i][j] = x;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Matrix multiply(Matrix x) &#123;</span><br><span class="line">        Matrix ret(row, x.col);</span><br><span class="line">        for (int i = 0; i &lt; row; i++) &#123;</span><br><span class="line">            for (int j = 0; j &lt; x.col; j++) &#123;</span><br><span class="line">                int sum = 0;	// overflow</span><br><span class="line">                for (int k = 0; k &lt; col; k++)</span><br><span class="line">                    sum += data[i][k] * x.data[k][j];</span><br><span class="line">                ret.data[i][j] = sum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return ret;</span><br><span class="line">    &#125;</span><br><span class="line">    void print() &#123;</span><br><span class="line">        for (int i = 0; i &lt; row; i++) &#123;</span><br><span class="line">            printf(&quot;[&quot;);</span><br><span class="line">            for (int j = 0; j &lt; col; j++) &#123;</span><br><span class="line">                printf(&quot; %d&quot;, data[i][j]);</span><br><span class="line">            &#125;</span><br><span class="line">            printf(&quot; ]\n&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    unsigned long signature() &#123;</span><br><span class="line">        unsigned long h = 0;</span><br><span class="line">        for (int i = 0; i &lt; row; i++) &#123;</span><br><span class="line">            for (int j = 0; j &lt; col; j++) &#123;</span><br><span class="line">                h = hash(h + data[i][j]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return h;</span><br><span class="line">    &#125;</span><br><span class="line">private:</span><br><span class="line">    unsigned long hash(unsigned long x) &#123;</span><br><span class="line">        return (x * 2654435761LU);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">int main() &#123;</span><br><span class="line">    int N, S1, S2;</span><br><span class="line">    while (scanf(&quot;%d %d %d&quot;, &amp;N, &amp;S1, &amp;S2) == 3) &#123;</span><br><span class="line">        Matrix A(N, N), B(N, N), C;</span><br><span class="line">        A.rand_gen(S1);</span><br><span class="line">        B.rand_gen(S2);</span><br><span class="line">        C = A.multiply(B);		</span><br><span class="line">//		A.print();</span><br><span class="line">//		B.print();</span><br><span class="line">//		C.print();</span><br><span class="line">        printf(&quot;%lu\n&quot;, C.signature());</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2 2 5</span><br><span class="line">2 2 5</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">573770929</span><br><span class="line">573770929</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>在越大的矩陣中，快取記憶體置換是很慢的，即便用 L1, L2, main memory 分層快取，速度差異很明顯，盡可能在線性 <span>$O(n)$</span><!-- Has MathJax --> 運算上都不造成記憶體置換 (搬移)，雖然複雜度都是 <span>$O(n^3)$</span><!-- Has MathJax -->，相信沒人會去實作 <span>$O(n^{2.807})$</span><!-- Has MathJax --> 的 Strassen 算法，又或者是現今更快的 Coppersmith-Winograd <span>$O(n^{2.3727})$</span><!-- Has MathJax -->。</p>
<p>作業系統題目第二彈，考驗快取應用。在 ZJ 主機上速度可以快二十倍，在本機上只快了十倍。</p>
<ol>
<li>蔡神 asas 修改輸入，而我選擇了轉置，速度落後。</li>
<li>柳州 liouzhou_101 同步簽章，而我選擇分開函數，速度落後。</li>
<li>廖氏如神 pcsh710742 下刀計組，等等，我看見了什麼。</li>
</ol>
<p>現在已經快了四十倍，就只是因為編譯器的優化參數變成手動。詳細實作和效能分析，需要的知識不只是作業系統，同時涵蓋計算機組織的 CPU stall 問題，參考 <a href="http://simulationcorner.net/index.php?page=fastmatrixvector">Optimizing Large Matrix-Vector Multiplications</a></p>
<p>先來個一般解，在計算矩陣 <span>$A \times B$</span><!-- Has MathJax --> 前，先將 <span>$B$</span><!-- Has MathJax --> 轉置，接著修改計算方式 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for (int k = 0; k &lt; col; k++) </span><br><span class="line">    sum += data[i][k] * x.data[j][k];</span><br></pre></td></tr></table></figure>

<p>在這一個迴圈中，陣列採用 row-major 的方式儲存，所以第二維度的區域基本上都在快取中，miss 的機會大幅度降低。</p>
<p>接下來要提案的做法是結合上述三位的做法，代碼快，但不能當 Matrix 模板使用，僅僅做為一個效能體現。共用記憶體，採用指針的方式減少複製，一樣進行轉置，但這會破壞原有的 <span>$B$</span><!-- Has MathJax --> 矩陣配置。同步進行簽章，捨棄掉 <span>$C$</span><!-- Has MathJax --> 矩陣的儲存，使用 LOOP UNROLLING，由於 Zerojudge 的優化沒有開到 <code>-O2</code>、<code>-O3</code>、<code>-Ofast</code>，關於這一部分的優化由使用者自己來。</p>
<p>LOOP UNROLLING 的優化在於 branch 指令，由於 pipeline 會讓效能提升，但遇到 branch 時必須捨棄掉偷偷載入的指令、算到一半的結果，效能會下降，因此使用 LOOP UNROLLING 的好處在於減少 branch 次數。</p>
<p>關於 data prefetch 可以用 <code>__builtin_prefetch()</code> 來完成，根據廖氏如神所言，這個概念可以預先載入防止 stall (pipeline hazard) 的拖延，速度並不會提升太多，有可能是硬體已經完成這一部分，甚至用別的架構去克服。</p>
<h3 id="轉置解"><a href="#轉置解" class="headerlink" title="轉置解"></a>轉置解</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Matrix</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt; vector&lt;<span class="keyword">int</span>&gt; &gt; data;</span><br><span class="line">    <span class="keyword">int</span> row, col;</span><br><span class="line">    <span class="built_in">Matrix</span>(<span class="keyword">int</span> n = <span class="number">1</span>, <span class="keyword">int</span> m = <span class="number">1</span>) &#123;</span><br><span class="line">        data = vector&lt; vector&lt;<span class="keyword">int</span>&gt; &gt;(n, vector&lt;<span class="keyword">int</span>&gt;(m, <span class="number">0</span>));</span><br><span class="line">        row = n, col = m;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rand_gen</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x = <span class="number">2</span>, n = row * col;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; col; j++) &#123;</span><br><span class="line">                x = ((<span class="keyword">long</span> <span class="keyword">long</span>) x * x + c + i + j)%n;</span><br><span class="line">                data[i][j] = x;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Matrix <span class="title">multiply</span><span class="params">(Matrix &amp;x)</span> </span>&#123;</span><br><span class="line">        <span class="function">Matrix <span class="title">ret</span><span class="params">(row, x.col)</span></span>;</span><br><span class="line">        x.<span class="built_in">transpose</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; x.col; j++) &#123;</span><br><span class="line">                <span class="keyword">int</span> sum = <span class="number">0</span>;	<span class="comment">// overflow</span></span><br><span class="line">                <span class="keyword">int</span> *a = &amp;data[i][<span class="number">0</span>], *b = &amp;x.data[j][<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; col; k++)</span><br><span class="line">                    sum += *a * *b, a++, b++;</span><br><span class="line">                ret.data[i][j] = sum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        x.<span class="built_in">transpose</span>();</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">transpose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++)</span><br><span class="line">        	<span class="keyword">for</span> (<span class="keyword">int</span> j = i+<span class="number">1</span>; j &lt; col; j++)</span><br><span class="line">            	<span class="built_in">swap</span>(data[i][j], data[j][i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; col; j++)</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot; %d&quot;</span>, data[i][j]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot; ]\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">signature</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> h = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; col; j++)</span><br><span class="line">                h = <span class="built_in">hash</span>(h + data[i][j]);</span><br><span class="line">        <span class="keyword">return</span> h;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">hash</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (x * <span class="number">2654435761LU</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> N, S1, S2;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d %d %d&quot;</span>, &amp;N, &amp;S1, &amp;S2) == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="function">Matrix <span class="title">A</span><span class="params">(N, N)</span>, <span class="title">B</span><span class="params">(N, N)</span>, C</span>;</span><br><span class="line">        A.<span class="built_in">rand_gen</span>(S1);</span><br><span class="line">        B.<span class="built_in">rand_gen</span>(S2);</span><br><span class="line">        C = A.<span class="built_in">multiply</span>(B);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%lu\n&quot;</span>, C.<span class="built_in">signature</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LOOP-UNROLL-解"><a href="#LOOP-UNROLL-解" class="headerlink" title="LOOP UNROLL 解"></a>LOOP UNROLL 解</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOOP_UNROLL 8</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Matrix</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt; vector&lt;<span class="keyword">int</span>&gt; &gt; data;</span><br><span class="line">    <span class="keyword">int</span> row, col;</span><br><span class="line">    <span class="built_in">Matrix</span>(<span class="keyword">int</span> n = <span class="number">1</span>, <span class="keyword">int</span> m = <span class="number">1</span>) &#123;</span><br><span class="line">        row = n, col = m;</span><br><span class="line">        data = vector&lt; vector&lt;<span class="keyword">int</span>&gt; &gt;(n, vector&lt;<span class="keyword">int</span>&gt;(m, <span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rand_gen</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x = <span class="number">2</span>, n = row * col;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; col; j++) &#123;</span><br><span class="line">                x = ((<span class="keyword">long</span> <span class="keyword">long</span>) x * x + c + i + j)%n;</span><br><span class="line">                data[i][j] = x;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">multiply</span><span class="params">(Matrix &amp;x)</span> </span>&#123;</span><br><span class="line">        x.<span class="built_in">transpose</span>();</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> h = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; x.col; j++) &#123;</span><br><span class="line">                <span class="keyword">register</span> <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">int</span> *a = &amp;data[i][<span class="number">0</span>], *b = &amp;x.data[j][<span class="number">0</span>], k;</span><br><span class="line">                <span class="keyword">for</span> (k = <span class="number">0</span>; k+LOOP_UNROLL &lt; col; k += LOOP_UNROLL) &#123;</span><br><span class="line">                    sum += *a * *b, a++, b++;</span><br><span class="line">                    sum += *a * *b, a++, b++;</span><br><span class="line">                    sum += *a * *b, a++, b++;</span><br><span class="line">                    sum += *a * *b, a++, b++;</span><br><span class="line">                    sum += *a * *b, a++, b++;</span><br><span class="line">                    sum += *a * *b, a++, b++;</span><br><span class="line">                    sum += *a * *b, a++, b++;</span><br><span class="line">                    sum += *a * *b, a++, b++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (; k &lt; col; k++)</span><br><span class="line">                    sum += *a * *b, a++, b++;</span><br><span class="line">                h = <span class="built_in">hash</span>(h + sum);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> h;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">transpose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++)</span><br><span class="line">        	<span class="keyword">for</span> (<span class="keyword">int</span> j = i+<span class="number">1</span>; j &lt; col; j++)</span><br><span class="line">            	<span class="built_in">swap</span>(data[i][j], data[j][i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; col; j++)</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot; %d&quot;</span>, data[i][j]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot; ]\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">hash</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (x * <span class="number">2654435761LU</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="built_in">A</span>(<span class="number">1000</span>, <span class="number">1000</span>), <span class="built_in">B</span>(<span class="number">1000</span>, <span class="number">1000</span>);</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> N, S1, S2;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d %d %d&quot;</span>, &amp;N, &amp;S1, &amp;S2) == <span class="number">3</span>) &#123;</span><br><span class="line">        A.row = A.col = B.row = B.col = N;</span><br><span class="line">        A.<span class="built_in">rand_gen</span>(S1);</span><br><span class="line">        B.<span class="built_in">rand_gen</span>(S2);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%lu\n&quot;</span>, A.<span class="built_in">multiply</span>(B));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b439" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/11/zj-b439/" class="article-date">
  <time datetime="2015-07-11T13:21:39.000Z" itemprop="datePublished">2015-07-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/11/zj-b439/">b439. 快取置換機制</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/11/zj-b439/" data-id="ckpaivca600b9n8vna2104l59" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/11/zj-b439/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/作業系統/">作業系統</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>編寫程式不僅僅是在數學分析上達到高效率，儘管數學分析的複雜度不是最好，理解電腦運作模式也能有效地讓程式變快。例如 資料結構 Unrolled linked list (常翻譯成 塊狀鏈表) 便是利用此一優勢，讓速度顯著地提升，之所以能追上不少常數大的平衡樹操作運用的技巧就是快取效能改善。</p>
<p>講一個更簡單的例子，宣告整數陣列的兩個方案：</p>
<h4 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const int LARGE_SIZE = 1&lt;&lt;30;  int A[LARGE_SIZE], B[LARGE_SIZE];</span><br></pre></td></tr></table></figure>

<h4 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const int LARGE_SIZE = 1&lt;&lt;30; struct DATA &#123; int A, B; &#125; E[LARGE_SIZE]; </span><br></pre></td></tr></table></figure>

<p>演算法的複雜度倘若一樣，若在 A, B 相當高頻率的替換，則快取操作必須不斷地將內容置換，若 A, B 在算法中是獨立運算，則方案一的寫法會來得更好，反之取用方案二會比較好。最常見的運作可以在軟體模擬矩陣乘法中見到，預先將矩陣轉置，利用快取優勢速度可以快上 8 倍以上。</p>
<h3 id="問題描述"><a href="#問題描述" class="headerlink" title="問題描述"></a>問題描述</h3><p>給予一個記憶體空間大小為 <span>$M$</span><!-- Has MathJax -->，使用 Least Recently Used (LRU) 策略進行置換，LRU 的策略為將最久沒有被使用過的空間替換掉，也就是需要從硬碟讀取 <span>$disk[i]$</span><!-- Has MathJax --> 到 <span>$memory$</span><!-- Has MathJax --> 時，發現記憶體都已經用光，則把不常用的 <span>$mem[j]$</span><!-- Has MathJax --> 寫入 <span>$disk[k]$</span><!-- Has MathJax -->，再將 <span>$disk[i]$</span><!-- Has MathJax --> 內容寫入 <span>$mem[j]$</span><!-- Has MathJax -->。</p>
<p>下圖是一個 <span>$M = 4$</span><!-- Has MathJax --> 簡單的範例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">       +---+     +---+     +---+     +---+     +---+     +---+     +---+     +---+</span><br><span class="line">mem[0] | 1 |     | 1 |     | 1 |     | 1 |     | 1 |     | 1 |     | 1 |     | 1 |</span><br><span class="line">       +---+     +---+     +---+     +---+     +---+     +---+     +---+     +---+</span><br><span class="line">mem[1] |   |     | 2 |     | 2 |     | 2 |     | 2 |     | 2 |     | 2 |     | 2 |</span><br><span class="line">       +---+ +-&gt; +---+ +-&gt; +---+ +-&gt; +---+ +-&gt; +---+ +-&gt; +---+ +-&gt; +---+ +-&gt; +---+</span><br><span class="line">mem[2] |   |     |   |     | 3 |     | 3 |     | 3 |     | 3 |     | 5 |     | 5 |</span><br><span class="line">       +---+     +---+     +---+     +---+     +---+     +---+     +---+     +---+</span><br><span class="line">mem[3] |   |     |   |     |   |     | 4 |     | 4 |     | 4 |     | 4 |     | 3 |</span><br><span class="line">       +---+     +---+     +---+     +---+     +---+     +---+     +---+     +---+ </span><br><span class="line">         1         2         3         4         1         2         5         3 </span><br></pre></td></tr></table></figure>

<p>依序使用 1, 2, 3, 4, 1, 2, 5, 3 的配置情況，特別是在 5 使用的時候，會將記憶體中上一次最晚使用的 3 替換掉。</p>
<p>現在寫程式去模擬置換情況。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">4</span><br><span class="line"></span><br><span class="line">0 1</span><br><span class="line">1 2 514</span><br><span class="line">1 3 101</span><br><span class="line">1 4 50216</span><br><span class="line">0 1</span><br><span class="line">0 2</span><br><span class="line">1 5 6</span><br><span class="line">0 3</span><br><span class="line">0 5</span><br><span class="line">0 2</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0 0</span><br><span class="line">0 0</span><br><span class="line">1 514</span><br><span class="line">3 0</span><br><span class="line">2 6</span><br><span class="line">1 514</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>軟體仿作，使用一個 hash 和一個 list 進行維護，而不是使用 priority queue 來維護，用 list 取代之。當進行取址時，順道把對應 list 指針移動，所有步驟期望複雜度都是在 <span>$O(1)$</span><!-- Has MathJax --> 完成，若使用 priority queue 會掉到 <span>$O(\log n)$</span><!-- Has MathJax --> 去進行更新。</p>
<p>換出作業系統題目，來一個最常見到的快取 LRU 算法。這個問題在 Leetcode OJ 上面也有，公司面試有機會遇到。</p>
<p>但實作時被自己坑，比較柳柳州給予的測試，速度居然慢個二十多倍。原因是這樣子的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">map[key] = value;</span><br><span class="line">return map.find(key);</span><br></pre></td></tr></table></figure>

<p>替換成以下寫法，速度就起飛了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return map.insert(&#123;key, value&#125;).first;</span><br></pre></td></tr></table></figure>

<p>也就是說插入的時候順便把指針拿到，避免第二次搜索。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> pair&lt;<span class="keyword">int</span>, list&lt;<span class="keyword">int</span>&gt;::iterator&gt; PIT_TYPE;</span><br><span class="line"><span class="keyword">typedef</span> unordered_map&lt;<span class="keyword">int</span>, pair&lt;<span class="keyword">int</span>, list&lt;<span class="keyword">int</span>&gt;::iterator&gt; &gt;::iterator HIT_TYPE;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LRUCache</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:	</span><br><span class="line">    <span class="keyword">int</span> memIdx, size;</span><br><span class="line">    list&lt;<span class="keyword">int</span>&gt; time;</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; mem;</span><br><span class="line">    unordered_map&lt;<span class="keyword">int</span>, PIT_TYPE&gt; addr;</span><br><span class="line">    <span class="built_in">LRUCache</span>(<span class="keyword">int</span> capacity) &#123;</span><br><span class="line">    	size = capacity;</span><br><span class="line">        mem.<span class="built_in">resize</span>(capacity, <span class="number">0</span>);</span><br><span class="line">        addr.<span class="built_in">clear</span>(), time.<span class="built_in">clear</span>();</span><br><span class="line">        memIdx = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; <span class="title">get</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">    	it = addr.<span class="built_in">find</span>(key);</span><br><span class="line">        <span class="keyword">if</span> (it == addr.<span class="built_in">end</span>())</span><br><span class="line">            it = <span class="built_in">replace</span>(key), mem[it-&gt;second.first] = <span class="number">0</span>;</span><br><span class="line">        it-&gt;second.second = <span class="built_in">recent</span>(it-&gt;second.second);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">make_pair</span>(it-&gt;second.first, mem[it-&gt;second.first]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">HIT_TYPE <span class="title">set</span><span class="params">(<span class="keyword">int</span> key, <span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        it = addr.<span class="built_in">find</span>(key);</span><br><span class="line">        <span class="keyword">if</span> (it == addr.<span class="built_in">end</span>())</span><br><span class="line">        	it = <span class="built_in">replace</span>(key);</span><br><span class="line">        it-&gt;second.second = <span class="built_in">recent</span>(it-&gt;second.second);</span><br><span class="line">        mem[it-&gt;second.first] = value;</span><br><span class="line">        <span class="keyword">return</span> it;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    HIT_TYPE it;</span><br><span class="line">    <span class="function">HIT_TYPE <span class="title">replace</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> mpos = <span class="number">-1</span>, trash;</span><br><span class="line">        list&lt;<span class="keyword">int</span>&gt;::iterator lpos;</span><br><span class="line">        <span class="keyword">if</span> (addr.<span class="built_in">size</span>() == size) &#123;</span><br><span class="line">            trash = time.<span class="built_in">front</span>(), time.<span class="built_in">pop_front</span>();</span><br><span class="line">            it = addr.<span class="built_in">find</span>(trash);</span><br><span class="line">            mpos = it-&gt;second.first;</span><br><span class="line">            addr.<span class="built_in">erase</span>(it);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mpos = memIdx++;</span><br><span class="line">        &#125;</span><br><span class="line">        lpos = time.<span class="built_in">insert</span>(time.<span class="built_in">end</span>(), key);</span><br><span class="line">        <span class="keyword">return</span> addr.<span class="built_in">insert</span>(&#123;key, <span class="built_in">make_pair</span>(mpos, lpos)&#125;).first;</span><br><span class="line">    &#125;</span><br><span class="line">    list&lt;<span class="keyword">int</span>&gt;::<span class="function">iterator <span class="title">recent</span><span class="params">(list&lt;<span class="keyword">int</span>&gt;::iterator p)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> key = *p;</span><br><span class="line">        time.<span class="built_in">erase</span>(p);</span><br><span class="line">        <span class="keyword">return</span> time.<span class="built_in">insert</span>(time.<span class="built_in">end</span>(), key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> M, cmd, x, y;</span><br><span class="line">    pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; t;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;M);</span><br><span class="line">    </span><br><span class="line">    <span class="function">LRUCache <span class="title">LL</span><span class="params">(M)</span></span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;cmd) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cmd == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;x);</span><br><span class="line">            pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; t = LL.<span class="built_in">get</span>(x);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d %d\n&quot;</span>, t.first, t.second);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;x, &amp;y);</span><br><span class="line">            LL.<span class="built_in">set</span>(x, y);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b435" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/11/zj-b435/" class="article-date">
  <time datetime="2015-07-11T12:59:36.000Z" itemprop="datePublished">2015-07-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/11/zj-b435/">b435. 尋找原根</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/11/zj-b435/" data-id="ckpaivca500b6n8vn49fgdlvw" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/11/zj-b435/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/原根/">原根</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/密碼基礎/">密碼基礎</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/數論基礎/">數論基礎</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>給定一個模數 <span>$m$</span><!-- Has MathJax -->，找到其 primitive root <span>$g$</span><!-- Has MathJax -->。</p>
<p>primitive root <span>$g$</span><!-- Has MathJax --> 滿足</p>
<span>$$g^{\phi(m)} \equiv 1 \mod m \\
g^{\gamma} \not\equiv 1 \mod m \text{ , for } 1 \le \gamma &lt; \phi(m)$$</span><!-- Has MathJax -->

<p>意即在模 <span>$m$</span><!-- Has MathJax --> 下，循環節 <span>$ord_m(g) = \phi(m)$</span><!-- Has MathJax -->，若 <span>$m$</span><!-- Has MathJax --> 是質數，則 <span>$\phi(m) = m-1$</span><!-- Has MathJax -->，也就是說循環節長度是 <span>$m-1$</span><!-- Has MathJax -->，更可怕的是組成一個 <span>$[1, m-1]$</span><!-- Has MathJax --> 的數字排列。</p>
<p>現在假定 <span>$m$</span><!-- Has MathJax --> 是質數，請求出一個最小的 primitive root <span>$g$</span><!-- Has MathJax -->。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2</span><br><span class="line">3</span><br><span class="line">5</span><br><span class="line">7</span><br></pre></td></tr></table></figure>

<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>primitive root 在密碼學中，用在 Diffie-Hellman 的選定中的穩定度，倘若基底是一個 primitive root 將會提升破解的難度，因為對應情況大幅增加 (值域比較廣，因為不循環)。</p>
<p>由於歐拉定理，可以得知 <span>$a^{\phi(p)} \equiv 1 \mod p$</span><!-- Has MathJax -->，那麼可以堆導得到若 <span>$a^x \equiv 1 \mod p$</span><!-- Has MathJax -->，則滿足 <span>$x | \phi(p)$</span><!-- Has MathJax -->，否則與歐拉矛盾，藉此可以作為一個篩選的檢查手法，對於所有 <span>$phi(p)$</span><!-- Has MathJax --> 的因數都進行檢查，最後我們可以得到 ** 一般檢測 ** 的作法。</p>
<p>為了加速驗證，由於 <span>$x | \phi(p)$</span><!-- Has MathJax -->，若最小的 <span>$x$</span><!-- Has MathJax --> 存在 <span>$a^x \equiv 1 \mod p$</span><!-- Has MathJax -->，那麼 <span>$kx$</span><!-- Has MathJax --> 也會符合等式，因此只需要檢查 <span>$x = (p-1)/\text{prime-factor}$</span><!-- Has MathJax --> 的情況，如此一來速度就快上非常多。最後得到 ** 加速版本 **，此做法由 liouzhou_101 提供想法。</p>
<h3 id="一般檢測"><a href="#一般檢測" class="headerlink" title="一般檢測"></a>一般檢測</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXL (50000&gt;&gt;5)+1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GET(x) (mark[(x)&gt;&gt;5]&gt;&gt;((x)&amp;31)&amp;1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SET(x) (mark[(x)&gt;&gt;5] |= 1&lt;&lt;((x)&amp;31))</span></span><br><span class="line"><span class="keyword">int</span> mark[MAXL];</span><br><span class="line"><span class="keyword">int</span> P[<span class="number">5500</span>], Pt = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sieve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">int</span> i, j, k;</span><br><span class="line">    <span class="built_in">SET</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">45825</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">GET</span>(i)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(k = n/i, j = i*k; k &gt;= i; k--, j -= i)</span><br><span class="line">                <span class="built_in">SET</span>(j);</span><br><span class="line">            P[Pt++] = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">vector&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt; <span class="built_in">factor</span>(<span class="keyword">int</span> n) &#123;</span><br><span class="line">    vector&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt; R;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>, j; i &lt; Pt &amp;&amp; P[i] * P[i] &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(n%P[i] == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(j = <span class="number">0</span>; n%P[i] == <span class="number">0</span>; n /= P[i], j++);</span><br><span class="line">            R.<span class="built_in">push_back</span>(<span class="built_in">make_pair</span>(P[i], j));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(n != <span class="number">1</span>)	R.<span class="built_in">push_back</span>(<span class="built_in">make_pair</span>(n, <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> R;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gen_factor</span><span class="params">(<span class="keyword">int</span> idx, <span class="keyword">int</span> x, vector&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt; &amp;f, vector&lt;<span class="keyword">int</span>&gt; &amp;g)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (idx == f.<span class="built_in">size</span>()) &#123;</span><br><span class="line">        g.<span class="built_in">push_back</span>(x);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, a = <span class="number">1</span>; i &lt;= f[idx].second; i++, a *= f[idx].first) </span><br><span class="line">        <span class="built_in">gen_factor</span>(idx+<span class="number">1</span>, x*a, f, g);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">mpow</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> x, <span class="keyword">long</span> <span class="keyword">long</span> y, <span class="keyword">long</span> <span class="keyword">long</span> mod)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> ret = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (y) &#123;</span><br><span class="line">        <span class="keyword">if</span> (y&amp;<span class="number">1</span>) </span><br><span class="line">            ret = (ret * x)%mod;</span><br><span class="line">        y &gt;&gt;= <span class="number">1</span>, x = (x * x)%mod;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret % mod;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">primitive_root</span><span class="params">(<span class="keyword">int</span> p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="number">2</span>)	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    vector&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt; f = <span class="built_in">factor</span>(p<span class="number">-1</span>);</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; g;</span><br><span class="line">    <span class="built_in">gen_factor</span>(<span class="number">0</span>, <span class="number">1</span>, f, g);</span><br><span class="line">    g.<span class="built_in">erase</span>(g.<span class="built_in">begin</span>()), g.<span class="built_in">pop_back</span>();	<span class="comment">// remove 1, p-1</span></span><br><span class="line">    <span class="built_in">random_shuffle</span>(g.<span class="built_in">begin</span>(), g.<span class="built_in">end</span>());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= p; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> ok = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;x: g) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">mpow</span>(i, x, p) == <span class="number">1</span>) &#123;</span><br><span class="line">                ok = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ok)	<span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">sieve</span>();</span><br><span class="line">    <span class="keyword">int</span> p;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;p) == <span class="number">1</span>) </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, <span class="built_in">primitive_root</span>(p));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="加速版本"><a href="#加速版本" class="headerlink" title="加速版本"></a>加速版本</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXL (50000&gt;&gt;5)+1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GET(x) (mark[(x)&gt;&gt;5]&gt;&gt;((x)&amp;31)&amp;1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SET(x) (mark[(x)&gt;&gt;5] |= 1&lt;&lt;((x)&amp;31))</span></span><br><span class="line"><span class="keyword">int</span> mark[MAXL];</span><br><span class="line"><span class="keyword">int</span> P[<span class="number">5500</span>], Pt = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sieve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">int</span> i, j, k;</span><br><span class="line">    <span class="built_in">SET</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">45825</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">GET</span>(i)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(k = n/i, j = i*k; k &gt;= i; k--, j -= i)</span><br><span class="line">                <span class="built_in">SET</span>(j);</span><br><span class="line">            P[Pt++] = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">vector&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt; <span class="built_in">factor</span>(<span class="keyword">int</span> n) &#123;</span><br><span class="line">    vector&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt; R;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>, j; i &lt; Pt &amp;&amp; P[i] * P[i] &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(n%P[i] == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(j = <span class="number">0</span>; n%P[i] == <span class="number">0</span>; n /= P[i], j++);</span><br><span class="line">            R.<span class="built_in">push_back</span>(<span class="built_in">make_pair</span>(P[i], j));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(n != <span class="number">1</span>)	R.<span class="built_in">push_back</span>(<span class="built_in">make_pair</span>(n, <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> R;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">mpow</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> x, <span class="keyword">long</span> <span class="keyword">long</span> y, <span class="keyword">long</span> <span class="keyword">long</span> mod)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> ret = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (y) &#123;</span><br><span class="line">        <span class="keyword">if</span> (y&amp;<span class="number">1</span>) </span><br><span class="line">            ret = (ret * x)%mod;</span><br><span class="line">        y &gt;&gt;= <span class="number">1</span>, x = (x * x)%mod;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret % mod;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">primitive_root</span><span class="params">(<span class="keyword">int</span> p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="number">2</span>)	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    vector&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt; f = <span class="built_in">factor</span>(p<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= p; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> ok = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;x: f) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">mpow</span>(i, (p<span class="number">-1</span>)/x.first, p) == <span class="number">1</span>) &#123;</span><br><span class="line">                ok = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ok)	<span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">sieve</span>();</span><br><span class="line">    <span class="keyword">int</span> p;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;p) == <span class="number">1</span>) </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, <span class="built_in">primitive_root</span>(p));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/categories/解題區/page/8/">&laquo; Prev</a><a class="page-number" href="/categories/解題區/">1</a><span class="space">&hellip;</span><a class="page-number" href="/categories/解題區/page/7/">7</a><a class="page-number" href="/categories/解題區/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/categories/解題區/page/10/">10</a><a class="page-number" href="/categories/解題區/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/categories/解題區/page/64/">64</a><a class="extend next" rel="next" href="/categories/解題區/page/10/">Next &raquo;</a>
    </nav>
  
</section>
          
          
            <aside id="sidebar">
  <!-- <div id="ukagaka_panel"></div> -->
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/">學校課程</a><span class="category-list-count">115</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/介面設計/">介面設計</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/作業系統/">作業系統</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/即時系統/">即時系統</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/大學專題/">大學專題</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/巨量資料/">巨量資料</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/平行程式/">平行程式</a><span class="category-list-count">43</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/敏捷方法/">敏捷方法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/編譯器/">編譯器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/自然語言/">自然語言</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/虛擬實境/">虛擬實境</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算型智慧/">計算型智慧</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算幾何/">計算幾何</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算機圖學/">計算機圖學</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資料庫系統/">資料庫系統</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資訊安全/">資訊安全</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/通識課程/">通識課程</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/">工作應用</a><span class="category-list-count">30</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Java/">Java</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Meme/">Meme</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/可持久化/">可持久化</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/鬼故事/">鬼故事</a><span class="category-list-count">9</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/手札日記/">手札日記</a><span class="category-list-count">44</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/">網頁設計</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/About-This-Blog/">About This Blog</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/HTML5/">HTML5</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/JQuery/">JQuery</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/Markdown/">Markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/NodeJs/">NodeJs</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/">解題區</a><span class="category-list-count">633</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/Latex/">Latex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/出題解題/">出題解題</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-POJ/">解題區 - POJ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a><span class="category-list-count">483</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a><span class="category-list-count">77</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-未解題目/">解題區 - 未解題目</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/雜言筆記/">雜言筆記</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a class="text" href="/2021/05/30/java/java-memory-optimization-1/">
              
                <i class="icon-file-o"></i> 
              
            Java 優化內存使用 結構篇</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/diary-202101/">
              
                <i class="icon-file-o"></i> 
              
            二八進展</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-file-extension/">
              
                <i class="icon-file-o"></i> 
              
            File Extension</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-globl-var/">
              
                <i class="icon-file-o"></i> 
              
            Global Variable</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-handover/">
              
                <i class="icon-file-o"></i> 
              
            Handover</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-interview-recursion/">
              
                <i class="icon-file-o"></i> 
              
            Interview &amp; Recursion</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-job-build/">
              
                <i class="icon-file-o"></i> 
              
            Job Build</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-lang/">
              
                <i class="icon-file-o"></i> 
              
            Programming Language Impostors</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-machine-learning-newbie/">
              
                <i class="icon-file-o"></i> 
              
            Machine Learning for Newbie</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-parallel-gc/">
              
                <i class="icon-file-o"></i> 
              
            Parallel &amp; Garbage Collection</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">   
      	<ul>
	      <li><a href="http://mypaper.pchome.com.tw/zerojudge" target="_blank" title="Old Blog"><i class="icon-star"></i> Morris' Blog (pchome)</a></li>
	      <li><a href="http://flere114.blogspot.tw/" target="_blank" title="蘿莉勿觸"><i class="icon-googles"></i> flere's Blog</a></li>
	      <li><a href="http://dreamoon4.blogspot.tw/" target="_blank" title="夢月"><i class="icon-googles"></i> dreamoon's Blog</a></li>
	      <li><a href="http://m80126colin.github.io" target="_blank" title="許胖們"><i class="icon-github-alt"></i> m80126colin's Blog</a></li>
	      <li><a href="http://sd12582000.blogspot.tw/" target="_blank" title="妮可妮可"><i class="icon-github-alt"></i> Nico's Blog</a></li>
	      <li><a href="http://kuoe0.logdown.com/" target="_blank" title="郭至軒大神"><i class="icon-github-alt"></i> KuoE0's Dots</a></li>
	      <li><a href="http://tyan.io/" title=""><i class="icon-github-alt"></i> Tyan Blog</a></li>
    	</ul>
    </div>
</div>

  
    
<script src="/js/jquery-ui.js"></script>
<script src="/js/ukagaka/jquery.morris.ukagaka.resource.js"></script>
<script src="/js/ukagaka/typed.js"></script>
<script type="text/javascript">
  $('#ukagaka_panel').ukagaka();
</script>
  
  
</aside>
          
        
      </div>
      <footer id="footer">
  
  <div class="outer">    
    <div class="social-group">
      
      <a href="https://github.com/morris821028" target="_blank" title="github"><i class="icon-github"></i></a>
      
      
      <a href="https://www.facebook.com/Morris1028" target="_blank" title="facebook"><i class="icon-facebook-sign"></i></a>
      
      
      <a href="http://uhunt.felix-halim.net/id/46705" target="_blank" title="uhunt" ><span class="icon-uhunt">UVa<span></a>
      
    </div>
    <div id="footer-info" class="inner">
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/morris821028/hexo-theme-landscape" target="_blank" title="landscape">landscape</a> &copy; 2021 Shiang-Yun Yang 
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link"><i class=icon-home ></i>&nbsp&nbspHome</a>
  
    <a href="/about" class="mobile-nav-link"><i class=icon-user ></i>&nbsp&nbspAbout</a>
  
    <a href="/archives" class="mobile-nav-link"><i class=icon-archive ></i>&nbsp&nbspArchives</a>
  
    <a href="/tags" class="mobile-nav-link"><i class=icon-tags ></i>&nbsp&nbspTags</a>
  
    <a href="/picture" class="mobile-nav-link"><i class=icon-camera ></i>&nbsp&nbspPictures</a>
  
    <a href="/works" class="mobile-nav-link"><i class=icon-trophy ></i>&nbsp&nbspWorks</a>
  
</nav>
    
<script>
  var disqus_shortname = 'morris1028';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/jquery.lazyload.js"></script>
<script src="/js/jquery.als-1.6.js"></script>

<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>