<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>淺談多重背包問題 (Multiple Knapsack Problem) 優化那些事 | Morris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="收錄於 批改娘 20008. Fast Multiple Knapsack Problem   之所以出了這一題，源自於實驗室另一名同學跑實驗太久，進而撰寫優化程序。聽說原本跑了十分鐘的實驗，改善後提升了到一分鐘跑完。  輸入格式每組測資第一行包含兩個正整數，分別代表背包大小 $M$ ($\leq 10^6$) 和物品個數 $N$ ($\leq 1000$)，下一行開始每行包含兩個正整數，分別代">
<meta name="keywords" content="優化,DP,背包問題,單調堆,monotone queue">
<meta property="og:type" content="article">
<meta property="og:title" content="淺談多重背包問題 (Multiple Knapsack Problem) 優化那些事">
<meta property="og:url" content="http://morris821028.github.io/2016/12/18/jg-20008/index.html">
<meta property="og:site_name" content="Morris&#39; Blog">
<meta property="og:description" content="收錄於 批改娘 20008. Fast Multiple Knapsack Problem   之所以出了這一題，源自於實驗室另一名同學跑實驗太久，進而撰寫優化程序。聽說原本跑了十分鐘的實驗，改善後提升了到一分鐘跑完。  輸入格式每組測資第一行包含兩個正整數，分別代表背包大小 $M$ ($\leq 10^6$) 和物品個數 $N$ ($\leq 1000$)，下一行開始每行包含兩個正整數，分別代">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2021-05-30T02:04:42.504Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="淺談多重背包問題 (Multiple Knapsack Problem) 優化那些事">
<meta name="twitter:description" content="收錄於 批改娘 20008. Fast Multiple Knapsack Problem   之所以出了這一題，源自於實驗室另一名同學跑實驗太久，進而撰寫優化程序。聽說原本跑了十分鐘的實驗，改善後提升了到一分鐘跑完。  輸入格式每組測資第一行包含兩個正整數，分別代表背包大小 $M$ ($\leq 10^6$) 和物品個數 $N$ ($\leq 1000$)，下一行開始每行包含兩個正整數，分別代">
<link rel="publisher" href="108158678174364350000">
  
    <link rel="alternative" href="/atom.xml" title="Morris&#39; Blog" type="application/atom+xml">
  
  
    <meta name="google-site-verification" content="5mRgj8NanEMpGZuNfHNJNmH90RgNlrnJXsFlTaKD6Gs" />
  
  
    <link rel="shortcut icon" href="/img/f.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script src="/js/jquery-2.1.0.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.5.1.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdn.oesmith.co.uk/morris-0.5.1.min.js"></script>
  <link rel="import" href="/bower_components/app-layout/app-layout.html"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"><div id="banner-right"></div></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Morris&#39; Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class=icon-home title='Home'></i></a>
          
        
          
            <a class="main-nav-link" href="/about"><i class=icon-user title='About'></i></a>
          
        
          
            <a class="main-nav-link" href="/archives"><i class=icon-archive title='Archives'></i></a>
          
        
          
            <a class="main-nav-link" href="/tags"><i class=icon-tags title='Tags'></i></a>
          
        
          
            <a class="main-nav-link" href="/picture"><i class=icon-camera title='Pictures'></i></a>
          
        
          
            <a class="main-nav-link" href="/works"><i class=icon-trophy title='Works'></i></a>
          
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://morris821028.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        
          
          <section id="main" style="width: 95%"><article id="post-jg-20008" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/18/jg-20008/" class="article-date">
  <time datetime="2016-12-18T03:14:07.000Z" itemprop="datePublished">2016-12-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      淺談多重背包問題 (Multiple Knapsack Problem) 優化那些事
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/12/18/jg-20008/" data-id="ckpaivc7s002vn8vnb6vzdwfq" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/12/18/jg-20008/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DP/">DP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/monotone-queue/">monotone queue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化/">優化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/單調堆/">單調堆</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/背包問題/">背包問題</a></li></ul>

    </footer>
    <div class="article-entry " itemprop="articleBody">
      
          
              <div id="toc" class="toc-article">
              <h2 class="toc-title"><span>contents</span></h2>
              
                  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#輸入格式"><span class="toc-number">1.</span> <span class="toc-text">輸入格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#輸出格式"><span class="toc-number">2.</span> <span class="toc-text">輸出格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#範例輸入-1"><span class="toc-number">3.</span> <span class="toc-text">範例輸入 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#範例輸出-1"><span class="toc-number">4.</span> <span class="toc-text">範例輸出 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Solution"><span class="toc-number">5.</span> <span class="toc-text">Solution</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#優化初夜"><span class="toc-number">5.1.</span> <span class="toc-text">優化初夜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#優化二夜"><span class="toc-number">5.2.</span> <span class="toc-text">優化二夜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#優化三夜"><span class="toc-number">5.3.</span> <span class="toc-text">優化三夜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#優化四夜"><span class="toc-number">5.4.</span> <span class="toc-text">優化四夜</span></a></li></ol></li></ol>
              
              </div>
          
        
          <blockquote>
<p>收錄於 <a href="https://judgegirl.csie.org/problem/0/20008">批改娘 20008. Fast Multiple Knapsack Problem</a></p>
</blockquote>
<blockquote>
<p>之所以出了這一題，源自於實驗室另一名同學跑實驗太久，進而撰寫優化程序。聽說原本跑了十分鐘的實驗，改善後提升了到一分鐘跑完。</p>
</blockquote>
<h2 id="輸入格式"><a href="#輸入格式" class="headerlink" title="輸入格式"></a>輸入格式</h2><p>每組測資第一行包含兩個正整數，分別代表背包大小 $M$ ($\leq 10^6$) 和物品個數 $N$ ($\leq 1000$)，下一行開始每行包含兩個正整數，分別代表物品價值 $P_i$ ($\leq 10^3$)、物品重量 $W_i$ ($ \leq 10^5$) 以及物品最多可以挑 $C_i$ 個 ($\le 100$)。</p>
<h2 id="輸出格式"><a href="#輸出格式" class="headerlink" title="輸出格式"></a>輸出格式</h2><p>對於每組測資，請輸出最大收益。</p>
<h2 id="範例輸入-1"><a href="#範例輸入-1" class="headerlink" title="範例輸入 1"></a>範例輸入 1</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">50 7</span><br><span class="line">66 31 1</span><br><span class="line">232 10 4</span><br><span class="line">49 20 1</span><br><span class="line">54 19 1</span><br><span class="line">426 4 3</span><br><span class="line">589 3 10</span><br><span class="line">10 6 4</span><br></pre></td></tr></table></figure>

<h2 id="範例輸出-1"><a href="#範例輸出-1" class="headerlink" title="範例輸出 1"></a>範例輸出 1</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">7178</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><blockquote>
<p>不管是 0/1 背包或者多重背包，兩者都屬於 bounded knapsack problem 問題。即便如此，優化上仍有些許的不同，請讓我緩緩道來。</p>
</blockquote>
<p>在此之前，您必須先理解上一篇《淺談背包問題 (0/1 Knapsack Problem) 優化那些事》的部分，不然會造成閱讀上的困難。</p>
<p>多重背包有一個二進制優化，也就是當物品限制最多拿 <span>$C$</span><!-- Has MathJax --> 個時，我們可以利用二進制組合的方式，轉換到 0/1 背包問題，因此我們會得到新的 <span>$N \log C$</span><!-- Has MathJax --> 個物品跑一次 0/1 背包，因此複雜度落在 <span>$O(N \log C \; W)$</span><!-- Has MathJax --> </p>
<p>然而，從公式定義上，在好幾年前的論文中，使用斜率優化降到 <span>$O(N \; W)$</span><!-- Has MathJax -->，推倒過程如下，</p>
<span>$j = k \; w_i + r, \; 0 \le r \le w_i - 1$</span><!-- Has MathJax -->

<span>$$\begin{align*}
dp[i][j] &amp;= \max\left\{dp[i-1][j], dp[i-1][j-w_i]+p_i, \cdots, dp[i-1][j-c_i \; w_i] + c_i \; p_i\right\} \\
&Tab;&amp;= \max\left\{dp[i-1][k \; w_i + r], dp[i-1][(k-1) \; w_i + r] + p_i, \cdots
&Tab;&Tab;, dp[i-1][(k-c_i) \; w_i + r] + c_i p_i\right\} \\
&Tab;&amp;= \max\left\{dp[i-1][k \; w_i + r] - k \; p_i, dp[i-1][(k-1) \; w_i + r] + (k-1) \; p_i, \cdots
&Tab;&Tab;, dp[i-1][(k-c_i) \; w_i + r] - (k-c_i) p_i\right\} + k \; p_i\\
\end{align*}$$</span><!-- Has MathJax -->

<p>隨著式子的轉移，我們發現每一個取值將不依賴相對位置，只跟自身的位置有關，那麼可以使用單調堆 (monotone queue) 運行 <span>$O(1)$</span><!-- Has MathJax --> 的 sliding windows 查找極值。最後，將相同餘數分堆處理，單調堆中最多存在 <span>$O(c)$</span><!-- Has MathJax --> 個元素。</p>
<h3 id="優化初夜"><a href="#優化初夜" class="headerlink" title="優化初夜"></a>優化初夜</h3><blockquote>
<p>如果只使用二進制優化，套上我們的 0/1 優化方案，將有大幅度地提升。</p>
</blockquote>
<p>加入 0/1 背包的優化策略，再套上最簡單的斜率優化算法，得到下面的程式。這裡很懶惰地，由於單調堆最多入隊 <span>$W$</span><!-- Has MathJax --> 次，不外乎地直接只用大小為 <span>$W$</span><!-- Has MathJax --> 的方式實作。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXW = <span class="number">1000005</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1005</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BB</span> &#123;</span></span><br><span class="line">        <span class="keyword">int</span> w, v, c;</span><br><span class="line">        <span class="built_in">BB</span>(<span class="keyword">int</span> w = <span class="number">0</span>, <span class="keyword">int</span> v = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>):</span><br><span class="line">            <span class="built_in">w</span>(w), <span class="built_in">v</span>(v), <span class="built_in">c</span>(c) &#123;&#125;</span><br><span class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> BB &amp;x) <span class="keyword">const</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> w * c  &lt; x.w * x.c;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(BB A[], <span class="keyword">int</span> dp[], <span class="keyword">int</span> W, <span class="keyword">int</span> N)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">int</span> MQ[MAXW][<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> w = A[i].w, v = A[i].v, c = A[i].c;</span><br><span class="line">            sum = <span class="built_in">min</span>(sum + w*c, W);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; w; j++) &#123;</span><br><span class="line">                <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="number">0</span>;</span><br><span class="line">                MQ[l][<span class="number">0</span>] = <span class="number">0</span>, MQ[l][<span class="number">1</span>] = dp[j];</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>; k*w+j &lt;= sum; k++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (k - MQ[l][<span class="number">0</span>] &gt; c)	</span><br><span class="line">                        l++;</span><br><span class="line">                    <span class="keyword">int</span> dpv = dp[k*w+j] - k*v;</span><br><span class="line">                    <span class="keyword">while</span> (l &lt;= r &amp;&amp; MQ[r][<span class="number">1</span>] &lt;= dpv)</span><br><span class="line">                        r--;</span><br><span class="line">                    r++;</span><br><span class="line">                    MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</span><br><span class="line">                    dp[k*w+j] = <span class="built_in">max</span>(dp[k*w+j], MQ[l][<span class="number">1</span>] + k*v);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;	</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">knapsack</span><span class="params">(<span class="keyword">int</span> C[][<span class="number">3</span>], <span class="keyword">int</span> N, <span class="keyword">int</span> W)</span> </span>&#123;</span><br><span class="line">        vector&lt;BB&gt; A;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> w = C[i][<span class="number">0</span>], v = C[i][<span class="number">1</span>], c = C[i][<span class="number">2</span>];</span><br><span class="line">            A.<span class="built_in">push_back</span>(<span class="built_in">BB</span>(w, v, c));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">assert</span>(N &lt; MAXN);</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">int</span> dp1[MAXW+<span class="number">1</span>], dp2[MAXW+<span class="number">1</span>];</span><br><span class="line">        BB Ar[<span class="number">2</span>][MAXN];</span><br><span class="line">        <span class="keyword">int</span> ArN[<span class="number">2</span>] = &#123;&#125;;</span><br><span class="line">        <span class="built_in">memset</span>(dp1, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(dp1[<span class="number">0</span>])*(W+<span class="number">1</span>));</span><br><span class="line">        <span class="built_in">memset</span>(dp2, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(dp2[<span class="number">0</span>])*(W+<span class="number">1</span>));</span><br><span class="line">        <span class="built_in">sort</span>(A.<span class="built_in">begin</span>(), A.<span class="built_in">end</span>());</span><br><span class="line">        <span class="keyword">int</span> sum[<span class="number">2</span>] = &#123;&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> ch = sum[<span class="number">1</span>] &lt; sum[<span class="number">0</span>];</span><br><span class="line">            Ar[ch][ArN[ch]] = A[i];</span><br><span class="line">            ArN[ch]++;</span><br><span class="line">            sum[ch] = <span class="built_in">min</span>(sum[ch] + A[i].w*A[i].c, W);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">run</span>(Ar[<span class="number">0</span>], dp1, W, ArN[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">run</span>(Ar[<span class="number">1</span>], dp2, W, ArN[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = W, mx = <span class="number">0</span>; i &lt;= W; i++, j--) &#123;</span><br><span class="line">            mx = <span class="built_in">max</span>(mx, dp2[i]);</span><br><span class="line">            ret = <span class="built_in">max</span>(ret, dp1[j] + mx);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> W, N;</span><br><span class="line">    <span class="built_in">assert</span>(<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;W, &amp;N) == <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> C[MAXN][<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">        <span class="built_in">assert</span>(<span class="built_in">scanf</span>(<span class="string">&quot;%d %d %d&quot;</span>, &amp;C[i][<span class="number">1</span>], &amp;C[i][<span class="number">0</span>], &amp;C[i][<span class="number">2</span>]) == <span class="number">3</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, <span class="built_in">knapsack</span>(C, N, W));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不幸地，相較於一般的斜率優化寫法，並沒有太大的改善。</p>
<h3 id="優化二夜"><a href="#優化二夜" class="headerlink" title="優化二夜"></a>優化二夜</h3><p>運行 sliding windows 操作時，前 <span>$c$</span><!-- Has MathJax --> 次，是不會進行 <code>pop_front()</code> 操作的，因此把迴圈分兩堆處理，增加 branch predict。以及在乘數運算上，使用強度減少 (strength reduction) 的技術，將乘法換成加法。</p>
<blockquote>
<p>只能些許地改善 5% 的效能。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(BB A[], <span class="keyword">int</span> dp[], <span class="keyword">int</span> W, <span class="keyword">int</span> N)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> MQ[MAXW][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> w = A[i].w, v = A[i].v, c = A[i].c;</span><br><span class="line">        sum = <span class="built_in">min</span>(sum + w*c, W);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; w; j++) &#123;</span><br><span class="line">            <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="number">0</span>;</span><br><span class="line">            MQ[l][<span class="number">0</span>] = <span class="number">0</span>, MQ[l][<span class="number">1</span>] = dp[j];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>, tw = w+j, tv = v; tw &lt;= sum &amp;&amp; k &lt;= c; k++, tw += w, tv += v) &#123;</span><br><span class="line">                <span class="keyword">int</span> dpv = dp[tw] - tv;</span><br><span class="line">                <span class="keyword">while</span> (l &lt;= r &amp;&amp; MQ[r][<span class="number">1</span>] &lt;= dpv)</span><br><span class="line">                    r--;</span><br><span class="line">                r++;</span><br><span class="line">                MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</span><br><span class="line">                dp[tw] = <span class="built_in">max</span>(dp[tw], MQ[l][<span class="number">1</span>] + tv);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = c+<span class="number">1</span>, tw = (c+<span class="number">1</span>)*w+j, tv = (c+<span class="number">1</span>)*v; tw &lt;= sum; k++, tw += w, tv += v) &#123;</span><br><span class="line">                <span class="keyword">if</span> (k - MQ[l][<span class="number">0</span>] &gt; c)   </span><br><span class="line">                    l++;</span><br><span class="line">                <span class="keyword">int</span> dpv = dp[tw] - tv;</span><br><span class="line">                <span class="keyword">while</span> (l &lt;= r &amp;&amp; MQ[r][<span class="number">1</span>] &lt;= dpv)</span><br><span class="line">                    r--;</span><br><span class="line">                r++;</span><br><span class="line">                MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</span><br><span class="line">                dp[tw] = <span class="built_in">max</span>(dp[tw], MQ[l][<span class="number">1</span>] + tv);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="優化三夜"><a href="#優化三夜" class="headerlink" title="優化三夜"></a>優化三夜</h3><p>後來發現，sliding windows 滑動時，我們常常看前看後，因此常常會發生 cache miss，因為他要跳躍一大段記憶體空間查找數值，所以可以考慮花點操作將極值放在 stack 上，視為一種 software cache 來加速，來減少 cache miss 的懲罰。</p>
<p>接著，在迴圈邊界比較時，我們可以算得更精準些，回到一般的 <code>i++</code> 的 format pattern，讓編譯器幫我們做常見的迴圈優化。</p>
<blockquote>
<p>改善了 10% 效能</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(BB A[], <span class="keyword">int</span> dp[], <span class="keyword">int</span> W, <span class="keyword">int</span> N)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> MQ[MAXW][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> w = A[i].w, v = A[i].v, c = A[i].c;</span><br><span class="line">        sum = <span class="built_in">min</span>(sum + w*c, W);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; w; j++) &#123;</span><br><span class="line">            <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="number">0</span>;</span><br><span class="line">            MQ[l][<span class="number">0</span>] = <span class="number">0</span>, MQ[l][<span class="number">1</span>] = dp[j];</span><br><span class="line">            <span class="keyword">int</span> cache_max = MQ[l][<span class="number">1</span>], cache_idx = MQ[l][<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">int</span> k_bound;</span><br><span class="line">            k_bound = <span class="built_in">min</span>((sum-j)/w, c);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>, tw = w+j, tv = v; k &lt;= k_bound; k++, tw += w, tv += v) &#123;</span><br><span class="line">                <span class="comment">// tw = k*w+j, tv = k*v;</span></span><br><span class="line">                <span class="keyword">int</span> dpv = dp[tw] - tv;</span><br><span class="line">                <span class="keyword">while</span> (l &lt;= r &amp;&amp; MQ[r][<span class="number">1</span>] &lt;= dpv)</span><br><span class="line">                    r--;</span><br><span class="line">                r++;</span><br><span class="line">                MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</span><br><span class="line">                <span class="keyword">if</span> (r == l)    cache_max = dpv, cache_idx = k;</span><br><span class="line">                dp[tw] = <span class="built_in">max</span>(dp[tw], cache_max + tv);</span><br><span class="line">            &#125;</span><br><span class="line">            k_bound = (sum-j)/w;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = c+<span class="number">1</span>, tw = (c+<span class="number">1</span>)*w+j, tv = (c+<span class="number">1</span>)*v; k &lt;= k_bound; k++, tw += w, tv += v) &#123;</span><br><span class="line">                <span class="keyword">int</span> dpv = dp[tw] - tv;</span><br><span class="line">                <span class="keyword">while</span> (l &lt;= r &amp;&amp; MQ[r][<span class="number">1</span>] &lt;= dpv)</span><br><span class="line">                    r--;</span><br><span class="line">                r++;</span><br><span class="line">                MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</span><br><span class="line">                <span class="keyword">if</span> (r == l)   </span><br><span class="line">                    cache_max = dpv, cache_idx = k;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (k - cache_idx &gt; c)   </span><br><span class="line">                    l++, cache_idx = MQ[l][<span class="number">0</span>], cache_max = MQ[l][<span class="number">1</span>];</span><br><span class="line">                dp[tw] = <span class="built_in">max</span>(dp[tw], cache_max + tv);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="優化四夜"><a href="#優化四夜" class="headerlink" title="優化四夜"></a>優化四夜</h3><p>儘管上面使用的 software cache 的方式減少 cache miss，但 DP table 仍與數據結構的記憶體位置相當遙遠，為了使他們貼近，應使用環狀隊列的實作，空間從 <span>$O(W)$</span><!-- Has MathJax --> 將到 <span>$O(N)$</span><!-- Has MathJax -->，實作時，將大小限制在 <span>$2^k$</span><!-- Has MathJax -->，方便運行時使用 AND 運算取代耗時的模數運算。</p>
<p>由於限制個數分佈上，很容易造成貪心算法有解，因此先跑一次貪心，如果貪心沒辦法達到剛好大小，那麼再跑 DP 找解。DP 找解時，可以將物品嘗試進行二進制轉換，將等價物品合併，來觸發計算邊界的優化。完成的程序如下：</p>
<blockquote>
<p>最終加速，改善 10%，期待你我的分享增進。根據鴿籠原理，cp 直種類不多時，可以高達 10 倍以上的加速。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXW = <span class="number">1000005</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1005</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXC = <span class="number">1</span>&lt;&lt;<span class="number">12</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BB</span> &#123;</span></span><br><span class="line">        <span class="keyword">int</span> w, v, c;</span><br><span class="line">        <span class="built_in">BB</span>(<span class="keyword">int</span> w = <span class="number">0</span>, <span class="keyword">int</span> v = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>):</span><br><span class="line">            <span class="built_in">w</span>(w), <span class="built_in">v</span>(v), <span class="built_in">c</span>(c) &#123;&#125;</span><br><span class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> BB &amp;x) <span class="keyword">const</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> w * c  &lt; x.w * x.c;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">cmpByWeight</span><span class="params">(BB x, BB y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x.w &lt; y.w;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(BB A[], <span class="keyword">int</span> dp[], <span class="keyword">int</span> W, <span class="keyword">int</span> N)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">int</span> MQ[MAXC][<span class="number">2</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> w = A[i].w, v = A[i].v, c = A[i].c;</span><br><span class="line">            <span class="built_in">assert</span>(c &lt; MAXC);</span><br><span class="line">            sum = <span class="built_in">min</span>(sum + w*c, W);</span><br><span class="line">            <span class="keyword">if</span> (c != <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; w; j++) &#123;</span><br><span class="line">                    <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="number">0</span>;</span><br><span class="line">                    MQ[r][<span class="number">0</span>] = <span class="number">0</span>, MQ[r][<span class="number">1</span>] = dp[j];</span><br><span class="line">                    <span class="keyword">int</span> cache_max = MQ[r][<span class="number">1</span>], cache_idx = MQ[r][<span class="number">0</span>];</span><br><span class="line">                    <span class="keyword">int</span> k_bound;</span><br><span class="line">                    r = (r+<span class="number">1</span>)&amp;(MAXC<span class="number">-1</span>);</span><br><span class="line">                    k_bound = <span class="built_in">min</span>((sum-j)/w, c);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>, tw = w+j, tv = v; k &lt;= k_bound; k++, tw += w, tv += v) &#123;</span><br><span class="line">                        <span class="comment">// tw = k*w+j, tv = k*v;</span></span><br><span class="line">                        <span class="keyword">int</span> dpv = dp[tw] - tv;</span><br><span class="line">                        <span class="keyword">while</span> (l != r &amp;&amp; MQ[(r<span class="number">-1</span>+MAXC)&amp;(MAXC<span class="number">-1</span>)][<span class="number">1</span>] &lt;= dpv)</span><br><span class="line">                            r = (r<span class="number">-1</span>+MAXC)&amp;(MAXC<span class="number">-1</span>);</span><br><span class="line">                        MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</span><br><span class="line">                        <span class="keyword">if</span> (l == r)	cache_max = dpv, cache_idx = k;</span><br><span class="line">                        r = (r+<span class="number">1</span>)&amp;(MAXC<span class="number">-1</span>);</span><br><span class="line">                        dp[tw] = <span class="built_in">max</span>(dp[tw], cache_max + tv);</span><br><span class="line">                    &#125;</span><br><span class="line">                    k_bound = (sum-j)/w;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> k = c+<span class="number">1</span>, tw = (c+<span class="number">1</span>)*w+j, tv = (c+<span class="number">1</span>)*v; k &lt;= k_bound; k++, tw += w, tv += v) &#123;</span><br><span class="line">                        <span class="keyword">int</span> dpv = dp[tw] - tv;</span><br><span class="line">                        <span class="keyword">while</span> (l != r &amp;&amp; MQ[(r<span class="number">-1</span>+MAXC)&amp;(MAXC<span class="number">-1</span>)][<span class="number">1</span>] &lt;= dpv)</span><br><span class="line">                            r--;</span><br><span class="line">                        MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</span><br><span class="line">                        <span class="keyword">if</span> (l == r)	cache_max = dpv, cache_idx = k;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (k - cache_idx &gt; c)	</span><br><span class="line">                            l = (l+<span class="number">1</span>)&amp;(MAXC<span class="number">-1</span>), cache_idx = MQ[l][<span class="number">0</span>], cache_max = MQ[l][<span class="number">1</span>];</span><br><span class="line">                        r = (r+<span class="number">1</span>)&amp;(MAXC<span class="number">-1</span>);</span><br><span class="line">                        dp[tw] = <span class="built_in">max</span>(dp[tw], cache_max + tv);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = sum; j &gt;= w; j--)</span><br><span class="line">                    dp[j] = <span class="built_in">max</span>(dp[j], dp[j-w]+v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;	</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">greedy</span><span class="params">(<span class="keyword">int</span> C[][<span class="number">3</span>], <span class="keyword">int</span> N, <span class="keyword">int</span> W)</span> </span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">GB</span> &#123;</span></span><br><span class="line">            <span class="keyword">int</span> w, v, c;</span><br><span class="line">            <span class="built_in">GB</span>(<span class="keyword">int</span> w = <span class="number">0</span>, <span class="keyword">int</span> v = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>):</span><br><span class="line">                <span class="built_in">w</span>(w), <span class="built_in">v</span>(v), <span class="built_in">c</span>(c) &#123;&#125;</span><br><span class="line">            <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> GB &amp;x) <span class="keyword">const</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (v * x.w != x.v * w)</span><br><span class="line">                    <span class="keyword">return</span> v * x.w &gt; x.v * w;</span><br><span class="line">                <span class="keyword">return</span> c &gt; x.c;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        vector&lt;GB&gt; A;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> w = C[i][<span class="number">0</span>], v = C[i][<span class="number">1</span>], c = C[i][<span class="number">2</span>];</span><br><span class="line">            A.<span class="built_in">push_back</span>(<span class="built_in">GB</span>(w, v, c));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">sort</span>(A.<span class="built_in">begin</span>(), A.<span class="built_in">end</span>());</span><br><span class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> t = <span class="built_in">min</span>(A[i].c, W/A[i].w);</span><br><span class="line">            <span class="keyword">if</span> (t == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            W -= t*A[i].w;</span><br><span class="line">            ret += t*A[i].v;</span><br><span class="line">            <span class="keyword">if</span> (W == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">knapsack</span><span class="params">(<span class="keyword">int</span> C[][<span class="number">3</span>], <span class="keyword">int</span> N, <span class="keyword">int</span> W)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// filter</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> filter = <span class="built_in">greedy</span>(C, N, W);</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="number">-1</span>)</span><br><span class="line">                <span class="keyword">return</span> filter;</span><br><span class="line">        &#125;</span><br><span class="line">        vector&lt;BB&gt; A;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> w = C[i][<span class="number">0</span>], v = C[i][<span class="number">1</span>], c = C[i][<span class="number">2</span>];</span><br><span class="line">            A.<span class="built_in">push_back</span>(<span class="built_in">BB</span>(w, v, c));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// reduce</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">sort</span>(A.<span class="built_in">begin</span>(), A.<span class="built_in">end</span>(), cmpByWeight);</span><br><span class="line">            map&lt;pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;, <span class="keyword">int</span>&gt; R;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">                R[<span class="built_in">make_pair</span>(A[i].w, A[i].v)] = i;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                <span class="keyword">int</span> c = A[i].c;</span><br><span class="line">                map&lt;pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;, <span class="keyword">int</span>&gt;::iterator it;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>; k &lt;= c; k &lt;&lt;= <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> w = A[i].w * k, v = A[i].v * k;</span><br><span class="line">                    it = R.<span class="built_in">find</span>(<span class="built_in">make_pair</span>(w, v));</span><br><span class="line">                    <span class="keyword">if</span> (it != R.<span class="built_in">end</span>() &amp;&amp; i != it-&gt;second) &#123;</span><br><span class="line">                        <span class="keyword">int</span> j = it-&gt;second;</span><br><span class="line">                        A[j].c ++;</span><br><span class="line">                        A[i].c -= k;</span><br><span class="line">                    &#125;</span><br><span class="line">                    c -= k;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (c &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> w = A[i].w * c, v = A[i].v * c;</span><br><span class="line">                    it = R.<span class="built_in">find</span>(<span class="built_in">make_pair</span>(w, v));</span><br><span class="line">                    <span class="keyword">if</span> (it != R.<span class="built_in">end</span>() &amp;&amp; i != it-&gt;second) &#123;</span><br><span class="line">                        <span class="keyword">int</span> j = it-&gt;second;</span><br><span class="line">                        A[j].c ++;</span><br><span class="line">                        A[i].c -= c;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">int</span> dp1[MAXW+<span class="number">1</span>], dp2[MAXW+<span class="number">1</span>];</span><br><span class="line">        BB Ar[<span class="number">2</span>][MAXN];</span><br><span class="line">        <span class="keyword">int</span> ArN[<span class="number">2</span>] = &#123;&#125;;</span><br><span class="line">        <span class="built_in">memset</span>(dp1, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(dp1[<span class="number">0</span>])*(W+<span class="number">1</span>));</span><br><span class="line">        <span class="built_in">memset</span>(dp2, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(dp2[<span class="number">0</span>])*(W+<span class="number">1</span>));</span><br><span class="line">        <span class="built_in">sort</span>(A.<span class="built_in">begin</span>(), A.<span class="built_in">end</span>());</span><br><span class="line">        <span class="keyword">int</span> sum[<span class="number">2</span>] = &#123;&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> ch = sum[<span class="number">1</span>] &lt; sum[<span class="number">0</span>];</span><br><span class="line">            Ar[ch][ArN[ch]] = A[i];</span><br><span class="line">            ArN[ch]++;</span><br><span class="line">            sum[ch] = <span class="built_in">min</span>(sum[ch] + A[i].w*A[i].c, W);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">run</span>(Ar[<span class="number">0</span>], dp1, W, ArN[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">run</span>(Ar[<span class="number">1</span>], dp2, W, ArN[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = W, mx = <span class="number">0</span>; i &lt;= W; i++, j--) &#123;</span><br><span class="line">            mx = <span class="built_in">max</span>(mx, dp2[i]);</span><br><span class="line">            ret = <span class="built_in">max</span>(ret, dp1[j] + mx);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> W, N;</span><br><span class="line">    <span class="built_in">assert</span>(<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;W, &amp;N) == <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> C[MAXN][<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">        <span class="built_in">assert</span>(<span class="built_in">scanf</span>(<span class="string">&quot;%d %d %d&quot;</span>, &amp;C[i][<span class="number">1</span>], &amp;C[i][<span class="number">0</span>], &amp;C[i][<span class="number">2</span>]) == <span class="number">3</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, <span class="built_in">knapsack</span>(C, N, W));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
      
    </div>

  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/01/16/2017-facebook-hacker-cup-qualification/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          2017 Facebook Hacker Cup 資格賽
        
      </div>
    </a>
  
  
    <a href="/2016/12/18/jg-20005/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">淺談背包問題 (0/1 Knapsack Problem) 優化那些事</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
          
          
        
      </div>
      <footer id="footer">
  
  <div class="outer">    
    <div class="social-group">
      
      <a href="https://github.com/morris821028" target="_blank" title="github"><i class="icon-github"></i></a>
      
      
      <a href="https://www.facebook.com/Morris1028" target="_blank" title="facebook"><i class="icon-facebook-sign"></i></a>
      
      
      <a href="http://uhunt.felix-halim.net/id/46705" target="_blank" title="uhunt" ><span class="icon-uhunt">UVa<span></a>
      
    </div>
    <div id="footer-info" class="inner">
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/morris821028/hexo-theme-landscape" target="_blank" title="landscape">landscape</a> &copy; 2021 Shiang-Yun Yang 
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link"><i class=icon-home ></i>&nbsp&nbspHome</a>
  
    <a href="/about" class="mobile-nav-link"><i class=icon-user ></i>&nbsp&nbspAbout</a>
  
    <a href="/archives" class="mobile-nav-link"><i class=icon-archive ></i>&nbsp&nbspArchives</a>
  
    <a href="/tags" class="mobile-nav-link"><i class=icon-tags ></i>&nbsp&nbspTags</a>
  
    <a href="/picture" class="mobile-nav-link"><i class=icon-camera ></i>&nbsp&nbspPictures</a>
  
    <a href="/works" class="mobile-nav-link"><i class=icon-trophy ></i>&nbsp&nbspWorks</a>
  
</nav>
    
<script>
  var disqus_shortname = 'morris1028';
  
  var disqus_url = 'http://morris821028.github.io/2016/12/18/jg-20008/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/jquery.lazyload.js"></script>
<script src="/js/jquery.als-1.6.js"></script>

<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>