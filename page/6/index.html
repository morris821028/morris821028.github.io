<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Morris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Morris&#39; Blog">
<meta property="og:url" content="http://morris821028.github.io/page/6/index.html">
<meta property="og:site_name" content="Morris&#39; Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Morris&#39; Blog">
<link rel="publisher" href="108158678174364350000">
  
    <link rel="alternative" href="/atom.xml" title="Morris&#39; Blog" type="application/atom+xml">
  
  
    <meta name="google-site-verification" content="5mRgj8NanEMpGZuNfHNJNmH90RgNlrnJXsFlTaKD6Gs" />
  
  
    <link rel="shortcut icon" href="/img/f.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script src="/js/jquery-2.1.0.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.5.1.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdn.oesmith.co.uk/morris-0.5.1.min.js"></script>
  <!-- <link rel="import" href="/bower_components/app-layout/app-layout.html"> --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"><div id="banner-right"></div></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Morris&#39; Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class=icon-home title='Home'></i></a>
          
        
          
            <a class="main-nav-link" href="/about"><i class=icon-user title='About'></i></a>
          
        
          
            <a class="main-nav-link" href="/archives"><i class=icon-archive title='Archives'></i></a>
          
        
          
            <a class="main-nav-link" href="/tags"><i class=icon-tags title='Tags'></i></a>
          
        
          
            <a class="main-nav-link" href="/picture"><i class=icon-camera title='Pictures'></i></a>
          
        
          
            <a class="main-nav-link" href="/works"><i class=icon-trophy title='Works'></i></a>
          
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://morris821028.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        
          
          <section id="main">
  
    <article id="post-mproblem-persistent-queue-pre-evaluation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/25/mproblem-persistent-queue-pre-evaluation/" class="article-date">
  <time datetime="2019-12-24T22:20:06.000Z" itemprop="datePublished">2019-12-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/工作應用/">工作應用</a>/<a class="article-category-link" href="/categories/工作應用/可持久化/">可持久化</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/25/mproblem-persistent-queue-pre-evaluation/">可持久化隊列 Persistent Queue 續</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2019/12/25/mproblem-persistent-queue-pre-evaluation/" data-id="ckxtxqs8f00ckgkvn8j76r1bm" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2019/12/25/mproblem-persistent-queue-pre-evaluation/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/queue/">queue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/可持久化/">可持久化</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <p>接續前一篇 《可持久化隊列 Persistent Queue 序》，開始搬運論文的內容，就當作個翻譯吧</p>
<h2 id="預先評估隊列-Pre-Evaluation"><a href="#預先評估隊列-Pre-Evaluation" class="headerlink" title="預先評估隊列 (Pre-Evaluation)"></a>預先評估隊列 (Pre-Evaluation)</h2><ul>
<li>SIMPLE AND EFFICIENT PURELY FUNCTIONAL QUEUES AND DEQUES, Chris Okasaki, 1995</li>
</ul>
<h3 id="初階定義"><a href="#初階定義" class="headerlink" title="初階定義"></a>初階定義</h3><p>定義：隊列 <span>$Q = \left \langle L, \; R \right \rangle$</span><!-- Has MathJax --> 且滿足 <span>$|R| \le |L|$</span><!-- Has MathJax --></p>
<span>$$\begin{aligned}
\left [ \; \right ]_{q} &amp;= \left \langle \left [ \; \right ], \left [ \; \right ] \right \rangle
\\
\\
|\left \langle L, \; R \right \rangle | &amp;= |L| + |R|
\\
\\
\textit{insert} \; (e, \left \langle L, \; R \right \rangle) &amp;= \textit{makeq} \; (L, \; e : R)
\\
\\
\textit{remove} \left \langle L, \; R \right \rangle &amp;= \left \langle \text{hd} \; L, \textit{makeq} \; (\text{tl} \; L, \; R) \right \rangle
\\
\\
\textit{makeq}  \left \langle L, \; R \right \rangle &amp;=  \left \langle L, \; R \right \rangle &amp;\{ |R| \le |L|\} \\
&amp;= \left \langle \textit{rot}(L, R, \left [ \; \right ]), \left [ \; \right ] \right \rangle &amp;\{ |R| = |L| + 1\}\\
\\
\textit{rot}(L, R, A) &amp;= \text{hd} \; R : A &amp; \{ |L| = 0 \} \\
                      &amp;= \text{hd} \; L : \textit{rot}(\text{tl} \; L, \text{tl} \; R, \text{hd} \; R : A) &amp; \{ |L| &gt; 0 \}
\end{aligned}$$</span><!-- Has MathJax -->
<p>看到這一大串的語法樹，就要開始構思曾經在編譯器學到的 LL Parser，操作完之後仍然是一個隊列，為了找到隊列的頭，我們要去完成 LL(1) 的計算，使用向前探查 (lookahead) 問第一個元素為何。</p>
<p>不幸地，上述語法的 <span>$\textit{remove}$</span><!-- Has MathJax --> 為 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax -->，其他操作為 <span>$\mathcal{O}(1)$</span><!-- Has MathJax -->。原因很簡單，當我們不斷地 <span>$\textit{insert}$</span><!-- Has MathJax --> 進去時，根據語法樹會不斷地構造長度為 <span>$1,\; 2,\; 4, \cdots, 2^n$</span><!-- Has MathJax --> 長度的 <span>$\textit{rot}$</span><!-- Has MathJax --> 堆疊，這時候若要看第一個元素為何，運算量就等同於遞迴深度。</p>
<p>縱使我們在每個堆疊建構時，預先計算出 <code>front()</code> 的結果，那麼在 <code>pop()</code> 回傳的時候，仍需要付出代價，而我們更不能在建構子中預先計算出 <code>pop()</code> ，這違反遞迴定義，更會落入退化成線性操作，而不是想要的惰性操作。當瞭解上述的問題後，接下來要想辦法把 <span>$\textit{remove}$</span><!-- Has MathJax --> 變成 <span>$\mathcal{O}(1)$</span><!-- Has MathJax --> 操作。</p>
<h2 id="進階定義"><a href="#進階定義" class="headerlink" title="進階定義"></a>進階定義</h2><p>定義：隊列 <span>$Q = \left \langle L, \; R, \; \hat{L} \right \rangle$</span><!-- Has MathJax --> 且滿足 <span>$|R| \le |L| \wedge |\hat{L}| = |L| - |R|$</span><!-- Has MathJax --></p>
<span>$$\begin{aligned}
\left [ \; \right ]_{q} &amp;= \left \langle \left [ \; \right ], \left [ \; \right ], \left [ \; \right ] \right \rangle
\\
\\
|\left \langle L, \; R, \; \hat{L} \right \rangle | &amp;= |L| + |R|
\\
\\
\textit{insert} \; (e, \left \langle L, \; R, \; \hat{L} \right \rangle) &amp;= \textit{makeq} \; (L, \; e : R, \hat{L})
\\
\\
\textit{remove} \left \langle L, \; R, \; \hat{L} \right \rangle &amp;= \left \langle \text{hd} \; L, \textit{makeq} \; (\text{tl} \; L, \; R, \hat{L}) \right \rangle
\\
\\
\textit{makeq}  \left \langle L, \; R, \; \hat{L} \right \rangle &amp;=  \left \langle L, \; R, \;  \text{tl} \; \hat{L} \right \rangle &amp;\{ |\hat{L}| &gt; 0\} \\
&amp;= \left \langle L&apos;, \left [ \; \right ], L&apos; \right \rangle, \; \text{let} \; L&apos; = \textit{rot}(L, R, \left [ \; \right]) &amp;\{ |\hat{L}| = 0\}\\
\\
\textit{rot}(L, R, A) &amp;= \text{hd} \; R : A &amp; \{ |L| = 0 \} \\
                      &amp;= \text{hd} \; L : \textit{rot}(\text{tl} \; L, \text{tl} \; R, \text{hd} \; R : A) &amp; \{ |L| &gt; 0 \}
\end{aligned}$$</span><!-- Has MathJax -->
<p>透過額外的 <span>$\hat{L}$</span><!-- Has MathJax -->，避開了 LL Parser 和 lookahead 造成的遞迴定義，如此一來每一個操作複雜度皆為 <span>$\mathcal{O}(1)$</span><!-- Has MathJax -->。其概念也很簡單，為了維持條件 <span>$|R| \le |L|$</span><!-- Has MathJax -->，我們將 <span>$\hat{L}$</span><!-- Has MathJax --> 定義為其差值，為即將地部分 <span>$R$</span><!-- Has MathJax --> 反轉到變成 <span>$L$</span><!-- Has MathJax --> 計數做準備。</p>
<p>特別注意到，在 <span>$\text{makeq}$</span><!-- Has MathJax --> 的時候，同步移除掉了一部分的 <span>$\hat{L}$</span><!-- Has MathJax -->，而在長度 <span>$|\hat{L}| = 0$</span><!-- Has MathJax --> 觸發反轉。實作上，可以當作一個長度數值去看待，而在可持久化概念上，它們實際上共享同一塊內存，所以也就沒有太大的差別。</p>
<p>概念與前一篇的 Realtime Queue 構造方式類同。只不過，我們預先將答案放置於 <span>$\textit{rot}$</span><!-- Has MathJax --> 堆疊定義中的 <span>$A$</span><!-- Has MathJax --> 中，而重複使用了 <span>$\hat{L}$</span><!-- Has MathJax --> 找到完成時刻。</p>
<h2 id="Java-實作代碼"><a href="#Java-實作代碼" class="headerlink" title="Java 實作代碼"></a>Java 實作代碼</h2><p>更多細節參閱 <a href="https://github.com/morris821028/immortal-jellyfish" target="_blank" rel="external">morris821028/immortal-jellyfish</a></p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-mproblem-persistent-queue" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/24/mproblem-persistent-queue/" class="article-date">
  <time datetime="2019-12-23T22:43:50.000Z" itemprop="datePublished">2019-12-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/工作應用/">工作應用</a>/<a class="article-category-link" href="/categories/工作應用/可持久化/">可持久化</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/24/mproblem-persistent-queue/">可持久化隊列 Persistent Queue 序</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2019/12/24/mproblem-persistent-queue/" data-id="ckxtxqs8m00d4gkvno9025ygk" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2019/12/24/mproblem-persistent-queue/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/queue/">queue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/可持久化/">可持久化</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我們完成了持久化堆疊後，必然要去完成隊列 (Queue)。難度遠比想像中的高，很多人的第一個反應是用兩個指標去完成持久化隊列，分別指向最前和最後的兩個元素。不幸地，<strong>直覺無法套用</strong>在不同的領域上。</p>
<p>下述為一個例子，假定每一個節點都往後指到下一次會被 pop 的節點，則我們無法同時描述 B 和 C。如果每一個節點都往前指到前一個加入的節點，則無法解決隊列的 pop 操作。上述的兩種設計都無法滿足可持久化的定義，則得到<strong>用兩個指標是無法完成可持久化隊列</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">A = empty().push(1); // [1]</div><div class="line">B = A.push(2);       // [1, 2]</div><div class="line">C = A.push(3);       // [1, 3]</div><div class="line">D = B.pop();         // [2]</div></pre></td></tr></table></figure>
<h3 id="攤銷分析的錯誤"><a href="#攤銷分析的錯誤" class="headerlink" title="攤銷分析的錯誤"></a>攤銷分析的錯誤</h3><p>定義：可持久化隊列 <span>$Q = \left \langle L, \; R \right \rangle$</span><!-- Has MathJax --></p>
<p>在沒有持久化的要求下，我們的確可以用兩個堆疊 <span>$L, \; R$</span><!-- Has MathJax --> 去實作隊列 <span>$Q$</span><!-- Has MathJax -->。當 <span>$|L|  = 0$</span><!-- Has MathJax --> 時，令 <span>$L&apos; = \text{Rev}(R), \; R&apos; = \left [ \; \right ]$</span><!-- Has MathJax -->，每一個操作的時間複雜度為 <span>$\text{amortized} \; \mathcal{O}(1)$</span><!-- Has MathJax -->。</p>
<p>然而，對於可持久化的場合中，這種忽大忽小的成本是不切實際的，因為持久化會複製整體的攤銷成本，而獨立於前一個狀態。達到真正的即時 (realtime)，必須保證每一個操作 <span>$\mathcal{\Theta}(1)$</span><!-- Has MathJax -->，才能防止攤銷最慘情況不會發生。</p>
<h2 id="即時隊列-Realtime"><a href="#即時隊列-Realtime" class="headerlink" title="即時隊列 (Realtime)"></a>即時隊列 (Realtime)</h2><ul>
<li>REAL-TIME QUEUE OPERATIONS IN PURE LISP, Robert HOOD and Robert MEVILL, 1981</li>
</ul>
<p>這快三十年前的論文，給了我們設計函數式的另一種啟發。不透過函數式語言的語法結構，我們可以很直觀地用傳統算法去模擬可持久化隊列。好比 C++ 中的 <code>vector&lt;T&gt;</code> 或者是 Java 中 的<code>ArrayList&lt;T&gt;</code>，每當快滿的時候，我們變將元素複製到兩倍大的容器裡。那可持久化就好比背景程式一般，在每一次操作的過程中，就開始準備好抽換的兩倍容器，直到真的要替換的時候，就可以常數搬移。</p>
<p>定義：隊列 <span>$Q = \left \langle O^{\triangleleft}, I^{\triangleright} \right \rangle$</span><!-- Has MathJax --> 且滿足 <span>$|O^{\triangleleft}| \ge |I^{\triangleright}|$</span><!-- Has MathJax --></p>
<ul>
<li><span>$O^{\triangleleft}$</span><!-- Has MathJax --> 表示出隊的堆疊</li>
<li><span>$I^{\triangleright}$</span><!-- Has MathJax --> 表示入隊的堆疊</li>
</ul>
<p>當發生 <span>$|O^{\triangleleft}| = n, \; |I^{\triangleright}| = n+1$</span><!-- Has MathJax --> 時，我們標記這個隊列為 <strong>轉移中</strong> (<em>transferring</em>)，此時開始可不滿足上述 <span>$|O^{\triangleleft}| \ge |I^{\triangleright}|$</span><!-- Has MathJax --> 的規定。接著，我們將預期在下一次 <span>$|O^{\triangleleft}| = 0$</span><!-- Has MathJax --> 的 pop 操作前，變換成 <span>$Q = \left \langle (OI)^{\triangleleft}, \left [ \; \right ]  \right \rangle$</span><!-- Has MathJax -->。因此這中間至少有 <span>$n$</span><!-- Has MathJax --> 次的 push/pop 操作，讓我們將轉移中隊列變成正規隊列。</p>
<p>需要以下操作：</p>
<ol>
<li>將 <span>$I^{\triangleright}$</span><!-- Has MathJax --> 的所有元素 pop 至 <span>$I_\text{aux} = I^{\triangleleft}$</span><!-- Has MathJax -->，需 <span>$n+2$</span><!-- Has MathJax --> 步。</li>
<li>將 <span>$O^{\triangleleft}$</span><!-- Has MathJax --> 的所有元素 pop 至 <span>$O_\text{aux} = O^{\triangleright}$</span><!-- Has MathJax -->，需 <span>$n+1$</span><!-- Has MathJax --> 步。</li>
<li>將 <span>$O_\text{aux}$</span><!-- Has MathJax --> 的所有元素 pop 至 <span>$I_\text{aux}$</span><!-- Has MathJax -->，<span>$O_\text{new}= (OI)^{\triangleleft}$</span><!-- Has MathJax -->，需 <span>$n+1$</span><!-- Has MathJax --> 步。</li>
</ol>
<p>共計 <span>$3n+4$</span><!-- Has MathJax --> 步。平均在 <span>$n$</span><!-- Has MathJax --> 次操作內完成。變成 <strong>轉移中</strong> 狀態的那一瞬間，操作 <span>$7$</span><!-- Has MathJax --> 次，隨後的每一個 push/pop 完成 <span>$3$</span><!-- Has MathJax --> 次操作。 確保了每一步在常數時間內完成。</p>
<p>在轉移過程中，若進行 push 操作，直接在清空完後的 <span>$I^{\triangleright}$</span><!-- Has MathJax --> 上操作、或者 <span>$I_\text{extra}^{\triangleright}$</span><!-- Has MathJax --> 。若進行 pop 操作時，步驟 3 的最後幾個會成為多餘操作，故需要額外的計數器統計總共完成了幾個 <span>$O_\text{aux}$</span><!-- Has MathJax --> 複製，當完成數量等於當前數量 <span>$|O|$</span><!-- Has MathJax --> 便停止轉移，並標記為正規隊列 <span>$Q = \left \langle O_\text{new}^{\triangleleft}, I^{\triangleright} \right \rangle$</span><!-- Has MathJax -->、或者 <span>$Q = \left \langle O_\text{new}^{\triangleleft}, I_\text{extra}^{\triangleright} \right \rangle$</span><!-- Has MathJax --></p>
<p>宣告不可變物件的類別時，以 Java 為例相當棘手，展開代碼會造成進入 HotSpot 的機會變低，傳遞這個多的參數進行轉移卻要用在回傳值上額外宣告變數來接取。因此，透過平均 <span>$3$</span><!-- Has MathJax --> 次，可能會需要額外宣告 3 次變數，這對 GC 的壓力非同小可。貪心一點，用常數 4 取代，這麼一來可讀性不會下降太多，代碼也能更明確一點，呼叫 2 次的 2 個操作。</p>
<p>實作時，一個可持久化隊列除了一開始的 2 個堆疊，還要維護轉移狀態 5~6 的狀態空間，因此一個隊列需要 7~8 個欄位。</p>
<h2 id="預先評估隊列-Pre-Evaluation"><a href="#預先評估隊列-Pre-Evaluation" class="headerlink" title="預先評估隊列 (Pre-Evaluation)"></a>預先評估隊列 (Pre-Evaluation)</h2><ul>
<li>SIMPLE AND EFFICIENT PURELY FUNCTIONAL QUEUES AND DEQUES, Chris Okasaki, 1995</li>
</ul>
<p>這是另一種設計方法，上述方法用了 7~8 欄位來表示一個隊列，作為一個函數式定義太複雜了，這一概念將只使用 3 個，其他的塞在別的定義中，讓其他函數式定義也能夠共享，下一篇文章再來細說。</p>
<h2 id="Java-實作代碼"><a href="#Java-實作代碼" class="headerlink" title="Java 實作代碼"></a>Java 實作代碼</h2><p>更多細節參閱 <a href="https://github.com/morris821028/immortal-jellyfish" target="_blank" rel="external">morris821028/immortal-jellyfish</a></p>
<h2 id="效能評比"><a href="#效能評比" class="headerlink" title="效能評比"></a>效能評比</h2><p>以 Java 實作，Realtime 與 Pre-Evaluation 效能差不多，但以 OOP 的角度看來 Realtime 很像當初打比賽的精明能幹，Pre-Evaluation 則是代碼量巨大，擴充概念性高。</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-mproblem-persistent-stack-operators" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/23/mproblem-persistent-stack-operators/" class="article-date">
  <time datetime="2019-12-23T13:21:21.000Z" itemprop="datePublished">2019-12-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/工作應用/">工作應用</a>/<a class="article-category-link" href="/categories/工作應用/可持久化/">可持久化</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/23/mproblem-persistent-stack-operators/">可持久化堆疊 操作 Persistent Stack Operators</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2019/12/23/mproblem-persistent-stack-operators/" data-id="ckxtxqs8g00cogkvne15wobbp" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2019/12/23/mproblem-persistent-stack-operators/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/stack/">stack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/可持久化/">可持久化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/堆/">堆</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <p>接續前一篇 《可持久化堆疊 Persistent Stack》，接下來要探討可持久化堆疊相互操作，如何照常在常數複雜度內完成。這一連貫的定義，將在後續的隊列、雙向隊列中使用。</p>
<h2 id="串接-Append"><a href="#串接-Append" class="headerlink" title="串接 Append"></a>串接 Append</h2><p>定義：串接堆疊 <span>$A = \text{Append} \; (T, B)$</span><!-- Has MathJax --></p>
<span>$$\begin{aligned}
\left [ \; \right ]_{\textit{append}} &amp;= \left \langle \left [ \; \right ], \left [ \; \right ] \right \rangle
\\
\\
|\left \langle T, \; B \right \rangle | &amp;= |T| + |B|
\\
\\
\textit{push} \; (\textit{e}, \left \langle T, \; B \right \rangle) &amp;= \left \langle e : T, \; B \right \rangle
\\
\\
\textit{pop} \; (\left \langle T, \; B \right \rangle) &amp;= \left \langle \text{hd} \; T, \left \langle \text{tl} \; T, \; B \right \rangle \right \rangle &amp; \{ |T| &gt; 0 \} \\
&amp;= \left \langle \text{hd} \; B, \text{tl} \; B \right \rangle &amp; \{ |T| = 0 \}
\end{aligned}$$</span><!-- Has MathJax -->
<p>串接兩個堆疊 <span>$T, \; B$</span><!-- Has MathJax -->，並且 <span>$T$</span><!-- Has MathJax --> 放置於頂首、<span>$B$</span><!-- Has MathJax --> 放置於末端，這時候串接也可以被視為一個堆疊結構。由於我們只在意堆疊的接口，完成這三項基礎操作並不是難事。皆可以在 <span>$\mathcal{O}(1)$</span><!-- Has MathJax --> 內完成。</p>
<p>對於大小這一個計算，要特別小心一個錯誤，如果直接以回傳值 <span>$|T| + |B|$</span><!-- Has MathJax --> 撰寫，將在遞迴使用時，其一方也為串接定義出的堆疊而退化成 <span>$\mathcal{O}(n)$</span><!-- Has MathJax --> 的計算。因此在宣告時，紀錄大小是很重要的。</p>
<p>此外，我們也很容易遞迴定義出 Append，如果 <span>$T$</span><!-- Has MathJax --> 本身也是 Append 出來的結果，那麼 pop 時會付出遞迴深度的代價，按照使用的演算法，這種情況會使得時間複雜度為 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax -->。構造時，如果 <span>$T \in \text{Append}$</span><!-- Has MathJax -->，拆解成 <span>$\text{Append}(T.l, \; \text{Append}(T.r, \; B))$</span><!-- Has MathJax --> 可以避免。</p>
<p>我們透過簡單的工廠模式 (Factory Design Pattern)，防止額外的空間宣告，當 <span>$T$</span><!-- Has MathJax --> 或者 <span>$B$</span><!-- Has MathJax --> 其一為空時，直接回傳其中一方。接著就能保證 <span>$|T| &gt; 0, \; |B| &gt; 0$</span><!-- Has MathJax -->，操作就能簡化許多。</p>
<h2 id="提取-Take"><a href="#提取-Take" class="headerlink" title="提取 Take"></a>提取 Take</h2><p>定義：提取堆疊 <span>$A = \text{Take} \; (n, X)$</span><!-- Has MathJax --></p>
<span>$$\begin{aligned}
\left [ \; \right ]_{\textit{take}} &amp;= \left \langle 0, X \right \rangle
\\
\\
|\left \langle n, X \right \rangle | &amp;= n
\\
\\
\textit{push} \; (\textit{e}, \left \langle n, X \right \rangle) &amp;= \text{Append}(e,\; \left \langle n, X \right \rangle)
\\
\\
\textit{pop} \; (\left \langle n, X \right \rangle) &amp;= \left [ \; \right ] &amp; \{ n = 1 \} \\
&amp;= \left \langle \text{hd} \; X, \left \langle n-1, \text{tl} \; X \right \rangle \right \rangle &amp; \{ n &gt; 1 \}
\end{aligned}$$</span><!-- Has MathJax -->
<p>只提取堆頂的前 <span>$n$</span><!-- Has MathJax --> 個元素，剩餘的都不需要。無疑地，提取堆疊也是可持久化的，並且在 <span>$\mathcal{O}(1)$</span><!-- Has MathJax --> 時間內完成所有堆疊操作。但是在 push 操作時，將使用串接操作。</p>
<p>發生遞迴定義時，意即 <span>$X \in \text{Take}$</span><!-- Has MathJax -->，則必須提取成 <span>$A = \text{Take}(n, \; X.x)$</span><!-- Has MathJax --> 防止退化成 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax --></p>
<h2 id="移除-Drop"><a href="#移除-Drop" class="headerlink" title="移除 Drop"></a>移除 Drop</h2><p>定義：移除堆疊 <span>$A = \text{Drop} \; (n, X)$</span><!-- Has MathJax --></p>
<span>$$\begin{aligned}
\text{Drop} \; (n, X) &amp;= X &amp; \{ n = 0 \} \\
                      &amp;= \text{Drop} \; (n-1, X) &amp; \{ n &gt; 1\}
\end{aligned}$$</span><!-- Has MathJax -->
<p>相反於提取，忽略堆頂的前 <span>$n$</span><!-- Has MathJax --> 個元素，從 <span>$n+1$</span><!-- Has MathJax --> 個開始算。</p>
<p>這裡僅提供遞迴定義，由於移除操作並非完全的常數操作，一旦需要拿到堆頂的第一個元素時，勢必要運行 <span>$n$</span><!-- Has MathJax --> 次。唯有在運行操作中，若 <span>$n \le c$</span><!-- Has MathJax --> 小於某個常數定值時，這時候才能把移除操作視為常數且可持久化的堆疊，否則將視為一般的攤平操作。</p>
<p>爾後，我們將提及一些算法的定義 <span>$c = 3$</span><!-- Has MathJax -->，使用這一個 Drop 操作。實作時要特別小心，同時 X 也是一個移除堆疊，那麼在建構前，必然要將 X 攤平，意即把 n 弄成 0 的表示法。防止 pop 操作時，意外地發生 stack overflow 的慘劇。</p>
<p>或許有人會問為什麼不一開始就攤平，早就是常數操作？其實，這就要看理論目標的最壞情況最小化，常數要怎麼分配到不同操作中。在可持久化的領域中，每一個常數操作的大小是每個操作的最大值，而非加總起來，<strong>完全不同於一般算法設計攤銷分析</strong>，因此優化的思維要有所轉變。</p>
<h2 id="反轉-Rev"><a href="#反轉-Rev" class="headerlink" title="反轉 Rev"></a>反轉 Rev</h2><p>定義：反轉堆疊 <span>$A = \text{Rev} \; (X)$</span><!-- Has MathJax --></p>
<span>$$\begin{aligned}
\text{Rev} \; (X) &amp;= \text{Rev}&apos;(X, \left [ \; \right ]) &amp; \\
\\
\text{Rev}&apos;(X, A) &amp;= A &amp; \{ |X| = 0\} \\
                  &amp;= \text{Rev}&apos; \; (\text{tl} \; X, \text{hd} \; X : A) &amp; \{ |X| &gt; 0\}
\end{aligned}$$</span><!-- Has MathJax -->
<p>將整個堆疊 <span>$X$</span><!-- Has MathJax --> 反轉後置放成一個堆疊 <span>$A$</span><!-- Has MathJax -->。</p>
<p>同樣地，若沒有定義 <span>$|X| \le c$</span><!-- Has MathJax -->，反轉操作也<strong>無法在常數時間內完成</strong>。網路上許多實作號稱常數、攤銷持久化，實際上若牽涉到回傳反轉的過程，即使做了快取答案，也可以輕易地將它效能擊破。只需要不斷地呼叫反轉那一瞬間的的操作，或者倒退版本再推進一個版本去觸發攤銷的反轉操作，複雜度就會落入  <span>$\mathcal{O}(n)$</span><!-- Has MathJax -->。</p>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ul>
<li>SIMPLE AND EFFICIENT PURELY FUNCTIONAL QUEUES AND DEQUES, Chris Okasaki, 1995</li>
</ul>
<h2 id="來點題目-《記憶中的堆疊》"><a href="#來點題目-《記憶中的堆疊》" class="headerlink" title="來點題目 《記憶中的堆疊》"></a>來點題目 《記憶中的堆疊》</h2><h3 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h3><p>不斷地進行「思想實驗」的妮可，終於讓大腦演進到平行思考。假想在腦海裡，我們把狀態以堆疊 (Stack) 的方式儲存，當走投無路的時候，就會退回到上一個狀態，再把新的分支因素堆疊上去。正在全力計算的妮可無法細說每一個思維狀態，而我們可以操作戳記，反推出當前狀態。</p>
<p>操作有以下三種：</p>
<ul>
<li><code>0 v</code>: 退回版本 v</li>
<li><code>1 x</code>: 在當前堆疊，push x 到堆頂</li>
<li><code>2</code>: 印出當前堆疊狀態</li>
</ul>
<p>起始版本編號為 0，第 <span>$i$</span><!-- Has MathJax --> 次操作版本編號為 <span>$i$</span><!-- Has MathJax -->。</p>
<h3 id="範例輸入"><a href="#範例輸入" class="headerlink" title="範例輸入"></a>範例輸入</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">1 1</div><div class="line">1 2</div><div class="line">2</div><div class="line">0 1</div><div class="line">2</div><div class="line">1 3</div><div class="line">2</div><div class="line">0 3</div><div class="line">2</div></pre></td></tr></table></figure>
<h3 id="範例輸出"><a href="#範例輸出" class="headerlink" title="範例輸出"></a>範例輸出</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2 1 ]</div><div class="line">1 ]</div><div class="line">3 1 ]</div><div class="line">2 1 ]</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-mproblem-persistent-stack" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/22/mproblem-persistent-stack/" class="article-date">
  <time datetime="2019-12-22T12:07:37.000Z" itemprop="datePublished">2019-12-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/工作應用/">工作應用</a>/<a class="article-category-link" href="/categories/工作應用/可持久化/">可持久化</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/22/mproblem-persistent-stack/">可持久化堆疊 Persistent Stack</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2019/12/22/mproblem-persistent-stack/" data-id="ckxtxqs8i00csgkvn4the84xd" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2019/12/22/mproblem-persistent-stack/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/stack/">stack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/可持久化/">可持久化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/堆/">堆</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>在某些情況下，我們想要每次操作都能對應一個新的物件，即使變動當前的數據結構，也不影響前一次的數據結構。「可持久化 Persistent」一詞用來描述在這一段時間內，保存所有操作狀態的方法。若用在資料庫儲存概念中，「持久化 Persistence」則是用來描述將內存數據對照寫入檔案的可行性，兩者的意思不盡相同。</p>
<p>在工作發現許多語言開始支援函數式設計，也就是 <span>$\lambda$</span><!-- Has MathJax --> 計算 (lambda function)，以現在手上的 Java 開發，主要發生幾個常見的效能問題：</p>
<ul>
<li><p><strong>惰性求值</strong> (Lazy Evaluation)：<br>每一個惰性求值是需要的時候再計算，然而有些歷史代碼並不是這麼回事，導致一部分函數回傳整個串列，因此消耗了至少為 <span>$\mathcal{O}(n)$</span><!-- Has MathJax --> 的時間，而非函數式所需要的 <span>$\mathcal{O}(1)$</span><!-- Has MathJax -->。如果一個函數只針對前 10 個數值感興趣，大部分的資料都會被捨棄掉，在未來使用這些函數接口時，都還要去檢查每一個相關實作是否為真惰性，而非假性惰性。請參閱 <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html" target="_blank" rel="external">Java Stream</a> 串流實作細節。</p>
</li>
<li><p><strong>不可變物件</strong> (Immutable Object)：<br>對於某些中間表達式，如檔案系統路徑。若要列出一個資料夾下的所有檔案路徑，在上述的惰性求值中，樸素的實作將會把路徑之間的重複不斷複製。正如同經典的字串問題，每串接一個字串，必然會複製一份，倘若複製的順序相反，時間複雜度將從 <span>$\mathcal{O}(n)$</span><!-- Has MathJax --> 變成 <span>$\mathcal{O}(n^2)$</span><!-- Has MathJax -->。</p>
</li>
</ul>
<p>串流操作 Stream 以 functional-style operation 為主，又細分成好幾種操作。即使運行結果相同，造就的效能與可拓展性也不同，如 <code>reduce</code> 和 <code>collect</code> 的差別，都能將一系列的元素縮合成一個，但是 <code>reduce</code> 採用二合一，容易在合成操作上退化成 <span>$\mathcal{O}(n^2)$</span><!-- Has MathJax -->，對不可變物件操作，其空間消耗量大，唯一個優勢是平行加速的擴充性。相反地，<code>collect</code> 則是逐一將元素納入一個集合，這樣一個簡單的合併操作，是沒辦法并行處理的，好處則是不會產生太多額外使用空間。</p>
<p>為了達到具拓展性且不失效能的設計，函數式編程那些獨特的數據結構和算法，或許能解決我們的問題。</p>
<h2 id="堆疊定義"><a href="#堆疊定義" class="headerlink" title="堆疊定義"></a>堆疊定義</h2><p>堆疊 Stack，主要有兩個操作：</p>
<ul>
<li><span>$\textit{push} \; (\textit{value})$</span><!-- Has MathJax -->：將一個元素 <span>$\textit{value}$</span><!-- Has MathJax --> 放置到堆頂</li>
<li><span>$\textit{pop} \; ()$</span><!-- Has MathJax -->：將堆頂元素移除</li>
</ul>
<p>課堂上總是會教資料結構，使用鏈結串列 (Linked List) 或者是陣列 (Array) 來實作，每一個操作皆為 <span>$\mathcal{O}(1)$</span><!-- Has MathJax --> 常數。而持久化一個堆疊，我們將要針對改變結構內容的操作進行複製。</p>
<h2 id="可持久化堆疊定義"><a href="#可持久化堆疊定義" class="headerlink" title="可持久化堆疊定義"></a>可持久化堆疊定義</h2><p>可持久化堆疊 Stack 定義：</p>
<ul>
<li><span>$[\;]_{\textit{stack}} = \left \langle [\;] \right \rangle$</span><!-- Has MathJax --></li>
<li><span>$|\left \langle A \right \rangle| = |\left \langle \text{hd} \; A \right \rangle| + |\left \langle \text{tl} \; A \right \rangle|$</span><!-- Has MathJax --></li>
<li><span>$\textit{push} \; (\textit{e}, A) = \left \langle e : A \right \rangle$</span><!-- Has MathJax --></li>
<li><span>$\textit{pop} \; (A) = \left \langle \text{hd} \; A, \left \langle \text{tl} \; A \right \rangle \right \rangle$</span><!-- Has MathJax -->
</li>
</ul>
<p>上述的數學式</p>
<ul>
<li><span>$\text{hd}$</span><!-- Has MathJax --> 為堆疊的首元素。另一個使用術語為 <span>$\textit{car}$</span><!-- Has MathJax -->。</li>
<li><span>$\text{tl}$</span><!-- Has MathJax --> 為剔除首元素之後的結果。另一個使用術語為 <span>$\textit{cdr}$</span><!-- Has MathJax -->。從堆疊來看，即為回傳指向前一個節點的位置。</li>
<li><span>$:$</span><!-- Has MathJax --> 為串接操作。</li>
</ul>
<p>這一簡單結構，又被稱作為 list。只允許對堆頂操作的串列，這麼說很混淆，但在函數式設計中，他們通用的 list 就是這麼構造的，在後續的算法中，我們都用可持久化堆疊來表示 list。</p>
<p>以下述的例子，我們構造 4 個堆疊，每一個堆疊指向堆頂元素。對於加入一個元素到堆疊，我們就額外多一個節點指向先前的堆疊；相同地，移除堆頂元素時，回傳前一個堆疊結果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">A = empty.push(X)    // [X]</div><div class="line">B = A.push(Y)        // [X, Y]</div><div class="line">C = B.push(Z)        // [X, Y, Z]</div><div class="line">D = B.push(W)        // [X, Y, W]</div></pre></td></tr></table></figure>
<p>相應的儲存圖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">   A         B         C</div><div class="line">+--+-+    +--+-+    +--+-+</div><div class="line">|  |X&lt;----+  |Y&lt;----+  |Z|</div><div class="line">+--+-+    +--+^+    +--+-+</div><div class="line">              |</div><div class="line">              |        D</div><div class="line">              |     +--+-+</div><div class="line">              +-----+  |W|</div><div class="line">                    +--+-+</div></pre></td></tr></table></figure>
<p>此時，<span>$D$</span><!-- Has MathJax --> 進行 <span>$\textit{pop}$</span><!-- Has MathJax --> 操作，回傳值為 <span>$\left \langle W, B \right \rangle$</span><!-- Has MathJax -->。</p>
<p>最後，對於每一個操作在 <span>$\mathcal{O}(1)$</span><!-- Has MathJax --> 時間內完成，需要額外的 <span>$\mathcal{O}(1)$</span><!-- Has MathJax --> 空間。對於沒有垃圾回收 (Garbage Collection) 的語言實作上，需要維護參照數量 reference counter 來回收沒有用到的堆疊節點。</p>
<h2 id="Java-實作代碼"><a href="#Java-實作代碼" class="headerlink" title="Java 實作代碼"></a>Java 實作代碼</h2><p>更多細節參閱 <a href="https://github.com/morris821028/immortal-jellyfish" target="_blank" rel="external">morris821028/immortal-jellyfish</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> persistent.stack;</div><div class="line"></div><div class="line"><span class="keyword">import</span> persistent.PStack;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> morrisy</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt; The type of element</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersistStack</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">PStack</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> PersistStack&lt;?&gt; EMPTY = <span class="keyword">new</span> PersistStack();</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">PersistStack&lt;T&gt; <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (PersistStack&lt;T&gt;) EMPTY;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> T value;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PersistStack&lt;T&gt; next;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> size;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">PersistStack</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">PersistStack</span><span class="params">(T value, PersistStack&lt;T&gt; next, <span class="keyword">int</span> size)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.value = value;</div><div class="line">        <span class="keyword">this</span>.next = next;</div><div class="line">        <span class="keyword">this</span>.size = size;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> size == <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> size;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> PersistStack&lt;T&gt; <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> create();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">top</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isEmpty())</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> PersistStack&lt;T&gt; <span class="title">push</span><span class="params">(T value)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PersistStack&lt;&gt;(value, <span class="keyword">this</span>, size + <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> PersistStack&lt;T&gt; <span class="title">pop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> next != <span class="keyword">null</span> ? next : create();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-diary-201908" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/09/diary-201908/" class="article-date">
  <time datetime="2019-08-09T09:07:42.000Z" itemprop="datePublished">2019-08-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/手札日記/">手札日記</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="https://i.imgur.com/g1o7Yud.jpg" rel="gallery_ckxtxqs540049gkvn87p2ds5q">
        <img src="https://i.imgur.com/g1o7Yud.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/09/diary-201908/">我們是否交會於一點</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2019/08/09/diary-201908/" data-id="ckxtxqs540049gkvn87p2ds5q" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2019/08/09/diary-201908/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <p>距離上一次撰寫已經過了六個月，原以為有很多故事可以分享，但卻發現工作後的變化並沒有太多。每天就這麼兩點一線地不斷往返，在通勤往返的路上，尋求那麼一點不同。久而久之，擠身在擁擠的人群中只能感受到與自己對話，那種刻骨銘心的衝勁逐漸地消失。</p>
<h2 id="工作"><a href="#工作" class="headerlink" title="工作"></a>工作</h2><p>從二月開始到八月，工作仍然繞著程式效能在轉，而我早已忘了給予的目標是什麼，看到路上的石子擋路，就拿著大學的基礎理論一路清下去，問題並不難、演算法也並不深。放在那兒好幾年，對我來說不是滋味。</p>
<p>隨著代碼的增長，一定會有人在之後不斷地照著這個思路複製下去，問題就如雪球般地越來越大。「能混就混吧，這樣才能在社會裡討好關係」－到了工作場所後，不是範圍內的事情，即使點出了錯誤，甚至還順便修了它，也不見得是件好事。這樣做下去，甚至還引起了質疑的氛圍，之後就這麼把工作丟給對方去做，要不然就是不給你權限做任何改變。</p>
<p>逐漸地，無法共同成長的我們，也無法將理想好好地發揮，那到底要怎麼好好地顧及這一切，明明能預先看到的問題，現在卻只能無助地看著危機不斷發生。</p>
<p><img src="https://i.imgur.com/dadOzB0.jpg" alt="「即便如此，他們說的話我全都照做」－《我要準時下班》"></p>
<p>起初，總指派著新的功能要著設想架構，但是發現提出來也只有自己去做，大家正襟危坐地聽著規劃，最後問著「大概要花多久的時間，才能看到你們完成？」此時，心中灰了一片。「原來不是要一起走啊」</p>
<p>然而，那些提著都是建立在原有的架構技術下。不斷地嘗試挖掘未來時，卻發現產品的各方面都還欠缺相當嚴重，於是不斷地修正效能、演算法、架構完整與防呆寫法，每天修改上千行的代碼，整體加速了好兩三倍以上，使用內存也少了一大半去，甚至在長期使用的穩定性給予大幅度地調整。</p>
<p><img src="https://i.imgur.com/t1G8V4h.jpg" alt="「旁邊的項目有點不妙」－《賢惠幼妻仙狐小姐》"></p>
<p>在某些層面上，這的確已經超出了原先設定的目標，但也沒有負責的單位去處理，自己動手下去修純屬逼不得已。面對眾人的期待，我再也沒辦法告訴你們多久能完成那些新功能，但聽到「可是那個不知道還要多久，能不能先 …」、「這問題當初你不是說要解決」諸如此類的話語，心中那股熱火就像少了助燃劑而熄滅。原來我們之間的工作切分得這麼細，真的沒有能力來幫忙嗎？明明我只是做基礎功。</p>
<p><img src="https://i.imgur.com/vV7Bb6W.jpg" alt="&quot;I can do anything, I can do absolutely anything&quot;, The Expert"></p>
<p>三月到了，櫃台大姊姊離去。四月到了，同期的同事被女友拖著去讀博班。心裡一沉，現在的我就會這麼一直下去，還是聽著家裡人講的，時間一到乾脆出國繼續讀書去。不知道那些未來還帶有著什麼，而到底是為了什麼賺錢？為什麼要工作？</p>
<p>大神傳了 <a href="https://www.youtube.com/watch?v=gpgXZ5nSCYU" target="_blank" rel="external"><strong>三和大神</strong></a> 的關鍵字給我，又聽著不斷地說不想學技術的烈士們，原先積極向上的朋友們，似乎都逐漸對工作感到人生黯淡。現實早已經變得殘酷不已，社會卻要向我們勸說咬著忍下去，工作就是不斷分析的我們，哪會這麼輕易地照著劇本走。成熟的我們，為了理想而苟且偷生，這才是常態。</p>
<p><img src="https://i.imgur.com/c7SXivE.jpg" alt="「雖然涉足這份工作不是因為想做，但接手了就不能放手不管。雖然涉足這份工作不是因為喜歡，但接手了就不能無功而返，就算我們有誰死了，也不會有人哭，大家肯定會笑著送別，因為誰也不敢保證一定能活到明天」－《灰色：幻影扳機》"></p>
<p>六月的某一天，我發現自己到了極限，對於現況的不滿已經淹沒我的思緒。那一天，我沒有選擇，開了一場 “I Don’t Have a Choice” 為題的會議。說著自己報告的時候，只能說著最重要的那 1% 的修改，剩餘的那 99% 對在場的各位也許不是那麼重要。就算是僅僅的那麼 1%，說了仍不能在各位心中占有一席之地，問題還是一再地發生。</p>
<p>光鮮亮麗的專案報告不是我所能給予的，現在的我很在意每一個技術環節，因為沒有一個可以遵循的準則。我沒辦法決定一個醒目的會議標題，告訴著你們有什麼特別突破，現在的我想要尋找恆久不變的原則。這些說起來很傷人，但也是因為我們並沒有共同走到那一步，無法在同一個平台上討論。</p>
<p>每當聽著報告，原先就聽不懂得我，完全學不到任何知識，當不知道一個項目用在哪裡，怎麼記也記不久，而且從來沒有機會使用的話，那真的非常難以體會其狀態。懵懵懂懂地參與，不知所謂的發問。</p>
<p>如果還有更遠得未來，就想要知道如何走得更遠。如果報告總是特例說明，輪到我啟程的那一天，真的會是一樣的情況嗎？不經地懷疑，那一天我仍要自己從零開始研究。</p>
<p>做事就像捏黏土，往那個目標捏去並不難，也許不是很漂亮，但足以觀賞。如果可以對材質有所研究？或者在捏的過程有所遵循的方法？是不是可以更進一步地完成？</p>
<p>工作帶著一種「勿以惡小而為之，勿以善小而不為」的心境處理代碼。然而，什麼是善？什麼是偽善？非與非惡？上帝向工程師下咒，一旦看到令人傷心的代碼，就會渾身劇痛的詛咒，為了避免自身的痛苦，就向所有代碼伸出了援手。是否伸出援手？如果存在一個純粹的善可以行動，那只剩下代碼自己了不是？</p>
<p><img src="https://i.imgur.com/CiNAkq4.jpg" alt="「只要看過聽過，亦或者思考過。無論何時都能清楚想起來，到目前為止，這種能力的效果只不過比他人記性好而已」－《重啟咲良田》"></p>
<p><img src="https://i.imgur.com/G2u0KIX.jpg" alt="「這是因為你的正義感太強，強烈到就像潔癖症或完美主義的程度。上帝向某位少年下咒，一旦看到傷心的人就會渾身劇痛的詛咒」－《重啟咲良田》"></p>
<p><img src="https://i.imgur.com/4I70LJr.jpg" alt="「少年為了避免自身的痛苦，就向所有悲傷的人伸出援手，之後上帝做了一個少年的複製品。沒有意識，只會模仿少年行為的複製品，假少年也向所有悲傷的人伸出援手，上帝賦予了真假少年各自的名字。一個叫做善，另一個較偽善。你覺得誰是善？誰又是偽善呢？」－《重啟咲良田》"></p>
<p>壞習慣已經養成，思考是難以停止，探究一切可能的心仍處於背景運行中。常常從身邊的人，老是說著我想得太多，應該要好好地放鬆。但是，那是因為我還沒有證明那些不可能，這不就是在三十歲以前的常態嗎？現在的我還不能放棄吧？</p>
<p><img src="https://i.imgur.com/TXBmKkb.jpg" alt="「為什麼考慮那些不會發生的事情」－《切爾諾貝利 》"></p>
<p><img src="https://i.imgur.com/Rxcbgbv.jpg" alt="「『為什麼考慮那些不會發生的事情』，太完美了，應該把這句話印在我們的貨幣上」－《切爾諾貝利 》"></p>
<p><img src="https://i.imgur.com/2iBNykb.jpg" alt="「我想我沒法再努力了」－《我要準時下班》"></p>
<h2 id="一般向"><a href="#一般向" class="headerlink" title="一般向"></a>一般向</h2><p><img src="https://i.imgur.com/caCuOlP.jpg" alt="「抱歉，我逃避到工作裡去了」－《未來的未來》"></p>
<p><img src="https://i.imgur.com/TqLsu7x.jpg" alt="「男人工作不順利的話，不就無路可逃了嗎」－《房仲女王》"></p>
<p>基本上，玩得遊戲還是那十幾年來如一貫的楓之谷，只不過現在裡頭認識的人不多了。有一天，久違上線的人問道：</p>
<p>「如果她不在了，那你怎麼還活著？」<br>「有嗎？」我心中想著，原來看起來還活著。</p>
<p>這幾個月來，沒有什麼特別的目標。看著美劇看看英文。每個休閒的假日就這樣過著，等級也就這樣子上去。</p>
<p><img src="https://i.imgur.com/YVV2aRr.png" alt="本吾 聖騎士"></p>
<p>直到了最近，網上朋友讓我認識了遊戲中的妹子，深入了解了後，沒想到是做 HR 的，談起話來常常總是四處碰壁，完全落不著頭緒。在某一天的上班時間，</p>
<p>「在忙什麼？」 友人 A 傳來的訊息<br>「正處理那些幾何相交的問題，高中數學裡頭的。」 看著手裡已經整合好的代碼說道。<br>「那我們呢？」 友人 A 很快速地傳了過來，腦海裡沒有任何應答的方式。</p>
<p>這句話的涵義相當地多樣，似乎就在玩弄著我，想讓我去思考，我們最終是否會交會？咱這輩子還沒看過有人問過這種問題。</p>
<p>起先，我並不怎麼在意這些，不過就是遊戲內的嘛。隨後在情人節的前一周，在好友頻道爆炸性的誤解來了。</p>
<p>「是做哪一種朋友？」 友人 B 如此問道<br>「靈魂之友」 我開玩笑地插嘴回覆。<br>「靈魂擁抱」 友人 A 不知道向誰說道</p>
<p>友人 C 無法看到友人 A 的詢問，於是莫名其妙陷入了難以解釋的關係。接著，被拉去解釋，在跳進黃河也洗不清的情況下，突然友人 A 這麼說道</p>
<p>「在等本吾過情人節」</p>
<p>這下子，我選擇了死亡。</p>
<p><img src="https://i.imgur.com/VNB9D82.jpg" alt=""></p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-e021" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/16/zj-e021/" class="article-date">
  <time datetime="2019-02-16T01:11:22.000Z" itemprop="datePublished">2019-02-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/16/zj-e021/">動態幾何 史蒂芙的泡泡 (解法 2)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2019/02/16/zj-e021/" data-id="ckxtxqst301lfgkvntdj26khc" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2019/02/16/zj-e021/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pbds/">pbds</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rope/">rope</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h2><p>在處理完數以百計的政事後，受盡折磨的史蒂芙，打算回家好好地休息。 拖著疲倦的身軀，再也無法再容納任何一點複雜計算。從王宮走回寢居的路上， 發現身邊所見的事物都不再圓滑，看起來就像是粗糙的幾何多邊形構成的一切。</p>
<p>打算享受著泡泡浴的史蒂芙，看著眼前的多邊形泡泡，失去原本應有的色澤，那透涼的心境更蒙上了一層灰影</p>
<p>「為什麼是我呢？」感嘆道</p>
<p>伸出手戳著眼前的泡泡，卻飄了過去</p>
<p>「區區的泡泡也跟我作對，嗚嗚」</p>
<p>將一個泡泡視為一個簡單多邊形 <span>$A$</span><!-- Has MathJax -->，方便起見用一個序列 <span>$a_0, a_1, ..., a_{n-1}$</span><!-- Has MathJax --> 表示多邊形 <span>$A$</span><!-- Has MathJax --> 的每一個頂點，則會有 <span>$n$</span><!-- Has MathJax --> 個線段 <span>$\overline{a_0 a_1}, \overline{a_1 a_2}, \cdots, \overline{a_{n-1} a_0}$</span><!-- Has MathJax -->。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">5 14</div><div class="line"></div><div class="line">0 0</div><div class="line">10 0 </div><div class="line">10 10</div><div class="line">0 10</div><div class="line">5 5</div><div class="line"></div><div class="line">1 0 0</div><div class="line">1 1 0</div><div class="line">1 2 1</div><div class="line">1 3 2</div><div class="line">3 5.5 5</div><div class="line">3 10 -1</div><div class="line">3 10 5</div><div class="line">1 4 1</div><div class="line">3 5.5 5</div><div class="line">3 10 -1</div><div class="line">3 10 5</div><div class="line">2 3</div><div class="line">3 5 7.5</div><div class="line">3 5 2.5</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">0</div><div class="line">0</div><div class="line">0</div><div class="line">0</div><div class="line">0</div><div class="line">0</div><div class="line">1</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>參閱 <a href="/2019/01/26/mproblem-dynamic-point-in-polygon/" title="動態幾何 史蒂芙的泡泡  (解法 1)">動態幾何 史蒂芙的泡泡  (解法 1)</a></p>
<p>相較於先前的解法 <span>$\mathcal{O}(\log n) - \mathcal{O}(\ast \sqrt{n})$</span><!-- Has MathJax -->，相當不穩定的嵌套 KD-BRH 的解法，實際上如果單純針對這一題，可以拋開 region search 的操作，只有完全的詢問點是否在多邊形內部，則可以做到 <span>$\mathcal{O}(\log^2 n)$</span><!-- Has MathJax -->。</p>
<p>如同一般的射線法，對詢問點拉出無限延長的線，找到與多邊形的邊相交個數。如果單純把每一條邊拿出來看，最暴力的複雜度為 <span>$\mathcal{O}(n)$</span><!-- Has MathJax -->，現在要減少查閱的邊數，且透過 rank tree 在 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax --> 累計相交數量。</p>
<p>由於給定的座標不需要動態，則著手離散化 <span>$X = x_0, x_1, \cdots, x_n$</span><!-- Has MathJax -->，線段樹中的每一個點 <span>$u$</span><!-- Has MathJax --> 維護一個 rank tree，把包含者個區段 <span>$[x_l, x_r]$</span><!-- Has MathJax --> 的線段通通放入，且保證放入的線段彼此之間不相交 (除了兩端點)。如此一來，當詢問一個點，需要探訪 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax --> 個節點，每個節點 <span>$u$</span><!-- Has MathJax --> 需要 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax --> 時間來計算相交數量，最後詢問的複雜度為 <span>$\mathcal{O}(\log^2 n)$</span><!-- Has MathJax -->。同理，修改點的操作也會在 <span>$\mathcal{O}(\log^2 n)$</span><!-- Has MathJax -->。</p>
<p>實作時，特別注意到與射線方向相同的線段不予處理，按照下面的寫法則是不處理垂直的線段，一來是射線法也不會去計算，二來是線段樹劃分的時候會造成一些邊界問題，由於我們對於點離散，父節點 <span>$[x_l, x_r]$</span><!-- Has MathJax -->，左右子樹控制的分別為 <span>$[x_l, x_\text{mid}]$</span><!-- Has MathJax -->、<span>$[x_\text{mid}, x_r]$</span><!-- Has MathJax -->，劃分時會共用中間點。</p>
<p>即使有了上述的概念來解題，我們仍需要維護 <a href="https://en.wikipedia.org/wiki/Rope_(data_structure" target="_blank" rel="external">rope data structrue</a> 來維護節點的相鄰關係，可以自己實作任何的 binary tree 來達到 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax -->，這裡採用 splay tree 示範。</p>
<hr>
<p>接下來介紹內建黑魔法 PBDS (policy-based data structure) 和 rope。很多人都提及到這些非正式的 STL 函式庫，只有在 gcc/g++ 裡面才有附錄，如果是 clang 等其他編譯器可能是沒有辦法的。所以上傳相關代碼要看 OJ 是否採用純正的 gcc/g++。</p>
<p>參考資料：</p>
<ul>
<li><a href="https://codeforces.com/blog/entry/11080" target="_blank" rel="external">C++ STL: Policy based data structures - Codeforces</a></li>
<li><a href="https://www.luogu.org/blog/Chanis/gnu-pbds" target="_blank" rel="external">比STL还STL？——平板电视</a></li>
<li><a href="http://www.martinbroadhurst.com/stl/Rope.html" target="_blank" rel="external">C++ STL: SGI rope</a></li>
</ul>
<p>PBDS 比較常用在 rank tree 和 heap，由於代碼量非常多，用內建防止 code length exceed limitation 的出現，也不妨是個好辦法。用 rank tree 的每一個詢問操作皆在 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax -->，而 heap 選擇 thin heap 或 pairing heap，除了 pop 操作外，皆為 <span>$\mathcal{O}(1)$</span><!-- Has MathJax -->，在對最短路徑問題上別有優勢。</p>
<p>而這一題不太適用 SGI rope，原因在於雖為 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax --> 操作，但它原本就為了仿作 string 而強迫變成可持久化的引數結構，導致每一個操作需要額外的開銷來減少內存使用。由於此題經常在單一元素上操作，SGI rope 對於單一元素效能不彰，以造成嚴重的逾時。</p>
<p>這裡仍提及和示範這些概念的資料結構，哪天正式編入標準函式庫，想必效能問題都已解決。</p>
<hr>
<ul>
<li>KD BRH AC(0.2s, 10 MB)</li>
<li>PBDS + SPLAY AC(0.3s, 38 MB)</li>
<li>PBDS + SGI rope AC(0.5s, 41 MB)<br>本機 MINGW gcc 4.9 c++ 11 編譯完運行最大的測資需要 20 倍慢於其他寫法，但是上傳到 ZJ 的 gcc 7 又追回去了。於是下載 CYGWIN gcc 7 測試結果與 ZJ 運行結果相當，對於需要調適的人，建議在新版上測試。</li>
</ul>
<p>用 splay tree 模擬 rope 的時候，會遇到循序非遞減的走訪，這時候若不斷地旋轉至根，會在之後的操作造成退化，常數稍微大一點，雖然在迭代過程中造就好的快取效能，很快地在 <span>$\mathcal{O}(1)$</span><!-- Has MathJax --> 訪問到相鄰的節點，卻在下一次的插入/刪除操作中變慢。一些變異的版本中，如只在插入/刪除操作中旋轉至根，在查找操作中不旋轉，或者限制旋轉的深度。雖然有一些特別的退化操作，splay 仍舊是某些 OS 場景中使用的資料結構，現實總是很特別的。</p>
<blockquote><p>In 2000, Danny Sleator and Robert Tarjan won the ACM Kanellakis Theory and Practice Award for their papers on splay trees and amortized analysis.  Splay trees are used in Windows NT (in the virtual memory, networking, and file system code), the gcc compiler and GNU C++ library, the sed string editor, Fore Systems network routers, the most popular implementation of Unix malloc, Linux loadable kernel modules, and in much other software.</p>
<footer><strong>Berkeley eecs April 23, 2014</strong><cite><a href="https://people.eecs.berkeley.edu/~jrs/61b/lec/36" target="_blank" rel="external">people.eecs.berkeley.edu/~jrs/61b/lec/36</a></cite></footer></blockquote>
<h3 id="PBDS-SPLAY"><a href="#PBDS-SPLAY" class="headerlink" title="PBDS + SPLAY"></a>PBDS + SPLAY</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ext/pb_ds/assoc_container.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ext/pb_ds/tree_policy.hpp&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> __gnu_pbds;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Mesh</span> &#123;</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1e5</span> + <span class="number">5</span>;</div><div class="line">    <span class="keyword">int</span> pt[MAXN][<span class="number">2</span>];</div><div class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; X;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;pt[i][<span class="number">0</span>], &amp;pt[i][<span class="number">1</span>]);</div><div class="line">        X.clear(); X.reserve(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            X.push_back(pt[i][<span class="number">0</span>]);</div><div class="line">        sort(X.begin(), X.end());</div><div class="line">        X.erase(unique(X.begin(), X.end()), X.end());</div><div class="line">    &#125;</div><div class="line">&#125; mesh;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplayTree</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></div><div class="line">        Node *ch[<span class="number">2</span>], *fa;</div><div class="line">        <span class="keyword">int</span> size; <span class="keyword">int</span> data;</div><div class="line">        Node() &#123;</div><div class="line">            ch[<span class="number">0</span>] = ch[<span class="number">1</span>] = fa = <span class="literal">NULL</span>;</div><div class="line">            size = <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">is_root</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> fa-&gt;ch[<span class="number">0</span>] != <span class="keyword">this</span> &amp;&amp; fa-&gt;ch[<span class="number">1</span>] != <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    Node *root, *EMPTY;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">(Node *u)</span> </span>&#123;&#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (u-&gt;ch[<span class="number">0</span>] != EMPTY)	pushdown(u-&gt;ch[<span class="number">0</span>]);</div><div class="line">        <span class="keyword">if</span> (u-&gt;ch[<span class="number">1</span>] != EMPTY)	pushdown(u-&gt;ch[<span class="number">1</span>]);</div><div class="line">        u-&gt;size = <span class="number">1</span> + u-&gt;ch[<span class="number">0</span>]-&gt;size + u-&gt;ch[<span class="number">1</span>]-&gt;size;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setch</span><span class="params">(Node *p, Node *u, <span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (p != EMPTY)	p-&gt;ch[i] = u;</div><div class="line">        <span class="keyword">if</span> (u != EMPTY)	u-&gt;fa = p;</div><div class="line">    &#125;</div><div class="line">    SplayTree() &#123;</div><div class="line">        EMPTY = <span class="keyword">new</span> Node();</div><div class="line">        EMPTY-&gt;fa = EMPTY-&gt;ch[<span class="number">0</span>] = EMPTY-&gt;ch[<span class="number">1</span>] = EMPTY;</div><div class="line">        EMPTY-&gt;size = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        root = EMPTY;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</div><div class="line">        Node *u = <span class="keyword">new</span> Node();</div><div class="line">        u-&gt;fa = u-&gt;ch[<span class="number">0</span>] = u-&gt;ch[<span class="number">1</span>] = EMPTY;</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rotate</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        Node *y;</div><div class="line">        <span class="keyword">int</span> d;</div><div class="line">        y = x-&gt;fa, d = y-&gt;ch[<span class="number">1</span>] == x ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">        x-&gt;ch[d^<span class="number">1</span>]-&gt;fa = y, y-&gt;ch[d] = x-&gt;ch[d^<span class="number">1</span>];</div><div class="line">        x-&gt;ch[d^<span class="number">1</span>] = y;</div><div class="line">        <span class="keyword">if</span> (!y-&gt;is_root())</div><div class="line">            y-&gt;fa-&gt;ch[y-&gt;fa-&gt;ch[<span class="number">1</span>] == y] = x;</div><div class="line">        x-&gt;fa = y-&gt;fa, y-&gt;fa = x;</div><div class="line">        pushup(y);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deal</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!x-&gt;is_root())	deal(x-&gt;fa);</div><div class="line">        pushdown(x);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">(Node *x, Node *below)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (x == EMPTY)	<span class="keyword">return</span> ;</div><div class="line">        Node *y, *z;</div><div class="line">        deal(x);</div><div class="line">        <span class="keyword">while</span> (!x-&gt;is_root() &amp;&amp; x-&gt;fa != below) &#123;</div><div class="line">            y = x-&gt;fa, z = y-&gt;fa;</div><div class="line">            <span class="keyword">if</span> (!y-&gt;is_root() &amp;&amp; y-&gt;fa != below) &#123;</div><div class="line">                <span class="keyword">if</span> (y-&gt;ch[<span class="number">0</span>] == x ^ z-&gt;ch[<span class="number">0</span>] == y)</div><div class="line">                    rotate(x);</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    rotate(y);</div><div class="line">            &#125;</div><div class="line">            rotate(x);</div><div class="line">        &#125;</div><div class="line">        pushup(x);</div><div class="line">        <span class="keyword">if</span> (x-&gt;fa == EMPTY)	root = x;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">prevNode</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        splay(u, EMPTY);</div><div class="line">        <span class="keyword">return</span> maxNode(u-&gt;ch[<span class="number">0</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">nextNode</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        splay(u, EMPTY);</div><div class="line">        <span class="keyword">return</span> minNode(u-&gt;ch[<span class="number">1</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">minNode</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        Node *p = u-&gt;fa;</div><div class="line">        <span class="keyword">for</span> (; pushdown(u), u-&gt;ch[<span class="number">0</span>] != EMPTY; u = u-&gt;ch[<span class="number">0</span>]);</div><div class="line">        splay(u, p);</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">maxNode</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        Node *p = u-&gt;fa;</div><div class="line">        <span class="keyword">for</span> (; pushdown(u), u-&gt;ch[<span class="number">1</span>] != EMPTY; u = u-&gt;ch[<span class="number">1</span>]);</div><div class="line">        splay(u, p);</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">findPos</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123; <span class="comment">// [0...]</span></div><div class="line">        <span class="keyword">for</span> (Node *u = root; u != EMPTY;) &#123;</div><div class="line">            pushdown(u);</div><div class="line">            <span class="keyword">int</span> t = u-&gt;ch[<span class="number">0</span>]-&gt;size;</div><div class="line">            <span class="keyword">if</span> (t == pos) &#123;</div><div class="line">                splay(u, EMPTY);</div><div class="line">                <span class="keyword">return</span> u;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (t &gt; pos)</div><div class="line">                u = u-&gt;ch[<span class="number">0</span>];</div><div class="line">            <span class="keyword">else</span></div><div class="line">                u = u-&gt;ch[<span class="number">1</span>], pos -= t + <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> EMPTY;</div><div class="line">    &#125;</div><div class="line">    tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; insert(<span class="keyword">int</span> data, <span class="keyword">int</span> pos) &#123;	<span class="comment">// make [pos] = data</span></div><div class="line">        Node *p, *q = findPos(pos);</div><div class="line">        Node *x = newNode(); x-&gt;data = data;</div><div class="line">        <span class="keyword">if</span> (q == EMPTY) &#123;</div><div class="line">            p = maxNode(root), splay(p, EMPTY);</div><div class="line">            setch(x, p, <span class="number">0</span>);</div><div class="line">            splay(x, EMPTY);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            splay(q, EMPTY), p = q-&gt;ch[<span class="number">0</span>];</div><div class="line">            setch(x, p, <span class="number">0</span>), setch(x, q, <span class="number">1</span>);</div><div class="line">            setch(q, EMPTY, <span class="number">0</span>);</div><div class="line">            splay(q, EMPTY);</div><div class="line">            p = prevNode(x);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (p == EMPTY)	p = maxNode(root);</div><div class="line">        <span class="keyword">if</span> (q == EMPTY)	q = minNode(root);</div><div class="line">        <span class="keyword">return</span> make_tuple(p-&gt;data, data, q-&gt;data);</div><div class="line">    &#125;</div><div class="line">    tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; remove(<span class="keyword">int</span> pos) &#123;</div><div class="line">        Node *x = findPos(pos), *p, *q;</div><div class="line">        p = prevNode(x), q = nextNode(x);</div><div class="line">        <span class="keyword">if</span> (p != EMPTY &amp;&amp; q != EMPTY) &#123;</div><div class="line">            setch(p, q, <span class="number">1</span>);</div><div class="line">            p-&gt;fa = EMPTY, splay(q, EMPTY);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p != EMPTY) &#123;</div><div class="line">            p-&gt;fa = EMPTY, root = p;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            q-&gt;fa = EMPTY, root = q;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> del = x-&gt;data;</div><div class="line">        <span class="keyword">delete</span> x;</div><div class="line">        <span class="keyword">if</span> (p == EMPTY)	p = maxNode(root);</div><div class="line">        <span class="keyword">if</span> (q == EMPTY)	q = minNode(root);</div><div class="line">        <span class="keyword">return</span> make_tuple(p-&gt;data, del, q-&gt;data);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> root == EMPTY ? <span class="number">0</span> : root-&gt;size;</div><div class="line">    &#125;</div><div class="line">&#125; mlist;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pt</span> &#123;</span></div><div class="line">    <span class="keyword">double</span> x, y;</div><div class="line">    Pt() &#123;&#125;</div><div class="line">    Pt(<span class="keyword">int</span> xy[]):Pt(xy[<span class="number">0</span>], xy[<span class="number">1</span>]) &#123;&#125;</div><div class="line">    Pt(<span class="keyword">double</span> x, <span class="keyword">double</span> y):x(x), y(y) &#123;&#125;</div><div class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Pt &amp;o) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">if</span> (x != o.x)	<span class="keyword">return</span> x &lt; o.x;</div><div class="line">        <span class="keyword">return</span> y &lt; o.y;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PtP</span> &#123;</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">double</span> x;</div><div class="line">    Pt p, q;</div><div class="line">    PtP(Pt a, Pt b) &#123;</div><div class="line">        p = a, q = b;</div><div class="line">        <span class="keyword">if</span> (q &lt; p)</div><div class="line">            swap(p, q);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">double</span> <span class="title">interpolate</span><span class="params">(<span class="keyword">const</span> Pt&amp; p1, <span class="keyword">const</span> Pt&amp; p2, <span class="keyword">double</span>&amp; x)</span> <span class="keyword">const</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (p1.x == p2.x) <span class="keyword">return</span> min(p1.y, p2.y);</div><div class="line">        <span class="keyword">return</span> p1.y + (p2.y - p1.y) / (p2.x - p1.x) * (x - p1.x);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> PtP &amp;o) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">return</span> interpolate(p, q, x) &lt; interpolate(o.p, o.q, x);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="keyword">double</span> PtP::x = <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SegSeg</span> &#123;</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></div><div class="line">        Node *lson, *rson;</div><div class="line">        tree&lt;pair&lt;PtP, <span class="keyword">int</span>&gt;, null_type, less&lt;pair&lt;PtP, <span class="keyword">int</span>&gt;&gt;, rb_tree_tag, tree_order_statistics_node_update&gt; segs;</div><div class="line">        Node() &#123;</div><div class="line">            lson = rson = <span class="literal">NULL</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    Node *root;</div><div class="line">    <span class="keyword">int</span> xn;</div><div class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Node();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">freeNode</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        <span class="built_in">free</span>(u);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        root = <span class="literal">NULL</span>;</div><div class="line">        xn = mesh.X.size();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> p, q, r; tie(p, q, r) = e;</div><div class="line">        remove(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;PtP(Pt(mesh.pt[p]), Pt(mesh.pt[r])), r&#125;);</div><div class="line">        insert(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;PtP(Pt(mesh.pt[p]), Pt(mesh.pt[q])), q&#125;);</div><div class="line">        insert(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;PtP(Pt(mesh.pt[q]), Pt(mesh.pt[r])), r&#125;);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> p, q, r; tie(p, q, r) = e;</div><div class="line">        remove(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;PtP(Pt(mesh.pt[p]), Pt(mesh.pt[q])), q&#125;);</div><div class="line">        remove(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;PtP(Pt(mesh.pt[q]), Pt(mesh.pt[r])), r&#125;);</div><div class="line">        insert(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;PtP(Pt(mesh.pt[p]), Pt(mesh.pt[r])), r&#125;);</div><div class="line">    &#125;	</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">inside</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</div><div class="line">        PtP::x = x;</div><div class="line">        <span class="keyword">return</span> count(root, <span class="number">0</span>, xn<span class="number">-1</span>, x, y)&amp;<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">count</span><span class="params">(Node* u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> ((mesh.X[l] &gt; x) != (mesh.X[r] &gt; x))</div><div class="line">            ret += u-&gt;segs.order_of_key(&#123;PtP(Pt(x, y), Pt(x, y)), <span class="number">-1</span>&#125;);</div><div class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</div><div class="line">        <span class="keyword">if</span> (x &lt;= mesh.X[m])</div><div class="line">            ret += count(u-&gt;lson, l, m, x, y);</div><div class="line">        <span class="keyword">if</span> (x &gt;= mesh.X[m])</div><div class="line">            ret += count(u-&gt;rson, m, r, x, y);</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (s.first.p.x != s.first.q.x)</div><div class="line">            insert(root, l, r, s);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (s.first.p.x != s.first.q.x)</div><div class="line">            remove(root, l, r, s);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</div><div class="line">            u = newNode();</div><div class="line">        <span class="keyword">if</span> (s.first.p.x &lt;= mesh.X[l] &amp;&amp; mesh.X[r] &lt;= s.first.q.x) &#123;</div><div class="line">            PtP::x = (mesh.X[l] + mesh.X[r])/<span class="number">2.0</span>;</div><div class="line">            u-&gt;segs.insert(s);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</div><div class="line">        <span class="keyword">if</span> (s.first.q.x &lt;= mesh.X[m])			insert(u-&gt;lson, l, m, s);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s.first.p.x &gt;= mesh.X[m])	insert(u-&gt;rson, m, r, s);</div><div class="line">        <span class="keyword">else</span>	insert(u-&gt;lson, l, m, s), insert(u-&gt;rson, m, r, s);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(Node* u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">if</span> (s.first.p.x &lt;= mesh.X[l] &amp;&amp; mesh.X[r] &lt;= s.first.q.x) &#123;</div><div class="line">            PtP::x = (mesh.X[l] + mesh.X[r])/<span class="number">2.0</span>;</div><div class="line">            u-&gt;segs.erase(s);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</div><div class="line">        <span class="keyword">if</span> (s.first.q.x &lt;= mesh.X[m])			remove(u-&gt;lson, l, m, s);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s.first.p.x &gt;= mesh.X[m])	remove(u-&gt;rson, m, r, s);</div><div class="line">        <span class="keyword">else</span>	remove(u-&gt;lson, l, m, s), remove(u-&gt;rson, m, r, s);</div><div class="line">    &#125;</div><div class="line">&#125; mbrh;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m, cmd, x, pos;</div><div class="line">    <span class="keyword">double</span> px, py;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m);</div><div class="line">    mesh.read(n);</div><div class="line">    mlist.init(), mbrh.init();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;cmd);</div><div class="line">        <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;x, &amp;pos);</div><div class="line">            mbrh.insert(mlist.insert(x, pos));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;x);</div><div class="line">            mbrh.remove(mlist.remove(x));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%lf %lf"</span>, &amp;px, &amp;py);</div><div class="line">            <span class="built_in">puts</span>(mbrh.inside(px, py) ? <span class="string">"1"</span> : <span class="string">"0"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="PBDS-ROPE"><a href="#PBDS-ROPE" class="headerlink" title="PBDS + ROPE"></a>PBDS + ROPE</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ext/rope&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> __gnu_cxx;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ext/pb_ds/assoc_container.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ext/pb_ds/tree_policy.hpp&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> __gnu_pbds;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Mesh</span> &#123;</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1e5</span> + <span class="number">5</span>;</div><div class="line">    <span class="keyword">int</span> pt[MAXN][<span class="number">2</span>];</div><div class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; X;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;pt[i][<span class="number">0</span>], &amp;pt[i][<span class="number">1</span>]);</div><div class="line">        X.clear(); X.reserve(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            X.push_back(pt[i][<span class="number">0</span>]);</div><div class="line">        sort(X.begin(), X.end());</div><div class="line">        X.erase(unique(X.begin(), X.end()), X.end());</div><div class="line">    &#125;</div><div class="line">&#125; mesh;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rope</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    rope&lt;<span class="keyword">int</span>&gt; r;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        r.clear();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">next</span><span class="params">(rope&lt;<span class="keyword">int</span>&gt;::const_iterator it)</span> </span>&#123;</div><div class="line">        it++;</div><div class="line">        <span class="keyword">if</span> (it == r.end())</div><div class="line">            <span class="keyword">return</span> *r.begin();</div><div class="line">        <span class="keyword">return</span> *it;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">prev</span><span class="params">(rope&lt;<span class="keyword">int</span>&gt;::const_iterator it)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (it == r.begin())</div><div class="line">            <span class="keyword">return</span> *r.rbegin();</div><div class="line">        it--;</div><div class="line">        <span class="keyword">return</span> *it;</div><div class="line">    &#125;</div><div class="line">    tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; insert(<span class="keyword">int</span> data, <span class="keyword">int</span> pos) &#123;</div><div class="line">        r.insert(pos, data);</div><div class="line">        <span class="keyword">auto</span> it = r.begin() + pos;</div><div class="line">        <span class="keyword">int</span> p = prev(it);</div><div class="line">        <span class="keyword">int</span> q = next(it);</div><div class="line">        <span class="keyword">return</span> make_tuple(p, data, q);</div><div class="line">    &#125;</div><div class="line">    tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; remove(<span class="keyword">int</span> pos) &#123;</div><div class="line">        <span class="keyword">auto</span> it = r.begin() + pos;</div><div class="line">        <span class="keyword">int</span> del = *it;</div><div class="line">        <span class="keyword">int</span> p = prev(it);</div><div class="line">        <span class="keyword">int</span> q = next(it);</div><div class="line">        r.erase(pos, <span class="number">1</span>);</div><div class="line">        <span class="keyword">return</span> make_tuple(p, del, q);</div><div class="line">    &#125;</div><div class="line">&#125; mlist;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pt</span> &#123;</span></div><div class="line">    <span class="keyword">double</span> x, y;</div><div class="line">    Pt() &#123;&#125;</div><div class="line">    Pt(<span class="keyword">int</span> xy[]):Pt(xy[<span class="number">0</span>], xy[<span class="number">1</span>]) &#123;&#125;</div><div class="line">    Pt(<span class="keyword">double</span> x, <span class="keyword">double</span> y):x(x), y(y) &#123;&#125;</div><div class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Pt &amp;o) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">if</span> (x != o.x)	<span class="keyword">return</span> x &lt; o.x;</div><div class="line">        <span class="keyword">return</span> y &lt; o.y;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PtP</span> &#123;</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">double</span> x;</div><div class="line">    Pt p, q;</div><div class="line">    PtP(Pt a, Pt b) &#123;</div><div class="line">        p = a, q = b;</div><div class="line">        <span class="keyword">if</span> (q &lt; p)</div><div class="line">            swap(p, q);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">double</span> <span class="title">interpolate</span><span class="params">(<span class="keyword">const</span> Pt&amp; p1, <span class="keyword">const</span> Pt&amp; p2, <span class="keyword">double</span>&amp; x)</span> <span class="keyword">const</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (p1.x == p2.x) <span class="keyword">return</span> min(p1.y, p2.y);</div><div class="line">        <span class="keyword">return</span> p1.y + (p2.y - p1.y) / (p2.x - p1.x) * (x - p1.x);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> PtP &amp;o) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">return</span> interpolate(p, q, x) &lt; interpolate(o.p, o.q, x);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="keyword">double</span> PtP::x = <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SegSeg</span> &#123;</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></div><div class="line">        Node *lson, *rson;</div><div class="line">        tree&lt;pair&lt;PtP, <span class="keyword">int</span>&gt;, null_type, less&lt;pair&lt;PtP, <span class="keyword">int</span>&gt;&gt;, rb_tree_tag, tree_order_statistics_node_update&gt; segs;</div><div class="line">        Node() &#123;</div><div class="line">            lson = rson = <span class="literal">NULL</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    Node *root;</div><div class="line">    <span class="keyword">int</span> xn;</div><div class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Node();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        root = <span class="literal">NULL</span>;</div><div class="line">        xn = mesh.X.size();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> p, q, r; tie(p, q, r) = e;</div><div class="line">        remove(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;PtP(Pt(mesh.pt[p]), Pt(mesh.pt[r])), r&#125;);</div><div class="line">        insert(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;PtP(Pt(mesh.pt[p]), Pt(mesh.pt[q])), q&#125;);</div><div class="line">        insert(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;PtP(Pt(mesh.pt[q]), Pt(mesh.pt[r])), r&#125;);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> p, q, r; tie(p, q, r) = e;</div><div class="line">        remove(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;PtP(Pt(mesh.pt[p]), Pt(mesh.pt[q])), q&#125;);</div><div class="line">        remove(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;PtP(Pt(mesh.pt[q]), Pt(mesh.pt[r])), r&#125;);</div><div class="line">        insert(<span class="number">0</span>, xn<span class="number">-1</span>, &#123;PtP(Pt(mesh.pt[p]), Pt(mesh.pt[r])), r&#125;);</div><div class="line">    &#125;	</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">inside</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</div><div class="line">        PtP::x = x;</div><div class="line">        <span class="keyword">return</span> count(root, <span class="number">0</span>, xn<span class="number">-1</span>, x, y)&amp;<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">count</span><span class="params">(Node* u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> ((mesh.X[l] &gt; x) != (mesh.X[r] &gt; x))</div><div class="line">            ret += u-&gt;segs.order_of_key(&#123;PtP(Pt(x, y), Pt(x, y)), <span class="number">-1</span>&#125;);</div><div class="line">        <span class="keyword">if</span> (l == r)</div><div class="line">            <span class="keyword">return</span> ret;</div><div class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</div><div class="line">        <span class="keyword">if</span> (x &lt;= mesh.X[m])</div><div class="line">            ret += count(u-&gt;lson, l, m, x, y);</div><div class="line">        <span class="keyword">if</span> (x &gt;= mesh.X[m])</div><div class="line">            ret += count(u-&gt;rson, m, r, x, y);</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (s.first.p.x != s.first.q.x)</div><div class="line">            insert(root, l, r, s);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (s.first.p.x != s.first.q.x)</div><div class="line">            remove(root, l, r, s);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</div><div class="line">            u = newNode();</div><div class="line">        <span class="keyword">if</span> (s.first.p.x &lt;= mesh.X[l] &amp;&amp; mesh.X[r] &lt;= s.first.q.x) &#123;</div><div class="line">            PtP::x = (mesh.X[l] + mesh.X[r])/<span class="number">2.0</span>;</div><div class="line">            u-&gt;segs.insert(s);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (l == r)</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</div><div class="line">        <span class="keyword">if</span> (s.first.q.x &lt;= mesh.X[m])			insert(u-&gt;lson, l, m, s);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s.first.p.x &gt;= mesh.X[m])	insert(u-&gt;rson, m, r, s);</div><div class="line">        <span class="keyword">else</span>	insert(u-&gt;lson, l, m, s), insert(u-&gt;rson, m, r, s);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> l, <span class="keyword">int</span> r, pair&lt;PtP, <span class="keyword">int</span>&gt; s)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (u == <span class="literal">NULL</span>)</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">if</span> (s.first.p.x &lt;= mesh.X[l] &amp;&amp; mesh.X[r] &lt;= s.first.q.x) &#123;</div><div class="line">            PtP::x = (mesh.X[l] + mesh.X[r])/<span class="number">2.0</span>;</div><div class="line">            u-&gt;segs.erase(s);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (l == r)</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">int</span> m = (l+r)/<span class="number">2</span>;</div><div class="line">        <span class="keyword">if</span> (s.first.q.x &lt;= mesh.X[m])			remove(u-&gt;lson, l, m, s);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s.first.p.x &gt;= mesh.X[m])	remove(u-&gt;rson, m, r, s);</div><div class="line">        <span class="keyword">else</span>	remove(u-&gt;lson, l, m, s), remove(u-&gt;rson, m, r, s);</div><div class="line">    &#125;</div><div class="line">&#125; mbrh;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m, cmd, x, pos;</div><div class="line">    <span class="keyword">double</span> px, py;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m);</div><div class="line">    mesh.read(n);</div><div class="line">    mlist.init(), mbrh.init();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;cmd);</div><div class="line">        <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;x, &amp;pos);</div><div class="line">            mbrh.insert(mlist.insert(x, pos));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;x);</div><div class="line">            mbrh.remove(mlist.remove(x));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%lf %lf"</span>, &amp;px, &amp;py);</div><div class="line">            <span class="built_in">puts</span>(mbrh.inside(px, py) ? <span class="string">"1"</span> : <span class="string">"0"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-diary-201901" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/27/diary-201901/" class="article-date">
  <time datetime="2019-01-27T10:57:20.000Z" itemprop="datePublished">2019-01-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/手札日記/">手札日記</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="https://i.imgur.com/Klod0Cb.jpg" rel="gallery_ckxtxqs7f00a3gkvnc7xlaig7">
        <img src="https://i.imgur.com/Klod0Cb.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/27/diary-201901/">敲落的聲響</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2019/01/27/diary-201901/" data-id="ckxtxqs7f00a3gkvnc7xlaig7" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2019/01/27/diary-201901/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="那一刻"><a href="#那一刻" class="headerlink" title="那一刻"></a>那一刻</h2><p>2019 年的開始，研發替代役過去一年三個月，迎來人生巔峰的二十五歲。曾經努力積賺的學習，在這個當下不斷地被提取，已經無法再次追逐那夢想中的人生，那等跨不過的門檻，對於不斷地分析計算的我，早已算不出任何的可能性。</p>
<p><img src="https://i.imgur.com/zfcbnb3.jpg" alt="「全新投入工作中，過著非常平凡順遂的生活。監視著表面的自己是否有不斷地往前進，責怪著那個自己，為什麼沒有好好面對眼前的重要事物。」－《秒速 5 厘米》"></p>
<p>倘若停止督促自己這般前進的動力，又如何面對過去，原本希望在未來有所成就的自己。也許要有所改變，正也因為過去的累積才造就現在的我，如果可以這麼輕易地改變，那思考方式就像徹底換了個人似的，四分五裂。</p>
<p><img src="https://i.imgur.com/SDGBwqx.jpg" alt="「過去，一直抱持著專一的新。對於無法維持這種想法的自己，一直以來都無法釋懷。」－《秒速 5 厘米》"></p>
<p>即使有了工作，認識了新的同事，那無非也只是個工作，社交禮儀下的對談。彼此之間都過著各自的生活，每當論及自己的話題時，總是不知道要從哪裡找出，不受蜚言蜚語的內容。因為總是過著這樣的生活，每天走著兩點一線的路線，不曾偏離的軌跡要怎麼聊著好幾個日子。</p>
<p>要在外頭活出有趣的日子，那是如此困難的題目，每踏一步就是數以百萬的分枝，一個人也許走到哪算到哪，但總是無法歸納一個「樂」的結語。編出讓其他人能夠理解的話語，不斷地瞞騙自己，事實上並沒有這樣子的感受吧。我們之間並沒有好聊的，沒有交集的交流，就不要增添麻煩給彼此了。</p>
<p><img src="https://i.imgur.com/TBdU59l.jpg" alt="「總覺得…已經很久沒有跟人說過話了。」－《秒速 5 厘米》"></p>
<p>講講你喜歡的事情吧。無法輕易地說出喜歡，但從你們看來，擺明就是喜歡某些事情，才至於身邊都是這種事物的存在。這種老是亂下評論的人。若從口中道出「喜歡」兩個字，是否又可以增加對方強而有力的定論。身邊只有那些選項時，也只能從那些裡選，不斷地選了下去，那還能稱作「喜歡」的事物，而不是受到「束縛」的體現嗎？</p>
<p><img src="https://i.imgur.com/9USt2Yi.jpg" alt="「&quot;喜歡&quot; 是一個束縛的詞」－《終將成為你》"></p>
<h2 id="前一刻"><a href="#前一刻" class="headerlink" title="前一刻"></a>前一刻</h2><p>投入工作的那一年裡，不斷地翻盤革新，交付著重大包袱，那些面臨到不得不再次攤開的問題，早已沒有人可以述說那段歷史，而現在束手無撤的工程師們，無疑地想邁向全新的架構，到底要怎麼寫才可以銜接原本的需求，有多少人願意花時間去理解，而又有多少人願意花時間等你，不斷地估算那種看不到結局的日子有多遠，又細數著下一個里程有多近。那種龐大的壓迫，能不斷地走出下一步的策略在哪？</p>
<p><img src="https://i.imgur.com/JNNgnuJ.jpg" alt="「我該成為怎樣的人，來度過餘生」－《終將成為你》"></p>
<p>把畢生所學的技術填充進去，那樣就可以解決了嗎？發現有所缺陷的解法，想著問題以不同方式分解，再以不同方式擊破。想不出來就去休息吧。解解別的題目，再回來思考，重置於不同狀態的思維出發，就有機會看到問題的另一面。</p>
<p>然而，過著不斷轉換的日子，發現也來到了三千五百題，這令人羞於心的數字，表示了閒與宅的程度。而真正聰明的人，理應用最少的工具解決最多的問題，也就是以最少的題數，達成最好的成就。試圖從那些題目中淬煉新想法，果然還太愚笨了些，僅僅只是知道的比人多，卻沒有好好地比任何人都深入了解。</p>
<p><img src="https://i.imgur.com/RclLca4.jpg" alt="「但是我沒辦法在其他人面前，不做特別的自己」－《終將成為你》"></p>
<h2 id="下一刻"><a href="#下一刻" class="headerlink" title="下一刻"></a>下一刻</h2><p>一年的過去，收到一些學長們的問候，馬上就猜到是來拉人換工作的。現在的我，有那種能力獲得青睞嗎？而現在的位子，是否只是被人感受到這傢伙堪用？算了一算，那些提及的工作內容與薪水，到底以什麼樣的比例才算活得心安，能否不為了下一個日子前進而煩惱。原本應屬於我的日子，是哪一種？</p>
<p><img src="https://i.imgur.com/hrj6F6r.png" alt="「雖然很遺憾，才能這種東西是有個體差別的，若用鳥類來舉例，我的羽翼是靠腳踏驅動的那種」－《３月的獅子》"></p>
<p><img src="https://i.imgur.com/YldpTdf.png" alt="「如果，不像惡鬼般地逼迫自己，滿身大汗地蹬下去，一瞬間就會墜落地面」－《３月的獅子》"></p>
<p><img src="https://i.imgur.com/LQ2uoXb.png" alt="「如果停止蹬踏的話，若是將能量用再其他的事情上面，就算只是百分之幾，雖不至於墜下去，高度也會降低」－《３月的獅子》"></p>
<p>親人、同學、同事，每一個像是完成里程碑地一一度過了關卡，看到自己的下一關只剩下工作，也不知道工作的下一步是為了生活，而生活要去煩惱工作。如果只是這樣子不斷地循環，定義的輪廓已有了雛形，明瞭一切的那時也到了盡頭。如此地羨慕有目標走到下一步，而我只是在等待事情的落幕。</p>
<p>現在的處境到底是雞生蛋，還是蛋生雞？</p>
<p><img src="https://i.imgur.com/lTzsB7v.jpg" alt="「我們要一直活下去哦」－《盾之勇者成名錄》"></p>
<p><img src="https://i.imgur.com/5nx7lkn.jpg" alt="「我接受了現實，回歸平靜」－《我想吃掉你的胰臟》"></p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-mproblem-dynamic-point-in-polygon" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/26/mproblem-dynamic-point-in-polygon/" class="article-date">
  <time datetime="2019-01-26T12:49:22.000Z" itemprop="datePublished">2019-01-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/26/mproblem-dynamic-point-in-polygon/">動態幾何 史蒂芙的泡泡  (解法 1)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2019/01/26/mproblem-dynamic-point-in-polygon/" data-id="ckxtxqs7u00b6gkvne2hx0k3d" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2019/01/26/mproblem-dynamic-point-in-polygon/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BRH/">BRH</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Splay-tree/">Splay tree</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kd-tree/">kd-tree</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/射線法/">射線法</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>題目描述請至 Zerojudge e021: 史蒂芙的泡泡 查閱詳細內容</p>
</blockquote>
<h2 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h2><p>在處理完數以百計的政事後，受盡折磨的史蒂芙，打算回家好好地休息。 拖著疲倦的身軀，再也無法再容納任何一點複雜計算。從王宮走回寢居的路上， 發現身邊所見的事物都不再圓滑，看起來就像是粗糙的幾何多邊形構成的一切。</p>
<p>打算享受著泡泡浴的史蒂芙，看著眼前的多邊形泡泡，失去原本應有的色澤，那透涼的心境更蒙上了一層灰影</p>
<p>「為什麼是我呢？」感嘆道</p>
<p>伸出手戳著眼前的泡泡，卻飄了過去</p>
<p>「區區的泡泡也跟我作對，嗚嗚」</p>
<p>將一個泡泡視為一個簡單多邊形 <span>$A$</span><!-- Has MathJax -->，方便起見用一個序列 <span>$a_0, a_1, ..., a_{n-1}$</span><!-- Has MathJax --> 表示多邊形 <span>$A$</span><!-- Has MathJax --> 的每一個頂點，則會有 <span>$n$</span><!-- Has MathJax --> 個線段 <span>$\overline{a_0 a_1}, \overline{a_1 a_2}, \cdots, \overline{a_{n-1} a_0}$</span><!-- Has MathJax -->。</p>
<h2 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h2><p>從能找到的論文「A Unified Approach to Dynamic Point Location, Ray Shooting, and Shortest Paths in Planar Maps」 得知操作更新 <span>$\mathcal{O}(\log^3 n)$</span><!-- Has MathJax -->，詢問操作 <span>$\mathcal{O}(\log n)$</span><!-- Has MathJax -->，這一個實作難度估計沒辦法在 10K 限制下完成 (代碼上傳長度上限)。</p>
<p>從動態梯形剖分開始，複雜度就相當高了，而論文後要有類似輕重鏈剖分的概念，將對偶圖產生的節點以輕重邊保存，接著再維護雙線輪廓，讓相連的連續重邊可以保存左右兩側的輪廓，… 資訊量龐大，想到一些可能未提及的邊界案例，實作相當困難。而從其他題目的經驗中，當設計到 <span>$\mathcal{O}(\log^2 n)$</span><!-- Has MathJax --> 的操作時，由於操作常數大，運行時間可能無法匹敵 <span>$\mathcal{O}(\sqrt{n})$</span><!-- Has MathJax --> 的算法。</p>
<p>那麼有沒有其他的替代方案，只需要跑得比暴力法還要快就行？特別小心，暴力法找一個點是否在多邊形內，需要 <span>$\mathcal{O}(n)$</span><!-- Has MathJax --> 的時間，且快取效果非常好，很容易做到 SIMD 的平行技術。</p>
<p>首先，解決維護多邊形點集序列，可以使用任何的平衡樹完成，若採用 splay tree 在均攤 <span>$\text{Amortized} \; \mathcal{O}(\log n)$</span><!-- Has MathJax -->。使用 treap 也可以完成這類操作，還可以做到額外的持久化功能。接著，修改點的操作，可以轉換成替換一個點的下一個點，因此將點放在 KD tree 上，而維護下一個點相當於把每一個節點擴充成 BRH。</p>
<p>接著，當解決點是否在多邊形內時，可走訪 BRH 找射線穿過的交點個數，此時複雜度至少為 <span>$\mathcal{O}(\sqrt{n} + k)$</span><!-- Has MathJax -->，其中 <span>$k$</span><!-- Has MathJax --> 為交點個數。我們可以額外維護多邊形的順逆時針來優化搜尋空間，最後一個接觸的線段方向，額外提供奇偶數來判斷該點是否在內側，然後把射線縮短到交點到詢問點之間。不斷地縮短搜尋空間下，大部分的情況為 <span>$\mathcal{O}(\sqrt{n})$</span><!-- Has MathJax -->，拋開了原本存在的 <span>$k$</span><!-- Has MathJax -->。</p>
<p>由於是封閉的簡單多邊形，所以當邊的疏密程度不一時，KD tree 轉換 BRH 會造成額外的負擔，bounding box 無法有效提供分割空間的功能。那麼在實際搜尋情況，額外走訪的節點與平面分布有關，這部分就不好分析。如果有更好的想法，歡迎分享。</p>
<p>現在實作動態 KD tree 必須有替罪羊樹 Scapegoat tree 的概念，再掛上 BRH 的想法，提供了相對有效率的動態方法來查詢點是否在多邊形內部。若把維護點序列的 splay tree 換成 treap，便可以做到持久化的動態幾何操作，這便是一開始想要的目標。</p>
<p>如果梯形剖分也可以持久化？暫時還不想去思考，那思考的容器要多大呢？</p>
<h2 id="參考解法"><a href="#參考解法" class="headerlink" title="參考解法"></a>參考解法</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Mesh</span> &#123;</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1e5</span> + <span class="number">5</span>;</div><div class="line">    <span class="keyword">int</span> pt[MAXN][<span class="number">2</span>];</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;pt[i][<span class="number">0</span>], &amp;pt[i][<span class="number">1</span>]);</div><div class="line">    &#125;</div><div class="line">&#125; mesh;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplayTree</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></div><div class="line">        Node *ch[<span class="number">2</span>], *fa;</div><div class="line">        <span class="keyword">int</span> size; <span class="keyword">int</span> data;</div><div class="line">        Node() &#123;</div><div class="line">            ch[<span class="number">0</span>] = ch[<span class="number">1</span>] = fa = <span class="literal">NULL</span>;</div><div class="line">            size = <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">is_root</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> fa-&gt;ch[<span class="number">0</span>] != <span class="keyword">this</span> &amp;&amp; fa-&gt;ch[<span class="number">1</span>] != <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    Node *root, *EMPTY;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">(Node *u)</span> </span>&#123;&#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (u-&gt;ch[<span class="number">0</span>] != EMPTY)	pushdown(u-&gt;ch[<span class="number">0</span>]);</div><div class="line">        <span class="keyword">if</span> (u-&gt;ch[<span class="number">1</span>] != EMPTY)	pushdown(u-&gt;ch[<span class="number">1</span>]);</div><div class="line">        u-&gt;size = <span class="number">1</span> + u-&gt;ch[<span class="number">0</span>]-&gt;size + u-&gt;ch[<span class="number">1</span>]-&gt;size;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setch</span><span class="params">(Node *p, Node *u, <span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (p != EMPTY)	p-&gt;ch[i] = u;</div><div class="line">        <span class="keyword">if</span> (u != EMPTY)	u-&gt;fa = p;</div><div class="line">    &#125;</div><div class="line">    SplayTree() &#123;</div><div class="line">        EMPTY = <span class="keyword">new</span> Node();</div><div class="line">        EMPTY-&gt;fa = EMPTY-&gt;ch[<span class="number">0</span>] = EMPTY-&gt;ch[<span class="number">1</span>] = EMPTY;</div><div class="line">        EMPTY-&gt;size = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        root = EMPTY;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</div><div class="line">        Node *u = <span class="keyword">new</span> Node();</div><div class="line">        u-&gt;fa = u-&gt;ch[<span class="number">0</span>] = u-&gt;ch[<span class="number">1</span>] = EMPTY;</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rotate</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        Node *y;</div><div class="line">        <span class="keyword">int</span> d;</div><div class="line">        y = x-&gt;fa, d = y-&gt;ch[<span class="number">1</span>] == x ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">        x-&gt;ch[d^<span class="number">1</span>]-&gt;fa = y, y-&gt;ch[d] = x-&gt;ch[d^<span class="number">1</span>];</div><div class="line">        x-&gt;ch[d^<span class="number">1</span>] = y;</div><div class="line">        <span class="keyword">if</span> (!y-&gt;is_root())</div><div class="line">            y-&gt;fa-&gt;ch[y-&gt;fa-&gt;ch[<span class="number">1</span>] == y] = x;</div><div class="line">        x-&gt;fa = y-&gt;fa, y-&gt;fa = x;</div><div class="line">        pushup(y);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deal</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!x-&gt;is_root())	deal(x-&gt;fa);</div><div class="line">        pushdown(x);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">(Node *x, Node *below)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (x == EMPTY)	<span class="keyword">return</span> ;</div><div class="line">        Node *y, *z;</div><div class="line">        deal(x);</div><div class="line">        <span class="keyword">while</span> (!x-&gt;is_root() &amp;&amp; x-&gt;fa != below) &#123;</div><div class="line">            y = x-&gt;fa, z = y-&gt;fa;</div><div class="line">            <span class="keyword">if</span> (!y-&gt;is_root() &amp;&amp; y-&gt;fa != below) &#123;</div><div class="line">                <span class="keyword">if</span> (y-&gt;ch[<span class="number">0</span>] == x ^ z-&gt;ch[<span class="number">0</span>] == y)</div><div class="line">                    rotate(x);</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    rotate(y);</div><div class="line">            &#125;</div><div class="line">            rotate(x);</div><div class="line">        &#125;</div><div class="line">        pushup(x);</div><div class="line">        <span class="keyword">if</span> (x-&gt;fa == EMPTY)	root = x;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">prevNode</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        splay(u, EMPTY);</div><div class="line">        <span class="keyword">return</span> maxNode(u-&gt;ch[<span class="number">0</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">nextNode</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        splay(u, EMPTY);</div><div class="line">        <span class="keyword">return</span> minNode(u-&gt;ch[<span class="number">1</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">minNode</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        Node *p = u-&gt;fa;</div><div class="line">        <span class="keyword">for</span> (; pushdown(u), u-&gt;ch[<span class="number">0</span>] != EMPTY; u = u-&gt;ch[<span class="number">0</span>]);</div><div class="line">        splay(u, p);</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">maxNode</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        Node *p = u-&gt;fa;</div><div class="line">        <span class="keyword">for</span> (; pushdown(u), u-&gt;ch[<span class="number">1</span>] != EMPTY; u = u-&gt;ch[<span class="number">1</span>]);</div><div class="line">        splay(u, p);</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">findPos</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123; <span class="comment">// [0...]</span></div><div class="line">        <span class="keyword">for</span> (Node *u = root; u != EMPTY;) &#123;</div><div class="line">            pushdown(u);</div><div class="line">            <span class="keyword">int</span> t = u-&gt;ch[<span class="number">0</span>]-&gt;size;</div><div class="line">            <span class="keyword">if</span> (t == pos) &#123;</div><div class="line">                splay(u, EMPTY);</div><div class="line">                <span class="keyword">return</span> u;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (t &gt; pos)</div><div class="line">                u = u-&gt;ch[<span class="number">0</span>];</div><div class="line">            <span class="keyword">else</span></div><div class="line">                u = u-&gt;ch[<span class="number">1</span>], pos -= t + <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> EMPTY;</div><div class="line">    &#125;</div><div class="line">    tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; insert(<span class="keyword">int</span> data, <span class="keyword">int</span> pos) &#123;	<span class="comment">// make [pos] = data</span></div><div class="line">        Node *p, *q = findPos(pos);</div><div class="line">        Node *x = newNode(); x-&gt;data = data;</div><div class="line">        <span class="keyword">if</span> (q == EMPTY) &#123;</div><div class="line">            p = maxNode(root), splay(p, EMPTY);</div><div class="line">            setch(x, p, <span class="number">0</span>);</div><div class="line">            splay(x, EMPTY);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            splay(q, EMPTY), p = q-&gt;ch[<span class="number">0</span>];</div><div class="line">            setch(x, p, <span class="number">0</span>), setch(x, q, <span class="number">1</span>);</div><div class="line">            setch(q, EMPTY, <span class="number">0</span>);</div><div class="line">            splay(q, EMPTY);</div><div class="line">            p = prevNode(x);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (p == EMPTY)	p = maxNode(root);</div><div class="line">        <span class="keyword">if</span> (q == EMPTY)	q = minNode(root);</div><div class="line">        <span class="keyword">return</span> make_tuple(p-&gt;data, data, q-&gt;data);</div><div class="line">    &#125;</div><div class="line">    tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; remove(<span class="keyword">int</span> pos) &#123;</div><div class="line">        Node *x = findPos(pos), *p, *q;</div><div class="line">        p = prevNode(x), q = nextNode(x);</div><div class="line">        <span class="keyword">if</span> (p != EMPTY &amp;&amp; q != EMPTY) &#123;</div><div class="line">            setch(p, q, <span class="number">1</span>);</div><div class="line">            p-&gt;fa = EMPTY, splay(q, EMPTY);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p != EMPTY) &#123;</div><div class="line">            p-&gt;fa = EMPTY, root = p;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            q-&gt;fa = EMPTY, root = q;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> del = x-&gt;data;</div><div class="line">        <span class="built_in">free</span>(x);</div><div class="line">        <span class="keyword">if</span> (p == EMPTY)	p = maxNode(root);</div><div class="line">        <span class="keyword">if</span> (q == EMPTY)	q = minNode(root);</div><div class="line">        <span class="keyword">return</span> make_tuple(p-&gt;data, del, q-&gt;data);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> root == EMPTY ? <span class="number">0</span> : root-&gt;size;</div><div class="line">    &#125;</div><div class="line">&#125; mlist;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">log2int</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">31</span> - __builtin_clz(x);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> int64_t <span class="title">h</span><span class="params">(<span class="keyword">int</span> p, <span class="keyword">int</span> q)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (<span class="keyword">int64_t</span>) mesh.pt[p][<span class="number">0</span>]*mesh.pt[q][<span class="number">1</span>] - (<span class="keyword">int64_t</span>) mesh.pt[p][<span class="number">1</span>]*mesh.pt[q][<span class="number">0</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">KDBRH</span> &#123;</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">double</span> ALPHA = <span class="number">0.75</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">double</span> LOG_ALPHA = log2(<span class="number">1.0</span> / ALPHA);</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Pt</span> &#123;</span></div><div class="line">        <span class="keyword">int</span> d[<span class="number">2</span>];</div><div class="line">        Pt() &#123;&#125;</div><div class="line">        Pt(<span class="keyword">int</span> xy[]):Pt(xy[<span class="number">0</span>], xy[<span class="number">1</span>]) &#123;&#125;</div><div class="line">        Pt(<span class="keyword">int</span> x, <span class="keyword">int</span> y) &#123;d[<span class="number">0</span>] = x, d[<span class="number">1</span>] = y;&#125;</div><div class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> Pt &amp;x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> d[<span class="number">0</span>] == x.d[<span class="number">0</span>] &amp;&amp; d[<span class="number">1</span>] == x.d[<span class="number">1</span>];</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">static</span> Pt <span class="title">NaN</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> Pt(INT_MIN, INT_MIN);&#125;</div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">isNaN</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> d[<span class="number">0</span>] == INT_MIN;&#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">PtP</span> &#123;</span></div><div class="line">        Pt p, q;</div><div class="line">        PtP(Pt p, Pt q): p(p), q(q) &#123;&#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cmpAxis</span> &#123;</span></div><div class="line">        <span class="keyword">int</span> k;</div><div class="line">        cmpAxis(<span class="keyword">int</span> k): k(k) &#123;&#125;</div><div class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span> <span class="params">(<span class="keyword">const</span> PtP &amp;x, <span class="keyword">const</span> PtP &amp;y)</span> <span class="keyword">const</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> x.p.d[k] &lt; y.p.d[k];</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BBox</span> &#123;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KDMIN(a, b, c) &#123;a[0] = min(b[0], c[0]), a[1] = min(b[1], c[1]);&#125;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KDMAX(a, b, c) &#123;a[0] = max(b[0], c[0]), a[1] = max(b[1], c[1]);&#125;</span></div><div class="line">        <span class="keyword">int</span> l[<span class="number">2</span>], r[<span class="number">2</span>];</div><div class="line">        BBox() &#123;&#125;</div><div class="line">        BBox(<span class="keyword">int</span> a[], <span class="keyword">int</span> b[]) &#123;</div><div class="line">            KDMIN(l, a, b); KDMAX(r, a, b);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">expand</span><span class="params">(Pt p)</span> </span>&#123;</div><div class="line">            KDMIN(l, l, p.d); KDMAX(r, r, p.d);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">expand</span><span class="params">(BBox b)</span> </span>&#123;</div><div class="line">            KDMIN(l, l, b.l); KDMAX(r, r, b.r);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">raycast</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> fx, <span class="keyword">double</span> y)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> l[<span class="number">1</span>] &lt;= y &amp;&amp; y &lt;= r[<span class="number">1</span>] &amp;&amp; r[<span class="number">0</span>] &gt;= x &amp;&amp; l[<span class="number">0</span>] &lt;= fx;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">static</span> BBox <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">            BBox b; b.l[<span class="number">0</span>] = b.l[<span class="number">1</span>] = INT_MAX, b.r[<span class="number">0</span>] = b.r[<span class="number">1</span>] = INT_MIN;</div><div class="line">            <span class="keyword">return</span> b;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></div><div class="line">        Node *lson, *rson;</div><div class="line">        Pt pt, qt;</div><div class="line">        BBox box;</div><div class="line">        <span class="keyword">int</span> size; <span class="keyword">int8_t</span> used;</div><div class="line">        Node() &#123;&#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">            lson = rson = <span class="literal">NULL</span>;</div><div class="line">            size = <span class="number">1</span>, used = <span class="number">1</span>;</div><div class="line">            pt = qt = Pt::NaN();</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">hasBox</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> box.l[<span class="number">0</span>] &lt;= box.r[<span class="number">0</span>]; &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">()</span> </span>&#123;</div><div class="line">            size = used;</div><div class="line">            <span class="keyword">if</span> (lson)	size += lson-&gt;size;</div><div class="line">            <span class="keyword">if</span> (rson)	size += rson-&gt;size;</div><div class="line">            pushupBox();</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushupBox</span><span class="params">()</span> </span>&#123;</div><div class="line">            BBox t = BBox::init();</div><div class="line">            <span class="keyword">if</span> (!qt.isNaN())</div><div class="line">                t.expand(pt), t.expand(qt);</div><div class="line">            <span class="keyword">if</span> (lson &amp;&amp; lson-&gt;hasBox())</div><div class="line">                t.expand(lson-&gt;box);</div><div class="line">            <span class="keyword">if</span> (rson &amp;&amp; rson-&gt;hasBox())</div><div class="line">                t.expand(rson-&gt;box);</div><div class="line">            box = t;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">double</span> <span class="title">interpolate</span><span class="params">(<span class="keyword">double</span> y)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (pt.d[<span class="number">1</span>] == qt.d[<span class="number">1</span>])	<span class="keyword">return</span> pt.d[<span class="number">0</span>];</div><div class="line">            <span class="keyword">return</span> pt.d[<span class="number">0</span>] + (qt.d[<span class="number">0</span>] - pt.d[<span class="number">0</span>]) * (y - pt.d[<span class="number">1</span>]) / (qt.d[<span class="number">1</span>] - pt.d[<span class="number">1</span>]);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    Node *root;</div><div class="line">    <span class="built_in">vector</span>&lt;PtP&gt; A;</div><div class="line">    <span class="keyword">int64_t</span> area;</div><div class="line">    Node _mem[<span class="number">262144</span>];</div><div class="line">    <span class="keyword">int</span> gc[<span class="number">262144</span>], gci, memi;</div><div class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</div><div class="line">        Node *u = gci &gt;= <span class="number">0</span> ? &amp;_mem[gc[gci--]] : &amp;_mem[memi++];</div><div class="line">        u-&gt;init();</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">freeNode</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        gc[++gci] = u-_mem;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        root = <span class="literal">NULL</span>, area = <span class="number">0</span>;</div><div class="line">        gci = <span class="number">-1</span>, memi = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> p, q, r; tie(p, q, r) = e;</div><div class="line">        insert(root, <span class="number">0</span>, Pt(mesh.pt[q]), Pt(mesh.pt[p]), log2int(size()) / LOG_ALPHA);</div><div class="line">        changeNode(root, <span class="number">0</span>, Pt(mesh.pt[r]), Pt(mesh.pt[q]));</div><div class="line">        area += h(p, q) + h(q, r) - h(p, r);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; e)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> p, q, r; tie(p, q, r) = e;</div><div class="line">        remove(root, <span class="number">0</span>, Pt(mesh.pt[q]), log2int(size()) / LOG_ALPHA);</div><div class="line">        changeNode(root, <span class="number">0</span>, Pt(mesh.pt[r]), Pt(mesh.pt[p]));</div><div class="line">        area -= h(p, q) + h(q, r) - h(p, r);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> RAY_T;</div><div class="line">    <span class="keyword">double</span> RAY_X;</div><div class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt; X;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">inside</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (area == <span class="number">0</span>)	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        X.clear(), RAY_X = <span class="number">1e+12</span>, RAY_T = <span class="number">-1</span>;</div><div class="line">        raycast(root, x, y);</div><div class="line">        <span class="keyword">if</span> (RAY_T &lt; <span class="number">0</span>)</div><div class="line">            <span class="keyword">return</span> X.size()&amp;<span class="number">1</span>;</div><div class="line">        <span class="keyword">int</span> pass = (area &gt; <span class="number">0</span>) == RAY_T;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;x : X)</div><div class="line">            pass += x &lt;= RAY_X;</div><div class="line">        <span class="keyword">return</span> pass&amp;<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> root == <span class="literal">NULL</span> ? <span class="number">0</span> : root-&gt;size; &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">isbad</span><span class="params">(Node *u, Node *v)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (u == root)	<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        <span class="keyword">int</span> l = v ? v-&gt;size : <span class="number">0</span>;</div><div class="line">        l = max(l, u-&gt;size-u-&gt;used-l);</div><div class="line">        <span class="keyword">return</span> l &gt; u-&gt;size * ALPHA;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">build</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (l &gt; r)	<span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">        <span class="keyword">int</span> mid = (l + r)&gt;&gt;<span class="number">1</span>;</div><div class="line">        Node *ret = newNode();</div><div class="line">        sort(A.begin()+l, A.begin()+r+<span class="number">1</span>, cmpAxis(k));</div><div class="line">        <span class="keyword">while</span> (mid &gt; l &amp;&amp; A[mid].p.d[k] == A[mid<span class="number">-1</span>].p.d[k])</div><div class="line">            mid--;</div><div class="line">        tie(ret-&gt;pt, ret-&gt;qt) = tie(A[mid].p, A[mid].q);</div><div class="line">        ret-&gt;lson = build(!k, l, mid<span class="number">-1</span>);</div><div class="line">        ret-&gt;rson = build(!k, mid+<span class="number">1</span>, r);</div><div class="line">        ret-&gt;pushup();</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">flatten</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!u)	<span class="keyword">return</span> ;</div><div class="line">        flatten(u-&gt;lson);</div><div class="line">        flatten(u-&gt;rson);</div><div class="line">        <span class="keyword">if</span> (u-&gt;used)	A.emplace_back(u-&gt;pt, u-&gt;qt);</div><div class="line">        freeNode(u);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">changeNode</span><span class="params">(Node *u, <span class="keyword">int</span> k, Pt x, Pt qt)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!u)	<span class="keyword">return</span>;</div><div class="line">        <span class="keyword">if</span> (x == u-&gt;pt) &#123;</div><div class="line">            u-&gt;qt = qt, u-&gt;pushupBox();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        changeNode(x.d[k] &lt; u-&gt;pt.d[k] ? u-&gt;lson : u-&gt;rson, !k, x, qt);</div><div class="line">        u-&gt;pushupBox();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rebuild</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> k)</span> </span>&#123;</div><div class="line">        A.clear(), A.reserve(u-&gt;size);</div><div class="line">        flatten(u);</div><div class="line">        u = build(k, <span class="number">0</span>, A.size()<span class="number">-1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">insert</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> k, Pt x, Pt y, <span class="keyword">int</span> d)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!u) &#123;</div><div class="line">            u = newNode(), u-&gt;pt = x, u-&gt;qt = y, u-&gt;pushup();</div><div class="line">            <span class="keyword">return</span> d &lt;= <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (x == u-&gt;pt) &#123;</div><div class="line">            u-&gt;used = <span class="number">1</span>, u-&gt;qt = y, u-&gt;pushup();</div><div class="line">            <span class="keyword">return</span> d &lt;= <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">auto</span> &amp;v = x.d[k] &lt; u-&gt;pt.d[k] ? u-&gt;lson : u-&gt;rson;</div><div class="line">        <span class="keyword">int</span> t = insert(v, !k, x, y, d<span class="number">-1</span>);</div><div class="line">        u-&gt;pushup();</div><div class="line">        <span class="keyword">if</span> (t &amp;&amp; !isbad(u, v))</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span> (t)	rebuild(u, k);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">remove</span><span class="params">(Node* &amp;u, <span class="keyword">int</span> k, Pt x, <span class="keyword">int</span> d)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!u)</div><div class="line">            <span class="keyword">return</span> d &lt;= <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (x == u-&gt;pt) &#123;</div><div class="line">            <span class="keyword">if</span> (u-&gt;lson || u-&gt;rson)</div><div class="line">                u-&gt;used = <span class="number">0</span>, u-&gt;qt = Pt::NaN(), u-&gt;pushup();</div><div class="line">            <span class="keyword">else</span></div><div class="line">                freeNode(u), u = <span class="literal">NULL</span>;</div><div class="line">            <span class="keyword">return</span> d &lt;= <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">auto</span> &amp;v = x.d[k] &lt; u-&gt;pt.d[k] ? u-&gt;lson : u-&gt;rson;</div><div class="line">        <span class="keyword">int</span> t = remove(v, !k, x, d<span class="number">-1</span>);</div><div class="line">        u-&gt;pushup();</div><div class="line">        <span class="keyword">if</span> (t &amp;&amp; !isbad(u, v))</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span> (t)	rebuild(u, k);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">cast</span><span class="params">(Node *u, <span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (u-&gt;qt.isNaN() || (u-&gt;pt.d[<span class="number">1</span>] &gt; y) == (u-&gt;qt.d[<span class="number">1</span>] &gt; y))</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        <span class="keyword">double</span> tx = u-&gt;interpolate(y);</div><div class="line">        <span class="keyword">if</span> (tx &lt;= x || tx &gt; RAY_X)</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        RAY_X = tx, RAY_T = u-&gt;pt.d[<span class="number">1</span>] &lt; u-&gt;qt.d[<span class="number">1</span>];</div><div class="line">        X.emplace_back(tx);</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    Node* stk[<span class="number">128</span>];</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">raycast</span><span class="params">(Node *u, <span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> pushstk(u) &#123;*p++ = u;&#125;</span></div><div class="line">        Node **p = stk;</div><div class="line">        pushstk(u);</div><div class="line">        <span class="keyword">while</span> (p &gt; stk) &#123;</div><div class="line">            u = *--p;</div><div class="line">            <span class="keyword">if</span> (!u || !u-&gt;size || !u-&gt;box.raycast(x, RAY_X, y))</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            cast(u, x, y);</div><div class="line">            pushstk(u-&gt;rson);</div><div class="line">            pushstk(u-&gt;lson);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125; mbrh;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m, cmd, x, pos;</div><div class="line">    <span class="keyword">double</span> px, py;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m);</div><div class="line">    mesh.read(n);</div><div class="line">    mlist.init(), mbrh.init();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;cmd);</div><div class="line">        <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;x, &amp;pos);</div><div class="line">            mbrh.insert(mlist.insert(x, pos));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;x);</div><div class="line">            mbrh.remove(mlist.remove(x));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%lf %lf"</span>, &amp;px, &amp;py);</div><div class="line">            <span class="built_in">puts</span>(mbrh.inside(px, py) ? <span class="string">"1"</span> : <span class="string">"0"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-mproblem-dynamic-tree" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/26/mproblem-dynamic-tree/" class="article-date">
  <time datetime="2019-01-26T12:07:42.000Z" itemprop="datePublished">2019-01-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/26/mproblem-dynamic-tree/">動態樹 樹形避難所</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2019/01/26/mproblem-dynamic-tree/" data-id="ckxtxqs7w00b9gkvn8gfh2ctj" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2019/01/26/mproblem-dynamic-tree/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LCT/">LCT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Link-Cut-Tree/">Link/Cut Tree</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>題目描述請至 Zerojudge e003: 樹形避難所 I、e004: 樹形避難所 II 查閱詳細內容</p>
</blockquote>
<h2 id="樹形避難所-I"><a href="#樹形避難所-I" class="headerlink" title="樹形避難所 I"></a>樹形避難所 I</h2><p>在一個樹形避難所中有 $N$ 個房間，待在充滿監視器房間的你，透過監視器的顯示發現存在一些未知的入侵者出現在某些房間。為了保護同伴，你可以選擇開啟或關閉房間之間的通道，而你也會收到來自於某個房間的同伴求救訊號，此時給予所有可能遇見的入侵者數量，以便同伴做好萬全的作戰準備。然而，操縱通道的控制器已不受限制，你只能眼睜睜地看著同伴與入侵者對抗，現在的你 … 做好準備了嗎？</p>
<ul>
<li>操作 1 <span>$u$</span><!-- Has MathJax --> <span>$v$</span><!-- Has MathJax -->：將房間 <span>$u$</span><!-- Has MathJax --> 與 <span>$v$</span><!-- Has MathJax --> 的通道開啟</li>
<li>操作 2 <span>$u$</span><!-- Has MathJax --> <span>$v$</span><!-- Has MathJax -->：將房間 <span>$u$</span><!-- Has MathJax --> 與 <span>$v$</span><!-- Has MathJax --> 的通道關閉</li>
<li>操作 3 <span>$u$</span><!-- Has MathJax --> <span>$w$</span><!-- Has MathJax -->：更正房間 <span>$u$</span><!-- Has MathJax --> 為 <span>$w$</span><!-- Has MathJax --> 個入侵者</li>
<li>操作 4 <span>$u$</span><!-- Has MathJax -->：回答來自 <span>$u$</span><!-- Has MathJax --> 的求救信號，告知與其可能面臨到的入侵者個數</li>
</ul>
<h2 id="樹形避難所-II"><a href="#樹形避難所-II" class="headerlink" title="樹形避難所 II"></a>樹形避難所 II</h2><p>由於上一個樹形避難所已經不再安全，全員轉移到下一個避難所，新的地方將不再是先前的平面構造，新的避難所建構在地下水層中，每一個房間可以在水中移動，並且打通到上一層的某一個房間。不幸地，新的入侵者更加地難纏，想保護大家的你，想藉由破壞某一個房間，將其相連的下層房間的入侵者一同殲滅，情局不斷地變化，哪一個才是最好的破壞手段呢 …</p>
<ul>
<li>操作 1 <span>$u$</span><!-- Has MathJax --> <span>$v$</span><!-- Has MathJax -->：將房間 <span>$u$</span><!-- Has MathJax --> 與上層房間 <span>$v$</span><!-- Has MathJax --> 的通道開啟</li>
<li>操作 2 <span>$u$</span><!-- Has MathJax -->：關閉房間 <span>$u$</span><!-- Has MathJax --> 與上層的通道</li>
<li>操作 3 <span>$u$</span><!-- Has MathJax --> <span>$w$</span><!-- Has MathJax -->：更正房間 <span>$u$</span><!-- Has MathJax --> 為 <span>$w$</span><!-- Has MathJax --> 個入侵者</li>
<li>操作 4 <span>$u$</span><!-- Has MathJax -->：估算摧毀房間 <span>$u$</span><!-- Has MathJax -->，可以殲滅的入侵者個數</li>
</ul>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>這一題對於樹的操作，牽涉到修改邊，修改點權，詢問整個連通的樹大小、以及子樹大小。可以考慮使用 Link/Cut Tree 完成。也有高手使用了離線算法，對操作分治後計算答案，將一個邊的存在時間記錄在某個時間戳記上，整體落在 <span>$\mathcal{O}(M \log M)$</span><!-- Has MathJax -->，由上而下合併所有存在的邊來完成單一詢問，需要搭配啟發式合併，來指查找根造成的退化，這一點相當地聰明。若強制在線，仍需要使用動態樹完成之。</p>
<p>對於第一題，只有包含前三個操作，可以當作一個無根樹操作，因此在 LCT 中的 <span>$\text{MakeRoot}$</span><!-- Has MathJax --> 打上反轉標記，無視原本的父子關係，額外維護一個虛邊上的子樹大小，如此一來就可以計算整個子樹大小。其餘的點權修改就相較於容易許多。對於第二題，便要求有根樹，因此在轉到根節點時，不能打上反轉標記，此時的左子樹為父節點，扣除掉父節點的大小後，便可以得到子樹大小。</p>
<ul>
<li>動態樹解法：空間複雜度 <span>$\mathcal{O}(N)$</span><!-- Has MathJax -->，操作複雜度 <span>$\text{Amortized} \; \mathcal{O}(\log N)$</span><!-- Has MathJax --></li>
<li>離線解法：空間複雜度 <span>$\mathcal{O}(M \log M)$</span><!-- Has MathJax -->，整體時間複雜度 <span>$\mathcal{O}(M \log M)$</span><!-- Has MathJax --></li>
</ul>
<h2 id="延伸問題"><a href="#延伸問題" class="headerlink" title="延伸問題"></a>延伸問題</h2><p>如果子樹存在等價關係，意即他們會被一個操作同時受到影響，那麼更新會退化嗎？</p>
<p>如果這個問題能被解決，那麼使用相同的概念，便能解決更多的高壓縮架構問題。工作就能輕鬆一些了。</p>
<h2 id="參考解答"><a href="#參考解答" class="headerlink" title="參考解答"></a>參考解答</h2><h3 id="樹形避難所-I-1"><a href="#樹形避難所-I-1" class="headerlink" title="樹形避難所 I"></a>樹形避難所 I</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line">  </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LCT</span> &#123;</span> <span class="comment">// Link-Cut Tree</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">30005</span>;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span>;</span></div><div class="line">    <span class="keyword">static</span> Node *EMPTY;</div><div class="line">    <span class="keyword">static</span> Node _mem[MAXN];</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> bufIdx;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></div><div class="line">        Node *ch[<span class="number">2</span>], *fa;</div><div class="line">        <span class="keyword">int</span> rev;</div><div class="line">        <span class="keyword">int</span> vsize, size, val;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">            ch[<span class="number">0</span>] = ch[<span class="number">1</span>] = fa = <span class="literal">NULL</span>;</div><div class="line">            size = <span class="number">0</span>, vsize = <span class="number">0</span>, rev = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">is_root</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> fa-&gt;ch[<span class="number">0</span>] != <span class="keyword">this</span> &amp;&amp; fa-&gt;ch[<span class="number">1</span>] != <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">()</span> </span>&#123;</div><div class="line">        	<span class="keyword">if</span> (rev) &#123;</div><div class="line">        		ch[<span class="number">0</span>]-&gt;rev ^= <span class="number">1</span>;</div><div class="line">                ch[<span class="number">1</span>]-&gt;rev ^= <span class="number">1</span>;</div><div class="line">        		swap(ch[<span class="number">0</span>], ch[<span class="number">1</span>]);</div><div class="line">        		rev = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">()</span> </span>&#123;</div><div class="line">        	<span class="keyword">if</span> (<span class="keyword">this</span> == EMPTY)</div><div class="line">        		<span class="keyword">return</span>;</div><div class="line">        	size = ch[<span class="number">0</span>]-&gt;size + ch[<span class="number">1</span>]-&gt;size + val + vsize;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    LCT() &#123;</div><div class="line">        EMPTY = &amp;_mem[<span class="number">0</span>];</div><div class="line">        EMPTY-&gt;fa = EMPTY-&gt;ch[<span class="number">0</span>] = EMPTY-&gt;ch[<span class="number">1</span>] = EMPTY;</div><div class="line">        EMPTY-&gt;size = <span class="number">0</span>;</div><div class="line">        bufIdx = <span class="number">1</span>; </div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        bufIdx = <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</div><div class="line">        Node *u = &amp;_mem[bufIdx++];</div><div class="line">        u-&gt;init();</div><div class="line">        u-&gt;fa = u-&gt;ch[<span class="number">0</span>] = u-&gt;ch[<span class="number">1</span>] = EMPTY;</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rotate</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        Node *y;</div><div class="line">        <span class="keyword">int</span> d;</div><div class="line">        y = x-&gt;fa, d = y-&gt;ch[<span class="number">1</span>] == x ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">        x-&gt;ch[d^<span class="number">1</span>]-&gt;fa = y, y-&gt;ch[d] = x-&gt;ch[d^<span class="number">1</span>];</div><div class="line">        x-&gt;ch[d^<span class="number">1</span>] = y;</div><div class="line">        <span class="keyword">if</span> (!y-&gt;is_root())</div><div class="line">            y-&gt;fa-&gt;ch[y-&gt;fa-&gt;ch[<span class="number">1</span>] == y] = x;</div><div class="line">        x-&gt;fa = y-&gt;fa, y-&gt;fa = x;</div><div class="line">        y-&gt;pushup(), x-&gt;pushup();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deal</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!x-&gt;is_root())   deal(x-&gt;fa);</div><div class="line">        x-&gt;pushdown();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        Node *y, *z;</div><div class="line">        deal(x);</div><div class="line">        <span class="keyword">while</span> (!x-&gt;is_root()) &#123;</div><div class="line">            y = x-&gt;fa, z = y-&gt;fa;</div><div class="line">            <span class="keyword">if</span> (!y-&gt;is_root()) &#123;</div><div class="line">                <span class="keyword">if</span> (y-&gt;ch[<span class="number">0</span>] == x ^ z-&gt;ch[<span class="number">0</span>] == y)</div><div class="line">                    rotate(x);</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    rotate(y);</div><div class="line">            &#125;</div><div class="line">            rotate(x);</div><div class="line">        &#125;</div><div class="line">        x-&gt;pushdown();</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">access</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        Node *v = EMPTY;</div><div class="line">        <span class="keyword">for</span> (; u != EMPTY; u = u-&gt;fa) &#123;</div><div class="line">            splay(u);</div><div class="line">            u-&gt;vsize += u-&gt;ch[<span class="number">1</span>] != EMPTY ? u-&gt;ch[<span class="number">1</span>]-&gt;size : <span class="number">0</span>;</div><div class="line">            u-&gt;vsize -= v != EMPTY ? v-&gt;size : <span class="number">0</span>;</div><div class="line">            u-&gt;ch[<span class="number">1</span>] = v;</div><div class="line">            u-&gt;pushup();</div><div class="line">            v = u;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> v;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">mk_root</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        access(u)-&gt;rev ^= <span class="number">1</span>, splay(u);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cut</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</div><div class="line">    	mk_root(x);</div><div class="line">    	access(y), splay(y);</div><div class="line"><span class="comment">//    	debug(10);</span></div><div class="line">    	assert(y-&gt;ch[<span class="number">0</span>] == x);</div><div class="line">        y-&gt;ch[<span class="number">0</span>] = x-&gt;fa = EMPTY;</div><div class="line">        y-&gt;pushup();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">link</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</div><div class="line">    	mk_root(y);</div><div class="line">    	access(x), splay(x);</div><div class="line">        y-&gt;fa = x;</div><div class="line">        x-&gt;vsize += y-&gt;size;</div><div class="line">        x-&gt;pushup();</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">find</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        access(x), splay(x);</div><div class="line">        <span class="keyword">for</span> (; x-&gt;ch[<span class="number">0</span>] != EMPTY; x = x-&gt;ch[<span class="number">0</span>]);</div><div class="line">        <span class="keyword">return</span> x;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(Node *x, <span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">    	mk_root(x);</div><div class="line">    	x-&gt;val = val;</div><div class="line">    	x-&gt;pushup();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">    	mk_root(u);</div><div class="line">    	<span class="keyword">return</span> u-&gt;size;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">same</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> find(x) == find(y);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">        <span class="built_in">puts</span>(<span class="string">"=================="</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            Node *u = &amp;_mem[i];</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"[%d] %d, %d %d, %d %d %d\n"</span>, i, u-&gt;fa-_mem, u-&gt;ch[<span class="number">0</span>]-_mem, u-&gt;ch[<span class="number">1</span>]-_mem, u-&gt;size, u-&gt;vsize, u-&gt;val);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125; lct;</div><div class="line">LCT::Node *LCT::EMPTY, LCT::_mem[LCT::MAXN];</div><div class="line"><span class="keyword">int</span> LCT::bufIdx;</div><div class="line">LCT::Node *node[LCT::MAXN];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</div><div class="line">        lct.init();</div><div class="line">        <span class="keyword">int</span> cmd, u, v, w;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;w);</div><div class="line">            node[i] = lct.newNode();</div><div class="line">            lct.<span class="built_in">set</span>(node[i], w);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;cmd);</div><div class="line">            <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;u, &amp;v);</div><div class="line">                lct.link(node[u], node[v]);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;u, &amp;v);</div><div class="line">                lct.cut(node[u], node[v]);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">3</span>) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;u, &amp;w);</div><div class="line">                lct.<span class="built_in">set</span>(node[u], w);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">4</span>) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;u);</div><div class="line">                <span class="keyword">int</span> p = lct.get(node[u]);</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, p);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;u, &amp;v);</div><div class="line">                <span class="keyword">int</span> f = lct.same(node[u], node[v]);</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, f);</div><div class="line">            &#125;</div><div class="line">            lct.debug(<span class="number">10</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="樹形避難所-II-1"><a href="#樹形避難所-II-1" class="headerlink" title="樹形避難所 II"></a>樹形避難所 II</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line">  </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LCT</span> &#123;</span> <span class="comment">// Link-Cut Tree</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">30005</span>;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span>;</span></div><div class="line">    <span class="keyword">static</span> Node *EMPTY;</div><div class="line">    <span class="keyword">static</span> Node _mem[MAXN];</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> bufIdx;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></div><div class="line">        Node *ch[<span class="number">2</span>], *fa;</div><div class="line">        <span class="keyword">int</span> vsize, size, val;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">            ch[<span class="number">0</span>] = ch[<span class="number">1</span>] = fa = <span class="literal">NULL</span>;</div><div class="line">            size = <span class="number">0</span>, vsize = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">is_root</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> fa-&gt;ch[<span class="number">0</span>] != <span class="keyword">this</span> &amp;&amp; fa-&gt;ch[<span class="number">1</span>] != <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">()</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">()</span> </span>&#123;</div><div class="line">        	<span class="keyword">if</span> (<span class="keyword">this</span> == EMPTY)</div><div class="line">        		<span class="keyword">return</span>;</div><div class="line">        	size = ch[<span class="number">0</span>]-&gt;size + ch[<span class="number">1</span>]-&gt;size + val + vsize;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    LCT() &#123;</div><div class="line">        EMPTY = &amp;_mem[<span class="number">0</span>];</div><div class="line">        EMPTY-&gt;fa = EMPTY-&gt;ch[<span class="number">0</span>] = EMPTY-&gt;ch[<span class="number">1</span>] = EMPTY;</div><div class="line">        EMPTY-&gt;size = <span class="number">0</span>;</div><div class="line">        bufIdx = <span class="number">1</span>; </div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        bufIdx = <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</div><div class="line">        Node *u = &amp;_mem[bufIdx++];</div><div class="line">        u-&gt;init();</div><div class="line">        u-&gt;fa = u-&gt;ch[<span class="number">0</span>] = u-&gt;ch[<span class="number">1</span>] = EMPTY;</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rotate</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        Node *y;</div><div class="line">        <span class="keyword">int</span> d;</div><div class="line">        y = x-&gt;fa, d = y-&gt;ch[<span class="number">1</span>] == x ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">        x-&gt;ch[d^<span class="number">1</span>]-&gt;fa = y, y-&gt;ch[d] = x-&gt;ch[d^<span class="number">1</span>];</div><div class="line">        x-&gt;ch[d^<span class="number">1</span>] = y;</div><div class="line">        <span class="keyword">if</span> (!y-&gt;is_root())</div><div class="line">            y-&gt;fa-&gt;ch[y-&gt;fa-&gt;ch[<span class="number">1</span>] == y] = x;</div><div class="line">        x-&gt;fa = y-&gt;fa, y-&gt;fa = x;</div><div class="line">        y-&gt;pushup(), x-&gt;pushup();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deal</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!x-&gt;is_root())   deal(x-&gt;fa);</div><div class="line">        x-&gt;pushdown();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        Node *y, *z;</div><div class="line">        deal(x);</div><div class="line">        <span class="keyword">while</span> (!x-&gt;is_root()) &#123;</div><div class="line">            y = x-&gt;fa, z = y-&gt;fa;</div><div class="line">            <span class="keyword">if</span> (!y-&gt;is_root()) &#123;</div><div class="line">                <span class="keyword">if</span> (y-&gt;ch[<span class="number">0</span>] == x ^ z-&gt;ch[<span class="number">0</span>] == y)</div><div class="line">                    rotate(x);</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    rotate(y);</div><div class="line">            &#125;</div><div class="line">            rotate(x);</div><div class="line">        &#125;</div><div class="line">        x-&gt;pushdown();</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">access</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        Node *v = EMPTY;</div><div class="line">        <span class="keyword">for</span> (; u != EMPTY; u = u-&gt;fa) &#123;</div><div class="line">            splay(u);</div><div class="line">            u-&gt;vsize += u-&gt;ch[<span class="number">1</span>] != EMPTY ? u-&gt;ch[<span class="number">1</span>]-&gt;size : <span class="number">0</span>;</div><div class="line">            u-&gt;vsize -= v != EMPTY ? v-&gt;size : <span class="number">0</span>;</div><div class="line">            u-&gt;ch[<span class="number">1</span>] = v;</div><div class="line">            u-&gt;pushup();</div><div class="line">            v = u;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> v;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">mk_root</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">        access(u), splay(u);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cut</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">    	access(x), splay(x);</div><div class="line">    	x-&gt;ch[<span class="number">0</span>]-&gt;fa = EMPTY;</div><div class="line">        x-&gt;ch[<span class="number">0</span>] = EMPTY;</div><div class="line">        x-&gt;pushup();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">link</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</div><div class="line">    	access(x), splay(x);</div><div class="line">    	access(y), splay(y);</div><div class="line">        x-&gt;fa = y;</div><div class="line">        y-&gt;vsize += x-&gt;size;</div><div class="line">        y-&gt;pushup();</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">find</span><span class="params">(Node *x)</span> </span>&#123;</div><div class="line">        access(x), splay(x);</div><div class="line">        <span class="keyword">for</span> (; x-&gt;ch[<span class="number">0</span>] != EMPTY; x = x-&gt;ch[<span class="number">0</span>]);</div><div class="line">        <span class="keyword">return</span> x;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(Node *x, <span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">    	mk_root(x);</div><div class="line">    	x-&gt;val = val;</div><div class="line">    	x-&gt;pushup();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get</span><span class="params">(Node *u)</span> </span>&#123;</div><div class="line">    	mk_root(u);</div><div class="line">    	<span class="keyword">int</span> ret = u-&gt;size;</div><div class="line">    	<span class="keyword">if</span> (u-&gt;ch[<span class="number">0</span>] != EMPTY)</div><div class="line">    		ret -= u-&gt;ch[<span class="number">0</span>]-&gt;size;</div><div class="line">    	<span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">same</span><span class="params">(Node *x, Node *y)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> find(x) == find(y);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">        <span class="built_in">puts</span>(<span class="string">"=================="</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            Node *u = &amp;_mem[i];</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"[%d] %d, %d %d, %d %d %d\n"</span>, i, u-&gt;fa-_mem, u-&gt;ch[<span class="number">0</span>]-_mem, u-&gt;ch[<span class="number">1</span>]-_mem, u-&gt;size, u-&gt;vsize, u-&gt;val);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125; lct;</div><div class="line">LCT::Node *LCT::EMPTY, LCT::_mem[LCT::MAXN];</div><div class="line"><span class="keyword">int</span> LCT::bufIdx;</div><div class="line"></div><div class="line">    LCT::Node *node[LCT::MAXN];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</div><div class="line">        lct.init();</div><div class="line">        <span class="keyword">int</span> cmd, u, v, w;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;w);</div><div class="line">            node[i] = lct.newNode();</div><div class="line">            lct.<span class="built_in">set</span>(node[i], w);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;cmd);</div><div class="line">            <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;u, &amp;v);</div><div class="line">                lct.link(node[u], node[v]);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;u);</div><div class="line">                lct.cut(node[u]);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">3</span>) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;u, &amp;w);</div><div class="line">                lct.<span class="built_in">set</span>(node[u], w);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">4</span>) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;u);</div><div class="line">                <span class="keyword">int</span> p = lct.get(node[u]);</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, p);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;u, &amp;v);</div><div class="line">                <span class="keyword">int</span> f = lct.same(node[u], node[v]);</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, f);</div><div class="line">            &#125;</div><div class="line">            lct.debug(<span class="number">4</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-diary-201811" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/25/diary-201811/" class="article-date">
  <time datetime="2018-11-24T22:53:05.000Z" itemprop="datePublished">2018-11-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/手札日記/">手札日記</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="https://i.imgur.com/rP2LtTm.jpg" rel="gallery_ckxtxqs5a004lgkvnzhsq0yg4">
        <img src="https://i.imgur.com/rP2LtTm.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/25/diary-201811/">波士頓出差 Cadence, Boston</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2018/11/25/diary-201811/" data-id="ckxtxqs5a004lgkvnzhsq0yg4" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2018/11/25/diary-201811/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="旅程前言"><a href="#旅程前言" class="headerlink" title="旅程前言"></a>旅程前言</h2><p>在碩二實習的時候，有碰到一次到美國波士頓出差的機會，有礙於那時候還是實習且研究生的身分，並沒有與團隊一起去。要是出國消失一周的話，指導教授大概會震怒吧，說不定就沒機會出現在 Cadence。</p>
<p>在 2016 那時，台灣的團隊才成立約一年，所以旅程的目的在於去學習，基本上就是產品架構的設計細節與概念、產品開發的流程。即使跟著去那兒，英文聽說都很糟糕的我，也只能看著投影片發呆吧。在這兩年中，團隊從四個人到七個人的成長，產品開發的控制越來越多到台灣團隊手上。因此，此行目的便不再是學習，要探討未來的發展和一些議題。</p>
<p>在出發之前，整理近幾個月的開發議題，手上有兩個舊有產品 OrbitIO 和 Allegro，修改了大幅度的效能問題，但舊有設計架構問題導致一些加速算法無法相容，光是想著這些設計問題，就不知道要怎麼與那邊的團隊討論，這些都是改動十幾年前的設計，我想代碼大多都朝著只增不減的方向邁進，這些問題很少人願意去著手，要去改那些需要十足的勇氣。然後，莫名其妙被加入了  Mission BraveHeart (<strong>任務代號：勇敢的心</strong>)，成功便成英雄。</p>
<p>另一個新產品的開發便是這次出發的壓軸，其內容跟公司的 EDM (Engineering Data Management) 產品有著異曲同工之妙，這困擾了我好幾個月，其概念就是強化版的批改娘，最大的不同在於多人協作的平台，要如何做得簡單好用「<strong>Simple is Better Than Complex</strong>」。</p>
<p><img src="https://i.imgur.com/vcOrnbq.jpg" alt="「我要做些什麼」－《昴宿七星》"></p>
<p>新產品的開發耗時將近一年，途中不斷地有新的工作要做，所以在好幾個產品跳來跳去。在 Java, C, Python, Javascript, HTML 跳來跳去，精神都快要達到臨界點。由於需求調整，一路上重新構造了好幾次架構，不斷地懷疑自己到底能不能把這個產品拉出來。由於公司與 DARPA (Defense Advanced Research Projects Agency, 國防高等研究計劃署)<br>的合作計畫，加速了這一個產品開發，在九月多時輪廓總算釐清了，目標在一個多月內把產品最低需求完成。</p>
<p>很多 EDA Tools 都經歷了好幾年的開發，如 OrbitIO 和 Allegro 更是幾十年的產品，支線需求直接在平台上開發比較沒什麼壓力。這次則要完全跳離所有依賴關係，團隊成員中沒有系統架構的經驗，而我這種半吊子只寫過一點點的網站，一點點的系統，一次就要走這麼遠，壓力不容小覷，這一段日子裡都不怎麼好睡。</p>
<p><img src="https://i.imgur.com/bJvPU50.jpg" alt="「感覺我好像越來越不行了」－《青春豬頭少年不會夢到兔女郎學姊》"></p>
<p>隔了一個多月，我們做到了嗎？做到哪裡？</p>
<p>開發過程中一直想找人來幫忙，面了一些高手，但面試的標準無從根據，導致錄取的進展不斷延後，於是先下定決心自己來吧，網頁後台各種從零開始，著手架構好的後台與前端網頁，試圖完成像 Github 與 git 這等偉大的目標。急急忙忙地切分模組出來給小夥伴開發，過程中又不斷地與其他成員說明系統的架構朝什麼發展，甚至一連開了整天的會議說明方向。</p>
<p>出發前一周仍然在調整各個模組的名稱，好讓介紹時快速切入要領。不得不佩服同事們的合作，介紹這方面的能力從以前開始都倚靠著別人，終於準備好上路了。</p>
<p><img src="https://i.imgur.com/MDmP4or.jpg" alt="「這個世界，沒有我的容身之地」－《異世界魔王與召喚少女的奴隸魔術》"></p>
<h2 id="啟程須知"><a href="#啟程須知" class="headerlink" title="啟程須知"></a>啟程須知</h2><p>給第二次出國的我 (第一次出國在泰國比賽)</p>
<p>礙於研發替代役的角色，出發前到外交部領事事務局申辦護照，不再是以前的三年版本，一次到手十年期限的護照。除了要額外帶著役男身分證外，其餘項目皆與一般申請護照無異，只需要一周的工作天，便可以領取護照。接著拿到新的護照，便向公司的 HR 發出出差申請，附上護照明細與旅途時間，通過後大約在一天左右，就可以從役政署的研發替代役網站列印許可通知書。接著，入境美國申請 ESTA，線上填妥細節繳費，列印好拿著這些就可以入境美國。</p>
<p>若需要國外駕車，可額外申請國際駕照，直接拿汽車駕照去監理站換發就好。不過國外租車的額外駕駛需要額外的保險，加一個額外駕駛就額外多一個費用，原則上對於我這種新手，最後沒有用到。</p>
<p>十一月初的波士頓到了將近攝氏零度的氣候，這一次旅程長達十四天，差不多要帶個六天的衣物，由於這麼冷的天氣基本上也不太需要太多外衣，內衣之類的還是需要帶多一點，直接在旅館內乾洗晾乾就好，大部分時間都有暖氣，所以只需要帶一件足夠厚的外套就行，也因為暖氣會不斷地除溼，保濕乳液之類的必須帶好。這次旅程意外地發現自己並不太怕冷，帶太多衣服穿不到，感覺有點傻了，毛襪不帶也沒關係，穿了反而不帶適應走路的步伐而不舒服。圍巾、手套帶著比較好，一下雪整個寒意就透過去。</p>
<h2 id="波士頓之旅"><a href="#波士頓之旅" class="headerlink" title="波士頓之旅"></a>波士頓之旅</h2><p>做了近 20 小時的飛機，終於到了美國波士頓，公司在比較偏遠的郊區 Chelmsford，隔天我們便到波士頓市中心附近的 MIT 和 Harvard 參觀，這時間點在感恩節前兩周，又正值假日，基本上都沒什麼學生。看著別人的生活環境，冷到一個很不舒服的季節。</p>
<p><img src="https://i.imgur.com/YEClMNn.jpg" alt="MIT"></p>
<p>在市中心晃了好一陣子，傍晚才前往到哈佛大學，然後開始排隊與那個金鞋合照。</p>
<p><img src="https://i.imgur.com/kea69zk.jpg" alt="Harvard University"></p>
<p>工作的第一天，聽著不太明白的產品與客戶發展介紹，第一次與 email 對面的人碰面聊天，上頭的上頭們全都來了，勉勉強強用殘破的英文亂說一通，還好有同事罩著，後面講的介紹一句也不懂，只能東猜猜西猜猜，猜出個什麼來再應付。下午便在討論「勇敢的心」細節，原則上是一個複雜度很難壓低的幾何計算，咱什麼時候變成幾何計算的顧問了？我其實也不算懂啊。</p>
<p>工作的第二天，兵分兩路被拆開到各自的主攻產品討論議題，陸陸續續邀請不同議題的相關成員會面，個人覺得是相當大的陣仗，區區的 Morris 開的議題邀了好幾個不同團隊的成員。由當地的同事主持會議，大多的時間都在聽他們討論，只花了幾分鐘介紹問題的原因、要解決的問題、可能的解決方向，為何需要這麼做？接著的應答就靠神一般同事翻譯。嗚嗚，<strong>我好沒用</strong>。晚上的時候，波士頓的第一場雪來了。</p>
<p><img src="https://i.imgur.com/NeSBcKB.jpg" alt="First Snow in Chelmsford"></p>
<p>工作的第三天，新產品決鬥的開始，Made in Taiwan 的武力展示，相當沒有信心去展示那些成果，大部分的架構還不確定能不能發展到那樣子，語言的特性決定發展能力，簡單、好用是否能兩全其美呢，覺得自己的眼界還不夠寬廣，深怕被那些非常非常資深的工程師擊飛，最後倖存！</p>
<p>工作的第四天，趕上公司的三十周年慶，公司租了一台遊艇在波士頓河岸繞了兩個小時，各個同事都在船上閒聊。結果我們台灣的都在玩船外的 table football 而忘了拍團體照 …</p>
<p><img src="https://i.imgur.com/W4cQZds.jpg" alt="Cadence 30th Celebration"></p>
<p>工作的第五天，討論要怎麼解決大數據的情況，數據一大只要會動就好，那麼效能就不再重要，但是舊有的操作又不能太慢，毫無用武之地的我，決定來個幻想之旅。最後一晚的聚餐，照片上的兇手替我點了 50 美元的龍蝦，看不懂菜單總是令人宰割。</p>
<p><img src="https://i.imgur.com/eLLHpA8.jpg" alt="$50 Lobster"></p>
<h2 id="紐約之旅"><a href="#紐約之旅" class="headerlink" title="紐約之旅"></a>紐約之旅</h2><p>在忙完一周的工作後，我們便到了第二周的紐約自由行。老實說，一開始的行程是回台灣休息，但是大部分的人都不在台灣，如果回台灣也處於無同事或目標的狀況，所以就跟著跑去紐約了。如此瘋狂的行程，大概就這一次！</p>
<p><img src="https://i.imgur.com/Tv2uioT.jpg" alt="「我真的沒有想做的事啊」－《來自繽紛世界的明日》"></p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/5/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/86/">86</a><a class="extend next" rel="next" href="/page/7/">Next &raquo;</a>
    </nav>
  
</section>
          
          
            <aside id="sidebar">
  <!-- <div id="ukagaka_panel"></div> -->
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/">學校課程</a><span class="category-list-count">115</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/介面設計/">介面設計</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/作業系統/">作業系統</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/即時系統/">即時系統</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/大學專題/">大學專題</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/巨量資料/">巨量資料</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/平行程式/">平行程式</a><span class="category-list-count">43</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/敏捷方法/">敏捷方法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/編譯器/">編譯器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/自然語言/">自然語言</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/虛擬實境/">虛擬實境</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算型智慧/">計算型智慧</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算幾何/">計算幾何</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算機圖學/">計算機圖學</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資料庫系統/">資料庫系統</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資訊安全/">資訊安全</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/通識課程/">通識課程</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/">工作應用</a><span class="category-list-count">38</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Java/">Java</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Meme/">Meme</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/其他/">其他</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/可持久化/">可持久化</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/鬼故事/">鬼故事</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/手札日記/">手札日記</a><span class="category-list-count">54</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/">網頁設計</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/About-This-Blog/">About This Blog</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/HTML5/">HTML5</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/JQuery/">JQuery</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/Markdown/">Markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/NodeJs/">NodeJs</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/">解題區</a><span class="category-list-count">633</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/Latex/">Latex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/出題解題/">出題解題</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-POJ/">解題區 - POJ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a><span class="category-list-count">483</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a><span class="category-list-count">77</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-未解題目/">解題區 - 未解題目</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/雜言筆記/">雜言筆記</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a class="text" href="/2021/12/31/diary-20211231-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·陸》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/12/26/diary-20211226-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·伍》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/11/21/diary-20211121-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·肆》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/11/12/diary-20211112-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·參》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/31/diary-20211031-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·貳》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/28/diary-202110-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·序》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/28/diary-202110/">
              
                <i class="icon-file-o"></i> 
              
            好多個 28 在這個時刻</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/28/work/company-ghost-story-14/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 14</a>
          </li>
        
          <li>
            <a class="text" href="/2021/09/12/work/appreciation-letter/">
              
                <i class="icon-file-o"></i> 
              
            Shiny People 感謝</a>
          </li>
        
          <li>
            <a class="text" href="/2021/09/12/work/company-ghost-story-13/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 13</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">   
        <ul>
          <li><a href="http://mypaper.pchome.com.tw/zerojudge" target="_blank" title="Old Blog"><i class="icon-star"></i> Morris' Blog (pchome)</a></li>
        </ul>
    </div>
</div>

  
    
<script src="/js/jquery-ui.js"></script>
<script src="/js/ukagaka/jquery.morris.ukagaka.resource.js"></script>
<script src="/js/ukagaka/typed.js"></script>
  
  
</aside>
          
        
      </div>
      <footer id="footer">
  
  <div class="outer">    
    <div class="social-group">
      
      <a href="https://github.com/morris821028" target="_blank" title="github"><i class="icon-github"></i></a>
      
      
      <a href="https://www.facebook.com/Morris1028" target="_blank" title="facebook"><i class="icon-facebook-sign"></i></a>
      
      
      <a href="http://uhunt.felix-halim.net/id/46705" target="_blank" title="uhunt" ><span class="icon-uhunt">UVa<span></a>
      
    </div>
    <div id="footer-info" class="inner">
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/morris821028/hexo-theme-landscape" target="_blank" title="landscape">landscape</a> &copy; 2021 Shiang-Yun Yang 
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link"><i class=icon-home ></i>&nbsp&nbspHome</a>
  
    <a href="/about" class="mobile-nav-link"><i class=icon-user ></i>&nbsp&nbspAbout</a>
  
    <a href="/archives" class="mobile-nav-link"><i class=icon-archive ></i>&nbsp&nbspArchives</a>
  
    <a href="/tags" class="mobile-nav-link"><i class=icon-tags ></i>&nbsp&nbspTags</a>
  
    <a href="/picture" class="mobile-nav-link"><i class=icon-camera ></i>&nbsp&nbspPictures</a>
  
    <a href="/works" class="mobile-nav-link"><i class=icon-trophy ></i>&nbsp&nbspWorks</a>
  
</nav>
    
<script>
  var disqus_shortname = 'morris1028';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/jquery.lazyload.js"></script>
<script src="/js/jquery.als-1.6.js"></script>

<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>