<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Morris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Morris&#39; Blog">
<meta property="og:url" content="http://morris821028.github.io/page/23/index.html">
<meta property="og:site_name" content="Morris&#39; Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Morris&#39; Blog">
<link rel="publisher" href="108158678174364350000">
  
    <link rel="alternative" href="/atom.xml" title="Morris&#39; Blog" type="application/atom+xml">
  
  
    <meta name="google-site-verification" content="5mRgj8NanEMpGZuNfHNJNmH90RgNlrnJXsFlTaKD6Gs" />
  
  
    <link rel="shortcut icon" href="/img/f.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script src="/js/jquery-2.1.0.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.5.1.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdn.oesmith.co.uk/morris-0.5.1.min.js"></script>
  <!-- <link rel="import" href="/bower_components/app-layout/app-layout.html"> --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"><div id="banner-right"></div></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Morris&#39; Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class=icon-home title='Home'></i></a>
          
        
          
            <a class="main-nav-link" href="/about"><i class=icon-user title='About'></i></a>
          
        
          
            <a class="main-nav-link" href="/archives"><i class=icon-archive title='Archives'></i></a>
          
        
          
            <a class="main-nav-link" href="/tags"><i class=icon-tags title='Tags'></i></a>
          
        
          
            <a class="main-nav-link" href="/picture"><i class=icon-camera title='Pictures'></i></a>
          
        
          
            <a class="main-nav-link" href="/works"><i class=icon-trophy title='Works'></i></a>
          
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://morris821028.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        
          
          <section id="main">
  
    <article id="post-zj-b419" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/07/zj-b419/" class="article-date">
  <time datetime="2015-07-06T22:24:18.000Z" itemprop="datePublished">2015-07-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/07/zj-b419/">b419. 公平的硬幣</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/07/zj-b419/" data-id="cktgl1qyw011214vnywcdrlk1" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/07/zj-b419/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/數值積分/">數值積分</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/機率/">機率</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/自然分布/">自然分布</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/辛普森積分/">辛普森積分</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/近似公式/">近似公式</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>一天，liouzhou_101 去打印店裏打印了幾張複習資料，花了 4 毛錢，他給了店主1張塊錢的鈔票，結果店主補了他兩枚硬幣，一個5毛錢，一個 1 毛錢。</p>
<p>在走回宿舍的途中，liouzhou_101 一直在想一個問題，5 毛錢的硬幣和 1 毛錢的硬幣哪個更公平？所謂公平，就是指將一枚硬幣拋擲 1 次，他正面朝上的概率是 12，反面朝上的概率也是 12。</p>
<p>結果他一會去就把1毛錢的硬幣拋了 1000 次， 記下來有 531 次正面朝上。然後他突然說道：“這硬幣不公平！！！”</p>
<p>真的不公平嗎？他希望你計算一下出現這種情況的概率。 </p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">10 5 5</div><div class="line">20 6 8</div><div class="line">100 40 60</div><div class="line">1000 531 531</div><div class="line">5000 2345 2456</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">0.2461</div><div class="line">0.2310</div><div class="line">0.9648</div><div class="line">0.0037</div><div class="line">0.1093</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>跟柳柳州互相出題目，已經來到了第 n 天，儘管我出的都是垃圾跟搬運題目，一出題被電得好愉悅，出在多的垃圾題都電不到柳柳州。</p>
<p>在擲硬幣找區間次數 <span>$[a, b]$</span><!-- Has MathJax --> 的機率，由於是離散的統計上就只能推組合數學，但又不是曲棍棒的模型 (Hockey Stick Pattern)，算了先手動窮舉，用 Stirling’s formula 計算組合，後來發現有幾組數據有問題。</p>
<p>當 n 太大的時候，機率分布就相當稀疏，直接套用數值積分，直接去積分自然分布得到公式稍微困難，利用 simpson 或者是 romberg 去解決，但這樣還會有一個問題，只有在平均值的部分機率非常高 (類似離散的 00000100000)，導致自適應辛普森積分會判斷錯誤，提醒剖半積分後測資就正確了不少。似乎合作出了一個可怕的題目，儘管如此，還是得用 mathlab 或者是 wolframalpha 來協助測資的檢驗，剩下的部分就交給柳柳州了。</p>
<p>關於自然分布 (normal distribution)：</p>
<ul>
<li>骰子擲 <span>$n$</span><!-- Has MathJax --> 次，命中的機率 <span>$p = 1/2$</span><!-- Has MathJax --></li>
<li>期望值 <span>$\mu = np = n/2$</span><!-- Has MathJax --></li>
<li>標準差為 <span>$\sigma = \sqrt{np(1-p)} = \sqrt{n/4}$</span><!-- Has MathJax -->。</li>
</ul>
<p>期望值 <span>$E[x] = \sum_{k=1}^{n} k \binom{n}{k} p^k (1-p)^{n-k}$</span><!-- Has MathJax -->，消階層之後提出，計算後得到 <span>$E[x] = np$</span><!-- Has MathJax -->。</p>
<p>而標準差 <span>$\sigma$</span><!-- Has MathJax --> 先從變異數下手</p>
<ul>
<li>定義： <span>$Var[x] = E[(x - \mu)^2] = \sum (x - \mu)^2 P[X = x]$</span><!-- Has MathJax --></li>
<li>拆解步驟 1： <span>$Var[x] = \sum (x^2 - 2 \mu x + \mu^{2}) P[X = x]$</span><!-- Has MathJax --></li>
<li>拆解步驟 2： <span>$Var[x] = E[x^2] - 2 E[x] E[x] + E[x] E[x] = E[x^2] - E[x]^2$</span><!-- Has MathJax --></li>
<li>拆解步驟 3： <span>$E[x^2] = E[x(x-1)] + E[x] = n(n-1)p^2 + np$</span><!-- Has MathJax --></li>
<li>拆解步驟 4： <span>$Var[x] = np(1-p)$</span><!-- Has MathJax --></li>
</ul>
<p>接下來直接帶入自然分布的公式，參數 <span>$(\mu, \sigma)$</span><!-- Has MathJax -->，特別小心使用辛普森積分 <span>$[a, b]$</span><!-- Has MathJax --> 時，由於問題是離散的，要改變成 <span>$[a - 0.5, b + 0.5]$</span><!-- Has MathJax -->，防止 <span>$a = b$</span><!-- Has MathJax --> 時造成積分錯誤。</p>
<p>特別感謝學弟 firejox 的數學指導。</p>
<p>不久之後，firejox 說道內建函數 <code>erf()</code> 可以解決積分問題，詳見 <a href="https://en.wikipedia.org/wiki/Error_function" target="_blank" rel="external">wiki Gauss error function</a>，因此這一題也可以不寫辛普森積分，套用內建函數在不到 10 行內解決此題。</p>
<h3 id="暴力檢測"><a href="#暴力檢測" class="headerlink" title="暴力檢測"></a>暴力檢測</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">double</span> PI = <span class="built_in">acos</span>(<span class="number">-1</span>), e = <span class="built_in">exp</span>(<span class="number">1</span>);</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">100001</span>;</div><div class="line"><span class="keyword">double</span> f[MAXN];</div><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">stirling</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (n &lt; MAXN)</div><div class="line">        <span class="keyword">return</span> f[n];</div><div class="line">    <span class="keyword">return</span> log2(<span class="built_in">sqrt</span>(<span class="number">2</span>*PI*n)) + n*log2(n/e);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">logC</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> m)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> stirling(n) - stirling(n - m) - stirling(m);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    f[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; MAXN; i++)</div><div class="line">        f[i] = log2(i) + f[i<span class="number">-1</span>];</div><div class="line">    <span class="keyword">int</span> n, a, b;</div><div class="line">    <span class="keyword">int</span> cases = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;n, &amp;a, &amp;b) == <span class="number">3</span>) &#123;</div><div class="line">        <span class="keyword">double</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = a; i &lt;= b; i++)</div><div class="line">            ret += <span class="built_in">pow</span>(<span class="number">2</span>, logC(n, i) - log2(<span class="number">2</span>) * n);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%.4lf\n"</span>, ret);</div><div class="line">        <span class="keyword">if</span> (++cases &gt; <span class="number">100</span>)</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125; </div></pre></td></tr></table></figure>
<h3 id="數值積分"><a href="#數值積分" class="headerlink" title="數值積分"></a>數值積分</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">double</span> PI = <span class="built_in">acos</span>(<span class="number">-1</span>), e = <span class="built_in">exp</span>(<span class="number">1</span>);</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1001</span>;</div><div class="line"><span class="keyword">double</span> f[MAXN];</div><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">stirling</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (n &lt; MAXN)</div><div class="line">        <span class="keyword">return</span> f[n];</div><div class="line">    <span class="keyword">return</span> log2(<span class="built_in">sqrt</span>(<span class="number">2</span>*PI*n)) + n*log2(n/e);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">logC</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> m)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> stirling(n) - stirling(n - m) - stirling(m);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpsonIntegral</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keyword">double</span> eps = <span class="number">1e-6</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">double</span> pi = <span class="built_in">acos</span>(<span class="number">-1</span>);</div><div class="line">    <span class="keyword">const</span> <span class="keyword">double</span> sqr2pi = <span class="built_in">sqrt</span>(<span class="number">2</span> * pi);</div><div class="line">    <span class="keyword">double</span> mu, sigma; <span class="comment">// function coefficient</span></div><div class="line">    <span class="function"><span class="keyword">double</span> <span class="title">f</span><span class="params">(<span class="keyword">double</span> x)</span> </span>&#123; <span class="comment">// usually replace</span></div><div class="line">        <span class="keyword">return</span> <span class="built_in">exp</span>(-(<span class="built_in">pow</span>(x - mu, <span class="number">2</span>)/<span class="number">2.0</span>/sigma/sigma))/ sigma / sqr2pi;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setCoefficient</span><span class="params">(<span class="keyword">double</span> m, <span class="keyword">double</span> s)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>-&gt;mu = m, <span class="keyword">this</span>-&gt;sigma = s;</div><div class="line">    &#125; </div><div class="line">    <span class="function"><span class="keyword">double</span> <span class="title">simpson</span><span class="params">(<span class="keyword">double</span> a, <span class="keyword">double</span> b, <span class="keyword">double</span> fa, <span class="keyword">double</span> fb, <span class="keyword">double</span> fab)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (fa + <span class="number">4</span> * fab + fb) * (b - a) / <span class="number">6.0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">double</span> <span class="title">integral</span><span class="params">(<span class="keyword">double</span> l, <span class="keyword">double</span> r)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> integral(l, r, eps);</div><div class="line">    &#125;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="function"><span class="keyword">double</span> <span class="title">integral</span><span class="params">(<span class="keyword">double</span> a, <span class="keyword">double</span> b, <span class="keyword">double</span> c, <span class="keyword">double</span> eps, <span class="keyword">double</span> A, <span class="keyword">double</span> fa, <span class="keyword">double</span> fb, <span class="keyword">double</span> fc)</span> </span>&#123;</div><div class="line">        <span class="keyword">double</span> ab = (a + b)/<span class="number">2</span>, bc = (b + c)/<span class="number">2</span>;</div><div class="line">        <span class="keyword">double</span> fab = f(ab), fbc = f(bc);</div><div class="line">        <span class="keyword">double</span> L = simpson(a, b, fa, fb, fab), R = simpson(b, c, fb, fc, fbc);</div><div class="line">        <span class="keyword">if</span> (<span class="built_in">fabs</span>(L + R - A) &lt;= <span class="number">15</span> * eps)</div><div class="line">            <span class="keyword">return</span> L + R + (L + R - A) / <span class="number">15.0</span>;</div><div class="line">        <span class="keyword">return</span> integral(a, ab, b, eps/<span class="number">2</span>, L, fa, fab, fb) + integral(b, bc, c, eps/<span class="number">2</span>, R, fb, fbc, fc);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">double</span> <span class="title">integral</span><span class="params">(<span class="keyword">double</span> a, <span class="keyword">double</span> b, <span class="keyword">double</span> eps)</span> </span>&#123;</div><div class="line">        <span class="keyword">double</span> ab = (a + b) /<span class="number">2</span>;</div><div class="line">        <span class="keyword">double</span> fa = f(a), fb = f(b), fab = f(ab);</div><div class="line">        <span class="keyword">return</span> integral(a, ab, b, eps, simpson(a, b, fa, fb, fab), fa, fab, fb);</div><div class="line">    &#125;</div><div class="line">&#125; tool;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">binom</span><span class="params">(<span class="keyword">double</span> n, <span class="keyword">double</span> a, <span class="keyword">double</span> b)</span> </span>&#123;</div><div class="line">    <span class="keyword">double</span> a1, b1;</div><div class="line">    <span class="keyword">double</span> d = <span class="built_in">sqrt</span>(n/<span class="number">2.0</span>);</div><div class="line">    a1 = <span class="number">0.5</span> * (<span class="number">1.0</span> + erf((a - n/<span class="number">2.0</span> - <span class="number">0.5</span>) / d));</div><div class="line">    b1 = <span class="number">0.5</span> * (<span class="number">1.0</span> + erf((b - n/<span class="number">2.0</span> + <span class="number">0.5</span>) / d));</div><div class="line">    <span class="keyword">return</span> b1 - a1;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    f[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; MAXN; i++)</div><div class="line">        f[i] = log2(i) + f[i<span class="number">-1</span>];</div><div class="line">    <span class="keyword">int</span> n, a, b;</div><div class="line">    <span class="keyword">int</span> cases = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;n, &amp;a, &amp;b) == <span class="number">3</span>) &#123;</div><div class="line">        cases++;</div><div class="line">        <span class="keyword">if</span> (n &lt; MAXN) &#123;</div><div class="line">            <span class="keyword">double</span> ret = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = a; i &lt;= b; i++)</div><div class="line">                ret += <span class="built_in">pow</span>(<span class="number">2</span>, logC(n, i) - log2(<span class="number">2</span>) * n);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%.4lf\n"</span>, ret);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="comment">//			tool.setCoefficient(n/2.0, sqrt(n/4.0));</span></div><div class="line"><span class="comment">//			double ret = 0, l = a - 0.5, r = b + 0.5;</span></div><div class="line"><span class="comment">//			if (r &lt; n/2.0 || l &gt; n/2.0)</span></div><div class="line"><span class="comment">//				ret = tool.integral(l, r);</span></div><div class="line"><span class="comment">//			else</span></div><div class="line"><span class="comment">//				ret = tool.integral(l, n/2.0) + tool.integral(n/2.0, r);</span></div><div class="line"><span class="comment">//			printf("%.4lf\n", ret);</span></div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%.4lf\n"</span>, binom(n, a, b));</div><div class="line">        &#125; </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125; </div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b417" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/05/zj-b417/" class="article-date">
  <time datetime="2015-07-05T00:28:10.000Z" itemprop="datePublished">2015-07-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/05/zj-b417/">b417. 區間眾數</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/05/zj-b417/" data-id="cktgl1qyq010p14vnnax37b86" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/05/zj-b417/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/分塊/">分塊</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/莫隊算法/">莫隊算法</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>大學上課是怎麼回事的呢？談論到學期成績計算，很多奇聞軼事可以說的，例如教授任選三題批改、同學任選三題作答、滿分三百、沒有考試、 … 等。筆試類型的考試只是最常見的一種，還有所謂的多才華加分，例如上台報告、舉手發問、參與展覽、參加競賽、 … 等。</p>
<p>不幸地，某 M 修了一堂怪課，教授每一堂課結束後總是會大聲宣揚「葛萊分多加 5 分」對於需要不斷複習演練的某 M 而言，這門課的即時評分方式讓其非常挫敗。神奇的是，有一次教授這麼問同學「給一序列，請計算眾數、平均數、中位數，答對加分。」某 M 剎那間傻住，大學的學期成績可以用這種問題獲得，當他在懷疑這個問題時，問題早已被同學回答走。</p>
<p>某 M 非常不甘心，計算眾數、平均數、中位數就能夠加分，要求只是 n = 10 的序列。既然加分有理，出題吧！</p>
<h3 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h3><p>平均數、中位數可以藉由區間總和、區間 K 小問題來完成，現在來解決眾數。</p>
<p>給定一個長度為 <span>$n$</span><!-- Has MathJax --> ( <span>$1 \le n \le 100000$</span><!-- Has MathJax --> ) 的正整數序列 <span>$s$</span><!-- Has MathJax --> (<span>$1 \le s_i \le n$</span><!-- Has MathJax -->)，對於 <span>$m$</span><!-- Has MathJax --> ( <span>$1 \le m \le 1000000$</span><!-- Has MathJax -->) 次詢問 <span>$l, r$</span><!-- Has MathJax -->，每次輸出 <span>$[s_l, \text{... },s_r]$</span><!-- Has MathJax --> 中，出現最多次的次數以及有多少種數字出現最多次。 </p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">10 10</div><div class="line">2 3 1 1 1 2 1 2 1 1</div><div class="line">5 8</div><div class="line">1 10</div><div class="line">6 9</div><div class="line">5 9</div><div class="line">1 5</div><div class="line">3 10</div><div class="line">1 9</div><div class="line">1 1</div><div class="line">6 9</div><div class="line">2 3</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">2 2</div><div class="line">6 1</div><div class="line">2 2</div><div class="line">3 1</div><div class="line">3 1</div><div class="line">6 1</div><div class="line">5 1</div><div class="line">1 1</div><div class="line">2 2</div><div class="line">1 2</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>眾數區間查找 <a href="https://en.wikipedia.org/wiki/Range_mode_query" target="_blank" rel="external">Range mode query</a> 性質可以參考維基百科。</p>
<p>在這一題中，這裡提供三種解法，但我的寫法中只有莫隊算法可以通過，其餘算法受到時間跟空間上的限制，需要額外的優化，細節就不多做說明：</p>
<ul>
<li>莫隊算法<br>只能離線處理，無法強制在線詢問，維護眾數最高頻率指針，來統計眾數的對應次數和等價眾數的個數，由於指針移動都是 <span>$O(1)$</span><!-- Has MathJax -->，整體上時間效能為 <span>$O(N^{1.5})$</span><!-- Has MathJax -->。</li>
<li>分塊在線 1<br>離線預處理 <span>$O(N^{0.5} \times N^{0.5} \times \log{N})$</span><!-- Has MathJax --><br>提供在線詢問 <span>$O(\text{ans} \times \log{N})$</span><!-- Has MathJax -->，由於知道每一個塊中的代表眾數都可能是答案，因此預處理每一個塊的眾數，其餘的非眾數捨棄掉，最慘情況是每個數字都出現一次，在線詢問時複雜度會掉到 <span>$O(N \log N)$</span><!-- Has MathJax -->。</li>
<li>分塊在線 2<ul>
<li>離線預處理時間 <span>$O(N \times L^2)$</span><!-- Has MathJax -->，提供在線詢問 <span>$O(N/L)$</span><!-- Has MathJax -->，其中 <span>$L$</span><!-- Has MathJax --> 表示有多少個分塊。</li>
<li>預處理分塊編號 <span>$PILE[i, j]$</span><!-- Has MathJax --> 的眾數情況 (類似莫隊維護指針)，因此記憶體消耗 <span>$O(N \times L^2)$</span><!-- Has MathJax -->。</li>
<li>對於每一處詢問，會對應預處理中的區域塊的紀錄 <span>$PILE[L, R]$</span><!-- Has MathJax -->，接著頭尾兩端的殘存數字再依序加入，意即 <span>$A[a, L-1]$</span><!-- Has MathJax --> 和 <span>$A[R+1, b]$</span><!-- Has MathJax --> 的數字加入的複雜度 <span>$O(1)$</span><!-- Has MathJax -->，隨後再進行撤銷 <span>$O(1)$</span><!-- Has MathJax -->。</li>
<li>假設詢問次數 <span>$Q$</span><!-- Has MathJax --> 與 <span>$N$</span><!-- Has MathJax --> 呈現性關係，整體需要 <span>$O(N \times L^2 + N^2 / L)$</span><!-- Has MathJax -->，則 <span>$L = N^{1/3}$</span><!-- Has MathJax --> 是最好的情況，意即每一個塊具有 <span>$O(N^{2/3})$</span><!-- Has MathJax --> 個數字，最後得到整體時間效能為 <span>$O(N^{1.66})$</span><!-- Has MathJax -->。</li>
</ul>
</li>
</ul>
<p>由於這一題目標不是找到眾數為何 (這牽涉到最小字典順序)，而是找眾數的出現個數和有幾種眾數可能，莫隊算法會快於其他算法。若是要求最小眾數莫隊算法需要 <span>$O(N^{1.5} \log{N})$</span><!-- Has MathJax -->，分塊在線 1 也是 <span>$O(N^{1.5} \log{N})$</span><!-- Has MathJax -->。</p>
<p>分塊在線 2 在此題不僅僅遇到記憶體過大，只好鬆弛 <span>$L$</span><!-- Has MathJax --> 來壓低記憶體用量，但增加時間需求，時間上慢個 10 倍以上。</p>
<h3 id="莫隊算法"><a href="#莫隊算法" class="headerlink" title="莫隊算法"></a>莫隊算法</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">100005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXV = <span class="number">100005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXQ = <span class="number">1000005</span>;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Offline</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Event</span> &#123;</span></div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> PILE, belong[MAXV];</div><div class="line">        <span class="keyword">int</span> l, r, qid;</div><div class="line">        Event(<span class="keyword">int</span> a = <span class="number">0</span>, <span class="keyword">int</span> b = <span class="number">0</span>, <span class="keyword">int</span> e = <span class="number">0</span>):</div><div class="line">            l(a), r(b), qid(e) &#123;&#125;</div><div class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Event &amp;x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">if</span> (belong[l] != belong[x.l])</div><div class="line">                <span class="keyword">return</span> l &lt; x.l;</div><div class="line">            <span class="keyword">return</span> r &lt; x.r; </div><div class="line">        &#125;</div><div class="line">    &#125; event[MAXQ];</div><div class="line">    <span class="keyword">int</span> A[MAXN], N, qsize;</div><div class="line">    <span class="keyword">int</span> ret[MAXQ][<span class="number">2</span>];</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> N)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>-&gt;N = N, qsize = <span class="number">0</span>;</div><div class="line">        <span class="built_in">memset</span>(val_count, <span class="number">0</span>, <span class="keyword">sizeof</span>(val_count));</div><div class="line">        <span class="built_in">memset</span>(mode_freq, <span class="number">0</span>, <span class="keyword">sizeof</span>(mode_freq));</div><div class="line">        mode_idx = <span class="number">0</span>;</div><div class="line">        Event::PILE = <span class="built_in">sqrt</span>(N);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = N; i &gt;= <span class="number">1</span>; i--)</div><div class="line">            Event::belong[i] = i / Event::PILE;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">q_add</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</div><div class="line">        event[qsize] = Event(l, r, qsize);</div><div class="line">        qsize++;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        sort(event, event+qsize);</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> l = <span class="number">1</span>, r = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; qsize; i++) &#123;</div><div class="line">            <span class="keyword">while</span> (r &lt; event[i].r)	r++, update(A[r], <span class="number">1</span>);</div><div class="line">            <span class="keyword">while</span> (r &gt; event[i].r)	update(A[r], <span class="number">-1</span>), r--;</div><div class="line">            <span class="keyword">while</span> (l &gt; event[i].l)	l--, update(A[l], <span class="number">1</span>);</div><div class="line">            <span class="keyword">while</span> (l &lt; event[i].l)	update(A[l], <span class="number">-1</span>), l++;</div><div class="line">            ret[event[i].qid][<span class="number">0</span>] = mode_idx;</div><div class="line">            ret[event[i].qid][<span class="number">1</span>] = mode_freq[mode_idx];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="comment">// unrolled</span></div><div class="line">    <span class="keyword">int</span> val_count[MAXV], mode_freq[MAXN], mode_idx;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (val == <span class="number">1</span>) &#123;</div><div class="line">            mode_freq[val_count[x]]--;</div><div class="line">            val_count[x]++;</div><div class="line">            mode_freq[val_count[x]]++;</div><div class="line">            <span class="keyword">if</span> (mode_freq[mode_idx+<span class="number">1</span>] != <span class="number">0</span>)</div><div class="line">                mode_idx++;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (val == <span class="number">-1</span>) &#123;</div><div class="line">            mode_freq[val_count[x]]--;</div><div class="line">            val_count[x]--;</div><div class="line">            mode_freq[val_count[x]]++;</div><div class="line">            <span class="keyword">if</span> (mode_freq[mode_idx] == <span class="number">0</span>)</div><div class="line">                mode_idx--;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125; off;</div><div class="line"><span class="keyword">int</span> Offline::Event::PILE = <span class="number">16</span>, Offline::Event::belong[MAXV];</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> mLocalStream &#123;</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">M</span> &#123;</span></div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">        <span class="keyword">char</span> buf[N], *p, *end;</div><div class="line">        M() &#123;</div><div class="line">            p = buf, end = buf + N - <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">printInt</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">            <span class="keyword">static</span> <span class="keyword">char</span> stk[<span class="number">16</span>];</div><div class="line">            <span class="keyword">int</span> idx = <span class="number">0</span>;</div><div class="line">            stk[idx++] = <span class="string">'\n'</span>;</div><div class="line">            <span class="keyword">if</span> (!x)	</div><div class="line">                stk[idx++] = <span class="string">'0'</span>;</div><div class="line">            <span class="keyword">while</span> (x)</div><div class="line">                stk[idx++] = x%<span class="number">10</span> + <span class="string">'0'</span>, x /= <span class="number">10</span>;</div><div class="line">            <span class="keyword">while</span> (idx) &#123;</div><div class="line">                <span class="keyword">if</span> (p == end) &#123;</div><div class="line">                    *p = <span class="string">'\0'</span>;</div><div class="line">                    <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf), p = buf;</div><div class="line">                &#125;</div><div class="line">                *p = stk[--idx], p++;</div><div class="line">            &#125;</div><div class="line">        &#125;	</div><div class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">readchar</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">static</span> <span class="keyword">char</span> buf[N];</div><div class="line">            <span class="keyword">static</span> <span class="keyword">char</span> *p = buf, *end = buf;</div><div class="line">            <span class="keyword">if</span>(p == end) &#123;</div><div class="line">                <span class="keyword">if</span>((end = buf + fread(buf, <span class="number">1</span>, N, <span class="built_in">stdin</span>)) == buf) <span class="keyword">return</span> EOF;</div><div class="line">                p = buf;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> *p++;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">ReadInt</span><span class="params">(<span class="keyword">int</span> *x)</span> </span>&#123;</div><div class="line">            <span class="keyword">static</span> <span class="keyword">char</span> c, neg;</div><div class="line">            <span class="keyword">while</span>((c = readchar()) &lt; <span class="string">'-'</span>)    &#123;<span class="keyword">if</span>(c == EOF) <span class="keyword">return</span> <span class="number">0</span>;&#125;</div><div class="line">            neg = (c == <span class="string">'-'</span>) ? <span class="number">-1</span> : <span class="number">1</span>;</div><div class="line">            *x = (neg == <span class="number">1</span>) ? c-<span class="string">'0'</span> : <span class="number">0</span>;</div><div class="line">            <span class="keyword">while</span>((c = readchar()) &gt;= <span class="string">'0'</span>)</div><div class="line">                *x = (*x &lt;&lt; <span class="number">3</span>) + (*x &lt;&lt; <span class="number">1</span>) + c-<span class="string">'0'</span>;</div><div class="line">            *x *= neg;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        ~M() &#123;</div><div class="line">            *p = <span class="string">'\0'</span>;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf);</div><div class="line">        &#125;		</div><div class="line">    &#125; bprint;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m, l, r, a, b;</div><div class="line">    <span class="keyword">while</span> (mLocalStream::M::ReadInt(&amp;n)) &#123;</div><div class="line">        mLocalStream::M::ReadInt(&amp;m);</div><div class="line">        off.init(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</div><div class="line">            mLocalStream::M::ReadInt(&amp;off.A[i]);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">            mLocalStream::M::ReadInt(&amp;l);</div><div class="line">            mLocalStream::M::ReadInt(&amp;r);</div><div class="line">            off.q_add(l, r);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        off.run();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++)</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, off.ret[i][<span class="number">0</span>], off.ret[i][<span class="number">1</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<h3 id="分塊在線-1"><a href="#分塊在線-1" class="headerlink" title="分塊在線 1"></a>分塊在線 1</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">100005</span>;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModeQuery</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">int</span> A[MAXN], N, PILE, belong[MAXN];</div><div class="line">    <span class="built_in">vector</span>&lt; <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &gt; V, Vmode;</div><div class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; POS[MAXN];</div><div class="line">    <span class="keyword">int</span> q_dup[MAXN], q_cases;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">make</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        N = n, q_cases = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (PILE = <span class="number">1</span>; PILE * PILE &lt; N; PILE &lt;&lt;= <span class="number">1</span>);</div><div class="line">        </div><div class="line">        V.clear(), Vmode.clear();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>, r; l &lt; N; l = r+<span class="number">1</span>) &#123;</div><div class="line">            r = min(l + PILE - <span class="number">1</span>, N<span class="number">-1</span>);</div><div class="line">            V.push_back(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;(A+l, A+r+<span class="number">1</span>));</div><div class="line">            Vmode.push_back(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;());</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; V.size(); i++) &#123;</div><div class="line">            sort(V[i].begin(), V[i].end());</div><div class="line">            <span class="keyword">int</span> mx_cnt = <span class="number">1</span>, cnt = <span class="number">1</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= V[i].size(); j++) &#123;</div><div class="line">                <span class="keyword">if</span> (j == V[i].size() || V[i][j] != V[i][j<span class="number">-1</span>]) &#123;</div><div class="line">                    <span class="keyword">if</span> (cnt &gt; mx_cnt)	</div><div class="line">                        mx_cnt = cnt, Vmode[i].clear();</div><div class="line">                    <span class="keyword">if</span> (cnt == mx_cnt)</div><div class="line">                        Vmode[i].push_back(V[i][j<span class="number">-1</span>]);</div><div class="line">                    cnt = <span class="number">1</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    cnt++;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++) <span class="comment">// value range</span></div><div class="line">            POS[i].clear(), q_dup[i] = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">            POS[A[i]].push_back(i);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = N<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--)</div><div class="line">            belong[i] = i / PILE;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">compute_cnt</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (q_dup[x] == q_cases)</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        q_dup[x] = q_cases;</div><div class="line">        <span class="keyword">int</span> va = (<span class="keyword">int</span>) (lower_bound(POS[x].begin(), POS[x].end(), l) - POS[x].begin()) - <span class="number">1</span>;</div><div class="line">        <span class="keyword">int</span> vb = (<span class="keyword">int</span>) (upper_bound(POS[x].begin(), POS[x].end(), r) - POS[x].begin()) - <span class="number">1</span>;</div><div class="line">        <span class="keyword">return</span> vb - va;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> &amp;a, <span class="keyword">int</span> &amp;b)</span> </span>&#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> t;</div><div class="line">        q_cases++;</div><div class="line">        a = b = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (belong[l] == belong[r]) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = l; i &lt;= r; i++) &#123;</div><div class="line">                t = compute_cnt(A[i], l, r);</div><div class="line">                <span class="keyword">if</span> (t &gt; a)	a = t, b = <span class="number">0</span>;</div><div class="line">                <span class="keyword">if</span> (t == a)	b++;</div><div class="line">            &#125;	</div><div class="line">            <span class="keyword">return</span> ;		</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = belong[l]+<span class="number">1</span>; i &lt; belong[r]; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; Vmode[i].size(); j++) &#123;</div><div class="line">                t = compute_cnt(Vmode[i][j], l, r);</div><div class="line">                <span class="keyword">if</span> (t &gt; a)	a = t, b = <span class="number">0</span>;</div><div class="line">                <span class="keyword">if</span> (t == a)	b++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = (belong[a]+<span class="number">1</span>)*PILE<span class="number">-1</span>; i &gt;= l; i--) &#123;</div><div class="line">            t = compute_cnt(A[i], l, r);</div><div class="line">            <span class="keyword">if</span> (t &gt; a)	a = t, b = <span class="number">0</span>;</div><div class="line">            <span class="keyword">if</span> (t == a)	b++;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = (belong[b])*PILE; i &lt;= r; i++) &#123;</div><div class="line">            t = compute_cnt(A[i], l, r);</div><div class="line">            <span class="keyword">if</span> (t &gt; a)	a = t, b = <span class="number">0</span>;</div><div class="line">            <span class="keyword">if</span> (t == a)	b++;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125; dream;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m, l, r, a, b;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;dream.A[i]);</div><div class="line">        dream.make(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;l, &amp;r);</div><div class="line">            l--, r--;</div><div class="line">            dream.query(l, r, a, b);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, a, b);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="分塊在線-2"><a href="#分塊在線-2" class="headerlink" title="分塊在線 2"></a>分塊在線 2</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">100005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXS = <span class="number">35</span>;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModeQuery</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Kit</span> &#123;</span></div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">short</span> cnt[MAXN], freq[MAXN];</div><div class="line">        <span class="keyword">int</span> mode_idx;</div><div class="line">        Kit() &#123;</div><div class="line">            init();</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">            mode_idx = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">            freq[cnt[x]]--;</div><div class="line">            cnt[x] += val;</div><div class="line">            freq[cnt[x]]++;</div><div class="line">            <span class="keyword">if</span> (cnt[x] &gt; mode_idx)</div><div class="line">                mode_idx = cnt[x];</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">resume</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">            freq[cnt[x]]--;</div><div class="line">            cnt[x] -= val;</div><div class="line">            freq[cnt[x]]++;</div><div class="line">        &#125; </div><div class="line">    &#125; f[MAXS * MAXS/<span class="number">2</span>], kit;</div><div class="line">    <span class="keyword">int</span> fr[MAXS][MAXS];</div><div class="line">    <span class="keyword">int</span> A[MAXN], N, PILE, belong[MAXN];</div><div class="line">    <span class="built_in">vector</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt; V;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">heavy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> ff = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; V.size(); i++)</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; V.size(); j++)</div><div class="line">                fr[i][j] = ff++;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; V.size(); i++)</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j++)</div><div class="line">                fr[i][j] = ff;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; V.size(); i++) &#123;</div><div class="line">            f[fr[i][i]].init();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = V[i].first; j &lt;= V[i].second; j++)</div><div class="line">                f[fr[i][i]].add(A[j], <span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; V.size(); i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i+<span class="number">1</span>; j &lt; V.size(); j++) &#123;</div><div class="line">                f[fr[i][j]] = f[fr[i][j<span class="number">-1</span>]];</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = V[j].first; k &lt;= V[j].second; k++)</div><div class="line">                    f[fr[i][j]].add(A[k], <span class="number">1</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">make</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        N = n;</div><div class="line">        PILE = (<span class="keyword">int</span>) <span class="built_in">pow</span>(n, <span class="number">0.70</span>) + <span class="number">1</span>;</div><div class="line">                </div><div class="line">        V.clear();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>, r; l &lt; N; l = r+<span class="number">1</span>) &#123;</div><div class="line">            r = min(l + PILE - <span class="number">1</span>, N<span class="number">-1</span>);</div><div class="line">            V.push_back(make_pair(l, r));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = N<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--)</div><div class="line">            belong[i] = i / PILE;</div><div class="line">        heavy();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> &amp;a, <span class="keyword">int</span> &amp;b)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> bl = belong[l], br = belong[r];</div><div class="line">        <span class="keyword">if</span> (bl == br || r - l &lt;= PILE + <span class="number">10</span>) &#123;</div><div class="line">            kit.init();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = l; i &lt;= r; i++)</div><div class="line">                kit.add(A[i], <span class="number">1</span>);</div><div class="line">            a = kit.freq[kit.mode_idx], b = kit.mode_idx;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = l; i &lt;= r; i++)</div><div class="line">                kit.resume(A[i], <span class="number">1</span>);</div><div class="line">            <span class="keyword">return</span> ;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (l &gt;= <span class="number">0</span> &amp;&amp; belong[l<span class="number">-1</span>] == bl)	</div><div class="line">            bl++;</div><div class="line">        <span class="keyword">if</span> (r &lt; N &amp;&amp; belong[r+<span class="number">1</span>] == br)</div><div class="line">            br--;</div><div class="line">        Kit &amp;tmp = f[fr[bl][br]];</div><div class="line">        <span class="keyword">int</span> tmp_mode_idx = tmp.mode_idx;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = bl*PILE - <span class="number">1</span>; i &gt;= l; i--)</div><div class="line">            tmp.add(A[i], <span class="number">1</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = (br+<span class="number">1</span>)*PILE; i &lt;= r; i++)</div><div class="line">            tmp.add(A[i], <span class="number">1</span>);</div><div class="line">        a = tmp.freq[tmp.mode_idx], b = tmp.mode_idx;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = bl*PILE - <span class="number">1</span>; i &gt;= l; i--)</div><div class="line">            tmp.resume(A[i], <span class="number">1</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = (br+<span class="number">1</span>)*PILE; i &lt;= r; i++)</div><div class="line">            tmp.resume(A[i], <span class="number">1</span>);</div><div class="line">        tmp.mode_idx = tmp_mode_idx;</div><div class="line">    &#125;</div><div class="line">&#125; dream;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m, l, r, a, b;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;dream.A[i]);</div><div class="line">        dream.make(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;l, &amp;r);</div><div class="line">            l--, r--;</div><div class="line">            dream.query(l, r, a, b);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, b, a);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b418" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/02/zj-b418/" class="article-date">
  <time datetime="2015-07-01T22:15:41.000Z" itemprop="datePublished">2015-07-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/02/zj-b418/">b418. 八成真物</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/02/zj-b418/" data-id="cktgl1qyz011a14vng7e1bg7v" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/02/zj-b418/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bitset/">bitset</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/窮舉/">窮舉</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><blockquote>
<p>「偽物比真物更有價值」—貝木泥舟<br>「真物和偽物一樣有價值」—忍野咩咩<br>「偽娘比真娘更有價值」—精英島民</p>
</blockquote>
<p>任兩個物品的相似度<span>$sim(A, B) = \frac{|A \cap B|}{|A \cup B|}$</span><!-- Has MathJax -->，換句話說把 <span>$A$</span><!-- Has MathJax --> 具有的特徵和 <span>$B$</span><!-- Has MathJax --> 具有的特徵類型取交集、聯集個數，相除就能得到其相似度。例如有 5 個特徵，若 A 表示成 11001、B 表示成 01100<span>$sim(A, B) = \frac{|{2}|}{|{1, 2, 3, 5}|} = 0.25$</span><!-- Has MathJax -->。</p>
<p>現在盤面上有 N 個物品、M 種特徵，請問相似度大於等於 0.8 的相似對數 <span>$S$</span><!-- Has MathJax --> 有多少種。為了讓這一題更有趣味，算法允許偽物，輸出<span>$\frac{S}{N(N-1)/2} \times 100$</span><!-- Has MathJax -->。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">8 10</div><div class="line">0111101101</div><div class="line">0111101100</div><div class="line">0111101100</div><div class="line">0111101101</div><div class="line">1100101010</div><div class="line">0111101100</div><div class="line">0111101100</div><div class="line">0011101111</div><div class="line">  </div><div class="line">8 10</div><div class="line">1111101100</div><div class="line">1011101100</div><div class="line">1010101100</div><div class="line">1010111010</div><div class="line">0100110100</div><div class="line">1011101100</div><div class="line">1110110000</div><div class="line">1011111100</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">53.57</div><div class="line">25.00</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>利用 <code>std::bitset</code> 加速交集和聯集運算，將數個屬性壓縮到一個 32-bits 單位，然後藉 bitcount 盡可能在 <span>$O(1)$</span><!-- Has MathJax --> 的時間內完成，就有機會通過這一題。一般的 <span>$O(N^2 M)$</span><!-- Has MathJax --> 比 <span>$O(N^2 M/32)$</span><!-- Has MathJax --> 慢個五六倍。</p>
<p>此外，特別小心浮點數計算誤差，<code>5.0/4.0 &gt;= 0.8 == false</code>，用乘法判定大於閥值的操作。</p>
<p>關於 LSH 的部分，還在進行測試，若 signature 計算太慢，還不如直接暴力法，若能分散找到 signature 或者是預先有辦法處理好，那分桶計算就會好一點。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m;</div><div class="line">    <span class="keyword">char</span> s[<span class="number">1024</span>];</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</div><div class="line">        <span class="built_in">bitset</span>&lt;512&gt; attr[n];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%s"</span>, s);</div><div class="line">            attr[i] = <span class="built_in">bitset</span>&lt;<span class="number">512</span>&gt;(s);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">double</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i+<span class="number">1</span>; j &lt; n; j++) &#123;</div><div class="line">                <span class="keyword">int</span> a = (attr[i]&amp;attr[j]).count();</div><div class="line">                <span class="keyword">int</span> b = (attr[i]|attr[j]).count();</div><div class="line">                <span class="keyword">if</span> (<span class="number">5</span> * a &gt;= <span class="number">4</span> * b)</div><div class="line">                    ret++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%.2lf\n"</span>, ret * <span class="number">100</span> / (n * (n<span class="number">-1</span>)/<span class="number">2</span>));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b413" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/29/zj-b413/" class="article-date">
  <time datetime="2015-06-28T23:09:51.000Z" itemprop="datePublished">2015-06-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/29/zj-b413/">b413. 虛擬女友</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/29/zj-b413/" data-id="cktgl1qyf010014vnf3rd9zfq" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/29/zj-b413/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/并查集/">并查集</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>曾經有一部採訪影片《BBC 紀錄片：別和日本人談性 No Sex. We’re Japanese.》在網路上流傳，其中有一段談到虛擬遊戲中的生活，不少男性以遊戲中的女角發生關係，其中以一款遊戲「Love Plus」為大宗，即使是擁有現實和虛擬的生活，若要選擇其中一方站，不少男性仍然「我選擇死亡」回答。</p>
<p>現在先不解決男女雙方的問題、在彼此關係上要如何運作，如何回到早些年沒有遊戲機、沒有網路、更沒有虛擬女友的交際生活，只有同性朋友要怎麼交流呢？於是有一場專門為這些男性舉行的一場交友會，規則如下所述：</p>
<ul>
<li>一開始全場男性都彼此不認識</li>
<li>每一個男性分別喜歡各自的虛擬女友 (可以是同一個)</li>
<li>每一個時刻，其中兩個男性會因談論遊戲而成為朋友</li>
<li>自己朋友的朋友也會成為朋友</li>
<li>如果朋友的虛擬女友的類型不同，他們有可能會因偏好女友類型不同而爭吵，稱為不穩定對。</li>
</ul>
<p>請問每一個時刻下，有多少穩定對朋友。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">2</div><div class="line"></div><div class="line">3 2</div><div class="line">1 2 1</div><div class="line">1 2</div><div class="line">2 3</div><div class="line"></div><div class="line">4 4</div><div class="line">1 2 2 1</div><div class="line">1 2</div><div class="line">2 3</div><div class="line">1 3</div><div class="line">2 4</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">0</div><div class="line">1</div><div class="line">0</div><div class="line">1</div><div class="line">1</div><div class="line">2</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>IPSC 2015 F 那一題發生於男女雙方都會進行聯集，而這一題只有男方會進行聯集。</p>
<p>合併兩團男時，只有下標 (女友類型) 相同會成為穩定對，可以利用合併排序來完成，能發生合併表示男的彼此之間不認識，只要考慮有多少女方相同即可。每一次將小堆合併到大堆中，由於要計數合併複雜度需要 <span>$O(min(|A|, |B|) \times \log N)$</span><!-- Has MathJax -->，若搭配 hash 可以降到 <span>$O(min(|A|, |B|)$</span><!-- Has MathJax -->。一般并查集 joint 複雜度為 <span>$O(1)$</span><!-- Has MathJax -->，整體操作只需要 <span>$O(N)$</span><!-- Has MathJax -->，但為了要計數，整體的複雜度為 <span>$O(N \log N)$</span><!-- Has MathJax -->。</p>
<p>可以選擇合併排序來完成，每一次把兩堆的女方列出來，把兩堆相同類型的次數相乘，列出來可以循序做，或者是串列完成，每一次保證堆裡面的女方順序是由小排到大，合併複雜度就為 <span>$O(|A| + |B|)$</span><!-- Has MathJax -->，均攤下複雜度為 <span>$O(N \log N)$</span><!-- Has MathJax -->，當測資不夠隨機複雜度會掉到 <span>$O(N^2)$</span><!-- Has MathJax -->，情況是每一次只把大小為 1 的堆合併到大小 i-1 的堆。</p>
<p>在測資隨機生成下，第二種作法會來得比第一種快。第一種做法要搭配 <code>ordered_map</code> 或者是 <code>unordered_map</code>，寫起來會比較不方便。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">65536</span>;</div><div class="line"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; son[MAXN];</div><div class="line"><span class="keyword">int</span> parent[MAXN], A[MAXN];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> testcase, n, m;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;testcase);</div><div class="line">    <span class="keyword">while</span> (testcase--) &#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;A[i]);</div><div class="line">        <span class="keyword">long</span> <span class="keyword">long</span> tot_pair = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> x, y;</div><div class="line">        <span class="built_in">map</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;, <span class="keyword">int</span> &gt; R;</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            parent[i] = i;</div><div class="line">            son[i].resize(<span class="number">1</span>, i);</div><div class="line">            R[pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;(i, A[i])] = <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;x, &amp;y);</div><div class="line">            x--, y--;</div><div class="line">            x = parent[x], y = parent[y];</div><div class="line">            <span class="keyword">if</span> (x != y) &#123; <span class="comment">// merge small to large</span></div><div class="line">                <span class="keyword">if</span> (son[x].size() &gt; son[y].size())</div><div class="line">                    swap(x, y);</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;e: son[x]) &#123;</div><div class="line">                    pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; t(parent[e], A[e]);</div><div class="line">                    R[t]--;</div><div class="line">                    <span class="keyword">if</span> (R[t] == <span class="number">0</span>)  R.erase(t);</div><div class="line">                    parent[e] = y;</div><div class="line">                    son[y].push_back(e);</div><div class="line">                    tot_pair += R[pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;(parent[e], A[e])];</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;e: son[x])</div><div class="line">                    R[pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;(parent[e], A[e])]++;</div><div class="line">                son[x].clear();</div><div class="line">            &#125;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, tot_pair);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b416" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/27/zj-b416/" class="article-date">
  <time datetime="2015-06-27T13:34:13.000Z" itemprop="datePublished">2015-06-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/27/zj-b416/">b416. 誤會妹子序列</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/27/zj-b416/" data-id="cktgl1qyx011414vnj7tt2hfn" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/27/zj-b416/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BIT/">BIT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/可持久化/">可持久化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/掃描線/">掃描線</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/莫隊算法/">莫隊算法</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在 2015 年 6 月的 Facebook 上，不少以「靠北」為前綴命名的粉絲頁面，就如 靠北工程師 為例，不少業界工程師匿名在上面抱怨工作過時、主管、生活 … 等。突然有一篇 #靠北工程師7257 抱怨著編程競賽的零零種種，從回應中能明白存在業界工程師不清楚編程競賽，以 UI 介面、cmd 指令 … 等方式理解比賽的目標、運行。</p>
<p>網路處處有答案，演算法和資料結構到底重不重要？抄下來能用就行，大部分的要求是不講求效率的，但對於曾經在編程競賽待過一陣子的小夥伴而言，看到他們的理解方式開始感到憤憤不平，進行了一陣子的爭吵。</p>
<p>過一陣子，大批的學生開始進入 靠北工程師 裡發文，開始爭論學校、系所哪個是比較有未來的，突然間有一位資管系的同學發問這一道算法題 ‪#‎靠北工程師7780‬ ，結果一不小心就看錯題目，把種類數誤看成個數，於是討論了不少其他的算法來完成，現在就把這個問題交給你。</p>
<p>用各種算法解決這個誤解的題目。</p>
<h3 id="問題描述"><a href="#問題描述" class="headerlink" title="問題描述"></a>問題描述</h3><p>Autumn 和 Bakser 又在研究 Gty 的妹子序列了！</p>
<p>但他們遇到了一個難題，對於一段妹子們，他們想讓你幫忙求出這之內美麗度 <span>$s_i \in [a, b]$</span><!-- Has MathJax --> 的妹子個數。為了方便，我們規定妹子們的美麗度全都在 <span>$[1,n]$</span><!-- Has MathJax --> 中。</p>
<p>給定一個長度為 <span>$n$</span><!-- Has MathJax --> ( <span>$1 \le n \le 100000$</span><!-- Has MathJax --> ) 的正整數序列 <span>$s$</span><!-- Has MathJax --> (<span>$1 \le s_i \le n$</span><!-- Has MathJax -->)，對於 <span>$m$</span><!-- Has MathJax --> ( <span>$1 \le m \le 1000000$</span><!-- Has MathJax -->) 次詢問 <span>$l, r, a, b$</span><!-- Has MathJax -->，每次輸出 <span>$[s_l, \text{... },s_r]$</span><!-- Has MathJax --> 中，權值 <span>$s_i \in [a, b]$</span><!-- Has MathJax --> 的個數。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">10 10</div><div class="line">4 4 5 1 4 1 5 1 2 1</div><div class="line">5 9 1 2</div><div class="line">3 4 7 9</div><div class="line">4 4 2 5</div><div class="line">2 3 4 7</div><div class="line">5 10 4 4</div><div class="line">3 9 1 1</div><div class="line">1 4 5 9</div><div class="line">8 9 3 3</div><div class="line">2 2 1 6</div><div class="line">8 9 1 4</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">3</div><div class="line">0</div><div class="line">0</div><div class="line">2</div><div class="line">1</div><div class="line">3</div><div class="line">1</div><div class="line">0</div><div class="line">1</div><div class="line">2</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>相較於 b414. BZOJ 3809 Gty 的二逼妹子序列 解法會相對多樣，單純計數就會變得比較簡單。</p>
<p>在這一題中，這裡提供三種解法：</p>
<ul>
<li>莫隊算法<br>只能離線處理，無法強制在線詢問，算法複雜度由分塊降到 <span>$O(N^{1.5})$</span><!-- Has MathJax -->。可參考 b414 的解法。</li>
<li>掃描線 + BIT<br>只能離線處理，把題目轉換成二維情況 <span>$(i, A[i])$</span><!-- Has MathJax -->，詢問相當於找到矩形內部 <span>$[l, r] \times [a, b]$</span><!-- Has MathJax --> 有多少點座標，所以可以當作二維前綴來完成計數 <span>$f(l, r, a, b) = f(r, b) - f(l-1, b) - f(r, a-1) - f(l-1, a-1)$</span><!-- Has MathJax -->。<span>$f(x, y)$</span><!-- Has MathJax --> 表示從原點 <span>$(0, 0)$</span><!-- Has MathJax --> 到 <span>$(x, y)$</span><!-- Has MathJax --> 的點數量，這樣的方式記憶體過多，利用掃描線算法降下來，對 x 由小掃描到大，依序將點插入詢問 <span>$f(x, y)$</span><!-- Has MathJax --> 會在掃瞄到 x 時，詢問 <span>$[0, y]$</span><!-- Has MathJax --> 之間的累計個數得到，最後將每一個詢問離線成四個詢問，掃描一次即可。</li>
<li>可持久化線段樹<br>必須預處理，支持在線詢問，不帶操作修改。將序列權值排序 <span>$(A[i], i)$</span><!-- Has MathJax -->，依序索引值插入線段樹，紀錄每一個插入完的線段樹狀態，接著當詢問 <span>$l, r, a, b$</span><!-- Has MathJax -->，相當於在版本 <code>ver_b - ver_a</code> 查詢線段樹區間 <span>$[l, r]$</span><!-- Has MathJax --> 的總和。由於是計數符合區間減法才能這樣做，否則持久化線段樹還要套別的小技巧來完成。</li>
</ul>
<p>補充一點，雖然 KD-tree 效能是 <span>$O(\sqrt{N} + K)$</span><!-- Has MathJax -->，它也支持 range searching，但必須搭配 report K 操作，那個 <span>$O(\sqrt{N})$</span><!-- Has MathJax --> 的花費是伴隨著 report 存在，因此單一筆計數詢問是無法達到 <span>$O(\sqrt{N})$</span><!-- Has MathJax -->，天真的我寫下去直接 TLE。</p>
<h3 id="莫隊算法"><a href="#莫隊算法" class="headerlink" title="莫隊算法"></a>莫隊算法</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">100005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXV = <span class="number">100005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXQ = <span class="number">1000005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXSQRTV = <span class="number">512</span>;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Offline</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Event</span> &#123;</span></div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> PILE, belong[MAXV];</div><div class="line">        <span class="keyword">int</span> l, r, x, y, qid;</div><div class="line">        Event(<span class="keyword">int</span> a = <span class="number">0</span>, <span class="keyword">int</span> b = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>, <span class="keyword">int</span> d = <span class="number">0</span>, <span class="keyword">int</span> e = <span class="number">0</span>):</div><div class="line">            l(a), r(b), x(c), y(d), qid(e) &#123;&#125;</div><div class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Event &amp;x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">if</span> (belong[l] != belong[x.l])</div><div class="line">                <span class="keyword">return</span> l &lt; x.l;</div><div class="line">            <span class="keyword">return</span> r &lt; x.r; </div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">int</span> A[MAXN], N, qsize;</div><div class="line">    Event event[MAXQ];</div><div class="line">    <span class="keyword">int</span> ret[MAXQ];</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> N)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>-&gt;N = N, qsize = <span class="number">0</span>;</div><div class="line">        <span class="built_in">memset</span>(pile, <span class="number">0</span>, <span class="keyword">sizeof</span>(pile));</div><div class="line">        <span class="built_in">memset</span>(val_count, <span class="number">0</span>, <span class="keyword">sizeof</span>(val_count));</div><div class="line">        val_PILE = Event::PILE = <span class="built_in">sqrt</span>(N);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = N; i &gt;= <span class="number">1</span>; i--)</div><div class="line">            val_belong[i] = Event::belong[i] = i / Event::PILE;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">q_add</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">        event[qsize] = Event(l, r, a, b, qsize);</div><div class="line">        qsize++;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        sort(event, event+qsize);</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> l = <span class="number">1</span>, r = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; qsize; i++) &#123;</div><div class="line">            <span class="keyword">while</span> (r &lt; event[i].r)	r++, update(A[r], <span class="number">1</span>);</div><div class="line">            <span class="keyword">while</span> (r &gt; event[i].r)	update(A[r], <span class="number">-1</span>), r--;</div><div class="line">            <span class="keyword">while</span> (l &gt; event[i].l)	l--, update(A[l], <span class="number">1</span>);</div><div class="line">            <span class="keyword">while</span> (l &lt; event[i].l)	update(A[l], <span class="number">-1</span>), l++;</div><div class="line">            ret[event[i].qid] = query(event[i].x, event[i].y);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="comment">// unrolled</span></div><div class="line">    <span class="keyword">int</span> pile[MAXSQRTV], val_count[MAXV], val_belong[MAXV], val_PILE;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">        val_count[x] += val;</div><div class="line">        pile[val_belong[x]] += val;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (val_belong[a] == val_belong[b]) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = a; i &lt;= b; i++)</div><div class="line">                ret += val_count[i];</div><div class="line">            <span class="keyword">return</span> ret;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = val_belong[a]+<span class="number">1</span>; i &lt; val_belong[b]; i++)</div><div class="line">            ret += pile[i];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = (val_belong[a]+<span class="number">1</span>)*val_PILE<span class="number">-1</span>; i &gt;= a; i--)</div><div class="line">            ret += val_count[i];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = (val_belong[b])*val_PILE; i &lt;= b; i++)</div><div class="line">            ret += val_count[i];</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125; off;</div><div class="line"><span class="keyword">int</span> Offline::Event::PILE = <span class="number">16</span>, Offline::Event::belong[MAXV];</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> mLocalStream &#123;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">readchar</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> buf[N];</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> *p = buf, *end = buf;</div><div class="line">        <span class="keyword">if</span>(p == end) &#123;</div><div class="line">            <span class="keyword">if</span>((end = buf + fread(buf, <span class="number">1</span>, N, <span class="built_in">stdin</span>)) == buf) <span class="keyword">return</span> EOF;</div><div class="line">            p = buf;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> *p++;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">ReadInt</span><span class="params">(<span class="keyword">int</span> *x)</span> </span>&#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> c, neg;</div><div class="line">        <span class="keyword">while</span>((c = readchar()) &lt; <span class="string">'-'</span>)    &#123;<span class="keyword">if</span>(c == EOF) <span class="keyword">return</span> <span class="number">0</span>;&#125;</div><div class="line">        neg = (c == <span class="string">'-'</span>) ? <span class="number">-1</span> : <span class="number">1</span>;</div><div class="line">        *x = (neg == <span class="number">1</span>) ? c-<span class="string">'0'</span> : <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>((c = readchar()) &gt;= <span class="string">'0'</span>)</div><div class="line">            *x = (*x &lt;&lt; <span class="number">3</span>) + (*x &lt;&lt; <span class="number">1</span>) + c-<span class="string">'0'</span>;</div><div class="line">        *x *= neg;</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Print</span> &#123;</span></div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">        <span class="keyword">char</span> buf[N], *p, *end;</div><div class="line">        Print() &#123;</div><div class="line">            p = buf, end = buf + N - <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">printInt</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">            <span class="keyword">static</span> <span class="keyword">char</span> stk[<span class="number">16</span>];</div><div class="line">            <span class="keyword">int</span> idx = <span class="number">0</span>;</div><div class="line">            stk[idx++] = <span class="string">'\n'</span>;</div><div class="line">            <span class="keyword">if</span> (!x)	</div><div class="line">                stk[idx++] = <span class="string">'0'</span>;</div><div class="line">            <span class="keyword">while</span> (x)</div><div class="line">                stk[idx++] = x%<span class="number">10</span> + <span class="string">'0'</span>, x /= <span class="number">10</span>;</div><div class="line">            <span class="keyword">while</span> (idx) &#123;</div><div class="line">                <span class="keyword">if</span> (p == end) &#123;</div><div class="line">                    *p = <span class="string">'\0'</span>;</div><div class="line">                    <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf), p = buf;</div><div class="line">                &#125;</div><div class="line">                *p = stk[--idx], p++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ~Print() &#123;</div><div class="line">            *p = <span class="string">'\0'</span>;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf);</div><div class="line">        &#125;		</div><div class="line">    &#125; bprint;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m, l, r, a, b;</div><div class="line">    <span class="keyword">while</span> (mLocalStream::ReadInt(&amp;n)) &#123;</div><div class="line">        mLocalStream::ReadInt(&amp;m);</div><div class="line">        off.init(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</div><div class="line">            mLocalStream::ReadInt(&amp;off.A[i]);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">            mLocalStream::ReadInt(&amp;l);</div><div class="line">            mLocalStream::ReadInt(&amp;r);</div><div class="line">            mLocalStream::ReadInt(&amp;a);</div><div class="line">            mLocalStream::ReadInt(&amp;b);</div><div class="line">            off.q_add(l, r, a, b);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        off.run();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++)</div><div class="line">            mLocalStream::bprint.printInt(off.ret[i]);</div><div class="line"><span class="comment">//			printf("%d\n", off.ret[i]);</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="掃描線"><a href="#掃描線" class="headerlink" title="掃描線"></a>掃描線</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//#include &lt;bits/stdc++.h&gt;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">100005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXQ = <span class="number">1000005</span>;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Event</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> y, qid, qtype;</div><div class="line">    Event(<span class="keyword">int</span> a = <span class="number">0</span>, <span class="keyword">int</span> b = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>):</div><div class="line">    y(a), qid(b), qtype(c) &#123;&#125;</div><div class="line">&#125;;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BIT</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">int</span> v[MAXN], N;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> N)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>-&gt;N = N;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= N; i++)</div><div class="line">            v[i] = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (x &lt;= N) &#123;</div><div class="line">            v[x] += val;</div><div class="line">            x += x&amp;(-x);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> (x) &#123;</div><div class="line">            sum += v[x];</div><div class="line">            x -= x&amp;(-x);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sum;</div><div class="line">    &#125;</div><div class="line">&#125; bit;</div><div class="line"><span class="keyword">namespace</span> mLocalStream &#123;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">readchar</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> buf[N];</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> *p = buf, *end = buf;</div><div class="line">        <span class="keyword">if</span>(p == end) &#123;</div><div class="line">            <span class="keyword">if</span>((end = buf + fread(buf, <span class="number">1</span>, N, <span class="built_in">stdin</span>)) == buf) <span class="keyword">return</span> EOF;</div><div class="line">            p = buf;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> *p++;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">ReadInt</span><span class="params">(<span class="keyword">int</span> *x)</span> </span>&#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> c, neg;</div><div class="line">        <span class="keyword">while</span>((c = readchar()) &lt; <span class="string">'-'</span>)    &#123;<span class="keyword">if</span>(c == EOF) <span class="keyword">return</span> <span class="number">0</span>;&#125;</div><div class="line">        neg = (c == <span class="string">'-'</span>) ? <span class="number">-1</span> : <span class="number">1</span>;</div><div class="line">        *x = (neg == <span class="number">1</span>) ? c-<span class="string">'0'</span> : <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>((c = readchar()) &gt;= <span class="string">'0'</span>)</div><div class="line">            *x = (*x &lt;&lt; <span class="number">3</span>) + (*x &lt;&lt; <span class="number">1</span>) + c-<span class="string">'0'</span>;</div><div class="line">        *x *= neg;</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Print</span> &#123;</span></div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">        <span class="keyword">char</span> buf[N], *p, *end;</div><div class="line">        Print() &#123;</div><div class="line">            p = buf, end = buf + N - <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">printInt</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">            <span class="keyword">static</span> <span class="keyword">char</span> stk[<span class="number">16</span>];</div><div class="line">            <span class="keyword">int</span> idx = <span class="number">0</span>;</div><div class="line">            stk[idx++] = <span class="string">'\n'</span>;</div><div class="line">            <span class="keyword">if</span> (!x)</div><div class="line">                stk[idx++] = <span class="string">'0'</span>;</div><div class="line">            <span class="keyword">while</span> (x)</div><div class="line">                stk[idx++] = x%<span class="number">10</span> + <span class="string">'0'</span>, x /= <span class="number">10</span>;</div><div class="line">            <span class="keyword">while</span> (idx) &#123;</div><div class="line">                <span class="keyword">if</span> (p == end) &#123;</div><div class="line">                    *p = <span class="string">'\0'</span>;</div><div class="line">                    <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf), p = buf;</div><div class="line">                &#125;</div><div class="line">                *p = stk[--idx], p++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ~Print() &#123;</div><div class="line">            *p = <span class="string">'\0'</span>;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf);</div><div class="line">        &#125;		</div><div class="line">    &#125; bprint;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> n, m, A[MAXN], ret[MAXQ];</div><div class="line"><span class="built_in">vector</span>&lt;Event&gt; event[MAXN]; <span class="comment">// event[pos]</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (mLocalStream::ReadInt(&amp;n)) &#123;</div><div class="line">        mLocalStream::ReadInt(&amp;m);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</div><div class="line">            mLocalStream::ReadInt(A+i), event[i].clear();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">            <span class="keyword">int</span> l, r, a, b;</div><div class="line">            mLocalStream::ReadInt(&amp;l);</div><div class="line">            mLocalStream::ReadInt(&amp;r);</div><div class="line">            mLocalStream::ReadInt(&amp;a);</div><div class="line">            mLocalStream::ReadInt(&amp;b);</div><div class="line">            <span class="comment">// area [l, a] - [r, b] = [r, b] - [l-1, b] - [r, a-1] + [l-1, a-1]</span></div><div class="line">            event[r].push_back(Event(b, i, <span class="number">1</span>));</div><div class="line">            event[l<span class="number">-1</span>].push_back(Event(b, i, <span class="number">-1</span>));</div><div class="line">            event[r].push_back(Event(a<span class="number">-1</span>, i, <span class="number">-1</span>));</div><div class="line">            event[l<span class="number">-1</span>].push_back(Event(a<span class="number">-1</span>, i, <span class="number">1</span>));</div><div class="line">            ret[i] = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        bit.init(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            bit.add(A[i], <span class="number">1</span>);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;e: event[i]) &#123;</div><div class="line">                <span class="keyword">int</span> val = bit.query(e.y);</div><div class="line">                ret[e.qid] += e.qtype * val;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++)</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, ret[i]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="可持久化"><a href="#可持久化" class="headerlink" title="可持久化"></a>可持久化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXNODE = <span class="number">3000000</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">100005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXQ = <span class="number">100005</span>;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SegementTree</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></div><div class="line">        Node *lson, *rson;</div><div class="line">        <span class="keyword">int</span> val;</div><div class="line">    &#125; nodes[MAXNODE];</div><div class="line">    <span class="keyword">int</span> nodesize, L, R;</div><div class="line">    <span class="function">Node* <span class="title">init</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</div><div class="line">        nodesize = <span class="number">0</span>;</div><div class="line">        L = l, R = r;</div><div class="line">        Node* root = build(l, r);</div><div class="line">        <span class="keyword">return</span> root;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (nodesize &gt;= MAXNODE)</div><div class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">        <span class="keyword">return</span> &amp;nodes[nodesize++];</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">cloneNode</span><span class="params">(Node *p)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (nodesize &gt;= MAXNODE)</div><div class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">        Node* u = &amp;nodes[nodesize++];</div><div class="line">        *u = *p;</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">build</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (l &gt; r)  <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">        Node *u = newNode();</div><div class="line">        u-&gt;lson = u-&gt;rson = <span class="literal">NULL</span>;</div><div class="line">        <span class="keyword">if</span> (l == r) &#123;</div><div class="line">            u-&gt;val = <span class="number">0</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">int</span> m = (l + r)/<span class="number">2</span>;</div><div class="line">            u-&gt;lson = build(l, m);</div><div class="line">            u-&gt;rson = build(m+<span class="number">1</span>, r);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Node* <span class="title">add</span><span class="params">(Node *p, <span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> add(p, x, val, L, R);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(Node *tp, Node *tq, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> query(tp, tq, L, R, x, y);</div><div class="line">    &#125;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="function">Node* <span class="title">add</span><span class="params">(Node *p, <span class="keyword">int</span> x, <span class="keyword">int</span> val, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</div><div class="line">        Node *u = cloneNode(p);</div><div class="line">        u-&gt;val += val;</div><div class="line">        <span class="keyword">if</span> (l == r) &#123;</div><div class="line">            <span class="keyword">return</span> u;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</div><div class="line">            <span class="keyword">if</span> (x &lt;= mid)</div><div class="line">                u-&gt;lson = add(p-&gt;lson, x, val, l, mid);</div><div class="line">            <span class="keyword">else</span></div><div class="line">                u-&gt;rson = add(p-&gt;rson, x, val, mid+<span class="number">1</span>, r);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> u;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(Node *tp, Node *tq, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (x &lt;= l &amp;&amp; r &lt;= y)</div><div class="line">            <span class="keyword">return</span> tq-&gt;val - tp-&gt;val;</div><div class="line">        <span class="keyword">int</span> mid = (l+r)/<span class="number">2</span>;</div><div class="line">        <span class="keyword">if</span> (y &lt;= mid)</div><div class="line">            <span class="keyword">return</span> query(tp-&gt;lson, tq-&gt;lson, l, mid, x, y);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (x &gt; mid)</div><div class="line">            <span class="keyword">return</span> query(tp-&gt;rson, tq-&gt;rson, mid+<span class="number">1</span>, r, x, y);</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="keyword">return</span> query(tp-&gt;lson, tq-&gt;lson, l, mid, x, mid) +</div><div class="line">                query(tp-&gt;rson, tq-&gt;rson, mid+<span class="number">1</span>, r, mid+<span class="number">1</span>, y);</div><div class="line">    &#125;</div><div class="line">&#125; segTree;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> mLocalStream &#123;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">readchar</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> buf[N];</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> *p = buf, *end = buf;</div><div class="line">        <span class="keyword">if</span>(p == end) &#123;</div><div class="line">            <span class="keyword">if</span>((end = buf + fread(buf, <span class="number">1</span>, N, <span class="built_in">stdin</span>)) == buf) <span class="keyword">return</span> EOF;</div><div class="line">            p = buf;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> *p++;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">ReadInt</span><span class="params">(<span class="keyword">int</span> *x)</span> </span>&#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> c, neg;</div><div class="line">        <span class="keyword">while</span>((c = readchar()) &lt; <span class="string">'-'</span>)    &#123;<span class="keyword">if</span>(c == EOF) <span class="keyword">return</span> <span class="number">0</span>;&#125;</div><div class="line">        neg = (c == <span class="string">'-'</span>) ? <span class="number">-1</span> : <span class="number">1</span>;</div><div class="line">        *x = (neg == <span class="number">1</span>) ? c-<span class="string">'0'</span> : <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>((c = readchar()) &gt;= <span class="string">'0'</span>)</div><div class="line">            *x = (*x &lt;&lt; <span class="number">3</span>) + (*x &lt;&lt; <span class="number">1</span>) + c-<span class="string">'0'</span>;</div><div class="line">        *x *= neg;</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Print</span> &#123;</span></div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">        <span class="keyword">char</span> buf[N], *p, *end;</div><div class="line">        Print() &#123;</div><div class="line">            p = buf, end = buf + N - <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">printInt</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">            <span class="keyword">static</span> <span class="keyword">char</span> stk[<span class="number">16</span>];</div><div class="line">            <span class="keyword">int</span> idx = <span class="number">0</span>;</div><div class="line">            stk[idx++] = <span class="string">'\n'</span>;</div><div class="line">            <span class="keyword">if</span> (!x)</div><div class="line">                stk[idx++] = <span class="string">'0'</span>;</div><div class="line">            <span class="keyword">while</span> (x)</div><div class="line">                stk[idx++] = x%<span class="number">10</span> + <span class="string">'0'</span>, x /= <span class="number">10</span>;</div><div class="line">            <span class="keyword">while</span> (idx) &#123;</div><div class="line">                <span class="keyword">if</span> (p == end) &#123;</div><div class="line">                    *p = <span class="string">'\0'</span>;</div><div class="line">                    <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf), p = buf;</div><div class="line">                &#125;</div><div class="line">                *p = stk[--idx], p++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ~Print() &#123;</div><div class="line">            *p = <span class="string">'\0'</span>;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf);</div><div class="line">        &#125;		</div><div class="line">    &#125; bprint;</div><div class="line">&#125;</div><div class="line"></div><div class="line">SegementTree::Node *ver[MAXQ];</div><div class="line">pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; A[MAXN];</div><div class="line"><span class="keyword">int</span> fver[MAXN];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m, x;</div><div class="line">    <span class="keyword">while</span> (mLocalStream::ReadInt(&amp;n)) &#123;</div><div class="line">        mLocalStream::ReadInt(&amp;m);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</div><div class="line">            mLocalStream::ReadInt(&amp;x), A[i] = make_pair(x, i);</div><div class="line">        sort(A+<span class="number">1</span>, A+n+<span class="number">1</span>);</div><div class="line">        </div><div class="line">        ver[<span class="number">0</span>] = segTree.init(<span class="number">1</span>, n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            ver[i] = segTree.add(ver[i<span class="number">-1</span>], A[i].second, <span class="number">1</span>);</div><div class="line">            fver[i] = A[i].first;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">            <span class="keyword">int</span> l, r, a, b;</div><div class="line">            mLocalStream::ReadInt(&amp;l);</div><div class="line">            mLocalStream::ReadInt(&amp;r);</div><div class="line">            mLocalStream::ReadInt(&amp;a);</div><div class="line">            mLocalStream::ReadInt(&amp;b);</div><div class="line">            <span class="keyword">int</span> va = (<span class="keyword">int</span>) (lower_bound(fver+<span class="number">1</span>, fver+n+<span class="number">1</span>, a) - fver) - <span class="number">1</span>;</div><div class="line">            <span class="keyword">int</span> vb = (<span class="keyword">int</span>) (upper_bound(fver+<span class="number">1</span>, fver+n+<span class="number">1</span>, b) - fver) - <span class="number">1</span>;</div><div class="line">            mLocalStream::bprint.printInt(segTree.query(ver[va], ver[vb], l, r));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b414" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/27/zj-b414/" class="article-date">
  <time datetime="2015-06-27T13:20:08.000Z" itemprop="datePublished">2015-06-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/27/zj-b414/">b414. BZOJ 3809 Gty 的二逼妹子序列</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/27/zj-b414/" data-id="cktgl1qyl010b14vnc9wgk1ae" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/27/zj-b414/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/分塊/">分塊</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/莫隊算法/">莫隊算法</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>Autumn 和 Bakser 又在研究 Gty 的妹子序列了！</p>
<p>但他們遇到了一個難題，對於一段妹子們，他們想讓你幫忙求出這之內美麗度 <span>$s_i \in [a, b]$</span><!-- Has MathJax --> 的妹子的美麗度的種類數。為了方便，我們規定妹子們的美麗度全都在 <span>$[1,n]$</span><!-- Has MathJax --> 中。</p>
<p>給定一個長度為 <span>$n$</span><!-- Has MathJax --> ( <span>$1 \le n \le 100000$</span><!-- Has MathJax --> ) 的正整數序列 <span>$s$</span><!-- Has MathJax --> (<span>$1 \le s_i \le n$</span><!-- Has MathJax -->)，對於 <span>$m$</span><!-- Has MathJax --> ( <span>$1 \le m \le 1000000$</span><!-- Has MathJax -->) 次詢問 <span>$l, r, a, b$</span><!-- Has MathJax -->，每次輸出 <span>$[s_l, \text{... },s_r]$</span><!-- Has MathJax --> 中，權值 <span>$s_i \in [a, b]$</span><!-- Has MathJax --> 的權值種類數。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">10 10</div><div class="line">4 4 5 1 4 1 5 1 2 1</div><div class="line">5 9 1 2</div><div class="line">3 4 7 9</div><div class="line">4 4 2 5</div><div class="line">2 3 4 7</div><div class="line">5 10 4 4</div><div class="line">3 9 1 1</div><div class="line">1 4 5 9</div><div class="line">8 9 3 3</div><div class="line">2 2 1 6</div><div class="line">8 9 1 4</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">2</div><div class="line">0</div><div class="line">0</div><div class="line">2</div><div class="line">1</div><div class="line">1</div><div class="line">1</div><div class="line">0</div><div class="line">1</div><div class="line">2</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>解決區間內數字在某個值域內部的種類數。</p>
<p><strong> 前情提要 </strong>，如果單純問區間種類數 (獨特)，可以轉換成找區間內部有多少數字大於右端點，要預處理每一個數字的下一個相同數字的位置，只要符合大於右端點的條件即為獨特。可以使用持久化線段樹來做這件事情，依序加入序列數字，貪心去保留最右側的相同數字是獨特的，藉由多版本的區間相減來完成。</p>
<p>現在特別要求在某個值域內部，那就沒有好方法可解，可以使用莫隊下去完成。但是莫隊算法在區間轉移 (example <code>[l, r] to [l, r+1]</code>) 的效能要縮小到 <span>$O(1)$</span><!-- Has MathJax -->，若使用一般樹結構，莫隊算法會衰退到 <span>$O(N^{1.5} \log N)$</span><!-- Has MathJax -->，還不如修改快一點 <span>$O(1)$</span><!-- Has MathJax -->，詢問慢一點 <span>$O(\sqrt{N})$</span><!-- Has MathJax -->，將值域使用塊狀表方式記錄，來達到 <span>$O(N^{1.5} + Q \sqrt{N})$</span><!-- Has MathJax --></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">100005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXV = <span class="number">100005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXQ = <span class="number">1000005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXSQRTV = <span class="number">512</span>;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Offline</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Event</span> &#123;</span></div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> PILE, belong[MAXV];</div><div class="line">        <span class="keyword">int</span> l, r, x, y, qid;</div><div class="line">        Event(<span class="keyword">int</span> a = <span class="number">0</span>, <span class="keyword">int</span> b = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>, <span class="keyword">int</span> d = <span class="number">0</span>, <span class="keyword">int</span> e = <span class="number">0</span>):</div><div class="line">            l(a), r(b), x(c), y(d), qid(e) &#123;&#125;</div><div class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Event &amp;x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">if</span> (belong[l] != belong[x.l])</div><div class="line">                <span class="keyword">return</span> l &lt; x.l;</div><div class="line">            <span class="keyword">return</span> r &lt; x.r; </div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">int</span> A[MAXN], N, qsize;</div><div class="line">    Event event[MAXQ];</div><div class="line">    <span class="keyword">int</span> ret[MAXQ];</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> N)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>-&gt;N = N, qsize = <span class="number">0</span>;</div><div class="line">        <span class="built_in">memset</span>(pile, <span class="number">0</span>, <span class="keyword">sizeof</span>(pile));</div><div class="line">        <span class="built_in">memset</span>(val_count, <span class="number">0</span>, <span class="keyword">sizeof</span>(val_count));</div><div class="line">        val_PILE = Event::PILE = <span class="built_in">sqrt</span>(N);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = N; i &gt;= <span class="number">1</span>; i--)</div><div class="line">            val_belong[i] = Event::belong[i] = i / Event::PILE;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">q_add</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">        event[qsize] = Event(l, r, a, b, qsize);</div><div class="line">        qsize++;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        sort(event, event+qsize);</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> l = <span class="number">1</span>, r = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; qsize; i++) &#123;</div><div class="line">            <span class="keyword">while</span> (r &lt; event[i].r)	r++, update(A[r], <span class="number">1</span>);</div><div class="line">            <span class="keyword">while</span> (r &gt; event[i].r)	update(A[r], <span class="number">-1</span>), r--;</div><div class="line">            <span class="keyword">while</span> (l &gt; event[i].l)	l--, update(A[l], <span class="number">1</span>);</div><div class="line">            <span class="keyword">while</span> (l &lt; event[i].l)	update(A[l], <span class="number">-1</span>), l++;</div><div class="line">            ret[event[i].qid] = query(event[i].x, event[i].y);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="comment">// unrolled</span></div><div class="line">    <span class="keyword">int</span> pile[MAXSQRTV], val_count[MAXV], val_belong[MAXV], val_PILE;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">        val_count[x] += val;</div><div class="line">        <span class="keyword">if</span> (val == <span class="number">-1</span> &amp;&amp; val_count[x] == <span class="number">0</span>)</div><div class="line">            pile[val_belong[x]]--;</div><div class="line">        <span class="keyword">if</span> (val == <span class="number">1</span> &amp;&amp; val_count[x] == <span class="number">1</span>)</div><div class="line">            pile[val_belong[x]]++;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (val_belong[a] == val_belong[b]) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = a; i &lt;= b; i++)</div><div class="line">                ret += val_count[i] &gt; <span class="number">0</span>;</div><div class="line">            <span class="keyword">return</span> ret;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = val_belong[a]+<span class="number">1</span>; i &lt; val_belong[b]; i++)</div><div class="line">            ret += pile[i];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = (val_belong[a]+<span class="number">1</span>)*val_PILE<span class="number">-1</span>; i &gt;= a; i--)</div><div class="line">            ret += val_count[i] &gt; <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = (val_belong[b])*val_PILE; i &lt;= b; i++)</div><div class="line">            ret += val_count[i] &gt; <span class="number">0</span>;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125; off;</div><div class="line"><span class="keyword">int</span> Offline::Event::PILE = <span class="number">16</span>, Offline::Event::belong[MAXV];</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> mLocalStream &#123;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">readchar</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> buf[N];</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> *p = buf, *end = buf;</div><div class="line">        <span class="keyword">if</span>(p == end) &#123;</div><div class="line">            <span class="keyword">if</span>((end = buf + fread(buf, <span class="number">1</span>, N, <span class="built_in">stdin</span>)) == buf) <span class="keyword">return</span> EOF;</div><div class="line">            p = buf;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> *p++;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">ReadInt</span><span class="params">(<span class="keyword">int</span> *x)</span> </span>&#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> c, neg;</div><div class="line">        <span class="keyword">while</span>((c = readchar()) &lt; <span class="string">'-'</span>)    &#123;<span class="keyword">if</span>(c == EOF) <span class="keyword">return</span> <span class="number">0</span>;&#125;</div><div class="line">        neg = (c == <span class="string">'-'</span>) ? <span class="number">-1</span> : <span class="number">1</span>;</div><div class="line">        *x = (neg == <span class="number">1</span>) ? c-<span class="string">'0'</span> : <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>((c = readchar()) &gt;= <span class="string">'0'</span>)</div><div class="line">            *x = (*x &lt;&lt; <span class="number">3</span>) + (*x &lt;&lt; <span class="number">1</span>) + c-<span class="string">'0'</span>;</div><div class="line">        *x *= neg;</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Print</span> &#123;</span></div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">        <span class="keyword">char</span> buf[N], *p, *end;</div><div class="line">        Print() &#123;</div><div class="line">            p = buf, end = buf + N - <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">printInt</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">            <span class="keyword">static</span> <span class="keyword">char</span> stk[<span class="number">16</span>];</div><div class="line">            <span class="keyword">int</span> idx = <span class="number">0</span>;</div><div class="line">            stk[idx++] = <span class="string">'\n'</span>;</div><div class="line">            <span class="keyword">if</span> (!x)	</div><div class="line">                stk[idx++] = <span class="string">'0'</span>;</div><div class="line">            <span class="keyword">while</span> (x)</div><div class="line">                stk[idx++] = x%<span class="number">10</span> + <span class="string">'0'</span>, x /= <span class="number">10</span>;</div><div class="line">            <span class="keyword">while</span> (idx) &#123;</div><div class="line">                <span class="keyword">if</span> (p == end) &#123;</div><div class="line">                    *p = <span class="string">'\0'</span>;</div><div class="line">                    <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf), p = buf;</div><div class="line">                &#125;</div><div class="line">                *p = stk[--idx], p++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ~Print() &#123;</div><div class="line">            *p = <span class="string">'\0'</span>;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf);</div><div class="line">        &#125;		</div><div class="line">    &#125; bprint;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m, l, r, a, b;</div><div class="line">    <span class="keyword">while</span> (mLocalStream::ReadInt(&amp;n)) &#123;</div><div class="line">        mLocalStream::ReadInt(&amp;m);</div><div class="line">        off.init(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</div><div class="line">            mLocalStream::ReadInt(&amp;off.A[i]);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">            mLocalStream::ReadInt(&amp;l);</div><div class="line">            mLocalStream::ReadInt(&amp;r);</div><div class="line">            mLocalStream::ReadInt(&amp;a);</div><div class="line">            mLocalStream::ReadInt(&amp;b);</div><div class="line">            off.q_add(l, r, a, b);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        off.run();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++)</div><div class="line">            mLocalStream::bprint.printInt(off.ret[i]);</div><div class="line"><span class="comment">//			printf("%d\n", off.ret[i]);</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b415" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/26/zj-b415/" class="article-date">
  <time datetime="2015-06-25T23:13:24.000Z" itemprop="datePublished">2015-06-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/26/zj-b415/">b415. 輸出優化練習</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/26/zj-b415/" data-id="cktgl1qyh010514vnbkydewob" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/26/zj-b415/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化輸入/">優化輸入</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化輸出/">優化輸出</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>寫題目不只會遇到算法複雜度問題，還會遇到語法上的瓶頸，了解更深入的作業系統架構、語言特性，了解每一個函數的實作方法，就能把代碼效能發揮到淋淋盡緻。當然，對於代碼轉成執行檔的最佳化技巧也是如此，接下來就來做個基礎題吧。</p>
<p>現在請處理一個偽隨機數計算，輸出前 <span>$m$</span><!-- Has MathJax --> 個值。</p>
<span>$x_{i+1} \equiv x_{i}^{2} \mod n$</span><!-- Has MathJax -->
<p>有興趣的同學，可以查閱 Blum Blum Shub (BBS) Generator 相關隨機數算法。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">90 141 5</div><div class="line">52 57 5</div><div class="line">19 129 5</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">90 63 21 18 42</div><div class="line">52 25 55 4 16</div><div class="line">19 103 31 58 10</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>手動轉字串，減少函數 <code>printf()</code> 的呼叫，一次將答案吐出來便可以達到加速，由於有一部分時間都花在取模，速度最多提升個兩到三倍。</p>
<p>用 <code>putchar()</code> 速度也會比 <code>printf()</code> 快一點，但沒有實作 buffer 來得快。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line">  </div><div class="line"><span class="keyword">namespace</span> mLocalStream &#123;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">readchar</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> buf[N];</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> *p = buf, *end = buf;</div><div class="line">        <span class="keyword">if</span>(p == end) &#123;</div><div class="line">            <span class="keyword">if</span>((end = buf + fread(buf, <span class="number">1</span>, N, <span class="built_in">stdin</span>)) == buf) <span class="keyword">return</span> EOF;</div><div class="line">            p = buf;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> *p++;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">ReadInt</span><span class="params">(<span class="keyword">int</span> *x)</span> </span>&#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> c, neg;</div><div class="line">        <span class="keyword">while</span>((c = readchar()) &lt; <span class="string">'-'</span>)    &#123;<span class="keyword">if</span>(c == EOF) <span class="keyword">return</span> <span class="number">0</span>;&#125;</div><div class="line">        neg = (c == <span class="string">'-'</span>) ? <span class="number">-1</span> : <span class="number">1</span>;</div><div class="line">        *x = (neg == <span class="number">1</span>) ? c-<span class="string">'0'</span> : <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>((c = readchar()) &gt;= <span class="string">'0'</span>)</div><div class="line">            *x = (*x &lt;&lt; <span class="number">3</span>) + (*x &lt;&lt; <span class="number">1</span>) + c-<span class="string">'0'</span>;</div><div class="line">        *x *= neg;</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Print</span> &#123;</span></div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">        <span class="keyword">char</span> buf[N], *p, *end;</div><div class="line">        Print() &#123;</div><div class="line">            p = buf, end = buf + N - <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">printInt</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">char</span> padding)</span> </span>&#123;</div><div class="line">            <span class="keyword">static</span> <span class="keyword">char</span> stk[<span class="number">16</span>];</div><div class="line">            <span class="keyword">int</span> idx = <span class="number">0</span>;</div><div class="line">            stk[idx++] = padding;</div><div class="line">            <span class="keyword">if</span> (!x)	</div><div class="line">                stk[idx++] = <span class="string">'0'</span>;</div><div class="line">            <span class="keyword">while</span> (x)</div><div class="line">                stk[idx++] = x%<span class="number">10</span> + <span class="string">'0'</span>, x /= <span class="number">10</span>;</div><div class="line">            <span class="keyword">while</span> (idx) &#123;</div><div class="line">                <span class="keyword">if</span> (p == end) &#123;</div><div class="line">                    *p = <span class="string">'\0'</span>;</div><div class="line">                    <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf), p = buf;</div><div class="line">                &#125;</div><div class="line">                *p = stk[--idx], p++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">online_printInt</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">            <span class="keyword">static</span> <span class="keyword">char</span> ch[<span class="number">16</span>];</div><div class="line">            <span class="keyword">static</span> <span class="keyword">int</span> idx;</div><div class="line">            idx = <span class="number">0</span>;</div><div class="line">            <span class="keyword">if</span> (x == <span class="number">0</span>)	ch[++idx] = <span class="number">0</span>;</div><div class="line">            <span class="keyword">while</span> (x &gt; <span class="number">0</span>) ch[++idx] = x % <span class="number">10</span>, x /= <span class="number">10</span>;</div><div class="line">            <span class="keyword">while</span> (idx) </div><div class="line">                <span class="built_in">putchar</span>(ch[idx--]+<span class="number">48</span>);</div><div class="line">        &#125;</div><div class="line">        ~Print() &#123;</div><div class="line">            *p = <span class="string">'\0'</span>;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf);</div><div class="line">        &#125;</div><div class="line">    &#125; bprint;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> x0, p, n;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;x0, &amp;p, &amp;n) == <span class="number">3</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            mLocalStream::bprint.printInt(x0, i == n<span class="number">-1</span> ? <span class="string">'\n'</span> : <span class="string">' '</span>);</div><div class="line"><span class="comment">//			mLocalStream::Print::online_printInt(x0);</span></div><div class="line"><span class="comment">//			putchar(i == n-1 ? '\n' : ' ');</span></div><div class="line">            x0 = ((<span class="keyword">long</span> <span class="keyword">long</span>) x0 * x0)%p;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-speech-terry" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/25/speech-terry/" class="article-date">
  <time datetime="2015-06-24T23:36:50.000Z" itemprop="datePublished">2015-06-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/手札日記/">手札日記</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="http://i.imgur.com/8vmTV11.png" rel="gallery_cktgl1qpe00fh14vn2i2epged">
        <img src="http://i.imgur.com/8vmTV11.png" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/25/speech-terry/">我的世界在路上 外出紀錄</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/25/speech-terry/" data-id="cktgl1qpe00fh14vn2i2epged" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/25/speech-terry/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/中央大學/">中央大學</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/服務學習/">服務學習</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>隔了一周，又跑中原參加一場講座。門檻壓力好可怕、好可怕，別人輕易跨過的事實成為令人怯步的記憶。人生總有那麼一兩個小事，會發現自己就是那 1% 不到的缺陷，那微乎其微基因突變雖不足以殺人，但足以折磨心理。</p>
<p>這一天，帶著平淡的心情出發，路程上想著一道題目，坐在陌生的圖書館中，時而發愣地等待靈感的出現，上帝並沒有給予我太多，那愚蠢又怪異舉止是在與內心世界掙扎的反應，在一旁的人群也許覺得是個怪人，人滿為患的情況下，身旁的位置總是空的，也許多慮了吧。</p>
<p>在講座開始前，把自己出在 zerojudge 的題目 b414, b416 寫了幾個不同解法，即使網路上有一些片段心得，有些事情還是得親自嘗試才能更加地體會。題目告一段落後，放下心去參與接下來的講座。</p>
<p>感謝舉辦活動的同學，願意讓我這外校生參加講座、特地向學校申請證明給我，以為這世界的人都朝著進度服從，規定之外、不在規定內事情都沒辦法做，「麻煩別人」對我而言需要 <strong> 勇氣 </strong>。</p>
<p><img src="http://i.imgur.com/ypvQXE1.png" alt="《吹響吧！低音號》那時，我明白了"></p>
<h2 id="狀態"><a href="#狀態" class="headerlink" title="狀態"></a>狀態</h2><p>這次邀請的是旅行作家 Terry，聽到「旅行」「作家」兩個關鍵字，曾經在網路上瀏覽的文章給予的感覺，就是一個陳腔濫調的講座對吧？</p>
<p>事實有點不一樣，怎麼說呢，在正式開始前他分享了幾個小故事，說著他去分享講座、所遇到的人，講座中他給予別人什麼樣的經驗，而別人又是如何改變自己。在不同的國中小演講，他發現環境影響一個人的夢想，不能跟哥哥姊姊一樣聰敏的學生 A，在另一個領域演說、作文上有所才能，參與不少演說比賽的 A，卻突然不參與任何比賽，這件事情讓老師有所顧慮，父母那一句「功課要跟哥哥、姊姊一樣好，之後才不會像我一樣。」類似的話語使得 A 放棄自己的才能，而去想辦法在功課上與哥哥姊姊一樣好。</p>
<blockquote>
<p>聽到這一半段，心想「這也是我放棄比賽的原因嗎？」還是 EVA 那一段話「不能逃避！不能逃避！」的掙扎，「無法做得比別人好，那就放棄吧。」回響著。</p>
</blockquote>
<p><img src="http://i.imgur.com/pYUoNka.jpg" alt="《吹響吧！低音號》不甘心地快死了"></p>
<p>他這麼對 A 說「那你有發現你的作文演說比哥哥姊姊來得好嗎？」，學生應答「有。」接著 Terry 回了一段有趣的回答「那跟爸媽要求哥哥姊姊要在這一塊做跟你自己一樣好？」這時突然茫了，原來打破僵局這麼簡單，摸摸鼻子，暗自竊笑一番，笑著自己為什麼預期不到這樣的回答，把別人要求自己當作習慣，要求別人成了反常舉止，以後好好要求別人做得比我還好！像我如此笨拙的人，大家一定可以做得比我還好。</p>
<blockquote>
<p>「演講時，跟那群小朋友說什麼大道理『要堅強、不要逃避、面對挫折沒有什麼大不了』他們聽不懂的啦，倒不如講講，踩過各種狗類型的屎分享，再去跟踩鳥屎的反應差別，還會有同學跟你分享踩牛屎的體驗呢。」</p>
</blockquote>
<p><img src="http://i.imgur.com/NxOuJiA.png" alt="《飆速宅男》"></p>
<p>他曾經想要單車環島，卻苦於沒有單車，將一段訊息說了出來，於是有 Terry 朋友從花蓮載了一台單車到台中給他，Terry 覺得也奇怪，那要怎麼把單車還給 Terry 朋友呢？Terry 朋友居然回答道「騎回花蓮給我吧！」聽到這一句我也傻了，住花蓮的我都清楚搭火車到西部都嫌煩，繞了半個台灣是很長的。對角線的最近距離是很短，但那段山路爬坡不是好方案。</p>
<blockquote>
<p>「一生中總會有那麼幾個壞朋友，當你要去做一件事情時，在一旁煽火推你，<strong> 就好像死的是你，不是他 </strong>。也會有幾個好朋友，總會在你身旁告誡你，那樣做很危險的！不要不要啦！」－ Terry</p>
</blockquote>
<p><img src="http://i.imgur.com/RjXax02.png" alt="《Fate/Stay Night UBW》幹得好，你們這群壞朋友 (誤配)"></p>
<p>大眾化的描述還真有 Terry 的風格，搭配肢體表達那該死的壞朋友，要跟聽者有所共鳴果然要這麼做吧！「說大道理我不懂，但你這麼一說我好像就明白」的那種心情，這方面我還得多學學呢。</p>
<p>「瘋子和勇氣只有一線之隔，而我常常是瘋子那一塊。」於是他出發了，在四、五天內穿過中央山脈到了花蓮，又經過好幾天才能下床走路，他在一年之初做了一件瘋狂的事情呢，今年的我又做了什麼創舉呢？寫寫心得、代碼、出個題目都不算什麼，咱居然 <strong> 出門 </strong> 聽了這場演講！我的一小步是人生的一大步。</p>
<p>曾經是在一家公司上班的 Terry，做在小小辦公桌的他，那時都有著一個普遍的夢想「幹掉老闆，那個位子就是我的！」這夢想是每個工程師的心言。29 歲的他第一次出國，不做幹掉老闆的夢想，出門玩玩最近火熱的 <strong> Gap Year </strong> 的舉止，看看有什麼更有趣的自己，並不是花錢出門看看別人，在別的地點用自己的努力換資源活著，拿著自己街頭賣藝的才藝，出去招搖撞騙？ (笑笑就好)，跟著朋友來個計劃「收集微笑」放映一段有趣的影片，看了好一陣子各國人的微笑影片，不自覺地自己也跟著笑「看著別人微笑，你的嘴角是否上揚了？」</p>
<blockquote>
<p>前輩們要是過著更有希望的生活，我想我也可以過得很有希望，誰來替前輩們找到工作啊。</p>
</blockquote>
<p>藉由沙發衝浪找旅宿，交換人生經驗、文化，他就這麼帶著烏克麗麗發送請求住宿，附加黑暗中華料理才藝「反正他們多數也不知道真正的中華料理，只要說我做的一定是中華料理就行了，太鹹、太油、太甜一切都沒問題的。」這樣招搖撞騙真的沒問題嗎？這時候暗自竊笑著，也許真物也不是那麼重要了，帶著自己有一點點的經驗，非專業都沒問題。</p>
<p><img src="http://i.imgur.com/gH2okoO.png" alt="《果然我的青春戀愛物語搞錯了》世上到底有沒有真心呢"></p>
<p>「交談怕什麼嗎？語言不好？有 Google 翻譯就行啦，這又不是考試。」想到英文考試就是一肚子的痛，Google 翻譯真的好用，翻譯品質不會是最好，能溝通就行啦！「而且沙發衝浪偏好找老人，因為老人說話慢，談話比較能聽得懂的啦！」這樣的出國技巧還真是磨練的淋淋盡致，真是無比佩服這位 <strong> 計畫通 </strong>，看似和藹可親的面容下，居然藏著一顆腹黑的心。</p>
<p>「這樣七十多歲的人都出國沙發衝浪」甚至在台灣 Terry 家住宿過，還隨手打著毛線。人啊，學個技能、改變第一步是困難的，但也沒有什麼不可能，那七十多歲的老騷包，還特地擔心跟著 Terry 一起拍攝影片的服裝呢，覺得衣著不好看還在那挑來挑去，身為一個教職退休的老人，要在彼此認識的小鎮做出收集微笑的活動，那還真是 <strong> 害羞 </strong> 呢。七十多歲的老人都在街頭做著平時只有年輕人做的事情，我是否也可以做點不一樣的？</p>
<p><img src="http://i.imgur.com/XL8VOUO.png" alt="《吹響吧！低音號》你一個人臉紅個什麼呢？"></p>
<p>「成功不能複製，失敗可以學習。」要讓家人支持自己出國嘗試，要做些什麼？首先，先來個小旅行，逐漸地把時間拉長，讓家人明白你自己可以解決問題，對外宣稱「台灣是熱情的國家，遇到問題只要敢發問，就會有人幫忙。」對自己小孩是怎麼說「外面可怕，要小心陌生人，要注意場合。」這兩面情要怎麼讓孩子理解，到底是求助於人好、還是不求於人好？也許當前問題要先解決這個呢。</p>
<p>有比別人多一個機會到外處學習，回來要怎麼 <strong> 分享經驗 </strong> 呢？「說說自己遇到的問題，順道說說如何解決，這樣的內容才有人看啊，老媽肯定會講『看吧，就說會遇到這種情況』，分享那裏有多好玩、那裏長得如何，很少人想去聽的。」這一點到沒錯呢，覺得在 FaceBook 是一個反常的存在。不管如何，就是不喜歡看一個沒有整理過的長時間紀錄片，一定會打瞌睡。</p>
<h2 id="節錄"><a href="#節錄" class="headerlink" title="節錄"></a>節錄</h2><ul>
<li>「出了遠門忘了帶錢，沒法賒帳，回家一趟也太遙遠，現場演奏怒賺菜錢，回頭結帳！爽。(高傲貌)」</li>
<li>「旅行是一個機會，可以理解到自己的專長、發掘自己的可能性，是個機會，沒有一定。」</li>
<li>「曾經為了搭個便車，在路旁等了五、六個小時，若你去問問女孩子通常等了多久『10 分鐘』沒錯，女孩子受到幫助的機會非常高啊，在我等了一個小時後，甚至想女裝一下，看能不能提高搭乘機率啊。」 </li>
<li>「不要說只有女孩子危險，男孩子在外搭便車也是很危險的啊，哪有什麼比較強壯什麼的，大家都是人吼。」</li>
<li>「你看到男性提供者限定女性沙發衝浪，女性們怕不怕，若限定男性沙發衝浪，你說男性們怕不怕。怕啊。」</li>
</ul>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>在場聽者不多，講者仍講得相當有生動，沒有被空位的壓力屈服，話語讓我整個人都熱血起來。講著講著，好像能踏出第一步了，「對不起，看到離近的兩大門檻前，還是選擇退一步，在逃離畢業資格考前，沒辦法像用 Google 翻譯那樣地活著。」這場講座是個有趣的經驗，不僅僅是人生未來挖掘方法，也看到如何作為一個講者去描述事情的方法。</p>
<p><img src="http://i.imgur.com/DNBMbPG.png" alt="《灰色樂園》這輩子都將銘記於心"></p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-d476" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/25/zj-d476/" class="article-date">
  <time datetime="2015-06-24T23:05:28.000Z" itemprop="datePublished">2015-06-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/25/zj-d476/">d476. 區間查詢</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/25/zj-d476/" data-id="cktgl1r0g014h14vnjjnpt4x6" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/25/zj-d476/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/整體二分/">整體二分</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/離線處理/">離線處理</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>一個長度為 n 的序列，支持兩種操作：</p>
<ol>
<li>输出 <span>$[A, B]$</span><!-- Has MathJax --> 區間第 k 小的數 (從小到大排序後第 k 個)</li>
<li>修改第 I 個數為 W</li>
</ol>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">5 3</div><div class="line">1 2 3 4 5</div><div class="line">Q 1 4 2</div><div class="line">C 2 5</div><div class="line">Q 1 4 2</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">2</div><div class="line">3</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在討論用一些雜七雜八的樹類結構去跟莫隊算法搏鬥之餘，用了轉幾何方向去兜資料結構，隨後發現題目尋找的是 unique 而非計數，因此很多想法就垮台，當然出成另一道題目也是不錯。決定尋找其他想法！</p>
<h3 id="開始"><a href="#開始" class="headerlink" title="開始"></a>開始</h3><p>整體二分是什麼呢？假設操作只有修改、詢問，不包含插入、刪除，而且詢問是一個數值結果，這個數值結果可以藉由二分 + 掃描來完成，那就可以使用整體二分來離線支持。</p>
<p>對答案值域分治，將相關操作分治在一起，同時要保留順序性，分治過程中會不斷地累加每一個詢問的掃描數值，最後滿溢時紀錄答案。每一個操作最多在 <span>$\log \text{MAXV}$</span><!-- Has MathJax --> 層計算，因此複雜度是 <span>$O(Q \log \text{MAXV})$</span><!-- Has MathJax -->。</p>
<p>好處是可以用常數較低的結構，所以會比較快？</p>
<h4 id="應用"><a href="#應用" class="headerlink" title="應用"></a>應用</h4><p>這一道經典題有很多作法，如持久化線段樹、塊狀鏈表、歸併樹、劃分樹、 … 等。其中能支持修改的有塊狀鏈表、複雜的持久化線段樹 (主席樹)。</p>
<p>帶修改的區間 K 小，概略說明二分答案 <span>$x$</span><!-- Has MathJax -->，然後去查找小於等於 <span>$x$</span><!-- Has MathJax --> 的數字在區間 <span>$[l, r]$</span><!-- Has MathJax --> 內出現的次數是否大於等於 <span>$K$</span><!-- Has MathJax -->。然後修改元素有加入跟移除，二分答案 mid，要將加入、移除會影響的 <span>$A[i] \le mid$</span><!-- Has MathJax -->，加入或移除時對該數字的索引值 <span>$i$</span><!-- Has MathJax --> 建造統計方案。</p>
<p>對於(位置, 值) <span>$\left \langle i, A[i] \right \rangle$</span><!-- Has MathJax --> 來說，一開始的前 <span>$N$</span><!-- Has MathJax --> 個操作是加入 <span>$\left \langle i, A[i] \right \rangle$</span><!-- Has MathJax -->，二分答案時，用一個 binary indexed tree 去維護 index 的個數，也就是說，對於修改元素 <span>$\left \langle i, A[i] \right \rangle$</span><!-- Has MathJax --> 相當於在二分答案 mid 時，插入 <code>BIT.add(i, 1)</code>，那對於區間詢問，相當於查找 <code>BIT.query([l, r])</code> 如此一來就能知道區間 <span>$[l, r]$</span><!-- Has MathJax --> 在 mid 以內有幾個數字符合。</p>
<p>假設計數大於 k，詢問往左放，反之扣除已知 mid 以內的數量，詢問往右放，如此一來就完成了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXQ = <span class="number">65536</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">65536</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> INF = <span class="number">0x3f3f3f3f</span>;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Offline</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Event</span> &#123;</span></div><div class="line">        <span class="keyword">int</span> x, y, k, qtype, qid;</div><div class="line">        <span class="keyword">int</span> calc; <span class="comment">//</span></div><div class="line">        Event(<span class="keyword">int</span> a = <span class="number">0</span>, <span class="keyword">int</span> b = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>, <span class="keyword">int</span> d = <span class="number">0</span>, <span class="keyword">int</span> e = <span class="number">0</span>, <span class="keyword">int</span> f = <span class="number">0</span>):</div><div class="line">            x(a), y(b), k(c), qtype(d), qid(e), calc(f) &#123;&#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="built_in">vector</span>&lt;Event&gt; event;</div><div class="line">    <span class="keyword">int</span> N, ret[MAXQ];</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> N)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>-&gt;N = N;</div><div class="line">        event.clear();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addEvent</span><span class="params">(<span class="keyword">int</span> qtype, <span class="keyword">int</span> qid, <span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> k)</span> </span>&#123;</div><div class="line">        event.push_back(Event(x, y, k, qtype, qid));</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        DC(<span class="number">0</span>, event.size()<span class="number">-1</span>, <span class="number">0</span>, INF);</div><div class="line">    &#125;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="comment">// buffer</span></div><div class="line">    <span class="keyword">int</span> buf[MAXQ];</div><div class="line">    Event ebuf1[MAXQ], ebuf2[MAXQ];</div><div class="line">    <span class="comment">// binary indexed tree</span></div><div class="line">    <span class="keyword">int</span> bit[MAXN];</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (x &lt;= N) &#123;</div><div class="line">            bit[x] += val;</div><div class="line">            x += (x)&amp;(-x);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> (x) &#123;</div><div class="line">            ret += bit[x];</div><div class="line">            x -= (x)&amp;(-x);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">DC</span><span class="params">(<span class="keyword">int</span> q_l, <span class="keyword">int</span> q_r, <span class="keyword">int</span> val_l, <span class="keyword">int</span> val_r)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (q_l &gt; q_r)	<span class="keyword">return</span> ;</div><div class="line">        <span class="keyword">if</span> (val_l == val_r) &#123;	<span class="comment">// find</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = q_l; i &lt;= q_r; i++)</div><div class="line">                <span class="keyword">if</span> (event[i].qtype == <span class="number">2</span>)</div><div class="line">                    ret[event[i].qid] = val_l;</div><div class="line">            <span class="keyword">return</span> ;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> mid = (val_l + val_r)/<span class="number">2</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = q_l; i &lt;= q_r; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (event[i].qtype == <span class="number">0</span> &amp;&amp; event[i].y &lt;= mid)</div><div class="line">                add(event[i].x, <span class="number">1</span>);</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (event[i].qtype == <span class="number">1</span> &amp;&amp; event[i].y &lt;= mid)</div><div class="line">                add(event[i].x, <span class="number">-1</span>);</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (event[i].qtype == <span class="number">2</span>)</div><div class="line">                buf[i] = query(event[i].y) - query(event[i].x<span class="number">-1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = q_l; i &lt;= q_r; i++) &#123; <span class="comment">// resume</span></div><div class="line">            <span class="keyword">if</span> (event[i].qtype == <span class="number">0</span> &amp;&amp; event[i].y &lt;= mid)</div><div class="line">                add(event[i].x, <span class="number">-1</span>);</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (event[i].qtype == <span class="number">1</span> &amp;&amp; event[i].y &lt;= mid)</div><div class="line">                add(event[i].x, <span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> lidx = <span class="number">0</span>, ridx = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = q_l; i &lt;= q_r; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (event[i].qtype == <span class="number">0</span> || event[i].qtype == <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (event[i].y &lt;= mid)</div><div class="line">                    ebuf1[lidx++] = event[i];</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    ebuf2[ridx++] = event[i];</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (event[i].calc + buf[i] &gt; event[i].k - <span class="number">1</span>)</div><div class="line">                    ebuf1[lidx++] = event[i];</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                    event[i].calc += buf[i];</div><div class="line">                    ebuf2[ridx++] = event[i];</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; lidx; i++)</div><div class="line">            event[q_l+i] = ebuf1[i];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ridx; i++)</div><div class="line">            event[q_l+lidx+i] = ebuf2[i];</div><div class="line">        DC(q_l, q_l+lidx<span class="number">-1</span>, val_l, mid);</div><div class="line">        DC(q_l+lidx, q_r, mid+<span class="number">1</span>, val_r);</div><div class="line">    &#125;</div><div class="line">&#125; off;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, m, x, y, k, v;</div><div class="line">    <span class="keyword">int</span> A[<span class="number">65536</span>];</div><div class="line">    <span class="keyword">char</span> cmd[<span class="number">10</span>];</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</div><div class="line">        off.init(n);</div><div class="line">        <span class="comment">// qtype 0:add, 1:remove, 2: query</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;A[i]);</div><div class="line">            off.addEvent(<span class="number">0</span>, <span class="number">0</span>, i, A[i], <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> qid = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%s"</span>, cmd);</div><div class="line">            <span class="keyword">if</span> (cmd[<span class="number">0</span>] == <span class="string">'Q'</span>) &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;x, &amp;y, &amp;k);</div><div class="line">                off.addEvent(<span class="number">2</span>, qid++, x, y, k);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;x, &amp;v);</div><div class="line">                off.addEvent(<span class="number">1</span>, <span class="number">0</span>, x, A[x], <span class="number">0</span>);</div><div class="line">                off.addEvent(<span class="number">0</span>, <span class="number">0</span>, x, v, <span class="number">0</span>);</div><div class="line">                A[x] = v;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        off.run();		</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; qid; i++)</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, off.ret[i]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-security-notes7" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/23/security-notes7/" class="article-date">
  <time datetime="2015-06-23T00:06:29.000Z" itemprop="datePublished">2015-06-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/資訊安全/">資訊安全</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/23/security-notes7/">近代加密 小額付費</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/23/security-notes7/" data-id="cktgl1qp700f614vnqx17n1dk" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/23/security-notes7/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/密碼學/">密碼學</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="關於小額付費"><a href="#關於小額付費" class="headerlink" title="關於小額付費"></a>關於小額付費</h2><p>另一個名稱為 <strong> 微支付 </strong> (Micropayment)，簡單來說提供顧客 (Consumer) - 銀行 (Broker) - 商家 (Vendor) 三方的交易。小額付費標明在交易金額小，因此交易成本也應該小，否則交易手續的計算能量就超過交易金額，更別說要扣除交易物品的成本。通常要在以下三點最小化</p>
<ul>
<li>計算資源：<br>在先前提到的加密算法中，key 的 bit-length 相當長，導致計算的能量消耗大。倘若只消費 1 元，耗電成本就佔了 1% 以上，甚至更多，那麼是划不來的。</li>
<li>儲存空間花費：<br>計算每一組交易明細所需要的空間要最小，例如記錄金額需要 32-bit，那麼 n 次交易就需要 n 個 32-bit 的空間，在其他細節中還需要紀錄額外的購買來源、 … 等。</li>
<li>管理成本：<br>第三方 (通常是銀行) 要管理顧客的金額花費、商家是否能取用顧客的錢。銀行要怎麼紀錄顧客的狀態、如何驗證商家真的有跟顧客交易 … 等。</li>
</ul>
<p>由於交易金額小，即使被破解對雙方的損失也不大。但通常破解手段需要的時間、資源往往超過交易金額，因此不太會有人去破解這個。</p>
<h2 id="應用層面"><a href="#應用層面" class="headerlink" title="應用層面"></a>應用層面</h2><h3 id="網路電子報："><a href="#網路電子報：" class="headerlink" title="網路電子報："></a>網路電子報：</h3><p>一份電子報可能有一些特別的標題內容，若要深入查閱內文，需要讀者付費觀看。這一部分更具有彈性，對於一份具有相當多面向的電子報而言，有些人只看幾個專欄就必須花費購買一整本的金額，有些時候是浪費的。</p>
<h3 id="網路期刊購買、資料庫詢問"><a href="#網路期刊購買、資料庫詢問" class="headerlink" title="網路期刊購買、資料庫詢問"></a>網路期刊購買、資料庫詢問</h3><p>網路學術期刊就跟電子報的情況一樣。資料庫詢問比較特別，花費小金額來交換資料庫服務的次數。</p>
<h3 id="廣告"><a href="#廣告" class="headerlink" title="廣告"></a>廣告</h3><p>互動式影片、廣告商為了誘拐大眾仔細觀看廣告，由廣告商付錢給觀看者。例如回答問卷回饋、機率性地抽獎回饋 … 等。</p>
<h3 id="網頁閱讀"><a href="#網頁閱讀" class="headerlink" title="網頁閱讀"></a>網頁閱讀</h3><p>類似向大眾徵文，鼓勵分享知識。徵求到的文章，由平台供應者支付。</p>
<h2 id="何時用"><a href="#何時用" class="headerlink" title="何時用"></a>何時用</h2><p>使用者付費，而非訂閱長時間的垃圾訊息或服務。在大多數的服務商中，會提供時間內無限使用或按照次數計費兩種方案，在大多數的情況下，時間內無限使用是對商家有利，可以預先得到使用者的投資，但使用者在後續時間內可能沒有去使用、或者沒時間去用。</p>
<p>不是 <strong> 按照次數計費全然好 </strong>，就如 <strong> 電話費 </strong>，打了多少通電話、講了多久，只有電信商知道，即便告訴花費相當多金額，通話明細也是由他們提供，很難證明到底花了多少，這是對使用者的不利。相較起來，小額付費比較接近投幣式的公共電話，投了多少就打多少，等到快沒有餘額時，再進行補充。</p>
<p>先付款給商家會對使用者不利，有可能取得不好的服務，後付款給商家會對商家不利，因為使用者可能沒有足夠的金額。正因為小額交易，適時地刷新狀態 (再投幣) 就能在之間達到平衡。</p>
<h2 id="數學"><a href="#數學" class="headerlink" title="數學"></a>數學</h2><p>由制定 RSA 那伙人 Rivest, Shamir 提供 Payword scheme 的方法。</p>
<p>首先，概念建立在假設不用數字儲存金額 (減少儲存空間、管理花費)，而是用運算次數來知道花費金額 (用簡單運算來完成，防止能源消耗過大)。金額花費是整數，由最小單位 1 元構成，如果是在通貨膨脹的國家，最小單位可能不一樣？</p>
<p>那麼可以建立一個儲值金額 n 元的串列如下。</p>
<span>$x_0 \leftarrow x_1 \leftarrow x_2 \leftarrow \text{ ... } \leftarrow x_{n-1} \leftarrow x_n$</span><!-- Has MathJax -->
<p>由使用者拿一個<span>$x_n$</span><!-- Has MathJax --> 初始化，接著利用 hash<span>$x_i = h(x_{i+1})$</span><!-- Has MathJax --> 得到每一個硬幣<span>$x_i$</span><!-- Has MathJax -->。用數學表示遞迴公式<span>$x_i = h^{n-i}(x_n)$</span><!-- Has MathJax -->。</p>
<p>當顧客跟商家交易時，簽一份簽章 (例如用 RSA 或者是 DSA 等方式) 給商家。簽章內容為</p>
<span>$\text{Sign}_C(\text{Merchant-ID} || x_0 || \text{Cert})$</span><!-- Has MathJax -->
<p>其中 <span>$\text{Cert}$</span><!-- Has MathJax --> 是由第三方信任銀行簽署給用戶的內容 (類似銀行帳戶的確認)。最後發送給商家資訊為</p>
<span>$\text{Sign}_C(\text{Merchant-ID} || x_0 || \text{Cert}), \text{Merchant-ID}, x_0, \text{Cert}$</span><!-- Has MathJax -->
<p>由商人去驗證 (檢查簽證內容、拿對方的 public key 打開，再去拿銀行的 public key 驗證 <span>$\text{Cert}$</span><!-- Has MathJax -->  是否正確) 是否是可信任的顧客或者是顧客是否存在。</p>
<p>接下來交易採用最笨的方案，每一次交易 1 元，交付 i 元時，顧客就告知<span>$x_i$</span><!-- Has MathJax --> 值給商家，這裡顧客得到硬幣方法為重新計算<span>$x_i = h^{n-i}(x_n)$</span><!-- Has MathJax -->，可以不事先用記憶體儲存<span>$[x_0, x_n]$</span><!-- Has MathJax -->，保留 <span>$n$</span><!-- Has MathJax --> 和<span>$x_n$</span><!-- Has MathJax --> 即可。</p>
<p>之後商家拿著 i 元<span>$x_i$</span><!-- Has MathJax --> 和<span>$\text{Sign}_C(\text{Merchant-ID} || x_0 || \text{Cert})$</span><!-- Has MathJax --> 的資訊給銀行，銀行計算 <span>$i$</span><!-- Has MathJax --> 次 hash<span>$x_0 = h^i(x_i)$</span><!-- Has MathJax --> 查看是否正確，若檢驗沒問題，則銀行從客戶存簿撥款給商家。</p>
<h3 id="為什麼可行"><a href="#為什麼可行" class="headerlink" title="為什麼可行"></a>為什麼可行</h3><p>運算過程中使用 hash，hash 提供不可逆的操作，因此商家無法有更多金額的索取，假設從顧客手中得到<span>$x_i$</span><!-- Has MathJax -->，無法計算出<span>$x_{i+1}$</span><!-- Has MathJax --> 究竟是什麼，具有一定安全性。而顧客必須由銀行索取簽證，來表示當前的狀態是合法的，顧客沒辦法竄改自己的狀態，使得自己有更多的金錢，銀行那裏會有最新一組的簽章在？應該是吧，銀行會在商家發送驗證資訊時發生異狀檢查顧客是否竄改。</p>
<p>數學之美。</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/22/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="page-number" href="/page/22/">22</a><span class="page-number current">23</span><a class="page-number" href="/page/24/">24</a><a class="page-number" href="/page/25/">25</a><span class="space">&hellip;</span><a class="page-number" href="/page/85/">85</a><a class="extend next" rel="next" href="/page/24/">Next &raquo;</a>
    </nav>
  
</section>
          
          
            <aside id="sidebar">
  <!-- <div id="ukagaka_panel"></div> -->
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/">學校課程</a><span class="category-list-count">115</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/介面設計/">介面設計</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/作業系統/">作業系統</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/即時系統/">即時系統</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/大學專題/">大學專題</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/巨量資料/">巨量資料</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/平行程式/">平行程式</a><span class="category-list-count">43</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/敏捷方法/">敏捷方法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/編譯器/">編譯器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/自然語言/">自然語言</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/虛擬實境/">虛擬實境</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算型智慧/">計算型智慧</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算幾何/">計算幾何</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算機圖學/">計算機圖學</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資料庫系統/">資料庫系統</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資訊安全/">資訊安全</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/通識課程/">通識課程</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/">工作應用</a><span class="category-list-count">35</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Java/">Java</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Meme/">Meme</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/可持久化/">可持久化</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/鬼故事/">鬼故事</a><span class="category-list-count">12</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/手札日記/">手札日記</a><span class="category-list-count">47</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/">網頁設計</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/About-This-Blog/">About This Blog</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/HTML5/">HTML5</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/JQuery/">JQuery</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/Markdown/">Markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/NodeJs/">NodeJs</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/">解題區</a><span class="category-list-count">633</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/Latex/">Latex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/出題解題/">出題解題</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-POJ/">解題區 - POJ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a><span class="category-list-count">483</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a><span class="category-list-count">77</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-未解題目/">解題區 - 未解題目</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/雜言筆記/">雜言筆記</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a class="text" href="/2021/08/15/diary-202108/">
              
                <i class="icon-file-o"></i> 
              
            被預告要開始管人的我，今天開始學管理？</a>
          </li>
        
          <li>
            <a class="text" href="/2021/08/14/work/company-ghost-story-12/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 12</a>
          </li>
        
          <li>
            <a class="text" href="/2021/07/29/java/java-jni-tls-error-2/">
              
                <i class="icon-file-o"></i> 
              
            Java JNI GC Thread Error (EINVAL)</a>
          </li>
        
          <li>
            <a class="text" href="/2021/07/29/work/company-ghost-story-11/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 11</a>
          </li>
        
          <li>
            <a class="text" href="/2021/06/21/diary-202106/">
              
                <i class="icon-file-o"></i> 
              
            疫情下的工作變化</a>
          </li>
        
          <li>
            <a class="text" href="/2021/06/21/work/company-ghost-story-10/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 10</a>
          </li>
        
          <li>
            <a class="text" href="/2021/05/30/diary-202105/">
              
                <i class="icon-file-o"></i> 
              
            前思後想 新居落成</a>
          </li>
        
          <li>
            <a class="text" href="/2021/05/30/java/java-memory-optimization-2/">
              
                <i class="icon-file-o"></i> 
              
            Java 優化內存使用 組合篇</a>
          </li>
        
          <li>
            <a class="text" href="/2021/05/30/java/java-memory-optimization-1/">
              
                <i class="icon-file-o"></i> 
              
            Java 優化內存使用 結構篇</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/diary-202101/">
              
                <i class="icon-file-o"></i> 
              
            二八進展</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">   
        <ul>
          <li><a href="http://mypaper.pchome.com.tw/zerojudge" target="_blank" title="Old Blog"><i class="icon-star"></i> Morris' Blog (pchome)</a></li>
        </ul>
    </div>
</div>

  
    
<script src="/js/jquery-ui.js"></script>
<script src="/js/ukagaka/jquery.morris.ukagaka.resource.js"></script>
<script src="/js/ukagaka/typed.js"></script>
  
  
</aside>
          
        
      </div>
      <footer id="footer">
  
  <div class="outer">    
    <div class="social-group">
      
      <a href="https://github.com/morris821028" target="_blank" title="github"><i class="icon-github"></i></a>
      
      
      <a href="https://www.facebook.com/Morris1028" target="_blank" title="facebook"><i class="icon-facebook-sign"></i></a>
      
      
      <a href="http://uhunt.felix-halim.net/id/46705" target="_blank" title="uhunt" ><span class="icon-uhunt">UVa<span></a>
      
    </div>
    <div id="footer-info" class="inner">
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/morris821028/hexo-theme-landscape" target="_blank" title="landscape">landscape</a> &copy; 2021 Shiang-Yun Yang 
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link"><i class=icon-home ></i>&nbsp&nbspHome</a>
  
    <a href="/about" class="mobile-nav-link"><i class=icon-user ></i>&nbsp&nbspAbout</a>
  
    <a href="/archives" class="mobile-nav-link"><i class=icon-archive ></i>&nbsp&nbspArchives</a>
  
    <a href="/tags" class="mobile-nav-link"><i class=icon-tags ></i>&nbsp&nbspTags</a>
  
    <a href="/picture" class="mobile-nav-link"><i class=icon-camera ></i>&nbsp&nbspPictures</a>
  
    <a href="/works" class="mobile-nav-link"><i class=icon-trophy ></i>&nbsp&nbspWorks</a>
  
</nav>
    
<script>
  var disqus_shortname = 'morris1028';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/jquery.lazyload.js"></script>
<script src="/js/jquery.als-1.6.js"></script>

<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>