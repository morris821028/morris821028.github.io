<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Morris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Morris&#39; Blog">
<meta property="og:url" content="http://morris821028.github.io/page/79/index.html">
<meta property="og:site_name" content="Morris&#39; Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Morris&#39; Blog">
<link rel="publisher" href="108158678174364350000">
  
    <link rel="alternative" href="/atom.xml" title="Morris&#39; Blog" type="application/atom+xml">
  
  
    <meta name="google-site-verification" content="5mRgj8NanEMpGZuNfHNJNmH90RgNlrnJXsFlTaKD6Gs" />
  
  
    <link rel="shortcut icon" href="/img/f.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script src="/js/jquery-2.1.0.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.5.1.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdn.oesmith.co.uk/morris-0.5.1.min.js"></script>
  <!-- <link rel="import" href="/bower_components/app-layout/app-layout.html"> --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"><div id="banner-right"></div></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Morris&#39; Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class=icon-home title='Home'></i></a>
          
        
          
            <a class="main-nav-link" href="/about"><i class=icon-user title='About'></i></a>
          
        
          
            <a class="main-nav-link" href="/archives"><i class=icon-archive title='Archives'></i></a>
          
        
          
            <a class="main-nav-link" href="/tags"><i class=icon-tags title='Tags'></i></a>
          
        
          
            <a class="main-nav-link" href="/picture"><i class=icon-camera title='Pictures'></i></a>
          
        
          
            <a class="main-nav-link" href="/works"><i class=icon-trophy title='Works'></i></a>
          
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://morris821028.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        
          
          <section id="main">
  
    <article id="post-oj/uva/uva-11260" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/31/oj/uva/uva-11260/" class="article-date">
  <time datetime="2014-05-31T11:48:22.000Z" itemprop="datePublished">2014-05-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/05/31/oj/uva/uva-11260/">UVa 11260 - Odd Root Sum</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2014/05/31/oj/uva/uva-11260/" data-id="cksb6gaka02w1d8vnupp6m07y" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2014/05/31/oj/uva/uva-11260/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/規律/">規律</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/逆元/">逆元</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>Given the value of an n you will have to find the modulo 100000000 value of the following expression:</p>
<p><code>floor(sqrt(1)) + floor(sqrt(3)) + floor(sqrt(5)) + ... + floor(sqrt(m))</code> , where m is the largest odd number not greater than n. Or in other words you will have to find the value of S where,</p>
<p><code>S = floor(sqrt(1)) + floor(sqrt(3)) + floor(sqrt(5)) + ... + floor(sqrt(m)) MOD 100000000</code></p>
<h2 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h2><p>The input file contains at most 30000 lines of inputs. Each line contains a single 64-nit signed integer which denotes the value of n. Input is terminated by a line containing a single zero which should not b processed.</p>
<h2 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h2><p>For each line of input produce one line of output. This line contains the value of S.</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">9</div><div class="line">19</div><div class="line">29</div><div class="line">10000000</div><div class="line">0</div></pre></td></tr></table></figure>
<h2 id="Output-for-Sample-Input"><a href="#Output-for-Sample-Input" class="headerlink" title="Output for Sample Input"></a>Output for Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">9</div><div class="line">26</div><div class="line">49</div><div class="line">38426378</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>先把前幾項列出來，會發現一個規律<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">11</div><div class="line">22</div><div class="line">3333</div><div class="line">4444</div><div class="line">555555</div><div class="line">666666</div><div class="line">77777777</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>每一次會增加兩個。</p>
<p>假設第 1 組為 <code>11 22</code>，第 2 組為 <code>3333 4444</code> …<br>需要使用二分搜尋找到我們總共要幾組，然後直接利用公式算出來 sigma(2i * (2i - 1 + 2i))。</p>
<p>但是公式算出來後，會有一個 <code>/3</code> 需要出處理，這邊使用乘法反元素，幸好 3 和 100000000 有互質，不然還真是沒有辦法避免大數運算，計算的時候請各種小心 overflow 的問題。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MOD 100000000 </span></div><div class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">inv</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> n, <span class="keyword">long</span> <span class="keyword">long</span> m)</span> </span>&#123; <span class="comment">// get n*? = 1 (mod m)</span></div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> la = <span class="number">1</span>, lb = <span class="number">0</span>, ra = <span class="number">0</span>, rb = <span class="number">1</span>;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> i = <span class="number">0</span>, t, mod = m;</div><div class="line">    <span class="keyword">while</span>(n%m) &#123;</div><div class="line">        <span class="keyword">if</span>(!i) &#123;</div><div class="line">            la -= n/m*ra;</div><div class="line">            lb -= n/m*rb;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ra -= n/m*la;</div><div class="line">            rb -= n/m*lb;</div><div class="line">        &#125;</div><div class="line">        i = !i;</div><div class="line">        t = n, n = m, m = t%m;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(i)</div><div class="line">        <span class="keyword">return</span> (la%mod+mod)%mod;</div><div class="line">    <span class="keyword">return</span> (ra%mod+mod)%mod;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">getM</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> n)</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> l = <span class="number">0</span>, r = <span class="number">3037000499L</span>L/<span class="number">2</span>, m, ret;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> tmp;</div><div class="line">    <span class="keyword">while</span>(l &lt;= r) &#123;</div><div class="line">        m = (l + r) / <span class="number">2</span>;</div><div class="line">        tmp = <span class="number">4</span> * (m) * (m + <span class="number">1</span>);</div><div class="line">        <span class="keyword">if</span>(tmp &lt;= n)</div><div class="line">            l = m + <span class="number">1</span>, ret = m;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            r = m - <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> n;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> inv3 = inv(<span class="number">3</span>, MOD);</div><div class="line">    <span class="keyword">while</span>(<span class="built_in">scanf</span>(<span class="string">"%llu"</span>, &amp;n) == <span class="number">1</span> &amp;&amp; n) &#123;</div><div class="line">        <span class="keyword">long</span> <span class="keyword">long</span> ret = <span class="number">0</span>;<span class="comment">/*</span></div><div class="line"><span class="comment">		for(long long i = 1; i &lt;= n; i += 2) &#123;</span></div><div class="line"><span class="comment">			// printf("%d\n", (int)sqrt(i));</span></div><div class="line"><span class="comment">			ret += (long long) sqrt(i);</span></div><div class="line"><span class="comment">			ret %= MOD;</span></div><div class="line"><span class="comment">		&#125;</span></div><div class="line"><span class="comment">		printf("%lld\n", ret);*/</span></div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> m = getM(n);</div><div class="line">        <span class="keyword">long</span> <span class="keyword">long</span> prev = <span class="number">4</span>*(m)*(m + <span class="number">1</span>)%MOD*(<span class="number">2</span>*m + <span class="number">1</span>)%MOD*inv3%MOD - m * (m + <span class="number">1</span>)%MOD;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> pn = <span class="number">4</span> * (m) * (m + <span class="number">1</span>) - <span class="number">1</span>;</div><div class="line">        prev = (prev%MOD + MOD)%MOD;</div><div class="line">        <span class="comment">//printf("%lld %lld %lld\n", m, prev, pn);</span></div><div class="line">        m++;</div><div class="line">        <span class="keyword">if</span>(pn + m * <span class="number">4</span> &lt; n) &#123;</div><div class="line">            prev += (<span class="number">2</span> * m - <span class="number">1</span>) * <span class="number">2</span> * m%MOD;</div><div class="line">            pn += m * <span class="number">4</span>;</div><div class="line">            <span class="comment">//printf("CROSS1 %llu %llu\n", pn, prev);</span></div><div class="line">            prev += (n - pn)/<span class="number">2</span> * <span class="number">2</span> * m%MOD;</div><div class="line">            <span class="comment">//printf("CROSS2 %llu %llu\n", m * 2, (n - pn) /2);</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            prev += (n - pn)/<span class="number">2</span> * (<span class="number">2</span> * m - <span class="number">1</span>)%MOD;</div><div class="line">            <span class="comment">//puts("CROSS3");</span></div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%llu\n"</span>, (prev%MOD + MOD)%MOD);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">11</span></div><div class="line"><span class="comment">22</span></div><div class="line"><span class="comment">3333</span></div><div class="line"><span class="comment">4444</span></div><div class="line"><span class="comment">555555</span></div><div class="line"><span class="comment">666666</span></div><div class="line"><span class="comment">77777777</span></div><div class="line"><span class="comment">...</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">10000000001</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-lesson/hw-nachos4-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/30/lesson/hw-nachos4-2/" class="article-date">
  <time datetime="2014-05-30T05:34:19.000Z" itemprop="datePublished">2014-05-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/作業系統/">作業系統</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/05/30/lesson/hw-nachos4-2/">向 NachOS 4.0 作業進發 (2)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2014/05/30/lesson/hw-nachos4-2/" data-id="cksb6ga5g02ecd8vn8x1ia3bf" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2014/05/30/lesson/hw-nachos4-2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NachOS/">NachOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/作業系統/">作業系統</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h1 id="接續"><a href="#接續" class="headerlink" title="接續"></a>接續</h1><p>接續上一篇的 <a href="http://morris821028.github.io/2014/05/24/hw-nachos4/">向 NachOS 4.0 作業進發 (1)</a>，我們繼續完成排程處理，在原始的 NachOS 4.0 中，基礎排程是 Round-robin，它的運作方式藉由定時呼叫 <code>threads/alarm.h</code> 中的 <code>Alarm::CallBack()</code>，而呼叫的時脈來源設定為 <code>machine/stats.h</code> 中的 <code>const int TimerTicks = 100;</code> 決定，數值越小表示呼叫頻率越高，置換的次數就會上升。</p>
<h1 id="目標-Scheduler"><a href="#目標-Scheduler" class="headerlink" title="目標 Scheduler"></a>目標 Scheduler</h1><ul>
<li>FIFO (FCFS) 先來先服務</li>
<li>SJF     最短工作優先</li>
<li>Priority 最小優先權優先</li>
<li>RR    (Round-robin)</li>
<li>multi-level queue <strong> 最後的大魔王 </strong></li>
</ul>
<h1 id="開始"><a href="#開始" class="headerlink" title="開始"></a>開始</h1><h2 id="第一步-測試"><a href="#第一步-測試" class="headerlink" title="第一步 - 測試"></a>第一步 - 測試</h2><p>先來說說怎麼測試自己的寫的代碼正確性，不然怎麼寫都只是理論腦補，雖然會動，但是不知道是否寫對。</p>
<ul>
<li><p>第一種方式為下達 </p>
<pre><code>$ ./nachos -e ../test/test1 -e ../test/test2 ... 多個
</code></pre><p>  這樣必須自己設置優先權、Burst Time，這方面撰寫方式有兩種，其一是來亂，其二是較為正式，而在 Burst Time 的計算又分成兩種，一是執行前已知、二是執行時猜測。</p>
<ul>
<li><p>其一來亂寫法，</p>
<pre><code>$ ./nachos -e ../test/test1 -e ../test/test2 ... 多個
</code></pre><p>  不改變原本的的執行方式，直接在代碼中決策 thread fork 出來時所擁有的優先權和 Burst Time。<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> testPriority = <span class="number">0</span>;</div><div class="line"><span class="keyword">void</span> </div><div class="line">Thread::Fork(VoidFunctionPtr func, <span class="keyword">void</span> *arg)</div><div class="line">&#123;</div><div class="line"><span class="comment">// morris add</span></div><div class="line">    testPriority++;</div><div class="line">    <span class="keyword">if</span>(testPriority == <span class="number">1</span>)</div><div class="line">        setPriority(<span class="number">64</span>);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(testPriority == <span class="number">2</span>)</div><div class="line">        setPriority(<span class="number">128</span>);</div><div class="line">    <span class="keyword">else</span></div><div class="line">        setPriority(<span class="number">64</span>);</div><div class="line"><span class="comment">// end morris add</span></div></pre></td></tr></table></figure><br>  因此，您可能會寫出以上的代碼，當然我不建議這麼寫，雖然是一種測試方式，但這並不好，一開始就這麼錯得相當離譜。</p>
</li>
<li><p>其二寫法，增加下達參數，不過這些參數格式要去查閱一下他們的參數傳遞建造，我想會寫成大概的樣子為</p>
<pre><code>$ ./nachos -e ../test/test1 -pw 64 -e ../test/test2  -pw 128 ... 
</code></pre><p>  多個為了不增加工作量，這裡就沒有親自去實作。某方面來說，可能要寫很多 small program 進行測試，並且撰寫時還要預測會跑多久，這難度會稍微提高。</p>
</li>
</ul>
</li>
<li><p>第二種方式按照軟工的寫法<br>  來寫 test code 吧！如果細心一點，就會看到相關的 <code>Class::SelfTest()</code> 在很多 class 都有的，因此我們需要把 test code 寫到 SelfTest 中被呼叫。因此，不需要有實體的 process 運行，只是單純地測試我們寫的 scheduler 的排程順序是否正確。<figure class="highlight cpp"><figcaption><span>threads/thread.cc</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span></div><div class="line">threadBody() &#123;</div><div class="line">    Thread *thread = kernel-&gt;currentThread;</div><div class="line">    <span class="keyword">while</span> (thread-&gt;getBurstTime() &gt; <span class="number">0</span>) &#123;</div><div class="line">        thread-&gt;setBurstTime(thread-&gt;getBurstTime() - <span class="number">1</span>);</div><div class="line">        kernel-&gt;interrupt-&gt;OneTick();</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%s: remaining %d\n"</span>, kernel-&gt;currentThread-&gt;getName(), kernel-&gt;currentThread-&gt;getBurstTime());</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">void</span></div><div class="line">Thread::SchedulingTest()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> thread_num = <span class="number">4</span>;</div><div class="line">    <span class="keyword">char</span> *name[thread_num] = &#123;<span class="string">"A"</span>, <span class="string">"B"</span>, <span class="string">"C"</span>, <span class="string">"D"</span>&#125;;</div><div class="line">    <span class="keyword">int</span> thread_priority[thread_num] = &#123;<span class="number">5</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>&#125;;</div><div class="line">    <span class="keyword">int</span> thread_burst[thread_num] = &#123;<span class="number">3</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">3</span>&#125;;</div><div class="line">    </div><div class="line">    Thread *t;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; thread_num; i ++) &#123;</div><div class="line">        t = <span class="keyword">new</span> Thread(name[i]);</div><div class="line">        t-&gt;setPriority(thread_priority[i]);</div><div class="line">        t-&gt;setBurstTime(thread_burst[i]);</div><div class="line">        t-&gt;Fork((VoidFunctionPtr) threadBody, (<span class="keyword">void</span> *)<span class="literal">NULL</span>);</div><div class="line">    &#125;</div><div class="line">    kernel-&gt;currentThread-&gt;Yield();</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>  請自行在 <code>class Thread</code> 增加 <code>setPriority()</code>, <code>setBurstTime()</code>, <code>SchedulingTest()</code> … 等 method header and body。<figure class="highlight cpp"><figcaption><span>threads/thread.h</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Thread</span> &#123;</span></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">   ...</div><div class="line"></div><div class="line">  <span class="keyword">public</span>:</div><div class="line">   ...</div><div class="line">    <span class="comment">// morris add</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setBurstTime</span><span class="params">(<span class="keyword">int</span> t)</span>	</span>&#123;burstTime = t;&#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getBurstTime</span><span class="params">()</span>		</span>&#123;<span class="keyword">return</span> burstTime;&#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setStartTime</span><span class="params">(<span class="keyword">int</span> t)</span>	</span>&#123;startTime = t;&#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getStartTime</span><span class="params">()</span>		</span>&#123;<span class="keyword">return</span> startTime;&#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setPriority</span><span class="params">(<span class="keyword">int</span> t)</span>	</span>&#123;execPriority = t;&#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPriority</span><span class="params">()</span>		</span>&#123;<span class="keyword">return</span> execPriority;&#125;</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SchedulingTest</span><span class="params">()</span></span>;</div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="comment">// some of the private data for this class is listed above</span></div><div class="line"></div><div class="line">    <span class="comment">// morris add</span></div><div class="line">    <span class="keyword">int</span> burstTime;	<span class="comment">// predicted burst time</span></div><div class="line">    <span class="keyword">int</span> startTime;	<span class="comment">// the start time of the thread</span></div><div class="line">    <span class="keyword">int</span> execPriority;	<span class="comment">// the execute priority of the thread</span></div><div class="line">    ...</div><div class="line">&#125;;</div></pre></td></tr></table></figure><br>  接著是需要 call testcode 加入到 ThreadedKernel 中。<figure class="highlight cpp"><figcaption><span>threads/kernel.cc</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span></div><div class="line">ThreadedKernel::SelfTest() &#123;</div><div class="line">   Semaphore *semaphore;</div><div class="line">   SynchList&lt;<span class="keyword">int</span>&gt; *synchList;</div><div class="line">   </div><div class="line">   LibSelfTest();		<span class="comment">// test library routines</span></div><div class="line">   </div><div class="line">   currentThread-&gt;SelfTest();	<span class="comment">// test thread switching</span></div><div class="line">   Thread::SchedulingTest();   </div><div class="line">   				<span class="comment">// test semaphore operation</span></div><div class="line">   semaphore = <span class="keyword">new</span> Semaphore(<span class="string">"test"</span>, <span class="number">0</span>);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>  因此我們可以利用單一 module 就能進行檢查。</p>
<pre><code>$ cd code/threads
$ ./nachos
</code></pre><p>  但是這種方式，並沒有決定我們要測試哪一種類型的 scheduler，額外需要設定參數，讓其選擇建造哪一種的 <code>readyList(Thread*)</code></p>
<pre><code>$ cd code/threads
$ ./nachos FCFS
$ ./nachos SJF
$ ./nachos Priority
$ ./nachos RR
</code></pre><p>  預計要修成如上述的測試方式。<figure class="highlight cpp"><figcaption><span>threads/main.cc</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span></div><div class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    debug = <span class="keyword">new</span> Debug(debugArg);</div><div class="line">    </div><div class="line">    DEBUG(dbgThread, <span class="string">"Entering main"</span>);</div><div class="line"><span class="comment">//</span></div><div class="line">    SchedulerType type = RR;</div><div class="line">    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"FCFS"</span>) == <span class="number">0</span>) &#123;</div><div class="line">    type = FIFO;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"SJF"</span>) == <span class="number">0</span>) &#123;</div><div class="line">    type = SJF;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"PRIORITY"</span>) == <span class="number">0</span>) &#123;</div><div class="line">    type = Priority;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"RR"</span>) == <span class="number">0</span>) &#123;</div><div class="line">    type = RR;</div><div class="line">    &#125;</div><div class="line"><span class="comment">//</span></div><div class="line">    kernel = <span class="keyword">new</span> KernelType(argc, argv);</div><div class="line">    kernel-&gt;Initialize(type);</div><div class="line">    </div><div class="line">    CallOnUserAbort(Cleanup);		<span class="comment">// if user hits ctl-C</span></div><div class="line"></div><div class="line">    kernel-&gt;SelfTest();</div><div class="line">    kernel-&gt;Run();</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<blockquote>
<p>第一步測試撰寫就這麼結束，比起撰寫新的 code，不會進行測試也是徒勞。</p>
<p>雖然這麼說，實際運作也是先寫 code 再寫 test code，因為當時還不太懂這些，所以如果已經先寫了一些也不用難過，大家都是這麼走過來的。</p>
<p>如果不知道怎麼執行，哪還有什麼撰寫的欲望，如果不知道怎麼測試，那就是在黑暗中漫步。</p>
</blockquote>
<h2 id="第二步-撰寫"><a href="#第二步-撰寫" class="headerlink" title="第二步 - 撰寫"></a>第二步 - 撰寫</h2><p>在撰寫開始前，如果使用走第一種測試方式的人，需要將實體記憶體用大一點，否則需要實作虛擬記憶體的 context-swith。</p>
<figure class="highlight cpp"><figcaption><span>machine/machine.h</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> NumPhysPages = <span class="number">64</span>;  <span class="comment">// morris modify, old value=32</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MemorySize = (NumPhysPages * PageSize);</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> TLBSize = <span class="number">4</span>;			<span class="comment">// if there is a TLB, make it small</span></div></pre></td></tr></table></figure>
<p>若完成以上的修改，在 <code>/userprog</code> 下，執行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ./nachos -e ../test/test1 -e ../test/test2 -e ../test/test1</div></pre></td></tr></table></figure></p>
<p>就不會跑出 segment fault 。<br><figure class="highlight cpp"><figcaption><span>threads/scheduler.h</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> SchedulerType &#123;</div><div class="line">        RR,     <span class="comment">// Round Robin</span></div><div class="line">        SJF,</div><div class="line">        Priority,</div><div class="line">        FIFO</div><div class="line">&#125;;</div><div class="line">...</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scheduler</span> &#123;</span></div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    Scheduler();</div><div class="line">    Scheduler(SchedulerType type);		<span class="comment">// Initialize list of ready threads </span></div><div class="line">    ...</div><div class="line">    	<span class="comment">// morris add</span></div><div class="line">    <span class="function">SchedulerType <span class="title">getSchedulerType</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> schedulerType;&#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSchedulerType</span><span class="params">(SchedulerType t)</span> </span>&#123;schedulerType = t;&#125;</div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    ...</div><div class="line">&#125;;</div></pre></td></tr></table></figure><br>如果有機會查閱其他代碼，很常見會把 <code>List&lt;Thread *&gt; *readyList;</code> 改成 <code>SortedList&lt;Thread *&gt; *readyList;</code> 但是其實不用的，可以利用多形來完成，畢竟 <code>SortedList</code> 繼承 <code>List</code>。因此是不需要更動的。</p>
<p>接著，我們使用多形，在建構子中決定要用哪一種類型的排程，並且宣告相對應的 <code>compare function</code>，參照如下。<br><figure class="highlight cpp"><figcaption><span>threads/scheduler.cc</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">SJFCompare</span><span class="params">(Thread *a, Thread *b)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span>(a-&gt;getBurstTime() == b-&gt;getBurstTime())</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">return</span> a-&gt;getBurstTime() &gt; b-&gt;getBurstTime() ? <span class="number">1</span> : <span class="number">-1</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">PriorityCompare</span><span class="params">(Thread *a, Thread *b)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span>(a-&gt;getPriority() == b-&gt;getPriority())</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">return</span> a-&gt;getPriority() &gt; b-&gt;getPriority() ? <span class="number">1</span> : <span class="number">-1</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">FIFOCompare</span><span class="params">(Thread *a, Thread *b)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">//----------------------------------------------------------------------</span></div><div class="line"><span class="comment">// Scheduler::Scheduler</span></div><div class="line"><span class="comment">// 	Initialize the list of ready but not running threads.</span></div><div class="line"><span class="comment">//	Initially, no ready threads.</span></div><div class="line"><span class="comment">//----------------------------------------------------------------------</span></div><div class="line">Scheduler::Scheduler() &#123;</div><div class="line">    Scheduler(RR);</div><div class="line">&#125;</div><div class="line">Scheduler::Scheduler(SchedulerType type)</div><div class="line">&#123;</div><div class="line">    schedulerType = type;</div><div class="line">    <span class="keyword">switch</span>(schedulerType) &#123;</div><div class="line">    <span class="keyword">case</span> RR:</div><div class="line">        readyList = <span class="keyword">new</span> List&lt;Thread *&gt;;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> SJF:</div><div class="line">        readyList = <span class="keyword">new</span> SortedList&lt;Thread *&gt;(SJFCompare);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> Priority:</div><div class="line">        readyList = <span class="keyword">new</span> SortedList&lt;Thread *&gt;(PriorityCompare);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> FIFO:</div><div class="line">        readyList = <span class="keyword">new</span> SortedList&lt;Thread *&gt;(FIFOCompare);</div><div class="line">    &#125;</div><div class="line">    toBeDestroyed = <span class="literal">NULL</span>;</div><div class="line">&#125; </div></pre></td></tr></table></figure><br>上述的寫法是因為沒有辦法宣告 default argument value for class。</p>
<p>如果需要搶先 (Preemptive) 設計，則在 <code>Alarm::CallBack()</code> 決定是否要呼叫 <code>interrupt-&gt;YieldOnReturn()</code> 查看是否有更需要優先的 process 要執行。<br><figure class="highlight cpp"><figcaption><span>threads/alarm.cc</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> </div><div class="line">Alarm::CallBack() </div><div class="line">&#123;</div><div class="line">    Interrupt *interrupt = kernel-&gt;interrupt;</div><div class="line">    MachineStatus status = interrupt-&gt;getStatus();</div><div class="line">    <span class="keyword">bool</span> woken = _bedroom.MorningCall();</div><div class="line"></div><div class="line">    kernel-&gt;currentThread-&gt;setPriority(kernel-&gt;currentThread-&gt;getPriority() - <span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (status == IdleMode &amp;&amp; !woken &amp;&amp; _bedroom.IsEmpty()) &#123;<span class="comment">// is it time to quit?</span></div><div class="line">        <span class="keyword">if</span> (!interrupt-&gt;AnyFutureInterrupts()) &#123;</div><div class="line">        timer-&gt;Disable();	<span class="comment">// turn off the timer</span></div><div class="line">    &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;			<span class="comment">// there's someone to preempt</span></div><div class="line">    <span class="keyword">if</span>(kernel-&gt;scheduler-&gt;getSchedulerType() == RR ||</div><div class="line">        kernel-&gt;scheduler-&gt;getSchedulerType() == Priority ) &#123;</div><div class="line"><span class="comment">//		interrupt-&gt;YieldOnReturn();</span></div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"=== interrupt-&gt;YieldOnReturn ==="</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        interrupt-&gt;YieldOnReturn();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 Burst Time 計算上，如果採用運行時估計，可以在以下代碼中進行計算。<code>kernel-&gt;stats-&gt;userTicks</code> 是執行 user program 的時間累加器 (也存有一個 system program 的時間累加器，運行 thread context-free, thread scheduling … 等時間用途。)<br><figure class="highlight cpp"><figcaption><span>threads/alarm.cc</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> </div><div class="line">Alarm::WaitUntil(<span class="keyword">int</span> x) &#123;</div><div class="line">    IntStatus oldLevel = kernel-&gt;interrupt-&gt;SetLevel(IntOff);</div><div class="line">    Thread* t = kernel-&gt;currentThread;</div><div class="line"></div><div class="line">    <span class="comment">// burst time</span></div><div class="line">    <span class="keyword">int</span> worktime = kernel-&gt;stats-&gt;userTicks - t-&gt;getStartTime();</div><div class="line">    t-&gt;setBurstTime(t-&gt;getBurstTime() + worktime);</div><div class="line">    t-&gt;setStartTime(kernel-&gt;stats-&gt;userTicks);</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Alarm::WaitUntil go sleep"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    _bedroom.PutToBed(t, x);</div><div class="line">    kernel-&gt;interrupt-&gt;SetLevel(oldLevel);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其實到這裡已經完成，接下來就放幾張測試結果。</p>
<p><img src="/img/multiprogramming.png" alt="multi-programming"></p>
<p><img src="/img/FCFS-1.png" alt="FCFS(1)"><br><img src="/img/FCFS-2.png" alt="FCFS(2)"></p>
<p><img src="/img/RR-1.png" alt="RR(1)"><br><img src="/img/RR-2.png" alt="RR(2)"></p>
<p><img src="/img/SJF-1.png" alt="SJF(1)"><br><img src="/img/SJF-2.png" alt="SJF(2)"></p>
<p><img src="/img/Priority-1.png" alt="Priority(1)"><br><img src="/img/Priority-2.png" alt="Priority(1)"></p>
<h1 id="最後"><a href="#最後" class="headerlink" title="最後"></a>最後</h1><p>如果在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cd code</div><div class="line">$ make</div></pre></td></tr></table></figure></p>
<p>編譯時發生錯誤，想必是兩個地方的 <code>Initialize()</code> 發生錯誤，所以請參照以下代碼進行修改。這問題是發生於我們在 <code>/threads</code> 下修改 main.cc 的關係，所以必須在每一個 kernel 宣告地方都給一個決定 scheduler 類型的參數。</p>
<p>其一,<br><figure class="highlight cpp"><figcaption><span>userprog/userkernel.h</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"../threads/scheduler.h"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SynchDisk</span>;</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserProgKernel</span> :</span> <span class="keyword">public</span> ThreadedKernel &#123;</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">  	...</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Initialize</span><span class="params">()</span></span>;		<span class="comment">// initialize the kernel </span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Initialize</span><span class="params">(SchedulerType type)</span></span>;</div><div class="line">    ...</div></pre></td></tr></table></figure><br>其二,<br><figure class="highlight cpp"><figcaption><span>userprog/userkernel.cc</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span></div><div class="line">UserProgKernel::Initialize()</div><div class="line">&#123;</div><div class="line">    Initialize(RR);</div><div class="line">&#125;</div><div class="line"><span class="keyword">void</span></div><div class="line">UserProgKernel::Initialize(SchedulerType type)</div><div class="line">&#123;</div><div class="line">    ThreadedKernel::Initialize(type);	<span class="comment">// init multithreading</span></div><div class="line"></div><div class="line">    machine = <span class="keyword">new</span> Machine(debugUserProg);</div><div class="line">    fileSystem = <span class="keyword">new</span> FileSystem();</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> FILESYS</span></div><div class="line">    synchDisk = <span class="keyword">new</span> SynchDisk(<span class="string">"New SynchDisk"</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// FILESYS</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure><br>其三,<br><figure class="highlight cpp"><figcaption><span>network/netkernel.h</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"../threads/scheduler.h"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostOfficeInput</span>;</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostOfficeOutput</span>;</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">NetKernel</span> :</span> <span class="keyword">public</span> UserProgKernel &#123;</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Initialize</span><span class="params">()</span></span>;		<span class="comment">// initialize the kernel </span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Initialize</span><span class="params">(SchedulerType)</span></span>;</div><div class="line">    ...</div></pre></td></tr></table></figure><br>其四,<br><figure class="highlight cpp"><figcaption><span>network/netkernel.cc</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> </div><div class="line">NetKernel::Initialize() &#123;</div><div class="line">    Initialize(RR);</div><div class="line">&#125;</div><div class="line"><span class="keyword">void</span></div><div class="line">NetKernel::Initialize(SchedulerType type)</div><div class="line">&#123;</div><div class="line">    UserProgKernel::Initialize(type);	<span class="comment">// init other kernel data structs</span></div><div class="line"></div><div class="line">    postOfficeIn = <span class="keyword">new</span> PostOfficeInput(<span class="number">10</span>);</div><div class="line">    postOfficeOut = <span class="keyword">new</span> PostOfficeOutput(reliability, <span class="number">10</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="致網路資源"><a href="#致網路資源" class="headerlink" title="致網路資源"></a>致網路資源</h1><p>感謝網路上前人們所遺留的遺產。雖然在看不懂的文字中摸索，但仍抓到了一點線索。</p>
<blockquote>
<p>我一無所有，直到見到了你們。</p>
</blockquote>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-oj/uva/uva-157" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/29/oj/uva/uva-157/" class="article-date">
  <time datetime="2014-05-29T01:23:04.000Z" itemprop="datePublished">2014-05-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/05/29/oj/uva/uva-157/">UVa 157 - Route Finding</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2014/05/29/oj/uva/uva-157/" data-id="cksb6gb3803dcd8vnvkn8xcn3" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2014/05/29/oj/uva/uva-157/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SPFA/">SPFA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SSSP/">SSSP</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>Many cities provide a comprehensive public transport system, often integrating bus routes, suburban commuter train services and underground railways. Routes on such systems can be categorised according to the stations or stops along them. We conventionally think of them as forming lines (where the vehicle shuttles from one end of the route to the other and returns), loops (where the two ends of the <code>branch</code> are the same and vehicles circle the system in both directions) and connections, where each end of the route connects with another route. Obviously all of these can be thought of as very similar, and can connect with each other at various points along their routes. Note that vehicles can travel in both directions along all routes, and that it is only possible to change between routes at connecting stations.</p>
<p>To simplify matters, each route is given a designation letter from the set <code>A</code> to <code>Z</code>, and each station along a route will be designated by another letter from the set <code>a</code> to <code>z</code>. Connecting stations will have more than one designation. Thus an example could be:</p>
<p><img src="/img/157img1.gif" alt=""></p>
<p>A common problem in such systems is finding a route between two stations. Once this has been done we wish to find the <code>best</code> route, where <code>best</code> means <code>shortest time</code>.</p>
<p>Write a program that will read in details of such a system and then will find the fastest routes between given pairs of stations. You can assume that the trip between stations always takes 1 unit of time and that changing between routes at a connecting station takes 3 units of time.</p>
<h2 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h2><p>Input will consist of two parts. The first will consist of a description of a system, the second will consist of pairs of stations. The description will start with a number between 1 and 26 indicating how many routes there are in the system. This will be followed by that many lines, each describing a single route. Each line will start with the route identifier followed by a <code>:</code> followed by the stations along that route, in order. Connections will be indicated by an <code>=</code> sign followed by the complete alternative designation. All connections will be identified at least once, and if there are more than two lines meeting at a connection, some or of all the alternative designations may be identified together. That is, there may be sequences such as <code>...hc=Bg=Cc=Abd...</code>. If the route forms a loop then the last station will be the same as the first. This is the only situation in which station letters will be repeated. The next portion of the input file will consist of a sequence of lines each containing two stations written contiguously. The file will be terminated by a line consisting of a single #.</p>
<h2 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h2><p>Output will consist of a series of lines, one for each pair of stations in the input. Each line will consist of the time for the fastest route joining the two stations, right justified in a field of width 3, followed by a colon and a space and the sequence of stations representing the shortest journey. Follow the example shown below. Note that there will always be only one fastest route for any given pair of stations and that the route must start and finish at the named stations (not at any synonyms thereof), hence the time for the route must include the time for any inter-station transfers.</p>
<p>The example input below refers to the diagram given above.</p>
<h2 id="Sample-input"><a href="#Sample-input" class="headerlink" title="Sample input"></a>Sample input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">4</div><div class="line">A:fgmpnxzabjd=Dbf</div><div class="line">D:b=Adac=Ccf</div><div class="line">B:acd=Azefg=Cbh</div><div class="line">C:bac</div><div class="line">AgAa</div><div class="line">AbBh</div><div class="line">BhDf</div><div class="line">#</div></pre></td></tr></table></figure>
<h2 id="Sample-output"><a href="#Sample-output" class="headerlink" title="Sample output"></a>Sample output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> 5: Agfdjba</div><div class="line"> 9: Abaz=Bdefgh</div><div class="line">10: Bhg=Cbac=Dcf</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p><strong> 題目描述：</strong></p>
<p>這一個交通運輸工具，配置如上圖所述，以大寫字母 (<code>A</code> - <code>Z</code>) 表示哪一種線路，每一條線路上有一些站牌 (<code>a</code> - <code>z</code>)。求某線某站到某線某站的最少花費時間。</p>
<p>然而在同一個線路上，轉換一個站的成本為 <code>1</code>，如果在線路交集站換一條線路走成本為 <code>3</code>。</p>
<p>輸入上比較特別，會用 <code>=</code> 表示交集的站編號，當然有可能會遇到多個線路的站交集在一起。</p>
<p><code>Dhc=Bg=Cc=Abd</code> 則表示 D 線路上的 Dh-Dc-Dd，其中 Dc, Bg, Cc, Ab 共站。</p>
<p>可以當作雙向連通，如果有環，則會頭尾相同，例如 <code>Dhch</code>。</p>
<p><strong> 題目解法：</strong></p>
<p>題目最令人討厭的是，交集站沒有說清楚，也就是說單一線路上的轉運站沒有說清楚，但事實上會被表示在其他線路上，這裡要自己取聯集。</p>
<p>但是做聯集是件挺麻煩的事，因此在求最短路上做點手腳，把狀態表示成 <code>(某線某站, 前一次是否轉運)</code>，這麼做就方便多了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">trans_node</span><span class="params">(<span class="keyword">int</span> r, <span class="keyword">int</span> a)</span> </span>&#123;</div><div class="line">    r -= <span class="string">'A'</span>, a -= <span class="string">'a'</span>;</div><div class="line">    <span class="keyword">return</span> r * <span class="number">26</span> + a;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">reverse_node</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> &amp;r, <span class="keyword">int</span> &amp;a)</span> </span>&#123;</div><div class="line">    r = n /<span class="number">26</span> + <span class="string">'A'</span>, a = n %<span class="number">26</span> + <span class="string">'a'</span>;</div><div class="line">&#125;</div><div class="line"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; g[<span class="number">1024</span>], g2[<span class="number">1024</span>];</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">spfa</span><span class="params">(<span class="keyword">int</span> st, <span class="keyword">int</span> ed)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> used[<span class="number">1024</span>][<span class="number">2</span>] = &#123;&#125;, dist[<span class="number">1024</span>][<span class="number">2</span>] = &#123;&#125;, prex[<span class="number">1024</span>][<span class="number">2</span>][<span class="number">2</span>];</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1024</span>; i++)</div><div class="line">        dist[i][<span class="number">0</span>] = dist[i][<span class="number">1</span>] = <span class="number">0x3f3f3f3f</span>;</div><div class="line">    <span class="built_in">queue</span>&lt;<span class="keyword">int</span>&gt; Q, S;</div><div class="line">    Q.push(st), S.push(<span class="number">0</span>);</div><div class="line">    dist[st][<span class="number">0</span>] = <span class="number">0</span>, prex[st][<span class="number">0</span>][<span class="number">0</span>] = <span class="number">-1</span>;</div><div class="line">    <span class="keyword">while</span>(!Q.empty()) &#123;</div><div class="line">        <span class="keyword">int</span> u = Q.front(), s = S.front();</div><div class="line">        Q.pop(), S.pop();</div><div class="line">        used[u][s] = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; g[u].size(); i++) &#123;</div><div class="line">            <span class="keyword">int</span> v = g[u][i];</div><div class="line">            <span class="keyword">if</span>(dist[v][<span class="number">0</span>] &gt; dist[u][s] + <span class="number">1</span>) &#123;</div><div class="line">                dist[v][<span class="number">0</span>] = dist[u][s] + <span class="number">1</span>;</div><div class="line">                prex[v][<span class="number">0</span>][<span class="number">0</span>] = u, prex[v][<span class="number">0</span>][<span class="number">1</span>] = s;</div><div class="line">                <span class="keyword">if</span>(!used[v][<span class="number">0</span>]) &#123;</div><div class="line">                    used[v][<span class="number">0</span>] = <span class="number">1</span>, Q.push(v), S.push(<span class="number">0</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> cost = (s == <span class="number">1</span>) ? <span class="number">0</span> : <span class="number">3</span>;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; g2[u].size(); i++) &#123;</div><div class="line">            <span class="keyword">int</span> v = g2[u][i];</div><div class="line">            <span class="keyword">if</span>(dist[v][<span class="number">1</span>] &gt; dist[u][s] + cost) &#123;</div><div class="line">                dist[v][<span class="number">1</span>] = dist[u][s] + cost;</div><div class="line">                </div><div class="line">                <span class="keyword">if</span>(cost == <span class="number">0</span>)</div><div class="line">                    prex[v][<span class="number">1</span>][<span class="number">0</span>] = prex[u][s][<span class="number">0</span>], prex[v][<span class="number">1</span>][<span class="number">1</span>] = prex[u][s][<span class="number">1</span>];</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    prex[v][<span class="number">1</span>][<span class="number">0</span>] = u, prex[v][<span class="number">1</span>][<span class="number">1</span>] = s;</div><div class="line"></div><div class="line">                <span class="keyword">if</span>(!used[v][<span class="number">1</span>]) &#123;</div><div class="line">                    used[v][<span class="number">1</span>] = <span class="number">1</span>, Q.push(v), S.push(<span class="number">1</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%3d: "</span>, min(dist[ed][<span class="number">0</span>], dist[ed][<span class="number">1</span>]));</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> r = <span class="number">-1</span>, a = <span class="number">-1</span>, s, mm = ed;</div><div class="line">    <span class="keyword">if</span>(dist[ed][<span class="number">0</span>] &lt;= dist[ed][<span class="number">1</span>])</div><div class="line">        s = <span class="number">0</span>;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        s = <span class="number">1</span>;</div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="keyword">int</span> nr, na;</div><div class="line">        reverse_node(mm, nr, na);</div><div class="line">        <span class="keyword">if</span>(nr != r) &#123;</div><div class="line">            <span class="keyword">if</span>(mm != ed)	<span class="built_in">printf</span>(<span class="string">"="</span>);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%c%c"</span>, nr, na);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%c"</span>, na);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> om = mm;</div><div class="line">        mm = prex[om][s][<span class="number">0</span>], s = prex[om][s][<span class="number">1</span>];</div><div class="line">        r = nr, a = na;</div><div class="line">    &#125; <span class="keyword">while</span>(mm != <span class="number">-1</span>);</div><div class="line">    <span class="built_in">puts</span>(<span class="string">""</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">char</span> line[<span class="number">1024</span>];</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> n; <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n) == <span class="number">1</span>;) &#123;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1024</span>; i++)</div><div class="line">            g[i].clear(), g2[i].clear();</div><div class="line">        <span class="keyword">while</span>(n--) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%s"</span>, &amp;line);</div><div class="line">            <span class="keyword">int</span> r = line[<span class="number">0</span>], preX;</div><div class="line">            preX = trans_node(r, line[<span class="number">2</span>]);</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">3</span>; line[i]; i++) &#123;</div><div class="line">                <span class="keyword">if</span>(line[i] != <span class="string">'='</span>) &#123;</div><div class="line">                    <span class="keyword">int</span> x = trans_node(r, line[i]);</div><div class="line">                    <span class="keyword">int</span> y = preX;</div><div class="line">                    g[x].push_back(y);</div><div class="line">                    g[y].push_back(x);</div><div class="line">                    preX = x;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">int</span> x = trans_node(line[i+<span class="number">1</span>], line[i+<span class="number">2</span>]);</div><div class="line">                    <span class="keyword">int</span> y = preX;</div><div class="line">                    g2[x].push_back(y);</div><div class="line">                    g2[y].push_back(x);</div><div class="line">                    i += <span class="number">2</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">while</span>(<span class="built_in">scanf</span>(<span class="string">"%s"</span>, line) == <span class="number">1</span> &amp;&amp; line[<span class="number">0</span>] != <span class="string">'#'</span>) &#123;</div><div class="line">            <span class="keyword">int</span> x = trans_node(line[<span class="number">0</span>], line[<span class="number">1</span>]);</div><div class="line">            <span class="keyword">int</span> y = trans_node(line[<span class="number">2</span>], line[<span class="number">3</span>]);</div><div class="line">            spfa(y, x);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">4</span></div><div class="line"><span class="comment">A:fgmpnxzabjd=Dbf</span></div><div class="line"><span class="comment">D:b=Adac=Ccf</span></div><div class="line"><span class="comment">B:acd=Azefg=Cbh</span></div><div class="line"><span class="comment">C:bac</span></div><div class="line"><span class="comment">AgAa</span></div><div class="line"><span class="comment">AbBh</span></div><div class="line"><span class="comment">BhDf</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">5 </span></div><div class="line"><span class="comment">A:ab=Bbcdefghijk </span></div><div class="line"><span class="comment">B:abc=Ajdef=Cb </span></div><div class="line"><span class="comment">C:ab </span></div><div class="line"><span class="comment">D:cd=Eg </span></div><div class="line"><span class="comment">E:fg=Bf </span></div><div class="line"><span class="comment">AaAk </span></div><div class="line"><span class="comment">AcAk </span></div><div class="line"><span class="comment">AbBb </span></div><div class="line"><span class="comment">BaDd </span></div><div class="line"><span class="comment"># </span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-oj/uva/uva-172" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/28/oj/uva/uva-172/" class="article-date">
  <time datetime="2014-05-27T23:33:52.000Z" itemprop="datePublished">2014-05-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/05/28/oj/uva/uva-172/">UVa 172 - Calculator Language</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2014/05/28/oj/uva/uva-172/" data-id="cksb6gb4n03epd8vn8n8f262t" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2014/05/28/oj/uva/uva-172/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/parsing-tree/">parsing tree</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/stack/">stack</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p> Calculator Language (CL) supports assignment, positive and negative integers and simple arithmetic. The allowable characters in a CL statement are thus:</p>
<p><img src="/img/172img1.gif" alt=""></p>
<p>All operators have the same precedence and are right associative, thus 15 - 8 - 3 = 15 - (8 - 3) = 10. As one would expect, brackets will force the expression within them to be evaluated first. Brackets may be nested arbitrarily deeply. An expression never has two operators next to each other (even if separated by a bracket), an assignment operator is always immediately preceded by a variable and the leftmost operator on a line is always an assignment. For readability, spaces may be freely inserted into an expression, except between a negative sign and a number. A negative sign will not appear before a variable. All variables are initialised to zero (0) and retain their values until changed explicitly.</p>
<p>Write a program that will accept and evaluate expressions written in this language. Each expression occupies one line and contains at least one assignment operator, and maybe more.</p>
<h2 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h2><p>Input will consist of a series of lines, each line containing a correct CL expression. No line will be longer than 100 characters. The file will be terminated by a line consisting of a single #.</p>
<h2 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h2><p>Output will consist of a series of lines, one for each line of the input. Each line will consist of a list of the final values of all variables whose value changes as a result of the evaluation of that expression. If more than one variable changes value, they should be listed in alphabetical order, separated by commas. If a variable changes value more than once in an expression, only the final value is output. A variable is said to change value if its value after the expression has been evaluated is different from its value before the expression was evaluated. If no variables change value, then print the message `No Change’. Follow the format shown below exactly.</p>
<h2 id="Sample-input"><a href="#Sample-input" class="headerlink" title="Sample input"></a>Sample input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">A = B = 4</div><div class="line">C = (D = 2)*_2</div><div class="line">C = D = 2 * _2</div><div class="line">F = C - D</div><div class="line">E = D * _10</div><div class="line">Z = 10 / 3</div><div class="line">#</div></pre></td></tr></table></figure>
<h2 id="Sample-output"><a href="#Sample-output" class="headerlink" title="Sample output"></a>Sample output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">A = 4, B = 4</div><div class="line">C = -4, D = 2</div><div class="line">D = -4</div><div class="line">No Change</div><div class="line">E = 40</div><div class="line">Z = 3</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p><strong> 題目描述：</strong></p>
<p>給一個六則運算，並且所有運算由右往左，也就是題目提及的 <code>right associative</code>，並且在每一個運算式之後輸出有改變值的變數結果。</p>
<p><strong> 題目解法：</strong></p>
<p>要處理的問題相當多，按照一般的思路要做出 <code>right associative</code> 還不打緊，就像冪次的定義一樣，也就是把 stack 的嚴格遞增改成非嚴格遞增。</p>
<p>但是查閱討論區給定的數據後，如下所示</p>
<p>範例輸入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">B=(A=1)+(A=2)</div><div class="line">#</div></pre></td></tr></table></figure></p>
<p>範例輸出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">A = 1, B = 3</div></pre></td></tr></table></figure></p>
<p>這表示著連括弧運算順序都是 <code>right associative</code>，這一點相當苦惱，於是最後建造 tree，然後先拜訪右子樹、再拜訪左子樹來解決這些問題。</p>
<p>中間誤把 <code>No Change</code> 寫成 <code>No change</code>，因此卡了不少 <code>Wrong Answer</code>。</p>
<p>Sample Input:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">A = B = 4</div><div class="line">B=B-6+B=100</div><div class="line">C = (D = 2) * _2</div><div class="line">C = D = 2 * _2</div><div class="line">E = D * _10</div><div class="line">F = 15 - 8 - 3</div><div class="line">F = 15 - 8 + _3</div><div class="line">F=1+F=F-1</div><div class="line">A=((3))</div><div class="line">Z=Y=X=A=B=C=1+D=E=F=G=2-H=K=J=I=L=M=O=N=P=Q=R=S=T=V=U=W=3</div><div class="line">A=100/2</div><div class="line">A=100/_2</div><div class="line">B=(_1+A*2)/2</div><div class="line">B=(1+A*_2)/2</div><div class="line">A=(((1-2)*3)+4)</div><div class="line">A=((1-(2*3))+4)</div><div class="line">A=((1-2)*(3+4))</div><div class="line">A=(1-(2*(3+4)))</div><div class="line">A=1+2+1+1+1+1+1+1+1+1+1+1+1+1+1+11+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+3</div><div class="line">#</div></pre></td></tr></table></figure></p>
<p>AC Sample Output:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">A = 4, B = 4</div><div class="line">B = -6</div><div class="line">C = -4, D = 2</div><div class="line">D = -4</div><div class="line">E = 40</div><div class="line">F = 10</div><div class="line">No Change</div><div class="line">No Change</div><div class="line">A = 3</div><div class="line">A = 0, B = 0, C = 0, D = -1, E = -1, F = -1, G = -1, H = 3, I = 3, J = 3, K = 3, L = 3, M = 3, N = 3, O = 3, P = 3, Q = 3, R = 3, S = 3, T = 3, U = 3, V = 3, W = 3</div><div class="line">A = 50</div><div class="line">A = -50</div><div class="line">B = -50</div><div class="line">B = 50</div><div class="line">A = 1</div><div class="line">A = -1</div><div class="line">A = -7</div><div class="line">A = -13</div><div class="line">A = 62</div></pre></td></tr></table></figure></p>
<p>一開始還在想為什麼當 <code>B = 4</code> 時，<code>B=B-6+B=100</code> 會產出 <code>B = -6</code>，由右往左運算。</p>
<ul>
<li>B = 100</li>
<li>6 + B = 106</li>
<li>B - (6 + B) = 100 - 106 = -6</li>
<li>B assign(=) -6</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Accepted</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stack&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sstream&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">priority_op</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123;</div><div class="line">    <span class="keyword">switch</span>(c) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'('</span>:<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'='</span>:<span class="keyword">return</span> <span class="number">3</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'+'</span>: <span class="keyword">case</span> <span class="string">'-'</span>:<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'*'</span>: <span class="keyword">case</span> <span class="string">'/'</span>:<span class="keyword">return</span> <span class="number">2</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">puts</span>(<span class="string">"ERROR"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">trans</span><span class="params">(<span class="keyword">char</span> infix[], <span class="keyword">char</span> buffer[])</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> len = <span class="built_in">strlen</span>(infix);</div><div class="line">    <span class="keyword">char</span> *ptr = buffer;</div><div class="line">    <span class="built_in">stack</span>&lt;<span class="keyword">char</span>&gt; op;</div><div class="line">    *ptr = <span class="string">'\0'</span>;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</div><div class="line">        <span class="keyword">if</span>(infix[i] == <span class="string">'_'</span> || <span class="built_in">isdigit</span>(infix[i]) || <span class="built_in">isalpha</span>(infix[i])) &#123;</div><div class="line">        	<span class="keyword">while</span>(infix[i] == <span class="string">'_'</span> || <span class="built_in">isdigit</span>(infix[i]) || <span class="built_in">isalpha</span>(infix[i])) &#123;</div><div class="line">        		<span class="keyword">if</span>(infix[i] == <span class="string">'_'</span>)</div><div class="line">        			<span class="built_in">sprintf</span>(ptr, <span class="string">"-"</span>);</div><div class="line">        		<span class="keyword">else</span></div><div class="line">            		<span class="built_in">sprintf</span>(ptr, <span class="string">"%c"</span>, infix[i]);	</div><div class="line">            	<span class="keyword">while</span>(*ptr)    ptr++;</div><div class="line">            	i++;</div><div class="line">        	&#125;</div><div class="line">            <span class="built_in">sprintf</span>(ptr, <span class="string">" "</span>);	</div><div class="line">            <span class="keyword">while</span>(*ptr)    ptr++;</div><div class="line">        	i--;</div><div class="line">        &#125;<span class="keyword">else</span> &#123;</div><div class="line">        	<span class="keyword">if</span>(infix[i] == <span class="string">' '</span>)	<span class="keyword">continue</span>;</div><div class="line">            <span class="keyword">if</span>(infix[i] == <span class="string">')'</span>) &#123;</div><div class="line">                <span class="keyword">while</span>(!op.empty() &amp;&amp; op.top() != <span class="string">'('</span>) &#123;</div><div class="line">                    <span class="built_in">sprintf</span>(ptr, <span class="string">"%c "</span>, op.top()), op.pop();</div><div class="line">                    <span class="keyword">while</span>(*ptr) ptr++;</div><div class="line">                &#125;</div><div class="line">                op.pop();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span>(infix[i] != <span class="string">'('</span>) &#123;</div><div class="line">                	<span class="keyword">if</span>(infix[i] == <span class="string">'='</span>) &#123;</div><div class="line">                		<span class="keyword">while</span>(!op.empty() &amp;&amp; priority_op(op.top()) &gt; priority_op(infix[i])) &#123;</div><div class="line">                    		<span class="built_in">sprintf</span>(ptr, <span class="string">"%c "</span>, op.top()), op.pop();</div><div class="line">                    		<span class="keyword">while</span>(*ptr) ptr++;</div><div class="line">                		&#125;</div><div class="line">                	&#125; <span class="keyword">else</span> &#123;</div><div class="line">                		<span class="keyword">while</span>(!op.empty() &amp;&amp; priority_op(op.top()) &gt; priority_op(infix[i]) &amp;&amp; op.top() != <span class="string">'='</span>) &#123;</div><div class="line">                    		<span class="built_in">sprintf</span>(ptr, <span class="string">"%c "</span>, op.top()), op.pop();</div><div class="line">                    		<span class="keyword">while</span>(*ptr) ptr++;</div><div class="line">                		&#125;</div><div class="line">                	&#125;</div><div class="line">                &#125;</div><div class="line">                op.push(infix[i]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span>(!op.empty()) &#123;</div><div class="line">        <span class="built_in">sprintf</span>(ptr, <span class="string">"%c "</span>, op.top()), op.pop();</div><div class="line">        <span class="keyword">while</span>(*ptr) ptr++;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">int</span> Variable[<span class="number">26</span>] = &#123;&#125;, oldVal[<span class="number">26</span>] = &#123;&#125;;</div><div class="line"><span class="function"><span class="built_in">string</span> <span class="title">to_string</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</div><div class="line">   <span class="built_in">stringstream</span> ss;<span class="comment">//create a stringstream</span></div><div class="line">   ss &lt;&lt; number;<span class="comment">//add number to the stream</span></div><div class="line">   <span class="keyword">return</span> ss.str();<span class="comment">//return a string with the contents of the stream</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TreeNode</span> &#123;</span></div><div class="line">    <span class="built_in">string</span> 	A, B, OP;</div><div class="line">    <span class="keyword">int</span> 	l, r;</div><div class="line">    TreeNode(<span class="built_in">string</span> a=<span class="string">""</span>, <span class="built_in">string</span> b=<span class="string">""</span>, <span class="built_in">string</span> op=<span class="string">""</span>):</div><div class="line">        A(a), B(b), OP(op) &#123;&#125;</div><div class="line">&#125;;</div><div class="line">TreeNode node[<span class="number">1024</span>];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">runTree</span><span class="params">(<span class="keyword">int</span> label)</span> </span>&#123;</div><div class="line">    <span class="built_in">string</span> 	A = node[label].A;</div><div class="line">    <span class="built_in">string</span>	B = node[label].B;</div><div class="line">    <span class="keyword">int</span> 	a, b;</div><div class="line">    <span class="keyword">if</span>(node[label].OP == <span class="string">"LEAF"</span>) &#123;</div><div class="line">        <span class="keyword">if</span>(<span class="built_in">isalpha</span>(A[<span class="number">0</span>]))</div><div class="line">           	a = Variable[A[<span class="number">0</span>] - <span class="string">'A'</span>];</div><div class="line">        <span class="keyword">else</span></div><div class="line">           	a = atoi(A.c_str());</div><div class="line">        <span class="keyword">return</span> a;	</div><div class="line">    &#125;</div><div class="line">    b = runTree(node[label].r);</div><div class="line">    a = runTree(node[label].l);</div><div class="line"><span class="comment">//	printf("%d %d\n", a, b);</span></div><div class="line">    <span class="comment">//cout &lt;&lt; A &lt;&lt; ", " &lt;&lt; B &lt;&lt; ", " &lt;&lt; node[label].OP &lt;&lt; endl;</span></div><div class="line">    <span class="keyword">switch</span>(node[label].OP[<span class="number">0</span>]) &#123;</div><div class="line">    	<span class="keyword">case</span> <span class="string">'+'</span>: a = a + b; <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'-'</span>: a = a - b; <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'*'</span>: a = a * b; <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'/'</span>: a = a / b; <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'='</span>: </div><div class="line">        	a = b;</div><div class="line">        	<span class="keyword">if</span>(<span class="built_in">isalpha</span>(A[<span class="number">0</span>])) &#123;</div><div class="line">        		Variable[A[<span class="number">0</span>] - <span class="string">'A'</span>] = a;</div><div class="line">        		<span class="comment">//cout &lt;&lt; A &lt;&lt; " -- " &lt;&lt; a &lt;&lt; endl;</span></div><div class="line">        	&#125;</div><div class="line">        	<span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> a;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">buildTree</span><span class="params">(<span class="keyword">char</span> postfix[])</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="built_in">stringstream</span>	<span class="title">sin</span><span class="params">(postfix)</span></span>;</div><div class="line">    <span class="built_in">string</span> 			token, A, B;</div><div class="line">    <span class="built_in">stack</span>&lt;<span class="built_in">string</span>&gt;	stk;</div><div class="line">    <span class="built_in">stack</span>&lt;<span class="keyword">int</span>&gt;		nodeLabel;</div><div class="line">    <span class="keyword">int</span> 			treeSize = <span class="number">0</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">while</span>(<span class="built_in">sin</span> &gt;&gt; token) &#123;</div><div class="line">    	<span class="keyword">if</span>(<span class="built_in">isalpha</span>(token[<span class="number">0</span>])) &#123;</div><div class="line">    		stk.push(token);</div><div class="line">    		nodeLabel.push(treeSize);</div><div class="line">    		node[treeSize++] = TreeNode(token, <span class="string">""</span>, <span class="string">"LEAF"</span>);</div><div class="line">    		</div><div class="line">    	&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">isdigit</span>(token[token.length() - <span class="number">1</span>])) &#123;</div><div class="line">    		stk.push(token);</div><div class="line">    		nodeLabel.push(treeSize);</div><div class="line">    		node[treeSize++] = TreeNode(token, <span class="string">""</span>, <span class="string">"LEAF"</span>);</div><div class="line">    	&#125; <span class="keyword">else</span> &#123;</div><div class="line">            B = stk.top(), stk.pop();</div><div class="line">            A = stk.top(), stk.pop();</div><div class="line">            <span class="keyword">int</span> a, b;</div><div class="line">            b = nodeLabel.top(), nodeLabel.pop();</div><div class="line">            a = nodeLabel.top(), nodeLabel.pop();</div><div class="line">            nodeLabel.push(treeSize);</div><div class="line">            node[treeSize] = TreeNode(A, B, token);</div><div class="line">            node[treeSize].l = a, node[treeSize].r = b;</div><div class="line">            treeSize++;</div><div class="line">            stk.push(<span class="string">"INNER"</span>);</div><div class="line">    	&#125;</div><div class="line">    &#125;</div><div class="line">    runTree(nodeLabel.top());</div><div class="line">&#125;</div><div class="line"><span class="keyword">char</span> infix[<span class="number">262144</span>], postfix[<span class="number">262144</span>];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span>(gets(infix) &amp;&amp; infix[<span class="number">0</span>] != <span class="string">'#'</span>) &#123;</div><div class="line">        trans(infix, postfix);</div><div class="line">        </div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++)</div><div class="line">        	oldVal[i] = Variable[i];</div><div class="line">        	</div><div class="line">        buildTree(postfix);</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> f = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++) &#123;</div><div class="line">        	<span class="keyword">if</span>(oldVal[i] != Variable[i]) &#123;</div><div class="line">        		<span class="keyword">if</span>(f)	<span class="built_in">printf</span>(<span class="string">", "</span>);</div><div class="line">        		f = <span class="number">1</span>;</div><div class="line">        		<span class="built_in">printf</span>(<span class="string">"%c = %d"</span>, i + <span class="string">'A'</span>, Variable[i]);</div><div class="line">        	&#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(f == <span class="number">0</span>)</div><div class="line">        	<span class="built_in">puts</span>(<span class="string">"No Change"</span>);</div><div class="line">        <span class="keyword">else</span></div><div class="line">        	<span class="built_in">puts</span>(<span class="string">""</span>);</div><div class="line">        <span class="comment">//printf("%s\n", postfix);</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-oj/uva/uva-177" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/27/oj/uva/uva-177/" class="article-date">
  <time datetime="2014-05-26T23:35:58.000Z" itemprop="datePublished">2014-05-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/05/27/oj/uva/uva-177/">UVa 177 - Paper Folding</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2014/05/27/oj/uva/uva-177/" data-id="cksb6gb4v03ewd8vnzjgjr2rx" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2014/05/27/oj/uva/uva-177/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/遞迴/">遞迴</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>If a large sheet of paper is folded in half, then in half again, etc, with all the folds parallel, then opened up flat, there are a series of parallel creases, some pointing up and some down, dividing the paper into fractions of the original length. If the paper is only opened <code>half-way&#39;&#39; up, so every crease forms a 90 degree angle, then (viewed end-on) it forms a</code>dragon curve’’. For example, if four successive folds are made, then the following curve is seen (note that it does not cross itself, but two corners touch):</p>
<p><img src="/img/177img1.gif" alt="UVa 177"></p>
<p>Write a program to draw the curve which appears after N folds. The exact specification of the curve is as follows:</p>
<ul>
<li>The paper starts flat, with the ``start edge’’ on the left, looking at it from above.</li>
<li>The right half is folded over so it lies on top of the left half, then the right half of the new double sheet is folded on top of the left, to form a 4-thick sheet, and so on, for N folds.</li>
<li>Then every fold is opened from a 180 degree bend to a 90 degree bend.</li>
<li>Finally the bottom edge of the paper is viewed end-on to see the dragon curve. </li>
</ul>
<p>From this view, the only unchanged part of the original paper is the piece containing the <code>start edge</code>, and this piece will be horizontal, with the <code>start edge</code> on the left. This uniquely defines the curve. In the above picture, the <code>start edge</code> is the left end of the rightmost bottom horizontal piece (marked <code>s</code>). Horizontal pieces are to be displayed with the underscore character <code>_</code>, and vertical pieces with the <code>|</code> character.</p>
<h2 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h2><p>Input will consist of a series of lines, each with a single number N (1 &lt;= N &lt;= 13). The end of the input will be marked by a line containing a zero.</p>
<h2 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h2><p>Output will consist of a series of dragon curves, one for each value of N in the input. Your picture must be shifted as far left, and as high as possible. Note that for large N, the picture will be greater than 80 characters wide, so it will look messy on the screen. The pattern for each different number of folds is terminated by a line containing a single `^’.</p>
<h2 id="Sample-input"><a href="#Sample-input" class="headerlink" title="Sample input"></a>Sample input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2</div><div class="line">4</div><div class="line">1</div><div class="line">0</div></pre></td></tr></table></figure>
<h2 id="Sample-output"><a href="#Sample-output" class="headerlink" title="Sample output"></a>Sample output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">|_</div><div class="line"> _|</div><div class="line">^</div><div class="line">   _   _</div><div class="line">  |_|_| |_</div><div class="line">   _|    _|</div><div class="line">|_|</div><div class="line">^</div><div class="line">_|</div><div class="line">^</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p><strong> 題目描述：</strong></p>
<p>將一個長條紙水平擺放，接著將右手邊的紙摺疊到左上邊的紙上面，接著又再重複做幾次，直到 <code>N</code> 次 ( 若將其攤平則會有 2<sup>N</sup> 個折疊區塊 )。摺疊完後，依序將其攤開，攤開的方式為：將前一次摺疊的 (想像與 <code>s</code> 重疊的那一片) 從 180 度旋轉到 90 度位置，依序攤開 N 次。</p>
<p><strong> 題目解法：</strong></p>
<p>這一題就是題目理解麻煩點，但是不難發現肯定是有遞迴需要處理的。</p>
<p>假設我們定義展開的每一根，分別為往上下左右的射線，會發現其對應關係，新的尾會跟舊的頭對照，依序對照到中間部分。</p>
<p>最後得到關係</p>
<ul>
<li>上 變成 左</li>
<li>下 變成 右</li>
<li>左 變成 下</li>
<li>右 變成 上</li>
</ul>
<p>輸出處理方面，利用一個 map 結構去完成。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;set&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="built_in">map</span>&lt;<span class="keyword">int</span>, <span class="built_in">set</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt; &gt; P;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> A[<span class="number">1</span>&lt;&lt;<span class="number">15</span>];</div><div class="line">    <span class="comment">// 0 up, 1 down, 2 left, 3 right</span></div><div class="line">    <span class="keyword">int</span> trans[] = &#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>&#125;;</div><div class="line">    <span class="keyword">int</span> m = <span class="number">1</span>;</div><div class="line">    A[<span class="number">0</span>] = <span class="number">3</span>;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = m - <span class="number">1</span>, k = m; j &gt;= <span class="number">0</span>; j--, k++)</div><div class="line">            A[k] = trans[A[j]];</div><div class="line">        m = m &lt;&lt; <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> x = <span class="number">-1</span>, y = <span class="number">0</span>, px = <span class="number">0</span>, py = <span class="number">0</span>;</div><div class="line">    P.clear();</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">        <span class="keyword">if</span>(A[i] == <span class="number">0</span>)		x = px&lt;&lt;<span class="number">1</span>, y = py;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(A[i] == <span class="number">1</span>)	x = px&lt;&lt;<span class="number">1</span>, y = py - <span class="number">1</span>;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(A[i] == <span class="number">2</span>)	x = (px&lt;&lt;<span class="number">1</span>)<span class="number">-1</span>, y = py;</div><div class="line">        <span class="keyword">else</span>				x = (px&lt;&lt;<span class="number">1</span>)+<span class="number">1</span>, y = py;</div><div class="line">        <span class="comment">//printf("%d %d %d - %d %d\n", px, py, A[i], x, y);</span></div><div class="line">        <span class="keyword">if</span>(A[i] == <span class="number">0</span>) &#123;</div><div class="line">            P[y].insert(make_pair(x, <span class="number">0</span>));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(A[i] == <span class="number">1</span>) &#123;</div><div class="line">            P[y].insert(make_pair(x, <span class="number">1</span>));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(A[i] == <span class="number">2</span>) &#123;</div><div class="line">            P[y].insert(make_pair(x, <span class="number">2</span>));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            P[y].insert(make_pair(x, <span class="number">3</span>));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(A[i] == <span class="number">0</span>)		py++;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(A[i] == <span class="number">1</span>)	py--;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(A[i] == <span class="number">2</span>)	px--;</div><div class="line">        <span class="keyword">else</span>				px++;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> n; <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n) == <span class="number">1</span> &amp;&amp; n; ) &#123;</div><div class="line">        build(n);</div><div class="line">        <span class="keyword">int</span> mxy = <span class="number">-0x3f3f3f3f</span>, mnx = <span class="number">0x3f3f3f3f</span>;</div><div class="line">        <span class="keyword">for</span>(<span class="built_in">map</span>&lt;<span class="keyword">int</span>, <span class="built_in">set</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt; &gt;::iterator it = P.begin();</div><div class="line">        it != P.end(); it++) &#123;</div><div class="line">            mxy = max(mxy, it-&gt;first);</div><div class="line">            <span class="keyword">for</span>(<span class="built_in">set</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt;::iterator jt = it-&gt;second.begin();</div><div class="line">                jt != it-&gt;second.end(); jt++) &#123;</div><div class="line">                mnx = min(mnx, jt-&gt;first);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span>(<span class="built_in">map</span>&lt;<span class="keyword">int</span>, <span class="built_in">set</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt; &gt;::reverse_iterator it = P.rbegin();</div><div class="line">        it != P.rend(); it++) &#123;</div><div class="line">            <span class="keyword">int</span> i = mnx;</div><div class="line">            <span class="keyword">for</span>(<span class="built_in">set</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt;::iterator jt = it-&gt;second.begin();</div><div class="line">                jt != it-&gt;second.end(); jt++) &#123;</div><div class="line">                <span class="keyword">while</span>(i &lt; jt-&gt;first)	<span class="built_in">putchar</span>(<span class="string">' '</span>), i++;</div><div class="line">                i++;</div><div class="line">                <span class="keyword">if</span>(jt-&gt;second == <span class="number">0</span> || jt-&gt;second == <span class="number">1</span>)</div><div class="line">                    <span class="built_in">putchar</span>(<span class="string">'|'</span>);</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    <span class="built_in">putchar</span>(<span class="string">'_'</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="built_in">puts</span>(<span class="string">""</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//printf("%d %d\n", mxy, mnx);</span></div><div class="line">        <span class="built_in">puts</span>(<span class="string">"^"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-oj/uva/uva-132" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/26/oj/uva/uva-132/" class="article-date">
  <time datetime="2014-05-25T22:59:01.000Z" itemprop="datePublished">2014-05-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/05/26/oj/uva/uva-132/">UVa 132 - Bumpy Objects</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2014/05/26/oj/uva/uva-132/" data-id="cksb6gb1403bid8vngc8szxoo" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2014/05/26/oj/uva/uva-132/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/凸包/">凸包</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/幾何/">幾何</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p><img src="/img/132img1.gif" alt="132img1"></p>
<p>Consider objects such as these. They are polygons, specified by the coordinates of a centre of mass and their vertices. In the figure, centres of mass are shown as black squares. The vertices will be numbered consecutively anti-clockwise as shown.</p>
<p>An object can be rotated to stand stably if two vertices can be found that can be joined by a straight line that does not intersect the object, and, when this line is horizontal, the centre of mass lies above the line and strictly between its endpoints. There are typically many stable positions and each is defined by one of these lines known as its base line. A base line, and its associated stable position, is identified by the highest numbered vertex touched by that line.</p>
<p>Write a program that will determine the stable position that has the lowest numbered base line. Thus for the above objects, the desired base lines would be 6 for object 1, 6 for object 2 and 2 for the square. You may assume that the objects are possible, that is they will be represented as non self-intersecting polygons, although they may well be concave.</p>
<h2 id="Input-and-Output"><a href="#Input-and-Output" class="headerlink" title="Input and Output"></a>Input and Output</h2><p>Successive lines of a data set will contain: a string of less than 20 characters identifying the object; the coordinates of the centre of mass; and the coordinates of successive points terminated by two zeroes (0 0), on one or more lines as necessary. There may be successive data sets (objects). The end of data will be defined by the string ‘#’.</p>
<p>Output will consist of the identification string followed by the number of the relevant base line.</p>
<h2 id="Sample-input"><a href="#Sample-input" class="headerlink" title="Sample input"></a>Sample input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Object2</div><div class="line">4 3</div><div class="line">3 2  5 2  6 1  7 1  6 3  4 7  1 1  2 1  0 0</div><div class="line">Square </div><div class="line">2 2</div><div class="line">1 1  3 1  3 3  1 3  0 0</div><div class="line">#</div></pre></td></tr></table></figure>
<h2 id="Sample-output"><a href="#Sample-output" class="headerlink" title="Sample output"></a>Sample output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Object2             6</div><div class="line">Square              2</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p><strong> 題目描述： </strong></p>
<p>給定一個多邊形，將會給予這個多邊形的質心和頂點。在圖中，質心表示成黑色正方形的小點，而頂點將會使用連續編號逆時針給點。</p>
<p>多邊形可以藉由旋轉放置於水平，並且穩定立起。這時可以發現，會有兩個頂點拉起的水平線，並且質心會位於水平線上的兩個端點之間。</p>
<p>通常一個多邊形具有多個這種水平放置方法，對於一個水平放置方式，可以用在水平線上最大編號的頂點描述。</p>
<p>請輸出最小水平放置的編號。</p>
<p><strong> 題目解法： </strong></p>
<p>對多邊形著手凸包計算，這裡使用單調鍊去完成凸包。接著利用內積找到質心是否在兩個水平線端點 (segment 的上方) 之間。</p>
<p>可以利用外積判斷是否在線 (line) 上。</p>
<p>好好利用數學運算，將可以在簡短的代碼完成。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> eps 1e-6</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pt</span> &#123;</span></div><div class="line">    <span class="keyword">double</span> x, y;</div><div class="line">    Pt(<span class="keyword">double</span> a = <span class="number">0</span>, <span class="keyword">double</span> b = <span class="number">0</span>):</div><div class="line">    	x(a), y(b) &#123;&#125;</div><div class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">if</span>(<span class="built_in">fabs</span>(x-a.x) &gt; eps)</div><div class="line">            <span class="keyword">return</span> x &lt; a.x;</div><div class="line">        <span class="keyword">return</span> y &lt; a.y;</div><div class="line">    &#125;</div><div class="line">    Pt <span class="keyword">operator</span>-(<span class="keyword">const</span> Pt &amp;a) <span class="keyword">const</span> &#123;</div><div class="line">        Pt ret;</div><div class="line">        ret.x = x - a.x;</div><div class="line">        ret.y = y - a.y;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">dot</span><span class="params">(Pt a, Pt b)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> a.x * b.x + a.y * b.y;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">cross2</span><span class="params">(Pt a, Pt b)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> a.x * b.y - a.y * b.x;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">cross</span><span class="params">(Pt o, Pt a, Pt b)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (a.x-o.x)*(b.y-o.y)-(a.y-o.y)*(b.x-o.x);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">between</span><span class="params">(Pt a, Pt b, Pt c)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> dot(c - a, b - a) &gt;= <span class="number">0</span> &amp;&amp; dot(c - b, a - b) &gt;= <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">onSeg</span><span class="params">(Pt a, Pt b, Pt c)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> between(a, b, c) &amp;&amp; <span class="built_in">fabs</span>(cross(a, b, c)) &lt; eps;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">monotone</span><span class="params">(<span class="keyword">int</span> n, Pt p[], Pt ch[])</span> </span>&#123;</div><div class="line">    sort(p, p+n);</div><div class="line">    <span class="keyword">int</span> i, m = <span class="number">0</span>, t;</div><div class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">        <span class="keyword">while</span>(m &gt;= <span class="number">2</span> &amp;&amp; cross(ch[m<span class="number">-2</span>], ch[m<span class="number">-1</span>], p[i]) &lt;= <span class="number">0</span>)</div><div class="line">            m--;</div><div class="line">        ch[m++] = p[i];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span>(i = n<span class="number">-1</span>, t = m+<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="keyword">while</span>(m &gt;= t &amp;&amp; cross(ch[m<span class="number">-2</span>], ch[m<span class="number">-1</span>], p[i]) &lt;= <span class="number">0</span>)</div><div class="line">            m--;</div><div class="line">        ch[m++] = p[i];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> m - <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">char</span> testcase[<span class="number">105</span>];</div><div class="line">    Pt P[<span class="number">1024</span>], CH[<span class="number">1024</span>], IN[<span class="number">1024</span>];</div><div class="line">    <span class="keyword">while</span>(<span class="built_in">scanf</span>(<span class="string">"%s"</span>, testcase) == <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(testcase, <span class="string">"#"</span>))</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">double</span> 	x, y;</div><div class="line">        <span class="keyword">int</span> 	n = <span class="number">0</span>, m;</div><div class="line">        Pt mc;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%lf %lf"</span>, &amp;mc.x, &amp;mc.y);</div><div class="line">        <span class="keyword">while</span>(<span class="built_in">scanf</span>(<span class="string">"%lf %lf"</span>, &amp;x, &amp;y) == <span class="number">2</span>) &#123;</div><div class="line">            <span class="keyword">if</span>(x == <span class="number">0</span> &amp;&amp; y == <span class="number">0</span>)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            IN[n] = P[n] = Pt(x, y);</div><div class="line">            n++;</div><div class="line">        &#125;</div><div class="line">        m = monotone(n, P, CH);</div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0x3f3f3f3f</span>;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>, j = m - <span class="number">1</span>; i &lt; m; j = i++) &#123;</div><div class="line">            <span class="keyword">if</span>(between(CH[i], CH[j], mc)) &#123;</div><div class="line">                <span class="keyword">int</span> mn = <span class="number">0</span>;</div><div class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; n; k++)</div><div class="line">                    <span class="keyword">if</span>(onSeg(CH[i], CH[j], IN[k]))</div><div class="line">                        mn = max(mn, k);</div><div class="line">                ret = min(ret, mn);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%-20s%d\n"</span>, testcase, ret + <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-lesson/hw-multiprocess-and-multithread" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/25/lesson/hw-multiprocess-and-multithread/" class="article-date">
  <time datetime="2014-05-25T12:15:47.000Z" itemprop="datePublished">2014-05-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/作業系統/">作業系統</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/05/25/lesson/hw-multiprocess-and-multithread/">作業系統 multiprocess &amp; multithread 作業</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2014/05/25/lesson/hw-multiprocess-and-multithread/" data-id="cksb6ga6402fad8vnr07477nq" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2014/05/25/lesson/hw-multiprocess-and-multithread/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/multiprocess/">multiprocess</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/multithread/">multithread</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h1 id="A-班程式要求"><a href="#A-班程式要求" class="headerlink" title="A 班程式要求"></a>A 班程式要求</h1><p>請使用所熟悉的程式開發環境設計單一行程產生子行程 ( Child Process ) 與 多執行緒 ( Multi-Thread) 的程式，意即完成下列傳統 for loop 之列印工作，將其改寫成多行程與多執行緒，由不同的行程與執行緒列印不同 i 值。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"output i = %d\n"</span>, i);</div></pre></td></tr></table></figure>
<h1 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h1><ul>
<li><strong> 嚴禁從網路抄襲作業 </strong>。每份程式作業將被程式比對軟體檢查，一旦發現抄襲，該份作業以零分計，並且這學期作業系統作業成績以零分計。</li>
<li>後略</li>
</ul>
<blockquote>
<p>這種作業不抄來抄去也難。但是作業格式不清楚，所以也有不同理解方式就是了。</p>
</blockquote>
<h1 id="開始動手"><a href="#開始動手" class="headerlink" title="開始動手"></a>開始動手</h1><p>對於將 for 迴圈改寫，我們必須認知到幾項</p>
<ul>
<li>是否要按照順序輸出？</li>
<li>平台 M$, Linux, or Max OS？</li>
</ul>
<blockquote>
<p>此篇假設目標是一模一樣的輸出</p>
</blockquote>
<h2 id="multiprocess"><a href="#multiprocess" class="headerlink" title="multiprocess"></a>multiprocess</h2><p><code>child process</code> 屬於 multiprocess 中的一種方式。為什麼這麼說呢？multiprocess 只是要求一個 CPU 中有多個工作同時在進行，藉由排程器去進行工作分配。</p>
<p>先不管這些，要實作 <code>child process</code> 看起來只有走向 <code>fork()</code> 一途。而之前 inker 大神則是走非 child process 使用類似 <code>./nachos -e ../test/test1 -e ../test/test1</code> 的方式去運行。</p>
<p>為了實作按照順序輸出，我們需要 process 共同擁有的 shared memory，這個 shared memory 將要紀錄原本 for 裡面的 <code>i</code> 值和一個 <code>sem_t</code>，來保證 process 和 process 之間不會同時搶先動作，<code>sem_t</code> 也許是不需要的，這裡留給實驗者去測試。</p>
<p>為了使輸出一致，在 <code>fork()</code> 完之後，使用 <code>wait()</code> 來等待所有子程序結束。這樣會造成當 for loop 需要跑 n 次，就會總共 n 個 process，也就是一整條鏈下去。</p>
<ul>
<li>思考 <code>wait()</code> 和 <code>sem_t</code> 都不是這麼必要？// 這個要看寫法</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span>  MAP_ANONYMOUS</span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span>  MAP_ANON</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAP_ANONYMOUS MAP_ANON</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> *glob_var;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> n = <span class="number">32</span>;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    glob_var = (<span class="keyword">int</span> *)mmap(<span class="literal">NULL</span>, <span class="keyword">sizeof</span> *glob_var, PROT_READ | PROT_WRITE,</div><div class="line">                    MAP_SHARED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">sem_t</span> *sema = (<span class="keyword">sem_t</span> *)mmap(<span class="literal">NULL</span>, <span class="keyword">sizeof</span>(sema),</div><div class="line">                       PROT_READ |PROT_WRITE,MAP_SHARED|MAP_ANONYMOUS,</div><div class="line">                       <span class="number">-1</span>, <span class="number">0</span>);</div><div class="line">    sem_init(sema, <span class="number">1</span>, <span class="number">0</span>);</div><div class="line">    *glob_var = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (*glob_var &lt; n) &#123;</div><div class="line">        sem_wait(sema);</div><div class="line">        <span class="keyword">int</span> pid = fork();</div><div class="line">        <span class="keyword">int</span> output = (*glob_var)++;</div><div class="line">        <span class="keyword">if</span> (output &lt; n)</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d, pid = %d\n"</span>, output, pid);</div><div class="line">        sem_post(sema);</div><div class="line">        <span class="keyword">int</span> wpid, status = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> ((wpid = wait(&amp;status)) &gt; <span class="number">0</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="comment">//printf("Exit status of %d was %d (%s)\n", (int)wpid, status, (status &gt; 0) ? "accept" : "reject");</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    munmap(glob_var, <span class="keyword">sizeof</span> *glob_var);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="multithread"><a href="#multithread" class="headerlink" title="multithread"></a>multithread</h2><p>Thread 就相當簡單，因為它們是共用同一個記憶體區段，因此沒有 share memory 的問題。<br>雖然使用 <code>sem_wait(&amp;sem)</code> 和 <code>sem_post(&amp;sem)</code> 來保證區域內的代碼不會同時有多個 thread 在運行，但仍遇到 <code>i = 0</code> 同時在多個 Thread 噴出的情況，這一點百思不得其解，為了解決這一切問題，使用課本提到的 <code>Producer–consumer problem</code> 寫法。</p>
<p>希望能從代碼中看懂。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></div><div class="line"><span class="keyword">int</span> i = <span class="number">0</span>, n = <span class="number">16</span>;</div><div class="line"><span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line"><span class="keyword">sem_t</span> sem;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAX_THREAD = <span class="number">4</span>;</div><div class="line"><span class="function"><span class="keyword">void</span> *<span class="title">Producer</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n;) &#123;</div><div class="line">        sem_wait(&amp;sem);</div><div class="line">        <span class="keyword">if</span>(count == <span class="number">1</span>) &#123;</div><div class="line">            sem_post(&amp;sem);</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        count++;</div><div class="line">        <span class="comment">// printf("\nProducer is :%d\n", count);</span></div><div class="line">        sem_post(&amp;sem);</div><div class="line">        i++;</div><div class="line">    &#125;</div><div class="line">    pthread_exit(<span class="literal">NULL</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> *<span class="title">runPrint</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> id = *((<span class="keyword">int</span> *) arg);</div><div class="line">    <span class="keyword">for</span> (; i &lt; n ;) &#123;</div><div class="line">        sem_wait(&amp;sem);</div><div class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</div><div class="line">            sem_post(&amp;sem);</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        count--;</div><div class="line">        i++;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"loop i = %d, thread id %d\n"</span>, i, id);</div><div class="line">        sem_post(&amp;sem);</div><div class="line">    &#125;</div><div class="line">    pthread_exit(<span class="literal">NULL</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">pthread_t</span> *threads;</div><div class="line">    sem_init(&amp;sem, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    threads = (<span class="keyword">pthread_t</span> *) <span class="built_in">malloc</span>(MAX_THREAD * <span class="keyword">sizeof</span>(<span class="keyword">pthread_t</span>));</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_THREAD; i++) &#123;</div><div class="line">        <span class="keyword">int</span> *p = (<span class="keyword">int</span> *) <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</div><div class="line">        *p = i;</div><div class="line">        pthread_create(&amp;threads[i], <span class="literal">NULL</span>, runPrint, (<span class="keyword">void</span> *)(p));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">pthread_t</span> producer;</div><div class="line">    <span class="keyword">int</span> *p = (<span class="keyword">int</span> *) <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</div><div class="line">    *p = <span class="number">-1</span>;</div><div class="line">    pthread_create(&amp;producer, <span class="literal">NULL</span>, Producer, (<span class="keyword">void</span> *)(p));</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_THREAD; i++) &#123;</div><div class="line">        pthread_join(threads[i], <span class="literal">NULL</span>);</div><div class="line">    &#125;</div><div class="line">    sem_destroy(&amp;sem);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="後記"><a href="#後記" class="headerlink" title="後記"></a>後記</h2><p>代碼沒有寫得很完整，也就是能達到輸出相同且用符合需求，這一點是有很多漏洞的，前人也是鑽漏洞交作業的。相較之下，我們 B 班的作業略顯兇殘，但是網路上資料還真是少呢，雖然還是找地方抄和理解。</p>
<p>測試的時候，為了保證輸出是穩定的，記得得多測試幾次，並且把數字範圍作變調，當然能不能讓一個 create thread 跑完整個迴圈呢？畢竟加上 main thread 就算是 multithread？haha</p>
<h1 id="執行"><a href="#執行" class="headerlink" title="執行"></a>執行</h1><h2 id="編譯"><a href="#編譯" class="headerlink" title="編譯"></a>編譯</h2><ul>
<li><p>Mac OSX</p>
<pre><code>$ clang -pthread x.cpp -o x
</code></pre></li>
<li><p>Linux</p>
<pre><code>$ gcc -lpthread x.cpp -o x
</code></pre><h2 id="運行"><a href="#運行" class="headerlink" title="運行"></a>運行</h2></li>
<li><p>Linux &amp; Max OSX</p>
<pre><code>$ ./x
</code></pre></li>
</ul>
<h1 id="Mac-運行問題"><a href="#Mac-運行問題" class="headerlink" title="Mac 運行問題"></a>Mac 運行問題</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#ifndef  MAP_ANONYMOUS</div><div class="line">#ifdef  MAP_ANON</div><div class="line">#define MAP_ANONYMOUS MAP_ANON</div><div class="line">#endif</div><div class="line">#endif</div></pre></td></tr></table></figure>
<p>不知道為什麼 clang 中沒有定義 <code>MAP_ANONYMOUS</code>，增加上述代碼後正確運行。</p>
<h1 id="其他作業"><a href="#其他作業" class="headerlink" title="其他作業"></a>其他作業</h1><p><a href="http://morris821028.github.io/2014/05/18/operating-system-hw-thread/">B 班程式作業 1</a><br><a href="http://morris821028.github.io/2014/05/24/hw-nachos4/">B 班程式作業 2</a></p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-lesson/consumption-item-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/25/lesson/consumption-item-1/" class="article-date">
  <time datetime="2014-05-25T06:22:22.000Z" itemprop="datePublished">2014-05-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/通識課程/">通識課程</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="/img/sungirl3.jpg" rel="gallery_cksb6ga4n02ded8vno82cfhpv">
        <img src="/img/sungirl3.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/05/25/lesson/consumption-item-1/">當代消費文化與社會 (2)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2014/05/25/lesson/consumption-item-1/" data-id="cksb6ga4n02ded8vno82cfhpv" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2014/05/25/lesson/consumption-item-1/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/通識/">通識</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="母親節篇"><a href="#母親節篇" class="headerlink" title="母親節篇"></a>母親節篇</h2><ol>
<li>請簡述母親節與消費文化的關聯性 ?<br>母親節與消費文化原本是扯不上邊的，後來商人們藉由這些推銷的活動，給予不知道母親節要怎麼犒勞養育辛勞的兒女們一項消費選擇，因此提供了相關的優惠活動方便消費者，母親節就逐漸跟情人節送禮一樣的氣氛。</li>
<li>舉例說明母親節有哪些消費現象 ?<br>相關女性用品優惠，對於餐飲業而言就是雙人、多人套餐，而觀光景點就是帶著母親出遊享優惠 … 等等。</li>
<li>您決定購買什麼禮物送媽媽及其理由 ?<br>身為一個程序猿，買禮物卻沒有思路，寫卡片卻沒有語言，在這樣的情況下，按照自己最常做的事情下手設計，但最近還有其他程序要趕，大概是趕不上這個母親節專案了。</li>
</ol>
<h2 id="血色月灣"><a href="#血色月灣" class="headerlink" title="血色月灣"></a>血色月灣</h2><div class="video-container"><iframe src="//www.youtube.com/embed/ypeW6lSeUFc" frameborder="0" allowfullscreen></iframe></div>
<p><a href="https://www.youtube.com/watch?v=ypeW6lSeUFc" target="_blank" rel="external">Youtube</a></p>
<p>在這場被隱藏的殺戮中，繼上次壽司造成的魚類問題，沒想到日本又在海洋造成了更大的傷害，不管是不是海豚，也許有人會因為海豚可愛而在這一次的血色海灣而保護它，在我們不喜歡的動物上，說不定也有類似的問題。</p>
<p>最令人訝異的是，即使在國際會議中，也有隱瞞事實的大人物在，果然要執行某些事情，不是會議或者是組織所為，而是來自個人的發起。這句話有額外的啟發，為了背後國民的飯碗或支持，這些代表人物不得不說謊的情境，假使一開始錯了，他們便會一直錯下去，這樣的情況令人相當惋惜。</p>
<p>海豚的確很有靈性，在他們受到如此的遭遇，難免會感受到如新世界中，那些因為外表被看成不同種的情況，而受到摧殘的可能，對於靈性的動物，在受到傷害，我們給予同情，在其他情況下則沒有這麼強烈的反應。</p>
<h2 id="消費型科技商品"><a href="#消費型科技商品" class="headerlink" title="消費型科技商品"></a>消費型科技商品</h2><p>現在出門一定有 GPS 衛星導航的裝置，才能穿梭於大街小巷，這些裝置給我們相當大的便利，不用攜帶大量的地圖資訊出門，不會迷路、不用煩惱就可以輕鬆出門。</p>
<p>科技所帶來的便利，使得停下來思考的機會少了，也不會看看四周的景色，追求更快速地抵達目的地，目的地以外的機緣就越來越少了。比起問人，問機器更來得有信任感，這也表示著相信別人給的知識也不是那麼重要。根據新聞的研究報導，也許我們正在改變記憶方式，開始不擅長記繁瑣的事物，而開始擅長去哪裡找資料、如何使用資料。</p>
<p>因此，也常發生因衛星導航所造成的交通事故，被引導到錯誤地方或者是進入不合適的地點。這也反應使用者即使發現了不合理之處，最後仍相信訊息給的答案。假使衛星給了錯誤訊息，或者被惡意修改成錯誤訊息，很容易造就嚴重事故，我們已經被訓練得無法自己處理這些資訊。</p>
<p>也許老師會問我「那你認為到底要不要買衛星導航？」這一點還真的是要看需求，身為宅的人們不喜歡出門呢。</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-lesson/hw-nachos4" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/24/lesson/hw-nachos4/" class="article-date">
  <time datetime="2014-05-24T00:14:43.000Z" itemprop="datePublished">2014-05-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/作業系統/">作業系統</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/05/24/lesson/hw-nachos4/">向 NachOS 4.0 作業進發 (1)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2014/05/24/lesson/hw-nachos4/" data-id="cksb6ga6n02fwd8vndoecg3gm" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2014/05/24/lesson/hw-nachos4/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NachOS/">NachOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/作業系統/">作業系統</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h1 id="關於-NachOS-4-0"><a href="#關於-NachOS-4-0" class="headerlink" title="關於 NachOS 4.0"></a>關於 NachOS 4.0</h1><p>作為教學用作業系統，需要實現簡單並且儘量縮小與實際作業系統之間的差距，所以我們採用 Nachos 作為作業系統課程的教學實踐平臺。Nachos 是美國加州大學伯克萊分校在作業系統課程中已多次使用的作業系統課程設計平臺，在美國很多大學中得到了應用，它在作業系統教學方面具有一下幾個突出的優點：</p>
<ul>
<li>採用通用虛擬機器</li>
<li>簡單而易於擴展    </li>
<li>物件導向性</li>
<li>… 略</li>
</ul>
<blockquote>
<p>簡單地來說，就是一個模擬作業系統的軟體</p>
</blockquote>
<h1 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h1><p>課程頁面：<a href="http://networklab.csie.ncu.edu.tw/2014_os/osweb.html#download" target="_blank" rel="external">http://networklab.csie.ncu.edu.tw/2014_os/osweb.html#download</a></p>
<ul>
<li>Platform: Linux or Linux over VMware <pre><code>RedHat Linux 9.0 
</code></pre>  在 Ubuntu 上面運行無法</li>
<li>Install steps<ul>
<li>Get NachOS-4.0<pre><code>wget ../nachos-4.0.tar.gz
</code></pre></li>
<li>Get Cross Compiler<pre><code>wget ../mips-decstation.linux-xgcc.tgz
</code></pre></li>
<li>Move Cross Compiler to /<pre><code>mv ./mips-decstation.linux-xgcc.tgz /
</code></pre></li>
<li>Untar Cross Compiler<pre><code>tar zxvf ./mips-decstation.linux-xgcc.tgz
</code></pre></li>
<li>Untar NachOS-4.0<pre><code>tar zxvf ./nachos-4.0.tar.gz
</code></pre></li>
<li>Make NachOS-4.0<pre><code>cd ./nachos-4.0/code
make
</code></pre></li>
<li>Test if installation is succeeded<pre><code>cd ./userprog
./nachos -e ../test/test1
./nachos -e ../test/test2
</code></pre></li>
</ul>
</li>
</ul>
<p>預期運行結果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">Total threads number is 1</div><div class="line">Thread ../test/test1 is executing.</div><div class="line">Print integer:9</div><div class="line">Print integer:8</div><div class="line">Print integer:7</div><div class="line">Print integer:6</div><div class="line">return value:0</div><div class="line">No threads ready or runnable, and no pending interrupts.</div><div class="line">Assuming the program completed.</div><div class="line">Machine halting!</div><div class="line">                                                                                </div><div class="line">Ticks: total 200, idle 66, system 40, user 94</div><div class="line">Disk I/O: reads 0, writes 0</div><div class="line">Console I/O: reads 0, writes 0</div><div class="line">Paging: faults 0</div><div class="line">Network I/O: packets received 0, sent 0</div><div class="line"></div><div class="line">Total threads number is 1</div><div class="line">Thread ../test/test2 is executing.</div><div class="line">Print integer:20</div><div class="line">Print integer:21</div><div class="line">Print integer:22</div><div class="line">Print integer:23</div><div class="line">Print integer:24</div><div class="line">Print integer:25</div><div class="line">return value:0</div><div class="line">No threads ready or runnable, and no pending interrupts.</div><div class="line">Assuming the program completed.</div><div class="line">Machine halting!</div><div class="line"></div><div class="line">Ticks: total 200, idle 32, system 40, user 128</div><div class="line">Disk I/O: reads 0, writes 0</div><div class="line">Console I/O: reads 0, writes 0</div><div class="line">Paging: faults 0</div><div class="line">Network I/O: packets received 0, sent 0</div></pre></td></tr></table></figure></p>
<h1 id="作業階段"><a href="#作業階段" class="headerlink" title="作業階段"></a>作業階段</h1><h2 id="Multiprogramming"><a href="#Multiprogramming" class="headerlink" title="Multiprogramming"></a>Multiprogramming</h2><p>執行下述指令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./nachos –e ../test/test1 –e ../test/test2</div></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><figcaption><span>test1.c</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"syscall.h"</span></span></div><div class="line">main() &#123;</div><div class="line">    <span class="keyword">int</span> n;</div><div class="line">    <span class="keyword">for</span> (n=<span class="number">9</span>;n&gt;<span class="number">5</span>;n--)</div><div class="line">        PrintInt(n);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight cpp"><figcaption><span>test2.c</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"syscall.h"</span></span></div><div class="line"></div><div class="line">main() &#123;</div><div class="line">    <span class="keyword">int</span> n;</div><div class="line">    <span class="keyword">for</span> (n=<span class="number">20</span>;n&lt;=<span class="number">25</span>;n++)</div><div class="line">        PrintInt(n);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在開始動工前，發現在 Multithread 操作會有錯誤，test1 程序會遞減輸出，而 test2 程序會遞增輸出，但是根據運行結果，兩個程式都會遞增輸出。</p>
<p>目標運行結果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">Total threads number is 2</div><div class="line">Thread ../test/test1 is executing.</div><div class="line">Thread ../test/test2 is executing.</div><div class="line">Print integer:9</div><div class="line">Print integer:8</div><div class="line">Print integer:7</div><div class="line">Print integer:20</div><div class="line">Print integer:21</div><div class="line">Print integer:22</div><div class="line">Print integer:23</div><div class="line">Print integer:24</div><div class="line">Print integer:6</div><div class="line">return value:0</div><div class="line">Print integer:25</div><div class="line">return value:0</div><div class="line">No threads ready or runnable, and no pending interrupts.</div><div class="line">Assuming the program completed.</div><div class="line">Machine halting!</div><div class="line"> </div><div class="line">Ticks: total 300, idle 8, system 70, user 222</div><div class="line">Disk I/O: reads 0, writes 0</div><div class="line">Console I/O: reads 0, writes 0</div><div class="line">Paging: faults 0</div><div class="line">Network I/O: packets received 0, sent 0</div></pre></td></tr></table></figure></p>
<ul>
<li>為什麼兩個程式都會遞增輸出？<br>明顯地是兩個程式匯入時，操作到相同區域的 code segment。如果發現各別遞增和遞減，但是輸出 <code>n</code> 的結果錯誤，則可以想到是 <code>context-switch</code> 上發生問題。</li>
</ul>
<h3 id="解決"><a href="#解決" class="headerlink" title="解決"></a>解決</h3><p>需要為 physical address 做標記，這個 physical address 就是在 main memory 裡面的位置。而每一個 process 都會有一個 AddrSpace，然後紀錄 logical address 所對應在 physical address，也就是 <code>pageTable</code> 對應到 <code>pageTable[i].physicalPage</code>。</p>
<p>也就是說，當要執行 process 某一頁的程序，則將會去找 pageTable 所對應的 physicalPage，然後去運行。在作業一開始給的代碼中，會發現所有程序的 physicalPage 都共用，如此一來當然會執行到同一份 code。</p>
<p>首先，我們需要一個全局的標記，來記錄 main memory page 的情況。<br><figure class="highlight cpp"><figcaption><span>usrprog/addrspace.h</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddrSpace</span> &#123;</span></div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    ...</div><div class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> usedPhyPage[NumPhysPages];</div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    ...</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>接著，在 addrspace.cc 宣告實體，並且初始化是 <code>0</code>，表示全部都還沒有用過。</p>
<figure class="highlight cpp"><figcaption><span>usrprog/addrspace.cc</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"copyright.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"main.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"addrspace.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"machine.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"noff.h"</span></span></div><div class="line">    ...</div><div class="line"><span class="keyword">bool</span> AddrSpace::usedPhyPage[NumPhysPages] = &#123;<span class="number">0</span>&#125;;</div><div class="line">    ...</div></pre></td></tr></table></figure>
<p>當 process 執行成功後，將會釋放資源。此時將要把標記使用的 page 設回未使用。<br><figure class="highlight cpp"><figcaption><span>usrprog/addrspace.cc</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">AddrSpace::~AddrSpace()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numPages; i++)</div><div class="line">        AddrSpace::usedPhyPage[pageTable[i].physicalPage] = <span class="literal">false</span>;</div><div class="line">   <span class="keyword">delete</span> pageTable;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最後，就是稍微麻煩的地方，當將程序載入記憶體時，要去填入 <code>pageTable[]</code> 對應的 <code>physicalPage</code>，這裡使用線性時間去搜索第一個未使用的 page 進行填入。</p>
<p>載入確定後，便要開始執行，執行的時候要去算程序進入點，進入點的位置即是 main memory address。</p>
<p><code>mainMemory[pageTable[noffH.code.virtualAddr/PageSize].physicalPage * PageSize + (noffH.code.virtualAddr%PageSize)]</code></p>
<p>首先算出第幾頁，然後乘上 <code>PageSize</code> 就是 page base，而 page offset 則是 <code>code.address mod PageSize</code>。</p>
<p>最後，<code>page base + page offset</code> 就是我們所需要的程序進入點。</p>
<figure class="highlight cpp"><figcaption><span>usrprog/addrspace.cc</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> AddrSpace::Load(<span class="keyword">char</span> *fileName) &#123;</div><div class="line">    OpenFile *executable = kernel-&gt;fileSystem-&gt;Open(fileName);</div><div class="line">    NoffHeader noffH;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (executable == <span class="literal">NULL</span>) &#123;</div><div class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="string">"Unable to open file "</span> &lt;&lt; fileName &lt;&lt; <span class="string">"\n"</span>;</div><div class="line">    <span class="keyword">return</span> FALSE;</div><div class="line">    &#125;</div><div class="line">    executable-&gt;ReadAt((<span class="keyword">char</span> *)&amp;noffH, <span class="keyword">sizeof</span>(noffH), <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> ((noffH.noffMagic != NOFFMAGIC) &amp;&amp; </div><div class="line">        (WordToHost(noffH.noffMagic) == NOFFMAGIC))</div><div class="line">    	SwapHeader(&amp;noffH);</div><div class="line">    ASSERT(noffH.noffMagic == NOFFMAGIC);</div><div class="line"></div><div class="line"><span class="comment">// how big is address space?</span></div><div class="line">    size = noffH.code.size + noffH.initData.size + noffH.uninitData.size </div><div class="line">            + UserStackSize;	<span class="comment">// we need to increase the size</span></div><div class="line">                        <span class="comment">// to leave room for the stack</span></div><div class="line">    numPages = divRoundUp(size, PageSize);</div><div class="line"><span class="comment">//	cout &lt;&lt; "number of pages of " &lt;&lt; fileName&lt;&lt; " is "&lt;&lt; numPages &lt;&lt; endl;</span></div><div class="line"><span class="comment">// morris add</span></div><div class="line">    pageTable = <span class="keyword">new</span> TranslationEntry[numPages];</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; numPages; i++) &#123;</div><div class="line">        pageTable[i].virtualPage = i;</div><div class="line">        <span class="keyword">while</span>(j &lt; NumPhysPages &amp;&amp; AddrSpace::usedPhyPage[j] == <span class="literal">true</span>)</div><div class="line">            j++;</div><div class="line">        AddrSpace::usedPhyPage[j] = <span class="literal">true</span>;</div><div class="line">        pageTable[i].physicalPage = j;</div><div class="line">        pageTable[i].valid = <span class="literal">true</span>;</div><div class="line">        pageTable[i].use = <span class="literal">false</span>;</div><div class="line">        pageTable[i].dirty = <span class="literal">false</span>;</div><div class="line">        pageTable[i].readOnly = <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"><span class="comment">// end morris add</span></div><div class="line">    size = numPages * PageSize;</div><div class="line"></div><div class="line">    ASSERT(numPages &lt;= NumPhysPages);		<span class="comment">// check we're not trying</span></div><div class="line">                        <span class="comment">// to run anything too big --</span></div><div class="line">                        <span class="comment">// at least until we have</span></div><div class="line">                        <span class="comment">// virtual memory</span></div><div class="line"></div><div class="line">    DEBUG(dbgAddr, <span class="string">"Initializing address space: "</span> &lt;&lt; numPages &lt;&lt; <span class="string">", "</span> &lt;&lt; size);</div><div class="line"></div><div class="line"><span class="comment">// then, copy in the code and data segments into memory</span></div><div class="line">    <span class="keyword">if</span> (noffH.code.size &gt; <span class="number">0</span>) &#123;</div><div class="line">        DEBUG(dbgAddr, <span class="string">"Initializing code segment."</span>);</div><div class="line">    DEBUG(dbgAddr, noffH.code.virtualAddr &lt;&lt; <span class="string">", "</span> &lt;&lt; noffH.code.size);</div><div class="line"><span class="comment">// morris add</span></div><div class="line">        	executable-&gt;ReadAt(</div><div class="line">        &amp;(kernel-&gt;machine-&gt;mainMemory[pageTable[noffH.code.virtualAddr/PageSize].physicalPage * PageSize + (noffH.code.virtualAddr%PageSize)]), </div><div class="line">            noffH.code.size, noffH.code.inFileAddr);</div><div class="line"><span class="comment">// end morris add</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (noffH.initData.size &gt; <span class="number">0</span>) &#123;</div><div class="line">        DEBUG(dbgAddr, <span class="string">"Initializing data segment."</span>);</div><div class="line">    DEBUG(dbgAddr, noffH.initData.virtualAddr &lt;&lt; <span class="string">", "</span> &lt;&lt; noffH.initData.size);</div><div class="line"><span class="comment">// morris add</span></div><div class="line">        executable-&gt;ReadAt(</div><div class="line">        &amp;(kernel-&gt;machine-&gt;mainMemory[pageTable[noffH.initData.virtualAddr/PageSize].physicalPage * PageSize + (noffH.code.virtualAddr%PageSize)]),</div><div class="line">            noffH.initData.size, noffH.initData.inFileAddr);</div><div class="line"><span class="comment">// end morris add</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">delete</span> executable;			<span class="comment">// close file</span></div><div class="line">    <span class="keyword">return</span> TRUE;			<span class="comment">// success</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h2 id="Sleep-System-call"><a href="#Sleep-System-call" class="headerlink" title="Sleep() System call"></a>Sleep() System call</h2><p>撰寫自己的 Sleep function，將該 Thread 進入休眠。</p>
<h3 id="測試檔案"><a href="#測試檔案" class="headerlink" title="測試檔案"></a>測試檔案</h3><p>與一開始的 <code>test1.c</code> 很像，這裡先做個簡單測試。<br><figure class="highlight cpp"><figcaption><span>/code/test/sleep.c</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"syscall.h"</span></span></div><div class="line">main() &#123;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</div><div class="line">        Sleep(<span class="number">10000000</span>);</div><div class="line">        PrintInt(<span class="number">50</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>因為整個測試檔案是要能在 nachOS 上面跑，所以不能使用一般的編譯方式？所以把這些訊息寫入 <code>Makefile</code> 中，之後下 <code>$ make</code> 產出 <code>sleep</code> 即可。<br><figure class="highlight cpp"><figcaption><span>/code/test/Makefile</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">all: halt shell matmult sort test1 test2 sleep</div><div class="line">...</div><div class="line">sleep: sleep.o start.o</div><div class="line">    &lt;span&gt;$(LD)$&lt;/span&gt;&lt;!-- Has MathJax --&gt;(LDFLAGS) start.o sleep.o -o sleep.coff</div><div class="line">    ../bin/coff2noff sleep.coff sleep</div><div class="line">...</div></pre></td></tr></table></figure></p>
<blockquote>
<p>如果無法在 <code>/code/test</code> 下 <code>$ make</code> 順利產出，則請參照 <strong> 其他指令 </strong>，將原本下載的 <code>mips-decstation.linux-xgcc.gz</code> 解壓縮產生的 <code>/usr</code> 移動到正確位置。</p>
</blockquote>
<h3 id="解決-1"><a href="#解決-1" class="headerlink" title="解決"></a>解決</h3><p>首先，要模仿 <code>PrintInt()</code>，找到切入的宣告位置。努力地尾隨前人。</p>
<figure class="highlight cpp"><figcaption><span>/code/userprog/syscall.h</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SC_PrintInt	11</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SC_Sleep	12</span></div><div class="line">...</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrintInt</span><span class="params">(<span class="keyword">int</span> number)</span></span>;	<span class="comment">//my System Call</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Sleep</span><span class="params">(<span class="keyword">int</span> number)</span></span>;         <span class="comment">// morris add</span></div><div class="line">...</div></pre></td></tr></table></figure>
<p>接著，找一下 ASM。<br>以下部分就不得而知了，為什麼會出現在 <code>/code/test</code> 目錄下。<br><figure class="highlight cpp"><figcaption><span>/code/test/start.s</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">    ...</div><div class="line">PrintInt:</div><div class="line">    addiu   &lt;span&gt;$2,$&lt;/span&gt;&lt;!-- Has MathJax --&gt;0,SC_PrintInt</div><div class="line">    syscall</div><div class="line">    j       $<span class="number">31</span></div><div class="line">    .end    PrintInt</div><div class="line"></div><div class="line">    .globl  Sleep</div><div class="line">    .ent	Sleep</div><div class="line">Sleep:</div><div class="line">    addiu   &lt;span&gt;$2,$&lt;/span&gt;&lt;!-- Has MathJax --&gt;0,SC_Sleep</div><div class="line">    syscall</div><div class="line">    j	$<span class="number">31</span></div><div class="line">    .end	Sleep</div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p>最後，確定 nachOS 會處理我們的例外操作。</p>
<figure class="highlight cpp"><figcaption><span>/code/userprog/exception.cc</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">    ...</div><div class="line"><span class="keyword">case</span> SC_PrintInt:</div><div class="line">    val=kernel-&gt;machine-&gt;ReadRegister(<span class="number">4</span>);</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Print integer:"</span> &lt;&lt; val &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line"><span class="keyword">case</span> SC_Sleep:</div><div class="line">    val=kernel-&gt;machine-&gt;ReadRegister(<span class="number">4</span>);</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Sleep Time "</span> &lt;&lt; val &lt;&lt; <span class="string">"(ms) "</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    kernel-&gt;alarm-&gt;WaitUntil(val);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">    ...</div></pre></td></tr></table></figure>
<blockquote>
<p>到這裡需要喘口氣，剛找了一陣子的代碼。接著才是重頭戲，因為你看到了 <code>kernel-&gt;alarm-&gt;WaitUntil(val);</code> 出現了。沒錯！我們需要撰寫那邊的代碼。</p>
</blockquote>
<p>既然 kernel 存有 <code>alarm</code>，也就是說每隔固定一段間，就會呼叫 <code>Alarm::CallBack()</code>，因此，對於這個鬧鐘來個累加器 <code>Bedroom::_current_interrupt</code>，全局去記數，當作毫秒 (ms) 看待就可以，每加一次就相當於過了 1 毫秒 (ms)。</p>
<p>假設現在某一個 <code>time = _current_interrupt</code> 呼叫 <code>Sleep(x)</code> 後，將 <code>(Thread address, _current_interrupt + x)</code> 丟入 List，則期望在 <code>_current_interrupt + x</code> 的時候甦醒。因此，每當 _current_interrupt++ 就去檢查 List 中，誰的預期時間小於 _current_interrupt，就將其從 List 中清除。</p>
<blockquote>
<p>這裡先不考慮 _current_interrupt Overflow 的問題，根據電腦效率，可能在 5 ~ 10 秒內就發生一次，此時會造成所有 Thread 沉眠很久。若察覺 Sleep 太久，則是發生 Overflow。</p>
</blockquote>
<ul>
<li>當有程序呼叫 <code>Sleep()</code> 時，會呼叫 <code>WaitUntil()</code>，然後將其丟入 <code>Bedroom</code> 安眠。</li>
<li>然後在 <code>CallBlack()</code> 被呼叫時，來去 <code>Bedroom</code> 檢查誰該醒來了。</li>
</ul>
<figure class="highlight cpp"><figcaption><span>/code/threads/alarm.h</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"copyright.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"utility.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"callback.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"timer.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;list&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"thread.h"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bedroom</span> &#123;</span></div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        Bedroom():_current_interrupt(<span class="number">0</span>) &#123;&#125;;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">PutToBed</span><span class="params">(Thread *t, <span class="keyword">int</span> x)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">MorningCall</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">IsEmpty</span><span class="params">()</span></span>;</div><div class="line">    <span class="keyword">private</span>:</div><div class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Bed</span> &#123;</span></div><div class="line">            <span class="keyword">public</span>:</div><div class="line">                Bed(Thread* t, <span class="keyword">int</span> x):</div><div class="line">                    sleeper(t), when(x) &#123;&#125;;</div><div class="line">                Thread* sleeper;</div><div class="line">                <span class="keyword">int</span> when;</div><div class="line">        &#125;;</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> _current_interrupt;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">list</span>&lt;Bed&gt; _beds;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// The following class defines a software alarm clock. </span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Alarm</span> :</span> <span class="keyword">public</span> CallBackObj &#123;</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    Alarm(<span class="keyword">bool</span> doRandomYield);	<span class="comment">// Initialize the timer, and callback </span></div><div class="line">                <span class="comment">// to "toCall" every time slice.</span></div><div class="line">    ~Alarm() &#123; <span class="keyword">delete</span> timer; &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">WaitUntil</span><span class="params">(<span class="keyword">int</span> x)</span></span>;	<span class="comment">// suspend execution until time &gt; now + x</span></div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    Timer *timer;		<span class="comment">// the hardware timer device</span></div><div class="line">    Bedroom _bedroom;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">CallBack</span><span class="params">()</span></span>;		<span class="comment">// called when the hardware</span></div><div class="line">                <span class="comment">// timer generates an interrupt</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>確定有哪些 method 就可以開始實作了。</p>
<figure class="highlight cpp"><figcaption><span>/code/threads/alarm.cc</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> Alarm::CallBack() &#123;</div><div class="line">    Interrupt *interrupt = kernel-&gt;interrupt;</div><div class="line">    MachineStatus status = interrupt-&gt;getStatus();</div><div class="line">    <span class="keyword">bool</span> woken = _bedroom.MorningCall();</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (status == IdleMode &amp;&amp; !woken &amp;&amp; _bedroom.IsEmpty()) &#123;<span class="comment">// is it time to quit?</span></div><div class="line">        <span class="keyword">if</span> (!interrupt-&gt;AnyFutureInterrupts()) &#123;</div><div class="line">        timer-&gt;Disable();	<span class="comment">// turn off the timer</span></div><div class="line">    &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;			<span class="comment">// there's someone to preempt</span></div><div class="line">    interrupt-&gt;YieldOnReturn();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> Alarm::WaitUntil(<span class="keyword">int</span> x) &#123;</div><div class="line">    IntStatus oldLevel = kernel-&gt;interrupt-&gt;SetLevel(IntOff);</div><div class="line">    Thread* t = kernel-&gt;currentThread;</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Alarm::WaitUntil go sleep"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    _bedroom.PutToBed(t, x);</div><div class="line">    kernel-&gt;interrupt-&gt;SetLevel(oldLevel);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">bool</span> Bedroom::IsEmpty() &#123;</div><div class="line">    <span class="keyword">return</span> _beds.size() == <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> Bedroom::PutToBed(Thread*t, <span class="keyword">int</span> x) &#123;</div><div class="line">    ASSERT(kernel-&gt;interrupt-&gt;getLevel() == IntOff);</div><div class="line">    _beds.push_back(Bed(t, _current_interrupt + x));</div><div class="line">    t-&gt;Sleep(<span class="literal">false</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">bool</span> Bedroom::MorningCall() &#123;</div><div class="line">    <span class="keyword">bool</span> woken = <span class="literal">false</span>;</div><div class="line"></div><div class="line">    _current_interrupt ++;</div><div class="line"></div><div class="line">    <span class="keyword">for</span>(<span class="built_in">std</span>::<span class="built_in">list</span>&lt;Bed&gt;::iterator it = _beds.begin(); </div><div class="line">        it != _beds.end(); ) &#123;</div><div class="line">        <span class="keyword">if</span>(_current_interrupt &gt;= it-&gt;when) &#123;</div><div class="line">            woken = <span class="literal">true</span>;</div><div class="line">            <span class="built_in">cout</span> &lt;&lt; <span class="string">"Bedroom::MorningCall Thread woken"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">            kernel-&gt;scheduler-&gt;ReadyToRun(it-&gt;sleeper);</div><div class="line">            it = _beds.erase(it);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            it++;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> woken;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>到這裡我們就完成 <code>Sleep()</code> 製作。</p>
<p>在下一階段，將要加入排程的製作。</p>
<h2 id="Scheduling"><a href="#Scheduling" class="headerlink" title="Scheduling"></a>Scheduling</h2><p>目標完成 SJF, RR, FIFO。<br>請參閱 “向 NachOS 4.0 作業進發 (2)”</p>
<h1 id="其他指令"><a href="#其他指令" class="headerlink" title="其他指令"></a>其他指令</h1><ul>
<li><p>打包轉移 // 交作業前，將檔案包出傳送，此指令不是壓縮用途</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ tar cvf FileName.tar DirName</div></pre></td></tr></table></figure>
</li>
<li><p>複製資料夾 // 將 nachos gcc library 搬移至 <code>/usr/local/nachos ...</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cp -a DirName TARGET_PATH</div></pre></td></tr></table></figure>
</li>
<li><p>轉移至 root 權限 // 如果指令權限不夠，需要下達此指令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ su</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="備忘"><a href="#備忘" class="headerlink" title="備忘"></a>備忘</h1><ul>
<li>網路上有幾個 Java 版本的 NachOS，架構稍微不同，如果發現文章說明有點怪怪的，請看一下他是用 JAVA 版本還是 C++ 版本。</li>
<li>至於怎麼將檔案從 Red Hat，這有點惱人，可以想辦法安裝其他瀏覽器，然後開 e-mail 送出，或者使用 terminal 上的 wget 安裝 … 一堆辦法。最後我自己用 nodejs 寫一個簡單的 upload server 傳出來。</li>
</ul>
<h1 id="代碼下載"><a href="#代碼下載" class="headerlink" title="代碼下載"></a>代碼下載</h1><p><a href="https://github.com/morris821028/hw-nachos-4.0" target="_blank" rel="external">Github</a></p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-oj/uva/uva-134-" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/23/oj/uva/uva-134-/" class="article-date">
  <time datetime="2014-05-23T00:08:43.000Z" itemprop="datePublished">2014-05-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/05/23/oj/uva/uva-134-/">UVa 134 - Loglan-A Logical Language</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2014/05/23/oj/uva/uva-134-/" data-id="cksb6gb2203cdd8vny29xmbiz" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2014/05/23/oj/uva/uva-134-/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LL-1/">LL(1)</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/編譯器/">編譯器</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>Loglan is a synthetic speakable language designed to test some of the fundamental problems of linguistics, such as the Sapir Whorf hypothesis. It is syntactically unambiguous, culturally neutral and metaphysically parsimonious. What follows is a gross over-simplification of an already very small grammar of some 200 rules.</p>
<p>Loglan sentences consist of a series of words and names, separated by spaces, and are terminated by a period (.). Loglan words all end with a vowel; names, which are derived extra-linguistically, end with a consonant. Loglan words are divided into two classes–little words which specify the structure of a sentence, and predicates which have the form CCVCV or CVCCV where C represents a consonant and V represents a vowel (see examples later).</p>
<p>The subset of Loglan that we are considering uses the following grammar:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">A             →  a | e | i | o | u</div><div class="line">MOD           →  ga | ge | gi | go | gu</div><div class="line">BA            →  ba | be | bi | bo | bu</div><div class="line">DA            →  da | de | di | do | du</div><div class="line">LA            →  la | le | li | lo | lu</div><div class="line">NAM           →  &#123;all names&#125;</div><div class="line">PREDA         →  &#123;all predicates&#125;</div><div class="line">&lt;sentence&gt;    →  &lt;statement&gt; | &lt;predclaim&gt;</div><div class="line">&lt;predclaim&gt;   →  &lt;predname&gt; BA &lt;preds&gt; | DA &lt;preds&gt;</div><div class="line">&lt;preds&gt;       →  &lt;predstring&gt; | &lt;preds&gt; A &lt;predstring&gt;</div><div class="line">&lt;predname&gt;    →  LA &lt;predstring&gt; | NAM</div><div class="line">&lt;predstring&gt;  →  PREDA | &lt;predstring&gt; PREDA</div><div class="line">&lt;statement&gt;   →  &lt;predname&gt; &lt;verbpred&gt; &lt;predname&gt; | &lt;predname&gt; &lt;verbpred&gt;</div><div class="line">&lt;verbpred&gt;    →  MOD &lt;predstring&gt;</div></pre></td></tr></table></figure>
<p>Write a program that will read a succession of strings and determine whether or not they are correctly formed Loglan sentences.</p>
<h2 id="Input-and-Output"><a href="#Input-and-Output" class="headerlink" title="Input and Output"></a>Input and Output</h2><p>Each Loglan sentence will start on a new line and will be terminated by a period (.). The sentence may occupy more than one line and words may be separated by more than one whitespace character. The input will be terminated by a line containing a single `#’. You can assume that all words will be correctly formed.</p>
<p>Output will consist of one line for each sentence containing either <code>Good&#39; or</code>Bad!’.</p>
<h2 id="Sample-input"><a href="#Sample-input" class="headerlink" title="Sample input"></a>Sample input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">la mutce bunbo mrenu bi ditca.</div><div class="line">la fumna bi le mrenu.</div><div class="line">djan ga vedma le negro ketpi.</div><div class="line">#</div></pre></td></tr></table></figure>
<h2 id="Sample-output"><a href="#Sample-output" class="headerlink" title="Sample output"></a>Sample output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Good</div><div class="line">Bad!</div><div class="line">Good</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>其實這一題有比較好的解法，但是在正在學編譯器，因此把 LL(1) parser 運用在此題<br>，所以代碼會稍微長一點。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;sentence&gt;    -&gt;  &lt;common_pre&gt;</div><div class="line">&lt;sentence&gt;    -&gt;  DA &lt;preds&gt;</div><div class="line">&lt;common_pre&gt;  -&gt;  &lt;predname&gt; &lt;suffix&gt;</div><div class="line">&lt;suffix&gt;      -&gt;  &lt;predclaim&gt;</div><div class="line">&lt;suffix&gt;      -&gt;  &lt;statement&gt;</div><div class="line">&lt;predclaim&gt;   -&gt;  BA &lt;preds&gt;</div><div class="line">&lt;preds&gt;       -&gt;  &lt;preds_head&gt; &lt;preds_tail&gt;</div><div class="line">&lt;preds_head&gt;  -&gt;  &lt;predstring&gt;</div><div class="line">&lt;preds_tail&gt;  -&gt;  A &lt;predstring&gt; &lt;preds_tail&gt;</div><div class="line">&lt;preds_tail&gt;  -&gt;  l</div><div class="line">&lt;predname&gt;    -&gt;  LA &lt;predstring&gt;</div><div class="line">&lt;predname&gt;    -&gt;  NAM</div><div class="line">&lt;predstring&gt;  -&gt;  PREDA &lt;predstr_tail&gt;</div><div class="line">&lt;predstr_tail&gt; -&gt; PREDA &lt;predstr_tail&gt;</div><div class="line">&lt;predstr_tail&gt; -&gt; l</div><div class="line">&lt;statement&gt;   -&gt;  &lt;verbpred&gt; &lt;statement_s&gt;</div><div class="line">&lt;statement_s&gt; -&gt;  &lt;predname&gt;</div><div class="line">&lt;statement_s&gt; -&gt;  l</div><div class="line">&lt;verbpred&gt;    -&gt;  MOD &lt;predstring&gt;</div></pre></td></tr></table></figure>
<p>為了要符合 LL(1) 的形式，要想辦法將 Grammar 符合規格，也就是每一條 production rule 的 predict set 不會有模稜兩個的情況，也就是說當我看到某個 non-terminal 在 stack 上，在去看下一個 token，然後可以對於 (non-terminal, token) 只找到一條規則去匹配。</p>
<p>predict set 是根據每一條 production rule 所產生的，也就是說這個推論可以產生的第一個 token 是什麼，假使有相同的前綴時，則必須拉出做調整。// 因為這將會造成模稜兩可的情況。</p>
<p>遇到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">A -&gt; BCx</div><div class="line">A -&gt; BCy</div></pre></td></tr></table></figure></p>
<p>應調整成<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">A -&gt; BCW</div><div class="line">W -&gt; x</div><div class="line">W -&gt; y</div></pre></td></tr></table></figure></p>
<p>在 parsing 問題上，應避免替換的無限迴圈。<br>遇到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">A -&gt; AC</div><div class="line">A -&gt; X</div><div class="line">A -&gt; Y</div></pre></td></tr></table></figure></p>
<p>應調整成<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">A -&gt; WD</div><div class="line">D -&gt; CD</div><div class="line">D -&gt; lambda</div><div class="line">W -&gt; X</div><div class="line">W -&gt; Y</div></pre></td></tr></table></figure></p>
<p>發現對照課本的 parsing function 撰寫起來才發現有些不完善的地方，對於 <code>lldriver()</code> 會沒有辦法應對輸入結束，要吐出 lambda 的問題。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sstream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;set&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stack&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Production</span> &#123;</span></div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        <span class="built_in">string</span> 			LHS;</div><div class="line">        <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; 	RHS;</div><div class="line">        <span class="keyword">int</span> 			label;</div><div class="line">        </div><div class="line">        Production(<span class="built_in">string</span> L = <span class="string">""</span>, <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; R = <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt;()) &#123;</div><div class="line">            LHS = L;</div><div class="line">            RHS = R;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%s -&gt; "</span>, LHS.c_str());</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; RHS.size(); i++)</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"%s"</span>, RHS[i].c_str());</div><div class="line">        &#125;</div><div class="line">&#125;;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grammar</span> &#123;</span></div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">string</span> 		lambda;</div><div class="line">        <span class="built_in">string</span> 						start_symbol;</div><div class="line">        <span class="built_in">vector</span>&lt;Production&gt; 			rules;</div><div class="line">        <span class="built_in">map</span>&lt;<span class="built_in">string</span>, <span class="built_in">set</span>&lt;<span class="built_in">string</span>&gt; &gt; 	first_set;</div><div class="line">        <span class="built_in">map</span>&lt;<span class="built_in">string</span>, <span class="built_in">set</span>&lt;<span class="built_in">string</span>&gt; &gt; 	follow_set;</div><div class="line">        <span class="built_in">map</span>&lt;<span class="built_in">string</span>, <span class="keyword">bool</span>&gt; 			derives_lambda;</div><div class="line">        <span class="built_in">map</span>&lt;<span class="built_in">string</span>, <span class="built_in">map</span>&lt;<span class="built_in">string</span>, Production&gt; &gt;	lltable;</div><div class="line">        </div><div class="line">        <span class="built_in">map</span>&lt;<span class="built_in">string</span>, <span class="keyword">bool</span>&gt; mark_lambda();</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">fill_first_set</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">fill_follow_set</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">isNonterminal</span><span class="params">(<span class="built_in">string</span> token)</span></span>;</div><div class="line">        <span class="built_in">set</span>&lt;<span class="built_in">string</span>&gt; compute_first(<span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; rhs);</div><div class="line">        <span class="built_in">set</span>&lt;<span class="built_in">string</span>&gt; get_predict_set(Production p);</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">fill_lltable</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">lldriver</span><span class="params">(<span class="built_in">queue</span>&lt;<span class="built_in">string</span>&gt; tokens)</span></span>;</div><div class="line">&#125;;</div><div class="line"><span class="keyword">const</span> <span class="built_in">string</span> Grammar::lambda(<span class="string">"l"</span>);</div><div class="line"></div><div class="line"><span class="built_in">set</span>&lt;<span class="built_in">string</span>&gt; Grammar::compute_first(<span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; rhs) &#123;</div><div class="line">    <span class="built_in">set</span>&lt;<span class="built_in">string</span>&gt; result;</div><div class="line">    <span class="keyword">size_t</span> i;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span>(rhs.size() == <span class="number">0</span> || rhs[<span class="number">0</span>] == Grammar::lambda) &#123;</div><div class="line">        result.insert(Grammar::lambda);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        result = first_set[rhs[<span class="number">0</span>]];</div><div class="line">        <span class="keyword">for</span>(i = <span class="number">1</span>; i &lt; rhs.size() &amp;&amp; </div><div class="line">            first_set[rhs[i<span class="number">-1</span>]].find(Grammar::lambda) != first_set[rhs[i<span class="number">-1</span>]].end(); i++) &#123;</div><div class="line">            <span class="built_in">set</span>&lt;<span class="built_in">string</span>&gt; f = first_set[rhs[i]];</div><div class="line">            f.erase(Grammar::lambda);</div><div class="line">            result.insert(f.begin(), f.end());	</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(i == rhs.size() </div><div class="line">            &amp;&amp; first_set[rhs[i<span class="number">-1</span>]].find(Grammar::lambda) != first_set[rhs[i<span class="number">-1</span>]].end()) &#123;</div><div class="line">            result.insert(Grammar::lambda);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            result.erase(Grammar::lambda);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125; </div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * please call get_predict_set() after fill_follow_set() and fill_first_set()</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="built_in">set</span>&lt;<span class="built_in">string</span>&gt; Grammar::get_predict_set(Production p) &#123;</div><div class="line">    <span class="built_in">set</span>&lt;<span class="built_in">string</span>&gt; result;</div><div class="line">    <span class="built_in">set</span>&lt;<span class="built_in">string</span>&gt; rfirst;</div><div class="line">    </div><div class="line">    rfirst = compute_first(p.RHS);</div><div class="line">    <span class="keyword">if</span>(rfirst.find(Grammar::lambda) != rfirst.end()) &#123;</div><div class="line">        rfirst.erase(Grammar::lambda);</div><div class="line">        result.insert(rfirst.begin(), rfirst.end());</div><div class="line">        rfirst = follow_set[p.LHS];</div><div class="line">        result.insert(rfirst.begin(), rfirst.end());</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        result.insert(rfirst.begin(), rfirst.end());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">void</span> Grammar::fill_lltable() &#123;</div><div class="line">    <span class="built_in">string</span>		A; <span class="comment">// nonterminal</span></div><div class="line">    Production 	p;</div><div class="line">    </div><div class="line">    <span class="keyword">for</span>(<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; rules.size(); i++) &#123;</div><div class="line">        p = rules[i];</div><div class="line">        A = p.LHS;</div><div class="line">        <span class="built_in">set</span>&lt;<span class="built_in">string</span>&gt; predict_set = get_predict_set(p);</div><div class="line">        </div><div class="line">        <span class="keyword">for</span>(<span class="built_in">set</span>&lt;<span class="built_in">string</span>&gt;::iterator it = predict_set.begin();</div><div class="line">            it != predict_set.end(); it++) &#123;</div><div class="line">            assert(lltable[A].find(*it) == lltable[A].end());</div><div class="line">            lltable[A][*it] = p;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"><span class="keyword">bool</span> Grammar::isNonterminal(<span class="built_in">string</span> token) &#123;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span>(token[<span class="number">0</span>] == <span class="string">'&lt;'</span> &amp;&amp; token[token.length() - <span class="number">1</span>] == <span class="string">'&gt;'</span>)</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="built_in">map</span>&lt;<span class="built_in">string</span>, <span class="keyword">bool</span>&gt; Grammar::mark_lambda() &#123;</div><div class="line">    <span class="keyword">bool</span> 				rhs_derives_lambda;</div><div class="line">    <span class="keyword">bool</span> 				changes;</div><div class="line">    Production 			p;</div><div class="line">    </div><div class="line">    derives_lambda.clear();</div><div class="line">    </div><div class="line">    <span class="comment">/* initially, nothing is marked. */</span></div><div class="line">    <span class="keyword">for</span>(<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; rules.size(); i++) &#123;</div><div class="line">        derives_lambda[rules[i].LHS] = <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        changes = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; rules.size(); i++) &#123;</div><div class="line">            p = rules[i];</div><div class="line">            <span class="keyword">if</span>(!derives_lambda[p.LHS]) &#123;</div><div class="line">                <span class="keyword">if</span>(p.RHS.size() == <span class="number">0</span> || p.RHS[<span class="number">0</span>] == Grammar::lambda) &#123;</div><div class="line">                    changes = derives_lambda[p.LHS] = <span class="literal">true</span>;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">/* does each part of RHS derive lambda ? */</span></div><div class="line">                rhs_derives_lambda = derives_lambda[<span class="built_in">string</span>(p.RHS[<span class="number">0</span>])];</div><div class="line">                <span class="keyword">for</span>(<span class="keyword">size_t</span> j = <span class="number">1</span>; j &lt; p.RHS.size(); j++) &#123;</div><div class="line">                    rhs_derives_lambda &amp;= derives_lambda[p.RHS[j]];</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span>(rhs_derives_lambda) &#123;</div><div class="line">                    changes = <span class="literal">true</span>;</div><div class="line">                    derives_lambda[p.LHS] = <span class="literal">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">while</span>(changes);</div><div class="line">    <span class="keyword">return</span> derives_lambda;</div><div class="line">&#125;</div><div class="line"><span class="keyword">void</span> Grammar::fill_first_set() &#123;</div><div class="line">    </div><div class="line">    <span class="built_in">string</span> 		A; <span class="comment">// nonterminal</span></div><div class="line">    <span class="built_in">string</span> 		a; <span class="comment">// terminal</span></div><div class="line">    Production 	p;</div><div class="line">    <span class="keyword">bool</span> 		changes;</div><div class="line">        </div><div class="line">    mark_lambda();</div><div class="line">    first_set.clear();</div><div class="line">    </div><div class="line">    <span class="keyword">for</span>(<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; rules.size(); i++) &#123;</div><div class="line">        A = rules[i].LHS;</div><div class="line">        <span class="keyword">if</span>(derives_lambda[A])</div><div class="line">            first_set[A].insert(Grammar::lambda);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">for</span>(<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; rules.size(); i++) &#123;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">size_t</span> j = <span class="number">0</span>; j &lt; rules[i].RHS.size(); j++) &#123;</div><div class="line">            a = rules[i].RHS[j];</div><div class="line">            <span class="keyword">if</span>(!isNonterminal(a)) &#123;</div><div class="line">                <span class="keyword">if</span>(a != Grammar::lambda)</div><div class="line">                    first_set[a].insert(a);</div><div class="line">                <span class="keyword">if</span>(j == <span class="number">0</span>) &#123; <span class="comment">// A -&gt; aXX</span></div><div class="line">                    first_set[rules[i].LHS].insert(a);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        changes = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; rules.size(); i++) &#123;</div><div class="line">            p = rules[i];</div><div class="line">            <span class="built_in">set</span>&lt;<span class="built_in">string</span>&gt; rfirst = compute_first(p.RHS);</div><div class="line">            <span class="keyword">size_t</span> oldsize = first_set[p.LHS].size();</div><div class="line">            first_set[p.LHS].insert(rfirst.begin(), rfirst.end());</div><div class="line">            <span class="keyword">size_t</span> newsize = first_set[p.LHS].size();</div><div class="line">            <span class="keyword">if</span>(oldsize != newsize)</div><div class="line">                changes = <span class="literal">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">while</span>(changes);</div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="keyword">void</span> Grammar::fill_follow_set() &#123;</div><div class="line">    <span class="built_in">string</span> 	A, B; <span class="comment">// nonterminal</span></div><div class="line">    Production 	p;</div><div class="line">    <span class="keyword">bool</span> 	changes;</div><div class="line">    </div><div class="line">    <span class="keyword">for</span>(<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; rules.size(); i++) &#123;</div><div class="line">        A = rules[i].LHS;</div><div class="line">        follow_set[A].clear();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    follow_set[start_symbol].insert(Grammar::lambda);</div><div class="line">        </div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        changes = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; rules.size(); i++) &#123;</div><div class="line">            <span class="comment">/* A -&gt; a B b</span></div><div class="line"><span class="comment">			 * I.e. for each production and each occurrence</span></div><div class="line"><span class="comment">			 * of a nonterminal in its right-hand side. </span></div><div class="line"><span class="comment">			 */</span></div><div class="line">            p = rules[i];</div><div class="line">            A = p.LHS;</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">size_t</span> j = <span class="number">0</span>; j &lt; p.RHS.size(); j++) &#123;</div><div class="line">                B = p.RHS[j];</div><div class="line">                <span class="keyword">if</span>(isNonterminal(B)) &#123;</div><div class="line">                    <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; beta(p.RHS.begin() + j + <span class="number">1</span>, p.RHS.end());</div><div class="line">                    <span class="built_in">set</span>&lt;<span class="built_in">string</span>&gt; rfirst = compute_first(beta);</div><div class="line">                    <span class="keyword">size_t</span> oldsize = follow_set[B].size();</div><div class="line">                    </div><div class="line">                    <span class="keyword">if</span>(rfirst.find(Grammar::lambda) == rfirst.end()) &#123;</div><div class="line">                        follow_set[B].insert(rfirst.begin(), rfirst.end());	</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        rfirst.erase(Grammar::lambda);</div><div class="line">                        follow_set[B].insert(rfirst.begin(), rfirst.end());	</div><div class="line">                        rfirst = follow_set[A];</div><div class="line">                        follow_set[B].insert(rfirst.begin(), rfirst.end());</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">size_t</span> newsize = follow_set[B].size();			</div><div class="line">                    <span class="keyword">if</span>(oldsize != newsize)</div><div class="line">                        changes = <span class="literal">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">while</span>(changes);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> Grammar::lldriver(<span class="built_in">queue</span>&lt;<span class="built_in">string</span>&gt; tokens) &#123;</div><div class="line">    <span class="built_in">stack</span>&lt;<span class="built_in">string</span>&gt; 	stk;</div><div class="line">    <span class="built_in">string</span> 			X;</div><div class="line">    <span class="built_in">string</span>			a;</div><div class="line">    Production		p;</div><div class="line">    <span class="comment">/* Push the Start Symbol onto an empty stack */</span></div><div class="line">    stk.push(start_symbol);</div><div class="line">    </div><div class="line">    <span class="keyword">while</span>(!stk.empty() &amp;&amp; !tokens.empty()) &#123;</div><div class="line">        X = stk.top();</div><div class="line">        a = tokens.front();</div><div class="line">        <span class="comment">// cout &lt;&lt; X &lt;&lt; " " &lt;&lt; a &lt;&lt; endl;</span></div><div class="line">        <span class="keyword">if</span>(isNonterminal(X) &amp;&amp; lltable[X].find(a) != lltable[X].end()) &#123;</div><div class="line">            p = lltable[X][a];</div><div class="line">            stk.pop();</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = p.RHS.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">                <span class="keyword">if</span>(p.RHS[i] == Grammar::lambda)</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                stk.push(p.RHS[i]);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(X == a) &#123;</div><div class="line">            stk.pop();</div><div class="line">            tokens.pop();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(lltable[X].find(Grammar::lambda) != lltable[X].end()) &#123;</div><div class="line">            stk.pop();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">/* Process syntax error. */</span></div><div class="line">            <span class="built_in">puts</span>(<span class="string">"Bad!"</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span>(!stk.empty()) &#123;</div><div class="line">        X = stk.top();</div><div class="line">        <span class="keyword">if</span>(lltable[X].find(Grammar::lambda) != lltable[X].end())</div><div class="line">            stk.pop();</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(tokens.size() == <span class="number">0</span> &amp;&amp; stk.size() == <span class="number">0</span>)</div><div class="line">        <span class="built_in">puts</span>(<span class="string">"Good"</span>);</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="built_in">puts</span>(<span class="string">"Bad!"</span>);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">aVowel</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123;</div><div class="line">    <span class="keyword">switch</span>(c) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'a'</span>:<span class="keyword">case</span> <span class="string">'e'</span>:<span class="keyword">case</span> <span class="string">'i'</span>:<span class="keyword">case</span> <span class="string">'o'</span>:<span class="keyword">case</span> <span class="string">'u'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="built_in">string</span> <span class="title">token2symbol</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span> &amp;str)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n = str.length();</div><div class="line">    <span class="keyword">if</span> (!<span class="built_in">islower</span>(str[n - <span class="number">1</span>]) || !aVowel(str[n - <span class="number">1</span>])) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"NAM"</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">switch</span> (n) &#123;</div><div class="line">    	<span class="keyword">case</span> <span class="number">1</span>: <span class="keyword">return</span> <span class="string">"A"</span>;</div><div class="line">    	<span class="keyword">case</span> <span class="number">5</span>:</div><div class="line">        n = aVowel(str[<span class="number">4</span>]);</div><div class="line">        n |= ((aVowel(str[<span class="number">0</span>]) &lt;&lt; <span class="number">4</span>) | (aVowel(str[<span class="number">1</span>]) &lt;&lt; <span class="number">3</span>));</div><div class="line">        n |= ((aVowel(str[<span class="number">2</span>]) &lt;&lt; <span class="number">2</span>) | (aVowel(str[<span class="number">3</span>]) &lt;&lt; <span class="number">1</span>));</div><div class="line">        <span class="keyword">return</span> (n == <span class="number">5</span> || n == <span class="number">9</span>) ? <span class="string">"PREDA"</span> : <span class="string">"UN"</span>;</div><div class="line">    	<span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">        	<span class="keyword">switch</span> (str[<span class="number">0</span>]) &#123;</div><div class="line">        		<span class="keyword">case</span> <span class="string">'g'</span>: <span class="keyword">return</span> <span class="string">"MOD"</span>;</div><div class="line">        		<span class="keyword">case</span> <span class="string">'b'</span>: <span class="keyword">return</span> <span class="string">"BA"</span>;</div><div class="line">        		<span class="keyword">case</span> <span class="string">'d'</span>: <span class="keyword">return</span> <span class="string">"DA"</span>;</div><div class="line">        		<span class="keyword">case</span> <span class="string">'l'</span>: <span class="keyword">return</span> <span class="string">"LA"</span>;</div><div class="line">        	&#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="string">"UN"</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">parsingProduction</span><span class="params">(<span class="built_in">string</span> r, Grammar &amp;g)</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> 		production_label = <span class="number">0</span>;</div><div class="line">    <span class="function"><span class="built_in">stringstream</span> 	<span class="title">sin</span><span class="params">(r)</span></span>;</div><div class="line">    <span class="built_in">string</span> 			lhs, foo;</div><div class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; 	tokens;</div><div class="line">    <span class="built_in">sin</span> &gt;&gt; lhs &gt;&gt; foo;</div><div class="line">    <span class="keyword">while</span>(<span class="built_in">sin</span> &gt;&gt; foo)</div><div class="line">        tokens.push_back(foo);</div><div class="line">    <span class="function">Production <span class="title">p</span><span class="params">(lhs, tokens)</span></span>;</div><div class="line">    p.label = ++production_label;</div><div class="line">    g.rules.push_back(p);</div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    Grammar g;</div><div class="line">    parsingProduction(<span class="string">"&lt;sentence&gt;    -&gt;  &lt;common_pre&gt;"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;sentence&gt;    -&gt;  DA &lt;preds&gt;"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;common_pre&gt;  -&gt;  &lt;predname&gt; &lt;suffix&gt;"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;suffix&gt;      -&gt;  &lt;predclaim&gt;"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;suffix&gt;	  	 -&gt;  &lt;statement&gt;"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;predclaim&gt;   -&gt;  BA &lt;preds&gt;"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;predclaim&gt;   -&gt;  DA &lt;preds&gt;"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;preds&gt;       -&gt;  &lt;preds_head&gt; &lt;preds_tail&gt;"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;preds_head&gt;  -&gt;  &lt;predstring&gt;"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;preds_tail&gt;  -&gt;  A &lt;predstring&gt; &lt;preds_tail&gt;"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;preds_tail&gt;  -&gt;  l"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;predname&gt;    -&gt;  LA &lt;predstring&gt;"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;predname&gt;    -&gt;  NAM"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;predstring&gt;  -&gt;  PREDA &lt;predstr_tail&gt;"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;predstr_tail&gt; -&gt; PREDA &lt;predstr_tail&gt;"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;predstr_tail&gt; -&gt; l"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;statement&gt;   -&gt;  &lt;verbpred&gt; &lt;statement_s&gt;"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;statement_s&gt; -&gt;  &lt;predname&gt;"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;statement_s&gt; -&gt;  l"</span>, g);</div><div class="line">    parsingProduction(<span class="string">"&lt;verbpred&gt;    -&gt;  MOD &lt;predstring&gt;"</span>, g);</div><div class="line">    </div><div class="line">    g.start_symbol = <span class="string">"&lt;sentence&gt;"</span>;</div><div class="line">        </div><div class="line">    g.fill_first_set();</div><div class="line">    g.fill_follow_set();</div><div class="line">    g.fill_lltable();</div><div class="line">    </div><div class="line">    <span class="built_in">queue</span>&lt;<span class="built_in">string</span>&gt; SYMBOL;</div><div class="line">    <span class="keyword">for</span>(<span class="built_in">string</span> token; <span class="built_in">cin</span> &gt;&gt; token &amp;&amp; token != <span class="string">"#"</span>;) &#123;</div><div class="line">        <span class="keyword">size_t</span> pos = token.find(<span class="string">'.'</span>);</div><div class="line">        <span class="keyword">if</span>(pos == <span class="built_in">string</span>::npos) &#123;</div><div class="line">            SYMBOL.push(token2symbol(token));</div><div class="line">            <span class="comment">//cout &lt;&lt; token2symbol(token) &lt;&lt; " ";</span></div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        token.erase(token.length() - <span class="number">1</span>);</div><div class="line">        <span class="comment">//cout &lt;&lt; token2symbol(token) &lt;&lt; endl;</span></div><div class="line">        <span class="keyword">if</span>(token.length() &gt; <span class="number">0</span>)</div><div class="line">            SYMBOL.push(token2symbol(token));</div><div class="line">        g.lldriver(SYMBOL);</div><div class="line">        </div><div class="line">        <span class="keyword">while</span>(!SYMBOL.empty())</div><div class="line">            SYMBOL.pop();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/78/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/77/">77</a><a class="page-number" href="/page/78/">78</a><span class="page-number current">79</span><a class="page-number" href="/page/80/">80</a><a class="page-number" href="/page/81/">81</a><span class="space">&hellip;</span><a class="page-number" href="/page/85/">85</a><a class="extend next" rel="next" href="/page/80/">Next &raquo;</a>
    </nav>
  
</section>
          
          
            <aside id="sidebar">
  <!-- <div id="ukagaka_panel"></div> -->
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/">學校課程</a><span class="category-list-count">115</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/介面設計/">介面設計</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/作業系統/">作業系統</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/即時系統/">即時系統</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/大學專題/">大學專題</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/巨量資料/">巨量資料</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/平行程式/">平行程式</a><span class="category-list-count">43</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/敏捷方法/">敏捷方法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/編譯器/">編譯器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/自然語言/">自然語言</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/虛擬實境/">虛擬實境</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算型智慧/">計算型智慧</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算幾何/">計算幾何</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算機圖學/">計算機圖學</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資料庫系統/">資料庫系統</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資訊安全/">資訊安全</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/通識課程/">通識課程</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/">工作應用</a><span class="category-list-count">35</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Java/">Java</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Meme/">Meme</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/可持久化/">可持久化</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/鬼故事/">鬼故事</a><span class="category-list-count">12</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/手札日記/">手札日記</a><span class="category-list-count">46</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/">網頁設計</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/About-This-Blog/">About This Blog</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/HTML5/">HTML5</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/JQuery/">JQuery</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/Markdown/">Markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/NodeJs/">NodeJs</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/">解題區</a><span class="category-list-count">633</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/Latex/">Latex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/出題解題/">出題解題</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-POJ/">解題區 - POJ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a><span class="category-list-count">483</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a><span class="category-list-count">77</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-未解題目/">解題區 - 未解題目</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/雜言筆記/">雜言筆記</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a class="text" href="/2021/08/14/work/company-ghost-story-12/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 12</a>
          </li>
        
          <li>
            <a class="text" href="/2021/07/29/java/java-jni-tls-error-2/">
              
                <i class="icon-file-o"></i> 
              
            Java JNI GC Thread Error (EINVAL)</a>
          </li>
        
          <li>
            <a class="text" href="/2021/07/29/work/company-ghost-story-11/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 11</a>
          </li>
        
          <li>
            <a class="text" href="/2021/06/21/diary-202106/">
              
                <i class="icon-file-o"></i> 
              
            疫情下的工作變化</a>
          </li>
        
          <li>
            <a class="text" href="/2021/06/21/work/company-ghost-story-10/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 10</a>
          </li>
        
          <li>
            <a class="text" href="/2021/05/30/diary-202105/">
              
                <i class="icon-file-o"></i> 
              
            前思後想 新居落成</a>
          </li>
        
          <li>
            <a class="text" href="/2021/05/30/java/java-memory-optimization-2/">
              
                <i class="icon-file-o"></i> 
              
            Java 優化內存使用 組合篇</a>
          </li>
        
          <li>
            <a class="text" href="/2021/05/30/java/java-memory-optimization-1/">
              
                <i class="icon-file-o"></i> 
              
            Java 優化內存使用 結構篇</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/diary-202101/">
              
                <i class="icon-file-o"></i> 
              
            二八進展</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-globl-var/">
              
                <i class="icon-file-o"></i> 
              
            Global Variable</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">   
      	<ul>
	      <li><a href="http://mypaper.pchome.com.tw/zerojudge" target="_blank" title="Old Blog"><i class="icon-star"></i> Morris' Blog (pchome)</a></li>
	      <li><a href="http://flere114.blogspot.tw/" target="_blank" title="蘿莉勿觸"><i class="icon-googles"></i> flere's Blog</a></li>
	      <li><a href="http://dreamoon4.blogspot.tw/" target="_blank" title="夢月"><i class="icon-googles"></i> dreamoon's Blog</a></li>
	      <li><a href="http://m80126colin.github.io" target="_blank" title="許胖們"><i class="icon-github-alt"></i> m80126colin's Blog</a></li>
	      <li><a href="http://sd12582000.blogspot.tw/" target="_blank" title="妮可妮可"><i class="icon-github-alt"></i> Nico's Blog</a></li>
	      <li><a href="http://kuoe0.logdown.com/" target="_blank" title="郭至軒大神"><i class="icon-github-alt"></i> KuoE0's Dots</a></li>
	      <li><a href="http://tyan.io/" title=""><i class="icon-github-alt"></i> Tyan Blog</a></li>
    	</ul>
    </div>
</div>

  
    
<script src="/js/jquery-ui.js"></script>
<script src="/js/ukagaka/jquery.morris.ukagaka.resource.js"></script>
<script src="/js/ukagaka/typed.js"></script>
  
  
</aside>
          
        
      </div>
      <footer id="footer">
  
  <div class="outer">    
    <div class="social-group">
      
      <a href="https://github.com/morris821028" target="_blank" title="github"><i class="icon-github"></i></a>
      
      
      <a href="https://www.facebook.com/Morris1028" target="_blank" title="facebook"><i class="icon-facebook-sign"></i></a>
      
      
      <a href="http://uhunt.felix-halim.net/id/46705" target="_blank" title="uhunt" ><span class="icon-uhunt">UVa<span></a>
      
    </div>
    <div id="footer-info" class="inner">
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/morris821028/hexo-theme-landscape" target="_blank" title="landscape">landscape</a> &copy; 2021 Shiang-Yun Yang 
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link"><i class=icon-home ></i>&nbsp&nbspHome</a>
  
    <a href="/about" class="mobile-nav-link"><i class=icon-user ></i>&nbsp&nbspAbout</a>
  
    <a href="/archives" class="mobile-nav-link"><i class=icon-archive ></i>&nbsp&nbspArchives</a>
  
    <a href="/tags" class="mobile-nav-link"><i class=icon-tags ></i>&nbsp&nbspTags</a>
  
    <a href="/picture" class="mobile-nav-link"><i class=icon-camera ></i>&nbsp&nbspPictures</a>
  
    <a href="/works" class="mobile-nav-link"><i class=icon-trophy ></i>&nbsp&nbspWorks</a>
  
</nav>
    
<script>
  var disqus_shortname = 'morris1028';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/jquery.lazyload.js"></script>
<script src="/js/jquery.als-1.6.js"></script>

<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>