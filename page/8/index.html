<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Morris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Morris&#39; Blog">
<meta property="og:url" content="http://morris821028.github.io/page/8/index.html">
<meta property="og:site_name" content="Morris&#39; Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Morris&#39; Blog">
<link rel="publisher" href="108158678174364350000">
  
    <link rel="alternative" href="/atom.xml" title="Morris&#39; Blog" type="application/atom+xml">
  
  
    <meta name="google-site-verification" content="5mRgj8NanEMpGZuNfHNJNmH90RgNlrnJXsFlTaKD6Gs" />
  
  
    <link rel="shortcut icon" href="/img/f.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script src="/js/jquery-2.1.0.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.5.1.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdn.oesmith.co.uk/morris-0.5.1.min.js"></script>
  <!-- <link rel="import" href="/bower_components/app-layout/app-layout.html"> --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"><div id="banner-right"></div></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Morris&#39; Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class=icon-home title='Home'></i></a>
          
        
          
            <a class="main-nav-link" href="/about"><i class=icon-user title='About'></i></a>
          
        
          
            <a class="main-nav-link" href="/archives"><i class=icon-archive title='Archives'></i></a>
          
        
          
            <a class="main-nav-link" href="/tags"><i class=icon-tags title='Tags'></i></a>
          
        
          
            <a class="main-nav-link" href="/picture"><i class=icon-camera title='Pictures'></i></a>
          
        
          
            <a class="main-nav-link" href="/works"><i class=icon-trophy title='Works'></i></a>
          
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://morris821028.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        
          
          <section id="main">
  
    <article id="post-2017-facebook-hacker-cup-qualification" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/16/2017-facebook-hacker-cup-qualification/" class="article-date">
  <time datetime="2017-01-16T02:23:56.000Z" itemprop="datePublished">2017-01-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/16/2017-facebook-hacker-cup-qualification/">2017 Facebook Hacker Cup 資格賽</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/01/16/2017-facebook-hacker-cup-qualification/" data-id="ckroajbcc000tpkvn5a7wzi97" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/01/16/2017-facebook-hacker-cup-qualification/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>原本只是想推碩一學弟去寫，學弟邀著邀著，我這個老骨頭只好跟著寫</p>
</blockquote>
<h2 id="Facebook-Hacker-Cup-2017-Qualification-Round"><a href="#Facebook-Hacker-Cup-2017-Qualification-Round" class="headerlink" title="Facebook Hacker Cup 2017 Qualification Round"></a>Facebook Hacker Cup 2017 Qualification Round</h2><h3 id="A-Progress-Pie"><a href="#A-Progress-Pie" class="headerlink" title="A. Progress Pie"></a>A. Progress Pie</h3><p>給一個落在 <span>$(0, 0)\; , (100, 100)$</span><!-- Has MathJax --> 矩形內部的圓餅圖，並且從垂直十二點方向開始，順時針繞一圈 <span>$P \%$</span><!-- Has MathJax --> ，又額外給一座標，請問該點是黑色還是白色，並且保證任何一組詢問點，鄰近 <span>$10^{-6}$</span><!-- Has MathJax --> 都屬於相同顏色。</p>
<p>從最後一個條件來看，我們處理邊界條件的誤差是可以容忍的。由於輸入都是整數，完全在整數上操作的部分尚未想到，但我們可以透過內積外積得到詢問點是順時針轉了 <span>$R, \; 0 \le R &lt; 2 \pi$</span><!-- Has MathJax --> ，只需要判斷 <span>$R$</span><!-- Has MathJax --> 是否小於等於 <span>$P$</span><!-- Has MathJax --> 即可。</p>
<p>十二點鐘的方向向量為 <span>$\vec{v} = (0, 50)$</span><!-- Has MathJax --> ，詢問點與圓心的向量為 <span>$\vec{u} = (X-50, Y-50)$</span><!-- Has MathJax --> ，計算這兩個向量的夾角 <span>$\theta = \cos^{-1}(\frac{u \cdot v}{|u| |v|})$</span><!-- Has MathJax --> ，這樣算出來的角度只會落在 <span>$[0, \pi)$</span><!-- Has MathJax --> ，接著透過外積決定順時針還是逆時針，補回來即可。</p>
<h3 id="B-Lazy-Loading"><a href="#B-Lazy-Loading" class="headerlink" title="B. Lazy Loading"></a>B. Lazy Loading</h3><p>搬家公司的工人要搬運 <span>$N$</span><!-- Has MathJax --> 個重量不同的傢俱，主管要求每次搬運至少 50 磅，工人為了偷懶，每次只搬運一部份的傢俱，然而主管不會準確計算工人搬運的總重，只會問一次搬運的最大重量和個數，工人想藉由分配方法來增加工作天數，請問要怎麼符合需求達到最多搬運天數。</p>
<p>可想而知，我們只需要貪心計算即可，每次挑選最重的那一個，接著搭配當前最輕的來湊數，一超過 50 磅就當作一天的搬運方案，直到沒有物品。一開始排序好 <span>$O(N \log N)$</span><!-- Has MathJax --> ，接著只需要掃描一次 <span>$O(N)$</span><!-- Has MathJax --> 即可完成。</p>
<h3 id="C-Fighting-the-Zombie"><a href="#C-Fighting-the-Zombie" class="headerlink" title="C. Fighting the Zombie"></a>C. Fighting the Zombie</h3><p>在 D&amp;D 遊戲中，我們需要施放技能攻擊血量為 <span>$H$</span><!-- Has MathJax --> 的殭屍，施放採用擲骰子的方式，骰一個 <span>$Y$</span><!-- Has MathJax --> 面骰 <span>$X$</span><!-- Has MathJax --> 次得到的點數總和加上固定值 <span>$Z$</span><!-- Has MathJax --> ，請問一擊必殺的機率最高為何，由於盤面上有許多骰子可以挑選，請輸出機率最高的那個骰子的機率為何。</p>
<p>首先，我們必須先瞭解最基礎的六面骰，投擲 <span>$X$</span><!-- Has MathJax --> 總和的方法數怎麼計算，定義 <span>$\text{dp}[i][j]$</span><!-- Has MathJax --> 表示投擲 <span>$i$</span><!-- Has MathJax --> 次，點數總和為 <span>$j$</span><!-- Has MathJax --> 的方法數。我們得到</p>
<span>$$\begin{align*}
dp[i][j] = \left\{\begin{matrix}
1 &amp;&amp; i = 0\;, j = 0\\
dp[i-1][j-1] + dp[i-1][j-2] + \cdots + dp[i-1][j-6] &amp;&amp; i \le j \\
0 &amp;&amp; \text{otherwise}
\end{matrix}\right.
\end{align*}$$</span><!-- Has MathJax -->
<p>上述的遞迴考慮 <span>$i-1$</span><!-- Has MathJax --> 個骰子的總和方法數，再決定第 <span>$i$</span><!-- Has MathJax --> 個骰子擲出哪一種點數。然而，這種方法不適用此題計算機率，很容易發生 overflow，方法數的總和為 <span>$Y^X$</span><!-- Has MathJax --> ，所以一開始我們就採用機率的方式統計。</p>
<span>$$\begin{align*}
dp[i][j] = \left\{\begin{matrix}
1 &amp;&amp; i = 0\;, j = 0\\
(dp[i-1][j-1] + dp[i-1][j-2] + \cdots + dp[i-1][j-6])/6 &amp;&amp; i \le j \\
0 &amp;&amp; \text{otherwise}
\end{matrix}\right.
\end{align*}$$</span><!-- Has MathJax -->
<p>這樣的 DP 計算消耗時間 <span>$O(X^2 Y^2)$</span><!-- Has MathJax --> ，加上滑動窗口統計總和則可以落在 <span>$O(X^2 Y)$</span><!-- Has MathJax --> 。</p>
<blockquote>
<p>比賽當下寫的，思路不是很清楚，變數命名和邏輯判斷會有點醜，沒有好好整理。</p>
</blockquote>
<h3 id="Solution-A"><a href="#Solution-A" class="headerlink" title="Solution A"></a>Solution A</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">double</span> eps = <span class="number">1e-8</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">double</span> pi = <span class="built_in">acos</span>(<span class="number">-1</span>);</div><div class="line">    <span class="keyword">int</span> testcase, cases = <span class="number">0</span>;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;testcase);</div><div class="line">    <span class="keyword">while</span> (testcase--) &#123;</div><div class="line">        <span class="keyword">int</span> P, X, Y;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;P, &amp;X, &amp;Y);</div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (X == <span class="number">50</span> &amp;&amp; Y == <span class="number">50</span>) &#123;</div><div class="line">            ret = <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hypot(X<span class="number">-50</span>, Y<span class="number">-50</span>) &gt; <span class="number">50</span>) &#123;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (P == <span class="number">100</span>) &#123;</div><div class="line">            ret = <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (P == <span class="number">0</span>) &#123;</div><div class="line">            </div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">int</span> vx = X<span class="number">-50</span>, vy = Y<span class="number">-50</span>;</div><div class="line">            <span class="keyword">int</span> tx = <span class="number">0</span>, ty = <span class="number">50</span>;</div><div class="line">            <span class="keyword">double</span> theta = <span class="built_in">acos</span>((vx*tx+vy*ty)/hypot(vx, vy)/hypot(tx, ty));</div><div class="line">            <span class="keyword">if</span> (tx*vy - ty*vx &gt; <span class="number">0</span>)</div><div class="line">                theta = <span class="number">2</span>*pi-theta;</div><div class="line">            <span class="keyword">double</span> t = (<span class="keyword">double</span>) P/<span class="number">100.0</span>*<span class="number">2</span>*pi;</div><div class="line">            <span class="keyword">if</span> (theta &lt;= t)</div><div class="line">                ret = <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Case #%d: %s\n"</span>, ++cases, ret ? <span class="string">"black"</span> : <span class="string">"white"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Solution-B"><a href="#Solution-B" class="headerlink" title="Solution B"></a>Solution B</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> testcase, cases = <span class="number">0</span>;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;testcase);</div><div class="line">    <span class="keyword">while</span> (testcase--) &#123;</div><div class="line">        <span class="keyword">int</span> n;</div><div class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; A;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            <span class="keyword">int</span> x;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;x);</div><div class="line">            A.push_back(x);</div><div class="line">        &#125;</div><div class="line">        sort(A.begin(), A.end());</div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> r = n<span class="number">-1</span>, l = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> (r &gt;= l) &#123;</div><div class="line">            <span class="keyword">int</span> need = ((<span class="number">50</span> + A[r]<span class="number">-1</span>) / A[r]);</div><div class="line">            <span class="keyword">if</span> (l + need<span class="number">-1</span> &gt; r)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            l += need<span class="number">-1</span>, r--;</div><div class="line">            ret++;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Case #%d: %d\n"</span>, ++cases, ret);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Solution-C"><a href="#Solution-C" class="headerlink" title="Solution C"></a>Solution C</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> testcase, cases = <span class="number">0</span>;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;testcase);</div><div class="line">    <span class="keyword">while</span> (testcase--) &#123;</div><div class="line">        <span class="keyword">int</span> H, S;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;H, &amp;S);</div><div class="line">        <span class="built_in">vector</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt; A;</div><div class="line">        <span class="keyword">double</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; S; i++) &#123;</div><div class="line">            <span class="keyword">char</span> s[<span class="number">128</span>];</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%s"</span>, s);</div><div class="line">            <span class="keyword">int</span> X = <span class="number">0</span>, Y = <span class="number">0</span>, Z = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>, x = <span class="number">0</span>, sign = <span class="number">1</span>, idx = <span class="number">0</span>; s[j]; j++) &#123;</div><div class="line">                <span class="keyword">if</span> (<span class="built_in">isdigit</span>(s[j]))</div><div class="line">                    x = x * <span class="number">10</span> + s[j] - <span class="string">'0'</span>;</div><div class="line">                <span class="keyword">if</span> (s[j+<span class="number">1</span>] == <span class="string">'\0'</span> || !<span class="built_in">isdigit</span>(s[j])) &#123;</div><div class="line">                    x = x * sign;</div><div class="line">                    <span class="keyword">if</span> (idx == <span class="number">0</span>)</div><div class="line">                        X = x;</div><div class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (idx == <span class="number">1</span>)</div><div class="line">                        Y = x;</div><div class="line">                    <span class="keyword">else</span></div><div class="line">                        Z = x;</div><div class="line">                    <span class="keyword">if</span> (s[j] == <span class="string">'-'</span>)</div><div class="line">                        sign = <span class="number">-1</span>;</div><div class="line">                    <span class="keyword">else</span></div><div class="line">                        sign = <span class="number">1</span>;</div><div class="line">                    x = <span class="number">0</span>, idx++;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">int</span> l = X+Z, r = X*Y+Z;</div><div class="line">            <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> OFF = <span class="number">1024</span>;</div><div class="line">            <span class="keyword">static</span> <span class="keyword">double</span> dp[<span class="number">2</span>][OFF];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; OFF; i++)</div><div class="line">                dp[<span class="number">0</span>][i] = dp[<span class="number">1</span>][i] = <span class="number">0</span>;</div><div class="line">            dp[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; X; i++) &#123;</div><div class="line">                <span class="keyword">int</span> p = i&amp;<span class="number">1</span>, q = i&amp;<span class="number">1</span>^<span class="number">1</span>;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; OFF; j++)</div><div class="line">                    dp[q][j] = <span class="number">0</span>;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; OFF; j++) &#123;</div><div class="line">                    <span class="keyword">if</span> (dp[p][j] &lt;= <span class="number">0</span>)	<span class="keyword">continue</span>;</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>; k &lt;= Y; k++)</div><div class="line">                        dp[q][j+k] += dp[p][j]*((<span class="keyword">double</span>) <span class="number">1.f</span>/Y);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">double</span> sum = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= X*Y; j++) &#123;</div><div class="line">                <span class="keyword">if</span> (j+Z &gt;= H)</div><div class="line">                    sum += dp[(X<span class="number">-1</span>)&amp;<span class="number">1</span>^<span class="number">1</span>][j];</div><div class="line">            &#125;</div><div class="line">            ret = max(ret, sum);</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Case #%d: %.6lf\n"</span>,++cases, ret);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-jg-20008" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/18/jg-20008/" class="article-date">
  <time datetime="2016-12-18T03:14:07.000Z" itemprop="datePublished">2016-12-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/18/jg-20008/">淺談多重背包問題 (Multiple Knapsack Problem) 優化那些事</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/12/18/jg-20008/" data-id="ckroajbfo009kpkvnzvi6hyws" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/12/18/jg-20008/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DP/">DP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/monotone-queue/">monotone queue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化/">優化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/單調堆/">單調堆</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/背包問題/">背包問題</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>收錄於 <a href="https://judgegirl.csie.org/problem/0/20008" target="_blank" rel="external">批改娘 20008. Fast Multiple Knapsack Problem</a></p>
<p>之所以出了這一題，源自於實驗室另一名同學跑實驗太久，進而撰寫優化程序。聽說原本跑了十分鐘的實驗，改善後提升了到一分鐘跑完。</p>
</blockquote>
<h2 id="輸入格式"><a href="#輸入格式" class="headerlink" title="輸入格式"></a>輸入格式</h2><p>每組測資第一行包含兩個正整數，分別代表背包大小 $M$ ($\leq 10^6$) 和物品個數 $N$ ($\leq 1000$)，下一行開始每行包含兩個正整數，分別代表物品價值 $P_i$ ($\leq 10^3$)、物品重量 $W_i$ ($ \leq 10^5$) 以及物品最多可以挑 $C_i$ 個 ($\le 100$)。</p>
<h2 id="輸出格式"><a href="#輸出格式" class="headerlink" title="輸出格式"></a>輸出格式</h2><p>對於每組測資，請輸出最大收益。</p>
<h2 id="範例輸入-1"><a href="#範例輸入-1" class="headerlink" title="範例輸入 1"></a>範例輸入 1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">50 7</div><div class="line">66 31 1</div><div class="line">232 10 4</div><div class="line">49 20 1</div><div class="line">54 19 1</div><div class="line">426 4 3</div><div class="line">589 3 10</div><div class="line">10 6 4</div></pre></td></tr></table></figure>
<h2 id="範例輸出-1"><a href="#範例輸出-1" class="headerlink" title="範例輸出 1"></a>範例輸出 1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">7178</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><blockquote>
<p>不管是 0/1 背包或者多重背包，兩者都屬於 bounded knapsack problem 問題。即便如此，優化上仍有些許的不同，請讓我緩緩道來。</p>
</blockquote>
<p>在此之前，您必須先理解上一篇《淺談背包問題 (0/1 Knapsack Problem) 優化那些事》的部分，不然會造成閱讀上的困難。</p>
<p>多重背包有一個二進制優化，也就是當物品限制最多拿 <span>$C$</span><!-- Has MathJax --> 個時，我們可以利用二進制組合的方式，轉換到 0/1 背包問題，因此我們會得到新的 <span>$N \log C$</span><!-- Has MathJax --> 個物品跑一次 0/1 背包，因此複雜度落在 <span>$O(N \log C \; W)$</span><!-- Has MathJax --> </p>
<p>然而，從公式定義上，在好幾年前的論文中，使用斜率優化降到 <span>$O(N \; W)$</span><!-- Has MathJax -->，推倒過程如下，</p>
<span>$j = k \; w_i + r, \; 0 \le r \le w_i - 1$</span><!-- Has MathJax -->
<span>$$\begin{align*}
dp[i][j] &amp;= \max\left\{dp[i-1][j], dp[i-1][j-w_i]+p_i, \cdots, dp[i-1][j-c_i \; w_i] + c_i \; p_i\right\} \\
&Tab;&amp;= \max\left\{dp[i-1][k \; w_i + r], dp[i-1][(k-1) \; w_i + r] + p_i, \cdots
&Tab;&Tab;, dp[i-1][(k-c_i) \; w_i + r] + c_i p_i\right\} \\
&Tab;&amp;= \max\left\{dp[i-1][k \; w_i + r] - k \; p_i, dp[i-1][(k-1) \; w_i + r] + (k-1) \; p_i, \cdots
&Tab;&Tab;, dp[i-1][(k-c_i) \; w_i + r] - (k-c_i) p_i\right\} + k \; p_i\\
\end{align*}$$</span><!-- Has MathJax -->
<p>隨著式子的轉移，我們發現每一個取值將不依賴相對位置，只跟自身的位置有關，那麼可以使用單調堆 (monotone queue) 運行 <span>$O(1)$</span><!-- Has MathJax --> 的 sliding windows 查找極值。最後，將相同餘數分堆處理，單調堆中最多存在 <span>$O(c)$</span><!-- Has MathJax --> 個元素。</p>
<h3 id="優化初夜"><a href="#優化初夜" class="headerlink" title="優化初夜"></a>優化初夜</h3><blockquote>
<p>如果只使用二進制優化，套上我們的 0/1 優化方案，將有大幅度地提升。</p>
</blockquote>
<p>加入 0/1 背包的優化策略，再套上最簡單的斜率優化算法，得到下面的程式。這裡很懶惰地，由於單調堆最多入隊 <span>$W$</span><!-- Has MathJax --> 次，不外乎地直接只用大小為 <span>$W$</span><!-- Has MathJax --> 的方式實作。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> &#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXW = <span class="number">1000005</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1005</span>;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BB</span> &#123;</span></div><div class="line">        <span class="keyword">int</span> w, v, c;</div><div class="line">        BB(<span class="keyword">int</span> w = <span class="number">0</span>, <span class="keyword">int</span> v = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>):</div><div class="line">            w(w), v(v), c(c) &#123;&#125;</div><div class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> BB &amp;x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> w * c  &lt; x.w * x.c;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(BB A[], <span class="keyword">int</span> dp[], <span class="keyword">int</span> W, <span class="keyword">int</span> N)</span> </span>&#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> MQ[MAXW][<span class="number">2</span>];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> w = A[i].w, v = A[i].v, c = A[i].c;</div><div class="line">            sum = min(sum + w*c, W);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; w; j++) &#123;</div><div class="line">                <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="number">0</span>;</div><div class="line">                MQ[l][<span class="number">0</span>] = <span class="number">0</span>, MQ[l][<span class="number">1</span>] = dp[j];</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>; k*w+j &lt;= sum; k++) &#123;</div><div class="line">                    <span class="keyword">if</span> (k - MQ[l][<span class="number">0</span>] &gt; c)	</div><div class="line">                        l++;</div><div class="line">                    <span class="keyword">int</span> dpv = dp[k*w+j] - k*v;</div><div class="line">                    <span class="keyword">while</span> (l &lt;= r &amp;&amp; MQ[r][<span class="number">1</span>] &lt;= dpv)</div><div class="line">                        r--;</div><div class="line">                    r++;</div><div class="line">                    MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</div><div class="line">                    dp[k*w+j] = max(dp[k*w+j], MQ[l][<span class="number">1</span>] + k*v);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;	</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">knapsack</span><span class="params">(<span class="keyword">int</span> C[][<span class="number">3</span>], <span class="keyword">int</span> N, <span class="keyword">int</span> W)</span> </span>&#123;</div><div class="line">        <span class="built_in">vector</span>&lt;BB&gt; A;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> w = C[i][<span class="number">0</span>], v = C[i][<span class="number">1</span>], c = C[i][<span class="number">2</span>];</div><div class="line">            A.push_back(BB(w, v, c));</div><div class="line">        &#125;</div><div class="line">        assert(N &lt; MAXN);</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> dp1[MAXW+<span class="number">1</span>], dp2[MAXW+<span class="number">1</span>];</div><div class="line">        BB Ar[<span class="number">2</span>][MAXN];</div><div class="line">        <span class="keyword">int</span> ArN[<span class="number">2</span>] = &#123;&#125;;</div><div class="line">        <span class="built_in">memset</span>(dp1, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp1[<span class="number">0</span>])*(W+<span class="number">1</span>));</div><div class="line">        <span class="built_in">memset</span>(dp2, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp2[<span class="number">0</span>])*(W+<span class="number">1</span>));</div><div class="line">        sort(A.begin(), A.end());</div><div class="line">        <span class="keyword">int</span> sum[<span class="number">2</span>] = &#123;&#125;;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> ch = sum[<span class="number">1</span>] &lt; sum[<span class="number">0</span>];</div><div class="line">            Ar[ch][ArN[ch]] = A[i];</div><div class="line">            ArN[ch]++;</div><div class="line">            sum[ch] = min(sum[ch] + A[i].w*A[i].c, W);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        run(Ar[<span class="number">0</span>], dp1, W, ArN[<span class="number">0</span>]);</div><div class="line">        run(Ar[<span class="number">1</span>], dp2, W, ArN[<span class="number">1</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = W, mx = <span class="number">0</span>; i &lt;= W; i++, j--) &#123;</div><div class="line">            mx = max(mx, dp2[i]);</div><div class="line">            ret = max(ret, dp1[j] + mx);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> W, N;</div><div class="line">    assert(<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;W, &amp;N) == <span class="number">2</span>);</div><div class="line">    <span class="keyword">int</span> C[MAXN][<span class="number">3</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">        assert(<span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;C[i][<span class="number">1</span>], &amp;C[i][<span class="number">0</span>], &amp;C[i][<span class="number">2</span>]) == <span class="number">3</span>);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, knapsack(C, N, W));</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不幸地，相較於一般的斜率優化寫法，並沒有太大的改善。</p>
<h3 id="優化二夜"><a href="#優化二夜" class="headerlink" title="優化二夜"></a>優化二夜</h3><p>運行 sliding windows 操作時，前 <span>$c$</span><!-- Has MathJax --> 次，是不會進行 <code>pop_front()</code> 操作的，因此把迴圈分兩堆處理，增加 branch predict。以及在乘數運算上，使用強度減少 (strength reduction) 的技術，將乘法換成加法。</p>
<blockquote>
<p>只能些許地改善 5% 的效能。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(BB A[], <span class="keyword">int</span> dp[], <span class="keyword">int</span> W, <span class="keyword">int</span> N)</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> MQ[MAXW][<span class="number">2</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">        <span class="keyword">int</span> w = A[i].w, v = A[i].v, c = A[i].c;</div><div class="line">        sum = min(sum + w*c, W);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; w; j++) &#123;</div><div class="line">            <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="number">0</span>;</div><div class="line">            MQ[l][<span class="number">0</span>] = <span class="number">0</span>, MQ[l][<span class="number">1</span>] = dp[j];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>, tw = w+j, tv = v; tw &lt;= sum &amp;&amp; k &lt;= c; k++, tw += w, tv += v) &#123;</div><div class="line">                <span class="keyword">int</span> dpv = dp[tw] - tv;</div><div class="line">                <span class="keyword">while</span> (l &lt;= r &amp;&amp; MQ[r][<span class="number">1</span>] &lt;= dpv)</div><div class="line">                    r--;</div><div class="line">                r++;</div><div class="line">                MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</div><div class="line">                dp[tw] = max(dp[tw], MQ[l][<span class="number">1</span>] + tv);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = c+<span class="number">1</span>, tw = (c+<span class="number">1</span>)*w+j, tv = (c+<span class="number">1</span>)*v; tw &lt;= sum; k++, tw += w, tv += v) &#123;</div><div class="line">                <span class="keyword">if</span> (k - MQ[l][<span class="number">0</span>] &gt; c)   </div><div class="line">                    l++;</div><div class="line">                <span class="keyword">int</span> dpv = dp[tw] - tv;</div><div class="line">                <span class="keyword">while</span> (l &lt;= r &amp;&amp; MQ[r][<span class="number">1</span>] &lt;= dpv)</div><div class="line">                    r--;</div><div class="line">                r++;</div><div class="line">                MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</div><div class="line">                dp[tw] = max(dp[tw], MQ[l][<span class="number">1</span>] + tv);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="優化三夜"><a href="#優化三夜" class="headerlink" title="優化三夜"></a>優化三夜</h3><p>後來發現，sliding windows 滑動時，我們常常看前看後，因此常常會發生 cache miss，因為他要跳躍一大段記憶體空間查找數值，所以可以考慮花點操作將極值放在 stack 上，視為一種 software cache 來加速，來減少 cache miss 的懲罰。</p>
<p>接著，在迴圈邊界比較時，我們可以算得更精準些，回到一般的 <code>i++</code> 的 format pattern，讓編譯器幫我們做常見的迴圈優化。</p>
<blockquote>
<p>改善了 10% 效能</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(BB A[], <span class="keyword">int</span> dp[], <span class="keyword">int</span> W, <span class="keyword">int</span> N)</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> MQ[MAXW][<span class="number">2</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">        <span class="keyword">int</span> w = A[i].w, v = A[i].v, c = A[i].c;</div><div class="line">        sum = min(sum + w*c, W);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; w; j++) &#123;</div><div class="line">            <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="number">0</span>;</div><div class="line">            MQ[l][<span class="number">0</span>] = <span class="number">0</span>, MQ[l][<span class="number">1</span>] = dp[j];</div><div class="line">            <span class="keyword">int</span> cache_max = MQ[l][<span class="number">1</span>], cache_idx = MQ[l][<span class="number">0</span>];</div><div class="line">            <span class="keyword">int</span> k_bound;</div><div class="line">            k_bound = min((sum-j)/w, c);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>, tw = w+j, tv = v; k &lt;= k_bound; k++, tw += w, tv += v) &#123;</div><div class="line">                <span class="comment">// tw = k*w+j, tv = k*v;</span></div><div class="line">                <span class="keyword">int</span> dpv = dp[tw] - tv;</div><div class="line">                <span class="keyword">while</span> (l &lt;= r &amp;&amp; MQ[r][<span class="number">1</span>] &lt;= dpv)</div><div class="line">                    r--;</div><div class="line">                r++;</div><div class="line">                MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</div><div class="line">                <span class="keyword">if</span> (r == l)    cache_max = dpv, cache_idx = k;</div><div class="line">                dp[tw] = max(dp[tw], cache_max + tv);</div><div class="line">            &#125;</div><div class="line">            k_bound = (sum-j)/w;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = c+<span class="number">1</span>, tw = (c+<span class="number">1</span>)*w+j, tv = (c+<span class="number">1</span>)*v; k &lt;= k_bound; k++, tw += w, tv += v) &#123;</div><div class="line">                <span class="keyword">int</span> dpv = dp[tw] - tv;</div><div class="line">                <span class="keyword">while</span> (l &lt;= r &amp;&amp; MQ[r][<span class="number">1</span>] &lt;= dpv)</div><div class="line">                    r--;</div><div class="line">                r++;</div><div class="line">                MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</div><div class="line">                <span class="keyword">if</span> (r == l)   </div><div class="line">                    cache_max = dpv, cache_idx = k;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (k - cache_idx &gt; c)   </div><div class="line">                    l++, cache_idx = MQ[l][<span class="number">0</span>], cache_max = MQ[l][<span class="number">1</span>];</div><div class="line">                dp[tw] = max(dp[tw], cache_max + tv);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125; </div></pre></td></tr></table></figure>
<h3 id="優化四夜"><a href="#優化四夜" class="headerlink" title="優化四夜"></a>優化四夜</h3><p>儘管上面使用的 software cache 的方式減少 cache miss，但 DP table 仍與數據結構的記憶體位置相當遙遠，為了使他們貼近，應使用環狀隊列的實作，空間從 <span>$O(W)$</span><!-- Has MathJax --> 將到 <span>$O(N)$</span><!-- Has MathJax -->，實作時，將大小限制在 <span>$2^k$</span><!-- Has MathJax -->，方便運行時使用 AND 運算取代耗時的模數運算。</p>
<p>由於限制個數分佈上，很容易造成貪心算法有解，因此先跑一次貪心，如果貪心沒辦法達到剛好大小，那麼再跑 DP 找解。DP 找解時，可以將物品嘗試進行二進制轉換，將等價物品合併，來觸發計算邊界的優化。完成的程序如下：</p>
<blockquote>
<p>最終加速，改善 10%，期待你我的分享增進。根據鴿籠原理，cp 直種類不多時，可以高達 10 倍以上的加速。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> &#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXW = <span class="number">1000005</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1005</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXC = <span class="number">1</span>&lt;&lt;<span class="number">12</span>;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BB</span> &#123;</span></div><div class="line">        <span class="keyword">int</span> w, v, c;</div><div class="line">        BB(<span class="keyword">int</span> w = <span class="number">0</span>, <span class="keyword">int</span> v = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>):</div><div class="line">            w(w), v(v), c(c) &#123;&#125;</div><div class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> BB &amp;x) <span class="keyword">const</span> &#123;</div><div class="line">            <span class="keyword">return</span> w * c  &lt; x.w * x.c;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">cmpByWeight</span><span class="params">(BB x, BB y)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> x.w &lt; y.w;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(BB A[], <span class="keyword">int</span> dp[], <span class="keyword">int</span> W, <span class="keyword">int</span> N)</span> </span>&#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> MQ[MAXC][<span class="number">2</span>];</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> w = A[i].w, v = A[i].v, c = A[i].c;</div><div class="line">            assert(c &lt; MAXC);</div><div class="line">            sum = min(sum + w*c, W);</div><div class="line">            <span class="keyword">if</span> (c != <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; w; j++) &#123;</div><div class="line">                    <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="number">0</span>;</div><div class="line">                    MQ[r][<span class="number">0</span>] = <span class="number">0</span>, MQ[r][<span class="number">1</span>] = dp[j];</div><div class="line">                    <span class="keyword">int</span> cache_max = MQ[r][<span class="number">1</span>], cache_idx = MQ[r][<span class="number">0</span>];</div><div class="line">                    <span class="keyword">int</span> k_bound;</div><div class="line">                    r = (r+<span class="number">1</span>)&amp;(MAXC<span class="number">-1</span>);</div><div class="line">                    k_bound = min((sum-j)/w, c);</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>, tw = w+j, tv = v; k &lt;= k_bound; k++, tw += w, tv += v) &#123;</div><div class="line">                        <span class="comment">// tw = k*w+j, tv = k*v;</span></div><div class="line">                        <span class="keyword">int</span> dpv = dp[tw] - tv;</div><div class="line">                        <span class="keyword">while</span> (l != r &amp;&amp; MQ[(r<span class="number">-1</span>+MAXC)&amp;(MAXC<span class="number">-1</span>)][<span class="number">1</span>] &lt;= dpv)</div><div class="line">                            r = (r<span class="number">-1</span>+MAXC)&amp;(MAXC<span class="number">-1</span>);</div><div class="line">                        MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</div><div class="line">                        <span class="keyword">if</span> (l == r)	cache_max = dpv, cache_idx = k;</div><div class="line">                        r = (r+<span class="number">1</span>)&amp;(MAXC<span class="number">-1</span>);</div><div class="line">                        dp[tw] = max(dp[tw], cache_max + tv);</div><div class="line">                    &#125;</div><div class="line">                    k_bound = (sum-j)/w;</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> k = c+<span class="number">1</span>, tw = (c+<span class="number">1</span>)*w+j, tv = (c+<span class="number">1</span>)*v; k &lt;= k_bound; k++, tw += w, tv += v) &#123;</div><div class="line">                        <span class="keyword">int</span> dpv = dp[tw] - tv;</div><div class="line">                        <span class="keyword">while</span> (l != r &amp;&amp; MQ[(r<span class="number">-1</span>+MAXC)&amp;(MAXC<span class="number">-1</span>)][<span class="number">1</span>] &lt;= dpv)</div><div class="line">                            r--;</div><div class="line">                        MQ[r][<span class="number">0</span>] = k, MQ[r][<span class="number">1</span>] = dpv;</div><div class="line">                        <span class="keyword">if</span> (l == r)	cache_max = dpv, cache_idx = k;</div><div class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (k - cache_idx &gt; c)	</div><div class="line">                            l = (l+<span class="number">1</span>)&amp;(MAXC<span class="number">-1</span>), cache_idx = MQ[l][<span class="number">0</span>], cache_max = MQ[l][<span class="number">1</span>];</div><div class="line">                        r = (r+<span class="number">1</span>)&amp;(MAXC<span class="number">-1</span>);</div><div class="line">                        dp[tw] = max(dp[tw], cache_max + tv);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = sum; j &gt;= w; j--)</div><div class="line">                    dp[j] = max(dp[j], dp[j-w]+v);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;	</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">greedy</span><span class="params">(<span class="keyword">int</span> C[][<span class="number">3</span>], <span class="keyword">int</span> N, <span class="keyword">int</span> W)</span> </span>&#123;</div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">GB</span> &#123;</span></div><div class="line">            <span class="keyword">int</span> w, v, c;</div><div class="line">            GB(<span class="keyword">int</span> w = <span class="number">0</span>, <span class="keyword">int</span> v = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>):</div><div class="line">                w(w), v(v), c(c) &#123;&#125;</div><div class="line">            <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> GB &amp;x) <span class="keyword">const</span> &#123;</div><div class="line">                <span class="keyword">if</span> (v * x.w != x.v * w)</div><div class="line">                    <span class="keyword">return</span> v * x.w &gt; x.v * w;</div><div class="line">                <span class="keyword">return</span> c &gt; x.c;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="built_in">vector</span>&lt;GB&gt; A;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> w = C[i][<span class="number">0</span>], v = C[i][<span class="number">1</span>], c = C[i][<span class="number">2</span>];</div><div class="line">            A.push_back(GB(w, v, c));</div><div class="line">        &#125;</div><div class="line">        sort(A.begin(), A.end());</div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> t = min(A[i].c, W/A[i].w);</div><div class="line">            <span class="keyword">if</span> (t == <span class="number">0</span>)</div><div class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">            W -= t*A[i].w;</div><div class="line">            ret += t*A[i].v;</div><div class="line">            <span class="keyword">if</span> (W == <span class="number">0</span>)</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">knapsack</span><span class="params">(<span class="keyword">int</span> C[][<span class="number">3</span>], <span class="keyword">int</span> N, <span class="keyword">int</span> W)</span> </span>&#123;</div><div class="line">        <span class="comment">// filter</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">int</span> filter = greedy(C, N, W);</div><div class="line">            <span class="keyword">if</span> (filter != <span class="number">-1</span>)</div><div class="line">                <span class="keyword">return</span> filter;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">vector</span>&lt;BB&gt; A;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> w = C[i][<span class="number">0</span>], v = C[i][<span class="number">1</span>], c = C[i][<span class="number">2</span>];</div><div class="line">            A.push_back(BB(w, v, c));</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// reduce</span></div><div class="line">        &#123;</div><div class="line">            sort(A.begin(), A.end(), cmpByWeight);</div><div class="line">            <span class="built_in">map</span>&lt;pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;, <span class="keyword">int</span>&gt; R;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">                R[make_pair(A[i].w, A[i].v)] = i;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">                <span class="keyword">int</span> c = A[i].c;</div><div class="line">                <span class="built_in">map</span>&lt;pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;, <span class="keyword">int</span>&gt;::iterator it;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>; k &lt;= c; k &lt;&lt;= <span class="number">1</span>) &#123;</div><div class="line">                    <span class="keyword">int</span> w = A[i].w * k, v = A[i].v * k;</div><div class="line">                    it = R.find(make_pair(w, v));</div><div class="line">                    <span class="keyword">if</span> (it != R.end() &amp;&amp; i != it-&gt;second) &#123;</div><div class="line">                        <span class="keyword">int</span> j = it-&gt;second;</div><div class="line">                        A[j].c ++;</div><div class="line">                        A[i].c -= k;</div><div class="line">                    &#125;</div><div class="line">                    c -= k;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (c &gt; <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">int</span> w = A[i].w * c, v = A[i].v * c;</div><div class="line">                    it = R.find(make_pair(w, v));</div><div class="line">                    <span class="keyword">if</span> (it != R.end() &amp;&amp; i != it-&gt;second) &#123;</div><div class="line">                        <span class="keyword">int</span> j = it-&gt;second;</div><div class="line">                        A[j].c ++;</div><div class="line">                        A[i].c -= c;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> dp1[MAXW+<span class="number">1</span>], dp2[MAXW+<span class="number">1</span>];</div><div class="line">        BB Ar[<span class="number">2</span>][MAXN];</div><div class="line">        <span class="keyword">int</span> ArN[<span class="number">2</span>] = &#123;&#125;;</div><div class="line">        <span class="built_in">memset</span>(dp1, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp1[<span class="number">0</span>])*(W+<span class="number">1</span>));</div><div class="line">        <span class="built_in">memset</span>(dp2, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp2[<span class="number">0</span>])*(W+<span class="number">1</span>));</div><div class="line">        sort(A.begin(), A.end());</div><div class="line">        <span class="keyword">int</span> sum[<span class="number">2</span>] = &#123;&#125;;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> ch = sum[<span class="number">1</span>] &lt; sum[<span class="number">0</span>];</div><div class="line">            Ar[ch][ArN[ch]] = A[i];</div><div class="line">            ArN[ch]++;</div><div class="line">            sum[ch] = min(sum[ch] + A[i].w*A[i].c, W);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        run(Ar[<span class="number">0</span>], dp1, W, ArN[<span class="number">0</span>]);</div><div class="line">        run(Ar[<span class="number">1</span>], dp2, W, ArN[<span class="number">1</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = W, mx = <span class="number">0</span>; i &lt;= W; i++, j--) &#123;</div><div class="line">            mx = max(mx, dp2[i]);</div><div class="line">            ret = max(ret, dp1[j] + mx);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> W, N;</div><div class="line">    assert(<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;W, &amp;N) == <span class="number">2</span>);</div><div class="line">    <span class="keyword">int</span> C[MAXN][<span class="number">3</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">        assert(<span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;C[i][<span class="number">1</span>], &amp;C[i][<span class="number">0</span>], &amp;C[i][<span class="number">2</span>]) == <span class="number">3</span>);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, knapsack(C, N, W));</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-jg-20005" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/18/jg-20005/" class="article-date">
  <time datetime="2016-12-18T01:13:40.000Z" itemprop="datePublished">2016-12-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/18/jg-20005/">淺談背包問題 (0/1 Knapsack Problem) 優化那些事</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/12/18/jg-20005/" data-id="ckroajbfh0096pkvn1fznmtjo" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/12/18/jg-20005/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DP/">DP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化/">優化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/背包問題/">背包問題</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>收錄於 <a href="https://judgegirl.csie.org/problem/0/20005" target="_blank" rel="external">批改娘 20005. 0/1 Knapsack Problem</a>。之所以有機會談到這個問題，其原因於早期的背包問題，大多都是用 branch-and-bound 算法來完成，也因此學弟課程出了這一份作業，大部分的測資，使用 branch-and-bound 能跑得比一般記憶體化 DP 快上非常多。當然，作為一個 Morris(?) 怎能允許這樣的事情發生。</p>
<p>現在回顧一下背包問題的模型吧！</p>
</blockquote>
<h2 id="輸入格式"><a href="#輸入格式" class="headerlink" title="輸入格式"></a>輸入格式</h2><p>每組測資第一行包含兩個正整數，分別代表背包大小 $M$ ($\leq 5×10^6$) 和物品個數 $N$ ($\leq 1000$)，下一行開始每行包含兩個正整數，分別代表物品價值 $P_i$ ($\leq 10^5$)和物品重量 $W_i$ ($ \leq 10^5$)。</p>
<h2 id="輸出格式"><a href="#輸出格式" class="headerlink" title="輸出格式"></a>輸出格式</h2><p>對於每組測資，請輸出最大收益。</p>
<h2 id="範例輸入-1"><a href="#範例輸入-1" class="headerlink" title="範例輸入 1"></a>範例輸入 1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">50 7</div><div class="line">70 31</div><div class="line">20 10</div><div class="line">39 20</div><div class="line">37 19</div><div class="line">7 4</div><div class="line">5 3</div><div class="line">10 6</div></pre></td></tr></table></figure>
<h2 id="範例輸出-1"><a href="#範例輸出-1" class="headerlink" title="範例輸出 1"></a>範例輸出 1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">107</div></pre></td></tr></table></figure>
<h2 id="範例輸入-2"><a href="#範例輸入-2" class="headerlink" title="範例輸入 2"></a>範例輸入 2</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">170 7</div><div class="line">442 41</div><div class="line">525 50</div><div class="line">511 49</div><div class="line">593 59</div><div class="line">546 55</div><div class="line">564 57</div><div class="line">617 60</div></pre></td></tr></table></figure>
<h2 id="範例輸出-2"><a href="#範例輸出-2" class="headerlink" title="範例輸出 2"></a>範例輸出 2</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1735</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><h3 id="Branch-and-bound"><a href="#Branch-and-bound" class="headerlink" title="Branch-and-bound"></a>Branch-and-bound</h3><blockquote>
<p><a href="http://www.or.deis.unibo.it/kp/Chapter3.pdf" target="_blank" rel="external">bound knapscak problem</a> 古耕竹同學提供</p>
</blockquote>
<p>如果物品可以被切割，那麼可以利用物品的 CP 值 (<span>$\textit{cp}_i = p_i/w_i$</span><!-- Has MathJax -->)排序，使用貪心算法在 <span>$O(N \log N)$</span><!-- Has MathJax --> 找到最佳解。然而，背包問題在於物品只能挑或不挑，一旦無法切割物品，那麼貪心算法無法將剩餘的部分填滿，進而可能產生更好的一組解填滿剩餘部分。</p>
<blockquote>
<p>想要更快嗎？多看論文且實作它吧！</p>
</blockquote>
<p>branch-and-bound 基本核心操作為</p>
<ul>
<li>按照 CP 值由大到小排序</li>
<li>貪心法最佳解 <span>$\textit{bound}$</span><!-- Has MathJax --></li>
<li>進行深度優先搜索，優先挑 CP 值大的入選<ul>
<li>當前挑選方案最佳解 <span>$g$</span><!-- Has MathJax --> + 剩餘物品使用貪心法最佳解 <span>$g$</span><!-- Has MathJax --> 小於等於當前最佳解 <span>$\textit{bound}$</span><!-- Has MathJax -->，則退出搜索。</li>
<li>更新 <span>$\textit{bound} = \max(\textit{bound}, g)$</span><!-- Has MathJax --></li>
<li>選擇加入 或 不加入 (註：學弟說我的某些測資，通通優先不選可以快個數十倍)</li>
</ul>
</li>
</ul>
<p>參考代碼</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Item</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> v, w;</div><div class="line">    <span class="function"><span class="keyword">double</span> <span class="title">cp</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">double</span>) v / w;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">cmpCP</span><span class="params">(Item a, Item b)</span> </span>&#123;</div><div class="line">    <span class="keyword">double</span> cpA = a.cp();</div><div class="line">    <span class="keyword">double</span> cpB = b.cp();</div><div class="line">    <span class="keyword">if</span> (cpA == cpB)</div><div class="line">        <span class="keyword">return</span> a.w &gt; b.w;</div><div class="line">    <span class="keyword">return</span> cpA &gt; cpB;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> n, m;</div><div class="line"><span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">Item items[<span class="number">1005</span>];</div><div class="line"><span class="keyword">int</span> prefixW[<span class="number">1005</span>];</div><div class="line"><span class="keyword">int</span> prefixV[<span class="number">1005</span>];</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">h</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> w, <span class="keyword">int</span> b, <span class="keyword">int</span> &amp;j, <span class="keyword">int</span> &amp;f)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> fw = i == <span class="number">0</span> ? w : (w + prefixW[i<span class="number">-1</span>]);</div><div class="line">    <span class="keyword">for</span> (j = max(b, i); j &lt; n &amp;&amp; prefixW[j] &lt;= fw; j++);</div><div class="line">    <span class="keyword">if</span> (j &gt;= n) &#123;</div><div class="line">        <span class="keyword">return</span> prefixV[n<span class="number">-1</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> v = <span class="number">0</span>;</div><div class="line">    f = <span class="number">0</span>;</div><div class="line">    v += prefixV[j<span class="number">-1</span>] - (i == <span class="number">0</span> ? <span class="number">0</span> : prefixV[i<span class="number">-1</span>]);</div><div class="line">    w -= prefixW[j<span class="number">-1</span>] - (i == <span class="number">0</span> ? <span class="number">0</span> : prefixW[i<span class="number">-1</span>]);</div><div class="line">    <span class="keyword">if</span> (w != <span class="number">0</span>) &#123;</div><div class="line">        f = <span class="number">1</span>;</div><div class="line">        <span class="keyword">float</span> k = (<span class="keyword">float</span>) w / items[j].w;</div><div class="line">        w -= k * items[j].w;</div><div class="line">        v += k * items[j].v;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> v;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">greedy</span><span class="params">(<span class="keyword">int</span> w)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> v = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)  &#123;</div><div class="line">        <span class="keyword">if</span> (w &gt;= items[i].w)&#123;</div><div class="line">            w -= items[i].w;</div><div class="line">            v += items[i].v;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> v;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> v;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> w, <span class="keyword">int</span> v, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (i &gt;= n) &#123;</div><div class="line">        ret = max(ret, v);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> j = n, f;</div><div class="line">    <span class="keyword">int</span> hv = v + h(i, w, b, j, f);</div><div class="line">    <span class="keyword">if</span> (hv &lt;= ret)</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">if</span> (f == <span class="number">0</span>) &#123;</div><div class="line">        ret = max(ret, hv);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (w &gt;= items[i].w)</div><div class="line">        dfs(i + <span class="number">1</span>, w - items[i].w, v + items[i].v, j);</div><div class="line">    dfs(i + <span class="number">1</span>, w, v, j);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;m, &amp;n) == <span class="number">2</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;items[i].v, &amp;items[i].w);</div><div class="line">        stable_sort(items, items+n, cmpCP);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, w = <span class="number">0</span>, v = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            w += items[i].w;</div><div class="line">            v += items[i].v;</div><div class="line">            prefixW[i] = w;</div><div class="line">            prefixV[i] = v;</div><div class="line">        &#125;</div><div class="line">        ret = greedy(m);</div><div class="line">        dfs(<span class="number">0</span>, m, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, ret);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h4><p>branch-and-bound 空間複雜度只跟 <span>$N$</span><!-- Has MathJax --> 有關，使用記憶體空間小，相較於記憶化搜索有較少的 cache miss，速度取決於搜索順序。對於同一 CP 的等價處理薄弱，一遇到這種情況，搜尋時間瞬間指數次方上去，可以等個昏天暗地。</p>
<h3 id="Dynamic-Programming"><a href="#Dynamic-Programming" class="headerlink" title="Dynamic Programming"></a>Dynamic Programming</h3><h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><blockquote>
<p>請不要忘記背包問題屬於 NP-Complete，我們能做的事情只能優化計算，最慘的情況仍要面對，優化常數是可以努力的方向，讓我們嘗試變得更快吧。</p>
</blockquote>
<p>基礎寫法解說請參考 <a href="http://www.csie.ntnu.edu.tw/~u91029/KnapsackProblem.html#4" target="_blank" rel="external">DJWS - Bounded Knapsack Problem</a> 的說明。</p>
<p>從定義上，我們通常會宣告 <code>dp[i][j]</code> 表示放入前 <span>$i$</span><!-- Has MathJax --> 個物品時，總共最多為 <span>$j$</span><!-- Has MathJax --> 的最大價值為何。這樣空間宣告使用 <span>$\mathcal{O}(NW)$</span><!-- Has MathJax -->。在實作上，我們可以藉由運算順序將空間降為 <span>$\mathcal{O}(W)$</span><!-- Has MathJax -->。因此，寫出以下代碼並不難</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> dp[MAXW];</div><div class="line"><span class="built_in">memset</span>(dp, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp));</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = W; j &gt;= w[i]; j--)</div><div class="line">        dp[j] = max(dp[j], dp[j-w[i]]+v[i]);</div></pre></td></tr></table></figure>
<h4 id="優化初夜"><a href="#優化初夜" class="headerlink" title="優化初夜"></a>優化初夜</h4><p>從實際運行上，我們可以發現每次跑 <span>$\mathcal{\theta}(W)$</span><!-- Has MathJax --> 非常浪費，只需要跑 <span>$\min(W, \sum w_i)$</span><!-- Has MathJax --> 即可。因此，第一份計算量優化如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> dp[MAXW];</div><div class="line"><span class="built_in">memset</span>(dp, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp));</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">    sum += w[i];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = min(W, sum); j &gt;= w[i]; j--)</div><div class="line">        dp[j] = max(dp[j], dp[j-w[i]]+v[i]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>計算邊界優化通常可以達到 2x 加速</p>
</blockquote>
<p>如此一來，在數量多權重小時，剛啟動的效能時可以賺到非常多。然而，不乏第一次就給權重的大的，目標最小化 <span>$\sum \text{sum}_i$</span><!-- Has MathJax -->，從數學觀念很明顯地瞭解，只要一開始將權重 <span>$w_i$</span><!-- Has MathJax --> 由小到大排序即可，這樣能保證最小化計算量！</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> dp[MAXW];</div><div class="line"><span class="built_in">memset</span>(dp, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp));</div><div class="line">sort (w, v) by w</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">    sum += w[i];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = min(W, sum); j &gt;= w[i]; j--)</div><div class="line">        dp[j] = max(dp[j], dp[j-w[i]]+v[i]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>數學使得我們更進一步，達到 1.5x 加速</p>
</blockquote>
<h4 id="優化二夜"><a href="#優化二夜" class="headerlink" title="優化二夜"></a>優化二夜</h4><p>經由平行的訓練，也許我們可以更往上一層優化。</p>
<p>接下來，打算把物品拆成兩堆，再利用優化初夜學到的技巧，就能引爆更多計算邊界優化。如果拆成三堆以上，合併操作變得相當複雜，當只有兩堆時，保證合併效能一定在 <span>$\mathcal{\theta}(W)$</span><!-- Has MathJax --> 完成。</p>
<p>如何合併兩堆的計算結果，假設 <code>dp1[i]</code> 表示其中一堆重量小於等於 <span>$i$</span><!-- Has MathJax --> 的最佳解，同理 <code>dp2[j]</code> 的計算結果。</p>
<p>當要湊出重量為 <span>$W$</span><!-- Has MathJax --> 的最佳解時，窮舉其中一堆的重量 <span>$i$</span><!-- Has MathJax --> 維護其中一堆的前綴最大值 <span>$j$</span><!-- Has MathJax -->，相當於使用掃描線算法在線性時間內合併。合併操作如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = W, mx = <span class="number">0</span>; i &lt;= W; i++, j--) &#123;</div><div class="line">    mx = max(mx, dp2[i]);</div><div class="line">    ret = max(ret, dp1[j] + mx);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Divide-and-Conquer，使得我們更快再更快！達到 1.5 加速</p>
</blockquote>
<p>然而，優化問題將轉移到最佳分堆策略，好的分堆策略將使得計算量下降更多。目標分兩堆，使得 <span>$\sum \text{sum1}_i + \sum \text{sum2}_i$</span><!-- Has MathJax --> 最小化。明顯地，由小到大排序物品重量，依序將物品放到總和最小的那一堆即可。最後，我們整合每一夜的結果如下：</p>
<blockquote>
<p>一個好的分堆，達到 1.2x 加速</p>
<p>相信在不久之後，還有更好的優化策略，也許不是延伸，而是全新的面貌。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> &#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXW = <span class="number">5000005</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1005</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">int</span> A[][<span class="number">2</span>], <span class="keyword">int</span> dp[], <span class="keyword">int</span> W, <span class="keyword">int</span> N)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, sum = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> w = A[i][<span class="number">0</span>], v = A[i][<span class="number">1</span>];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = min(W, sum + w); j &gt;= w; j--)</div><div class="line">                dp[j] = max(dp[j], dp[j-w]+v);</div><div class="line">            sum += w;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">knapsack</span><span class="params">(<span class="keyword">int</span> C[][<span class="number">2</span>], <span class="keyword">int</span> N, <span class="keyword">int</span> W)</span> </span>&#123;</div><div class="line">        <span class="built_in">vector</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt; A;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">            A.push_back(make_pair(C[i][<span class="number">0</span>], C[i][<span class="number">1</span>]));</div><div class="line">        N = A.size();</div><div class="line">        assert(N &lt; MAXN);</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> dp1[MAXW+<span class="number">1</span>], dp2[MAXW+<span class="number">1</span>];</div><div class="line">        <span class="keyword">int</span> Ar[<span class="number">2</span>][MAXN][<span class="number">2</span>], ArN[<span class="number">2</span>] = &#123;&#125;;</div><div class="line">        <span class="built_in">memset</span>(dp1, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp1[<span class="number">0</span>])*(W+<span class="number">1</span>));</div><div class="line">        <span class="built_in">memset</span>(dp2, <span class="number">0</span>, <span class="keyword">sizeof</span>(dp2[<span class="number">0</span>])*(W+<span class="number">1</span>));</div><div class="line">        sort(A.begin(), A.end());</div><div class="line">        <span class="keyword">int</span> sum[<span class="number">2</span>] = &#123;&#125;;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">int</span> ch = sum[<span class="number">1</span>] &lt; sum[<span class="number">0</span>];</div><div class="line">            Ar[ch][ArN[ch]][<span class="number">0</span>] = A[i].first;</div><div class="line">            Ar[ch][ArN[ch]][<span class="number">1</span>] = A[i].second;</div><div class="line">            ArN[ch]++;</div><div class="line">            sum[ch] += A[i].first;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        run(Ar[<span class="number">0</span>], dp1, W, ArN[<span class="number">0</span>]);</div><div class="line">        run(Ar[<span class="number">1</span>], dp2, W, ArN[<span class="number">1</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = W, mx = <span class="number">0</span>; i &lt;= W; i++, j--) &#123;</div><div class="line">            mx = max(mx, dp2[i]);</div><div class="line">            ret = max(ret, dp1[j] + mx);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> W, N, C[MAXN][<span class="number">2</span>];</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;W, &amp;N) == <span class="number">2</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">            assert(<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;C[i][<span class="number">1</span>], &amp;C[i][<span class="number">0</span>]) == <span class="number">2</span>);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, knapsack(C, N, W));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-parallel-opt" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/31/parallel-opt/" class="article-date">
  <time datetime="2016-07-31T12:15:17.000Z" itemprop="datePublished">2016-07-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/平行程式/">平行程式</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/31/parallel-opt/">平行優化技巧－基礎篇</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/07/31/parallel-opt/" data-id="ckroajbgw00cqpkvnmfnmmept" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/07/31/parallel-opt/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CUDA/">CUDA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenCL/">OpenCL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenMP/">OpenMP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化/">優化</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <p>在撰寫平行程式時，仍會使用到編譯器的技巧，大幅度地減少指令個數，有時候這些優化甚至會把寫壞的分享記憶體 (shared memory) 存取給移除掉，如果能充分理解這些不好的設計，就不會造成實驗上發生的謬誤，還以為自己跑得很慢，平行根本沒加速到，這樣草草交出的報告，助教也收到煩了 (這裡不討論實驗方法本身就是錯的情況)。</p>
<h2 id="內存篇"><a href="#內存篇" class="headerlink" title="內存篇"></a>內存篇</h2><p>首先，來談談 cache line 是什麼吧？現在的機器都有著記憶體階層架構 (memory hierarchy)，按照大小排序，其中最小的就是 cache line，接下來才是 L1, L2, L3 cache，最後是最大的主記憶體 (main memory)，但某些超級電腦的設計就不是如此，而有些輔助處理器 (如 intel xeon phi) 缺少 L3 cache，而像 GPU 則沒有 cache 設計，但有提供有 bank 存取資料。這些都跟處理問題的類型有關，才導致有那些特殊設計。</p>
<h3 id="Multicore"><a href="#Multicore" class="headerlink" title="Multicore"></a>Multicore</h3><h4 id="Cache-Size"><a href="#Cache-Size" class="headerlink" title="Cache Size"></a>Cache Size</h4><p>為什麼 cache line 很重要？因為存取速度最快，但能存放的資料也很小，通常是 64 bytes 或者 32 bytes。在快取設計中，一次把位址連續的資料一起搬靠近 CPU，這樣簡單的設計，導致我們在撰寫程式時，若能將結構定義得好便能讓使用率高，這非常仰賴編成者對於系統架構的了解。例如色彩 RGB，可以宣告成 <code>struct RGB {flaot R, G, B};</code> 或者 <code>float R[], G[], B[]</code>，如果 RGB 三者會共同計算，例如色彩轉換通常是三者交互作用的表達式，因此前者構造方式較為妥當。</p>
<blockquote>
<p>例題：批改娘 10087. Sparse Matrix Multiplication (OpenMP) </p>
</blockquote>
<h4 id="Cache-Hierarchy"><a href="#Cache-Hierarchy" class="headerlink" title="Cache Hierarchy"></a>Cache Hierarchy</h4><p>然而，有些情況充分使用反而不好，沒錯，就是平行程式，通常平行程式不外乎會有分享記憶體，這時候充分利用反而是一件壞事，因為我們需要讓數個核心 (core) 同時運行，因為每一個 core 都有各自的 cache line，若在不同 core 上同時修改相近的位址時，很容易產生 dirty bit，這導致要掉回 L3 cache (同一個 CPU，但分享在不同的 core 上) 進行同步。通常編譯器能做到 independent 分析，那麼就會利用暫存器配置來避開這問題，如果不行，就要靠自己手動來調整。</p>
<blockquote>
<p>例題：批改娘 10085. Parallel Count (debug)</p>
</blockquote>
<h3 id="GPU"><a href="#GPU" class="headerlink" title="GPU"></a>GPU</h3><p>GPU 的記憶體設計分成四種，經常分成 on-chip 和 off-chip，差別在於是不是內建焊死，因此 on-chip 內建記憶體有比較好的效能，而 off-chip 則是外接記憶體，存取速度相對於 on-chip 慢個三倍以上。特別注意，有好就有壞，提供越快存取速度的記憶體能存放的容量越小，因此非常不容易配置。</p>
<p>在編寫 CUDA 或者是 OpenCL 時，提供 shared memory 的設計，如果請求數量過大，將會自動轉入 global memory，這一點沒有明確告知，只有在執行時期才會發現突然變慢。若採用存取速度較快的寫法，有時候不見得比較快，</p>
<blockquote>
<p>例題：批改娘 10101. Fast Game of Life (CUDA) </p>
</blockquote>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-diary-201606-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/30/diary-201606-2/" class="article-date">
  <time datetime="2016-06-30T05:19:22.000Z" itemprop="datePublished">2016-06-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/手札日記/">手札日記</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="http://i.imgur.com/iMNzqYL.jpg" rel="gallery_ckroajbd6002wpkvnqga0yfep">
        <img src="http://i.imgur.com/iMNzqYL.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/30/diary-201606-2/">走在平行道路上－後篇</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/06/30/diary-201606-2/" data-id="ckroajbd6002wpkvnqga0yfep" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/06/30/diary-201606-2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote><p>到頭來，最好的平行就是不交流，最好的進展就是不溝通。－Antisocial Parallelism</p>
</blockquote>
<h2 id="崩壞季節"><a href="#崩壞季節" class="headerlink" title="崩壞季節"></a>崩壞季節</h2><p>在學期後半段，「四月是你的謊言，五月是否要換題目，六月是否要重新來過」聽到這些是否能明白我在說什麼呢？沒錯，就是傳奇的碩二崩壞日子，若是以畢業導向來讀研究所，花個一年或一年半修課，剩餘時間還要產出論文，想而知壓力是如此地大，有些領域甚至要實作一個系統，那麼忙碌程度就明顯不同，學長們崩壞的日子越來越近。</p>
<ul>
<li>[問卦] 實驗室學長為什麼都不會回家 ? <a href="https://www.ptt.cc/bbs/Gossiping/M.1460094845.A.753.html" target="_blank" rel="external">https://www.ptt.cc/bbs/Gossiping/M.1460094845.A.753.html</a></li>
<li>[問卦] 實驗室學長怎麼壞掉了 <a href="https://www.ptt.cc/bbs/Gossiping/M.1460445571.A.2AA.html" target="_blank" rel="external">https://www.ptt.cc/bbs/Gossiping/M.1460445571.A.2AA.html</a></li>
</ul>
<h2 id="平行助教"><a href="#平行助教" class="headerlink" title="平行助教"></a>平行助教</h2><h3 id="追求優化極致"><a href="#追求優化極致" class="headerlink" title="追求優化極致"></a>追求優化極致</h3><p>課堂作業的平行題目大多都是純數值計算，相當枯燥乏味，但優化技術屬於編譯器範疇，對於平行課程而言，只需要知道概念就能交差，對於這一點我也無可奈何，數次詢問老師是否要以速度作為評分標準，得到的回答都是「不」，心中帶點傷心，很想鼓勵那些寫得不錯又願意花時間鑽研的同學。看到沒有鑽研的同學嫌這門課簡單、好混，真的好想拉著他們一起來研究。</p>
<h3 id="與同學互動"><a href="#與同學互動" class="headerlink" title="與同學互動"></a>與同學互動</h3><p>相較於往年的平行課程，今天很多題目都被設計可以 Online Judge，但有批改娘後，同學在半夜用不錯的想法寫出較快的程序，剛睡醒的我馬上發現自己寫的程序不斷地被幹掉，又花了一個下午加上現有知識再追回去。反反覆覆地過著這種日子，每天醒來都會畏懼最好的寫法會使用什麼樣的概念。心裡過得很痛苦，即使如此我也挺開心的，同學不嫌棄廢廢的我球員兼裁判，還願意在我出的題目下花時間，在下非常感動。</p>
<p><img src="http://i.imgur.com/uSk8DUI.jpg" alt="「即使如此我也挺開心的」－《Re: 從零開始的異世界生活》"></p>
<p>當我拚命優化 local memory 存取，卻在替同學 debug 時發現意外地加速，於是新境界到來，順便跟同學交流一下加速部份，甚至連開檔時間都要省！一起追尋神乎其技的感覺非常不賴。</p>
<blockquote>
<p>效能進展 3571 ms (24-core CPU) -&gt; 2567 ms (GPU, partial local memory) -&gt; 2472 ms (GPU, full local memory) -&gt; 1675 ms (GPU, full local memory + work group opt) -&gt; 967 ms (GPU, global memory + I/O opt + embedded kernel code)</p>
</blockquote>
<p><img src="http://i.imgur.com/RUtql78.jpg" alt="「來吧 快和我一起來修行吧」－《田中君總是如此慵懶》"></p>
<p>「看著秒速被拉近，從 profiler 中看出當前問題卡在 memory bandwidth &amp; usage，要著手這一塊優化了對吧。」</p>
<p>「就算是 1 μs，也省給你看！」</p>
<p>「又有人刷新速度極限，睡覺時收到訊息很想裝死。要是再強一點就好了，又要等價交換什麼了嗎？只剩下生命了啊」</p>
<p>「相互學習競爭，別的實驗室好厲害啊，一不留意效能就輸了，得快點想辦法。」</p>
<p>「遇到第一次執行時慢 800 ms 左右，接下來都執行相同輸入又不見這消失的時間，難道是所謂的 library cache miss ? 可是執行檔不到 1 MB 耶。」</p>
<p>「照理來說，演算法迭代到後期的收斂是可預測的，所以硬體能猜測的效能會加快，從平行的結果卻是越跑越慢嗎？明明一開始贏了，後來卻輸了，咱不明白啊，一定是寫壞掉了」</p>
<p>「一早起床就發現相當疲勞，一打開批改娘就發現排名被刷掉。如果贏不了，起碼不能輸，不然這樣有辱實驗室之名！M 之神啊，請賜予我力量活著。不然沒有信心活下去 …」</p>
<p><img src="http://i.imgur.com/hCEuP2f.jpg" alt="「動用腦中所有的智慧考慮這個問題」－《熊巫女》"></p>
<p>事實上，這名跟我拚搏的學生只有一位 R04922075 古耕竹同學，就與 tmt514 談論的結果，一門課只需要有一位同學認真與助教一起學習就好，「一名足矣！」的精神已經深植我心。</p>
<p>後來才知道他之所以能在長時間拚搏都是因為住在實驗室裡，醒來就可以寫程式做實驗，累了就在實驗室睡，聽起來可是研究最高生活境界，當然聽起來是個廢人似的，但能省下龐大的住宿費相當吸引我，再加上在台北這種鬼地方，還得忍受每天一個多小時的通勤，先不談住宿有多昂貴，學校研究生宿舍不夠住真的不方便，不像以前中央大學，也許地理位置偏僻，研究生宿舍還一堆空位等著人去住呢！除非指導教授收不到學生，否則進住實驗室這件事情我還做不到啊。</p>
<p><img src="http://i.imgur.com/jFAVqtJ.jpg" alt="「我做不到啊」－《田中君總是如此慵懶》"></p>
<h3 id="出題考驗"><a href="#出題考驗" class="headerlink" title="出題考驗"></a>出題考驗</h3><p>老師每週只要求同學們撰寫幾支小程序，套用平行有快就好，但時候發生平行反而慢，或者不如預期效果時，通常是因為平行撰寫後，導致編譯器的優化等級起不來，可是老師又不想讓同學學習優化，在兩頭難的情況下，只好進行自主研究，包裝成線上評測只是單純方便實驗，為了減少 IO 導致實驗不準確，可是費了相當大的心力在思考如何出題。</p>
<p><img src="http://i.imgur.com/qMEqyld.jpg" alt="「你就隨便研究一下，然後自學吧！」－《田中君總是如此慵懶》"></p>
<p>在沒有任何經驗傳承下，大部分的程式碼都被學長摧毀，拼湊零碎的知識弄成一題，再寫各種版本進行測試，調校參數進行實驗，簡直是在做大規模的研究似的，每天都如此反覆地度過好幾個星期。</p>
<p><img src="http://i.imgur.com/OIgBxMV.jpg" alt="「現在我的心裡已經裝不下你了」－《田中君總是如此慵懶》"></p>
<p>思考如何解題、設計題目時，總會瞬間 CPU 全滿，誰也無法搶資源！這樣的日子過久了，覺得身心相當疲勞。</p>
<p><img src="http://i.imgur.com/fIs4P00.jpg" alt="「現在的我需要休息」－《熊巫女》"></p>
<p>到了學期後半，步入分散式計算的領域，但不知道能不能用單元測試的想法，建構出一套測試 Hadoop 題目的系統，雖然沒辦法完全模擬群集計算的環境，作為驗證程序正確性也有一定可靠性。採用 Hadoop Streaming 的方式進行 Judge。</p>
<blockquote>
<p>曾經未完成的夢，是否在這裡能找到答案？</p>
</blockquote>
<h2 id="超艱難修課進行式"><a href="#超艱難修課進行式" class="headerlink" title="超艱難修課進行式"></a>超艱難修課進行式</h2><h3 id="期中考"><a href="#期中考" class="headerlink" title="期中考"></a>期中考</h3><p>迎來在台大第二次期中考，遲遲無法適應這邊的考試方式，一部分原因也許是在以前學校大多都有考古題撐腰，而現在屬於無依無靠的情況下，又加上題目是一坨英文，看錯題目意思的機會太高，而在答題速度方面考試時間上會來不及，期中考變得一項大挑戰。其中一門課提供開書考，甚至允許同學上網搜尋答案，但是一打開試卷，突然冒出了一題「請看以下這一篇論文，然後回答下列問題」頓時的反射動作是直接跳過，經常看的英文論文通常是十幾頁在跳，考試時間兩個半小時，沒時間耗在這。</p>
<p>然而，在考試結束後，老師特別講到「作為一個研究生，看論文的能力很重要的」於是特地被老師點出來「你怎麼沒寫那一題呢？」只能苦笑地回應，在心中暗自地述說『因為我怕英文啊』那一題佔了 10% 成績，連看都沒看就放棄了，而那張試卷寫到最後一刻才把所有題目寫完，到底該不該慶幸沒去看那一題呢？</p>
<p><img src="http://i.imgur.com/fDijwFD.jpg" alt="「我一點兒也不知道」－《熊巫女》"></p>
<h2 id="心靈打擊"><a href="#心靈打擊" class="headerlink" title="心靈打擊"></a>心靈打擊</h2><p>這陣子受到強烈打擊，原因可以歸納出以下幾點：</p>
<ol>
<li>大學長火速交了女朋友並且擺脫魯蛇行列</li>
<li>弄了半天的環境，被橫插一行突然 PASS</li>
<li>寫得程序在不知名的情況下被女同學說很醜</li>
<li>程序一直寫不好、不快</li>
<li>愚蠢至極</li>
</ol>
<p>碩二學長則一直在暗示要抓交替，如報帳和財務管理、伺服器管理 … 等，準備進入三者皆無的狀態，徹底用到廢掉。</p>
<p><img src="http://i.imgur.com/gypx3yv.jpg" alt="「你真的被詛咒了嗎？」－《Re: 從零開始的異世界生活》"></p>
<h2 id="新生活挑戰"><a href="#新生活挑戰" class="headerlink" title="新生活挑戰"></a>新生活挑戰</h2><p>由於助教薪水大概一個月七千，但發送方式不是學校支付，拖了好幾個月才會到，當然一個月七千在台北吃飯，若要吃點好的，一個月七千一點也不夠，都到了這把歲數，還是要想辦法養活自己的一小部分吧。於是小夥伴表示「薪水到現在都還沒發出來，一個月六千哪能過生活。」最後在小夥伴的催促下，Morris 打開家教網找零工啦。但打電話是多麼令人害怕得一件事情 …</p>
<p><img src="http://i.imgur.com/ZJhzb86.jpg" alt="「我絕對不會這麼失敗的」－《田中君總是如此慵懶》"></p>
<p>被學長推去面試家教，明明都已經鼓起勇氣出發，卻又過程中潑冷水。去也不是，不去也不是，這搞得我好混亂，到底還能相信這世界什麼地方？</p>
<p><img src="http://i.imgur.com/hljjHxR.jpg" alt="「妳這麼關心我，真不好意思，其實你不用太在乎我的，我喜歡一個人待著。」－《田中君總是如此慵懶》"></p>
<h2 id="白活系列"><a href="#白活系列" class="headerlink" title="白活系列"></a>白活系列</h2><h3 id="加速-NPC"><a href="#加速-NPC" class="headerlink" title="加速 NPC"></a>加速 NPC</h3><p><img src="http://i.imgur.com/fR0IDd3.jpg" alt="「同樣都是人類，為什麼差距這麼大！」－《線上遊戲的老婆不可能是女生》"></p>
<p>當年在 NCPC 搞不出來的 Problem I Christmas Gifts (NP-hard)，在賽後用 DLX 運行效果不錯，在啟發函數加上延遲標記更是屹立排名前數位已久。最近又因為平行把題目挖回來討論，在去年釣到大一學弟來解，便以飛快的速度擊破測資，最後達到加速 20x。再把當初需要跑 30 秒的測資來運行，現在只需要短短的 50ms。而都這麼快了 … 應該不用平行吧。</p>
<h3 id="動態規劃"><a href="#動態規劃" class="headerlink" title="動態規劃"></a>動態規劃</h3><p>為了出題目，根據研究論文後的結果，出了一題常見的動態規劃題目，也就是 matrix chain multiplication，儘管算法最終可以加速到 $O(N^{\log_2 3})$，但在 30 年前就存在 matrix chain multiplication 的 $O(N \log N)$ 作法，那在 $O(N^3)$ 套了一堆剖分方便平行到底在窮忙什麼？</p>
<p>「當面對諸多選項時，我實在不曉得到底該選哪一個才不算錯。」當一個 Flag 打開之後，瞬間掉了不少 Performance …</p>
<h2 id="近期活動"><a href="#近期活動" class="headerlink" title="近期活動"></a>近期活動</h2><p>最近才把原本要出題目的測資補起來，論文誇張的加速似乎是跟非常非常蠢的版本比較，但快個兩三倍仍相當值得，編程複雜度也是增加兩三倍。各種層面的題目都已經全數實作好放上批改娘上提供線上評測。心想當研究一直發展下去，難道都不會窮盡？清單上的靶子長得越來越奇特，研究學者果真是一群變態啊。</p>
<p><img src="http://i.imgur.com/AUqO1eD.jpg" alt="「我已經失去活下去的信心」－《田中君總是如此慵懶》"></p>
<p>學期最後一堂 Workshop 結束，心裡總算舒坦了些，不用每周在廢物的羞恥 play 下度過。感謝上課同學們賜教予我！</p>
<p><img src="http://i.imgur.com/V3uOCmD.jpg" alt="「謝謝」－《田中君總是如此慵懶》"></p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-diary-201606" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/29/diary-201606/" class="article-date">
  <time datetime="2016-06-29T11:56:18.000Z" itemprop="datePublished">2016-06-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/手札日記/">手札日記</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="http://i.imgur.com/eHvfV1i.jpg" rel="gallery_ckroajbd4002spkvncadjtggz">
        <img src="http://i.imgur.com/eHvfV1i.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/29/diary-201606/">走在平行道路上－前篇</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/06/29/diary-201606/" data-id="ckroajbd4002spkvncadjtggz" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/06/29/diary-201606/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="前提摘要"><a href="#前提摘要" class="headerlink" title="前提摘要"></a>前提摘要</h2><p>這學期修課過得相當恐懼，期初上課就受到多方刺激，因為許多課第一堂都問說以前有沒有學過什麼，易想而知地，對學店逃出的我而言，只能默默在心中說「有聽過這個詞嗎？難道就沒辦法修課，這樣子根本沒有課程可以修。」幸好地，雖然沒有受過台大大學部課程的指導，大部分的內容以前都自己研究和玩過。</p>
<p>回頭看看，那些英文授課以及期末實作論文之類的，內心恐懼越來越深，而在下學期要報英文論文，學長因為連發音不正確或者用詞錯誤受到老師的深入指導，每一次開會都久戰一個多小時。而連基礎英文都只能靠 google 翻譯，為了確信實驗結果，都必須親自實作一番才行。腦子不斷地去喘測未來，估量這學期不間斷地抗戰的生活，然後還要受到老師嚴厲地批判。</p>
<p>接下來，就以圖文的方式回顧這一學期吧！</p>
<h2 id="解題相關"><a href="#解題相關" class="headerlink" title="解題相關"></a>解題相關</h2><p>逐漸地放下在 UVa Online Judge 的刷題日子，更沒有參與各種線上例行賽，由於曾經寫非常多的題目，仍然有不少人經常來詢問題目，不管是學校課程或者是 UVa 上的舊題目都會被拿來問。然而，有一些特殊案例是拿著世界總決賽等級的題目來問，一看就知道要寫個天昏地暗，說不定還不會的題目呢。</p>
<p><img src="http://i.imgur.com/yKnTlUf.jpg" alt="「來，請吧」-《為美好的世界獻上祝福》"></p>
<p>只是比別人稍微努力一點，對於高難度的題目反應是相當慢的。當然，我還是盡力回答，不過那陣子還要趕作業，閒暇時間一點也不想再開題目，一開下去不知道會不會一整天就過去，這樣可就沒辦法好好寫作業，滿腦子都是揮之不去的題目。所以有忽略一些人的提問，在此向大家說聲抱歉。</p>
<h2 id="實驗生活"><a href="#實驗生活" class="headerlink" title="實驗生活"></a>實驗生活</h2><h3 id="燃燒經費"><a href="#燃燒經費" class="headerlink" title="燃燒經費"></a>燃燒經費</h3><p>從碩一剛進來時，碩班學長已經擔任採購財務管理已經兩年，為什麼是兩年呢？這些就要留給本人來說，事實上這裡很多人都充滿兩年以上的回憶，若要成為這裡的一分子，負擔是非常沉重的。每學期都要消耗實驗室經費，經過半年的我仍然幫不上學長，沒有研究目標就不知道要怎麼樣的實驗環境，能提出的採購項目原則上都不會通過。</p>
<p><img src="http://i.imgur.com/rmSaE3L.jpg" alt="「對不起，我太沒用了」-《蒼之彼方的四重奏》"></p>
<p>那一陣子，由於要架設實驗室的群集計算，花了好個星期都沒辦法把網路架設好，一部分原因都是因為想要在虛擬機器如 Xen 上面維護，這時候網路設定和應用程式之間的權限開放變得困難，這些牽涉到軟體設計，參數總是不如預期地運作。</p>
<p>為了解決管理介面每天都睡不好，每到實驗室看著旁邊吵到不行的伺服器，不想接觸那無法運行的廢鐵們。這時候就提案買個 <strong>安眠藥</strong> 之類的，可想而知地被老師打槍，因不久之後因為課堂要使用，建造不起來的壓力非常大，再加上實驗室已經沒人有架設經驗，對系統比較熟的蕭大帥還要忙著畢業論文，只好用毅力嘗試架設。這故事的最後，採用原生的方式完成，暫時先別為了防止系統掛掉而採用虛擬化技術保護。</p>
<h3 id="巧遇英文"><a href="#巧遇英文" class="headerlink" title="巧遇英文"></a>巧遇英文</h3><p>蕭大帥學長看我破爛的英文，設想推薦我學習英文的方法，例如去學校語言中心聽力練習，或者到圖書館借閱英文文法書籍，又或者參與大一英文課程，然而都因為時間點不對，而且修課過重而沒有動力參加，英文帶來的恐懼對我來說不是一時造成的。但是看英文字幕的動畫不是問題，可惜地歐美翻譯速度慢，再加上翻譯味道對不上，一部分是文化上的不同，這導致要找到對應詞彙困難，有機會再來採用英文字幕看新番吧，擷圖一定非常有趣。</p>
<p><img src="http://i.imgur.com/CktUcN2.jpg" alt="「You were asleep for 15 years but still have a silver tongue」-《只有我不存在的街道》"></p>
<h3 id="路人搭訕"><a href="#路人搭訕" class="headerlink" title="路人搭訕"></a>路人搭訕</h3><p>每天過著早上九點左右到實驗室，晚上十一點左右回住的地方，其一原因是要避免上班族群和補習班下課學生。每天過著像上班族往常的通勤生活。</p>
<p>在某次下雨的夜晚，看到窗外的雨停了，便拿著來滴著雨水的傘提早離開，快速地走在人行道上，突然一旁有聲細語傳來「你正要回家嗎？」轉過頭來看，原來是名剛打完工妹子，心想『還好不是什麼怪人，但主動跟我搭話也有一點怪人成份吧？』心中充滿地慌張回道「是的，剛從實驗室離開。」</p>
<p>「哦，你是研究生嗎？我剛從打工那裡下班。今天都沒有少收錢，超開心的，之前經常少收錢」帶著愉悅的語調回道<br>「辛苦你啦，你在活動中心打工嗎？」因為沒見過面的面孔，為了確定身分還是問些資訊來吧。<br>「嗯嗯，在麥當勞打工。」<br>『…』帶有疑惑地，可是我一點也沒印象，去過幾次麥當勞，但店員的年齡對不上的。<br>「不過我都在內場忙，所以可能沒有見過吧。」</p>
<p>聊著聊著都走到捷運站上，一路上只應答一些簡單的句子，突然來個人靠在身邊聊天，難免不受到驚嚇。到了捷運站，一般都直接走樓梯而沒有特地走到有電扶梯的入口，也許就因為要跟著我走</p>
<p>「可以借我攙著嗎？」她攙著我的胳膊走下去，這時候幼小的心靈受到沉重打擊。<br>「你有在練肌肉嗎？感覺是有肌肉的觸感 …」<br>「沒啦！」聽到內心不斷地尖叫、嘶吼，這一切都來得太突然。</p>
<p><img src="http://i.imgur.com/vVeeJVB.jpg" alt="「確實在啊，腦子不正常的孩子。」-《為美好的世界獻上祝福》"></p>
<p>看來經常到實驗室打混的日子，導致逐漸地看到幻覺，總算可以達到擴充實境的地步，由衷地敬佩自己。</p>
<h3 id="算法數學分析"><a href="#算法數學分析" class="headerlink" title="算法數學分析"></a>算法數學分析</h3><p>經由學長的推薦，選修陳文進老師的「演算法數學分析」課程，這門課可說是各種演算法常見的數論技巧，在競賽中也非常容易見到，但從看過數學家是如何定義這些符號以及運算性質，這門課可說是增廣嚴謹數學定義與工具的好課。</p>
<p>然而，每週寫起作業來非常刺激，雖然水泥數學課本〈Concrete Mathematics〉大部分都有提供解答，但是解法就不太明確，有提供驗證答案正確性的參考，於是乎有各種神妙的解法，甚至不用套用課程所講的一些技法，老師也非常鼓勵同學用一些已知的知識來推論答案，有時還比教科書來得簡單扼要。</p>
<p>寫起作業每次大概花了一天到兩天，每週一個章節，老師沒講到的章節要自行閱讀，難度不會太高，花點時間坑一下基本上都能完成。作業推論則是經過一個星期的哀嚎，有時候六日推不出來，放著過好幾天才突然想到，數學的美妙近在眼前卻總是差一步就能推出。</p>
<p><img src="http://i.imgur.com/7tpuCB0.jpg" alt="「大家就愉快地化為塵土吧」-《為美好的世界獻上祝福》"></p>
<p>由於這門課已經很久沒開，沒法找到合適的人選擔任助教，而常見的球員兼裁判的人選卻不選這門課，於是每週作業大家輪著改。有一次我改大家的作業，看到許多神奇的寫法，但也非常地痛苦，腦補了好幾十分鐘仍猜不出這傢伙在寫什麼，而我們寫程式的人，又經常失去一些數學常識，如 <strong>程式的等號和數學的等號是不相同的</strong>。若這門課程有助教，這助教一定會崩潰的！</p>
<h3 id="奴工打雜"><a href="#奴工打雜" class="headerlink" title="奴工打雜"></a>奴工打雜</h3><p>老闆又叫我把批改娘架設給 Data Structrue and Algorithm (簡稱 DSA) 課程使用，雖然跟他們實驗室要了一台 伺服器安裝，經過三番測試終於架設起來，只有稍微跟他們說明如何建置題目和加入使用者。畢竟是做免錢的，剩下就看他們造化。</p>
<p>沒想到最後還是採用老方法，繼承他們 DSA 去年的腳本改作業，畢竟要設置批改系統非常不容易。而上次交給電機系使用，他們成功地運作這到讓我感到意外，資工系反而沒有花時間架起來玩。</p>
<p>過了不久收到 DSA 課程來信要徵助教，想到已經擔任一門課助教，再一門會往生，有人還認為我會想去當 DSA 的助教呢？若是當了，早就來一場助教與學生之間的效能拚搏，想到若要協助架設批改系統，多麼令人感到戰慄。</p>
<p><img src="http://i.imgur.com/gYcmE2D.jpg" alt="《無彩限的幻影世界》"></p>
<h3 id="超艱難修課挑戰"><a href="#超艱難修課挑戰" class="headerlink" title="超艱難修課挑戰"></a>超艱難修課挑戰</h3><p>清明連假都在寫作業，每天都看似好像有點進展，程序仍然沒辦法跑。覺得程式越寫越退化，退化到與組語奮戰。覺得各課程作業非常噁心，一年抵四年所學，都覺得快被後輩看起來認定是個廢物。如果寫不出來，是不是都是我的錯呢？</p>
<p><img src="http://i.imgur.com/0H6QdG2.jpg" alt="「不全都是你的錯嗎？」《好想大聲說出心底的話》"></p>
<p>看著作業需要的 LLVM API，看不懂文件只好猜呀猜，針對文件窮舉各種英文姿勢，歷經崩潰的驗證思路後，才察覺流程果然有點詭異，確定描述上的瑕疵後，換個思路打掉重來吧！也許還需要寫點測試，才能知道到底有沒有寫對。於是作業又再次進入輪迴，進度從零開始！</p>
<h2 id="平行助教"><a href="#平行助教" class="headerlink" title="平行助教"></a>平行助教</h2><h3 id="提前研究"><a href="#提前研究" class="headerlink" title="提前研究"></a>提前研究</h3><p>在學期開始前，預想而知地會受到老闆指派當平行程式助教，從上學期 C 語言程式助教那時開始，平行設計的課堂題目就開始實驗，把平行題目放上批改娘系統上，沒想到大一新生也有嘗試去解決那些題目，台大新生的學習能力遠遠超出我的想像。</p>
<p>研究如何平行程式不算難，但是寫得好與壞差別很多，大部分的情況都會快上一些，慘的時候甚至會慢上數倍，經過一層層地解析，研究為什麼會變慢，慢是因為什麼因素所導致？是架構嗎？還是運行流程？又或者是算法重複計算？當遇到瓶頸的時候，只能埋頭苦幹地研究，深刻地體會到研究並不會提升智力，只是增加知識層面而已，像我這種笨蛋卻過著研究生活，怎麼想都奇怪呢！</p>
<p><img src="http://i.imgur.com/NHvqBMk.jpg" alt="「也不會提升智力了」-《為美好的世界獻上祝福》"></p>
<h3 id="優化挑戰"><a href="#優化挑戰" class="headerlink" title="優化挑戰"></a>優化挑戰</h3><p>平行不只有平行，牽涉到硬體架構，隨著平行的需求所進行的算法設計，若整個算法對硬體友不友善，將會影響程式的快慢。最常見的就是快取問題，第一個遇到的是 Structure Of Array / Array Of Structure 的不同，針對使用層面，沒想到他們居然會差異到 10 ~ 20% 效能差異，也就是遠本跑 50 秒的程式，居然可以提升到 40 秒內跑完，若要發這種論文，想必需要知道很多硬體設計。</p>
<p><img src="http://i.imgur.com/inFI4p6.jpg" alt="「Study Hard」－《無彩限的幻影世界》"></p>
<h3 id="製作批改系統"><a href="#製作批改系統" class="headerlink" title="製作批改系統"></a>製作批改系統</h3><p>如果沒有正常執行完畢，莫名其妙伺服器的內存量增加，也找不到地方砍，重啟顯卡也沒辦法解決，眼睜睜地看著內存爆炸。OpenCL 要製作成 Judge 題目還有一段路要走，每次 Judge 就重新啟動 Server 是最慘的抉擇。</p>
<p><img src="http://i.imgur.com/Ldivp9f.jpg" alt="「這跟說好的不一樣啊？」－《Re: 從零開始的異世界生活》"></p>
<p>大致上知道 Memory Leak 的出現點，不管是程序有錯或被強制中斷都來不及執行釋放，少釋放一個物件造成內存少 100MB，經過兩三百個案例就得重開機。暫時解決方案是寫腳本偵測記憶體用量，指定超過用量自動重開，一旦沒寫好將變成不斷地重開。</p>
<p>好不容易架設好批改系統，但是測速度有嚴重的啟動損耗，有時候在沙盒裡面運行還特別慢，當只裝 nVidia driver，啟動 OpenCL 基本消耗一秒多。為了使用 Profiler，意外地安裝 CUDA 相關插件，頓時啟動消耗變成毫秒等級。為了解決這奇怪的現象，還一度把伺服器搞壞，整台重灌才順利解決。</p>
<p><img src="http://i.imgur.com/HZOgbzy.jpg" alt="《為美好的世界獻上祝福》"></p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-jg-10116" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/28/jg-10116/" class="article-date">
  <time datetime="2016-06-28T06:02:13.000Z" itemprop="datePublished">2016-06-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/平行程式/">平行程式</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/28/jg-10116/">批改娘 10116. Fast Dynamic Programming Computing I (OpenMP)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/06/28/jg-10116/" data-id="ckroajbfm009gpkvncwt7to0g" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/06/28/jg-10116/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DP/">DP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenMP/">OpenMP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cache-oblivious-algorithm/">cache-oblivious algorithm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/批改娘/">批改娘</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h2><p>給定一序列矩陣，期望求出相乘這些矩陣的最有效方法的乘法次數。</p>
<h3 id="sequence-c"><a href="#sequence-c" class="headerlink" title="sequence.c"></a>sequence.c</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 4096</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> INF (1LL&lt;&lt;60)</span></div><div class="line"><span class="keyword">int</span> N;</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> dp[MAXN*MAXN], SZ[MAXN+<span class="number">5</span>];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;N) == <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= N; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;SZ[i]);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N-i; j++) &#123;</div><div class="line">                <span class="keyword">int</span> l = j, r = j+i;</div><div class="line">                <span class="keyword">long</span> <span class="keyword">long</span> local = INF;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = l; k &lt; r; k++) &#123;</div><div class="line">                    <span class="keyword">long</span> <span class="keyword">long</span> t = dp[l*N+k] + dp[(k+<span class="number">1</span>)*N+r] + SZ[l] * SZ[k+<span class="number">1</span>] * SZ[r+<span class="number">1</span>];</div><div class="line">                    <span class="keyword">if</span> (t &lt; local)</div><div class="line">                        local = t;</div><div class="line">                &#125;</div><div class="line">                dp[l*N+r] = local;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, dp[<span class="number">0</span>*N+N<span class="number">-1</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="輸入格式"><a href="#輸入格式" class="headerlink" title="輸入格式"></a>輸入格式</h2><p>有多組測資，每組第一行會有一個整數 $N$ 表示矩陣鏈上有 $N$ 個矩陣，第二行上會有 $N+1$ 個整數 $Z_i$，表示矩陣鏈的每一個行列大小，例如當 $N = 3$ 時，輸入 <code>10 30 5 60</code> 表示矩陣 <span>$A_{10, 30} B_{30, 5} C_{5, 60}$</span><!-- Has MathJax --> 相乘。</p>
<ul>
<li>$1 \le N \le 4096$</li>
<li>$1 \le Z_i \le 4096$</li>
</ul>
<h2 id="輸出格式"><a href="#輸出格式" class="headerlink" title="輸出格式"></a>輸出格式</h2><p>對於每組測資輸出一行一個整數 $M$ 為最少乘法次數。</p>
<h2 id="範例輸入"><a href="#範例輸入" class="headerlink" title="範例輸入"></a>範例輸入</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">2</div><div class="line">2 2 2</div><div class="line"> </div><div class="line">3</div><div class="line">10 30 5 60</div><div class="line"> </div><div class="line">3</div><div class="line">1 5 20 1</div><div class="line"> </div><div class="line">3</div><div class="line">5 10 20 35</div><div class="line"> </div><div class="line">6</div><div class="line">30 35 15 5 10 20 25</div></pre></td></tr></table></figure>
<h2 id="範例輸出"><a href="#範例輸出" class="headerlink" title="範例輸出"></a>範例輸出</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">8</div><div class="line">4500</div><div class="line">105</div><div class="line">4500</div><div class="line">15125</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>假設有 $p$ 個處理單元，矩陣大小為 $n \times n$，分析一般平行運算時間 <span>$T_p$</span><!-- Has MathJax --> 如下所示：</p>
<span>$$\begin{align*}
&Tab;T_p &amp;= \sum\limits_{k=1}^{n} \left\lceil \frac{k}{p} \right\rceil \times (n - k)
\end{align*}$$</span><!-- Has MathJax -->
<p>針對地 $k$ 次迭代，將第二層迴圈平行化，每一個執行緒處理 $\left\lceil \frac{k}{p} \right\rceil$ 個狀態計算，每個狀態繼續需要 $n-k$ 次計算。</p>
<span>$$\begin{align*}
&Tab;\sum\limits_{k=1}^{n} \left\lceil \frac{k}{p} \right\rceil \times k
&Tab;&Tab;&amp;= 1 \times (1 + 2 + 3 + \cdots + p) + \\
&Tab;&Tab;&amp; \qquad
&Tab;&Tab;&Tab;2 \times ((p+1) + (p+2) + (p+3) + \cdots + 2p) + \cdots + \\
&Tab;&Tab;&amp; \qquad
&Tab;&Tab;&Tab;&Tab;(n \bmod{p}) \times \left\lceil \frac{n}{p}\right\rceil (\lfloor n/p \rfloor \times p + 1 + \cdots + n) \\
&Tab;&Tab;&amp;= \sum_{k=1}^{\lfloor n/p \rfloor} k \cdot \frac{p (2k+1) p}{2}
&Tab;&Tab;&Tab;+ (n \bmod{p}) \times \left\lceil \frac{n}{p}\right\rceil 
&Tab;&Tab;&Tab;&Tab;\frac{(n \bmod{p})(n + \left\lfloor \frac{n}{p}\right\rfloor p + 1)}{2} \\
&Tab;&Tab;&amp;= p^2 \left[ \frac{\left\lfloor n/p \right\rfloor(\left\lfloor n/p \right\rfloor+1)(2 \left\lfloor n/p \right\rfloor + 1)}{6} + \frac{\left\lfloor n/p \right\rfloor(\left\lfloor n/p \right\rfloor+1)}{4} \right] + 
&Tab;&Tab;&Tab;(n \bmod{p})^2 \left\lceil n/p \right\rceil \frac{n + \left\lfloor n/p \right\rfloor p + 1}{2} \\
&Tab;\sum\limits_{k=1}^{n} \left\lceil \frac{k}{p} \right\rceil \times n
&Tab;&Tab;&amp;= n \cdot p \cdot \frac{\left\lfloor n/p \right\rfloor (\left\lfloor n/p \right\rfloor + 1)}{2} + 
&Tab;n \cdot (n - p \cdot \left\lfloor n/p \right\rfloor) \left\lceil n/p \right\rceil
\end{align*}$$</span><!-- Has MathJax -->
<p>總結一下 <span>$T_p = \sum\nolimits_{k=1}^{n} \left\lceil \frac{k}{p} \right\rceil \times n - \sum\nolimits_{k=1}^{n} \left\lceil \frac{k}{p} \right\rceil \times k = O(n^3 / p)$</span><!-- Has MathJax --></p>
<p>針對前半段 <span>$\sum\limits_{k=1}^{n} \left\lceil \frac{k}{p} \right\rceil$</span><!-- Has MathJax --> 有以下兩種推法可供參考。</p>
<h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><span>$$\begin{align*}
&Tab;\sum\limits_{k=1}^{n} \left\lceil \frac{k}{p} \right\rceil 
&Tab;&Tab;&amp;= p \cdot 1 + p \cdot 2 + p \cdot 3 + \cdots + p \cdot \left\lfloor n/p \right\rfloor + (n \bmod{p}) \cdot \left\lceil n/p \right\rceil 
&Tab;&Tab;&Tab;\phantom{0\over0}\\
&Tab;&Tab;&amp;= \sum\limits_{k=1}^{\left\lfloor n/p \right\rfloor} k \cdot p + (n - p \cdot 
&Tab;&Tab;&Tab;\left\lfloor n/p \right\rfloor)
&Tab;&Tab;&Tab;\left\lceil n/p \right\rceil \\
&Tab;&Tab;&amp;= p \cdot \frac{\left\lfloor n/p \right\rfloor (\left\lfloor n/p \right\rfloor + 1)}{2} + 
&Tab;&Tab;(n - p \cdot \left\lfloor n/p \right\rfloor) \left\lceil n/p \right\rceil
&Tab;&Tab;&Tab;&amp;&amp; \blacksquare
\end{align*}$$</span><!-- Has MathJax -->
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>套用定理如下：(解釋： $n$ 個人分成 $p$，每組人數最多差一。)</p>
<span>$$\begin{align}
&Tab;n = \left\lceil \frac{n}{p} \right\rceil + \left\lceil \frac{n-1}{p} \right\rceil
&Tab;&Tab;+ \cdots + \left\lceil \frac{n-p+1}{p} \right\rceil
\end{align}$$</span><!-- Has MathJax -->
<p>套用上式從 $k = n$ 往回推。</p>
<span>$$\begin{align*}
&Tab;\sum\limits_{k=1}^{n} \left\lceil \frac{k}{p} \right\rceil 
&Tab;&Tab;&amp;= \left\lceil \frac{n}{p} \right\rceil +
&Tab;&Tab;&Tab;\left\lceil \frac{n-1}{p} \right\rceil + \cdots +
&Tab;&Tab;&Tab;\left\lceil \frac{n-p+1}{p} \right\rceil +
&Tab;&Tab;&Tab;&Tab;\sum_{k=1}^{n-p} \left\lceil \frac{k}{p} \right\rceil \\
&Tab;&Tab;&amp;= n + (n - p) + (n - 2p) + \cdots + (n - \lfloor n/p \rfloor \cdot p)
&Tab;&Tab;&Tab;+ \sum_{k=1}^{n \bmod{p}} \left\lceil \frac{k}{p} \right\rceil \\
&Tab;&Tab;&amp;= \sum\limits_{k=0}^{\left\lfloor n/p \right\rfloor - 1} (n - k p)
&Tab;&Tab;&Tab;+ (n \bmod{p}) \\
&Tab;&Tab;&amp;= n \left\lfloor n / p \right\rfloor 
&Tab;&Tab;&Tab;- \frac{\left\lfloor n/p \right\rfloor (\left\lfloor n/p \right\rfloor - 1)}{2} \times p 
&Tab;&Tab;&Tab;+ (n \bmod{p}) &amp;&amp; \blacksquare
\end{align*}$$</span><!-- Has MathJax -->
<h3 id="基礎平行"><a href="#基礎平行" class="headerlink" title="基礎平行"></a>基礎平行</h3><ul>
<li>Accepted (50883 ms, 132224 KB)</li>
</ul>
<p>平行地方呼之欲出，針對第二層迴圈直接平行化即可，下述代碼會帶入一點累贅，其原因在於做了各種實驗所致，但不影響正確性。只做了減少 thread 建立時的 overhead 的處理。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;omp.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 4096</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> INF (1LL&lt;&lt;60)</span></div><div class="line"><span class="keyword">int</span> N;</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> dp[MAXN*MAXN], SZ[MAXN+<span class="number">5</span>];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;N) == <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= N; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;SZ[i]);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">            dp[i*N+i] = <span class="number">0</span>;</div><div class="line">        <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel firstprivate(N)</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++) &#123;</div><div class="line">                <span class="meta">#<span class="meta-keyword">pragma</span> omp for</span></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N-i; j++) &#123;</div><div class="line">                    <span class="keyword">int</span> l = j, r = j+i;</div><div class="line">                    <span class="keyword">long</span> <span class="keyword">long</span> local = INF;</div><div class="line">                    dp[l*N+r] = INF;</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> k = l; k &lt; r; k++) &#123;</div><div class="line">                        <span class="keyword">long</span> <span class="keyword">long</span> t = dp[l*N+k] + dp[(k+<span class="number">1</span>)*N+r] + SZ[l] * SZ[k+<span class="number">1</span>] * SZ[r+<span class="number">1</span>];</div><div class="line">                        <span class="keyword">if</span> (t &lt; local)</div><div class="line">                            local = t;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (local &lt; dp[l*N+r])</div><div class="line">                        dp[l*N+r] = local;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, dp[<span class="number">0</span>*N+N<span class="number">-1</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="進階平行"><a href="#進階平行" class="headerlink" title="進階平行"></a>進階平行</h3><ul>
<li>Accepted (9890 ms, 136320 KB)</li>
</ul>
<p>從一般平行實驗結果中，發現明顯地加速倍率不對，明明使用 24 個核心，跑起來不到兩倍加速的原因到底在哪？是的，在第三層存取順序需要 <code>dp[l][k]</code> 和 <code>dp[k+1][r]</code> 隨著 $k$ 變大，在前者存取順序是連續的，而在後者存取順序每一次跳躍長度為 $N$，導致 <code>dp[k+1][r]</code> 常常會發生 cache miss，一旦發生 cache miss，需要數百的 cycle 等待資料被帶進記憶體中。</p>
<p>由於矩陣鍊乘積計算時只用了矩陣的上三角，那複製一份到下三角矩陣去吧！<code>dp[l][r] = dp[r][l]</code>，如此一來在第三層迴圈發生 cache miss 的機會就大幅度下降。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;omp.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 4096</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> INF (1LL&lt;&lt;60)</span></div><div class="line"><span class="keyword">int</span> N, SZ[MAXN+<span class="number">5</span>];</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> dp[MAXN*MAXN];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;N) == <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= N; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;SZ[i]);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">            dp[i*N+i] = <span class="number">0</span>;</div><div class="line">        <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel firstprivate(N)</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++) &#123;</div><div class="line">                <span class="meta">#<span class="meta-keyword">pragma</span> omp for</span></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N-i; j++) &#123;</div><div class="line">                    <span class="keyword">int</span> l = j, r = j+i;</div><div class="line">                    <span class="keyword">long</span> <span class="keyword">long</span> local = INF, base = <span class="number">1L</span>L * SZ[l] * SZ[r+<span class="number">1</span>];</div><div class="line">                    <span class="keyword">long</span> <span class="keyword">long</span> *dp1 = dp + l*N, *dp2 = dp + r*N;</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> k = l; k &lt; r; k++) &#123;</div><div class="line">                        <span class="keyword">long</span> <span class="keyword">long</span> t = dp1[k] + dp2[k+<span class="number">1</span>] + SZ[k+<span class="number">1</span>] * base;</div><div class="line">                        <span class="keyword">if</span> (t &lt; local)</div><div class="line">                            local = t;</div><div class="line">                    &#125;</div><div class="line">                    dp1[r] = dp2[l] = local;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, dp[<span class="number">0</span>*N+N<span class="number">-1</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="忘卻快取平行"><a href="#忘卻快取平行" class="headerlink" title="忘卻快取平行"></a>忘卻快取平行</h3><ul>
<li><p>Accepted (4264 ms, 134400 KB)</p>
</li>
<li><p>參考論文 High-perofrmance Energy-efficient Recursive Dynamic Programming with Matrix-multiplication-like Flexible Kernels</p>
</li>
</ul>
<p>最主要的精神 cache-oblivious algorithm 設計，利用大方陣切割成數個小方陣，矩陣跟矩陣之間在足夠小的情況下進行合併計算。算法概述如下：</p>
<p><img src="http://i.imgur.com/38JJ44k.png" alt="cache-oblivious algorithm"></p>
<p>每一個函數參數中的藍色區塊答案算出，而其他參數則是要合併的左矩陣和下矩陣，直到計算大小足夠小時，直接跑序列版本的程式，此時所有陣列可以全部帶進快取，這時候計算變得更加有利。再加上很多層的快取，每一個 CPU 的 cache 重複使用率相當高。</p>
<p>一般的平行度最高只有 $N$，因為我們只針對其中一個迴圈平行，而在 cache-oblivious algorithm 中，平行度最高為 $N^{1.415}$。這些都只是理論分析，實作時為了考慮硬體架構是沒辦法達到理想狀態的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 4096</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXD 6</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXC 64</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> INF (1LL&lt;&lt;62)</span></div><div class="line"><span class="keyword">int</span> N;</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> dp[MAXN*MAXN], SZ[MAXN+<span class="number">5</span>];</div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">MtxHead</span> &#123;</span></div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> *A;</div><div class="line">    <span class="keyword">int</span> bx, by, n;</div><div class="line">&#125; MtxHead;</div><div class="line"></div><div class="line"><span class="function">MtxHead <span class="title">subMtx</span><span class="params">(MtxHead X, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</div><div class="line">    MtxHead T = X;</div><div class="line">    T.n &gt;&gt;= <span class="number">1</span>;</div><div class="line">    <span class="keyword">if</span> (i == <span class="number">2</span>)	T.bx += T.n;</div><div class="line">    <span class="keyword">if</span> (j == <span class="number">2</span>)	T.by += T.n;</div><div class="line">    <span class="keyword">return</span> T;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">min</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> x &lt; y ? x : y;	</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">max</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> x &gt; y ? x : y;	</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="title">loop</span><span class="params">(MtxHead X, MtxHead U, MtxHead V, <span class="keyword">int</span> tl, <span class="keyword">int</span> tr, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> v = INF, t;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> comSZ = SZ[l] * SZ[r+<span class="number">1</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = tl; k &lt; tr; k++) &#123;</div><div class="line">        t = U.A[l*N+k] + V.A[(k+<span class="number">1</span>)+r*N] + SZ[k+<span class="number">1</span>] * comSZ;</div><div class="line">        <span class="keyword">if</span> (t &lt; v)	v = t;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> v;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Cloop</span><span class="params">(MtxHead X, MtxHead U, MtxHead V)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n = X.n, l, r, tl, tr;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> v, t;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = n<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</div><div class="line">            l = X.bx + i, r = X.by + j;</div><div class="line">            v = X.A[l*N+r];</div><div class="line">            </div><div class="line">            tl = max(U.by, X.bx+i), tr = min(U.by+n, X.by+j);</div><div class="line">            t = loop(X, U, V, tl, tr, l, r);</div><div class="line">            <span class="keyword">if</span> (t &lt; v)	v = t;</div><div class="line">            </div><div class="line">            tl = max(V.bx, X.bx+i), tr = min(V.bx+n, X.by+j);</div><div class="line">            t = loop(X, U, V, tl, tr, l, r);</div><div class="line">            <span class="keyword">if</span> (t &lt; v)	v = t;</div><div class="line">            </div><div class="line">            X.A[l*N+r] = X.A[r*N+l] = v;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Bloop</span><span class="params">(MtxHead X, MtxHead U, MtxHead V)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n = X.n, l, r, tl, tr;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> v, t;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = n<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</div><div class="line">            l = X.bx + i, r = X.by + j;</div><div class="line">            v = X.A[l*N+r];</div><div class="line">                        </div><div class="line">            tl = max(U.by+i, X.bx+i), tr = min(U.by+n, X.by+j);</div><div class="line">            t = loop(X, U, V, tl, tr, l, r);</div><div class="line">            <span class="keyword">if</span> (t &lt; v)	v = t;</div><div class="line">            </div><div class="line">            tl = max(V.bx, X.bx+i), tr = min(V.bx+n, X.by+j);</div><div class="line">            t = loop(X, U, V, tl, tr, l, r);</div><div class="line">            <span class="keyword">if</span> (t &lt; v)	v = t;</div><div class="line">            </div><div class="line">            X.A[l*N+r] = X.A[r*N+l] = v;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Aloop</span><span class="params">(MtxHead X)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n = X.n;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j+i &lt; n; j++) &#123;</div><div class="line">            <span class="keyword">int</span> l = X.bx + j, r = X.by + j+i;</div><div class="line">            <span class="keyword">long</span> <span class="keyword">long</span> v = X.A[l*N+r], t;</div><div class="line">            <span class="keyword">long</span> <span class="keyword">long</span> comSZ = SZ[l] * SZ[r+<span class="number">1</span>];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = l; k &lt; r; k++) &#123;</div><div class="line">                t = X.A[l*N+k] + X.A[(k+<span class="number">1</span>)+r*N] + SZ[k+<span class="number">1</span>] * comSZ;</div><div class="line">                <span class="keyword">if</span> (t &lt; v)</div><div class="line">                    v = t;</div><div class="line">            &#125;</div><div class="line">            X.A[l*N+r] = X.A[r*N+l] = v;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Cpar</span><span class="params">(MtxHead X, MtxHead U, MtxHead V, <span class="keyword">int</span> dep)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (X.n &lt;= MAXC) &#123;</div><div class="line">        Cloop(X, U, V);</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">1</span>, <span class="number">1</span>), subMtx(U, <span class="number">1</span>, <span class="number">1</span>), subMtx(V, <span class="number">1</span>, <span class="number">1</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">1</span>, <span class="number">2</span>), subMtx(U, <span class="number">1</span>, <span class="number">1</span>), subMtx(V, <span class="number">1</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">2</span>, <span class="number">1</span>), subMtx(U, <span class="number">2</span>, <span class="number">1</span>), subMtx(V, <span class="number">1</span>, <span class="number">1</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">2</span>, <span class="number">2</span>), subMtx(U, <span class="number">2</span>, <span class="number">1</span>), subMtx(V, <span class="number">1</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp taskwait</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">1</span>, <span class="number">1</span>), subMtx(U, <span class="number">1</span>, <span class="number">2</span>), subMtx(V, <span class="number">2</span>, <span class="number">1</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">1</span>, <span class="number">2</span>), subMtx(U, <span class="number">1</span>, <span class="number">2</span>), subMtx(V, <span class="number">2</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">2</span>, <span class="number">1</span>), subMtx(U, <span class="number">2</span>, <span class="number">2</span>), subMtx(V, <span class="number">2</span>, <span class="number">1</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">2</span>, <span class="number">2</span>), subMtx(U, <span class="number">2</span>, <span class="number">2</span>), subMtx(V, <span class="number">2</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp taskwait</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Bpar</span><span class="params">(MtxHead X, MtxHead U, MtxHead V, <span class="keyword">int</span> dep)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (X.n &lt;= MAXC) &#123;</div><div class="line">        Bloop(X, U, V);</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    Bpar(subMtx(X, <span class="number">2</span>, <span class="number">1</span>), subMtx(U, <span class="number">2</span>, <span class="number">2</span>), subMtx(V, <span class="number">1</span>, <span class="number">1</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">1</span>, <span class="number">1</span>), subMtx(U, <span class="number">1</span>, <span class="number">2</span>), subMtx(X, <span class="number">2</span>, <span class="number">1</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Cpar(subMtx(X, <span class="number">2</span>, <span class="number">2</span>), subMtx(X, <span class="number">2</span>, <span class="number">1</span>), subMtx(V, <span class="number">1</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp taskwait</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Bpar(subMtx(X, <span class="number">1</span>, <span class="number">1</span>), subMtx(U, <span class="number">1</span>, <span class="number">1</span>), subMtx(V, <span class="number">1</span>, <span class="number">1</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Bpar(subMtx(X, <span class="number">2</span>, <span class="number">2</span>), subMtx(U, <span class="number">2</span>, <span class="number">2</span>), subMtx(V, <span class="number">2</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp taskwait</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    Cpar(subMtx(X, <span class="number">1</span>, <span class="number">2</span>), subMtx(U, <span class="number">1</span>, <span class="number">2</span>), subMtx(X, <span class="number">2</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    Cpar(subMtx(X, <span class="number">1</span>, <span class="number">2</span>), subMtx(X, <span class="number">1</span>, <span class="number">1</span>), subMtx(V, <span class="number">1</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    Bpar(subMtx(X, <span class="number">1</span>, <span class="number">2</span>), subMtx(U, <span class="number">1</span>, <span class="number">1</span>), subMtx(V, <span class="number">2</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Apar</span><span class="params">(MtxHead X, <span class="keyword">int</span> dep)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (X.n &lt;= MAXC) &#123;</div><div class="line">        Aloop(X);</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Apar(subMtx(X, <span class="number">1</span>, <span class="number">1</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task <span class="meta-keyword">if</span> (dep &lt; MAXD)</span></div><div class="line">    Apar(subMtx(X, <span class="number">2</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp taskwait</span></div><div class="line">    </div><div class="line">    Bpar(subMtx(X, <span class="number">1</span>, <span class="number">2</span>), subMtx(X, <span class="number">1</span>, <span class="number">1</span>), subMtx(X, <span class="number">2</span>, <span class="number">2</span>), dep+<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Psmall</span><span class="params">(<span class="keyword">int</span> N)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</div><div class="line">        dp[i*N+i] = <span class="number">0</span>;</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = N<span class="number">-1</span>; i &gt; <span class="number">0</span>; i--) &#123;</div><div class="line">            <span class="keyword">int</span> comN = N-i;</div><div class="line">            <span class="meta">#<span class="meta-keyword">pragma</span> omp for</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j++) &#123;</div><div class="line">                <span class="keyword">int</span> l = j, r = comN+j;</div><div class="line">                <span class="keyword">long</span> <span class="keyword">long</span> local = INF;</div><div class="line">                <span class="keyword">long</span> <span class="keyword">long</span> *dp1 = dp+l*N, *dp2 = dp+r*N;</div><div class="line">                <span class="keyword">long</span> <span class="keyword">long</span> comSZ = SZ[l] * SZ[r+<span class="number">1</span>];</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = l; k &lt; r; k++) &#123;</div><div class="line">                    <span class="keyword">long</span> <span class="keyword">long</span> t = dp1[k] + dp2[(k+<span class="number">1</span>)] + comSZ * SZ[k+<span class="number">1</span>];</div><div class="line">                    <span class="keyword">if</span> (t &lt; local)</div><div class="line">                        local = t;</div><div class="line">                &#125;</div><div class="line">                dp[l*N+r] = dp[r*N+l] = local;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, dp[<span class="number">0</span>*N+N<span class="number">-1</span>]);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;N) == <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= N; i++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;SZ[i]);</div><div class="line">        <span class="keyword">if</span> (N &lt;= <span class="number">2048</span>) &#123;</div><div class="line">        	Psmall(N);</div><div class="line">        	<span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> ON = N;</div><div class="line">        <span class="keyword">while</span> ((N&amp;(-N)) != N)</div><div class="line">            N++;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">        	<span class="keyword">for</span> (<span class="keyword">int</span> j = i+<span class="number">1</span>; j &lt; N; j++)</div><div class="line">        		dp[i*N+j] = INF;</div><div class="line">            dp[i*N+i] = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        MtxHead X;</div><div class="line">        X.n = N, X.bx = X.by = <span class="number">0</span>, X.A = dp;</div><div class="line">        <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></div><div class="line">        &#123;</div><div class="line">        	<span class="meta">#<span class="meta-keyword">pragma</span> omp single</span></div><div class="line">        	Apar(X, <span class="number">0</span>);</div><div class="line">    	&#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, dp[<span class="number">0</span>*N+ON<span class="number">-1</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-jg-10113" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/28/jg-10113/" class="article-date">
  <time datetime="2016-06-28T05:36:40.000Z" itemprop="datePublished">2016-06-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/平行程式/">平行程式</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/28/jg-10113/">批改娘 10113. Longest Common Subsequence II (CUDA)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/06/28/jg-10113/" data-id="ckroajbfl009epkvnsnziintd" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/06/28/jg-10113/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CUDA/">CUDA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DP/">DP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hirschberg-s-algorithm/">Hirschberg's algorithm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LCS/">LCS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/批改娘/">批改娘</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h2><p>給兩個字串 $X, \; Y$，在兩個字串中都有出現且最長的子序列 (subsequence)，就是最長共同子字串<br>。</p>
<h2 id="輸入格式"><a href="#輸入格式" class="headerlink" title="輸入格式"></a>輸入格式</h2><p>有多組測資，每組測資有兩行字串 $X, \; Y$，$X, \; Y$ 只由 <code>A</code> <code>T</code> <code>C</code> <code>G</code> 四個字母構成。</p>
<ul>
<li>$1 \le |X|, |Y| \le 60000$</li>
</ul>
<h2 id="輸出格式"><a href="#輸出格式" class="headerlink" title="輸出格式"></a>輸出格式</h2><p>針對每一組測資，輸出一行 $X, \; Y$ 的最長共同子字串長度以及任何一組最長共同子字串。</p>
<h2 id="範例輸入"><a href="#範例輸入" class="headerlink" title="範例輸入"></a>範例輸入</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">TCA</div><div class="line">GTA</div><div class="line">TGGAC</div><div class="line">TATCT</div></pre></td></tr></table></figure>
<h2 id="範例輸出"><a href="#範例輸出" class="headerlink" title="範例輸出"></a>範例輸出</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2</div><div class="line">TA</div><div class="line">3</div><div class="line">TAC</div></pre></td></tr></table></figure>
<h2 id="編譯參數"><a href="#編譯參數" class="headerlink" title="編譯參數"></a>編譯參數</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ nvcc -Xcompiler &quot;-O2 -fopenmp&quot; main.cu -o main</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>附錄為舊版設計，可以針對 OpenMP 的設計再重新設計 CUDA 版本。</p>
<p>舊版設計根據 CPU 平行與不平行以及 GPU 三種狀態，根據閥值決定要選擇運行哪一種版本。若加上足夠小的情況下，直接用 $O(N^2)$ 表格直接回溯，和 OpenMP 判斷閥值的公式，效能還能在加速個兩到三倍，但整體而言未必比純 OpenMP 還要快，因為有 GPU 啟動的 overhead，要跑夠多的測資才看得出來。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div></pre></td><td class="code"><pre><div class="line">#include &lt;cstdio&gt;</div><div class="line">#include &lt;cstdlib&gt;</div><div class="line">#include &lt;algorithm&gt;</div><div class="line">#include &lt;omp.h&gt;</div><div class="line">using namespace std;</div><div class="line">#define MAXN 60005</div><div class="line">#define CHARSET 4</div><div class="line">#define max(x, y) (x) &gt; (y) ? (x) : (y)</div><div class="line">typedef unsigned short uint16;</div><div class="line">static char A[MAXN], B[MAXN];</div><div class="line">static int c2i[128];</div><div class="line">static char i2c[CHARSET+1] = &quot;ACGT&quot;;</div><div class="line">static int *cuP;</div><div class="line">static char *cuB;</div><div class="line">static uint16 *cuDP;</div><div class="line">__global__ void prepare(int *P, char *B, int nb) &#123;</div><div class="line">    int i = threadIdx.x;</div><div class="line">    int *p = P + i*MAXN;</div><div class="line">    char c = &quot;ACGT&quot;[i];</div><div class="line">    p[0] = 0;</div><div class="line">    for (int j = 1; j &lt;= nb; j++)</div><div class="line">        p[j] = (B[j] == c) ? j : p[j-1];</div><div class="line">&#125;</div><div class="line">__global__ void run(int nb, uint16 *dpIn, uint16 *dpOut, int *P) &#123;</div><div class="line">    int j = blockDim.x*blockIdx.x+threadIdx.x+1;</div><div class="line">    if (j &gt; nb)    return ;</div><div class="line">    int pos = P[j];</div><div class="line">    uint16 t1 = pos ? dpIn[pos-1]+1 : 0;</div><div class="line">    uint16 t2 = dpIn[j];</div><div class="line">    dpOut[j] = t1 &gt; t2 ? t1 : t2;</div><div class="line">&#125;</div><div class="line">int lcs_len_seq(const char *A, int na, const char *B, int nb, uint16 dpf[]) &#123;</div><div class="line">    static uint16 dp[2][MAXN];</div><div class="line">    memset(dp[0], 0, sizeof(uint16)*(nb+1));</div><div class="line">    dp[1][0] = 0, dpf[0] = 0;</div><div class="line">    for (int i = 1; i &lt;= na; i++) &#123;</div><div class="line">        for (int j = 1; j &lt;= nb; j++) &#123;</div><div class="line">            if (A[i-1] == B[j-1])</div><div class="line">                dp[1][j] = dp[0][j-1]+1;</div><div class="line">            else</div><div class="line">                dp[1][j] = max(dp[1][j-1], dp[0][j]);</div><div class="line">        &#125;</div><div class="line">        memcpy(dp[0], dp[1], sizeof(uint16)*(nb+1));</div><div class="line">    &#125;</div><div class="line">    for (int i = 0; i &lt;= nb; i++)</div><div class="line">        dpf[i] = dp[0][i];</div><div class="line">    return dpf[nb];</div><div class="line">&#125;</div><div class="line">int lcs_len_omp(const char *A, int na, const char *B, int nb, uint16 dpf[]) &#123;</div><div class="line">    static int P[CHARSET][MAXN];</div><div class="line">    static uint16 dp[2][MAXN];</div><div class="line">    A--, B--;</div><div class="line">#pragma omp parallel for</div><div class="line">    for (int i = 0; i &lt; CHARSET; i++) &#123;</div><div class="line">        memset(P[i], 0, sizeof(int)*(nb+1));</div><div class="line">        for (int j = 1; j &lt;= nb; j++)</div><div class="line">            P[i][j] = (B[j] == i2c[i])? j : P[i][j-1];</div><div class="line">    &#125;</div><div class="line">    for (int i = 0; i &lt; 2; i++)</div><div class="line">        memset(dp[i], 0, sizeof(uint16)*(nb+1));</div><div class="line">#pragma omp parallel</div><div class="line">    for (int i = 1; i &lt;= na; i++) &#123;</div><div class="line">        int *Pv = P[c2i[A[i]]];</div><div class="line">#pragma omp for</div><div class="line">        for (int j = 1; j &lt;= nb; j++) &#123;</div><div class="line">            int last_match = Pv[j];</div><div class="line">            uint16 tmp = last_match ? dp[i&amp;1^1][last_match-1]+1 : 0;</div><div class="line">            dp[i&amp;1][j] = max(dp[i&amp;1^1][j], tmp);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    for (int i = 0; i &lt;= nb; i++)</div><div class="line">        dpf[i] = dp[na&amp;1][i];</div><div class="line">    return dpf[nb];</div><div class="line">&#125;</div><div class="line">int lcs_len(const char *A, int na, const char *B, int nb, uint16 dpf[]) &#123;</div><div class="line">    if (max(na, nb) &lt; 2048)</div><div class="line">        return lcs_len_seq(A, na, B, nb, dpf);</div><div class="line">    if (nb &lt; 10000)</div><div class="line">        return lcs_len_omp(A, na, B, nb, dpf);</div><div class="line">    B--;</div><div class="line">    cudaMemcpy(cuB, B, sizeof(char)*(nb+1), cudaMemcpyHostToDevice);</div><div class="line">    cudaMemset(cuDP, 0, sizeof(uint16)*(nb+1));</div><div class="line">    cudaMemset(cuDP+MAXN, 0, sizeof(uint16)*(nb+1));</div><div class="line"></div><div class="line">    int bsz = 1024;</div><div class="line">    dim3 bb(bsz);</div><div class="line">    dim3 gg((nb+bsz-1)/bsz);</div><div class="line">    prepare&lt;&lt;&lt;1, 4&gt;&gt;&gt;(cuP, cuB, nb);</div><div class="line">    for (int i = 0; i &lt; na; i++) &#123;</div><div class="line">        int v = c2i[A[i]];</div><div class="line">        run&lt;&lt;&lt;gg, bb&gt;&gt;&gt;(nb, cuDP+(i&amp;1)*MAXN, cuDP+((i&amp;1)^1)*MAXN, cuP+v*MAXN);</div><div class="line">    &#125;</div><div class="line">    cudaMemcpy(dpf, cuDP+(na&amp;1)*MAXN, sizeof(uint16)*(nb+1), cudaMemcpyDeviceToHost);</div><div class="line">    return dpf[nb];</div><div class="line">&#125;</div><div class="line">char* alloc_str(int sz) &#123;</div><div class="line">    return (char *) calloc(sz, sizeof(char));</div><div class="line">&#125;</div><div class="line">char* substr(const char *s, int pos, int len) &#123;</div><div class="line">    char *t = alloc_str(len+1);</div><div class="line">    memcpy(t, s+pos, len);</div><div class="line">    return t;</div><div class="line">&#125;</div><div class="line">char* cat(const char *sa, const char *sb) &#123;</div><div class="line">    int na = strlen(sa), nb = strlen(sb);</div><div class="line">    char *t = alloc_str(na + nb + 1);</div><div class="line">    memcpy(t, sa, na);</div><div class="line">    memcpy(t+na, sb, nb);</div><div class="line">    return t;</div><div class="line">&#125;</div><div class="line">char* reverse(const char *s, int len) &#123;</div><div class="line">    char *t = substr(s, 0, len);</div><div class="line">    char *l = t, *r = t + len - 1;</div><div class="line">    char tmp;</div><div class="line">    while (l &lt; r) &#123;</div><div class="line">        tmp = *l, *l = *r, *r = tmp;</div><div class="line">        l++, r--;</div><div class="line">    &#125;</div><div class="line">    return t;</div><div class="line">&#125;</div><div class="line">char* find_lcs(const char *a, int na, const char *b, int nb) &#123;</div><div class="line">    if (na &gt; nb) &#123;</div><div class="line">        const char *c; int t;</div><div class="line">        c = a, a = b, b = c;</div><div class="line">        t = na, na = nb, nb = t;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (na == 0)</div><div class="line">        return alloc_str(1);</div><div class="line"></div><div class="line">    if (na == 1) &#123;</div><div class="line">        for (int i = 0; i &lt; nb; i++) &#123;</div><div class="line">            if (a[0] == b[i])</div><div class="line">                return substr(a, 0, 1);</div><div class="line">        &#125;</div><div class="line">        return alloc_str(1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    static uint16 t1[MAXN];</div><div class="line">    static uint16 t2[MAXN];</div><div class="line">    int len = lcs_len(a, na, b, nb, t1);</div><div class="line">    if (len == 0)</div><div class="line">        return alloc_str(1);</div><div class="line">    int half_len = na / 2;</div><div class="line">    char *la = substr(a, 0, half_len);</div><div class="line">    char *ra = substr(a, half_len, na - half_len);</div><div class="line">    char *tb = reverse(b, nb);</div><div class="line">    char *ta = reverse(ra, na - half_len);</div><div class="line">    lcs_len(la, half_len, b, nb, t1);</div><div class="line">    lcs_len(ta, na - half_len, tb, nb, t2);</div><div class="line"></div><div class="line">    int split = -1;</div><div class="line">    for (int i = 0; i &lt;= nb; i++) &#123;</div><div class="line">        if (t1[i] + t2[nb-i] == len) &#123;</div><div class="line">            split = i;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    char *lb = substr(b, 0, split);</div><div class="line">    char *rb = substr(b, split, nb - split);</div><div class="line">    char *sl = find_lcs(la, half_len, lb, split);</div><div class="line">    char *sr = find_lcs(ra, na - half_len, rb, nb - split);</div><div class="line">    char *ret = cat(sl, sr);</div><div class="line">    free(la), free(ra), free(ta);</div><div class="line">    free(lb), free(rb), free(tb);</div><div class="line">    free(sl), free(sr);</div><div class="line">    return ret;</div><div class="line">&#125;</div><div class="line">int main() &#123;</div><div class="line">    for (int i = 0; i &lt; CHARSET; i++)</div><div class="line">        c2i[i2c[i]] = i;</div><div class="line">    cudaMalloc(&amp;cuB, sizeof(char)*MAXN);</div><div class="line">    cudaMalloc(&amp;cuP, sizeof(int)*MAXN*4);</div><div class="line">    cudaMalloc(&amp;cuDP, sizeof(uint16)*MAXN*2);</div><div class="line">    static uint16 dpf[MAXN];</div><div class="line">    while (scanf(&quot;%s %s&quot;, A, B) == 2) &#123;</div><div class="line">        int na = strlen(A);</div><div class="line">        int nb = strlen(B);</div><div class="line">        int len = lcs_len(A, na, B, nb, dpf);</div><div class="line">        char *str = find_lcs(A, na, B, nb);</div><div class="line">        printf(&quot;%d\n&quot;, len);</div><div class="line">        printf(&quot;%s\n&quot;, str);</div><div class="line">        free(str);	</div><div class="line">    &#125;</div><div class="line">    cudaFree(cuB);</div><div class="line">    cudaFree(cuP);</div><div class="line">    cudaFree(cuDP);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-jg-10112" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/28/jg-10112/" class="article-date">
  <time datetime="2016-06-28T05:29:26.000Z" itemprop="datePublished">2016-06-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/平行程式/">平行程式</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/28/jg-10112/">批改娘 10112. Longest Common Subsequence (CUDA)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/06/28/jg-10112/" data-id="ckroajbfg0092pkvnxopgekq7" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/06/28/jg-10112/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CUDA/">CUDA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DP/">DP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LCS/">LCS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/批改娘/">批改娘</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h2><p>給兩個字串 $X, \; Y$，在兩個字串中都有出現且最長的子序列 (subsequence)，就是最長共同子字串<br>。</p>
<h2 id="輸入格式"><a href="#輸入格式" class="headerlink" title="輸入格式"></a>輸入格式</h2><p>有多組測資，每組測資有兩行字串 $X, \; Y$，$X, \; Y$ 只由 <code>A</code> <code>T</code> <code>C</code> <code>G</code> 四個字母構成。</p>
<ul>
<li>$1 \le |X|, |Y| \le 60000$</li>
</ul>
<h2 id="輸出格式"><a href="#輸出格式" class="headerlink" title="輸出格式"></a>輸出格式</h2><p>針對每一組測資，輸出一行 $X, \; Y$ 的最長共同子字串長度。</p>
<h2 id="範例輸入"><a href="#範例輸入" class="headerlink" title="範例輸入"></a>範例輸入</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">TCA</div><div class="line">GTA</div><div class="line">TGGAC</div><div class="line">TATCT</div></pre></td></tr></table></figure>
<h2 id="範例輸出"><a href="#範例輸出" class="headerlink" title="範例輸出"></a>範例輸出</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">2</div><div class="line">3</div></pre></td></tr></table></figure>
<h2 id="編譯參數"><a href="#編譯參數" class="headerlink" title="編譯參數"></a>編譯參數</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ nvcc -Xcompiler &quot;-O2 -fopenmp&quot; main.cu -o main</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>相比於 OpenMP 版本，由於 GPU 的快取設計不如 CPU，在我們使用失敗指針優化 branch 的發生，對 GPU 反而還是慢的，因為要存取 global memory，這使得還不如發生 branch，讓 warp 分多次跑反而比較快，因為有足夠多的 warp 在一個 block。在優化程度上，CPU 和 GPU 還是得分開解決。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 60005</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> CHARSET 4</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> uint16;</div><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> A[MAXN], B[MAXN];</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> c2i[<span class="number">128</span>];</div><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> i2c[CHARSET+<span class="number">1</span>] = <span class="string">"ACGT"</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> *cuP;</div><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> *cuB;</div><div class="line"><span class="keyword">static</span> uint16 *cuDP;</div><div class="line">__<span class="function">global__ <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">int</span> *P, <span class="keyword">char</span> *B, <span class="keyword">int</span> nb)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> i = threadIdx.x;</div><div class="line">    <span class="keyword">int</span> *p = P + i*MAXN;</div><div class="line">    <span class="keyword">char</span> c = <span class="string">"ACGT"</span>[i];</div><div class="line">    p[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= nb; j++)</div><div class="line">        p[j] = (B[j] == c) ? j : p[j<span class="number">-1</span>];</div><div class="line">&#125;</div><div class="line">__<span class="function">global__ <span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">int</span> nb, uint16 *dpIn, uint16 *dpOut, <span class="keyword">int</span> *P)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> j = blockDim.x*blockIdx.x+threadIdx.x+<span class="number">1</span>;</div><div class="line">    <span class="keyword">if</span> (j &gt; nb)	<span class="keyword">return</span> ;</div><div class="line">    <span class="keyword">int</span> pos = P[j];</div><div class="line">    uint16 t1 = pos ? dpIn[pos<span class="number">-1</span>]+<span class="number">1</span> : <span class="number">0</span>;</div><div class="line">    uint16 t2 = dpIn[j];</div><div class="line">    dpOut[j] = t1 &gt; t2 ? t1 : t2;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">lcs_len</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *A, <span class="keyword">int</span> na, <span class="keyword">const</span> <span class="keyword">char</span> *B, <span class="keyword">int</span> nb, uint16 dpf[])</span> </span>&#123;</div><div class="line">    B--;</div><div class="line">    cudaMemcpy(cuB, B, <span class="keyword">sizeof</span>(<span class="keyword">char</span>)*(nb+<span class="number">1</span>), cudaMemcpyHostToDevice);</div><div class="line">    cudaMemset(cuDP, <span class="number">0</span>, <span class="keyword">sizeof</span>(uint16)*(nb+<span class="number">1</span>));</div><div class="line">    cudaMemset(cuDP+MAXN, <span class="number">0</span>, <span class="keyword">sizeof</span>(uint16)*(nb+<span class="number">1</span>));</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> bsz = <span class="number">1024</span>;</div><div class="line">    <span class="function">dim3 <span class="title">bb</span><span class="params">(bsz)</span></span>;</div><div class="line">    dim3 gg((nb+bsz-1)/bsz);</div><div class="line">    prepare&lt;&lt;&lt;<span class="number">1</span>, <span class="number">4</span>&gt;&gt;&gt;(cuP, cuB, nb);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; na; i++) &#123;</div><div class="line">        <span class="keyword">int</span> v = c2i[A[i]];</div><div class="line">        run&lt;&lt;&lt;gg, bb&gt;&gt;&gt;(nb, cuDP+(i&amp;<span class="number">1</span>)*MAXN, cuDP+((i&amp;<span class="number">1</span>)^<span class="number">1</span>)*MAXN, cuP+v*MAXN);</div><div class="line">    &#125;</div><div class="line">    cudaMemcpy(dpf, cuDP+(na&amp;<span class="number">1</span>)*MAXN, <span class="keyword">sizeof</span>(uint16)*(nb+<span class="number">1</span>), cudaMemcpyDeviceToHost);</div><div class="line">    <span class="keyword">return</span> dpf[nb];</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CHARSET; i++)</div><div class="line">        c2i[i2c[i]] = i;</div><div class="line">    cudaMalloc(&amp;cuB, <span class="keyword">sizeof</span>(<span class="keyword">char</span>)*MAXN);</div><div class="line">    cudaMalloc(&amp;cuP, <span class="keyword">sizeof</span>(<span class="keyword">int</span>)*MAXN*<span class="number">4</span>);</div><div class="line">    cudaMalloc(&amp;cuDP, <span class="keyword">sizeof</span>(uint16)*MAXN*<span class="number">2</span>);</div><div class="line">    <span class="keyword">static</span> uint16 dpf[MAXN];</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%s %s"</span>, A, B) == <span class="number">2</span>) &#123;</div><div class="line">        <span class="keyword">int</span> len = lcs_len(A, <span class="built_in">strlen</span>(A), B, <span class="built_in">strlen</span>(B), dpf);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, len);</div><div class="line">    &#125;</div><div class="line">    cudaFree(cuB);</div><div class="line">    cudaFree(cuP);</div><div class="line">    cudaFree(cuDP);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-jg-10111" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/28/jg-10111/" class="article-date">
  <time datetime="2016-06-28T05:08:57.000Z" itemprop="datePublished">2016-06-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/平行程式/">平行程式</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/28/jg-10111/">批改娘 10111. Longest Common Subsequence II (OpenMP)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2016/06/28/jg-10111/" data-id="ckroajbfa008mpkvnane7lzxk" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2016/06/28/jg-10111/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DP/">DP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hirschberg-s-algorithm/">Hirschberg's algorithm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LCS/">LCS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenMP/">OpenMP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/批改娘/">批改娘</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="題目描述"><a href="#題目描述" class="headerlink" title="題目描述"></a>題目描述</h2><p>給兩個字串 $X, \; Y$，在兩個字串中都有出現且最長的子序列 (subsequence)，就是最長共同子字串<br>。</p>
<h2 id="輸入格式"><a href="#輸入格式" class="headerlink" title="輸入格式"></a>輸入格式</h2><p>有多組測資，每組測資有兩行字串 $X, \; Y$，$X, \; Y$ 只由 <code>A</code> <code>T</code> <code>C</code> <code>G</code> 四個字母構成。</p>
<ul>
<li>$1 \le |X|, |Y| \le 60000$</li>
</ul>
<h2 id="輸出格式"><a href="#輸出格式" class="headerlink" title="輸出格式"></a>輸出格式</h2><p>針對每一組測資，輸出一行 $X, \; Y$ 的最長共同子字串長度以及任何一組最長共同子字串。</p>
<h2 id="範例輸入"><a href="#範例輸入" class="headerlink" title="範例輸入"></a>範例輸入</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">TCA</div><div class="line">GTA</div><div class="line">TGGAC</div><div class="line">TATCT</div></pre></td></tr></table></figure>
<h2 id="範例輸出"><a href="#範例輸出" class="headerlink" title="範例輸出"></a>範例輸出</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2</div><div class="line">TA</div><div class="line">3</div><div class="line">TAC</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>雖然我們都知道數據小時，由於有 $O(N^2)$ 大小的表可以協助回溯找解，但當 $N$ 非常大時，就無法儲存這張表。因此，可以採用分治算法找到這一張表，也就是所謂的 Hirschberg’s algorithm，相關的 <a href="http://www.mathcs.emory.edu/~cheung/Courses/323/Syllabus/DynProg/Herschberg2.html" target="_blank" rel="external">demo</a> 在此。</p>
<p>時間複雜度為 <span>$O(N \log N)$</span><!-- Has MathJax -->，空間複雜度為 <span>$O(N)$</span><!-- Has MathJax -->，平行部分可以採用 fine-grain 設計，那麼就會有不斷建立 thread 的 overhead，但更容易處於負載平衡 (workload balance)。另一種則是在遞迴分治下，拆成好幾個 thread 完成各自部分，這樣比較容易觸發 cache 的性質。</p>
<p>從實作中，fine-grain 比 coarse-grain 好上許多。</p>
<h3 id="fine-grain"><a href="#fine-grain" class="headerlink" title="fine-grain"></a>fine-grain</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;omp.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 60005</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXSEQ 500</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> CHARSET 4</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> max(x, y) (x) &gt; (y) ? (x) : (y)</span></div><div class="line"><span class="keyword">static</span> __thread <span class="keyword">int</span> c2i[<span class="number">128</span>] = &#123;[<span class="string">'A'</span>] = <span class="number">0</span>, [<span class="string">'C'</span>] = <span class="number">1</span>, [<span class="string">'G'</span>] = <span class="number">2</span>, [<span class="string">'T'</span>] = <span class="number">3</span>&#125;;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">lcs_len</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *A, <span class="keyword">int</span> na, <span class="keyword">const</span> <span class="keyword">char</span> *B, <span class="keyword">int</span> nb, <span class="keyword">int</span> inv_flag, <span class="keyword">int</span> dpf[])</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> P[CHARSET][MAXN];</div><div class="line">    <span class="keyword">int</span> dp[<span class="number">2</span>][MAXN] = &#123;&#125;;</div><div class="line">    A--, B--;</div><div class="line">    <span class="keyword">if</span> (!inv_flag) &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CHARSET; i++) &#123;</div><div class="line">            P[i][<span class="number">0</span>] = nb+<span class="number">1</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= nb; j++)</div><div class="line">                P[i][j] = (B[j] == <span class="string">"ACGT"</span>[i]) ? j<span class="number">-1</span> : P[i][j<span class="number">-1</span>];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</div><div class="line">            dp[i][nb+<span class="number">1</span>] = <span class="number">-1</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= na; i++) &#123;</div><div class="line">            <span class="keyword">int</span> *Pv = P[c2i[A[i]]];</div><div class="line">            <span class="keyword">int</span> *dpIn = dp[i&amp;<span class="number">1</span>^<span class="number">1</span>];</div><div class="line">            <span class="keyword">int</span> *dpOut = dp[i&amp;<span class="number">1</span>];</div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp for</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= nb; j++) &#123;</div><div class="line">                <span class="keyword">int</span> t1 = dpIn[Pv[j]]+<span class="number">1</span>;</div><div class="line">                <span class="keyword">int</span> t2 = dpIn[j];</div><div class="line">                dpOut[j] = t1 &gt; t2 ? t1 : t2;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">memcpy</span>(dpf, dp[na&amp;<span class="number">1</span>], <span class="keyword">sizeof</span>(<span class="keyword">int</span>)*(nb+<span class="number">1</span>));</div><div class="line">        dpf[nb+<span class="number">1</span>] = dpf[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">        <span class="keyword">return</span> dpf[nb];</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// inverse version	</span></div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CHARSET; i++) &#123;</div><div class="line">        P[i][nb+<span class="number">1</span>] = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = nb; j &gt;= <span class="number">1</span>; j--)</div><div class="line">            P[i][j] = (B[j] == <span class="string">"ACGT"</span>[i]) ? j+<span class="number">1</span> : P[i][j+<span class="number">1</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</div><div class="line">        dp[i][<span class="number">0</span>] = <span class="number">-1</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = na; i &gt;= <span class="number">1</span>; i--) &#123;</div><div class="line">        <span class="keyword">int</span> *Pv = P[c2i[A[i]]];</div><div class="line">        <span class="keyword">int</span> *dpIn = dp[i&amp;<span class="number">1</span>^<span class="number">1</span>];</div><div class="line">        <span class="keyword">int</span> *dpOut = dp[i&amp;<span class="number">1</span>];</div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp for</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= nb; j++) &#123;</div><div class="line">            <span class="keyword">int</span> t1 = dpIn[Pv[j]]+<span class="number">1</span>;</div><div class="line">            <span class="keyword">int</span> t2 = dpIn[j];</div><div class="line">            dpOut[j] = t1 &gt; t2 ? t1 : t2;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">memcpy</span>(dpf, dp[<span class="number">1</span>&amp;<span class="number">1</span>], <span class="keyword">sizeof</span>(<span class="keyword">int</span>)*(nb+<span class="number">1</span>));</div><div class="line">    dpf[nb+<span class="number">1</span>] = dpf[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">    <span class="keyword">return</span> dpf[nb];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">char</span>* <span class="title">alloc_str</span><span class="params">(<span class="keyword">int</span> sz)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (<span class="keyword">char</span> *) <span class="built_in">calloc</span>(sz, <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">char</span>* <span class="title">substr</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s, <span class="keyword">int</span> pos, <span class="keyword">int</span> len)</span> </span>&#123;</div><div class="line">    <span class="keyword">char</span> *t = alloc_str(len+<span class="number">1</span>);</div><div class="line">    <span class="built_in">memcpy</span>(t, s+pos, len);</div><div class="line">    <span class="keyword">return</span> t;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">char</span>* <span class="title">cat</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *sa, <span class="keyword">const</span> <span class="keyword">char</span> *sb)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> na = <span class="built_in">strlen</span>(sa), nb = <span class="built_in">strlen</span>(sb);</div><div class="line">    <span class="keyword">char</span> *t = alloc_str(na + nb + <span class="number">1</span>);</div><div class="line">    <span class="built_in">memcpy</span>(t, sa, na);</div><div class="line">    <span class="built_in">memcpy</span>(t+na, sb, nb);</div><div class="line">    <span class="keyword">return</span> t;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">char</span>* <span class="title">find_lcs_seq</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *A, <span class="keyword">int</span> na, <span class="keyword">const</span> <span class="keyword">char</span> *B, <span class="keyword">int</span> nb)</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> P[CHARSET][MAXSEQ];</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> fa[MAXSEQ][MAXSEQ];</div><div class="line">    <span class="keyword">int</span> dp[<span class="number">2</span>][MAXSEQ] = &#123;&#125;;</div><div class="line">    A--, B--;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CHARSET; i++) &#123;</div><div class="line">        P[i][<span class="number">0</span>] = nb+<span class="number">1</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= nb; j++)</div><div class="line">            P[i][j] = (B[j] == <span class="string">"ACGT"</span>[i]) ? j<span class="number">-1</span> : P[i][j<span class="number">-1</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</div><div class="line">        dp[i][nb+<span class="number">1</span>] = <span class="number">-1</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= na; i++) &#123;</div><div class="line">        <span class="keyword">int</span> *Pv = P[c2i[A[i]]];</div><div class="line">        <span class="keyword">int</span> *dpIn = dp[i&amp;<span class="number">1</span>^<span class="number">1</span>];</div><div class="line">        <span class="keyword">int</span> *dpOut = dp[i&amp;<span class="number">1</span>];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= nb; j++) &#123;</div><div class="line">            <span class="keyword">int</span> t1 = dpIn[Pv[j]]+<span class="number">1</span>;</div><div class="line">            <span class="keyword">int</span> t2 = dpIn[j];</div><div class="line">            <span class="keyword">if</span> (t1 &gt; t2)</div><div class="line">                dpOut[j] = t1, fa[i][j] = <span class="number">0</span>;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                dpOut[j] = t2, fa[i][j] = <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> sz = dp[na&amp;<span class="number">1</span>][nb];</div><div class="line">    <span class="keyword">char</span> *ret = alloc_str(sz+<span class="number">1</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = na, j = nb; sz &amp;&amp; i &gt;= <span class="number">1</span>; i--) &#123;</div><div class="line">        <span class="keyword">if</span> (fa[i][j] == <span class="number">0</span>)</div><div class="line">            ret[--sz] = A[i], j = P[c2i[A[i]]][j];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">char</span>* <span class="title">find_lcs</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *a, <span class="keyword">int</span> na, <span class="keyword">const</span> <span class="keyword">char</span> *b, <span class="keyword">int</span> nb)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (na &gt; nb) &#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *c; <span class="keyword">int</span> t;</div><div class="line">        c = a, a = b, b = c;</div><div class="line">        t = na, na = nb, nb = t;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (na == <span class="number">0</span>)</div><div class="line">        <span class="keyword">return</span> alloc_str(<span class="number">1</span>);</div><div class="line">    <span class="keyword">if</span> (na &lt; MAXSEQ &amp;&amp; nb &lt; MAXSEQ)</div><div class="line">        <span class="keyword">return</span> find_lcs_seq(a, na, b, nb);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> t1[MAXN];</div><div class="line">    <span class="keyword">int</span> t2[MAXN];</div><div class="line">    <span class="keyword">int</span> len = <span class="number">-1</span>;</div><div class="line">    <span class="keyword">int</span> half_len = na / <span class="number">2</span>;</div><div class="line">    <span class="keyword">char</span> *la = substr(a, <span class="number">0</span>, half_len);</div><div class="line">    <span class="keyword">char</span> *ra = substr(a, half_len, na - half_len);</div><div class="line">    lcs_len(la, half_len, b, nb, <span class="number">0</span>, t1);</div><div class="line">    lcs_len(ra, na - half_len, b, nb, <span class="number">1</span>, t2);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> split = <span class="number">-1</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= nb; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (t1[i] + t2[i+<span class="number">1</span>] &gt; len)</div><div class="line">            split = i, len = t1[i] + t2[i+<span class="number">1</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (len == <span class="number">0</span>) </div><div class="line">        <span class="keyword">return</span> alloc_str(<span class="number">1</span>);</div><div class="line">    assert(split != <span class="number">-1</span>);</div><div class="line">    <span class="keyword">char</span> *lb = substr(b, <span class="number">0</span>, split);</div><div class="line">    <span class="keyword">char</span> *rb = substr(b, split, nb - split);</div><div class="line">    <span class="keyword">char</span> *sl = t1[split] ? find_lcs(la, half_len, lb, split) : alloc_str(<span class="number">1</span>);</div><div class="line">    <span class="keyword">char</span> *sr = t2[split+<span class="number">1</span>] ? find_lcs(ra, na - half_len, rb, nb - split) : alloc_str(<span class="number">1</span>);</div><div class="line">    <span class="keyword">char</span> *ret = cat(sl, sr);</div><div class="line">    <span class="built_in">free</span>(la), <span class="built_in">free</span>(ra);</div><div class="line">    <span class="built_in">free</span>(lb), <span class="built_in">free</span>(rb);</div><div class="line">    <span class="built_in">free</span>(sl), <span class="built_in">free</span>(sr);</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> A[MAXN], B[MAXN];</div><div class="line">    <span class="keyword">int</span> dp[MAXN];</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%s %s"</span>, A, B) == <span class="number">2</span>) &#123;</div><div class="line">        <span class="keyword">int</span> na = <span class="built_in">strlen</span>(A);</div><div class="line">        <span class="keyword">int</span> nb = <span class="built_in">strlen</span>(B);</div><div class="line">        <span class="keyword">char</span> *str = find_lcs(A, na, B, nb);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, <span class="built_in">strlen</span>(str));</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, str);</div><div class="line">        <span class="built_in">free</span>(str);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="coarse-grain"><a href="#coarse-grain" class="headerlink" title="coarse-grain"></a>coarse-grain</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;omp.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 60005</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> CHARSET 4</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> max(x, y) (x) &gt; (y) ? (x) : (y)</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> uint16;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">lcs_len_seq</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *A, <span class="keyword">int</span> na, <span class="keyword">const</span> <span class="keyword">char</span> *B, <span class="keyword">int</span> nb, <span class="keyword">int</span> dpf[])</span> </span>&#123;</div><div class="line">    uint16 dp[<span class="number">2</span>][MAXN];</div><div class="line">    <span class="built_in">memset</span>(dp[<span class="number">0</span>], <span class="number">0</span>, <span class="keyword">sizeof</span>(uint16)*(nb+<span class="number">1</span>));</div><div class="line">    dp[<span class="number">1</span>][<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= na; i++) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= nb; j++) &#123;</div><div class="line">            <span class="keyword">if</span> (A[i<span class="number">-1</span>] == B[j<span class="number">-1</span>])</div><div class="line">                dp[<span class="number">1</span>][j] = dp[<span class="number">0</span>][j<span class="number">-1</span>]+<span class="number">1</span>;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                dp[<span class="number">1</span>][j] = max(dp[<span class="number">1</span>][j<span class="number">-1</span>], dp[<span class="number">0</span>][j]);</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">memcpy</span>(dp[<span class="number">0</span>], dp[<span class="number">1</span>], <span class="keyword">sizeof</span>(uint16)*(nb+<span class="number">1</span>));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= nb; i++)</div><div class="line">        dpf[i] = dp[<span class="number">0</span>][i];</div><div class="line">    <span class="keyword">return</span> dpf[nb];</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">lcs_len</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *A, <span class="keyword">int</span> na, <span class="keyword">const</span> <span class="keyword">char</span> *B, <span class="keyword">int</span> nb, <span class="keyword">int</span> dpf[])</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (nb &lt; <span class="number">256</span>)</div><div class="line">        <span class="keyword">return</span> lcs_len_seq(A, na, B, nb, dpf);</div><div class="line">    <span class="keyword">int</span> c2i[<span class="number">128</span>] = &#123;[<span class="string">'A'</span>] = <span class="number">0</span>, [<span class="string">'C'</span>] = <span class="number">1</span>, [<span class="string">'G'</span>] = <span class="number">2</span>, [<span class="string">'T'</span>] = <span class="number">3</span>&#125;;</div><div class="line">    <span class="keyword">char</span> i2c[CHARSET] = &#123;<span class="string">'A'</span>, <span class="string">'C'</span>, <span class="string">'G'</span>, <span class="string">'T'</span>&#125;;</div><div class="line">    <span class="keyword">int</span> P[CHARSET][MAXN];</div><div class="line">    uint16 dp[<span class="number">2</span>][MAXN];</div><div class="line">    A--, B--;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CHARSET; i++) &#123;</div><div class="line">        P[i][<span class="number">0</span>] = nb+<span class="number">1</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= nb; j++)</div><div class="line">            P[i][j] = (B[j] == i2c[i]) ? j<span class="number">-1</span> : P[i][j<span class="number">-1</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</div><div class="line">        <span class="built_in">memset</span>(dp[i], <span class="number">0</span>, <span class="keyword">sizeof</span>(uint16)*(nb+<span class="number">1</span>));</div><div class="line">        dp[i][nb+<span class="number">1</span>] = <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= na; i++) &#123;</div><div class="line">        <span class="keyword">int</span> *Pv = P[c2i[A[i]]];</div><div class="line">        uint16 *dpIn = dp[i&amp;<span class="number">1</span>^<span class="number">1</span>];</div><div class="line">        uint16 *dpOut = dp[i&amp;<span class="number">1</span>];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= nb; j++) &#123;</div><div class="line">            uint16 t1 = dpIn[Pv[j]]+<span class="number">1</span>;</div><div class="line">            uint16 t2 = dpIn[j];</div><div class="line">            dpOut[j] = t1 &gt; t2 ? t1 : t2;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= nb; i++)</div><div class="line">        dpf[i] = dp[na&amp;<span class="number">1</span>][i];</div><div class="line">    <span class="keyword">return</span> dpf[nb];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">char</span>* <span class="title">alloc_str</span><span class="params">(<span class="keyword">int</span> sz)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (<span class="keyword">char</span> *) <span class="built_in">calloc</span>(sz, <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">char</span>* <span class="title">substr</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s, <span class="keyword">int</span> pos, <span class="keyword">int</span> len)</span> </span>&#123;</div><div class="line">    <span class="keyword">char</span> *t = alloc_str(len+<span class="number">1</span>);</div><div class="line">    <span class="built_in">memcpy</span>(t, s+pos, len);</div><div class="line">    <span class="keyword">return</span> t;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">char</span>* <span class="title">cat</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *sa, <span class="keyword">const</span> <span class="keyword">char</span> *sb)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> na = <span class="built_in">strlen</span>(sa), nb = <span class="built_in">strlen</span>(sb);</div><div class="line">    <span class="keyword">char</span> *t = alloc_str(na + nb + <span class="number">1</span>);</div><div class="line">    <span class="built_in">memcpy</span>(t, sa, na);</div><div class="line">    <span class="built_in">memcpy</span>(t+na, sb, nb);</div><div class="line">    <span class="keyword">return</span> t;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">char</span>* <span class="title">reverse</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s, <span class="keyword">int</span> len)</span> </span>&#123;</div><div class="line">    <span class="keyword">char</span> *t = substr(s, <span class="number">0</span>, len);</div><div class="line">    <span class="keyword">char</span> *l = t, *r = t + len - <span class="number">1</span>;</div><div class="line">    <span class="keyword">char</span> tmp;</div><div class="line">    <span class="keyword">while</span> (l &lt; r) &#123;</div><div class="line">        tmp = *l, *l = *r, *r = tmp;</div><div class="line">        l++, r--;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> t;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">char</span>* <span class="title">find_lcs</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *a, <span class="keyword">int</span> na, <span class="keyword">const</span> <span class="keyword">char</span> *b, <span class="keyword">int</span> nb, <span class="keyword">int</span> dep)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (na &gt; nb) &#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *c; <span class="keyword">int</span> t;</div><div class="line">        c = a, a = b, b = c;</div><div class="line">        t = na, na = nb, nb = t;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (na == <span class="number">0</span>)</div><div class="line">        <span class="keyword">return</span> alloc_str(<span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (na == <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nb; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (a[<span class="number">0</span>] == b[i])</div><div class="line">                <span class="keyword">return</span> substr(a, <span class="number">0</span>, <span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> alloc_str(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> t1[MAXN];</div><div class="line">    <span class="keyword">int</span> t2[MAXN];</div><div class="line">    <span class="keyword">int</span> len = <span class="number">-1</span>;</div><div class="line">    <span class="keyword">int</span> half_len = na / <span class="number">2</span>;</div><div class="line">    <span class="keyword">char</span> *la = substr(a, <span class="number">0</span>, half_len);</div><div class="line">    <span class="keyword">char</span> *ra = substr(a, half_len, na - half_len);</div><div class="line">    <span class="keyword">char</span> *tb = reverse(b, nb);</div><div class="line">    <span class="keyword">char</span> *ta = reverse(ra, na - half_len);</div><div class="line"></div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task untied shared(t1)</span></div><div class="line">    lcs_len(la, half_len, b, nb, t1);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task untied shared(t2)</span></div><div class="line">    lcs_len(ta, na - half_len, tb, nb, t2);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp taskwait</span></div><div class="line"></div><div class="line">    <span class="keyword">int</span> split = <span class="number">-1</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= nb; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (t1[i] + t2[nb-i] &gt; len)</div><div class="line">            split = i, len = t1[i] + t2[nb-i];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (len == <span class="number">0</span>) </div><div class="line">        <span class="keyword">return</span> alloc_str(<span class="number">1</span>);</div><div class="line">    <span class="keyword">char</span> *lb = substr(b, <span class="number">0</span>, split);</div><div class="line">    <span class="keyword">char</span> *rb = substr(b, split, nb - split);</div><div class="line">    <span class="keyword">char</span> *sl, *sr;</div><div class="line"></div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task untied shared(sl)</span></div><div class="line">    sl = find_lcs(la, half_len, lb, split, dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp task untied shared(sr)</span></div><div class="line">    sr = find_lcs(ra, na - half_len, rb, nb - split, dep+<span class="number">1</span>);</div><div class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp taskwait</span></div><div class="line">    </div><div class="line">    <span class="keyword">char</span> *ret = cat(sl, sr);</div><div class="line">    <span class="built_in">free</span>(la), <span class="built_in">free</span>(ra), <span class="built_in">free</span>(ta);</div><div class="line">    <span class="built_in">free</span>(lb), <span class="built_in">free</span>(rb), <span class="built_in">free</span>(tb);</div><div class="line">    <span class="built_in">free</span>(sl), <span class="built_in">free</span>(sr);</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> A[MAXN], B[MAXN];</div><div class="line">    <span class="keyword">int</span> dp[MAXN];</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%s %s"</span>, A, B) == <span class="number">2</span>) &#123;</div><div class="line">        <span class="keyword">int</span> na = <span class="built_in">strlen</span>(A);</div><div class="line">        <span class="keyword">int</span> nb = <span class="built_in">strlen</span>(B);</div><div class="line">        <span class="keyword">char</span> *str;</div><div class="line">        <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></div><div class="line">        &#123;</div><div class="line">            <span class="meta">#<span class="meta-keyword">pragma</span> omp single</span></div><div class="line">            str = find_lcs(A, na, B, nb, <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, <span class="built_in">strlen</span>(str));</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, str);</div><div class="line">        <span class="built_in">free</span>(str);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/7/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/85/">85</a><a class="extend next" rel="next" href="/page/9/">Next &raquo;</a>
    </nav>
  
</section>
          
          
            <aside id="sidebar">
  <!-- <div id="ukagaka_panel"></div> -->
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/">學校課程</a><span class="category-list-count">115</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/介面設計/">介面設計</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/作業系統/">作業系統</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/即時系統/">即時系統</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/大學專題/">大學專題</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/巨量資料/">巨量資料</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/平行程式/">平行程式</a><span class="category-list-count">43</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/敏捷方法/">敏捷方法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/編譯器/">編譯器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/自然語言/">自然語言</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/虛擬實境/">虛擬實境</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算型智慧/">計算型智慧</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算幾何/">計算幾何</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算機圖學/">計算機圖學</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資料庫系統/">資料庫系統</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資訊安全/">資訊安全</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/通識課程/">通識課程</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/">工作應用</a><span class="category-list-count">33</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Java/">Java</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Meme/">Meme</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/可持久化/">可持久化</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/鬼故事/">鬼故事</a><span class="category-list-count">11</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/手札日記/">手札日記</a><span class="category-list-count">46</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/">網頁設計</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/About-This-Blog/">About This Blog</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/HTML5/">HTML5</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/JQuery/">JQuery</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/Markdown/">Markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/NodeJs/">NodeJs</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/">解題區</a><span class="category-list-count">633</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/Latex/">Latex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/出題解題/">出題解題</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-POJ/">解題區 - POJ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a><span class="category-list-count">483</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a><span class="category-list-count">77</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-未解題目/">解題區 - 未解題目</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/雜言筆記/">雜言筆記</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a class="text" href="/2021/07/29/work/company-ghost-story-11/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 11</a>
          </li>
        
          <li>
            <a class="text" href="/2021/06/21/diary-202106/">
              
                <i class="icon-file-o"></i> 
              
            疫情下的工作變化</a>
          </li>
        
          <li>
            <a class="text" href="/2021/06/21/work/company-ghost-story-10/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 10</a>
          </li>
        
          <li>
            <a class="text" href="/2021/05/30/diary-202105/">
              
                <i class="icon-file-o"></i> 
              
            前思後想 新居落成</a>
          </li>
        
          <li>
            <a class="text" href="/2021/05/30/java/java-memory-optimization-2/">
              
                <i class="icon-file-o"></i> 
              
            Java 優化內存使用 組合篇</a>
          </li>
        
          <li>
            <a class="text" href="/2021/05/30/java/java-memory-optimization-1/">
              
                <i class="icon-file-o"></i> 
              
            Java 優化內存使用 結構篇</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/diary-202101/">
              
                <i class="icon-file-o"></i> 
              
            二八進展</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-globl-var/">
              
                <i class="icon-file-o"></i> 
              
            Global Variable</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-file-extension/">
              
                <i class="icon-file-o"></i> 
              
            File Extension</a>
          </li>
        
          <li>
            <a class="text" href="/2021/01/31/work/meme-job-build/">
              
                <i class="icon-file-o"></i> 
              
            Job Build</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">   
      	<ul>
	      <li><a href="http://mypaper.pchome.com.tw/zerojudge" target="_blank" title="Old Blog"><i class="icon-star"></i> Morris' Blog (pchome)</a></li>
	      <li><a href="http://flere114.blogspot.tw/" target="_blank" title="蘿莉勿觸"><i class="icon-googles"></i> flere's Blog</a></li>
	      <li><a href="http://dreamoon4.blogspot.tw/" target="_blank" title="夢月"><i class="icon-googles"></i> dreamoon's Blog</a></li>
	      <li><a href="http://m80126colin.github.io" target="_blank" title="許胖們"><i class="icon-github-alt"></i> m80126colin's Blog</a></li>
	      <li><a href="http://sd12582000.blogspot.tw/" target="_blank" title="妮可妮可"><i class="icon-github-alt"></i> Nico's Blog</a></li>
	      <li><a href="http://kuoe0.logdown.com/" target="_blank" title="郭至軒大神"><i class="icon-github-alt"></i> KuoE0's Dots</a></li>
	      <li><a href="http://tyan.io/" title=""><i class="icon-github-alt"></i> Tyan Blog</a></li>
    	</ul>
    </div>
</div>

  
    
<script src="/js/jquery-ui.js"></script>
<script src="/js/ukagaka/jquery.morris.ukagaka.resource.js"></script>
<script src="/js/ukagaka/typed.js"></script>
  
  
</aside>
          
        
      </div>
      <footer id="footer">
  
  <div class="outer">    
    <div class="social-group">
      
      <a href="https://github.com/morris821028" target="_blank" title="github"><i class="icon-github"></i></a>
      
      
      <a href="https://www.facebook.com/Morris1028" target="_blank" title="facebook"><i class="icon-facebook-sign"></i></a>
      
      
      <a href="http://uhunt.felix-halim.net/id/46705" target="_blank" title="uhunt" ><span class="icon-uhunt">UVa<span></a>
      
    </div>
    <div id="footer-info" class="inner">
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/morris821028/hexo-theme-landscape" target="_blank" title="landscape">landscape</a> &copy; 2021 Shiang-Yun Yang 
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link"><i class=icon-home ></i>&nbsp&nbspHome</a>
  
    <a href="/about" class="mobile-nav-link"><i class=icon-user ></i>&nbsp&nbspAbout</a>
  
    <a href="/archives" class="mobile-nav-link"><i class=icon-archive ></i>&nbsp&nbspArchives</a>
  
    <a href="/tags" class="mobile-nav-link"><i class=icon-tags ></i>&nbsp&nbspTags</a>
  
    <a href="/picture" class="mobile-nav-link"><i class=icon-camera ></i>&nbsp&nbspPictures</a>
  
    <a href="/works" class="mobile-nav-link"><i class=icon-trophy ></i>&nbsp&nbspWorks</a>
  
</nav>
    
<script>
  var disqus_shortname = 'morris1028';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/jquery.lazyload.js"></script>
<script src="/js/jquery.als-1.6.js"></script>

<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>