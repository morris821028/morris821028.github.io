<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Morris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Morris&#39; Blog">
<meta property="og:url" content="http://morris821028.github.io/page/8/index.html">
<meta property="og:site_name" content="Morris&#39; Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Morris&#39; Blog">
<link rel="publisher" href="108158678174364350000">
  
    <link rel="alternative" href="/atom.xml" title="Morris&#39; Blog" type="application/atom+xml">
  
  
    <meta name="google-site-verification" content="5mRgj8NanEMpGZuNfHNJNmH90RgNlrnJXsFlTaKD6Gs" />
  
  
    <link rel="shortcut icon" href="/img/f.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script src="/js/jquery-2.1.0.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.5.1.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdn.oesmith.co.uk/morris-0.5.1.min.js"></script>
  <!-- <link rel="import" href="/bower_components/app-layout/app-layout.html"> --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"><div id="banner-right"></div></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Morris&#39; Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class=icon-home title='Home'></i></a>
          
        
          
            <a class="main-nav-link" href="/about"><i class=icon-user title='About'></i></a>
          
        
          
            <a class="main-nav-link" href="/archives"><i class=icon-archive title='Archives'></i></a>
          
        
          
            <a class="main-nav-link" href="/tags"><i class=icon-tags title='Tags'></i></a>
          
        
          
            <a class="main-nav-link" href="/picture"><i class=icon-camera title='Pictures'></i></a>
          
        
          
            <a class="main-nav-link" href="/works"><i class=icon-trophy title='Works'></i></a>
          
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://morris821028.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        
          
          <section id="main">
  
    <article id="post-note/diary-201705-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/04/note/diary-201705-2/" class="article-date">
  <time datetime="2017-05-04T03:46:34.000Z" itemprop="datePublished">2017-05-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/手札日記/">手札日記</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="http://i.imgur.com/BsbOqhH.jpg" rel="gallery_ckxv1wn7x02bla8vn7e0wp99l">
        <img src="http://i.imgur.com/BsbOqhH.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/04/note/diary-201705-2/">純粹 Part 2</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/05/04/note/diary-201705-2/" data-id="ckxv1wn7x02bla8vn7e0wp99l" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/05/04/note/diary-201705-2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <p>接續上一篇所講，繼續說下去吧。</p>
<p>「神明曾向某個青年下了詛咒，那是看到悲傷之人就會全身感到痛苦的詛咒。青年為了避免自己痛苦，於是向所有悲傷的人伸出了援手 —— 神明著著他的樣子，仿製了一個外貌、動作與他一模一樣的假貨，他也像真正的青年一樣對所有悲傷的人伸出了援手。神明分別為他們起了名字 —— 一方為善，另一方為偽善。你覺得哪個是善，哪個是偽善？」－《重啟咲良田》</p>
<p>純粹究竟是什麼樣子？不帶有任何的自我意識，完全地無意識到周遭，更不會去評斷做了什麼，就只是去做，最終是好是壞那又是什麼？不是我們給予一個行為或結果的解釋嗎，都只是解釋的話，真相有必要探究嗎？若是純粹，那還可以被稱作人？還是被稱為機器人合適？</p>
<p>純粹地，想知道。</p>
<h2 id="日常篇"><a href="#日常篇" class="headerlink" title="日常篇"></a>日常篇</h2><p>原本只是想做一個簡單的平行算法，從趕 Conference 論文換成 Transaction 論文，原本 Conference 論文頁數不得超過十頁，導致很多提及的數據結構都不太想仔細說明，咱的指導老師只好先改其他人的論文投 Conference，而我被安排到投 Transaction，沒有任何時間壓力。</p>
<p>三月中是個分水嶺，同屆的只剩下我要寫論文，其他人已經不用到校 (只要不接助教工作，事實上不必總是到實驗室)，而我還接下了平行助教的工作，到學校等著論文修改的 on call，平常實驗室只剩下我和學弟們，不時跟他們討些作業來做，亦或者討論計畫所需要的算法。也許有人會想問，那實驗室的博班學長呢？只有 meeting 那一天有機會在實驗室見著，平常是完全的零交流，是非常平行的實驗室呢！</p>
<p>當助教的日子裡，就像去年一樣「我不知道該怎麼辦，但覺得這樣下去不太行。」，若跟其他人一樣顧好自己畢業，其他事都不管的話，這裡的許許多多事情終究會重複上演。設計題目出測資，看相關論文後，做個簡單的簡報，在每週跟課的時候跟同學說明，為了設計新的題目而調整系統，按照這個行程走，每天都有一些工作需要處理。</p>
<p><img src="http://i.imgur.com/KFoit6t.jpg" alt="「和其他人一起努力的話，很多問題可以迎刃而解」－《3月的獅子》"></p>
<p>然而，做的一切還會被同學嫌。要說這裡是台大嗎？讓我這個半吊子當助教本身就是錯的，我是來學習的，不是來工作的！真正值得學習的對象卻很少出現在我眼前給予我指導，曾經的我也好想在這裡永遠追隨某人、想和其他人一起努力，但每個人都有自己的規則和約束，能一起努力的機會就更少了，有著各自的工作與理念，即使在第一學府眾多的人群中，也未必能找到能共事的同事。</p>
<p>助教工作時看著自己專研過的算法和代碼，不時地仍會看著其他人的程序學習，儘管在運行上可能不是很有效率、邏輯不漂亮。別因為追不到我的程序就放棄努力，我仍然可以向妳學習「就差那麼一步，你的想法將會推翻整個局面，本該如此的美麗，卻少了最後那份信心。」《3月的獅子》，別過於相信我，我並沒你們想像中地強大。</p>
<p><img src="http://i.imgur.com/IiwHJgw.jpg" alt="「本應如此地美麗」－《3月的獅子》"></p>
<p>論文從十頁放寬到二十五頁的限制，能放置的圖表更加地豐富，老師要我從祖宗十八代的算法開始描述，必且要講得可以不查閱其他論文和資料就能閱讀，大部分的內容都被要求重寫，提及約十個算法、快二十張圖片說明，製圖耗費的經歷更加地多 (原因都來自於版本控制的需求，畫圖都像寫程式一般)，調整描寫順序，用最簡單的方法講清楚一件事情，於是一下子就到了快二十五頁。改我論文的痛苦已經充分展現在老師的臉書塗鴉牆，那大概是老師有生之年第一次這麼辛苦。</p>
<p><img src="http://i.imgur.com/moKcWOd.jpg" alt="「為了創作出傑作，我正在養精蓄銳」－《我的妹妹是黃漫老師》"></p>
<p>別太期待會有什麼特別的，自己覺得挺簡單的，可能還沒有什麼用呢。</p>
<h2 id="計畫篇"><a href="#計畫篇" class="headerlink" title="計畫篇"></a>計畫篇</h2><p>因為要回學校當助教又要改論文，暫時辭去了實習工作 (留職停薪？為什麼不打算讓我離職，怎麼想都很奇怪，這麼照顧我，真的辛苦你們了)，畢業之後又會到哪裡，做些什麼事情，不經讓我想起《秒速五釐米》的那段話，</p>
<p><img src="http://i.imgur.com/4HcqoP1.jpg" alt="「總之這幾年裡，我很想向前邁進，想觸及那無法觸及的事物，儘管不知道那具體指什麼。我不知道這份勉強的感情是從何處如何孕育而生，只能一味地工作，等回過神來，日漸喪失彈性的心靈是如此傷痛。接著某天早上，我意識到過去那份銘刻於心的感情已消失得無影無踪，我知道自己到了極限，於是辭去了工作。」─《秒速五釐米》"></p>
<p>那份心情到底要如何醞釀？為了什麼而活的心情？想等待著什麼樣的日子？太多太多的問題想要知道，還是不需要去想意義，若是每一件事情都去找意義，那就不能做事了，那先做看看吧，誰也不知道答案！當然，接受包養的情況也是可以接受的！</p>
<p><img src="http://i.imgur.com/GnoM6AI.jpg" alt="「請包養我！我真的不想去工作」－《不正經的魔術講師雨禁忌教典》"></p>
<h2 id="理念篇"><a href="#理念篇" class="headerlink" title="理念篇"></a>理念篇</h2><p>在台大讀研究所，有時會覺得佔了某人的位置，畢竟一開始的我並不在這裡，而應該出現在這裡的人卻又不怎麼出現，我出現在這裡合適嗎？如果合適的話，為什麼要這樣對我？如果不合適的話，又為什麼要這樣要求我？不得不去思考這些問題，否則就很難邁出下一步。</p>
<p><img src="http://i.imgur.com/B6QVTEZ.jpg" alt="「有時我會覺得佔了某人的位置，這讓我感到難過。比方說，活在世上就是一種浪費，霸佔了其他人的位置，他們也許能活出更有意義的人生」－《愛在來世》"></p>
<p>很想追祢，也很想追妳，在同一個次元也罷，不同次元也行，那是成為一般人且獲得認同的證明，對於我是如此地渴望。</p>
<p><img src="http://i.imgur.com/zNKmBDF.jpg" alt="「就算是距離無法縮短，也不能成為我不前進的理由」－《3月的獅子》"></p>
<p>人們說那種東西只是個雙保險，也許，只是害怕一個人待著，那晚的事情我還記得很清楚，晚上十點多寫完程式闔上筆電，跟家人說聲晚安，走上樓睡覺時，覺得今晚是如此地奇怪，總覺得從另一個視角看著自己，但什麼事情也沒發生，無疑地躺上床後，馬上被寫程式的疲累帶進夢裡。</p>
<p>半夜突然驚醒，正要拿起手機看時間，坐在床上都會倒下，在半夜裡無助地喊著，一邊思考著「是不是要結束人生了，我的腦已經要停止運作了嗎？」還好那時在家裡，半夜還能被送去急診，無力的我還得被推著輪椅進去，醫師只跟我說明是「腸胃炎」，那時的我不怎麼相信，畢竟腸胃炎都得過多少次了，都還沒遇過這種情況。</p>
<p>躺在上休息的我，吃不下也喝不下，就只是發呆著，等著可以分清楚方向，那時朋友仍用著我的帳號在臉書發圖文，家人還以為我已經好到可以用手機發文，誰都不知道、也沒發現早已陣亡的我，一如往常地回覆我。這才發現不需要我也可以正常運作，這世界的容錯能力很好，一瞬間就可以修正我這個錯誤。之後的我更沒想過會失去平衡一個多月，車也不敢騎，頭也不敢回，快速轉個頭可能就要跌倒，那究竟是什麼情況，至今還不清楚。</p>
<p><img src="http://i.imgur.com/6GEwa39.jpg" alt="「我十七歲的時候還在妄想著『自己會不會成為很厲害的人啊』」－《3月的獅子》"></p>
<p>曾經的幻想「自己會不會成為很厲害的人啊」，到了考大學的結果才發現一點也不行，有些東西就是學不來，真的學不來呀，怎麼樣追逐的速度都跟不上，只能在一旁一味地看著自己離大家越來越遠，最後吊了車尾。</p>
<p><img src="http://i.imgur.com/0xciq0c.jpg" alt="「想到要為了賺錢，埋首研究如何讓日常生活更便利，就受不了，我要為了思考而思考」－《世紀天才》"></p>
<p>我想要為了思考而思考，找了工作後，身旁的人就很在意薪水多高，不斷地吹捧那薪水價值，但我想那都不是重點，回顧一個常見的小故事——</p>
<p>〈說話的藝術〉的小故事「如果你說一個女大學生，晚上去夜總會陪酒，聽起來就不太好，可如果你說一個夜總會小姐，白天堅持去大學聽課，就滿滿的正能量了。如果你說你是一個學者，開了個公司，會被鄙視，認為你俗，真是斯文敗類。可是如果你說你是一個商人，經商之餘還專研學術，別人會肅然起敬，尊稱你為儒商。所以說話的時候，順序特別重要。」</p>
<p>我想說得差不多對照類似的意思，強調的順序反了！理念上感到非常奇怪的點。</p>
<blockquote>
<p>貼了圖不久，就收到了訊息<br>「你可以為了思考而思考」<br>「然後錢給我，幫你花！」</p>
</blockquote>
<p>此時，我的心情寫照</p>
<p><img src="http://i.imgur.com/V6SsDfC.jpg" alt="「你這麼說的話，不就是在表達想跟我永遠在一起嗎」－《從零開始的魔法書》"></p>
<p>儘管知道這只是純粹的話，仍必須好好地建造高牆，否則容易受到動搖。</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-note/diary-201705" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/03/note/diary-201705/" class="article-date">
  <time datetime="2017-05-03T11:51:34.000Z" itemprop="datePublished">2017-05-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/手札日記/">手札日記</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="http://i.imgur.com/QfgFMVC.jpg" rel="gallery_ckxv1wn7v02bia8vnfmffciov">
        <img src="http://i.imgur.com/QfgFMVC.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/03/note/diary-201705/">純粹 Part 1</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/05/03/note/diary-201705/" data-id="ckxv1wn7v02bia8vnfmffciov" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/05/03/note/diary-201705/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <p>從二月到五月這段日子，發生了許多事情，也有些不變的日常。其中，有一段疲於應付的日子過得水生火熱，又在其中穿插了幾段小趣事，獻給想到聽八卦的朋友們，接下來將分成感情、日常、計畫與理念四篇。</p>
<p>感情篇——在一月時已提及了大部分感情篇的要素，那些沒有後續的故事，通常不太想去提及、不想去談論，那是純粹的還是虛偽的感情？這些問題隨著這段日子不斷反覆思考著。</p>
<p>日常篇——講著大部分的實驗室的情況，我的日常不是一般的日常，回家就是睡，醒來就會在實驗室，說是一般的娛樂，也都是在學校度過。其原因可以歸納在「反正我沒有朋友、沒有女朋友，有著大把大把的時間可以去思考。」</p>
<p>計畫篇——計畫著下一階段要怎麼運行，一旦失去學生身份，就得開始履行當兵義務，而當完兵又是怎麼樣的日子，我應該要以什麼的理念活下去？</p>
<p>理念篇——從國小曾思考著「世界是否從我眼界下才開始構築」，到現在不斷地加深自己的理念，與其拓展到個方位上的思考轉換，那些思考有什麼意義？</p>
<h2 id="感情篇"><a href="#感情篇" class="headerlink" title="感情篇"></a>感情篇</h2><p>明白和揣測對方的想法，就像寫程序就能想到執行的預期結果是怎麼樣子，只要構築環境與每一步的指令都相當明確，那麼結果必然呼之欲出。這個能力用於寫程式很方便，一旦用到了感情上就不被接受。</p>
<p>當朋友身邊有著不錯的對象，也有著像漫畫劇情般那樣發展，在對方尚未開口的處境下，喜歡與不喜歡就決定於下一步，有可能錯過一個表明心意的機會，人生就差了十萬八千里遠。基於上述，學弟和朋友們開始喧鬧「不試著找個機會告白嗎？」「她應該在等你了吧」… 等。</p>
<p><img src="http://i.imgur.com/RPDNDzV.jpg" alt="「其實我不善與人交談」－《風夏》"></p>
<p>「別鬧了，你們不夠理解她，她本來就是這樣子的人 …」那些無法用語言表述的推測，明確地告訴我，對方本質加上輸入後的結果－不會成功、也不會失敗，沒有機會告白，也不會有機會告白，我試著將這些跟朋友說到，但是誰也不信我。</p>
<p>然後到了某天早晨，在意識不清的情況下，傳了一張圖片過去，上頭這麼寫著「我有著一種能力，喜歡的對象總會有男朋友」想著考慮要交男朋友的她，我的能力也許能幫上她，「妳交上男朋友了嗎？」如此地問道，收拾著包包去學校，在等十字路口紅綠燈時，看到走在一旁男女國中生們，才想起稍早些到底做了什麼蠢事 …</p>
<p>看著中午時，手機傳來了訊息通知，在開啟之前，內心感覺就像是考卷在發的過程中，在台下能明確地幻想到下五分鐘的未來，那種心境和感覺在此刻重現，「求你了，我所想的預測不要成真」忍了很久，開啟的第一句話大致上說明故事已經落幕，心裡早就知道的事情，真實呈現時的痛苦啊！</p>
<p><img src="http://i.imgur.com/4ETQPBD.jpg" alt="「雖然知道會這樣，不過還是很痛苦啊」－《清戀》"></p>
<p>沒事兒，至少在情人節之前挑戰過了，失敗就可以給各位朋友一個交代，心中也鬆了一口氣</p>
<p>「我已經不要緊了」「連我的心靈支柱 … 我以為的心靈支柱都這麼說 …」</p>
<p><img src="http://i.imgur.com/2kFa8WO.jpg" alt="「失敗就意味著挑戰過了」－《3月的獅子》"></p>
<hr>
<p>那件事情也過了一陣子，開學前就要忙於論文報告和助教工作的準備，這段忙碌的日子過了好一陣子</p>
<blockquote>
<p>「Hello, 我來了」在晚上九點多的實驗室門口傳來熟悉的聲音  </p>
<p>「Hello, 妳怎麼突然來了？」還來不及反應過來，只能隨手抓個詞應答道  </p>
<p>「剛 meeting 結束，過來看看你們」<br>「你還記得我的論文做些什麼嗎？」</p>
<p>「還記得些，我記得是運行 XXX YYYY 達到 XXXX」對於記憶有點信心，至少認為特別的或重要的事情不會忘</p>
<p>「沒錯！今天老師跟我說 …」</p>
</blockquote>
<p>憑藉著演算法的那些小伎倆，在不擅長的領域到指出自己的想法，希望我還可以派上用場！在這一晚，我想在一旁的學弟又會開始幻想些什麼，儘管在失敗後告誡他們別再拿我的蠢事開玩笑。想著沒有信心地講完後，又要無奈地應對他們，這一晚的關卡好難過。</p>
<p>又過了一陣子，某個晚上</p>
<blockquote>
<p>「Hello, 我來了」這種開場白，不知道為什麼總是這麼有趣<br>「你們實驗室有 XXX 可以借用一下嗎？急用」<br>「我們不是做那一領域的，不會有的，你有問過其他實驗室嗎？」<br>「沒耶，第一個想到的就是問你」</p>
<p>此時，我心中的寫照 <img src="http://i.imgur.com/jLbRRFQ.jpg" alt="《廢天使加百列》"><br>『妳這樣子說，等等我要怎麼跟學弟解釋啊』這個誤會嚴重影響到擅長腦補的朋友們啊！</p>
<p>四處問了下相關領域的學長們是否能租借，最後只能安慰著「明天老實跟老師說吧，沒關係的」</p>
</blockquote>
<p>又過了一陣子，某個下午</p>
<blockquote>
<p>「Hi」又聽到熟悉的聲音，但下午寫程序到了一半，暫時不想停止手邊的工作。<br>「你們實驗室有 XXX 可以借用一下嗎？」</p>
<p>學弟起身，翻著好久沒有整理的紙箱仍沒有結果。工作告一段落的我，加入搜尋的行列<br>「看起來是沒有，就算有，那可以用嗎？」</p>
<p>「應該可以吧？」</p>
<p>繼續翻著箱子說道「看起來是沒有耶」</p>
<p>「ㄟㄟ，你在寫些什麼？」走到我的位子上，稍微看著螢幕上的程序說道</p>
<p>「那個 … 我在寫學弟的作業」身為學長寫著學弟的作業，完全感受不到威嚴</p>
<p>「我的論文重要？還是學弟作業重要！」</p>
<p>突然間，實驗室的人都在竊笑，想必此生的我已經結束了，這跳進黃河也洗不清。<br><img src="http://i.imgur.com/Cv8vxz7.jpg" alt="《廢天使加百列》"></p>
</blockquote>
<hr>
<p>四月初仍忙著論文撰寫，在這修改的煎熬日子裡，不是等待回應，就是將描述手法改來改去。然後，之前在遊戲《楓之谷》認識的交大某數已經提早把論文寫完等畢業，週末突然問我要不要去拜月老，一個剛跟女友分手的正常人和一個從未正常交過女友的肥宅就這麼約著網友聚會去龍山寺拜月老。</p>
<p>不知道那天是怎了，想把手上的事情放掉，鐵了心想做了不同的事情，但是關於「出門拜月老？」這個出遊議題，在內心掙扎著「出門就輸了，若去的話就驗證我二十多年來的失敗 …」最終，由於沒有任何不去的理由，隔天一早就出發了。</p>
<p>當日頂著大太陽，什麼事前調查都沒準備，那麼拜也沒什麼效用，想著當作觀光之旅來看待。至於月老求姻緣的部分，秉持著平常心看待囉！好久沒有拿著香在寺廟裡晃來晃去，有拜學業、拜健康、拜姻緣還有拜商業 … 等。想到自己要來拜個姻緣？嗯，這種無法明確努力的項目，就像天生註定的，我想行為只是基因的載體，意識到自己從未有過，再想著有過與沒有過的差別，我的確不是那一型的個性，那麼沒有也是很正常的吧。</p>
<p>然而，都來了一趟，仍硬是要我問問關於姻緣，心想求姻緣要連續三個聖筊，這個的機率這麼低，如果沒有對於對象任何要求的話，我有機會嗎？先來個二分搜尋法，</p>
<blockquote>
<p>「五年內有機會遇的到嗎？」<br>「不會」神如此回應<br>「那 … 十年內遇的到嗎？」大膽突破點地詢問<br>「沒辦法」神明搖著頭說道<br>「二十年內呢？」作為人而言，我的想法太奢求了<br>「沒有」<br>「這一生有可能嗎？」人生要果斷點，也許才有機會<br>「沒有」</p>
</blockquote>
<p>內心憔悴，先來個中場休息吧。若是再擲下去，探究真理的我也許會想問「還需要活下去嗎？神」看著一旁有人頂著大太陽折騰了好幾十分鐘「兄弟呀，我理解機率是多麼地困難」</p>
<blockquote>
<p>「她跟我不同次元對吧？」換個說法看看吧，希望是找出來的<br>「對」<br>「這樣的我可以活得開心吧」淚水不斷地在內心流淌，原來神告訴我的真理是這個樣子，至今我都沒好好對待。<br>「可以」</p>
</blockquote>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-uva-13154" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/28/uva-13154/" class="article-date">
  <time datetime="2017-04-28T11:40:58.000Z" itemprop="datePublished">2017-04-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/28/uva-13154/">UVa 13154 - Extreme XOR Sum</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/04/28/uva-13154/" data-id="ckxv1wmnz0133a8vnvspoqe89" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/04/28/uva-13154/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/二項係數/">二項係數</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化輸入/">優化輸入</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/塊狀表/">塊狀表</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>給一長度為 <span>$N$</span><!-- Has MathJax --> 的整數序列，詢問任意區間的極端異或和 Extreme XOR Sum。</p>
<p>定義 Extreme XOR Sum 為一系列操作的最後一個值</p>
<ul>
<li>當長度 <span>$n&gt;1$</span><!-- Has MathJax --> 時，將陣列縮小為 <span>$n-1$</span><!-- Has MathJax --></li>
<li>對 <span>$[a_0, a_1, a_2, \cdots, a_{n-1}]$</span><!-- Has MathJax -->，每一個元素與後一個元素運行互斥或，將會被轉換成 <span>$[a_0 \oplus a_1, a_1\oplus a_2, a_2 \oplus  a_3, \cdots, a_{n-2}\oplus a_{n-1}]$</span><!-- Has MathJax --></li>
<li>直到只剩下一個元素，即為 Extreme XOR Sum</li>
</ul>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">5</div><div class="line">1  4  6  7  8</div><div class="line">3</div><div class="line">0  0</div><div class="line">0  1</div><div class="line">2  4</div></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Case 1:</div><div class="line">1</div><div class="line">5</div><div class="line">14</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>這題詢問次數非常多，一般運行將對每一個詢問達到 <span>$O(N)$</span><!-- Has MathJax --> 的複雜度，這很容易得到 TLE。從大多的數據結構，如線段樹、塊狀表 … 等，他們提供高效率的查找效能，但也必須符合某些條件才能使用。因此，在此題若要符合結合律將變得相當困難。</p>
<h3 id="觀察"><a href="#觀察" class="headerlink" title="觀察"></a>觀察</h3><p>假設要計算陣列 <span>$[1,  4,  6,  7,  8]$</span><!-- Has MathJax --> 的值時</p>
<ul>
<li>第一步，<span>$[1 \oplus 4,  4 \oplus 6,  6 \oplus 7,  7 \oplus 8]$</span><!-- Has MathJax --></li>
<li>第二步，<span>$[1 \oplus 4 \oplus 4 \oplus 6,  \cdots]$</span><!-- Has MathJax --></li>
<li>如此類推下去，XOR 有結合律，我們發現到各別使用了 1 次 <span>$a_0$</span><!-- Has MathJax -->、4 次 <span>$a_1$</span><!-- Has MathJax -->、6 次 <span>$a_2$</span><!-- Has MathJax -->、4 次 <span>$a_3$</span><!-- Has MathJax --> 和 1 次 <span>$a_4$</span><!-- Has MathJax --></li>
</ul>
<p>對於不同的長度，我們發現到是二項係數的配對情況。由於偶數次的 XOR 會互消，只需要計算出現奇數次的即可，因此我們列出二項次數模二的情況，進而得到 Sierpinski triangle/Sierpinski sieve。即使知道 Sierpinski sieve 是二項係數模二的結果，我們仍不知道要怎麼套用結合律達到剖分加速的條件。</p>
<p>二項係數的公式如下</p>
<span>$$\begin{align*}
\binom{n}{m} &amp;= \binom{n-1}{m-1} + \binom{n-1}{m} \\
&Tab;&Tab;&Tab;&amp;= \frac{n!}{m!(n-m)!}
\end{align*}$$</span><!-- Has MathJax -->
<p>階層運算在數學運算上的性質並不多，逼得我們只好往碎形上觀察，以下列出前幾項的結果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">1 1</div><div class="line">1 0 1</div><div class="line">1 1 1 1</div><div class="line">1 0 0 0 1</div><div class="line">1 1 0 0 1 1</div><div class="line">1 0 1 0 1 0 1</div><div class="line">1 1 1 1 1 1 1 1</div><div class="line">1 0 0 0 0 0 0 0 1</div><div class="line">1 1 0 0 0 0 0 0 1 1</div><div class="line">1 0 1 0 0 0 0 0 1 0 1</div><div class="line">1 1 1 1 0 0 0 0 1 1 1 1</div><div class="line">1 0 0 0 1 0 0 0 1 0 0 0 1</div><div class="line">1 1 0 0 1 1 0 0 1 1 0 0 1 1</div><div class="line">1 0 1 0 1 0 1 0 1 0 1 0 1 0 1</div><div class="line">1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</div></pre></td></tr></table></figure>
<p>發現它是一個很有趣的碎形，每個三角形大小都是以二的冪次的。我們按照 <span>$2^3 = 8$</span><!-- Has MathJax --> 切割一下上圖，並且把右邊斜的補上 0 得到下圖。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">1 1</div><div class="line">1 0 1</div><div class="line">1 1 1 1</div><div class="line">1 0 0 0 1</div><div class="line">1 1 0 0 1 1</div><div class="line">1 0 1 0 1 0 1</div><div class="line">1 1 1 1 1 1 1 1</div><div class="line">^---------------</div><div class="line">1 0 0 0 0 0 0 0 |1 0 0 0 0 0 0 0</div><div class="line">1 1 0 0 0 0 0 0 |1 1 0 0 0 0 0 0</div><div class="line">1 0 1 0 0 0 0 0 |1 0 1 0 0 0 0 0</div><div class="line">1 1 1 1 0 0 0 0 |1 1 1 1 0 0 0 0</div><div class="line">1 0 0 0 1 0 0 0 |1 0 0 0 1 0 0 0</div><div class="line">1 1 0 0 1 1 0 0 |1 1 0 0 1 1 0 0</div><div class="line">1 0 1 0 1 0 1 0 |1 0 1 0 1 0 1 0</div><div class="line">1 1 1 1 1 1 1 1 |1 1 1 1 1 1 1 1</div><div class="line">^----------------^--------------</div><div class="line">1 0 0 0 0 0 0 0 |0 0 0 0 0 0 0 0 |1 0 0 0 0 0 0 0</div><div class="line">1 1 0 0 0 0 0 0 |0 0 0 0 0 0 0 0 |1 1 0 0 0 0 0 0</div><div class="line">1 0 1 0 0 0 0 0 |0 0 0 0 0 0 0 0 |1 0 1 0 0 0 0 0</div><div class="line">1 1 1 1 0 0 0 0 |0 0 0 0 0 0 0 0 |1 1 1 1 0 0 0 0</div><div class="line">1 0 0 0 1 0 0 0 |0 0 0 0 0 0 0 0 |1 0 0 0 1 0 0 0</div><div class="line">1 1 0 0 1 1 0 0 |0 0 0 0 0 0 0 0 |1 1 0 0 1 1 0 0</div><div class="line">1 0 1 0 1 0 1 0 |0 0 0 0 0 0 0 0 |1 0 1 0 1 0 1 0</div><div class="line">1 1 1 1 1 1 1 1 |0 0 0 0 0 0 0 0 |1 1 1 1 1 1 1 1</div><div class="line">^                ^                ^ </div><div class="line">箭頭表示本身也是 Sierpinski sieve</div><div class="line"></div><div class="line">區塊縮影得到 miniature pattern 也是 Sierpinski sieve</div><div class="line">1</div><div class="line">1 1</div><div class="line">1 0 1</div></pre></td></tr></table></figure>
<p>得到數個一模一樣的子圖，上述全零和非零的區塊，又恰好構成 Sierpinski sieve。這告訴我們任何操作全都要以二的冪次為基準，且合併區段時須以二項係數為係數。設定 pattern 大小為 <span>$M=2^{\lceil \log_2 N\rceil}$</span><!-- Has MathJax -->，最後得到 miniature pattern。在同一層中，非零構成的條紋都是相同的模式，例如上述得圖中，最後一層的箭號組合必然是 101 或者是 000，最後得到下列公式計算條紋。</p>
<span>$A_{i, j} = A_{i-1}{j} \oplus A_{i-1,j+M}$</span><!-- Has MathJax -->
<p>接下來，我們將需要確定每一個條紋 (stripe) 是否使用全零或者非零，只需要查找 miniature pattern 相應的係數即可。</p>
<h3 id="如何在-Sierpinski-sieve-找到非零係數的位置"><a href="#如何在-Sierpinski-sieve-找到非零係數的位置" class="headerlink" title="如何在 Sierpinski sieve 找到非零係數的位置"></a>如何在 Sierpinski sieve 找到非零係數的位置</h3><p>若 <span>$\binom{n}{i} \mod 2 = 1$</span><!-- Has MathJax -->，必滿足 <span>$n\&amp;i = i$</span><!-- Has MathJax -->。其證明從數學歸納法來，由二冪次的長度碎形著手，移除最高位的 1 得到 <span>$i&apos;$</span><!-- Has MathJax -->，從 <span>$i&apos;$</span><!-- Has MathJax --> 舊有位置集合，保留此集合，並對每一個元素增加二的冪次得到碎形的另一邊。</p>
<p>故可利用下述算法，準確地找到每一個非零的係數位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">for (int pos = n; pos; pos = (pos-1)&amp;n)</div><div class="line">    C[n][pos] mod 2 = 1</div></pre></td></tr></table></figure>
<p>最後附上優化後得到 Rank 1 的程序 0.040 s</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> M = (<span class="number">1</span>&lt;&lt;<span class="number">7</span>);</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">10005</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> A[M+<span class="number">1</span>][MAXN];</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">miniature</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i*M &lt; n; i++) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j+i*M &lt; n; j++)</div><div class="line">            A[i][j] = A[i<span class="number">-1</span>][j] ^ A[i<span class="number">-1</span>][j+M];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">extract</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> n = r-l;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> m = n/M;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> o = n%M;</div><div class="line">    <span class="keyword">int</span> ret = A[m][l];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = o; i; i = (i<span class="number">-1</span>)&amp;o)</div><div class="line">        ret ^= A[m][l+i];</div><div class="line">    <span class="keyword">return</span> ret;	</div><div class="line">&#125;</div><div class="line"><span class="keyword">namespace</span> MM &#123;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">readchar</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> buf[N];</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> *p = buf, *end = buf;</div><div class="line">        <span class="keyword">if</span>(p == end) &#123;</div><div class="line">            <span class="keyword">if</span>((end = buf + fread(buf, <span class="number">1</span>, N, <span class="built_in">stdin</span>)) == buf) <span class="keyword">return</span> EOF;</div><div class="line">            p = buf;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> *p++;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">ReadInt</span><span class="params">(<span class="keyword">int</span> *x)</span> </span>&#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">char</span> c, neg;</div><div class="line">        <span class="keyword">while</span>((c = readchar()) &lt; <span class="string">'-'</span>)    &#123;<span class="keyword">if</span>(c == EOF) <span class="keyword">return</span> <span class="number">0</span>;&#125;</div><div class="line">        neg = (c == <span class="string">'-'</span>) ? <span class="number">-1</span> : <span class="number">1</span>;</div><div class="line">        *x = (neg == <span class="number">1</span>) ? c-<span class="string">'0'</span> : <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>((c = readchar()) &gt;= <span class="string">'0'</span>)</div><div class="line">            *x = (*x &lt;&lt; <span class="number">3</span>) + (*x &lt;&lt; <span class="number">1</span>) + c-<span class="string">'0'</span>;</div><div class="line">        *x *= neg;</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Print</span> &#123;</span></div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1048576</span>;</div><div class="line">        <span class="keyword">char</span> buf[N], *p, *end;</div><div class="line">        Print() &#123;</div><div class="line">            p = buf, end = buf + N - <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">printInt</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">char</span> padding)</span> </span>&#123;</div><div class="line">            <span class="keyword">static</span> <span class="keyword">char</span> stk[<span class="number">16</span>];</div><div class="line">            <span class="keyword">int</span> idx = <span class="number">0</span>;</div><div class="line">            stk[idx++] = padding;</div><div class="line">            <span class="keyword">if</span> (!x)	</div><div class="line">                stk[idx++] = <span class="string">'0'</span>;</div><div class="line">            <span class="keyword">while</span> (x)</div><div class="line">                stk[idx++] = x%<span class="number">10</span> + <span class="string">'0'</span>, x /= <span class="number">10</span>;</div><div class="line">            <span class="keyword">while</span> (idx) &#123;</div><div class="line">                <span class="keyword">if</span> (p == end) &#123;</div><div class="line">                    *p = <span class="string">'\0'</span>;</div><div class="line">                    <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf), p = buf;</div><div class="line">                &#125;</div><div class="line">                *p = stk[--idx], p++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> </span>&#123;</div><div class="line">        	*p = <span class="string">'\0'</span>, p = buf;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">online_printInt</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">            <span class="keyword">static</span> <span class="keyword">char</span> ch[<span class="number">16</span>];</div><div class="line">            <span class="keyword">static</span> <span class="keyword">int</span> idx;</div><div class="line">            idx = <span class="number">0</span>;</div><div class="line">            <span class="keyword">if</span> (x == <span class="number">0</span>)	ch[++idx] = <span class="number">0</span>;</div><div class="line">            <span class="keyword">while</span> (x &gt; <span class="number">0</span>) ch[++idx] = x % <span class="number">10</span>, x /= <span class="number">10</span>;</div><div class="line">            <span class="keyword">while</span> (idx) </div><div class="line">                <span class="built_in">putchar</span>(ch[idx--]+<span class="number">48</span>);</div><div class="line">        &#125;</div><div class="line">        ~Print() &#123;</div><div class="line">            *p = <span class="string">'\0'</span>;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf);</div><div class="line">        &#125;</div><div class="line">    &#125; bprint;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> testcase, cases = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> n, m;</div><div class="line"><span class="comment">//	scanf("%d", &amp;testcase);</span></div><div class="line">    MM::ReadInt(&amp;testcase);</div><div class="line">    <span class="keyword">while</span> (testcase--) &#123;</div><div class="line"><span class="comment">//		scanf("%d", &amp;n);</span></div><div class="line">        MM::ReadInt(&amp;n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line"><span class="comment">//			scanf("%d", &amp;A[0][i]);</span></div><div class="line">            MM::ReadInt(&amp;A[<span class="number">0</span>][i]);</div><div class="line">        miniature(n);</div><div class="line"><span class="comment">//		scanf("%d", &amp;m);</span></div><div class="line">        MM::ReadInt(&amp;m);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Case %d:\n"</span>, ++cases);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">            <span class="keyword">int</span> l, r;</div><div class="line"><span class="comment">//			scanf("%d %d", &amp;l, &amp;r);</span></div><div class="line">            MM::ReadInt(&amp;l), MM::ReadInt(&amp;r);</div><div class="line"><span class="comment">//			printf("%d\n", extract(l, r));</span></div><div class="line">            MM::bprint.printInt(extract(l, r), <span class="string">'\n'</span>);</div><div class="line">        &#125;</div><div class="line">        MM::bprint.flush();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">1</span></div><div class="line"><span class="comment">5</span></div><div class="line"><span class="comment">1  4  6  7  8</span></div><div class="line"><span class="comment">3</span></div><div class="line"><span class="comment">0  0</span></div><div class="line"><span class="comment">0  1</span></div><div class="line"><span class="comment">2  4</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-big-integer-division" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/09/big-integer-division/" class="article-date">
  <time datetime="2017-04-09T08:13:14.000Z" itemprop="datePublished">2017-04-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="http://i.imgur.com/BuPUpad.jpg" rel="gallery_ckxv1wm7m001aa8vnb1q5rtax">
        <img src="http://i.imgur.com/BuPUpad.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/09/big-integer-division/">關於高效大數除法的那些事</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/04/09/big-integer-division/" data-id="ckxv1wm7m001aa8vnb1q5rtax" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/04/09/big-integer-division/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FFT/">FFT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/大數/">大數</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>從國小開始學起加減乘除，腦海裡計算加法比減法簡單，減法可以換成加法，乘法則可以換成數個加法。即使到了中國最強的利器——珠心算，我們學習這古老的快速運算時，也都採取這類方法，而除法最為複雜，需要去估算商，嘗試去扣完，再做細微調整。然而，當整數位數為 <span>$N$</span><!-- Has MathJax --> 時，加減法效能為 <span>$N$</span><!-- Has MathJax --> 基礎運算，而乘除法為 <span>$N^2$</span><!-- Has MathJax --> 次基礎運算，一次基礎運算通常定義在查表，例如背誦的九九乘法表，使得我們在借位和乘積運算達到非常快速。</p>
<p>這些方法在計算機發展後，硬體實作大致使用這些算法，直到了快速傅立葉 (FFT) 算法能在 <span>$O(N \log N)$</span><!-- Has MathJax --> 時間內完成旋積 (卷積) 計算，順利地解決了多項式乘法的問題，使得大數乘法能在 <span>$O(N \log N)$</span><!-- Has MathJax --> 時間內完成。</p>
<p>一開始我們知道乘法和除法都可以在 <span>$O(N^2)$</span><!-- Has MathJax --> 時間內完成，有了 FFT 之後，除法是不是也能跟乘法一樣在 <span>$O(N \log N)$</span><!-- Has MathJax --> 內完成？</p>
<h2 id="大數除法"><a href="#大數除法" class="headerlink" title="大數除法"></a>大數除法</h2><p>就目前研究來看，除法可以轉換成乘法運算，在數論的整數域中，若存在乘法反元素，除一個數相當於成一個數，而我們發展的計算機，有效運算為 32/64-bit，其超過的部分視為溢位 (overflow)，溢位則可視為模數。因此，早期 CPU 設計中，除法需要的運行次數比乘法多一些，編譯器會將除法轉換乘法運算 (企圖找到反元素)，來加速運算。現在，由於 intel 的黑魔法，導致幾乎一模一樣快而沒人注意到這些瑣事。</p>
<p>回過頭來，我們介紹一個藉由 FFT 達到的除法運算 <span>$O(N \log N \log N)$</span><!-- Has MathJax --> 的算法。而那多的 <span>$O(\log N)$</span><!-- Has MathJax --> 來自於牛頓迭代法。目標算出 <span>$C = \lfloor A/B \rfloor$</span><!-- Has MathJax -->，轉換成 <span>$C = \lfloor A \ast (1/B) \rfloor$</span><!-- Has MathJax -->，快速算出 <span>$1/B$</span><!-- Has MathJax --> 的值，採用牛頓迭代法。</p>
<p>額外要求整數長度 <span>$n = \text{length}(A)$</span><!-- Has MathJax -->、<span>$m = \text{length}(B)$</span><!-- Has MathJax -->，當計算 <span>$1/B$</span><!-- Has MathJax --> 時，要求精準度到小數點後 <span>$n$</span><!-- Has MathJax --> 位才行。</p>
<h3 id="牛頓迭代法"><a href="#牛頓迭代法" class="headerlink" title="牛頓迭代法"></a>牛頓迭代法</h3><p>目標求 <span>$f(x) = 0$</span><!-- Has MathJax --> 的一組解。</p>
<span>$$\begin{align}
x_{n+1} = x_n - \frac{f(x_n)}{f&apos;(x_n)}
\end{align}$$</span><!-- Has MathJax -->
<p>不斷地迭代逼近找解。若有多組解，則依賴初始值 <span>$x_0$</span><!-- Has MathJax --> 決定優先找到哪一組解。</p>
<blockquote>
<p>這部分也應用在快速開根號——反平方根快速演算法 <a href="https://en.wikipedia.org/wiki/Fast_inverse_square_root" target="_blank" rel="external">Fast inverse square root</a></p>
</blockquote>
<h3 id="倒數計算"><a href="#倒數計算" class="headerlink" title="倒數計算"></a>倒數計算</h3><p>藉由下述定義，找到 <span>$x = 1/B$</span><!-- Has MathJax --></p>
<span>$$\begin{align}
f(x) = \frac{1}{x} - B, \; f&apos;(x) = -\frac{1}{x^2}
\end{align}$$</span><!-- Has MathJax -->
<p>接著推導牛頓迭代法的公式</p>
<span>$$\begin{align}
x_{n+1} &amp;= x_n - \frac{f(x_n)}{f&apos;(x_n)} \\
&Tab;&Tab;&amp;= x_n - \frac{\frac{1}{x} - B}{-\frac{1}{x^2}} = (2 - x_n B) x_n
\end{align}$$</span><!-- Has MathJax -->
<h3 id="運行範例"><a href="#運行範例" class="headerlink" title="運行範例"></a>運行範例</h3><p>當 <span>$A = 7123456, \; B = 123$</span><!-- Has MathJax -->，計算倒數 <span>$1/B = 1/123$</span><!-- Has MathJax -->，由於 <span>$A$</span><!-- Has MathJax --> 為 <span>$n=7$</span><!-- Has MathJax --> 位數，小數點後精準 7 位，意即迭代比較小數點後 7 位不再變動時停止。</p>
<p>以下描述皆以 <strong>十進制</strong> (在程式運行時我們可能會偏向萬進制，甚至億進制來充分利用 32-bit 暫存器)</p>
<ul>
<li>決定 <span>$x_0$</span><!-- Has MathJax --> 是很重要的一步，這嚴重影響著迭代次數。</li>
<li><span>$x_0$</span><!-- Has MathJax --> 拿 <span>$B$</span><!-- Has MathJax --> 的最高位數 1 進行大數除小數，得到 <span>$x_0 = 0.01$</span><!-- Has MathJax --></li>
<li><span>$x_1 = (2 - x_0 \ast B) \ast x_0 = 0.0077$</span><!-- Has MathJax --></li>
<li><span>$x_2 = (2 - x_1 \ast B) \ast x_1 = 0.0081073$</span><!-- Has MathJax --></li>
<li><span>$x_3 = (2 - x_2 \ast B) \ast x_2 = 0.00813001$</span><!-- Has MathJax --></li>
<li><span>$x_4 = (2 - x_3 \ast B) \ast x_3 = 0.00813008$</span><!-- Has MathJax -->
</li>
</ul>
<p>接下來進行移位到整數部分，進行乘法後再移回去即可。</p>
<h3 id="實作細節"><a href="#實作細節" class="headerlink" title="實作細節"></a>實作細節</h3><h4 id="精準度"><a href="#精準度" class="headerlink" title="精準度"></a>精準度</h4><p>使用浮點數實作的 FFT，需要小心精準度，網路上有些代碼利用合角公式取代建表。這類型的優化，在精準度不需要很高的時候提供較好的效能，卻無法提供精準的值，誤差修正成了一道難題。</p>
<h4 id="牛頓迭代"><a href="#牛頓迭代" class="headerlink" title="牛頓迭代"></a>牛頓迭代</h4><p>由於有 FFT 造成的誤差，檢查收斂必須更加地保守，我們可能需要保留小數點下 <span>$n+10$</span><!-- Has MathJax --> 位，在收斂時檢查 <span>$n+5$</span><!-- Has MathJax --> 位確保收斂。通常收斂可以在 20 次左右完成，若發現迭代次數過多，有可能是第一個精準度造成的影響，盡可能使用內建函數得到的三角函數值。</p>
<h4 id="加速優化"><a href="#加速優化" class="headerlink" title="加速優化"></a>加速優化</h4><p>一般使用 IEEE-754 的浮點數格式，根據 FFT 的長度，要避開超過的震級，因此，在 Zerojudge b960 中，最多使用十萬進制進行加速。</p>
<h4 id="誤差修正"><a href="#誤差修正" class="headerlink" title="誤差修正"></a>誤差修正</h4><p>儘管算出的商 <span>$C=A \ast (1/B)$</span><!-- Has MathJax -->，得到的 <span>$C$</span><!-- Has MathJax --> 可能會差個 1，需要在後續乘法中檢驗。</p>
<h2 id="參考題目-資料"><a href="#參考題目-資料" class="headerlink" title="參考題目/資料"></a>參考題目/資料</h2><ul>
<li><a href="https://zerojudge.tw/ShowProblem?problemid=b960" target="_blank" rel="external">Zerojudge b960</a></li>
<li><a href="http://www.spoj.com/problems/VFDIV/" target="_blank" rel="external">SPOJ VFDIV - Very Fast Division</a></li>
<li><a href="http://edisonx.pixnet.net/blog/post/94569776-%5B%E5%A4%A7%E6%95%B8%5D-c-%E8%AA%9E%E8%A8%80%E5%A4%A7%E6%95%B8%E6%BC%94%E7%AE%97%E6%B3%95-for-general-(iii" target="_blank" rel="external">C 語言大數演算法 for general (III) - 大數除法 / Edison.X. Blog</a>—%E5%A4%A7%E6%95%B8)</li>
</ul>
<h2 id="b960-的亂碼"><a href="#b960-的亂碼" class="headerlink" title="b960 的亂碼"></a>b960 的亂碼</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="class"><span class="keyword">class</span> <span class="title">TOOL_FFT</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">complex</span> &#123;</span></div><div class="line">        T x, y;</div><div class="line">        <span class="keyword">complex</span>(T x = <span class="number">0</span>, T y = <span class="number">0</span>):</div><div class="line">            x(x), y(y) &#123;&#125;</div><div class="line">        <span class="keyword">complex</span> <span class="keyword">operator</span>+(<span class="keyword">const</span> <span class="keyword">complex</span> &amp;A) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">complex</span>(x+A.x,y+A.y);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">complex</span> <span class="keyword">operator</span>-(<span class="keyword">const</span> <span class="keyword">complex</span> &amp;A) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">complex</span>(x-A.x,y-A.y);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">complex</span> <span class="keyword">operator</span>*(<span class="keyword">const</span> <span class="keyword">complex</span> &amp;A) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">complex</span>(x*A.x-y*A.y,x*A.y+y*A.x);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    T PI;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1</span>&lt;&lt;<span class="number">17</span>;</div><div class="line">    <span class="keyword">complex</span> p[<span class="number">2</span>][MAXN];</div><div class="line">    <span class="keyword">int</span> reversePos[MAXN];</div><div class="line">    TOOL_FFT() &#123;</div><div class="line">        PI = <span class="built_in">acos</span>(<span class="number">-1</span>);</div><div class="line">        preprocessing();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">NumberOfBitsNeeded</span><span class="params">(<span class="keyword">int</span> PowerOfTwo)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;; ++i) &#123;</div><div class="line">            <span class="keyword">if</span> (PowerOfTwo &amp; (<span class="number">1</span> &lt;&lt; i)) &#123;</div><div class="line">                <span class="keyword">return</span> i;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">inline</span> uint32_t <span class="title">FastReverseBits</span><span class="params">(<span class="keyword">uint32_t</span> a, <span class="keyword">int</span> NumBits)</span> </span>&#123;</div><div class="line">        a = ( ( a &amp; <span class="number">0x55555555</span>U ) &lt;&lt; <span class="number">1</span> ) | ( ( a &amp; <span class="number">0xAAAAAAAA</span>U ) &gt;&gt; <span class="number">1</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x33333333</span>U ) &lt;&lt; <span class="number">2</span> ) | ( ( a &amp; <span class="number">0xCCCCCCCC</span>U ) &gt;&gt; <span class="number">2</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x0F0F0F0F</span>U ) &lt;&lt; <span class="number">4</span> ) | ( ( a &amp; <span class="number">0xF0F0F0F0</span>U ) &gt;&gt; <span class="number">4</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x00FF00FF</span>U ) &lt;&lt; <span class="number">8</span> ) | ( ( a &amp; <span class="number">0xFF00FF00</span>U ) &gt;&gt; <span class="number">8</span> ) ;</div><div class="line">        a = ( ( a &amp; <span class="number">0x0000FFFF</span>U ) &lt;&lt; <span class="number">16</span> ) | ( ( a &amp; <span class="number">0xFFFF0000</span>U ) &gt;&gt; <span class="number">16</span> ) ;</div><div class="line">        <span class="keyword">return</span> a &gt;&gt; (<span class="number">32</span> - NumBits);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">FFT</span><span class="params">(<span class="keyword">bool</span> InverseTransform, <span class="keyword">complex</span> In[], <span class="keyword">complex</span> Out[], <span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="comment">// simultaneous data copy and bit-reversal ordering into outputs</span></div><div class="line">        <span class="keyword">int</span> NumSamples = n;</div><div class="line">        <span class="keyword">int</span> NumBits = NumberOfBitsNeeded(NumSamples);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NumSamples; ++i) </div><div class="line">            Out[reversePos[i]] = In[i];</div><div class="line">            </div><div class="line">        <span class="comment">// the FFT process</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= NumBits; i++) &#123;</div><div class="line">            <span class="keyword">int</span> BlockSize = <span class="number">1</span>&lt;&lt;i, BlockEnd = BlockSize&gt;&gt;<span class="number">1</span>, BlockCnt = NumSamples/BlockSize;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; NumSamples; j += BlockSize) &#123;</div><div class="line">                <span class="keyword">complex</span> *t = p[InverseTransform];</div><div class="line">                <span class="keyword">int</span> k = <span class="number">0</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOP_SIZE 8</span></div><div class="line">                <span class="keyword">for</span> (; k+UNLOOP_SIZE &lt; BlockEnd; ) &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOP &#123; \</span></div><div class="line">    <span class="keyword">complex</span> a = (*t) * Out[k+j+BlockEnd]; \</div><div class="line">    Out[k+j+BlockEnd] = Out[k+j] - a; \</div><div class="line">    Out[k+j] = Out[k+j] + a;\</div><div class="line">    k++, t += BlockCnt;\</div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOP4 &#123;UNLOOP UNLOOP UNLOOP UNLOOP;&#125;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOOP8 &#123;UNLOOP4 UNLOOP4;&#125;</span></div><div class="line">                    UNLOOP8;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">for</span> (; k &lt; BlockEnd;)</div><div class="line">                    UNLOOP;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// normalize if inverse transform</span></div><div class="line">        <span class="keyword">if</span> (InverseTransform) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NumSamples; ++i) &#123;</div><div class="line">                Out[i] = Out[i].x / NumSamples;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">convolution</span><span class="params">(T *a, T *b, <span class="keyword">int</span> n, T *c)</span> </span>&#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">complex</span> s[MAXN], d1[MAXN], d2[MAXN], y[MAXN];</div><div class="line">    	n = MAXN;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</div><div class="line">            s[i] = <span class="keyword">complex</span>(a[i], <span class="number">0</span>);</div><div class="line">        FFT(<span class="literal">false</span>, s, d1, n);</div><div class="line">        s[<span class="number">0</span>] = <span class="keyword">complex</span>(b[<span class="number">0</span>], <span class="number">0</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++i)</div><div class="line">            s[i] = <span class="keyword">complex</span>(b[n - i], <span class="number">0</span>);</div><div class="line">        FFT(<span class="literal">false</span>, s, d2, n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</div><div class="line">            y[i] = d1[i] * d2[i];</div><div class="line">        FFT(<span class="literal">true</span>, y, s, n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</div><div class="line">            c[i] = s[i].x;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">preprocessing</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> n = MAXN;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i ++) &#123;</div><div class="line">            p[<span class="number">0</span>][i] = <span class="keyword">complex</span>(<span class="built_in">cos</span>(<span class="number">2</span>*i*PI / n), <span class="built_in">sin</span>(<span class="number">2</span>*i*PI / n));</div><div class="line">            p[<span class="number">1</span>][i] = <span class="keyword">complex</span>(p[<span class="number">0</span>][i].x, -p[<span class="number">0</span>][i].y);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> NumBits = NumberOfBitsNeeded(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">        	reversePos[i] = FastReverseBits(i, NumBits);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">TOOL_FFT&lt;<span class="keyword">double</span>&gt; tool;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BigInt</span> &#123;</span></div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> *v;</div><div class="line">    <span class="keyword">int</span> size;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> DIGITS = <span class="number">5</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1</span>&lt;&lt;<span class="number">17</span>;</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(<span class="keyword">const</span> BigInt a, <span class="keyword">const</span> BigInt b)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = MAXN<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">            <span class="keyword">if</span> (a.v[i] &lt; b.v[i])</div><div class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">            <span class="keyword">if</span> (a.v[i] &gt; b.v[i])</div><div class="line">                <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">str2int</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">long</span> <span class="keyword">long</span> buf[])</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> n = <span class="built_in">strlen</span>(s);</div><div class="line">        size = (n+DIGITS<span class="number">-1</span>) / DIGITS;</div><div class="line">        <span class="keyword">int</span> cnt = n%DIGITS == <span class="number">0</span> ? DIGITS : n%DIGITS;</div><div class="line">        <span class="keyword">int</span> x = <span class="number">0</span>, pos = size<span class="number">-1</span>;</div><div class="line">        v = buf;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            x = x*<span class="number">10</span> + s[i] - <span class="string">'0'</span>;</div><div class="line">            <span class="keyword">if</span> (--cnt == <span class="number">0</span>) &#123;</div><div class="line">                cnt = DIGITS;</div><div class="line">                v[pos--] = x, x = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">println</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%lld"</span>, v[size<span class="number">-1</span>]);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> pos = size<span class="number">-2</span>; pos &gt;= <span class="number">0</span>; pos--)</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%05lld"</span>, v[pos]);</div><div class="line">        <span class="built_in">puts</span>(<span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function">BigInt <span class="title">multiply</span><span class="params">(<span class="keyword">const</span> BigInt &amp;other, <span class="keyword">long</span> <span class="keyword">long</span> buf[])</span> <span class="keyword">const</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> m = MAXN;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">double</span> na[MAXN], nb[MAXN];</div><div class="line">        <span class="keyword">static</span> <span class="keyword">double</span> tmp[MAXN];</div><div class="line">        <span class="built_in">memset</span>(na+size, <span class="number">0</span>, <span class="keyword">sizeof</span>(v[<span class="number">0</span>])*(m-size));</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</div><div class="line">            na[i] = v[i];</div><div class="line">        <span class="built_in">memset</span>(nb+<span class="number">1</span>, <span class="number">0</span>, <span class="keyword">sizeof</span>(v[<span class="number">0</span>])*(m-other.size));</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, j = m<span class="number">-1</span>; i &lt; other.size; i++, j--)</div><div class="line">            nb[j] = other.v[i];</div><div class="line">        nb[<span class="number">0</span>] = other.v[<span class="number">0</span>];</div><div class="line">        tool.convolution(na, nb, m, tmp);</div><div class="line">        BigInt ret;</div><div class="line">        ret.size = m;</div><div class="line">        ret.v = buf;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++)</div><div class="line">        	buf[i] = (<span class="keyword">long</span> <span class="keyword">long</span>) (tmp[i] + <span class="number">1.5e-1</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">        	<span class="keyword">if</span> (buf[i] &gt;= <span class="number">100000</span>)</div><div class="line">        		buf[i+<span class="number">1</span>] += buf[i]/<span class="number">100000</span>, buf[i] %= <span class="number">100000</span>;</div><div class="line">        &#125;</div><div class="line">        ret.reduce();</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reduce</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (size &gt; <span class="number">1</span> &amp;&amp; <span class="built_in">fabs</span>(v[size<span class="number">-1</span>]) &lt; <span class="number">5e-1</span>)</div><div class="line">            size--;</div><div class="line">    &#125;</div><div class="line">    <span class="function">BigInt <span class="title">divide</span><span class="params">(<span class="keyword">const</span> BigInt &amp;other, <span class="keyword">long</span> <span class="keyword">long</span> buf[])</span> <span class="keyword">const</span> </span>&#123;</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">int</span> cmp = compare(*<span class="keyword">this</span>, other);</div><div class="line">            BigInt ret;</div><div class="line">            ret.size = MAXN<span class="number">-1</span>, ret.v = buf;</div><div class="line">            <span class="keyword">if</span> (cmp == <span class="number">0</span>) &#123;</div><div class="line">                <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf[<span class="number">0</span>])*MAXN);</div><div class="line">                buf[<span class="number">0</span>] = <span class="number">1</span>;</div><div class="line">                ret.reduce();</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf[<span class="number">0</span>])*MAXN);</div><div class="line">                buf[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">                ret.reduce();</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// A / B = A * (1/B)</span></div><div class="line">        <span class="comment">// x' = (2 - x * B) * x</span></div><div class="line">        <span class="keyword">int</span> m = MAXN;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">double</span> na[MAXN], nb[MAXN];</div><div class="line">        <span class="keyword">static</span> <span class="keyword">double</span> invB[MAXN], netB[MAXN], tmpB[MAXN];</div><div class="line">        <span class="keyword">static</span> <span class="keyword">long</span> <span class="keyword">long</span> bufB[MAXN];</div><div class="line">        <span class="keyword">int</span> PRECISION = size+<span class="number">10</span>;</div><div class="line">        <span class="built_in">memset</span>(nb+<span class="number">1</span>, <span class="number">0</span>, <span class="keyword">sizeof</span>(v[<span class="number">0</span>])*(m-other.size));</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, j = m<span class="number">-1</span>; i &lt; other.size; i++, j--)</div><div class="line">            nb[j] = other.v[i];</div><div class="line">        nb[<span class="number">0</span>] = other.v[<span class="number">0</span>];</div><div class="line">        </div><div class="line">        <span class="built_in">memset</span>(invB, <span class="number">0</span>, <span class="keyword">sizeof</span>(invB[<span class="number">0</span>])*m);</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">long</span> <span class="keyword">long</span> t = <span class="number">100000</span>, a = other.v[other.size<span class="number">-1</span>];</div><div class="line">            <span class="keyword">if</span> (other.size<span class="number">-2</span> &gt;= <span class="number">0</span>)</div><div class="line">                t = t*<span class="number">100000</span>, a = a*<span class="number">100000</span>+other.v[other.size<span class="number">-2</span>];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = PRECISION-other.size; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">                invB[i] = t/a;</div><div class="line">                t = (t%a)*<span class="number">100000</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> it = <span class="number">0</span>; it &lt; <span class="number">100</span>; it++) &#123;</div><div class="line">            <span class="comment">// netB = xi * B</span></div><div class="line">            tool.convolution(invB, nb, m, netB);</div><div class="line">            <span class="keyword">long</span> <span class="keyword">long</span> carry = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= PRECISION*<span class="number">2</span>; i++) &#123;</div><div class="line">            	bufB[i] = carry + (<span class="keyword">long</span> <span class="keyword">long</span>) (netB[i] + <span class="number">1.5e-1</span>);</div><div class="line">            	<span class="keyword">if</span> (bufB[i] &gt;= <span class="number">100000</span>)</div><div class="line">            		carry = bufB[i]/<span class="number">100000</span>, bufB[i] %= <span class="number">100000</span>;</div><div class="line">            	<span class="keyword">else</span></div><div class="line">            		carry = <span class="number">0</span>;</div><div class="line">                bufB[i] = -bufB[i];</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// tmpB = 2 - xi * B</span></div><div class="line">            bufB[PRECISION] += <span class="number">2</span>;</div><div class="line">            <span class="built_in">memset</span>(tmpB, <span class="number">0</span>, <span class="keyword">sizeof</span>(tmpB[<span class="number">0</span>])*m);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= PRECISION*<span class="number">2</span>; i++) &#123;</div><div class="line">            	<span class="keyword">if</span> (bufB[i] &lt; <span class="number">0</span>)</div><div class="line">            		bufB[i] += <span class="number">100000</span>, bufB[i+<span class="number">1</span>]--;</div><div class="line">            	<span class="keyword">if</span> (i != <span class="number">0</span>)</div><div class="line">            		tmpB[m-i] = bufB[i];</div><div class="line">            	<span class="keyword">else</span></div><div class="line">            		tmpB[i] = bufB[i];</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// netB = tmpB * invB</span></div><div class="line">            tool.convolution(invB, tmpB, m, netB);</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">long</span> <span class="keyword">long</span> carry = <span class="number">0</span>;</div><div class="line">                <span class="built_in">memset</span>(bufB, <span class="number">0</span>, <span class="keyword">sizeof</span>(bufB[<span class="number">0</span>])*m);</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= PRECISION*<span class="number">2</span>; i++) &#123;</div><div class="line">                    bufB[i] = carry + (<span class="keyword">long</span> <span class="keyword">long</span>) (netB[i] + <span class="number">1.5e-1</span>);</div><div class="line">                    <span class="keyword">if</span> (bufB[i] &gt;= <span class="number">100000</span>)</div><div class="line">            			carry = bufB[i]/<span class="number">100000</span>, bufB[i] %= <span class="number">100000</span>;</div><div class="line">            		<span class="keyword">else</span></div><div class="line">            			carry = <span class="number">0</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            &#123;</div><div class="line">                <span class="keyword">int</span> same = <span class="number">1</span>;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = PRECISION; same &amp;&amp; i &gt;= <span class="number">5</span>; i--)</div><div class="line">                    same &amp;= ((<span class="keyword">long</span> <span class="keyword">long</span>) (invB[i]) == bufB[i+PRECISION]);</div><div class="line">                <span class="keyword">if</span> (same)</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="built_in">memset</span>(invB, <span class="number">0</span>, <span class="keyword">sizeof</span>(invB[<span class="number">0</span>])*m);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i+PRECISION &lt;= PRECISION*<span class="number">2</span>; i++)</div><div class="line">            	invB[i] = bufB[i+PRECISION];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="built_in">memset</span>(na+<span class="number">1</span>, <span class="number">0</span>, <span class="keyword">sizeof</span>(v[<span class="number">0</span>])*(m-size));</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, j = m<span class="number">-1</span>; i &lt; size; i++, j--)</div><div class="line">            na[j] = v[i];</div><div class="line">        na[<span class="number">0</span>] = v[<span class="number">0</span>];</div><div class="line">        tool.convolution(invB, na, m, netB);</div><div class="line">        </div><div class="line">        BigInt ret;</div><div class="line">        ret.size = m<span class="number">-1</span>;</div><div class="line">        ret.v = buf;</div><div class="line">        <span class="keyword">long</span> <span class="keyword">long</span> carry = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">        	buf[i] = carry + (<span class="keyword">long</span> <span class="keyword">long</span>) (netB[i] + <span class="number">1.5e-1</span>);</div><div class="line">        	<span class="keyword">if</span> (buf[i] &gt;= <span class="number">100000</span>)</div><div class="line">        		carry = buf[i]/<span class="number">100000</span>, buf[i] %= <span class="number">100000</span>;</div><div class="line">        	<span class="keyword">else</span></div><div class="line">        		carry = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i+PRECISION &lt; m; i++)</div><div class="line">            buf[i] = buf[i+PRECISION];</div><div class="line">        <span class="built_in">memset</span>(buf+PRECISION, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf[<span class="number">0</span>])*(m-PRECISION));</div><div class="line">        &#123;</div><div class="line">        	<span class="built_in">memset</span>(na, <span class="number">0</span>, <span class="keyword">sizeof</span>(na[<span class="number">0</span>])*m);</div><div class="line">        	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, j = m<span class="number">-1</span>; i &lt; m<span class="number">-1</span>; i++, j--)</div><div class="line">                na[j] = buf[i];</div><div class="line">            na[<span class="number">0</span>] = buf[<span class="number">0</span>];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++)</div><div class="line">            	nb[i] = other.v[i];</div><div class="line">    		tool.convolution(nb, na, m, netB);</div><div class="line">    		<span class="keyword">long</span> <span class="keyword">long</span> carry = <span class="number">0</span>;</div><div class="line">    		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">    			bufB[i] = (carry + (<span class="keyword">long</span> <span class="keyword">long</span>) (netB[i] + <span class="number">1e-1</span>));</div><div class="line">            	<span class="keyword">if</span> (bufB[i] &gt;= <span class="number">100000</span>)</div><div class="line">            		carry = bufB[i]/<span class="number">100000</span>, bufB[i] %= <span class="number">100000</span>;</div><div class="line">            	<span class="keyword">else</span></div><div class="line">            		carry = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">            carry = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">                bufB[i] = v[i] - bufB[i] + carry;</div><div class="line">                <span class="keyword">if</span> (bufB[i] &lt; <span class="number">0</span>)</div><div class="line">            		bufB[i] += <span class="number">100000</span>, carry = <span class="number">-1</span>;</div><div class="line">            	<span class="keyword">else</span></div><div class="line">            		carry = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">            BigInt R;</div><div class="line">            R.size = m<span class="number">-1</span>, R.v = bufB;</div><div class="line">            <span class="keyword">if</span> (compare(other, R) &lt;= <span class="number">0</span>) &#123;</div><div class="line">                buf[<span class="number">0</span>]++;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; buf[i] &gt;= <span class="number">100000</span>; i++)</div><div class="line">                    buf[i+<span class="number">1</span>]++, buf[i] -= <span class="number">100000</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ret.reduce();</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> sa[<span class="number">1</span>&lt;&lt;<span class="number">20</span>], sb[<span class="number">1</span>&lt;&lt;<span class="number">20</span>];</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%s %s"</span>, sa, sb) == <span class="number">2</span>) &#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">long</span> <span class="keyword">long</span> da[<span class="number">1</span>&lt;&lt;<span class="number">19</span>], db[<span class="number">1</span>&lt;&lt;<span class="number">19</span>], dc[<span class="number">1</span>&lt;&lt;<span class="number">19</span>];</div><div class="line">        </div><div class="line">        BigInt a, b, c;</div><div class="line">        a.str2int(sa, da);</div><div class="line">        b.str2int(sb, db);</div><div class="line">        c = a.divide(b, dc);</div><div class="line">        c.println();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-2017-google-code-jam-qr" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/09/2017-google-code-jam-qr/" class="article-date">
  <time datetime="2017-04-09T06:21:32.000Z" itemprop="datePublished">2017-04-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="http://i.imgur.com/KrHRAeT.jpg" rel="gallery_ckxv1wm7d000oa8vn6ytybo5i">
        <img src="http://i.imgur.com/KrHRAeT.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/09/2017-google-code-jam-qr/">2017 Google Code Jam Round QR</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/04/09/2017-google-code-jam-qr/" data-id="ckxv1wm7d000oa8vn6ytybo5i" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/04/09/2017-google-code-jam-qr/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/二分匹配/">二分匹配</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/數學/">數學</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/貪心/">貪心</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <p>「在 24 小時內想不到解法，就註定這一生為處男」－《解題暴君》</p>
<blockquote>
<p>感謝小夥伴們、茵可、妮可的提醒和翻譯，提醒要比賽，結果題目意思猜了一個下午 …</p>
</blockquote>
<h2 id="A-Oversized-Pancake-Flipper"><a href="#A-Oversized-Pancake-Flipper" class="headerlink" title="A. Oversized Pancake Flipper"></a>A. Oversized Pancake Flipper</h2><p>有 <span>$N$</span><!-- Has MathJax --> 個煎餅排成一列，每個煎餅有正反兩面，分別以 <code>+</code> 和 <code>-</code> 表示，現在有一個超大的煎餅翻轉氣，一次可以翻轉恰好連續 <span>$K$</span><!-- Has MathJax --> 個煎餅的狀態，若一次不滿 <span>$K$</span><!-- Has MathJax --> 視為無效操作。給予起始盤面，請問至少要操作幾次才能使其全部都成為正面。</p>
<p>由邊界開始觀察，最左的正面一定不再被翻，如果翻了必然為多一次操作，不斷地推移下去，只有最左邊的反面要依序翻轉，貪心模擬即可。</p>
<h2 id="B-Tidy-Numbers"><a href="#B-Tidy-Numbers" class="headerlink" title="B. Tidy Numbers"></a>B. Tidy Numbers</h2><p>要找到一種特別的數字，這些數字滿足從高位到低位的每一位呈現非嚴格遞減，請問從數字 <span>$1$</span><!-- Has MathJax --> 判斷到 <span>$N$</span><!-- Has MathJax --> 最後一個滿足的數字為何。</p>
<p>最直觀的方案就 <span>$N$</span><!-- Has MathJax --> 開始倒退過去找第一個符合的解。為解決大測資，<span>$N$</span><!-- Has MathJax --> 大到不太可能窮舉，即便很容易出現 <code>???999999</code> 的解，我們可以用更簡單的貪心算法找到這個小於等於 <span>$N$</span><!-- Has MathJax --> 的解。</p>
<ul>
<li>例如輸入為 423</li>
<li>從最高位開始窮舉，第一位不能放 4，其原因在於貪心 444 已經大於 423，退而求其次 333 是可行的一組解</li>
<li>接著再考慮下一位時，我們不必要求小於等於 2，因為前一次窮舉保證小於 423，直接從 9 開始嘗試 399 是否符合解 … 類推。</li>
</ul>
<p>這樣的解法效能為 <span>$O(m^2)$</span><!-- Has MathJax -->，由於位數很小，就可以偷懶地去寫它。</p>
<h2 id="C-Bathroom-Stalls"><a href="#C-Bathroom-Stalls" class="headerlink" title="C. Bathroom Stalls"></a>C. Bathroom Stalls</h2><p>在公共澡堂中，有 <span>$N$</span><!-- Has MathJax --> 個位子排成一列，最左和最右有守衛。現在 <span>$M$</span><!-- Has MathJax --> 名使用者依照順序進入澡堂，每一個人會遠則離其他人盡可能遠的位置，意即往左和往右到第一個人的距離最小值最大化，往左距離為 <span>$L_s$</span><!-- Has MathJax --> 往右為 <span>$R_s$</span><!-- Has MathJax -->，這樣的位置也許會有好幾個，這時候優先選擇 <span>$\max(L_s, R_s)$</span><!-- Has MathJax --> 最大的那一個 (也就是盡可能靠左側)。請問最後一個人的 <span>$\max(L_s, R_s)$</span><!-- Has MathJax --> 和 <span>$\min(L_s, R_s)$</span><!-- Has MathJax --> 分別為多少？</p>
<p>若使用純模擬，時間複雜度可能高達 <span>$O(NM)$</span><!-- Has MathJax -->，大測資是無法在時間內通過的。仔細觀察到題目並未要求找到最後一個人的所在位置，在數學推敲上並不要求太高，那麼我們轉向繼續連續為空的區段分別有多少個。</p>
<ul>
<li>例如一開始長度為 <span>$N=10$</span><!-- Has MathJax --></li>
<li>有一段長度為 10，第一個人必然會將這一個分成兩段 4 和 5</li>
<li>下一個人則會把 5 再分成 2 和 2</li>
<li>下一個人則會把 4 再分成 1 和 2</li>
</ul>
<p>計算過程中，我們按照長度高到低依序挑出，便可以知道最終的結果。為了加速運算，需要紀錄某個長度有多少個，一次統計會使用相同挑選方案的人，來逼近最終的 <span>$M$</span><!-- Has MathJax --> 個人。時間複雜度 <span>$O(\log N)$</span><!-- Has MathJax -->？</p>
<h2 id="D-Fashion-Show"><a href="#D-Fashion-Show" class="headerlink" title="D. Fashion Show"></a>D. Fashion Show</h2><p>在一個方型時尚展場中，我們可以放置 3 種不同的服裝，分別為 <code>+</code>, <code>x</code>, <code>o</code> 三種，其中 <code>+</code>, <code>x</code> 可以為展場增添 1 分，<code>o</code> 可以增添 2 分，我們希望按照下述的規則使得展場總分最高：</p>
<ul>
<li>對於同行或者同列的放置服裝，任兩個之中，至少要有一個為 <code>+</code></li>
<li>對於斜對角 45 度的放置服裝，任兩個之中，至少要有一個為 <code>x</code></li>
</ul>
<p>現在給予一個空的展場和一些已經放置服裝的位置，你只能升級 <code>+</code>, <code>x</code> 服裝為 <code>o</code> 和增加新的服裝在空位置上，使得分數最高，輸出其中一組解即可。</p>
<p>如果只看行列，通常我們可以轉換成二分匹配，其中 <code>(行 i) -- (列 j)</code> 表明了一種放置方案，而中間的匹配邊成為最終的放置選擇。現在多了斜對角，匹配成為最難處理的部份，</p>
<p>題目的規則可以轉換成，行列最多放置一個非 <code>+</code>，同理對角最多放置一個非 <code>x</code>。按照原先的匹配思路，如果放置 <code>x</code>，則相當於匹配某行某列。同理，放置 <code>+</code>，則相當於匹配某斜和某反斜。這裡我們發現如果同時匹配，則視為 <code>o</code>，其匹配數恰好符合題目要求的得分。</p>
<p>對於已經擺設上去的點，預先將其匹配，並且那些行、列、斜線及反斜的代表點則不再與其他節點匹配，最後，我們構造節點個數為 <span>$6N$</span><!-- Has MathJax --> 的二分匹配圖，運行匈牙利或者是最大流算法都可解決。</p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><h3 id="A"><a href="#A" class="headerlink" title="A"></a>A</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> testcase, cases = <span class="number">0</span>, K;</div><div class="line">    <span class="keyword">char</span> s[<span class="number">1024</span>];</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;testcase);</div><div class="line">    <span class="keyword">while</span> (testcase--) &#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%s %d"</span>, s, &amp;K);</div><div class="line">        <span class="keyword">int</span> n = <span class="built_in">strlen</span>(s);</div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>, valid = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (s[i] == <span class="string">'+'</span>)</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            <span class="keyword">if</span> (i+K &lt;= n) &#123;</div><div class="line">                ret++;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; K; j++) &#123;</div><div class="line">                    <span class="keyword">if</span> (s[i+j] == <span class="string">'-'</span>)</div><div class="line">                        s[i+j] = <span class="string">'+'</span>;</div><div class="line">                    <span class="keyword">else</span></div><div class="line">                        s[i+j] = <span class="string">'-'</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        valid = <span class="number">1</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            valid &amp;= s[i] == <span class="string">'+'</span>;</div><div class="line">        <span class="keyword">if</span> (valid)</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"Case #%d: %d\n"</span>, ++cases, ret);</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="built_in">printf</span>(<span class="string">"Case #%d: IMPOSSIBLE\n"</span>, ++cases);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="B"><a href="#B" class="headerlink" title="B"></a>B</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> testcase, cases = <span class="number">0</span>;</div><div class="line">    <span class="keyword">uint64_t</span> N;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;testcase);</div><div class="line">    <span class="keyword">while</span> (testcase--) &#123;</div><div class="line">        <span class="keyword">char</span> s[<span class="number">1024</span>];</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%s"</span>, s);</div><div class="line">        <span class="built_in">sscanf</span>(s, <span class="string">"%llu"</span>, &amp;N);</div><div class="line">        <span class="keyword">int</span> n = <span class="built_in">strlen</span>(s);</div><div class="line">        <span class="keyword">uint64_t</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> begin_small = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            <span class="keyword">int</span> prev = ret%<span class="number">10</span>;</div><div class="line">            <span class="keyword">int</span> st = begin_small ? <span class="number">9</span> : (s[i]-<span class="string">'0'</span>);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = st; j &gt;= prev; j--) &#123;</div><div class="line">                <span class="keyword">uint64_t</span> test = ret;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = i; k &lt; n; k++)</div><div class="line">                    test = test*<span class="number">10</span> + j;</div><div class="line">                <span class="keyword">if</span> (test &lt;= N) &#123;</div><div class="line">                    <span class="keyword">if</span> (!begin_small &amp;&amp; j != s[i]-<span class="string">'0'</span>)</div><div class="line">                        begin_small = <span class="number">1</span>;</div><div class="line">                    ret = ret*<span class="number">10</span> + j;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Case #%d: %llu\n"</span>, ++cases, ret);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="C"><a href="#C" class="headerlink" title="C"></a>C</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> testcase, cases = <span class="number">0</span>;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;testcase);</div><div class="line">    <span class="keyword">while</span> (testcase--) &#123;</div><div class="line">        <span class="keyword">long</span> <span class="keyword">long</span> n, m;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%lld %lld"</span>, &amp;n, &amp;m);</div><div class="line">        <span class="built_in">map</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">long</span> <span class="keyword">long</span>&gt; S;</div><div class="line">        S[n] = <span class="number">1</span>;</div><div class="line">        <span class="keyword">long</span> <span class="keyword">long</span> ret1 = <span class="number">-1</span>, ret2 = <span class="number">-1</span>;</div><div class="line">        <span class="keyword">while</span> (m) &#123;</div><div class="line">            pair&lt;<span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">long</span> <span class="keyword">long</span>&gt; e = *S.rbegin();</div><div class="line">            S.erase(e.first);</div><div class="line">            <span class="keyword">if</span> (e.second &gt;= m) &#123;</div><div class="line">                ret1 = e.first/<span class="number">2</span>, ret2 = (e.first<span class="number">-1</span>)/<span class="number">2</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            m -= e.second;</div><div class="line">            <span class="keyword">if</span> (e.first%<span class="number">2</span>) &#123;</div><div class="line">                <span class="keyword">long</span> <span class="keyword">long</span> t = e.first/<span class="number">2</span>;</div><div class="line">                S[t] += <span class="number">2L</span>L*e.second;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">long</span> <span class="keyword">long</span> t = e.first/<span class="number">2</span>;</div><div class="line">                S[t] += e.second;</div><div class="line">                S[t<span class="number">-1</span>] += e.second;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Case #%d: %lld %lld\n"</span>, ++cases, ret1, ret2);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="D"><a href="#D" class="headerlink" title="D"></a>D</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXV = <span class="number">40010</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXE = MAXV * <span class="number">200</span> * <span class="number">2</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> INF = <span class="number">1</span>&lt;&lt;<span class="number">29</span>;</div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> v, cap, flow;</div><div class="line">    Edge *next, *re;</div><div class="line">&#125; Edge;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MaxFlow</span> &#123;</span></div><div class="line">    <span class="keyword">public</span>:</div><div class="line">    Edge edge[MAXE], *adj[MAXV], *pre[MAXV], *arc[MAXV];</div><div class="line">    <span class="keyword">int</span> e, n, level[MAXV], lvCnt[MAXV], Q[MAXV];</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Init</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">        n = x, e = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i) adj[i] = <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Addedge</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> flow)</span></span>&#123;</div><div class="line">        edge[e].v = y, edge[e].cap = flow, edge[e].next = adj[x];</div><div class="line">        edge[e].re = &amp;edge[e+<span class="number">1</span>], adj[x] = &amp;edge[e++];</div><div class="line">        edge[e].v = x, edge[e].cap = <span class="number">0</span>, edge[e].next = adj[y];</div><div class="line">        edge[e].re = &amp;edge[e<span class="number">-1</span>], adj[y] = &amp;edge[e++];</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Bfs</span><span class="params">(<span class="keyword">int</span> v)</span></span>&#123;</div><div class="line">        <span class="keyword">int</span> front = <span class="number">0</span>, rear = <span class="number">0</span>, r = <span class="number">0</span>, dis = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i) level[i] = n, lvCnt[i] = <span class="number">0</span>;</div><div class="line">        level[v] = <span class="number">0</span>, ++lvCnt[<span class="number">0</span>];</div><div class="line">        Q[rear++] = v;</div><div class="line">        <span class="keyword">while</span> (front != rear)&#123;</div><div class="line">            <span class="keyword">if</span> (front == r) ++dis, r = rear;</div><div class="line">            v = Q[front++];</div><div class="line">            <span class="keyword">for</span> (Edge *i = adj[v]; i != <span class="literal">NULL</span>; i = i-&gt;next) &#123;</div><div class="line">                <span class="keyword">int</span> t = i-&gt;v;</div><div class="line">                <span class="keyword">if</span> (level[t] == n) level[t] = dis, Q[rear++] = t, ++lvCnt[dis];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">Maxflow</span><span class="params">(<span class="keyword">int</span> s, <span class="keyword">int</span> t)</span></span>&#123;</div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>, i, j;</div><div class="line">        Bfs(t);</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; ++i) pre[i] = <span class="literal">NULL</span>, arc[i] = adj[i];</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; e; ++i) edge[i].flow = edge[i].cap;</div><div class="line">        i = s;</div><div class="line">        <span class="keyword">while</span> (level[s] &lt; n)&#123;</div><div class="line">            <span class="keyword">while</span> (arc[i] &amp;&amp; (level[i] != level[arc[i]-&gt;v]+<span class="number">1</span> || !arc[i]-&gt;flow)) </div><div class="line">                arc[i] = arc[i]-&gt;next;</div><div class="line">            <span class="keyword">if</span> (arc[i])&#123;</div><div class="line">                j = arc[i]-&gt;v;</div><div class="line">                pre[j] = arc[i];</div><div class="line">                i = j;</div><div class="line">                <span class="keyword">if</span> (i == t)&#123;</div><div class="line">                    <span class="keyword">int</span> update = INF;</div><div class="line">                    <span class="keyword">for</span> (Edge *p = pre[t]; p != <span class="literal">NULL</span>; p = pre[p-&gt;re-&gt;v])</div><div class="line">                        <span class="keyword">if</span> (update &gt; p-&gt;flow) update = p-&gt;flow;</div><div class="line">                    ret += update;</div><div class="line">                    <span class="keyword">for</span> (Edge *p = pre[t]; p != <span class="literal">NULL</span>; p = pre[p-&gt;re-&gt;v])</div><div class="line">                        p-&gt;flow -= update, p-&gt;re-&gt;flow += update;</div><div class="line">                    i = s;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span>&#123;</div><div class="line">                <span class="keyword">int</span> depth = n<span class="number">-1</span>;</div><div class="line">                <span class="keyword">for</span> (Edge *p = adj[i]; p != <span class="literal">NULL</span>; p = p-&gt;next)</div><div class="line">                    <span class="keyword">if</span> (p-&gt;flow &amp;&amp; depth &gt; level[p-&gt;v]) depth = level[p-&gt;v];</div><div class="line">                <span class="keyword">if</span> (--lvCnt[level[i]] == <span class="number">0</span>) <span class="keyword">return</span> ret;</div><div class="line">                level[i] = depth+<span class="number">1</span>;</div><div class="line">                ++lvCnt[level[i]];</div><div class="line">                arc[i] = adj[i];</div><div class="line">                <span class="keyword">if</span> (i != s) i = pre[i]-&gt;re-&gt;v;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125; g;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> testcase, cases = <span class="number">0</span>;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;testcase);</div><div class="line">    <span class="keyword">while</span> (testcase--) &#123;</div><div class="line">        <span class="keyword">int</span> n, m;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m);</div><div class="line">        </div><div class="line">        g.Init(<span class="number">6</span>*n+<span class="number">5</span>);</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> mm[<span class="number">800</span>][<span class="number">800</span>];</div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> mmPos[<span class="number">800</span>][<span class="number">800</span>][<span class="number">2</span>];</div><div class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        <span class="built_in">memset</span>(mm, <span class="number">0</span>, <span class="keyword">sizeof</span>(mm));</div><div class="line">        <span class="keyword">int</span> source = <span class="number">6</span>*n+<span class="number">1</span>, sink = <span class="number">6</span>*n+<span class="number">2</span>;</div><div class="line">        <span class="keyword">int</span> board[<span class="number">128</span>][<span class="number">128</span>] = &#123;&#125;;</div><div class="line">        <span class="keyword">int</span> <span class="keyword">board_t</span>[<span class="number">128</span>][<span class="number">128</span>] = &#123;&#125;;</div><div class="line">        <span class="keyword">char</span> board_s[<span class="number">128</span>][<span class="number">128</span>] = &#123;&#125;;</div><div class="line">        <span class="keyword">int</span> ban[<span class="number">800</span>] = &#123;&#125;;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</div><div class="line">                mm[i][j+n] = <span class="number">1</span>;</div><div class="line">                mm[(i+j)+<span class="number">2</span>*n][(i-j+n<span class="number">-1</span>)+<span class="number">4</span>*n] = <span class="number">1</span>;</div><div class="line">                mmPos[i][j+n][<span class="number">0</span>] = i;</div><div class="line">                mmPos[i][j+n][<span class="number">1</span>] = j;</div><div class="line">                mmPos[(i+j)+<span class="number">2</span>*n][(i-j+n<span class="number">-1</span>)+<span class="number">4</span>*n][<span class="number">0</span>] = i;</div><div class="line">                mmPos[(i+j)+<span class="number">2</span>*n][(i-j+n<span class="number">-1</span>)+<span class="number">4</span>*n][<span class="number">1</span>] = j;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</div><div class="line">            <span class="keyword">char</span> s[<span class="number">16</span>];</div><div class="line">            <span class="keyword">int</span> x, y;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%s %d %d"</span>, s, &amp;x, &amp;y);</div><div class="line">            x--, y--;</div><div class="line">            board_s[x][y] = s[<span class="number">0</span>];</div><div class="line">            <span class="keyword">if</span> (s[<span class="number">0</span>] == <span class="string">'o'</span>) &#123;</div><div class="line">                ret += <span class="number">2</span>, board[x][y] = <span class="number">2</span>;</div><div class="line">                ban[x] = <span class="number">1</span>, ban[y+n] = <span class="number">1</span>;</div><div class="line">                ban[(x+y)+(<span class="number">2</span>*n)] = <span class="number">1</span>;</div><div class="line">                ban[(x-y+n<span class="number">-1</span>)+<span class="number">4</span>*n] = <span class="number">1</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s[<span class="number">0</span>] == <span class="string">'+'</span>) &#123;</div><div class="line">                ret += <span class="number">1</span>, board[x][y] = <span class="number">1</span>;</div><div class="line">                ban[(x+y)+(<span class="number">2</span>*n)] = <span class="number">1</span>;</div><div class="line">                ban[(x-y+n<span class="number">-1</span>)+<span class="number">4</span>*n] = <span class="number">1</span>;</div><div class="line"><span class="comment">//				printf("%d %d\n", x+y+2*n, x-y+n-1+4*n);</span></div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s[<span class="number">0</span>] == <span class="string">'x'</span>) &#123;</div><div class="line">                ret += <span class="number">1</span>, board[x][y] = <span class="number">1</span>;</div><div class="line">                ban[x] = <span class="number">1</span>, ban[y+n] = <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">memcpy</span>(<span class="keyword">board_t</span>, board, <span class="keyword">sizeof</span>(board));</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">            g.Addedge(source, i, <span class="number">1</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>*n; i &lt; <span class="number">4</span>*n; i++)</div><div class="line">            g.Addedge(source, i, <span class="number">1</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = n; i &lt; <span class="number">2</span>*n; i++)</div><div class="line">            g.Addedge(i, sink, <span class="number">1</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">4</span>*n; i &lt; <span class="number">6</span>*n; i++)</div><div class="line">            g.Addedge(i, sink, <span class="number">1</span>);</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = n; j &lt; <span class="number">2</span>*n; j++) &#123;</div><div class="line">                <span class="keyword">if</span> (ban[i] || ban[j] || !mm[i][j])</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                g.Addedge(i, j, <span class="number">1</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>*n; i &lt; <span class="number">4</span>*n<span class="number">-1</span>; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">4</span>*n; j &lt; <span class="number">6</span>*n<span class="number">-1</span>; j++) &#123;</div><div class="line">                <span class="keyword">if</span> (ban[i] || ban[j] || !mm[i][j])</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                g.Addedge(i, j, <span class="number">1</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> flow = g.Maxflow(source, sink);</div><div class="line">        </div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (Edge *p = g.adj[i]; p != <span class="literal">NULL</span>; p = p-&gt;next) &#123;</div><div class="line">                <span class="keyword">if</span> (p-&gt;v &gt;= n &amp;&amp; p-&gt;v &lt; <span class="number">2</span>*n &amp;&amp; p-&gt;flow == <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">board_t</span>[mmPos[i][p-&gt;v][<span class="number">0</span>]][mmPos[i][p-&gt;v][<span class="number">1</span>]]++;</div><div class="line"><span class="comment">//					printf("---- %d %d\n", mmPos[i][p-&gt;v][0], mmPos[i][p-&gt;v][1]);</span></div><div class="line">                    board_s[mmPos[i][p-&gt;v][<span class="number">0</span>]][mmPos[i][p-&gt;v][<span class="number">1</span>]] = <span class="string">'x'</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>*n; i &lt; <span class="number">4</span>*n; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (Edge *p = g.adj[i]; p != <span class="literal">NULL</span>; p = p-&gt;next) &#123;</div><div class="line">                <span class="keyword">if</span> (p-&gt;v &gt;= <span class="number">4</span>*n &amp;&amp; p-&gt;v &lt; <span class="number">6</span>*n &amp;&amp; p-&gt;flow == <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">board_t</span>[mmPos[i][p-&gt;v][<span class="number">0</span>]][mmPos[i][p-&gt;v][<span class="number">1</span>]]++;</div><div class="line"><span class="comment">//					printf("---- %d %d\n", mmPos[i][p-&gt;v][0], mmPos[i][p-&gt;v][1]);</span></div><div class="line">                    board_s[mmPos[i][p-&gt;v][<span class="number">0</span>]][mmPos[i][p-&gt;v][<span class="number">1</span>]] = <span class="string">'+'</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">DD</span> &#123;</span></div><div class="line">            <span class="keyword">int</span> x, y;</div><div class="line">            <span class="keyword">char</span> val;</div><div class="line">            DD(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">char</span> val): x(x), y(y), val(val) &#123;&#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="built_in">vector</span>&lt;DD&gt; V;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">board_t</span>[i][j] != board[i][j]) &#123;</div><div class="line">                    <span class="keyword">if</span> (<span class="keyword">board_t</span>[i][j] == <span class="number">2</span>)</div><div class="line">                        V.push_back(DD(i+<span class="number">1</span>, j+<span class="number">1</span>, <span class="string">'o'</span>));</div><div class="line"><span class="comment">//						printf("o %d %d\n", i+1, j+1);</span></div><div class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">board_t</span>[i][j] == <span class="number">1</span>)</div><div class="line">                        V.push_back(DD(i+<span class="number">1</span>, j+<span class="number">1</span>, board_s[i][j]));</div><div class="line"><span class="comment">//						printf("%c %d %d\n", board_s[i][j], i+1, j+1);</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Case #%d: %d %d\n"</span>, ++cases, ret+flow, V.size());</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; V.size(); i++)</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%c %d %d\n"</span>, V[i].val, V[i].x, V[i].y);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-icg-final-project-radiosity-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/24/icg-final-project-radiosity-2/" class="article-date">
  <time datetime="2017-01-24T03:01:19.000Z" itemprop="datePublished">2017-01-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/計算機圖學/">計算機圖學</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/24/icg-final-project-radiosity-2/">探討平行與優化技術於熱輻射法 (下)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/01/24/icg-final-project-radiosity-2/" data-id="ckxv1wm82002ja8vn7t9ojlea" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/01/24/icg-final-project-radiosity-2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/平行/">平行</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/計算機圖學/">計算機圖學</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>接續上一篇</p>
</blockquote>
<h2 id="平行設計-Parallel-Design"><a href="#平行設計-Parallel-Design" class="headerlink" title="平行設計 Parallel Design"></a>平行設計 Parallel Design</h2><p>回顧原始算法，為了加快收斂速度，每一次會挑選單位面積能量最多的三角形 <span>$f$</span><!-- Has MathJax --> ，之後便拿所有三角形 <span>$t$</span><!-- Has MathJax --> 進行傳導，直到傳導能量小於閥值，迭代將停止。算法如下所述：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> (<span class="keyword">not</span> converge) &#123;</div><div class="line">  f = PickMaxRadiosityTriangle()</div><div class="line">  foreach triangle t in model</div><div class="line">      shader(f, t);</div><div class="line">  clearRadiosity(f)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在嘗試傳遞的過程中，若三角形 <span>$f$</span><!-- Has MathJax --> 的三頂點的能量差異大，則選擇自適應切割三角形，直到三頂點能量差異小，這麼計算 Form-Factor 才會正確。在自適應部份，切割方法如下圖所示：</p>
<p><img src="http://i.imgur.com/qd2QlKk.png" alt=""></p>
<p>當偵測到綠色三角形 <span>$A$</span><!-- Has MathJax --> 頂點之間的 Form-Factor 差異過大時，使用最長邊的中點切割，這麼做是盡可能產生銳角三角形，為了圖形完整，必然也要對鄰居切割。為減少計算量，只算新增中心點 <span>$P$</span><!-- Has MathJax --> 的 Form-Factor。對於下方的三角形 <span>$B$</span><!-- Has MathJax --> 而言，分成兩種情況，已在這一輪完成計算，則重新計算 Form-Factor；相反地，不做任何事。</p>
<h3 id="Single-Source-Parallel-Algorithm"><a href="#Single-Source-Parallel-Algorithm" class="headerlink" title="Single-Source Parallel Algorithm"></a>Single-Source Parallel Algorithm</h3><p>我們發現計算 Form-Factor 相當獨立的，但自適應處理需要遞迴切割，因此選用多核心平台，而非通用圖形處理器平台，因為目前的 GPU 實作遞迴所需的 stack 使用 global memory 作為存取位址，所以一般多核心平台效果會更好。在這一次報告中，我們選用 OpenMP 這套跨平台多執行緒 API 進行實驗。</p>
<p>著手將多個三角形平行處理，意即每一個執行緒負責多個三角形的 Form-Factor 計算。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Single-Source Parallel Algorithm</span></div><div class="line"><span class="keyword">while</span> (<span class="keyword">not</span> converage) &#123;</div><div class="line">  f = PickMaxRadiosityTriangle()</div><div class="line">  parallel foreach triangle t in model</div><div class="line">      shader(s, t);</div><div class="line">  clearRadiosity(f)</div></pre></td></tr></table></figure>
<h3 id="Multi-Source-Parallel-Algorithm"><a href="#Multi-Source-Parallel-Algorithm" class="headerlink" title="Multi-Source Parallel Algorithm"></a>Multi-Source Parallel Algorithm</h3><p>從原始算法中，我們發現到每一次迭代將只有一個熱源輻射到場景中，當場景有多個高能量熱源時，場景必須經過好幾次迭代才能近似最終結果。藉由平行處理的效能，我們可以一次迭代多熱源，便可將低執行緒之間分配工作不均的情況，不僅僅前幾次迭代就能近似最終結果，同時也能加速運算。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Multi-Source Parallel Algorithm</span></div><div class="line"><span class="keyword">while</span> (<span class="keyword">not</span> converge) &#123;</div><div class="line">  <span class="built_in">set</span>&lt;Triangle&gt; f = RadiosityTriangleCandiateCandidate();</div><div class="line">  parallel foreach triangle t in model</div><div class="line">      <span class="keyword">if</span> (f.find(t))</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">      foreach s in f</div><div class="line">          shader(s, t);</div><div class="line">  clearRadiosity(f);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我們所用的平行方無法搭配上述自適應的切割方案，其原因在於分裂過程中，同時也要對鄰居三角形分裂，整個圖形產生的節點與邊的關係才會正確，無法保證鄰居在同一執行緒內處理，若沒有做好空間切割，我們便無法處理這部份。若模型格式會是數個獨立的物體，而非單純的三角形資訊，可分配每一個執行緒處理多個獨立物體，我們預期可以達到更好的效果。</p>
<p>平行過程中每一個執行緒共享和衝突的區段越少越好，這意味著我們必須在運行輻射前就必須將模型切得相當細緻。特別注意到，切得細緻與否對於光線投射 (Ray Casting) 複雜度不變，因為邏輯上他們處理同一平面。</p>
<p>一旦切得細緻，傳遞的效果就不是這麼好，在邊界的陰影更加顯著。根據理論和實作層面推測，其一原因是能傳遞的總能量隨著迭代減少，那麼從分裂過程中傳遞能量採用較多的加法完成，相較於多個 32-bit floating point 誤差就少了許多。</p>
<p>我們也試著使用獨立的切割方案─重心切割，切割的結果不依賴鄰居，只需要在加入三角形清單部份使用 critical section 即可，效能影響並不大。</p>
<p><img src="http://i.imgur.com/cI7z6Jx.png" alt=""></p>
<p>根據重心切割，下述實驗中，從 156 個三角形，自動分裂到 30000 個三角形後進行輻射的結果如下圖所示：</p>
<p>明顯地，根據重心的切割方法容易產生鈍角三角形，看起來就會像很多紡錘體。在眾多數學性質中，只使用重心也許不是好的解決方案，這是値得探討的一部份，由於製作上的時間限制，我們並沒有去探討各個不同切割方案，所對應的自適應的效果如何。</p>
<table>
<thead>
<tr>
<th style="text-align:center">Longest Edge</th>
<th style="text-align:center">Center</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><img src="http://i.imgur.com/vQFsQ3K.png" alt=""></td>
<td style="text-align:center"><img src="http://i.imgur.com/ZyLbimO.png" alt=""></td>
</tr>
</tbody>
</table>
<h2 id="展示結果-Demo"><a href="#展示結果-Demo" class="headerlink" title="展示結果 Demo"></a>展示結果 Demo</h2><p>只使用優化技術渲染結果</p>
<table>
<thead>
<tr>
<th style="text-align:center">blocks</th>
<th style="text-align:center">room</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><img src="http://i.imgur.com/4I3U5zd.png" alt=""></td>
<td style="text-align:center"><img src="http://i.imgur.com/ATsDg8e.png" alt=""></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:center">hall</th>
<th style="text-align:center">church</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><img src="http://i.imgur.com/j6KNvT0.png" alt=""></td>
<td style="text-align:center"><img src="http://i.imgur.com/Squ2W0v.png" alt=""></td>
</tr>
</tbody>
</table>
<h3 id="平行效能比較"><a href="#平行效能比較" class="headerlink" title="平行效能比較"></a>平行效能比較</h3><p>在 Intel Xeon E5-2620 v3 上，我們測試不同平行度帶來的影響，由於只有兩個實體 CPU，每一個 CPU 有 6 個核心，每個核心皆有 Hyper-threading 技術，故可產生 24 個執行緒。</p>
<p><img src="http://i.imgur.com/qcJfMW7.png" alt="Single-Source Parallel Algorithm - Scalability"></p>
<p>我們對模型 room.tri 以預先切割 14977 個三角形後，根據先前提到的平行算法 Single-Source Parallel Algorithm，即是迭代一次只取一個熱源，平行計算所有三角形到此熱源的 Form-Factor 値，針對不同的執行緒個數和運行時間記錄，結果如上圖。在由於過多的執行緒可能會帶來更多的 false sharing，造成資料在不同的 CPU 之間運行 data transmission，所以效果就逐漸不明顯。</p>
<p><img src="http://i.imgur.com/GKBUCrB.png" alt="Multi-Source Parallel Algorithm - Scalability"></p>
<p>接著，我們測試 Multi-Source Parallel Algorithm，以 room.tri 預先切割 50017 個三角形後，每次迭代皆取數個熱源，平行計算所有三角形到所有被選取熱源的 Form-Factor 的總和。同樣地，因為查找的資料重複存取的模式造成不好的影響，類似上述所提到的 false sharing 影響，故會呈現一種陡坡。</p>
<h2 id="參考論文-Reference"><a href="#參考論文-Reference" class="headerlink" title="參考論文 Reference"></a>參考論文 Reference</h2><ul>
<li>Fast conversion of floating-point values to string, Wojciech Muła:<br><a href="http://0x80.pl/notesen/2015-12-29-float-to-string.html" target="_blank" rel="external">http://0x80.pl/notesen/2015-12-29-float-to-string.html</a><br>我們使用這一篇討論中，在輸出 Triangle 格式部份加速浮點數轉文字加快 4 倍速。</li>
</ul>
<h2 id="後記-Note"><a href="#後記-Note" class="headerlink" title="後記 Note"></a>後記 Note</h2><p>當我們進行平行效能比較時，要特別小心編譯器行為的差異，意即平行處理 <span>$P$</span><!-- Has MathJax --> 控制時，當 <span>$P=1$</span><!-- Has MathJax --> 時，使用平行版本比較合適。因為有時候，平行部分的函數被編譯器偵測到，由於分享記憶體的關係，部分代碼無法優化，導致效能瞬間慢個四到五倍都是有可能的，再加上 false sharing 的關係，更有可能在發生密集計算時，效能更加低落。</p>
<p>在不同平台上的情況也有所不同，例如在一般 server 上運行時，CPU 頻率通常都會比一般 PC 慢上許多，又因為很多個 CPU 導致總共的快取大小遠比一般 PC 多，所以平行效能將會受限於運行的應用行為，是否需要時常存取大量的資料。</p>
<h2 id="致謝-Thanks"><a href="#致謝-Thanks" class="headerlink" title="致謝 Thanks"></a>致謝 Thanks</h2><p>一開始在挑選主題相當困惑，畢竟使用 Unity 可以做出更生動的作品，但作品的元素和創意相當重要，相當迷惘於要選哪一種類型才好。如果要兩人以上一起做，那麼主題又不能太過狹隘。百般思慮下，還是由我拉選了這個主題下來做。</p>
<blockquote>
<p>「我可能會扯你後腿，還是我們各別做？」組員擔心地說道</p>
</blockquote>
<p>不用擔心，我自己也沒信心將所有程序都看完且修改更好更快，每天都焦頭爛額地煩惱整份程序的運作，深怕來不及在時限內完成足夠的報告份量。</p>
<blockquote>
<p>「快來幫幫我啊，在身邊一起 trace 程序也好，咱的記憶體不足啊。」內心如此吶喊</p>
</blockquote>
<p>一起修課的博班學長給了我們一些意見與鼓勵，而學弟們只會在一旁扯後腿問「學姊今天會來嗎？」最後，我們完成了整份程序的理解與討論。</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-icg-final-project-radiosity" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/22/icg-final-project-radiosity/" class="article-date">
  <time datetime="2017-01-22T03:40:03.000Z" itemprop="datePublished">2017-01-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/學校課程/">學校課程</a>/<a class="article-category-link" href="/categories/學校課程/計算機圖學/">計算機圖學</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/22/icg-final-project-radiosity/">探討平行與優化技術於熱輻射法 (上)</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/01/22/icg-final-project-radiosity/" data-id="ckxv1wm87002ya8vn519vemow" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/01/22/icg-final-project-radiosity/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/優化/">優化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/計算機圖學/">計算機圖學</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>此為計算機圖學課程中的一環，自由挑選主題。而這個 Radiosity 有好幾年前的原始碼，程式碼部分由老師提供。看到幾處寫得不是很好的地方，於是就拿來加速。在 tracing code 耗費了相當大的力氣，雖然才幾千行的 C 程序，完全不熟的領域，慢慢做起來也別有一番風趣。<a href="https://github.com/morris821028/hw-radiosity" target="_blank" rel="external">morris821028/hw-radiosity</a></p>
</blockquote>
<h2 id="Parallel-Computing-and-Optimization-Skills-for-Radiosity"><a href="#Parallel-Computing-and-Optimization-Skills-for-Radiosity" class="headerlink" title="Parallel Computing and Optimization Skills for Radiosity"></a>Parallel Computing and Optimization Skills for Radiosity</h2><ul>
<li>R04922067 楊翔雲、R04922133 古君葳</li>
</ul>
<h2 id="介紹-Introduction"><a href="#介紹-Introduction" class="headerlink" title="介紹 Introduction"></a>介紹 Introduction</h2><p>熱輻射法 (Radiosity) 是一種渲染的技術。相較於光線追蹤法 (Ray Tracing)，熱輻射法可以產生更接近於現實場景中光亮的變化。當場景使用光線追蹤法時，物體的陰影的邊緣相對銳利，但在現實情況下，物體陰影漸層呈現，因此使用熱輻射法可以更貼近我們想要的。</p>
<span>$$\begin{align*}
B_i dA_i = E_i dA_i + R_i \int_j B_j F_{ji} dA_j
\end{align*}$$</span><!-- Has MathJax -->
<ul>
<li><span>$A_i$</span><!-- Has MathJax --> : Area of element i (computable)</li>
<li><span>$B_i$</span><!-- Has MathJax --> : Radiosity of element i (unknown)</li>
<li><span>$E_i$</span><!-- Has MathJax --> : Radient emitted flux density of element i (given)</li>
<li><span>$R_i$</span><!-- Has MathJax --> : Refletance of element i (given)</li>
<li><span>$F_{ji}$</span><!-- Has MathJax --> : Form Factor from j to i (computable)</li>
</ul>
<p>假設整個場景中有 <span>$N$</span><!-- Has MathJax --> 個三角形，每一次迭代選擇一個最亮的三角形當作光源，由這個光源計算與場景中其他三角形的 Radiosity 之值。其中，判斷光源是否可以輻射到某個三角形之複雜度介於 <span>$O(\log N)$</span><!-- Has MathJax --> 到 <span>$O(N)$</span><!-- Has MathJax --> (視Data structure而定)，而計算 Form-Factor的花費可以視為常數 <span>$O(1)$</span><!-- Has MathJax --> ，因此每次迭代的複雜度介於 <span>$O(N \log N)$</span><!-- Has MathJax --> 到 <span>$O(N^2)$</span><!-- Has MathJax -->。</p>
<p>其中佔據效能的因素是 Form-Factor 估算，因此有像 Hemicube之類的近似逼近，大幅度減少計算量，但投影回到原本物件上會失真。</p>
<span>$$\begin{align*}
F_{ij} = \frac{1}{A_i} \int_{A_i}\int_{A_j} \frac{\cos \phi_2 \cos \phi_1}{\pi r^2} dA_i dA_j
\end{align*}$$</span><!-- Has MathJax -->
<p><img src="http://i.imgur.com/mOMEPZR.gif" alt=""></p>
<blockquote>
<p>進入優化主題吧</p>
</blockquote>
<h2 id="優化技術-Code-Review-amp-Optimization"><a href="#優化技術-Code-Review-amp-Optimization" class="headerlink" title="優化技術 Code Review &amp; Optimization"></a>優化技術 Code Review &amp; Optimization</h2><p>首先，我們先對助教提供的程式碼加速，分成以下幾個部分討論</p>
<ul>
<li>減少光線投射計算量 Strength Reduction for Ray Casting</li>
<li>減少 Form-Factor計算量 Strength Reduction for Form-Factor</li>
<li>改善資料局部性 Improve Data Locality</li>
<li>其他優化 Other Optimization: <ul>
<li>Improve I-cache Miss</li>
<li>Short Circuit Design</li>
<li>Clipping Algorithm</li>
<li>Strength Reduction for Float-Point</li>
<li>Shrink the Scope of Variables</li>
<li>Reduce the Number of Arguments</li>
<li>Remove Implications of Pointer Aliasing</li>
<li>Copy Optimization</li>
</ul>
</li>
</ul>
<h3 id="減少光線投射計算量-Strength-Reduction-for-Ray-Casting"><a href="#減少光線投射計算量-Strength-Reduction-for-Ray-Casting" class="headerlink" title="減少光線投射計算量 Strength Reduction for Ray Casting"></a>減少光線投射計算量 Strength Reduction for Ray Casting</h3><p>判斷射線 (Ray) 是否能打到三角形 <span>$A$</span><!-- Has MathJax --> 上，先用 bounding box 包住 <span>$A$</span><!-- Has MathJax --> ，計算 <span>$p$</span><!-- Has MathJax --> 到 bounding box 的時間 <span>$t$</span><!-- Has MathJax --> ，若 <span>$t$</span><!-- Has MathJax --> 大於目前的最小 <span>$t_{\min}$</span><!-- Has MathJax --> ，則退出。相反地，再計算更精準的 <span>$t$</span><!-- Has MathJax --> 。加入利用已知結果 <span>$v = p + t_{\min} \cdot d, t_{\min} &gt; 0$</span><!-- Has MathJax --></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">TriangleHitted</span><span class="params">(Vector p, Vector d, TrianglePtr tp, <span class="keyword">float</span> *t_min)</span> </span>&#123;</div><div class="line">    <span class="keyword">float</span> t = <span class="comment">/* time t from p to bounding box of Triangle tp */</span>;</div><div class="line">    <span class="keyword">if</span> (t &lt; eps)</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    <span class="keyword">if</span> (t &gt;= *t_min)    <span class="comment">/* important !! */</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    <span class="comment">/* ... */</span></div><div class="line">    *t_min = t;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="減少-FF-計算量-Strength-Reduction-for-Form-Factor"><a href="#減少-FF-計算量-Strength-Reduction-for-Form-Factor" class="headerlink" title="減少 FF 計算量 Strength Reduction for Form-Factor"></a>減少 FF 計算量 Strength Reduction for Form-Factor</h3><p>根據公式 <span>$F_{ij} = \frac{1}{A_i} \int_{A_i}\int_{A_j} \frac{\cos \phi_2 \cos \phi_1}{\pi r^2} dA_i dA_j$</span><!-- Has MathJax --> ，一般我們的判斷順序會得如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">float</span> <span class="title">computeFormFactor</span><span class="params">(TrianglePtr srcTri, <span class="keyword">int</span> logSrc, TrianglePtr desTri, <span class="keyword">int</span> logDes, Vector p)</span> </span>&#123;</div><div class="line">    Vector dir = srcTri-&gt;c - p;</div><div class="line">    <span class="keyword">float</span> ff = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (RayHitted(p, dir, logDes) == logDes) &#123;</div><div class="line">        <span class="keyword">float</span> theta1 = CosTheta(dir, srcTri-&gt;normal), theta2 = CosTheta(dir, desTri-&gt;normal);</div><div class="line">        ff = theta1 * theta2 * srcTri-&gt;area / (norm2(dir) * PI);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> max(ff, <span class="number">0.f</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>效能考量的因素：</p>
<ul>
<li><code>RayHitted()</code> 需要大量的計算</li>
<li>Form-Factor 在 <code>float</code> 儲存格式下可能無法得到貢獻，改採優先計算 Form-Factor 的值，再運行 RayHitted 判斷。調整加速了 2 倍多。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">float</span> <span class="title">computeFormFactor</span><span class="params">(TrianglePtr srcTri, <span class="keyword">int</span> logSrc, TrianglePtr desTri, <span class="keyword">int</span> logDes, Vector p)</span></span></div><div class="line"><span class="function">    Vector dir </span>= srcTri-&gt;c - p;</div><div class="line">    <span class="keyword">float</span> theta1 = CosTheta(dir, srcTri-&gt;normal), </div><div class="line">theta2 = CosTheta(dir, desTri-&gt;normal);</div><div class="line">    <span class="keyword">float</span> ff = theta1 * theta2;</div><div class="line">    <span class="keyword">if</span> (ff &lt;= <span class="number">0</span>)    <span class="keyword">return</span> <span class="number">0.f</span>;</div><div class="line">    ff *= srcTri-&gt;area / (norm2(dir) * PI);</div><div class="line">    <span class="keyword">if</span> (ff &lt;= <span class="number">0</span>)    <span class="keyword">return</span> <span class="number">0.f</span>;</div><div class="line">    <span class="keyword">if</span> (RayHitted(p, dir, logDes) == logDes)</div><div class="line">        <span class="keyword">return</span> ff;</div><div class="line">    <span class="keyword">return</span> <span class="number">0.f</span>;</div></pre></td></tr></table></figure>
<h3 id="改善資料局部性-Improve-Data-Locality"><a href="#改善資料局部性-Improve-Data-Locality" class="headerlink" title="改善資料局部性 Improve Data Locality"></a>改善資料局部性 Improve Data Locality</h3><p>程式碼中使用 3D-DDA Line Algorithm/Bresenham’s Line Algorithm 搭配 Octree，在找尋某個射線與哪個最近三角形相交。</p>
<ul>
<li>只需要儲存葉節點代表的立方體中，所有可能相交的三角形編號</li>
<li>移除掉中間產生的編號，讓每一次 access 的 cache-miss 下降</li>
</ul>
<p>在 3D-DDA 中，我們需要反查找空間中一點 p 在哪一個葉節點中，藉由固定的長寬高切割長度，可以在 <span>$O(1)$</span><!-- Has MathJax --> 時間內得知 <code>[i][j][k]</code> 各別的值。若限制大小，則建立陣列 <code>[i][j][k]</code> 查找。若自適應大小，則建立 hash 表查找，但根據實驗結果，效能並沒有改善，因為三角形個數過多導致命中機率過低。</p>
<p>對於 Static Tree 的 Memory Layout，大致上分成四種DFS Layout、Inorder Layout、BFS Layout、和 van Emde Boas Layout，目前程式使用的是 DFS Layout，這方面會影響到存取的效能。若有更多的時間，我們也可以測試平行處理的細粒度與這些 Memory Layout 的影響。</p>
<h3 id="其他優化-Other-Optimization"><a href="#其他優化-Other-Optimization" class="headerlink" title="其他優化 Other Optimization"></a>其他優化 Other Optimization</h3><h4 id="Improve-I-cache-Miss"><a href="#Improve-I-cache-Miss" class="headerlink" title="Improve I-cache Miss"></a>Improve I-cache Miss</h4><p>壓縮程式碼長度以改善 I-cache miss，因為大部分的初始化只會運行一次，不應該交錯在時常被呼叫的函數之間，指令載入效能才會提高，同時也要做好 Code Layout，就能改善執行效能。</p>
<p>原始版本如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">x, y = compute(<span class="number">0</span>)</div><div class="line">buildTree(x, y)</div><div class="line">x, y = compute(<span class="number">1</span>)</div><div class="line">buildTree()</div><div class="line">x, y = compute(<span class="number">2</span>)</div><div class="line">buildTree()</div><div class="line">x, y = compute(<span class="number">3</span>)</div><div class="line">buildTree()</div><div class="line">...</div></pre></td></tr></table></figure>
<p>壓縮和整理後</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i from <span class="number">0</span> to n</div><div class="line">    x, y = compute(i)</div><div class="line">    buildTree()</div></pre></td></tr></table></figure>
<h4 id="Short-Circuit-Design"><a href="#Short-Circuit-Design" class="headerlink" title="Short Circuit Design"></a>Short Circuit Design</h4><p>判斷三角形與一個正交立方體是否相交，使用投影到二維空間中與一線段的交點是否皆存在。投影方法有 3 種 x-y, y-z, z-x，線段投影共有 2 種，共計 6 種情況。原先程式沒有做好短路設計，只要其中一種不符就應退出。</p>
<p><img src="http://i.imgur.com/8jcycpG.png" alt=""></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">CrossOver</span><span class="params">(TrianglePtr tri, </span></span></div><div class="line"><span class="function"><span class="params">            Vector g0, Vector g1)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (xyz = <span class="number">0</span>; xyz &lt; <span class="number">3</span>; xyz++) &#123;</div><div class="line">        <span class="comment">// front face project</span></div><div class="line">        <span class="keyword">if</span> (!test())</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        <span class="comment">// back face project</span></div><div class="line">        <span class="keyword">if</span> (!test())</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Clipping-Algorithm"><a href="#Clipping-Algorithm" class="headerlink" title="Clipping Algorithm"></a>Clipping Algorithm</h4><p>我們實作課程中所描述的 Cohen–Sutherland Algorithm 降低 branch 次數，使用 bitwise 操作引出 SSE (Streaming SIMD Extensions)。儘管 compiler -O2 替我們優化，為減少 stack push/pop 的次數，實作時請不要使用的 procedure call，否則會慢上許多。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">computeRadiosity</span><span class="params">(TrianglePtr srcTri, TrianglePtr desTri, </span></span></div><div class="line"><span class="function"><span class="params"><span class="keyword">float</span> ff[<span class="number">3</span>])</span> </span>&#123;</div><div class="line">    <span class="keyword">char</span> mask1 = (p0[x] &lt; g0[x])&lt;&lt;<span class="number">0</span> |</div><div class="line">        (p0[x] &gt; g1[x])&lt;&lt;<span class="number">1</span> |</div><div class="line">        (p0[y] &lt; g0[y])&lt;&lt;<span class="number">2</span> |</div><div class="line">        (p0[y] &gt; g1[y])&lt;&lt;<span class="number">3</span> ;</div><div class="line">    <span class="keyword">char</span> mask2 = (p1[x] &lt; g0[x])&lt;&lt;<span class="number">0</span> |</div><div class="line">        (p1[x] &gt; g1[x])&lt;&lt;<span class="number">1</span> |</div><div class="line">        (p1[y] &lt; g0[y])&lt;&lt;<span class="number">2</span> |</div><div class="line">        (p1[y] &gt; g1[y])&lt;&lt;<span class="number">3</span> ;</div><div class="line">    <span class="keyword">if</span> (mask1&amp;mask2)    </div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    <span class="keyword">if</span> (!(mask1|mask2))</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    <span class="comment">// ... test</span></div></pre></td></tr></table></figure>
<h4 id="Strength-Reduction-for-Float-Point"><a href="#Strength-Reduction-for-Float-Point" class="headerlink" title="Strength Reduction for Float-Point"></a>Strength Reduction for Float-Point</h4><p>兩個外積結果相乘小於零，減少 instruction cycle 量，盡量用整數作為運算型態。</p>
<blockquote>
<p>在現在的 Intel CPU 中，32-bit 浮點數運算基本上跟整數一樣快</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">float</span> a = cross(<span class="comment">/* */</span>);</div><div class="line"><span class="keyword">float</span> b = cross(<span class="comment">/* */</span>);</div><div class="line"><span class="keyword">if</span> (a * b &lt; <span class="number">0</span>)</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">b = cross(<span class="comment">/* */</span>);</div><div class="line"><span class="keyword">if</span> (a * b &lt; <span class="number">0</span>)</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">...</div></pre></td></tr></table></figure>
<p>事先判斷正負號，同時也防止溢位。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> a = cross(<span class="comment">/* */</span>) &lt; <span class="number">0</span>;</div><div class="line"><span class="keyword">int</span> b = cross(<span class="comment">/* */</span>) &lt; <span class="number">0</span>;</div><div class="line"><span class="keyword">if</span> (a != b)</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">b = cross(<span class="comment">/* */</span>) &lt; <span class="number">0</span>;</div><div class="line"><span class="keyword">if</span> (a != b)</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">...</div></pre></td></tr></table></figure>
<h4 id="Shrink-the-Scope-of-Variables"><a href="#Shrink-the-Scope-of-Variables" class="headerlink" title="Shrink the Scope of Variables"></a>Shrink the Scope of Variables</h4><p>減少變數生命週期的長度以增加放入暫存器的機會，而非 stack 上。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">float</span> rgb[<span class="number">3</span>];</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</div><div class="line">    rgb[f(i)] = g(i);</div><div class="line"><span class="comment">/* ... */</span></div><div class="line"><span class="keyword">if</span> (maybe) &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</div><div class="line">        rgb[h(i)] = g(i);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/* ... */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>當邏輯很複雜時，編譯器不太能幫忙做分析，所以自己手動優化的效果會比較好，在 C/C++ 語言中，可以利用大括弧進行區域變數的設定。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="keyword">float</span> rgb[<span class="number">3</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</div><div class="line">        rgb[f(i)] = g(i);</div><div class="line">    <span class="comment">/* ... */</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (maybe) &#123;</div><div class="line">    <span class="keyword">float</span> rgb[<span class="number">3</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</div><div class="line">        rgb[h(i)] = g(i);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/* ... */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Reduce-the-Number-of-Arguments"><a href="#Reduce-the-Number-of-Arguments" class="headerlink" title="Reduce the Number of Arguments"></a>Reduce the Number of Arguments</h4><p>減少 stack push/pop 次數</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Arg</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> a0, a1;</div><div class="line">&#125;;    <span class="comment">// p1.a1 = p2.a0</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">(Arg p1, Arg p2)</span> </span>&#123;</div><div class="line">    <span class="comment">/* ... */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如何修改合適的參數個數，必須看使用的機率和次數，才能達到最大效益。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Arg</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> a0, a1, a2;</div><div class="line">&#125;;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">(Arg p1p2)</span> </span>&#123;</div><div class="line">    <span class="comment">/* ... */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Remove-Implications-of-Pointer-Aliasing"><a href="#Remove-Implications-of-Pointer-Aliasing" class="headerlink" title="Remove Implications of Pointer Aliasing"></a>Remove Implications of Pointer Aliasing</h4><p>移除指標 Aliasing，意指可能會指向相同記憶體位址，導致每次計算都要重新載入，不能放進暫存器中。如下述的寫法，編譯器無法判定 <code>srcTri</code> 是否與 <code>desTri</code> 相同，在累加時則重新載入 <code>srcTri-&gt;deltaB[]</code> 的數值，計算上可能會產生數次的 cache miss，隨著迴圈次數不斷突顯效能差異。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">computeRadiosity</span><span class="params">(TrianglePtr srcTri, TrianglePtr desTri,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="keyword">float</span> ff[<span class="number">3</span>])</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; <span class="number">3</span>; v++) &#123;    <span class="comment">// vertex</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span>; c &lt; <span class="number">3</span>; c++) &#123;    <span class="comment">// color RGB</span></div><div class="line">            flaot deltaB = desTri-&gt;Frgb[c]/<span class="number">255.0</span>*RefRatio*srcTri-&gt;deltaB[c]*ff[v]/<span class="number">3</span>;</div><div class="line">            desTri-&gt;deltaB[c] += deltaB; </div><div class="line">            desTri-&gt;accB[v][c] += deltaB; </div><div class="line">            desTri-&gt;deltaAccB[v][c] += deltaB; </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>方法 1: 加入 <code>if (srcTri != desTri)</code> 判斷，讓編譯器在 Function Pass 階段著手的 Dependency Analysis 更好</li>
<li>方法 2: 使用 Copy Optimization，同時把重複計算搬到 stack 上，或者使用 Polyhedal 表示法進行 Reordering Accesses for Loop Nest。這裡我們選擇前者，更容易引出 SSE</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">computeRadiosity</span><span class="params">(TrianglePtr srcTri, TrianglePtr desTri, </span></span></div><div class="line"><span class="function"><span class="params"><span class="keyword">float</span> ff[<span class="number">3</span>])</span> </span>&#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">float</span> k = RefRatio / <span class="number">255.0</span>;</div><div class="line">    <span class="keyword">float</span> lo[<span class="number">3</span>] = &#123; desTri-&gt;Frgb[<span class="number">0</span>]*k*(srctri-&gt;deltaB[<span class="number">0</span>]), </div><div class="line">                    desTri-&gt;Frgb[<span class="number">1</span>]*k*(srctri-&gt;deltaB[<span class="number">1</span>]), </div><div class="line">                    desTri-&gt;Frgb[<span class="number">2</span>]*k*(srctri-&gt;deltaB[<span class="number">2</span>])&#125;;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; <span class="number">3</span>; v++)    &#123;    <span class="comment">// vertex</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span>; c &lt; <span class="number">3</span>; c++) &#123;    <span class="comment">// color RGB</span></div><div class="line">            <span class="comment">/* calculate the reflectiveness */</span></div><div class="line">            <span class="keyword">float</span> deltaB = lo[c] * ff[v] / <span class="number">3</span>;</div><div class="line">            desTri-&gt;deltaB[c] += deltaB;</div><div class="line">            desTri-&gt;accB[v][c] += deltaB;</div><div class="line">            desTri-&gt;deltaaccB[v][c] = deltaB;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h2><ul>
<li>使用洽當的編譯器參數可加速 2 倍</li>
<li>減少 Form-Factor 計算加速 2 倍</li>
<li>剩餘優化部份改善 10% ~ 20% 效能。</li>
</ul>
<p>至今，我們加速了 4 倍，在下一篇文章中，我們將繼續探討平行處理。</p>
<h3 id="Experiment"><a href="#Experiment" class="headerlink" title="Experiment"></a>Experiment</h3><table>
<thead>
<tr>
<th style="text-align:center">Model</th>
<th style="text-align:right">Origin (sec.)</th>
<th style="text-align:right">Our v0.1 (sec.)</th>
<th style="text-align:right">Speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">room.tri</td>
<td style="text-align:right">10.27</td>
<td style="text-align:right">4.70</td>
<td style="text-align:right">2.18</td>
</tr>
<tr>
<td style="text-align:center">hall.tri</td>
<td style="text-align:right">176.92</td>
<td style="text-align:right">38.50</td>
<td style="text-align:right">4.59</td>
</tr>
<tr>
<td style="text-align:center">church.tri</td>
<td style="text-align:right">72.32</td>
<td style="text-align:right">42.64</td>
<td style="text-align:right">1.69</td>
</tr>
</tbody>
</table>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-note/diary-201701-5" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/20/note/diary-201701-5/" class="article-date">
  <time datetime="2017-01-20T12:23:52.000Z" itemprop="datePublished">2017-01-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/手札日記/">手札日記</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="http://i.imgur.com/rxih6Pj.jpg" rel="gallery_ckxv1wn7r02bba8vnwgj9kmyd">
        <img src="http://i.imgur.com/rxih6Pj.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/20/note/diary-201701-5/">那段過往的蠢事</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/01/20/note/diary-201701-5/" data-id="ckxv1wn7r02bba8vnwgj9kmyd" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/01/20/note/diary-201701-5/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>我一定誤會了什麼，才冒冒失失地進入這個世界，大家所期待的那個人明明不是我－《三月的獅子》</p>
</blockquote>
<h2 id="實驗室調侃"><a href="#實驗室調侃" class="headerlink" title="實驗室調侃"></a>實驗室調侃</h2><p>「什麼時候要簽博？」</p>
<p>學校年底寄了封向碩士一學年修畢、在學成績前 30% 且被教授認可有研究能力的學生，提供 <strong>逕行修讀博士學位</strong> ，從那陣子之後，這句話不斷地從旁人口說出，可想而知是在玩弄我。大概是從某次開會中，老師三番兩次地說誰誰看起來適合簽博，又朝著我說能力怎樣怎樣地很安心，必然是學弟們的光芒尚未展現，目光才莫名其妙地投射在我身上。</p>
<p>有趣的是隔了幾週後，系上放寬到一學期修畢即可，心想這下子總算能反攻了，但論談話辯論技巧，一時還是贏不了。</p>
<blockquote>
<p>「學弟們來簽博吧！」充滿嘲諷的反擊道<br>「可是老師只認同你」學弟緩緩地說道<br>「…」到底是怎麼想到那一塊去的，心中滿滿的困惑</p>
</blockquote>
<h2 id="順水推舟"><a href="#順水推舟" class="headerlink" title="順水推舟"></a>順水推舟</h2><p><img src="http://i.imgur.com/sdLbmIR.jpg" alt="「什麼 什麼」－ 《吹響吧！上低音號》"></p>
<p>年底的事情仍尚未結束，在旁人的催促下，感覺需要紀錄點什麼－那段有趣的誤會。</p>
<h3 id="跨年那一夜"><a href="#跨年那一夜" class="headerlink" title="跨年那一夜"></a>跨年那一夜</h3><p>在台北的第二次跨年，想去年在生測資完後，回家的路上看著一群攝影愛好者在圖書館後頭拍攝，而自己只能拖著疲累的身軀回家休息。2017 年稍微特別一點，在靠北工程師看到一句話「人家有閃光才叫跨年，我們這群單身狗不跨年，叫熬夜。」尾牙聚餐因學弟一句話衝動發出邀請後，果然還是一個人熬夜吧，這回是學弟們一起在實驗室熬夜，別有樂趣。</p>
<p>這一夜原本想約著一起寫作業，自己一個人做做還可以，嘗試各種修改，絞盡腦力讓自己無法去想那原本的計劃，差點就在 TLE 下跨年了。</p>
<p><img src="http://i.imgur.com/pPAN5fd.jpg" alt="「的確 成就感真是活下去所需要的能量啊」－《三月的獅子》"></p>
<blockquote>
<p>「楓之谷倒數計時 3, 2, 1, …」<br>「限時販售商店在哪？」</p>
</blockquote>
<p>一群肥宅就這麼在楓之谷上跨年。這麼說也許突然，學弟們看我有玩楓之谷，一個個都來跟我一起玩，一次要養這麼多人相當不容易，也因此那陣子完全不能自由活動，一上線就是當工具人。</p>
<p>那晚走在回租屋處的路上，傳了封訊息說聲「新年快樂」這讓我不禁想起，曾經也做過類似的事情，對著四年沒聯絡的手機號碼，到了那天日子傳了封「祝你生日快樂」這麼說起來，就像動畫《秒速五釐米》心境，平凡地過著日子，卻時時刻刻想著那過往的蠢事。</p>
<p>跨年那一夜的清晨走回家，平常一起租屋的高中同學們都會在家，而今晚一個都沒有，房裡、客廳裡只有從路燈照來的光，摸著冰冷的樓梯扶手走回房裡，收到封「抱歉，整天沒都沒看訊息，現在在喝酒」</p>
<p>然而，不只是現實生活中，連遊戲中都感受到一種奇怪的氛圍，難道沒長時間在線上掛網，連網友都和這一夥人都想到一塊去了！素未謀面的網友，傳了些訊息給我。</p>
<blockquote>
<p>「吾 你今年會脫魯」遞上作業的截圖說道<br>「吾 你今年X月X日前會脫魯」</p>
</blockquote>
<p>心中滿滿地無奈，處處都有人在督促我。</p>
<h3 id="新年那一日"><a href="#新年那一日" class="headerlink" title="新年那一日"></a>新年那一日</h3><p>三天連假必然要為了平行加速的期末專題奮戰，所以約了小夥伴一起努力。一早八點坐在床頭滑著手機，看看昨夜的廢文有什麼樣的反應，看著未讀訊息中一封也沒有，收拾著包包走到學校，在實驗室等著沒有約定的討論。看著什麼都沒進展的程序，不知不覺就一個人待到中午，心想那傢伙肯定宿醉了。</p>
<blockquote>
<p>「抱歉，剛剛才醒。」<br>「宿醉了對吧？」<br>「沒宿！」</p>
</blockquote>
<p>比起對於算法分析和優化技術，也許應該從更基本的算法開始講起。腦海中大量的資訊嘗試從平常不怎麼說話的口中說出，一時什麼都講不出來</p>
<blockquote>
<p>「沒關係，你慢慢說」<br>「是這個意思吧？」描繪著投影片上的圖示說道<br>「抱歉，這講起來有點枯燥」<br>「沒關係，聽你講著講著，我開始對這個有點興趣。」</p>
</blockquote>
<p>小組討論就這麼持續到晚上，學弟們還不跟我吃飯，不知道這群傢伙在想些什麼，你們這樣玩弄學長對嗎？就是要我們倆個一起吃。</p>
<h3 id="心情複雜"><a href="#心情複雜" class="headerlink" title="心情複雜"></a>心情複雜</h3><p>一想到在自己喜歡的事物面前，思緒總沒辦法順暢且正常地表達出來！覺得自己遜斃了。</p>
<p><img src="http://i.imgur.com/RyTYjQM.jpg" alt="「遜斃了」－《風夏》"></p>
<p>趕緊逃進期末專題程式編寫的修改，不再去理會旁人的總總，心想事情根本不是這樣子的，這種事情怎麼會落在我身上呢。</p>
<blockquote>
<p>優化計算機圖學浮點數輸出轉文字檔部份，轉換 json 就可以更快，加速 4 倍之多。參考論文說道 16 倍加速，提供的程序 Warning 編譯訊息停不下來，修一修 Bug 送上 pull request，沒想到 Lemire 教授也在貢獻者裡，略感興奮。清晨就收到信，修改部份被 Merge！</p>
</blockquote>
<p>一個小小的 CPU 中，突然多了一條程序需要執行，帶著這樣的心情去工作。沒想到這一天是老闆來，一整天全是全英開會，而且還有一場是咱的報告，事前都不知道啊！時間不斷消逝，終於迎來那一刻 … 原來已經沒救了，好丟臉啊。</p>
<p><img src="http://i.imgur.com/P46COfP.jpg" alt="「太丟臉了」－《風夏》"></p>
<p>在當下心中不冒出某晚一起討論的閒聊</p>
<blockquote>
<p>指著螢幕上一行一行的程序，試圖解釋自己的想法<br>「我改了這裡，好讓整個三角形更加地完整，不會破圖，不過也因此不太能平行 … 這有點麻煩」<br>在腦海中盤算著時程和算法<br>「如果要平行的話，要改成這個樣子，不過要花點時間，再弄個幾天吧」</p>
<p>「每個人都有自己不擅長的，不會每件事情都做得好，沒・關・係・的」<br>「我們已經做很多了呀，先把這些弄好吧」</p>
</blockquote>
<p>我啊，對於自己不擅長的項目太過在意，對於做不好一件可以完成的事覺得相當愧疚，總是投入好幾倍的時間來完成，想想自己這麼疲憊到底是為了什麼？在追求什麼？聽到那段話，有如放下了大石，旁人要不什麼都不說，要不鼓勵盡量往前衝，距離上一次對我傳達「你可以休息一下」又是多麼久遠的事了。</p>
<blockquote>
<p>不斷地敲打鍵盤，嘗試將自己的想法加入並進行測試，突然冒出了一句話<br>「欸欸，你爸有缺老婆嗎？」<br>「？」頓時落下手上的工作，腦海中喀喀聲瞬間即逝，『等等，這是什麼話題，現在我們在弄期末專題吧？』<br>「沒啦，我媽離婚一陣子，最近又交了另一半。」<br>「嗯？」對於這話題到底從哪裡來，心中滿滿的困惑<br>「她居然嗆我說『我比妳還有市場耶』，我是不是應該隨便交個男友？」<br>『咦？咦咦咦咦？』現在應該要沉住氣吧，擔心一不小心就要進警局<br>「沒事，你繼續寫吧。」</p>
</blockquote>
<p>繼續敲著鍵盤的同時，心想好像錯過了什麼選項。</p>
<h3 id="角色轉換"><a href="#角色轉換" class="headerlink" title="角色轉換"></a>角色轉換</h3><p><img src="http://i.imgur.com/J2cTZsg.jpg" alt="「只是一味地爬升，爬升，最終抵達的地方沒有回去的路」－《三月的獅子》"></p>
<blockquote>
<p>「今天學姊會來嗎？」學弟如此問道<br>「哪個學姊？你想說什麼」不耐煩地詢問</p>
</blockquote>
<p>終於來到這一天，跟學弟談話時要把同屆同學用稱謂描述，叫全名也不對勁，只喊名也怪奇特的，若用學長學姊稱呼，一不小心談話又忘了是哪個學長學姊。</p>
<h3 id="清醒之日"><a href="#清醒之日" class="headerlink" title="清醒之日"></a>清醒之日</h3><blockquote>
<p>「我在你家，可以借用你房間嗎？」<br>「？」原來是高中同學來訪，如此地閒情逸致 … 到我的房間打電動！<br>「借你桌子打電動」</p>
</blockquote>
<p>十一點多離開實驗室，一回到租屋的地方，從沒想過接下來才是那無法描述的黑歷史，為什麼連回家都要被酷刑拷問，這些不是我能決定的啊，學校那樣就算了，連好友都能從動態中發現個什麼，為什麼你們要處處肉搜呢？</p>
<p>次次日，收到通知要買電池回去弄熱水器，到處敲個房門請求工具支援，才發現自己有多孤單。不僅是電池沒電，連瓦斯都沒有，看來今天是冷水澡的清醒日！</p>
<p><img src="http://i.imgur.com/1j4BK8O.jpg" alt="「孤單的時候 就可以相互依靠」－《人渣本願》"></p>
<blockquote>
<p>根據以往的經驗，想認識的女生都會馬上有男朋友。我想這次也不意外，祝福各位，這個小劇場給大家帶來一陣子的歡笑。</p>
</blockquote>
<p>學期的最後，授課老師說研究生只要有幾門課拿到 A+ 就好，研究方向就會比較明確。然而，在這當下把碩士課程八門都修完，回過頭來，發現到擅長的研究領域無法判定，對於研究能力更加迷惘。感謝小夥伴們的協助，全 A+ 成就取得。</p>
<p><img src="http://i.imgur.com/VvcUwJZ.jpg" alt="「誰能溫暖我 誰能快點溫暖我」－《為美好的世界獻上祝福》"></p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-jg-20007" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/18/jg-20007/" class="article-date">
  <time datetime="2017-01-18T01:16:30.000Z" itemprop="datePublished">2017-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/18/jg-20007/">淺談旅行推銷員問題 (Travelling Salesman Problem) 搜索加速</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/01/18/jg-20007/" data-id="ckxv1wm9s006wa8vnu4nbh5rl" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/01/18/jg-20007/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DLX/">DLX</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/branch-and-reduce-algorithm/">branch-and-reduce algorithm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/批改娘/">批改娘</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <blockquote>
<p>學弟們修課〈演算法設計與分析〉內容中的一環，看他們的講義進行加速比較，也許有人會認為我太閒，但這只是追求真理。看看維基百科上，就有那上萬點的極佳近似解算法，而接下來要說的相當於玩具等級。</p>
</blockquote>
<h2 id="Task-Description"><a href="#Task-Description" class="headerlink" title="Task Description"></a>Task Description</h2><p>給一組城市和每一個城市之間的單向距離，請找出從起點城市出發，經過所有城市且不重複回到起點城市的最短距離和。</p>
<p>例如，走訪順序為 $1-2-4-3-1$. 距離總和為 $10+25+30+15 = 80$.</p>
<p><img src="http://i.imgur.com/l2aSygv.png" alt=""></p>
<h2 id="Subtask"><a href="#Subtask" class="headerlink" title="Subtask"></a>Subtask</h2><span>$N \le 100$</span><!-- Has MathJax -->
<h2 id="Input-Format"><a href="#Input-Format" class="headerlink" title="Input Format"></a>Input Format</h2><p>只有一組測資，每組第一行有一個整數 <span>$N$</span><!-- Has MathJax --> ，表示有 <span>$N$</span><!-- Has MathJax --> 座城市，接下來會有 <span>$N$</span><!-- Has MathJax --> 行，每行上有 <span>$N$</span><!-- Has MathJax --> 個非負整數 <span>$D_{i, j}$</span><!-- Has MathJax --> 表示節點 <span>$i$</span><!-- Has MathJax --> 到節點 <span>$j$</span><!-- Has MathJax --> 的距離，如果 <span>$D_{i, j} = 0$</span><!-- Has MathJax --> ，視同沒有邊。</p>
<p>你可以假設每一條邊可能是單向的，保證至少一條 TSP 路徑。</p>
<ul>
<li><span>$3 &lt; N \leq 100$</span><!-- Has MathJax --></li>
<li><span>$0 &lt; \textit{distance between any pair of cities} \le 10000$</span><!-- Has MathJax -->
</li>
</ul>
<h2 id="Output-Format"><a href="#Output-Format" class="headerlink" title="Output Format"></a>Output Format</h2><p>輸出一行最小距離和。</p>
<h2 id="Sample-Input-1"><a href="#Sample-Input-1" class="headerlink" title="Sample Input 1"></a>Sample Input 1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">4</div><div class="line">0 10 15 20</div><div class="line">10 0 35 25</div><div class="line">15 35 0 30</div><div class="line">20 25 30 0</div></pre></td></tr></table></figure>
<h2 id="Sample-Output-1"><a href="#Sample-Output-1" class="headerlink" title="Sample Output 1"></a>Sample Output 1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">80</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><h3 id="初學第一步－窮舉"><a href="#初學第一步－窮舉" class="headerlink" title="初學第一步－窮舉"></a>初學第一步－窮舉</h3><p>從最直觀的想法中，我們可以使用窮舉 <span>$O(N!)$</span><!-- Has MathJax --> 解決，再搭配簡單的剪枝 (加上當前點 <span>$u$</span><!-- Has MathJax --> 返回起點的最短路徑長是否大於已知解)。當 <span>$N \ge 12$</span><!-- Has MathJax --> 時，理論運算次數達 4 億之多，運算時間相當於 1 秒左右 (粗估一般 CPU 可達 4 GHz)，接下來窮舉速度就不堪負荷。</p>
<blockquote>
<p>時間複雜度 <span>$O(N!)$</span><!-- Has MathJax --> ， 空間複雜度 <span>$O(N)$</span><!-- Has MathJax --></p>
</blockquote>
<h3 id="踏出第一步－動態規劃"><a href="#踏出第一步－動態規劃" class="headerlink" title="踏出第一步－動態規劃"></a>踏出第一步－動態規劃</h3><p>當學會動態規劃後，解決這一 NP-Complete 問題時，我們使用記憶體空間去掉重複換取時間，定義狀態 <code>dp[i][j]</code> 表示當前走過的點集合 <span>$i$</span><!-- Has MathJax --> ，停留最後一個點位置 <span>$j$</span><!-- Has MathJax --> ，點集合可以用 bitmask 的技巧壓縮，集合狀態個數 <span>$2^N$</span><!-- Has MathJax --> ，窮舉所有停留點轉移需要 <span>$O(N)$</span><!-- Has MathJax --> 次。當 <span>$N \ge 25$</span><!-- Has MathJax --> 時，理論次數達 8 億之多，再加上記憶體存取效能，導致運行約數十秒。</p>
<blockquote>
<p>時間複雜度 <span>$O(N^2 \cdot 2^N)$</span><!-- Has MathJax --> ， 空間複雜度 <span>$O(N \cdot 2^N)$</span><!-- Has MathJax --></p>
</blockquote>
<h3 id="更進一步"><a href="#更進一步" class="headerlink" title="更進一步"></a>更進一步</h3><p>我們發現到基礎窮舉中可以剪枝卻又不夠局觀，在動態規劃中擁有移除重複卻又不能剪枝，動態規劃又佔據大量的記憶體空間，那麼使用更厲害的 branch-and-reduce 算法吧。簡單介紹一下 branch-and-reduce 算法的特性：</p>
<ul>
<li>屬於窮舉的一環</li>
<li>在每一步中，花費較多的時間估算整體基礎花費，用來剪枝</li>
<li>窮舉一步之後，將盤面選擇縮小，甚至做到同構移除來減少窮舉分支，這個步驟稱為 reduce</li>
<li>使用的記憶體空間少 (與一般窮舉相當)</li>
</ul>
<p>運用在 TSP 問題時，我們首先將輸入轉換成 <span>$N \times N$</span><!-- Has MathJax --> 矩陣，當移動從 <span>$u$</span><!-- Has MathJax --> 到 <span>$v$</span><!-- Has MathJax --> 時，矩陣就會變成 <span>$(N-1) \times (N-1)$</span><!-- Has MathJax --> 大小。</p>
<h4 id="計算基礎花費"><a href="#計算基礎花費" class="headerlink" title="計算基礎花費"></a>計算基礎花費</h4><p>對於一個 TSP 而言，每一個點必然有入邊和出邊，因此基礎花費必然每一個節點權重最小的入邊和出邊總和。範例操作如下：</p>
<span>$$\begin{align*}
\text{cost matrix } M_5 = \begin{bmatrix}
\infty &amp; 20 &amp; 30 &amp; 10 &amp; 11 \\
15 &amp; \infty &amp; 16 &amp; 4 &amp; 2 \\
3 &amp; 5 &amp; \infty &amp; 2 &amp; 4 \\
19 &amp; 6 &amp; 18 &amp; \infty &amp; 3 \\
16 &amp; 4 &amp; 7 &amp; 16 &amp; \infty
\end{bmatrix}
\end{align*}$$</span><!-- Has MathJax -->
<p>計算出邊最小值，將每一行的最小值算出，例如第一行 <span>$[\infty \; 20 \; 30 \; 10 \; 11]$</span><!-- Has MathJax --> 為 10，最後分別扣掉 10, 2, 2, 3, 4，得到出邊基礎花費 <span>$10+2+2+3+4 = 21$</span><!-- Has MathJax --> ，接著我們扣除掉基礎花費得到</p>
<span>$$\begin{align*}
\text{reduce row, cost matrix } M_5 = \begin{bmatrix}
\infty &amp; 10 &amp; 20 &amp; 0 &amp; 1 \\
13 &amp; \infty &amp; 14 &amp; 2 &amp; 0 \\
1 &amp; 3 &amp; \infty &amp; 0 &amp; 2 \\
16 &amp; 3 &amp; 15 &amp; \infty &amp; 0 \\
12 &amp; 0 &amp; 3 &amp; 12 &amp; \infty
\end{bmatrix}
\end{align*}$$</span><!-- Has MathJax -->
<p>此時，我們再針對入邊找到基礎花費，將每一個列的最小值算出，分別為 1, 0, 3, 0, 0，因此得到基礎花費 <span>$21+1+3 = 25$</span><!-- Has MathJax --> ，如此一來當下限高於當前的最佳解就可以退出。下一階段的矩陣就會被改造成如下所示</p>
<span>$$\begin{align*}
\text{reduce row/column, cost matrix }M_5 = \begin{bmatrix}
\infty &amp; 10 &amp; 17 &amp; 0 &amp; 1 \\
12 &amp; \infty &amp; 11 &amp; 2 &amp; 0 \\
0 &amp; 3 &amp; \infty &amp; 0 &amp; 2 \\
15 &amp; 3 &amp; 12 &amp; \infty &amp; 0 \\
11 &amp; 0 &amp; 0 &amp; 12 &amp; \infty
\end{bmatrix}
\end{align*}$$</span><!-- Has MathJax -->
<p>當我們從某一點 <span>$u$</span><!-- Has MathJax --> 移動到 <span>$v$</span><!-- Has MathJax --> 時，移除掉矩陣中的某一行 <span>$u$</span><!-- Has MathJax --> 和某一列 <span>$v$</span><!-- Has MathJax --> 即可。特別注意到，上述範例為完全圖，對於稀疏圖會發生無解情況，需要特別判斷。</p>
<h4 id="優化一夜"><a href="#優化一夜" class="headerlink" title="優化一夜"></a>優化一夜</h4><p>用陣列實作不算困難，當抽出一行一列時，可能會需要複製整個矩陣，又或者只用標記來防止計算到經過的點，不管哪一種寫法都不算漂亮。這裡提供一個解決方法：在處理基礎花費時，對整個矩陣每行每列扣一個定值，實作時不真正修改數值，而是把差值記錄下來，用 <span>$O(N)$</span><!-- Has MathJax --> 空間 <span>$Dx[], \; Dy[]$</span><!-- Has MathJax --> 記錄差值，如此一來就不用耗費 <span>$O(N^2)$</span><!-- Has MathJax --> 空間和時間進行複製。</p>
<p>相對地，這會造成計算真正值 <span>$M&apos;_{x, y} = M_{x, y} - Dx[x] - Dy[y]$</span><!-- Has MathJax --> 需要數次的記憶體存取。無妨地，我們已經將了每一層的空間和搬運次數，又因為陣列小到可以全塞進快取中。</p>
<h4 id="優化二夜"><a href="#優化二夜" class="headerlink" title="優化二夜"></a>優化二夜</h4><p>對於稀疏圖而言，用矩陣實作過於浪費空間，而且很容易拖累速度，因此可以使用雙十字鏈表 Dancing Links 來模擬上述的矩陣，高效地降低運行常數。實作複雜度指數上升。</p>
<h4 id="優化三夜"><a href="#優化三夜" class="headerlink" title="優化三夜"></a>優化三夜</h4><p>遞迴窮舉必然會遇到復原操作，除非我們完整地複製每一層狀態。通常我們只會修改差異，這裡需要對整個矩陣修改，這導致差異數量非常多。為了加速復原操作，遞迴時維護自己 stack 來復原修改差異，而且僅當 <span>$Dx[], Dy[]$</span><!-- Has MathJax --> 不為零的時候才進行儲存，因為一部分的 reduce 結果會是零，這些影響的效能非常多。</p>
<p>除了上述外，計算基礎花費仍佔據了 <span>$O(N^2)$</span><!-- Has MathJax --> 的時間並佔大部分的運行時間。為了減少計算量，可以做到以下幾點：</p>
<ul>
<li>在每一行/列計算最小值時，走訪 Dancing Links 每一行每一列，如果當前最小值已經被更新到 0 時，可以直接退出。</li>
<li>傳遞當前已知最佳解，當累積計算花費總和高於已知解就退出。</li>
</ul>
<h4 id="優化四夜"><a href="#優化四夜" class="headerlink" title="優化四夜"></a>優化四夜</h4><p>從啟發的觀點來看，每一階段有 <span>$n$</span><!-- Has MathJax --> 種選擇，各別算出預期最少花費後，排序後優先從花費小的開始拓展。</p>
<blockquote>
<p>下述程式只支援頂點個數 30 以內，在頂點個數 30 時，只需要耗費 161 ms 即可完成。<br>當我將頂點個數放大 50 時，小夥伴們的程序花了 2 個小時還沒結果，而我寫的版本跑了 1X 秒就結束。測資的極限就只到這了，暫時先擱著吧。<a href="https://judgegirl.csie.org/problem/0/20007" target="_blank" rel="external">題目鏈結 20007. Fast Travelling Salesman Problem</a></p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXNODE 5000</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXCOL 32</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 32</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> INF 0x3f3f3f</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DancingNode</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> left, right, up, down;</div><div class="line">    <span class="keyword">int</span> ch, rh, w;</div><div class="line">&#125; DL[MAXNODE];</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">HelperNode</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> head, size, next, prev;</div><div class="line">&#125; HN[MAXNODE];</div><div class="line"><span class="keyword">int</span> help_head;</div><div class="line"><span class="keyword">int</span> s[MAXCOL];</div><div class="line"><span class="keyword">int</span> head, size, Ans;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Remove</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</div><div class="line">    DL[DL[c].right].left = DL[c].left;</div><div class="line">    DL[DL[c].left].right = DL[c].right;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = DL[c].down; i != c; i = DL[i].down) &#123;</div><div class="line">    	<span class="keyword">if</span> (HN[DL[i].rh].head == i)</div><div class="line">    		HN[DL[i].rh].head = DL[i].left;</div><div class="line">    	HN[DL[i].rh].size--;</div><div class="line">        DL[DL[i].right].left = DL[i].left;</div><div class="line">        DL[DL[i].left].right = DL[i].right;</div><div class="line">        s[DL[i].ch]--;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Resume</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = DL[c].down; i != c; i = DL[i].down) &#123;</div><div class="line">    	<span class="keyword">if</span> (HN[DL[i].rh].head == i)</div><div class="line">    		HN[DL[i].rh].head = DL[i].right;</div><div class="line">    	HN[DL[i].rh].size++;</div><div class="line">        DL[DL[i].right].left = i;</div><div class="line">        DL[DL[i].left].right = i;</div><div class="line">        s[DL[i].ch]++;</div><div class="line">    &#125;</div><div class="line">    DL[DL[c].right].left = c;</div><div class="line">    DL[DL[c].left].right = c;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Reduce</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> t = DL[i].rh;</div><div class="line">    HN[HN[t].next].prev = HN[t].prev;</div><div class="line">    HN[HN[t].prev].next = HN[t].next;</div><div class="line">    s[DL[i].ch]--;</div><div class="line">    </div><div class="line">    DL[DL[i].down].up = DL[i].up;</div><div class="line">    DL[DL[i].up].down = DL[i].down;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = DL[i].right; k != i; k = DL[k].right) &#123;</div><div class="line">        DL[DL[k].down].up = DL[k].up;</div><div class="line">        DL[DL[k].up].down = DL[k].down;</div><div class="line">        s[DL[k].ch]--;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Recover</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> t = DL[i].rh;</div><div class="line">    HN[HN[t].next].prev = t;</div><div class="line">    HN[HN[t].prev].next = t;</div><div class="line">    s[DL[i].ch]++;</div><div class="line">    </div><div class="line">    DL[DL[i].down].up = i;</div><div class="line">    DL[DL[i].up].down = i;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = DL[i].right; k != i; k = DL[k].right) &#123;</div><div class="line">        DL[DL[k].down].up = k;</div><div class="line">        DL[DL[k].up].down = k;</div><div class="line">        s[DL[k].ch]++;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Select</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> s = DL[i].rh;</div><div class="line">    Reduce(i);</div><div class="line">    Remove(j);</div><div class="line">    HN[HN[s].next].prev = HN[s].prev;</div><div class="line">    HN[HN[s].prev].next = HN[s].next;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Cancel</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> s = DL[i].rh;</div><div class="line">    Resume(j);</div><div class="line">    Recover(i);</div><div class="line">    HN[HN[s].next].prev = s;</div><div class="line">    HN[HN[s].prev].next = s;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">new_node</span><span class="params">(<span class="keyword">int</span> up, <span class="keyword">int</span> down, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</div><div class="line">    DL[size].up = up, DL[size].down = down;</div><div class="line">    DL[size].left = left, DL[size].right = right;</div><div class="line">    DL[up].down = DL[down].up = DL[left].right = DL[right].left = size;</div><div class="line">    <span class="keyword">return</span> size++;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">new_row</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> R[][<span class="number">2</span>], <span class="keyword">int</span> rh)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> r, row = <span class="number">-1</span>, k;</div><div class="line">    <span class="keyword">int</span> h = size;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">        r = R[i][<span class="number">0</span>];</div><div class="line">        DL[size].ch = r, s[r]++;</div><div class="line">        DL[size].rh = rh;</div><div class="line">        DL[size].w = R[i][<span class="number">1</span>];</div><div class="line">        <span class="keyword">if</span> (row == <span class="number">-1</span>) &#123;</div><div class="line">            row = new_node(DL[DL[r].ch].up, DL[r].ch, size, size);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            k = new_node(DL[DL[r].ch].up, DL[r].ch, DL[row].left, row);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    HN[rh].size = n;</div><div class="line">    HN[rh].head = h;</div><div class="line">    HN[rh].next = HN[help_head].next;</div><div class="line">    HN[rh].prev = help_head;</div><div class="line">    HN[HN[help_head].next].prev = rh;</div><div class="line">    HN[help_head].next = rh;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> m)</span> </span>&#123;</div><div class="line">    size = <span class="number">0</span>;</div><div class="line">    help_head = <span class="number">0</span>, HN[help_head].next = HN[help_head].prev = help_head;</div><div class="line">    head = new_node(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++) &#123;</div><div class="line">        new_node(i, i, DL[head].left, head);</div><div class="line">        DL[i].ch = i, s[i] = <span class="number">0</span>;</div><div class="line">        DL[i].rh = <span class="number">0</span>;	<span class="comment">// important pointer (fail pointer)</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> Dx[MAXN], Dy[MAXN];</div><div class="line"><span class="keyword">int</span> markRStk[MAXNODE], markRidx = <span class="number">-1</span>;</div><div class="line"><span class="keyword">int</span> markCStk[MAXNODE], markCidx = <span class="number">-1</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">printDL</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = HN[help_head].prev; i != help_head; i = HN[i].prev) &#123;</div><div class="line">        <span class="keyword">int</span> j = HN[i].head, prev = <span class="number">1</span>;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%2d "</span>, DL[j].rh);</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            <span class="keyword">while</span> (prev &lt; DL[j].ch)</div><div class="line">                prev++, <span class="built_in">printf</span>(<span class="string">" -- "</span>);</div><div class="line">            prev = DL[j].ch+<span class="number">1</span>;</div><div class="line">            <span class="keyword">int</span> rh = DL[j].rh, ch = DL[j].ch;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"[%2d]"</span>, DL[j].w - Dx[rh] - Dy[ch]);</div><div class="line">            j = DL[j].right;</div><div class="line">        &#125; <span class="keyword">while</span> (j != HN[i].head);</div><div class="line">        <span class="keyword">while</span> (prev &lt;= n)</div><div class="line">            prev++, <span class="built_in">printf</span>(<span class="string">" -- "</span>);</div><div class="line">        <span class="built_in">puts</span>(<span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">puts</span>(<span class="string">"----------------------"</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">cH</span><span class="params">(<span class="keyword">int</span> limit = INF)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> ins = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = HN[help_head].prev; i != help_head; i = HN[i].prev) &#123;</div><div class="line">        <span class="keyword">if</span> (HN[i].size == <span class="number">0</span>)</div><div class="line">            <span class="keyword">return</span> INF;</div><div class="line">        <span class="keyword">int</span> j = HN[i].head, v = INF;</div><div class="line">        <span class="keyword">int</span> rh = DL[j].rh, ch;</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            ch = DL[j].ch;</div><div class="line">            v = min(v, DL[j].w - Dx[rh] - Dy[ch]);</div><div class="line">            j = DL[j].right;</div><div class="line">        &#125; <span class="keyword">while</span> (j != HN[i].head &amp;&amp; v);</div><div class="line">        <span class="keyword">if</span> (v == INF || ins+v &gt;= limit)</div><div class="line">            <span class="keyword">return</span> INF;</div><div class="line">        <span class="keyword">if</span> (v) &#123;</div><div class="line">            ins += v;</div><div class="line">            Dx[rh] += v;</div><div class="line">            markRStk[++markRidx] = v;</div><div class="line">            markRStk[++markRidx] = rh;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">	printf("cH first\n");</span></div><div class="line"><span class="comment">	printDL(4);</span></div><div class="line"><span class="comment">*/</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = DL[head].right; i != head; i = DL[i].right) &#123;</div><div class="line">        <span class="keyword">if</span> (DL[i].down == i)</div><div class="line">            <span class="keyword">return</span> INF;</div><div class="line">        <span class="keyword">int</span> j = DL[i].down, v = INF;</div><div class="line">        <span class="keyword">int</span> ch = DL[i].ch, rh;</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            rh = DL[j].rh;</div><div class="line">            v = min(v, DL[j].w - Dx[rh] - Dy[ch]);</div><div class="line">            j = DL[j].down;</div><div class="line">        &#125; <span class="keyword">while</span> (j != i &amp;&amp; v);</div><div class="line">        <span class="keyword">if</span> (v == INF || ins+v &gt;= limit)</div><div class="line">            <span class="keyword">return</span> INF;</div><div class="line">        <span class="keyword">if</span> (v) &#123;</div><div class="line">            ins += v;</div><div class="line">            Dy[ch] += v;</div><div class="line">            markCStk[++markCidx] = v;</div><div class="line">            markCStk[++markCidx] = ch;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ins;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">rH</span><span class="params">(<span class="keyword">int</span> backRidx, <span class="keyword">int</span> backCidx)</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (markRidx &gt; backRidx) &#123;</div><div class="line">        <span class="keyword">int</span> a = markRStk[markRidx--];</div><div class="line">        <span class="keyword">int</span> b = markRStk[markRidx--];</div><div class="line">        Dx[a] -= b;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span> (markCidx &gt; backCidx) &#123;</div><div class="line">        <span class="keyword">int</span> a = markCStk[markCidx--];</div><div class="line">        <span class="keyword">int</span> b = markCStk[markCidx--];</div><div class="line">        Dy[a] -= b;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SAME_CUT</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">isSame</span><span class="params">(<span class="keyword">int</span> vx, <span class="keyword">int</span> vy)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> i = HN[vx].head, j = HN[vy].head;</div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="keyword">if</span> (DL[i].ch != DL[j].ch &amp;&amp; (DL[i].ch != vy &amp;&amp; DL[j].ch != vx))</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> e1 = DL[i].w - Dx[vx] - Dy[DL[i].ch];</div><div class="line">        <span class="keyword">int</span> e2 = DL[j].w - Dx[vy] - Dy[DL[j].ch];</div><div class="line">        <span class="keyword">if</span> (e1 != e2)</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        i = DL[i].right;</div><div class="line">        j = DL[j].right;	</div><div class="line">    &#125; <span class="keyword">while</span> (i != HN[vx].head &amp;&amp; j != HN[vy].head);</div><div class="line">    <span class="keyword">return</span> i == HN[vx].head &amp;&amp; j == HN[vy].head;</div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MST_CUT</span></div><div class="line"><span class="keyword">int</span> parent[MAXN];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">findp</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> x == parent[x] ? x : (parent[x]=findp(parent[x]));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">joint</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">    x = findp(x), y = findp(y);</div><div class="line">    <span class="keyword">if</span> (x == y) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    parent[y] = x;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">MST</span><span class="params">(<span class="keyword">int</span> st, <span class="keyword">int</span> ed, <span class="keyword">int</span> limit = INF)</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> used[MAXN] = &#123;&#125;, cases = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (HN[HN[help_head].prev].prev == help_head)</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> i = HN[help_head].prev;</div><div class="line">    <span class="keyword">int</span> n = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>, in = INF, out = INF;</div><div class="line">    cases++;</div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="keyword">int</span> j = HN[i].head;</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            <span class="keyword">int</span> x = DL[j].rh, y = DL[j].ch;</div><div class="line">            <span class="keyword">int</span> w = DL[j].w - Dx[x] - Dy[y];</div><div class="line">            <span class="keyword">if</span> (x == st) &#123;</div><div class="line">                in = min(in, w);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (y == ed) &#123;</div><div class="line">                out = min(out, w);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (used[x] != cases)</div><div class="line">                    used[x] = cases, parent[x] = x, n++;</div><div class="line">                <span class="keyword">if</span> (used[y] != cases)</div><div class="line">                    used[y] = cases, parent[y] = y, n++;</div><div class="line">                n -= joint(x, y);</div><div class="line">            &#125;</div><div class="line">            j = DL[j].right;</div><div class="line">        &#125; <span class="keyword">while</span> (j != HN[i].head);</div><div class="line">        i = HN[i].prev;</div><div class="line">    &#125; <span class="keyword">while</span> (i != help_head);</div><div class="line">    ret = in + out;</div><div class="line">    <span class="keyword">if</span> (ret &gt;= limit)</div><div class="line">        <span class="keyword">return</span> limit;</div><div class="line">    <span class="keyword">if</span> (n &gt; <span class="number">1</span>) &#123;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"cc cut\n"</span>);</div><div class="line">        <span class="keyword">return</span> INF;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> </span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">DFS</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> lower_bound)</span> </span>&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MST_CUT</span></div><div class="line">    <span class="keyword">if</span> (lower_bound + MST(u, <span class="number">1</span>, Ans - lower_bound) &gt;= Ans) &#123;</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="keyword">if</span> (lower_bound &gt;= Ans) &#123;</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (HN[HN[help_head].prev].prev == help_head) &#123;</div><div class="line">        Ans = lower_bound;</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> i = HN[u].head;</div><div class="line">    <span class="built_in">vector</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt; pick;</div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="keyword">int</span> v = DL[i].ch;</div><div class="line">        <span class="keyword">int</span> runnable = <span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span> (v == <span class="number">1</span>)</div><div class="line">            runnable = <span class="number">0</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SAME_CUT</span></div><div class="line">        <span class="keyword">if</span> (runnable) &#123;</div><div class="line">            <span class="keyword">int</span> e1 = DL[i].w - Dx[u] - Dy[v];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = HN[u].head; j != i &amp;&amp; runnable; j = DL[j].right) &#123;</div><div class="line">                <span class="keyword">int</span> e2 = DL[j].w - Dx[u] - Dy[DL[j].ch];</div><div class="line">                <span class="keyword">if</span> (e1 != e2)</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                <span class="keyword">if</span> (isSame(v, DL[j].ch))</div><div class="line">                    runnable = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (runnable) &#123;</div><div class="line">            <span class="keyword">int</span> backRidx = markRidx, backCidx = markCidx;</div><div class="line">            <span class="keyword">int</span> tu = HN[u].head;</div><div class="line">            Select(tu, v);</div><div class="line">            <span class="keyword">int</span> c = cH(Ans - lower_bound);</div><div class="line">            <span class="keyword">if</span> (c != INF) &#123;</div><div class="line">                pick.push_back(make_pair(lower_bound + c + DL[i].w-Dx[u]-Dy[v], v));</div><div class="line">            <span class="comment">//	DFS(v, lower_bound + c + DL[i].w-Dx[u]-Dy[v]);</span></div><div class="line">            &#125;</div><div class="line">            rH(backRidx, backCidx);</div><div class="line">            Cancel(tu, v);</div><div class="line">        &#125;</div><div class="line">        i = DL[i].right;</div><div class="line">    &#125; <span class="keyword">while</span> (i != HN[u].head);</div><div class="line"></div><div class="line">    sort(pick.begin(), pick.end());</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pick.size(); i++) &#123;</div><div class="line">        <span class="keyword">int</span> v = pick[i].second;	</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">		printf("%d -&gt; %d, %d\n", u, v, pick[i].first);</span></div><div class="line"><span class="comment">		printDL(4);</span></div><div class="line"><span class="comment">*/</span></div><div class="line">        <span class="keyword">int</span> backRidx = markRidx, backCidx = markCidx;</div><div class="line">        <span class="keyword">int</span> tu = HN[u].head;</div><div class="line">        Select(tu, v);</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">		printf("Select\n");</span></div><div class="line"><span class="comment">		printDL(4);</span></div><div class="line"><span class="comment">*/</span></div><div class="line">        <span class="keyword">int</span> c = cH(Ans - lower_bound);</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">		printf("Reduce\n");</span></div><div class="line"><span class="comment">		printDL(4);</span></div><div class="line"><span class="comment">*/</span></div><div class="line">        <span class="keyword">if</span> (c != INF)</div><div class="line">            DFS(v, pick[i].first);</div><div class="line">        rH(backRidx, backCidx);</div><div class="line">        Cancel(tu, v);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> G[MAXN][MAXN];</div><div class="line">    <span class="keyword">int</span> n;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n) == <span class="number">1</span>) &#123;</div><div class="line">        init(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            <span class="keyword">int</span> R[MAXN][<span class="number">2</span>], Rcnt = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j++) &#123;</div><div class="line">                assert(<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;G[i][j]) == <span class="number">1</span>);</div><div class="line">                <span class="keyword">if</span> (G[i][j])</div><div class="line">                    R[Rcnt][<span class="number">0</span>] = j, R[Rcnt][<span class="number">1</span>] = G[i][j], Rcnt++;</div><div class="line">            &#125;</div><div class="line">            new_row(Rcnt, R, i);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> backRidx = markRidx, backCidx = markCidx;</div><div class="line">        Ans = INF;</div><div class="line">        DFS(<span class="number">1</span>, cH());</div><div class="line">        rH(backRidx, backCidx);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, Ans);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-note/diary-201701-4" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/17/note/diary-201701-4/" class="article-date">
  <time datetime="2017-01-17T08:45:01.000Z" itemprop="datePublished">2017-01-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/手札日記/">手札日記</a>
  </div>

  </div>
  <div class="article-inner ">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="http://i.imgur.com/dODwLPn.jpg" rel="gallery_ckxv1wn7p02b8a8vn85xm6ps0">
        <img src="http://i.imgur.com/dODwLPn.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/17/note/diary-201701-4/">優化小插曲 下篇</a>
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/01/17/note/diary-201701-4/" data-id="ckxv1wn7p02b8a8vn85xm6ps0" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/01/17/note/diary-201701-4/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="2016・冬・續"><a href="#2016・冬・續" class="headerlink" title="2016・冬・續"></a>2016・冬・續</h2><h2 id="學校課業"><a href="#學校課業" class="headerlink" title="學校課業"></a>學校課業</h2><p>畢業門檻共計二十四學分，每堂課原則上都是三學分，意即要修八堂課，其中一部分可以選修外系碩班課，而我卻傻傻地全選資工碩班的課。大部分的人都是每學期修三到四門課，最後一學期專心做論文，前提指導教授派發的助教工作夠輕鬆，而不是每週都來亂的情況。</p>
<p>而這學期一開始有打算修英文課，開給碩班的英文課不外乎有很多系來修，對於我這種渣渣而言還稍微困難了些，但沒想到第一堂課的互動，在互動過程中回答問題時，讓我的人生增添了 <strong> 黑歷史 </strong>，隨後的分組成了邊緣人，於是我，退了。</p>
<h3 id="計算機圖學"><a href="#計算機圖學" class="headerlink" title="計算機圖學"></a>計算機圖學</h3><blockquote>
<p>這裡只描述過程中的心情，實作細節有機會再發文</p>
</blockquote>
<p>之前在大學時，課程中 GameMaker 這套軟體上弄遊戲就快崩潰，靠著小夥伴編寫劇本，自己兜弄 UI 設計與美工，討論如何做出適當的效果，反覆地測試運行流程，那時用了一整個學期，請參考 <a href="https://github.com/morris821028/hw-GameMaker/tree/master/doc" target="_blank" rel="external">Github</a>，那門課可說是我唯三拿到低於九十分的系上課程 (其中兩個是專題，也許是我嗆老師不懂設計、太過古板)。</p>
<p>第二個作業使用 Unity3D 開發，拉個 GUI 弄得昏天暗地。在物理引擎設定上，質量大小、推力反應、空氣阻力、碰撞動量 … 等，這些估計數據的感覺全還給老師，瞬間覺得自己是個蠢貨，怎麼調都不對。搞了幾天都弄不定，還好有小夥伴古古教我怎麼用，不然還真的會崩潰一陣子。</p>
<p><img src="http://i.imgur.com/TMLvPpG.jpg" alt="《田中君總是如此慵懶》"></p>
<p>期末專案跟小夥伴古古一組，著手渲染技術之一的 Radiosity <a href="https://github.com/morris821028/hw-radiosity" target="_blank" rel="external">Github</a>，用各式優化技巧和 WebGL、OpenGL 呈現作品，有機會我們再來談談大量的優化技術吧，將老師給的程序利用編譯器優化到極致！隨後再平行它！</p>
<h3 id="演算法設計與分析"><a href="#演算法設計與分析" class="headerlink" title="演算法設計與分析"></a>演算法設計與分析</h3><p>雖然沒修這門課，看著學弟去修這門課的作業，又知道助教是之前修平行的古耕竹同學，追求效能極限的對手！有對手就會成長，永不滿足！</p>
<p>其中一個作業是計算 0/1 背包的最佳解，課程中使用 branch-and-bound 算法，可想而知這種搜索法還是會還是會退化的。不管哪種寫法都是 NP-Complete，因此只能做常數優化，如何加速背包問題請參考《淺談背包問題 (0/1 Knapsack Problem) 優化那些事》那篇。花了好幾天加速他們的作業，用優化後的 DP 計算就能完爆他們早期的剪枝版本，在數據範圍小的時候，剪枝版本仍然比較好。</p>
<p>為了加速應用，使用了 DP 達到理想最佳解，為了加速這個 DP 計算，額外使用了 DP 優化計算，又為了優化 … 不斷地遞迴下去，最後達到貪心收斂？</p>
<p><img src="http://i.imgur.com/TDrJJK6.jpg" alt="「但我的愛和努力都還不成熟」－ 斯特拉的魔法"></p>
<blockquote>
<p>還有另一個 TSP 銷售員旅遊問題的實作優化，有空我再來跟大家說說吧。</p>
</blockquote>
<h4 id="優化心情一覽"><a href="#優化心情一覽" class="headerlink" title="優化心情一覽"></a>優化心情一覽</h4><p>摸遍上百人的 Code，還原所有學過的知識，偷學技術並變成自己的招式，Gate of Codeylon！</p>
<p><img src="http://i.imgur.com/1A0eE9R.jpg" alt="「Gate of Bootylon」"></p>
<p>連續幾週都在高喊加速！你怎麼改，我就怎麼追。當成功加速時，就擺上切嗣大叔</p>
<p><img src="http://i.imgur.com/acZmPgO.jpg" alt="「固有時制御 二倍數 Time Alter Double Accel」－ Fate/Zero"></p>
<p>隔日發現第一名被奪走時，高喊奪回誓言「妹子被暴搜搶走！不行，我一定要攻下她。」</p>
<p><img src="http://i.imgur.com/HgG23mN.jpg" alt="斯特拉的魔法"></p>
<p>反反覆覆地，每天心情有如三溫暖般地洗禮，時時刻刻都無法鬆懈，我們越來越逼近真理，內心相當雀躍。古助教看著我與學弟們的競爭，也加入討論，感覺相當地不錯。</p>
<blockquote>
<p>M &lt;&lt;「我在追求真理」<br>K &gt;&gt;「好好栽培學弟，學弟就是你的真理」<br>M &lt;&lt;「？」<br>K &gt;&gt;「真理還分性別嗎？」<br>M &lt;&lt;「…」</p>
</blockquote>
<p>學弟們最後加速剪枝到優化後的 DP 無法追到。深感可惜，在沒有滿足鴿籠原理的情況下，我找不太到卡暴搜的測資。相反地，若很容易做到鴿籠原理，莫名其妙可以快個十幾倍。他們加速剪枝，我利用減少計算量加速，彼此都獲得更進一步的討論，有人討論果然可以走得更遠更快。</p>
<p><img src="http://i.imgur.com/ZOodNFv.jpg" alt="「想要走得更遠」－ 吹響吧！上低音號"></p>
<p>最後這些題目被我們放在批改娘系統上，測資有卡實作邊界處理不好程序。雖然我不是最強，但在這第一學府就要成為最強，任何亂來的解法見一個斬一個，動用腦中所有的智慧生出最強的測資！啊，好像把別門課的作業弄壞掉了。當然作業只求計算正確，速度不要太離譜，這一點我們還是無法違背課程需求，要求每位同學與我們一起加速和探討似乎都錯了什麼。</p>
<h2 id="實驗室雜談"><a href="#實驗室雜談" class="headerlink" title="實驗室雜談"></a>實驗室雜談</h2><h3 id="教授語錄"><a href="#教授語錄" class="headerlink" title="教授語錄"></a>教授語錄</h3><blockquote>
<p>「實作細節一點也不重要，根本沒人想聽」<br>「別太相信論文」<br>「理論都正確，但你做的有什麼用？」</p>
</blockquote>
<p><strong><em>紀錄心中的困惑</em></strong></p>
<p>這一年，我越來越不能理解這奇怪的要求。當不想講細節的時候，又被問要怎麼做，細節大多都沒有乾淨的理論描述，完全依賴在計算機架構上，不同的架構又是另一套參數，講起來沒完沒了。</p>
<p>當被質疑報告的論文正確性時，偏偏那一篇還是 tier-1 conference (曾經最高的國際會議) 來的論文，到底是信還是不信呢？那我們被要求投那個國際會議時，又要秉持什麼樣的態度才合適。從研究論文開始，我也明白很多論文的部分成果有瑕疵。無妨地，我們可以理論推測那是很簡單的，但礙於篇幅有限。</p>
<p>當想做出一篇很有用的論文時，我覺得這困難到想休學不讀，根本沒有機會遇到有用的且可以寫出論文的機緣。所以當時跟老師談論到想休學，老師卻說論文隨便寫就發一篇，這樣隨便發一篇真的有用嗎？這麼說起來，我的人生好沒用呢。</p>
<p><img src="http://i.imgur.com/dPgilok.jpg" alt="「不是都怪你太弱嗎」－ 3 月的獅子"></p>
<h3 id="白色聖誕前奏"><a href="#白色聖誕前奏" class="headerlink" title="白色聖誕前奏"></a>白色聖誕前奏</h3><p>公司的大哥大姐打算在聖誕節辦活動，要來個交換禮物又是卡拉歌唱比賽，櫃檯姊姊和其他 AE 姊姊談論這事情時，恰好就在旁邊聽著。</p>
<blockquote>
<p>A &gt;&gt;「打算辦交換禮物活動，妳覺得如何」<br>B &gt;&gt;「我覺得交換禮物不錯呀」<br>Morris 思考中<br>A &gt;&gt;「妳看看 Morris 好像不太行耶，主管 X 是打算換成卡拉歌唱比賽」<br>A &gt;&gt;「他們是不是不太願意花時間去挑禮物，他們工程師都這樣」<br>Morris 思考中<br>B &gt;&gt;「Morris 好像撐不住了」<br>A &gt;&gt;「比賽這種就不是每個人都能參與，有輸有贏的，好好的聖誕節為什麼要這樣？」</p>
</blockquote>
<p>咱只是在思考這些活動的複雜度而已，行不行也不是我能決定的，喜歡估算的心錯了嗎？對於我來說負擔太大，不僅不會唱歌，連買禮物的品味都成問題。最後耗費一個週末只思考禮物要買些什麼。</p>
<p><img src="http://i.imgur.com/sM6rFKN.jpg" alt="「是從什麼時候開始的呢 會感覺聖誕好痛苦」－ 3 月的獅子"></p>
<p>這學期在學校大大小小的事物都跟古同學有關，學弟常常要跟我描述是古學長 (演算法設計助教) 還是古學姊 (物聯網助教和計算機圖學一起修課)，同時他們兩位又有在我當平行助教的時候一起修平行課，稱呼方法搞得我好混亂，但跟這群有趣的傢伙同一屆不容易也很幸運。</p>
<p>跟學弟們討論到底要買什麼禮物作為交換，並抱怨著自己聖誕節魯到不行。此時，學弟突然說「你不是在追古學姊嗎？」當下的我愣了一下，學弟馬上補一刀「難道是追古學長嗎？」等等，這聽起來越來越不對勁，看來這兒已經沒我說話的餘地，學弟們的這套想法讓我不知所措。</p>
<p><img src="http://i.imgur.com/n7UYb9Q.jpg" alt="「嗯 我會努力的」－ 斯特拉的魔法"></p>
<p>週末買公司要求的禮物時，學弟學長們再三交代「不買給『她』嗎」？心想「她」到底是誰，在旁人的催促下，內心相當煎熬，我不懂的事情太多，對於沒有錯過的問題，完全不知如何下手解決，行動與常識近乎零，類似當機地直接跳過無法執行的部分。於是在聖誕的前一週，跑了數間店買了數個禮物準備。</p>
<p>不管送給誰，送不出去就在聖誕節自己拆，自己買的禮物自己拆，做好邊緣人的心理建設。同時，週末也順便補實驗室另一個女生生日蛋糕，請學弟騎車帶我去買蛋糕，畢竟去年她們替我慶生，這回有學弟們一起在實驗室，買蛋糕也不尷尬，這週末真是忙碌呀。</p>
<p>從此之後，學弟問任何話題，一提到「學姊」總要特別小心地回答，他們總是在刺探我的心意，無意也變有意。在一旁的實驗室「學姊」看著我慌忙地回答與再三確認不時在一旁偷笑。「也許，他們把你的潛意思說出來了。」在這陣子，我想我回答什麼都不是。</p>
<p>隨著聖誕逼近，學長學弟一直在催促我何時要送「很多人週一就開始送了，你怎麼還不送」我只能再三地反問「到底是想要我送給誰啦」想著適合自己品味的禮物，若要與眾不同，肯定是朝著送記憶卡內附程序，並留言到「這是我加速三倍快的程序，拜託了，請回禮追我」的那種。</p>
<p><img src="http://i.imgur.com/TAHnvGd.jpg" alt="「要我故意輸掉嗎？」－ 3 月的獅子"></p>
<p>最後在聖誕前幾天，也就去公司上班的前一天把禮物送出去，這下你們就不會再撈叨我了吧？至於在聖誕節前一日，因為被要求上台唱中文歌而內心受創好幾天，有必要把聖誕節搞得如此繁複嗎？</p>
<h3 id="跨年尾牙"><a href="#跨年尾牙" class="headerlink" title="跨年尾牙"></a>跨年尾牙</h3><p>實驗室尾牙總會問跨年打算怎麼過</p>
<blockquote>
<p>M「反正沒人約，應該在實驗室過吧！」<br>A「學長，不用擔心，我們都在實驗室」<br>B「實驗室由我們守護，你放膽出去約吧，記得遊戲角色開著幫我放輪」<br>聽起來有點感動又有點頹廢是怎麼回事 …<br>M「約誰？」<br>B「當然是學姊」<br>… … …<br>M「你們認真的嗎？」<br>B「當然」<br>一群在旁邊偷笑<br>實驗室學姊對 M 說「你是認真的嗎？」<br>… …. … …. .. …<br>M「嗯，失敗了，跟你們過吧」</p>
</blockquote>
<p><img src="http://i.imgur.com/tHEwpTb.jpg" alt="「明天早上能陪我一下嗎」－ 吹響吧！上低音號"></p>
<hr>
<p>2016・冬・終</p>

          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/7/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/87/">87</a><a class="extend next" rel="next" href="/page/9/">Next &raquo;</a>
    </nav>
  
</section>
          
          
            <aside id="sidebar">
  <!-- <div id="ukagaka_panel"></div> -->
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/">學校課程</a><span class="category-list-count">115</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/介面設計/">介面設計</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/作業系統/">作業系統</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/即時系統/">即時系統</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/大學專題/">大學專題</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/巨量資料/">巨量資料</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/平行程式/">平行程式</a><span class="category-list-count">43</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/敏捷方法/">敏捷方法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/編譯器/">編譯器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/自然語言/">自然語言</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/虛擬實境/">虛擬實境</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算型智慧/">計算型智慧</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算幾何/">計算幾何</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算機圖學/">計算機圖學</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資料庫系統/">資料庫系統</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資訊安全/">資訊安全</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/通識課程/">通識課程</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/">工作應用</a><span class="category-list-count">38</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Java/">Java</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/Meme/">Meme</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/其他/">其他</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/可持久化/">可持久化</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作應用/鬼故事/">鬼故事</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/手札日記/">手札日記</a><span class="category-list-count">55</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/">網頁設計</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/About-This-Blog/">About This Blog</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/HTML5/">HTML5</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/JQuery/">JQuery</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/Markdown/">Markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/NodeJs/">NodeJs</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/">解題區</a><span class="category-list-count">633</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/Latex/">Latex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/出題解題/">出題解題</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-POJ/">解題區 - POJ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a><span class="category-list-count">483</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a><span class="category-list-count">77</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-未解題目/">解題區 - 未解題目</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/雜言筆記/">雜言筆記</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a class="text" href="/2022/01/01/note/clove-letter/">
              
                <i class="icon-file-o"></i> 
              
            《獻上給某工程師的情書》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/12/31/note/diary-20211231-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·陸》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/12/26/note/diary-20211226-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·伍》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/11/21/note/diary-20211121-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·肆》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/11/12/note/diary-20211112-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·參》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/31/note/diary-20211031-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·貳》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/28/note/diary-202110-encrypt/">
              
                <i class="icon-file-o"></i> 
              
            《批改娘串起得那段經歷·序》</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/28/note/diary-202110/">
              
                <i class="icon-file-o"></i> 
              
            好多個 28 在這個時刻</a>
          </li>
        
          <li>
            <a class="text" href="/2021/10/28/work/company-ghost-story-14/">
              
                <i class="icon-file-o"></i> 
              
            Company Ghost Story 公司鬼故事 14</a>
          </li>
        
          <li>
            <a class="text" href="/2021/09/12/work/appreciation-letter/">
              
                <i class="icon-file-o"></i> 
              
            Shiny People 感謝</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">   
        <ul>
          <li><a href="http://mypaper.pchome.com.tw/zerojudge" target="_blank" title="Old Blog"><i class="icon-star"></i> Morris' Blog (pchome)</a></li>
        </ul>
    </div>
</div>

  
    
<script src="/js/jquery-ui.js"></script>
<script src="/js/ukagaka/jquery.morris.ukagaka.resource.js"></script>
<script src="/js/ukagaka/typed.js"></script>
  
  
</aside>
          
        
      </div>
      <footer id="footer">
  
  <div class="outer">    
    <div class="social-group">
      
      <a href="https://github.com/morris821028" target="_blank" title="github"><i class="icon-github"></i></a>
      
      
      <a href="https://www.facebook.com/Morris1028" target="_blank" title="facebook"><i class="icon-facebook-sign"></i></a>
      
      
      <a href="http://uhunt.felix-halim.net/id/46705" target="_blank" title="uhunt" ><span class="icon-uhunt">UVa<span></a>
      
    </div>
    <div id="footer-info" class="inner">
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/morris821028/hexo-theme-landscape" target="_blank" title="landscape">landscape</a> &copy; 2022 Shiang-Yun Yang 
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link"><i class=icon-home ></i>&nbsp&nbspHome</a>
  
    <a href="/about" class="mobile-nav-link"><i class=icon-user ></i>&nbsp&nbspAbout</a>
  
    <a href="/archives" class="mobile-nav-link"><i class=icon-archive ></i>&nbsp&nbspArchives</a>
  
    <a href="/tags" class="mobile-nav-link"><i class=icon-tags ></i>&nbsp&nbspTags</a>
  
    <a href="/picture" class="mobile-nav-link"><i class=icon-camera ></i>&nbsp&nbspPictures</a>
  
    <a href="/works" class="mobile-nav-link"><i class=icon-trophy ></i>&nbsp&nbspWorks</a>
  
</nav>
    
<script>
  var disqus_shortname = 'morris1028';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/jquery.lazyload.js"></script>
<script src="/js/jquery.als-1.6.js"></script>

<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>