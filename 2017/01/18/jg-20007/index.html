<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>淺談旅行推銷員問題 (Travelling Salesman Problem) 搜索加速 | Morris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="學弟們修課〈演算法設計與分析〉內容中的一環，看他們的講義進行加速比較，也許有人會認為我太閒，但這只是追求真理。看看維基百科上，就有那上萬點的極佳近似解算法，而接下來要說的相當於玩具等級。  Task Description給一組城市和每一個城市之間的單向距離，請找出從起點城市出發，經過所有城市且不重複回到起點城市的最短距離和。 例如，走訪順序為 $1-2-4-3-1$. 距離總和為 $10+25">
<meta name="keywords" content="批改娘,DLX,branch-and-reduce algorithm">
<meta property="og:type" content="article">
<meta property="og:title" content="淺談旅行推銷員問題 (Travelling Salesman Problem) 搜索加速">
<meta property="og:url" content="http://morris821028.github.io/2017/01/18/jg-20007/index.html">
<meta property="og:site_name" content="Morris&#39; Blog">
<meta property="og:description" content="學弟們修課〈演算法設計與分析〉內容中的一環，看他們的講義進行加速比較，也許有人會認為我太閒，但這只是追求真理。看看維基百科上，就有那上萬點的極佳近似解算法，而接下來要說的相當於玩具等級。  Task Description給一組城市和每一個城市之間的單向距離，請找出從起點城市出發，經過所有城市且不重複回到起點城市的最短距離和。 例如，走訪順序為 $1-2-4-3-1$. 距離總和為 $10+25">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://i.imgur.com/l2aSygv.png">
<meta property="og:updated_time" content="2021-05-30T02:04:42.504Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="淺談旅行推銷員問題 (Travelling Salesman Problem) 搜索加速">
<meta name="twitter:description" content="學弟們修課〈演算法設計與分析〉內容中的一環，看他們的講義進行加速比較，也許有人會認為我太閒，但這只是追求真理。看看維基百科上，就有那上萬點的極佳近似解算法，而接下來要說的相當於玩具等級。  Task Description給一組城市和每一個城市之間的單向距離，請找出從起點城市出發，經過所有城市且不重複回到起點城市的最短距離和。 例如，走訪順序為 $1-2-4-3-1$. 距離總和為 $10+25">
<meta name="twitter:image" content="http://i.imgur.com/l2aSygv.png">
<link rel="publisher" href="108158678174364350000">
  
    <link rel="alternative" href="/atom.xml" title="Morris&#39; Blog" type="application/atom+xml">
  
  
    <meta name="google-site-verification" content="5mRgj8NanEMpGZuNfHNJNmH90RgNlrnJXsFlTaKD6Gs" />
  
  
    <link rel="shortcut icon" href="/img/f.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script src="/js/jquery-2.1.0.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.5.1.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdn.oesmith.co.uk/morris-0.5.1.min.js"></script>
  <!-- <link rel="import" href="/bower_components/app-layout/app-layout.html"> --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"><div id="banner-right"></div></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Morris&#39; Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class=icon-home title='Home'></i></a>
          
        
          
            <a class="main-nav-link" href="/about"><i class=icon-user title='About'></i></a>
          
        
          
            <a class="main-nav-link" href="/archives"><i class=icon-archive title='Archives'></i></a>
          
        
          
            <a class="main-nav-link" href="/tags"><i class=icon-tags title='Tags'></i></a>
          
        
          
            <a class="main-nav-link" href="/picture"><i class=icon-camera title='Pictures'></i></a>
          
        
          
            <a class="main-nav-link" href="/works"><i class=icon-trophy title='Works'></i></a>
          
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://morris821028.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        
          
          <section id="main" style="width: 95%"><article id="post-jg-20007" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/18/jg-20007/" class="article-date">
  <time datetime="2017-01-18T01:16:30.000Z" itemprop="datePublished">2017-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>/<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      淺談旅行推銷員問題 (Travelling Salesman Problem) 搜索加速
    </h1>
  

      </header>
    
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2017/01/18/jg-20007/" data-id="cktgztprb009tgsvnxjojt2oc" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2017/01/18/jg-20007/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DLX/">DLX</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/branch-and-reduce-algorithm/">branch-and-reduce algorithm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/批改娘/">批改娘</a></li></ul>

    </footer>
    <div class="article-entry " itemprop="articleBody">
      
          
              <div id="toc" class="toc-article">
              <h2 class="toc-title"><span>contents</span></h2>
              
                  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Task-Description"><span class="toc-number">1.</span> <span class="toc-text">Task Description</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Subtask"><span class="toc-number">2.</span> <span class="toc-text">Subtask</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Input-Format"><span class="toc-number">3.</span> <span class="toc-text">Input Format</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Output-Format"><span class="toc-number">4.</span> <span class="toc-text">Output Format</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sample-Input-1"><span class="toc-number">5.</span> <span class="toc-text">Sample Input 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sample-Output-1"><span class="toc-number">6.</span> <span class="toc-text">Sample Output 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Solution"><span class="toc-number">7.</span> <span class="toc-text">Solution</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#初學第一步－窮舉"><span class="toc-number">7.1.</span> <span class="toc-text">初學第一步－窮舉</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#踏出第一步－動態規劃"><span class="toc-number">7.2.</span> <span class="toc-text">踏出第一步－動態規劃</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更進一步"><span class="toc-number">7.3.</span> <span class="toc-text">更進一步</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#計算基礎花費"><span class="toc-number">7.3.1.</span> <span class="toc-text">計算基礎花費</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#優化一夜"><span class="toc-number">7.3.2.</span> <span class="toc-text">優化一夜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#優化二夜"><span class="toc-number">7.3.3.</span> <span class="toc-text">優化二夜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#優化三夜"><span class="toc-number">7.3.4.</span> <span class="toc-text">優化三夜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#優化四夜"><span class="toc-number">7.3.5.</span> <span class="toc-text">優化四夜</span></a></li></ol></li></ol></li></ol>
              
              </div>
          
        
          <blockquote>
<p>學弟們修課〈演算法設計與分析〉內容中的一環，看他們的講義進行加速比較，也許有人會認為我太閒，但這只是追求真理。看看維基百科上，就有那上萬點的極佳近似解算法，而接下來要說的相當於玩具等級。</p>
</blockquote>
<h2 id="Task-Description"><a href="#Task-Description" class="headerlink" title="Task Description"></a>Task Description</h2><p>給一組城市和每一個城市之間的單向距離，請找出從起點城市出發，經過所有城市且不重複回到起點城市的最短距離和。</p>
<p>例如，走訪順序為 $1-2-4-3-1$. 距離總和為 $10+25+30+15 = 80$.</p>
<p><img src="http://i.imgur.com/l2aSygv.png" alt=""></p>
<h2 id="Subtask"><a href="#Subtask" class="headerlink" title="Subtask"></a>Subtask</h2><span>$N \le 100$</span><!-- Has MathJax -->
<h2 id="Input-Format"><a href="#Input-Format" class="headerlink" title="Input Format"></a>Input Format</h2><p>只有一組測資，每組第一行有一個整數 <span>$N$</span><!-- Has MathJax --> ，表示有 <span>$N$</span><!-- Has MathJax --> 座城市，接下來會有 <span>$N$</span><!-- Has MathJax --> 行，每行上有 <span>$N$</span><!-- Has MathJax --> 個非負整數 <span>$D_{i, j}$</span><!-- Has MathJax --> 表示節點 <span>$i$</span><!-- Has MathJax --> 到節點 <span>$j$</span><!-- Has MathJax --> 的距離，如果 <span>$D_{i, j} = 0$</span><!-- Has MathJax --> ，視同沒有邊。</p>
<p>你可以假設每一條邊可能是單向的，保證至少一條 TSP 路徑。</p>
<ul>
<li><span>$3 &lt; N \leq 100$</span><!-- Has MathJax --></li>
<li><span>$0 &lt; \textit{distance between any pair of cities} \le 10000$</span><!-- Has MathJax -->
</li>
</ul>
<h2 id="Output-Format"><a href="#Output-Format" class="headerlink" title="Output Format"></a>Output Format</h2><p>輸出一行最小距離和。</p>
<h2 id="Sample-Input-1"><a href="#Sample-Input-1" class="headerlink" title="Sample Input 1"></a>Sample Input 1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">4</div><div class="line">0 10 15 20</div><div class="line">10 0 35 25</div><div class="line">15 35 0 30</div><div class="line">20 25 30 0</div></pre></td></tr></table></figure>
<h2 id="Sample-Output-1"><a href="#Sample-Output-1" class="headerlink" title="Sample Output 1"></a>Sample Output 1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">80</div></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><h3 id="初學第一步－窮舉"><a href="#初學第一步－窮舉" class="headerlink" title="初學第一步－窮舉"></a>初學第一步－窮舉</h3><p>從最直觀的想法中，我們可以使用窮舉 <span>$O(N!)$</span><!-- Has MathJax --> 解決，再搭配簡單的剪枝 (加上當前點 <span>$u$</span><!-- Has MathJax --> 返回起點的最短路徑長是否大於已知解)。當 <span>$N \ge 12$</span><!-- Has MathJax --> 時，理論運算次數達 4 億之多，運算時間相當於 1 秒左右 (粗估一般 CPU 可達 4 GHz)，接下來窮舉速度就不堪負荷。</p>
<blockquote>
<p>時間複雜度 <span>$O(N!)$</span><!-- Has MathJax --> ， 空間複雜度 <span>$O(N)$</span><!-- Has MathJax --></p>
</blockquote>
<h3 id="踏出第一步－動態規劃"><a href="#踏出第一步－動態規劃" class="headerlink" title="踏出第一步－動態規劃"></a>踏出第一步－動態規劃</h3><p>當學會動態規劃後，解決這一 NP-Complete 問題時，我們使用記憶體空間去掉重複換取時間，定義狀態 <code>dp[i][j]</code> 表示當前走過的點集合 <span>$i$</span><!-- Has MathJax --> ，停留最後一個點位置 <span>$j$</span><!-- Has MathJax --> ，點集合可以用 bitmask 的技巧壓縮，集合狀態個數 <span>$2^N$</span><!-- Has MathJax --> ，窮舉所有停留點轉移需要 <span>$O(N)$</span><!-- Has MathJax --> 次。當 <span>$N \ge 25$</span><!-- Has MathJax --> 時，理論次數達 8 億之多，再加上記憶體存取效能，導致運行約數十秒。</p>
<blockquote>
<p>時間複雜度 <span>$O(N^2 \cdot 2^N)$</span><!-- Has MathJax --> ， 空間複雜度 <span>$O(N \cdot 2^N)$</span><!-- Has MathJax --></p>
</blockquote>
<h3 id="更進一步"><a href="#更進一步" class="headerlink" title="更進一步"></a>更進一步</h3><p>我們發現到基礎窮舉中可以剪枝卻又不夠局觀，在動態規劃中擁有移除重複卻又不能剪枝，動態規劃又佔據大量的記憶體空間，那麼使用更厲害的 branch-and-reduce 算法吧。簡單介紹一下 branch-and-reduce 算法的特性：</p>
<ul>
<li>屬於窮舉的一環</li>
<li>在每一步中，花費較多的時間估算整體基礎花費，用來剪枝</li>
<li>窮舉一步之後，將盤面選擇縮小，甚至做到同構移除來減少窮舉分支，這個步驟稱為 reduce</li>
<li>使用的記憶體空間少 (與一般窮舉相當)</li>
</ul>
<p>運用在 TSP 問題時，我們首先將輸入轉換成 <span>$N \times N$</span><!-- Has MathJax --> 矩陣，當移動從 <span>$u$</span><!-- Has MathJax --> 到 <span>$v$</span><!-- Has MathJax --> 時，矩陣就會變成 <span>$(N-1) \times (N-1)$</span><!-- Has MathJax --> 大小。</p>
<h4 id="計算基礎花費"><a href="#計算基礎花費" class="headerlink" title="計算基礎花費"></a>計算基礎花費</h4><p>對於一個 TSP 而言，每一個點必然有入邊和出邊，因此基礎花費必然每一個節點權重最小的入邊和出邊總和。範例操作如下：</p>
<span>$$\begin{align*}
\text{cost matrix } M_5 = \begin{bmatrix}
\infty &amp; 20 &amp; 30 &amp; 10 &amp; 11 \\
15 &amp; \infty &amp; 16 &amp; 4 &amp; 2 \\
3 &amp; 5 &amp; \infty &amp; 2 &amp; 4 \\
19 &amp; 6 &amp; 18 &amp; \infty &amp; 3 \\
16 &amp; 4 &amp; 7 &amp; 16 &amp; \infty
\end{bmatrix}
\end{align*}$$</span><!-- Has MathJax -->
<p>計算出邊最小值，將每一行的最小值算出，例如第一行 <span>$[\infty \; 20 \; 30 \; 10 \; 11]$</span><!-- Has MathJax --> 為 10，最後分別扣掉 10, 2, 2, 3, 4，得到出邊基礎花費 <span>$10+2+2+3+4 = 21$</span><!-- Has MathJax --> ，接著我們扣除掉基礎花費得到</p>
<span>$$\begin{align*}
\text{reduce row, cost matrix } M_5 = \begin{bmatrix}
\infty &amp; 10 &amp; 20 &amp; 0 &amp; 1 \\
13 &amp; \infty &amp; 14 &amp; 2 &amp; 0 \\
1 &amp; 3 &amp; \infty &amp; 0 &amp; 2 \\
16 &amp; 3 &amp; 15 &amp; \infty &amp; 0 \\
12 &amp; 0 &amp; 3 &amp; 12 &amp; \infty
\end{bmatrix}
\end{align*}$$</span><!-- Has MathJax -->
<p>此時，我們再針對入邊找到基礎花費，將每一個列的最小值算出，分別為 1, 0, 3, 0, 0，因此得到基礎花費 <span>$21+1+3 = 25$</span><!-- Has MathJax --> ，如此一來當下限高於當前的最佳解就可以退出。下一階段的矩陣就會被改造成如下所示</p>
<span>$$\begin{align*}
\text{reduce row/column, cost matrix }M_5 = \begin{bmatrix}
\infty &amp; 10 &amp; 17 &amp; 0 &amp; 1 \\
12 &amp; \infty &amp; 11 &amp; 2 &amp; 0 \\
0 &amp; 3 &amp; \infty &amp; 0 &amp; 2 \\
15 &amp; 3 &amp; 12 &amp; \infty &amp; 0 \\
11 &amp; 0 &amp; 0 &amp; 12 &amp; \infty
\end{bmatrix}
\end{align*}$$</span><!-- Has MathJax -->
<p>當我們從某一點 <span>$u$</span><!-- Has MathJax --> 移動到 <span>$v$</span><!-- Has MathJax --> 時，移除掉矩陣中的某一行 <span>$u$</span><!-- Has MathJax --> 和某一列 <span>$v$</span><!-- Has MathJax --> 即可。特別注意到，上述範例為完全圖，對於稀疏圖會發生無解情況，需要特別判斷。</p>
<h4 id="優化一夜"><a href="#優化一夜" class="headerlink" title="優化一夜"></a>優化一夜</h4><p>用陣列實作不算困難，當抽出一行一列時，可能會需要複製整個矩陣，又或者只用標記來防止計算到經過的點，不管哪一種寫法都不算漂亮。這裡提供一個解決方法：在處理基礎花費時，對整個矩陣每行每列扣一個定值，實作時不真正修改數值，而是把差值記錄下來，用 <span>$O(N)$</span><!-- Has MathJax --> 空間 <span>$Dx[], \; Dy[]$</span><!-- Has MathJax --> 記錄差值，如此一來就不用耗費 <span>$O(N^2)$</span><!-- Has MathJax --> 空間和時間進行複製。</p>
<p>相對地，這會造成計算真正值 <span>$M&apos;_{x, y} = M_{x, y} - Dx[x] - Dy[y]$</span><!-- Has MathJax --> 需要數次的記憶體存取。無妨地，我們已經將了每一層的空間和搬運次數，又因為陣列小到可以全塞進快取中。</p>
<h4 id="優化二夜"><a href="#優化二夜" class="headerlink" title="優化二夜"></a>優化二夜</h4><p>對於稀疏圖而言，用矩陣實作過於浪費空間，而且很容易拖累速度，因此可以使用雙十字鏈表 Dancing Links 來模擬上述的矩陣，高效地降低運行常數。實作複雜度指數上升。</p>
<h4 id="優化三夜"><a href="#優化三夜" class="headerlink" title="優化三夜"></a>優化三夜</h4><p>遞迴窮舉必然會遇到復原操作，除非我們完整地複製每一層狀態。通常我們只會修改差異，這裡需要對整個矩陣修改，這導致差異數量非常多。為了加速復原操作，遞迴時維護自己 stack 來復原修改差異，而且僅當 <span>$Dx[], Dy[]$</span><!-- Has MathJax --> 不為零的時候才進行儲存，因為一部分的 reduce 結果會是零，這些影響的效能非常多。</p>
<p>除了上述外，計算基礎花費仍佔據了 <span>$O(N^2)$</span><!-- Has MathJax --> 的時間並佔大部分的運行時間。為了減少計算量，可以做到以下幾點：</p>
<ul>
<li>在每一行/列計算最小值時，走訪 Dancing Links 每一行每一列，如果當前最小值已經被更新到 0 時，可以直接退出。</li>
<li>傳遞當前已知最佳解，當累積計算花費總和高於已知解就退出。</li>
</ul>
<h4 id="優化四夜"><a href="#優化四夜" class="headerlink" title="優化四夜"></a>優化四夜</h4><p>從啟發的觀點來看，每一階段有 <span>$n$</span><!-- Has MathJax --> 種選擇，各別算出預期最少花費後，排序後優先從花費小的開始拓展。</p>
<blockquote>
<p>下述程式只支援頂點個數 30 以內，在頂點個數 30 時，只需要耗費 161 ms 即可完成。<br>當我將頂點個數放大 50 時，小夥伴們的程序花了 2 個小時還沒結果，而我寫的版本跑了 1X 秒就結束。測資的極限就只到這了，暫時先擱著吧。<a href="https://judgegirl.csie.org/problem/0/20007" target="_blank" rel="external">題目鏈結 20007. Fast Travelling Salesman Problem</a></p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXNODE 5000</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXCOL 32</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 32</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> INF 0x3f3f3f</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DancingNode</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> left, right, up, down;</div><div class="line">    <span class="keyword">int</span> ch, rh, w;</div><div class="line">&#125; DL[MAXNODE];</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">HelperNode</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> head, size, next, prev;</div><div class="line">&#125; HN[MAXNODE];</div><div class="line"><span class="keyword">int</span> help_head;</div><div class="line"><span class="keyword">int</span> s[MAXCOL];</div><div class="line"><span class="keyword">int</span> head, size, Ans;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Remove</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</div><div class="line">    DL[DL[c].right].left = DL[c].left;</div><div class="line">    DL[DL[c].left].right = DL[c].right;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = DL[c].down; i != c; i = DL[i].down) &#123;</div><div class="line">    	<span class="keyword">if</span> (HN[DL[i].rh].head == i)</div><div class="line">    		HN[DL[i].rh].head = DL[i].left;</div><div class="line">    	HN[DL[i].rh].size--;</div><div class="line">        DL[DL[i].right].left = DL[i].left;</div><div class="line">        DL[DL[i].left].right = DL[i].right;</div><div class="line">        s[DL[i].ch]--;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Resume</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = DL[c].down; i != c; i = DL[i].down) &#123;</div><div class="line">    	<span class="keyword">if</span> (HN[DL[i].rh].head == i)</div><div class="line">    		HN[DL[i].rh].head = DL[i].right;</div><div class="line">    	HN[DL[i].rh].size++;</div><div class="line">        DL[DL[i].right].left = i;</div><div class="line">        DL[DL[i].left].right = i;</div><div class="line">        s[DL[i].ch]++;</div><div class="line">    &#125;</div><div class="line">    DL[DL[c].right].left = c;</div><div class="line">    DL[DL[c].left].right = c;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Reduce</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> t = DL[i].rh;</div><div class="line">    HN[HN[t].next].prev = HN[t].prev;</div><div class="line">    HN[HN[t].prev].next = HN[t].next;</div><div class="line">    s[DL[i].ch]--;</div><div class="line">    </div><div class="line">    DL[DL[i].down].up = DL[i].up;</div><div class="line">    DL[DL[i].up].down = DL[i].down;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = DL[i].right; k != i; k = DL[k].right) &#123;</div><div class="line">        DL[DL[k].down].up = DL[k].up;</div><div class="line">        DL[DL[k].up].down = DL[k].down;</div><div class="line">        s[DL[k].ch]--;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Recover</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> t = DL[i].rh;</div><div class="line">    HN[HN[t].next].prev = t;</div><div class="line">    HN[HN[t].prev].next = t;</div><div class="line">    s[DL[i].ch]++;</div><div class="line">    </div><div class="line">    DL[DL[i].down].up = i;</div><div class="line">    DL[DL[i].up].down = i;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = DL[i].right; k != i; k = DL[k].right) &#123;</div><div class="line">        DL[DL[k].down].up = k;</div><div class="line">        DL[DL[k].up].down = k;</div><div class="line">        s[DL[k].ch]++;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Select</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> s = DL[i].rh;</div><div class="line">    Reduce(i);</div><div class="line">    Remove(j);</div><div class="line">    HN[HN[s].next].prev = HN[s].prev;</div><div class="line">    HN[HN[s].prev].next = HN[s].next;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Cancel</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> s = DL[i].rh;</div><div class="line">    Resume(j);</div><div class="line">    Recover(i);</div><div class="line">    HN[HN[s].next].prev = s;</div><div class="line">    HN[HN[s].prev].next = s;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">new_node</span><span class="params">(<span class="keyword">int</span> up, <span class="keyword">int</span> down, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</div><div class="line">    DL[size].up = up, DL[size].down = down;</div><div class="line">    DL[size].left = left, DL[size].right = right;</div><div class="line">    DL[up].down = DL[down].up = DL[left].right = DL[right].left = size;</div><div class="line">    <span class="keyword">return</span> size++;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">new_row</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> R[][<span class="number">2</span>], <span class="keyword">int</span> rh)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> r, row = <span class="number">-1</span>, k;</div><div class="line">    <span class="keyword">int</span> h = size;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">        r = R[i][<span class="number">0</span>];</div><div class="line">        DL[size].ch = r, s[r]++;</div><div class="line">        DL[size].rh = rh;</div><div class="line">        DL[size].w = R[i][<span class="number">1</span>];</div><div class="line">        <span class="keyword">if</span> (row == <span class="number">-1</span>) &#123;</div><div class="line">            row = new_node(DL[DL[r].ch].up, DL[r].ch, size, size);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            k = new_node(DL[DL[r].ch].up, DL[r].ch, DL[row].left, row);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    HN[rh].size = n;</div><div class="line">    HN[rh].head = h;</div><div class="line">    HN[rh].next = HN[help_head].next;</div><div class="line">    HN[rh].prev = help_head;</div><div class="line">    HN[HN[help_head].next].prev = rh;</div><div class="line">    HN[help_head].next = rh;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> m)</span> </span>&#123;</div><div class="line">    size = <span class="number">0</span>;</div><div class="line">    help_head = <span class="number">0</span>, HN[help_head].next = HN[help_head].prev = help_head;</div><div class="line">    head = new_node(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++) &#123;</div><div class="line">        new_node(i, i, DL[head].left, head);</div><div class="line">        DL[i].ch = i, s[i] = <span class="number">0</span>;</div><div class="line">        DL[i].rh = <span class="number">0</span>;	<span class="comment">// important pointer (fail pointer)</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> Dx[MAXN], Dy[MAXN];</div><div class="line"><span class="keyword">int</span> markRStk[MAXNODE], markRidx = <span class="number">-1</span>;</div><div class="line"><span class="keyword">int</span> markCStk[MAXNODE], markCidx = <span class="number">-1</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">printDL</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = HN[help_head].prev; i != help_head; i = HN[i].prev) &#123;</div><div class="line">        <span class="keyword">int</span> j = HN[i].head, prev = <span class="number">1</span>;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%2d "</span>, DL[j].rh);</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            <span class="keyword">while</span> (prev &lt; DL[j].ch)</div><div class="line">                prev++, <span class="built_in">printf</span>(<span class="string">" -- "</span>);</div><div class="line">            prev = DL[j].ch+<span class="number">1</span>;</div><div class="line">            <span class="keyword">int</span> rh = DL[j].rh, ch = DL[j].ch;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"[%2d]"</span>, DL[j].w - Dx[rh] - Dy[ch]);</div><div class="line">            j = DL[j].right;</div><div class="line">        &#125; <span class="keyword">while</span> (j != HN[i].head);</div><div class="line">        <span class="keyword">while</span> (prev &lt;= n)</div><div class="line">            prev++, <span class="built_in">printf</span>(<span class="string">" -- "</span>);</div><div class="line">        <span class="built_in">puts</span>(<span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">puts</span>(<span class="string">"----------------------"</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">cH</span><span class="params">(<span class="keyword">int</span> limit = INF)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> ins = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = HN[help_head].prev; i != help_head; i = HN[i].prev) &#123;</div><div class="line">        <span class="keyword">if</span> (HN[i].size == <span class="number">0</span>)</div><div class="line">            <span class="keyword">return</span> INF;</div><div class="line">        <span class="keyword">int</span> j = HN[i].head, v = INF;</div><div class="line">        <span class="keyword">int</span> rh = DL[j].rh, ch;</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            ch = DL[j].ch;</div><div class="line">            v = min(v, DL[j].w - Dx[rh] - Dy[ch]);</div><div class="line">            j = DL[j].right;</div><div class="line">        &#125; <span class="keyword">while</span> (j != HN[i].head &amp;&amp; v);</div><div class="line">        <span class="keyword">if</span> (v == INF || ins+v &gt;= limit)</div><div class="line">            <span class="keyword">return</span> INF;</div><div class="line">        <span class="keyword">if</span> (v) &#123;</div><div class="line">            ins += v;</div><div class="line">            Dx[rh] += v;</div><div class="line">            markRStk[++markRidx] = v;</div><div class="line">            markRStk[++markRidx] = rh;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">	printf("cH first\n");</span></div><div class="line"><span class="comment">	printDL(4);</span></div><div class="line"><span class="comment">*/</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = DL[head].right; i != head; i = DL[i].right) &#123;</div><div class="line">        <span class="keyword">if</span> (DL[i].down == i)</div><div class="line">            <span class="keyword">return</span> INF;</div><div class="line">        <span class="keyword">int</span> j = DL[i].down, v = INF;</div><div class="line">        <span class="keyword">int</span> ch = DL[i].ch, rh;</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            rh = DL[j].rh;</div><div class="line">            v = min(v, DL[j].w - Dx[rh] - Dy[ch]);</div><div class="line">            j = DL[j].down;</div><div class="line">        &#125; <span class="keyword">while</span> (j != i &amp;&amp; v);</div><div class="line">        <span class="keyword">if</span> (v == INF || ins+v &gt;= limit)</div><div class="line">            <span class="keyword">return</span> INF;</div><div class="line">        <span class="keyword">if</span> (v) &#123;</div><div class="line">            ins += v;</div><div class="line">            Dy[ch] += v;</div><div class="line">            markCStk[++markCidx] = v;</div><div class="line">            markCStk[++markCidx] = ch;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ins;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">rH</span><span class="params">(<span class="keyword">int</span> backRidx, <span class="keyword">int</span> backCidx)</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (markRidx &gt; backRidx) &#123;</div><div class="line">        <span class="keyword">int</span> a = markRStk[markRidx--];</div><div class="line">        <span class="keyword">int</span> b = markRStk[markRidx--];</div><div class="line">        Dx[a] -= b;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span> (markCidx &gt; backCidx) &#123;</div><div class="line">        <span class="keyword">int</span> a = markCStk[markCidx--];</div><div class="line">        <span class="keyword">int</span> b = markCStk[markCidx--];</div><div class="line">        Dy[a] -= b;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SAME_CUT</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">isSame</span><span class="params">(<span class="keyword">int</span> vx, <span class="keyword">int</span> vy)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> i = HN[vx].head, j = HN[vy].head;</div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="keyword">if</span> (DL[i].ch != DL[j].ch &amp;&amp; (DL[i].ch != vy &amp;&amp; DL[j].ch != vx))</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> e1 = DL[i].w - Dx[vx] - Dy[DL[i].ch];</div><div class="line">        <span class="keyword">int</span> e2 = DL[j].w - Dx[vy] - Dy[DL[j].ch];</div><div class="line">        <span class="keyword">if</span> (e1 != e2)</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        i = DL[i].right;</div><div class="line">        j = DL[j].right;	</div><div class="line">    &#125; <span class="keyword">while</span> (i != HN[vx].head &amp;&amp; j != HN[vy].head);</div><div class="line">    <span class="keyword">return</span> i == HN[vx].head &amp;&amp; j == HN[vy].head;</div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MST_CUT</span></div><div class="line"><span class="keyword">int</span> parent[MAXN];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">findp</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> x == parent[x] ? x : (parent[x]=findp(parent[x]));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">joint</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">    x = findp(x), y = findp(y);</div><div class="line">    <span class="keyword">if</span> (x == y) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    parent[y] = x;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">MST</span><span class="params">(<span class="keyword">int</span> st, <span class="keyword">int</span> ed, <span class="keyword">int</span> limit = INF)</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> used[MAXN] = &#123;&#125;, cases = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (HN[HN[help_head].prev].prev == help_head)</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> i = HN[help_head].prev;</div><div class="line">    <span class="keyword">int</span> n = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>, in = INF, out = INF;</div><div class="line">    cases++;</div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="keyword">int</span> j = HN[i].head;</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            <span class="keyword">int</span> x = DL[j].rh, y = DL[j].ch;</div><div class="line">            <span class="keyword">int</span> w = DL[j].w - Dx[x] - Dy[y];</div><div class="line">            <span class="keyword">if</span> (x == st) &#123;</div><div class="line">                in = min(in, w);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (y == ed) &#123;</div><div class="line">                out = min(out, w);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (used[x] != cases)</div><div class="line">                    used[x] = cases, parent[x] = x, n++;</div><div class="line">                <span class="keyword">if</span> (used[y] != cases)</div><div class="line">                    used[y] = cases, parent[y] = y, n++;</div><div class="line">                n -= joint(x, y);</div><div class="line">            &#125;</div><div class="line">            j = DL[j].right;</div><div class="line">        &#125; <span class="keyword">while</span> (j != HN[i].head);</div><div class="line">        i = HN[i].prev;</div><div class="line">    &#125; <span class="keyword">while</span> (i != help_head);</div><div class="line">    ret = in + out;</div><div class="line">    <span class="keyword">if</span> (ret &gt;= limit)</div><div class="line">        <span class="keyword">return</span> limit;</div><div class="line">    <span class="keyword">if</span> (n &gt; <span class="number">1</span>) &#123;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"cc cut\n"</span>);</div><div class="line">        <span class="keyword">return</span> INF;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> </span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">DFS</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> lower_bound)</span> </span>&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MST_CUT</span></div><div class="line">    <span class="keyword">if</span> (lower_bound + MST(u, <span class="number">1</span>, Ans - lower_bound) &gt;= Ans) &#123;</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="keyword">if</span> (lower_bound &gt;= Ans) &#123;</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (HN[HN[help_head].prev].prev == help_head) &#123;</div><div class="line">        Ans = lower_bound;</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> i = HN[u].head;</div><div class="line">    <span class="built_in">vector</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; &gt; pick;</div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="keyword">int</span> v = DL[i].ch;</div><div class="line">        <span class="keyword">int</span> runnable = <span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span> (v == <span class="number">1</span>)</div><div class="line">            runnable = <span class="number">0</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SAME_CUT</span></div><div class="line">        <span class="keyword">if</span> (runnable) &#123;</div><div class="line">            <span class="keyword">int</span> e1 = DL[i].w - Dx[u] - Dy[v];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = HN[u].head; j != i &amp;&amp; runnable; j = DL[j].right) &#123;</div><div class="line">                <span class="keyword">int</span> e2 = DL[j].w - Dx[u] - Dy[DL[j].ch];</div><div class="line">                <span class="keyword">if</span> (e1 != e2)</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                <span class="keyword">if</span> (isSame(v, DL[j].ch))</div><div class="line">                    runnable = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (runnable) &#123;</div><div class="line">            <span class="keyword">int</span> backRidx = markRidx, backCidx = markCidx;</div><div class="line">            <span class="keyword">int</span> tu = HN[u].head;</div><div class="line">            Select(tu, v);</div><div class="line">            <span class="keyword">int</span> c = cH(Ans - lower_bound);</div><div class="line">            <span class="keyword">if</span> (c != INF) &#123;</div><div class="line">                pick.push_back(make_pair(lower_bound + c + DL[i].w-Dx[u]-Dy[v], v));</div><div class="line">            <span class="comment">//	DFS(v, lower_bound + c + DL[i].w-Dx[u]-Dy[v]);</span></div><div class="line">            &#125;</div><div class="line">            rH(backRidx, backCidx);</div><div class="line">            Cancel(tu, v);</div><div class="line">        &#125;</div><div class="line">        i = DL[i].right;</div><div class="line">    &#125; <span class="keyword">while</span> (i != HN[u].head);</div><div class="line"></div><div class="line">    sort(pick.begin(), pick.end());</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pick.size(); i++) &#123;</div><div class="line">        <span class="keyword">int</span> v = pick[i].second;	</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">		printf("%d -&gt; %d, %d\n", u, v, pick[i].first);</span></div><div class="line"><span class="comment">		printDL(4);</span></div><div class="line"><span class="comment">*/</span></div><div class="line">        <span class="keyword">int</span> backRidx = markRidx, backCidx = markCidx;</div><div class="line">        <span class="keyword">int</span> tu = HN[u].head;</div><div class="line">        Select(tu, v);</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">		printf("Select\n");</span></div><div class="line"><span class="comment">		printDL(4);</span></div><div class="line"><span class="comment">*/</span></div><div class="line">        <span class="keyword">int</span> c = cH(Ans - lower_bound);</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">		printf("Reduce\n");</span></div><div class="line"><span class="comment">		printDL(4);</span></div><div class="line"><span class="comment">*/</span></div><div class="line">        <span class="keyword">if</span> (c != INF)</div><div class="line">            DFS(v, pick[i].first);</div><div class="line">        rH(backRidx, backCidx);</div><div class="line">        Cancel(tu, v);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> G[MAXN][MAXN];</div><div class="line">    <span class="keyword">int</span> n;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n) == <span class="number">1</span>) &#123;</div><div class="line">        init(n);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">            <span class="keyword">int</span> R[MAXN][<span class="number">2</span>], Rcnt = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j++) &#123;</div><div class="line">                assert(<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;G[i][j]) == <span class="number">1</span>);</div><div class="line">                <span class="keyword">if</span> (G[i][j])</div><div class="line">                    R[Rcnt][<span class="number">0</span>] = j, R[Rcnt][<span class="number">1</span>] = G[i][j], Rcnt++;</div><div class="line">            &#125;</div><div class="line">            new_row(Rcnt, R, i);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> backRidx = markRidx, backCidx = markCidx;</div><div class="line">        Ans = INF;</div><div class="line">        DFS(<span class="number">1</span>, cH());</div><div class="line">        rH(backRidx, backCidx);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, Ans);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
        
      
    </div>

  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/01/20/diary-201701-5/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          那段過往的蠢事
        
      </div>
    </a>
  
  
    <a href="/2017/01/17/diary-201701-4/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">優化小插曲 下篇</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
          
          
        
      </div>
      <footer id="footer">
  
  <div class="outer">    
    <div class="social-group">
      
      <a href="https://github.com/morris821028" target="_blank" title="github"><i class="icon-github"></i></a>
      
      
      <a href="https://www.facebook.com/Morris1028" target="_blank" title="facebook"><i class="icon-facebook-sign"></i></a>
      
      
      <a href="http://uhunt.felix-halim.net/id/46705" target="_blank" title="uhunt" ><span class="icon-uhunt">UVa<span></a>
      
    </div>
    <div id="footer-info" class="inner">
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/morris821028/hexo-theme-landscape" target="_blank" title="landscape">landscape</a> &copy; 2021 Shiang-Yun Yang 
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link"><i class=icon-home ></i>&nbsp&nbspHome</a>
  
    <a href="/about" class="mobile-nav-link"><i class=icon-user ></i>&nbsp&nbspAbout</a>
  
    <a href="/archives" class="mobile-nav-link"><i class=icon-archive ></i>&nbsp&nbspArchives</a>
  
    <a href="/tags" class="mobile-nav-link"><i class=icon-tags ></i>&nbsp&nbspTags</a>
  
    <a href="/picture" class="mobile-nav-link"><i class=icon-camera ></i>&nbsp&nbspPictures</a>
  
    <a href="/works" class="mobile-nav-link"><i class=icon-trophy ></i>&nbsp&nbspWorks</a>
  
</nav>
    
<script>
  var disqus_shortname = 'morris1028';
  
  var disqus_url = 'http://morris821028.github.io/2017/01/18/jg-20007/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/jquery.lazyload.js"></script>
<script src="/js/jquery.als-1.6.js"></script>

<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>